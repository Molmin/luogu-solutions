## 【计数dp】【P6239】 [JXOI2012]奇怪的道路

### Solution

首先图是无向的，这样对于每条边，不妨认为它是从编号较大的点指向编号较小的点的，来方便枚举点的编号。另外 $k$ 非常小，这提示我们可以把后 $k$ 个点的度数奇偶性状压成二进制。

一个 naive 的想法是 $f_{i, j, S}$ 是考虑前 $i$ 个点，$j$ 条边，后 $k$ 个点的奇偶性二进制表示为 $S$ 的方案数。但是写出来会有各种各样的问题，原因是转移有一部分是无序的，会重复计数。

考虑用状态对转移加以限制。设 $f_{i, j, S, t}$ 是考虑前 $i$ 个点，$j$ 条边，后 $k$ 个点奇偶性二进制表示为 $S$，且前 $(i-1)$ 个点向前连的边都连完了，$i$ 只连了 $(i- k)\sim (i - t - 1)$ 的点的方案数。

具体对 $S$ 的定义是，对于节点 $i$ 的状态，若节点 $(i - k)$ 的度数为奇数，则 $S$ 二进制第 $k$ 位为 $1$，否则为 $0$。

考虑转移，在该状态首先可以再连一条 $i \to i - t - 1$ 的边，即

$$f_{i, j + 1, S', t} += f_{i, j, S, t}$$

其中 $S'$ 是 $S$ 状态对 $2^0$ 和 $2^{t-1}$ 取异或的结果。

另外该状态也可以是 $i \to i - t - 1$ 的最后一条边，即

$$f_{i, j, S, k - 1} += f_{i, j, S, k}$$

表示从下一条边开始考虑连向 $i - t$。

对于已经连完了 $i\to i - 1$ 的边的状态，如果节点 $i - k$ 的度数是偶数，那么就可以考虑 $i + 1$ 节点怎么连边了，否则由于 $i + 1$ 无法连向 $i - k$，这个状态是不合法的。

$$f_{i + 1,j,S',\min(i, t)} += f_{i, j, S, 0}$$

其中 $S'$ 代表 $S$ 左移一位后的结果。

边界条件当然是 $f_{1, 0, 0, 0} = 1$，输出 $f_{n, m, 0, 0}$ 即可。

### Code

代码里 $t$ 和 $k$ 是反的。

```cpp
const int maxn = 32;
const int maxt = 1025;
const int p = 1000000007;

int n, m, t;
int f[maxn][maxn][maxt][maxn];

int main() {
  freopen("1.in", "r", stdin);
  qr(n); qr(m); qr(t);
  int upc = (1 << (t + 1)) - 1, fir = 1 << t;
  f[1][0][0][0] = 1;
  for (int i = 1, di = i + 1; i <= n; i = di++) {
    for (int j = 0, dj = j + 1; j <= m; j = dj++) {
      for (int s = 0; s <= upc; ++s) {
        for (int k = std::min(i - 1, t); k; --k) {
          (f[i][j][s][k - 1] += f[i][j][s][k]) %= p;
          if (i > k) (f[i][dj][s ^ 1 ^ (1 << k)][k] += f[i][j][s][k]) %= p;
        }
        if ((s & fir) == 0) {
          (f[di][j][s << 1][std::min(i, t)] += f[i][j][s][0]) %= p;
        }
      }
    }
  }
  qw(f[n][m][0][0], '\n');
  return 0;
}
```

