~~放在前面：这是一道期望dp大水题，属于那种看题解一看就会，自己写一写就废的那种。~~

## 零. 安利：

[安利一下我的博客。](https://rsdbkhusky.github.io/)

## 一. 思路

~~（不想看我前面唠叨就直接看代码吧）~~

#### 1. 确定状态转移方程

$d_i$：$i$ 次操作后得的分数。则 $E(d_i)$：$i$ 次操作后期望的的分数。

第 $i$ 轮后，得分发生了怎样的变化了呢？我们先只看从最近一次失败后算起的成功的一段，$i$ 轮前得分是 $x^3$，如果低 $i$ 次成功，$i$ 轮后是 $(x+1)^3=x^3+3x^2+3x+1$，反之是 $0$。变化了 $3x^2+3x+1$。再加上之前的得分 $d_{i-1}$。

综上所述，已知成败情况的状转方程：

$x_i=\begin{cases}0~~~~~~~~~~~~~~~~~~~(fail)\\x_{i-1}+1~~~~~~~(success)\end{cases}$

${x^2}_i=\begin{cases}0~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~(fail)\\{x^2}_{i-1}+2x_{i-1}+1~~~~~~~~(success)\end{cases}$

$d_i=d_{i-1}+\begin{cases}0~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~(fail)\\3{x^2}_{i-1}+3x_{i-1}+1~~~~~~~~(success)\end{cases}$

设第 $i$ 次成功的几率为 $prob_i$。

**综上所述，期望状转方程**：

$E(x)_i=prob_i\times (E(x)_{i-1}+1)+(1-prob_i)\times 0$

$ ~~~~~~~~~~~=prob_i\times (E(x)_{i-1}+1)$

$E({x^2})_i=prob_i\times(E({x^2})_{i-1}+2E(x)_{i-1}+1)+(1-prob_i)\times 0$

$~~~~~~~~~~~~~=prob_i\times(E({x^2})_{i-1}+2E(x)_{i-1}+1)$

$E(d)_i=E(d)_{i-1}+prob_i\times(3E({x^2})_{i-1}+3E(x)_{i-1}+1)+(1-prob_i)\times 0$

$~~~~~~~~~~~=E(d)_{i-1}+prob_i\times(3E({x^2})_{i-1}+3E(x)_{i-1}+1)$



#### 2. 坑点

- $E(a^2)\ne E(a)^2$

  也就是说，不能将状转方程中的 $E(x^2)$ 用 $E(x)$ 表示。

- $d\ne x^3$

  $d$ 比 $x^3$ 还额外需要考虑之前的累计得分，也就是 $d_i$ 要加上 $d_{i-1}$。

- $E(d)$、$E(x^2)$ 和 $E(x)$ 更新的顺序

  如果你不开数组，就要格外注意这一点。$d$ 的期望状转方程中用到 $E(d)$、 $E(x^2)$ 和 $E(x)$；$x^2$ 的用到 $E(x^2)$ 和 $E(x)$；$x$ 的只用到自己，并且用的都是上一阶段的。所以先刷新 $E(d)$，再刷新 $E(x^2)$，最后 $E(x)$。

## 二. 代码

```cpp
#include<cstdio>
int n; double prob, d, x2, x;
int main() {
	scanf("%d", &n);
	while (n--) {
		scanf("%lf", &prob);
		d = d + prob * (3 * x2 + 3 * x + 1);
		x2 = prob * (x2 + 2 * x + 1);
		x = prob * (x + 1);
	}
	printf("%.1lf", d);
}
```

