这个是自新 op2，但是我更喜欢 op1。

---

学习题解。

考虑按右端点做扫描线。

我们首先希望维护一个 $p_x$ 表示 $\forall y\in [x,i]$，区间 $[x,y]$ 的答案。那么将右端点进行移动（$r-1\to r$）就是要将所有以 $r$ 为右端点的区间加入。

注意到：若 $[x,r-1]$ 和 $[x,r]$ 这两段区间的贡献不同，这类 $x$ 是从 $r$ 开始的一段连续区间，且长度总和为 $O(n\log n)$——两段区间贡献不同当且仅当 $\text{or}$ 和、$\text{and}$ 和或 $\gcd$ 值中有至少一个不相同。

所以可以将 $p$ 写成 $kr+b$ 的形式，其中 $k$ 是 $[x,r]$ 的贡献。移动右端点的时候进行 $O(n\log n)$ 次修改。$b$ 的维护方式可以通过简单的推导得到（正确的话应该不包含“上次修改 $k$ 的时间”）。并且连续取 $\gcd$ 的时间复杂度为 $O(\log n)$，所以对 $p$ 的修改可以 $O(n\log n)$ 完成。然后需要求 $p$ 的后缀和，这个直接维护 $p$ 的前缀和就行了。

总的时间复杂度是 $O(n\log n+q)$。写个 mmap 再卡点常数就能过。