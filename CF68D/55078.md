优美的题。

考虑最后一定是分成了一条链上的点和一些子树上的点的拼合。

很套路地计算每棵子树的贡献。

容易发现，我们以根节点剖分的时候，当当前子树 $u$ 的子树和比任何一个其他子树的子树和小的时候，他的所有子树都没用了。

那么直接暴力 dfs 的时候维护一个 max 就行了。

为什么复杂度是对的？

考虑线段树的证明过程。读者自证不难。

代码链接：https://www.luogu.com.cn/paste/vylqy0o8