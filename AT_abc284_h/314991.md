注意到 $k=1$ 时即为 [无标号无向图计数](https://www.luogu.com.cn/problem/P4727)，考虑使用相同方法。快进到对于置换 $g$ 计算稳定子个数。我们可以将图在 $g$ 作用后同构拆解为 图的边同构 和 图的颜色同构。对于边同构而言，容易得到与原题相同的结论：若 $g$ 可以被拆为 $c(g)$ 个轮换，第 $i$ 个轮换大小为 $b_i$，则可以将边划分为 $l=\sum_{i=1}^{c(g)}\lfloor\frac{b_i}{2}\rfloor+\sum_{i=1}^{c(g)}\sum_{j=1}^{i-1}\gcd(b_i,b_j)$ 个等价类，每个等价类必然全选或全不选，因此有 $2^l$ 种边同构的图。而对于本题所增加的颜色同构，不难发现若一种染色方法在置换 $g$ 作用下是稳定子，那么同一轮换内的点所染颜色必然相同，至于 “所有 $k$ 种颜色均出现” 的限制不难二项式反演去掉。具体而言，染色方法共有 $\sum_{i=0}^k(-1)^i\binom{c(g)}{i}(k-i)^{c(g)}$ 种。由于边的同构和颜色的同构之间相互独立，因此稳定子数量即为这两者的乘积。照搬原题做法，枚举分拆计算贡献，即可做到 $O(p(n)n^2)$，其中 $p(n)$ 为分拆数。