发现对于一个数列的答案求法类似于从小到大考虑赋值给递增的 $a_i$。

比如 $4\ 1\ 5\ 4\ 1\ 1$ 即 $\ 2\ 1\ 4\ 3\ 1\ 1$。

发现特殊的是每一个值可能对应一个值域上的不交区间，记 $x$ 对应的区间为 $[l_x,r_x]$，上面例子中 $l_4=2,r_4=3$。

考虑每次插入一个数 $a_i$ 对答案的影响。

- 若 $r_{a_i}<a_i$ 则 $a_i$ 可以起到更新答案的作用。令 $r_{a_i}\gets r_{a_i}+1$，从小到大更新 $x$ 满足 $x>a_i$。
  - 若 $r_x<x$，则 $l_x\gets l_x+1,r_x\gets r_x+1$。
  - 否则停止更新。
- 否则由于 $a_i$ 只能通过操作减小，所以对答案无影响。

停止更新即 $r_x=x$，我们可以使用线段树维护值对应区间以及最小的 $x-r_x$ 还有答案等。可以通过线段树二分找到 $r_x=x$，然后若满足 $r_{a_i}<a_i$ 就在区间 $[a_x+1,x-1]$ 上更新 $l,r$ 即可。时间复杂度 $O(n\log n)$。

