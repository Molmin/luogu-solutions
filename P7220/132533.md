**P7220** 

此题的加强版即为 Ynoi 的 T166，期望在 2077 年加入出题库。

**无序性**：观察到一段连续的 $H/V$ 操作其实是可以无续操作的。

**非容斥事件的无序性**：观察到对于一个间接的插入，根据上文同类操作的无序性，我们维护异类操作互相的影响。

这里的影响是抽象的，以 $H$ 操作举例，我们维护 $l_V$ 在该操作之前小于该 $n - l_{H_i}$ 最大的 $l_V$，即确定了该 $H$ 操作实际影响的矩形。

考虑任意一个查询等价于一个点从第 $l$ 个修改开始到第 $r$ 个修改结束后的点状态。

问题变成：给定 $m$ 个修改操作，等价于将一个矩形内的点的 $(x,y)$ 中的一维取到一个给定的矩形边界，给定 $q$ 个询问，且每个矩形信息由查询的区间信息决定，但修改具有子问题划分的性质。

考虑建立线段树，对于每个修改区间 $[l,r]$ 维护出当前每个位置的矩形，我们显然可以将修改看作一个函数层面上的映射，所以将一个点 $x \rightarrow f_1(x) = y,y \rightarrow f_2(y) = z$ 这样，在线段树上做 $O(\log n)$ 次无序的二维数点，即排一下序退化到一维的数点即可。

时间复杂度 $O(m \log q \log n)$。

此题在谷上空间限制太小，建议去 loj 交。