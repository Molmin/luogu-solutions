提供一个相当简单的线性做法。

求出 $dp_{i,j}$ 表示以 $i$ 为根的 $j$ 叉树的最深深度，显然这里只有 $O(n)$ 个大于 $1$ 的状态（因为每个点的状态数是其儿子数量）。这是很好线性求的。

然后枚举 $k$ 即可，将所有儿子数 $\ge k$ 的点跑虚树求解。这里实现的好就是线性的。

这里虚树可以通过链表删除或者归并求出 dfn 排序的结果，还要写一个 $O(n)-O(1)$ LCA。

[CF 评测记录，里面封装了一个写法很优秀的 O(n)-O(1) LCA](https://codeforces.com/contest/955/submission/172357555)