我们考虑建出操作树，先进行一次 $\text{dfs}$，将加边操作判断是否合法（是否已连通），处理出操作树上每个加边操作并查集的根，询问操作并查集的根。

将权值离散化，使得每个权值唯一对应一个点，对值域分块。

对于每个值域块进行一次 $\text{dfs}$，得出每个询问的答案在哪一个值域块内。

对操作树分块，这里分块的要求是选出 $O(\frac{m}{B})$ 个点使得树上任意一个点存在一个不超过 $O(B)$ 级祖先为关键点，$B$ 取 $\sqrt{m}$。

我们称一个点所属的块的根为离它最近的为关键点的祖先（包括自己），有同一个所属的块的根的节点属于同一块。

对于每一个块，我们可以 $O(m)$ 处理出操作到这个块根时，每个点所属的并查集的根。块内每个询问的状态是从根处状态合并 $O(B)$ 次连通块形成的，我们把这 $O(B)$ 次合并连通块拿出来，$\text{BFS}$ 一遍就可以知道哪些并查集的根与询问节点属于同一连通块，枚举答案所在值域块内点，得到答案，我们就完成了一个时间 $O(n\sqrt{n})$，空间 $O(n)$ 的算法，$n,m$ 同阶。 

代码不想给，写的太丑，都跑到最劣解了/kk。

ps：我不知道这题啥毛病，我值域分块块长 $3500$ 最快。