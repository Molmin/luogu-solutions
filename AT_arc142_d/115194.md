首先显然，一个合法的摆放棋子的方式可以映射到一种将树划分为若干条有向链的方案，满足对于每条链而言，一开始只有箭头处的位置没有棋子，其他位置都有棋子，这样在第奇数轮，所有棋子都向箭头方向移动一步，在第偶数轮，所有棋子都向箭尾方向移动一步。

但是并不是所有链划分的方案都能对应一种合法的摆放方案。因为我们链划分只能保证每轮存在移动方案，并不能保证其唯一性。考虑什么样的链划分方案才能保证唯一性。首先箭尾不能相邻，否则它们可以合并成一条链。同理箭头不能相邻，因为箭头操作一次后就变成了箭尾。再其次，箭身只能和箭身相邻，因为如果箭身和箭尾相邻，那么这一部分就不止有一种链的对应方法，第一次操作也就不唯一。

这样我们可以设 $dp_{u,0\sim 7}$ 表示，现在确定了 $u$ 子树内每个点是什么类型，现在

- 0：该点是箭身，没有前驱没有后继。
- 1：该点是箭身，有前驱没有后继。
- 2：该点是箭身，没有前驱有后继。
- 3：该点是箭身，有前驱有后继。
- 4：该点是箭头，无前驱。
- 5：该点是箭头，有前驱。
- 6：该点是箭尾，无后继。
- 7：该点是箭尾，有后继。

还是分类讨论进行 DP 转移即可。