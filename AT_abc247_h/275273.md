考虑我们如何判定一个排列是否能成为最终答案。连边 $i \to p_i$，设环数为 $k$，那么最少交换次数为 $n - k$。那么充要条件是，每个环所有点的 $c_i$ 相同，并且 $n - k \le K$ 且 $2 \mid (K - (n - k))$。$K$ 和 $n - k$ 奇偶性相同是因为，如果交换 $p_i, p_j$，其中 $i \ne j$，那么环数**恰好改变** $1$。这个的证明是平凡的，考虑它们原本在或者不在同一个环内即可。

也就是说现在要求出，每个环所有点的 $c_i$ 相同，共形成了 $k$ 个环的 $p_i$ 的方案数。考虑一个 $O(n^2)$ 的 dp，$f_{i, j}$ 表示，考虑了 $1 \sim i$，共形成了 $j$ 个环的方案数。转移就是讨论 $i$ 这个点是自环还是加到之前的环里面。设 $a_i = \sum\limits_{j = 1}^{i - 1} [c_j = c_i]$，于是有：

$$f_{i, j} = f_{i - 1, j - 1} + f_{i - 1, j} \times a_i$$

考虑优化。发现经过一次转移，$f_{i, j}$ 可能转移到 $f_{i + 1, j}$ 和 $f_{i + 1, j + 1}$。考虑构造多项式 $g(x) = \prod\limits_{i = 1}^n (a_i + x)$，就是要求 $g(x)$ 的第 $1 \sim n$ 次项。直接乘起来复杂度不对，考虑一个分治，分治区间 $[l, r]$ 表示计算 $\prod\limits_{i = l}^r (a_i + x)$。设 $mid = \left\lfloor\frac{l + r}{2}\right\rfloor$，把 $[l, mid]$ 和 $[mid + 1, r]$ 的结果乘起来即可。时间复杂度 $O(n \log^2 n)$。

[code](https://atcoder.jp/contests/abc247/submissions/41884276)