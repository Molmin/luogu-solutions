对这个问题考虑一个 dp ，设 $dp_i$ 表示路径长度 $\bmod m=i$ 的路径条数。设两层之间长度为 $i$ 的路径有 $num_i$ 条，可以得出转移式：

$$
dp_{i\bmod m}=\sum_{j=0}^i f_j\times w_{i-j}
$$

发现题目有个特殊性质：每一层之间的边都是相同的。所以每一层之间的转移都是相同的。

我们设 $g_i=w_i$ , $f_i$ 为第 $i$ 层的 dp 数组，这玩意就转化成了一个类似卷积的形式，转移式为 $f_{i+1}=f_i\cdot g_i$ 。那么由于每一层的 $g_i$ 是相同的，因此 $f_i=f_0\cdot g_i^i$ 我们可以用快速幂来优化转移。

这里注意一个细节，由于到了最后一层的点之后，只能从相应的连向汇点的边到达汇点，因此我们需要把连向最后一层的边和连向汇点的边合起来一起转移。