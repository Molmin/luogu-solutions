考虑转换 $p$ 的下标和值，即构造新的序列 $q$，满足 $q_{p_i}=i$，则构造这颗树的过程可以看作从左到右扫 $q$，到 $q_i$ 时，找到前缀最大值 $q_j=\max_{k=1}^{i-1}{q_k}$，然后连边 $(q_j,q_i)$。

若新扫到的数 $q_i$ 是新的前缀最大值，那么后面的一些数会连向 $q_i$，否则后面的一些数还会连向 $q_j$（直到出现新的前缀最大值）。

于是可以发现，树的形态一定是一条链上挂了一些点，且链上的点一定是 $q$ 序列的前缀最大值。

于是统计主链上每个点的度数 $d$，设当前编号分配到了 $s$，则把挂在当前点上的点分配 $s+1\sim s+d$，当前点为 $s+d+1$ 即可（由于要求字典序最小，故这样一定是更优的）。

主链的两个方向都做一次，输出字典序较小的即可。