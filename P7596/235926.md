先下一些简单的定义：
- $posa$ ：小 $A$ 蛇头的位置。
- $lena$ ：小 $A$ 的长度。
- $posb$ ：小 $B$ 蛇头的位置。
- $lenb$ ：小 $B$ 的长度。

---

考虑一种简单的 $O(qn^2)$ 做法：

我们枚举 小 $A$ 和 小 $B$ 的每一步行动，并判断当前移动的蛇是否可以进入“副链”。

一条蛇可以拐进副链，必须满足对方在他之前先无法移动。那么我们以小 $A$ 为例，讨论一下什么时候可以拐进副链（小 $B$ 可以同理得出）：

1. 小 $A$ 不能被 小 $B$ “碾压”，也就是不能使小 $B$ 走到和小 $A$ 一样的副链。分析一下，就是他们之间的距离严格小于小 $A$ 的长度。

$$posb-posa < lena$$

2. 小 $B$ 在小 $A$ “右边”，无论怎么走都会先无法移动。

$$x_{posa}>\max_{i=posa+1}^{posb} posb-i+x_i$$

显然，满足这两个条件，小 $A$ 拐进副链后就可以获胜了。

---

考虑简单的优化。

上一个算法时间复杂度瓶颈是枚举 $\max_{i=posa+1}^{posb} posb-i+x_i$ 。

我们可以直接用 $ST$ 表维护 $\max_{i=l}^{r} x_i-i$ ，然后就可以 $O(1)$ 得到上面这个式子的答案了。

然后就 $O(qn)$ 了。

---

考虑 $n$ 很小时怎么做。

我们将满足 $x_{posa'}>\max_{i=posa'+1}^{posb'} posb'-i+x_i$ 的 $posa'$ 称为“必胜点”（$posa',posb'$ 表示某一轮到 小 $A$ 移动的时刻，小 $A$ 和 小 $B$ 蛇头的位置。显然 $posa'-posa=posb-posb'\geq 0$），记为 $c$ 。

对于每一对 $(posa,posb)$ ，我们可以得到所有必胜点的集合，记为 $S_{(posa,posb)}$ 。

那么对于所有的 $(posa,posb)$ ，可以 $O(n)$ 算出它的必胜点集合。

询问时我们可以通过刚才算出的 $posa$ 的范围，在 $S_{(posa,posb)}$找到 小 $A$ 最近的“可用必胜点”。同理，我们也可以找到小 $B$ 最近的“可用必胜点”。然后比较一下这两条蛇谁先到达“可用必胜点”，就可以了。

注意特判没有必胜点的情况。

时间复杂度：$O(n^3+q\log n)$ 

---

奇怪的优化。

定义“广义必胜点”为满足 $x_{posa'}>\max_{i=posa'+1}^{posb'} posb'-i+x_i$ 的 $posa'$ 。在这里，我们仍需满足 $posa'-posa=posb-posb'$，但无需满足 $posa'-posa\geq0$ 。

对于每一对 $(posa,posb)$ ，我们可以得到所有“广义必胜点”的集合，记为 $S'_{(posa,posb)}$ 。

我们会发现一个很神奇的现象：对于所有 $posa+posb$ 相等的 $(posa,posb)$ ，$S'_{(posa,posb)}$ 都相同！

为什么呢？因为显然，对于和相同的 $(posa,posb)$ ，它们能到达的 $(posa',posb')$ 是一样的。因为根据定义，$posa'-posa=posb-posb'$ ，那么 $posa'+posb'=posa+posb$ 。所以这个结论成立。

因此，我们只需求出所有 $S'_{(1,i)}$ 就可以了。

那么时间复杂度为 $O(n^2+q\log n)$ 。

---

考虑优化求出所有 $S'_{(1,i)}$ 的过程。

我们可以算出对于每一个点，它可以被包含在哪些 $S'_{(1,i)}$ 中。

一个显然的单调性，随着 $i$ 的增大，这个点作为“广义必胜点”的“优势”会减小。

可以这样理解：有局面 $(1,i)$ ，其中 $c$ 是“广义必胜点”。然后随着 $i$ 的增大，可以认为小 $B$ 的位置右移了。在这种情况下，无论何时，小 $A$ 的优势都会减小。因此这是对的。

那么算法就很显然了：
- 对于每个点 $i$ ，它可以作为 $S'_{1,i} \sim S'_{1,R_i}$ 的广义必胜点。我们二分求出每个 $R_i$ 。
- 然后我们把询问按 $posa+posb$ 离线下来，从小到大扫描 $i$ ，更新 $S'_{1,i}$ 。具体如何更新呢？先维护一个 $set$ ，然后使用类似差分的方法，在 $i=j$ 时，把 $j$ 插入。在 $i=R_j$ 时，把 $j$ 删除。
- 对于每组询问，找出小 $A$ 的最近可用必胜点。
- 同理找出小 $B$ 的最近可用必胜点，比较谁先到达。特判没有必胜点的情况。

时间复杂度：$O((n+q)\log n)$