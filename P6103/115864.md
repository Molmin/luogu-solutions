这里主要讲一下优化做法，最好在搞明白 $\Theta(n^2)$ 暴力递推后再看。

设 $A(x),B(x),C(x),D(x),E(x)$ 分别为 语句、程序片段、语句块、函数、值 这五种在字符串长度为 $n$ 时答案的生成函数。

那么容易列出如下函数方程组：

$$\begin{cases}B(x)=A(x)B(x)+1  \\ A(x)=C(x)+xD(x)+xE(x)+x \\ C(x)=x^2B(x) \\ D(x)=x^2C(x)+x^4C(x)+x^2D(x) \\ E(x)=x^2D(x)+x^2E(x) \end{cases}$$
接下来就是解这个五元方程组，看起来非常恶心但解并不很难。

由 $(3)$ 式代入 $(4)$ 式，得
$$D(x)=x^2D(x)+x^4B(x)+x^6B(x)$$
$$D(x)=\frac{x^4+x^6}{1-x^2}B(x)$$
再将解出的 $D(x)$ 代入 $(5)$ 式
$$E(x)=\frac{x^6+x^8}{1-x^2}B(x)+x^2E(x)$$
$$E(x)=\frac{x^6+x^8}{(1-x^2)^2}B(x)$$
将前面解出的结果一同代入 $(2)$ 式  
$$A(x)=x^2B(x)+\frac{x^5+x^7}{1-x^2}B(x)+\frac{x^7+x^9}{(1-x^2)^2}B(x)+x$$

$$A(x)=x^2B(x)+\frac{x^5+x^7}{(1-x^2)^2}B(x)+x$$
$$A(x)=\frac{x^2-2x^4+x^5+x^6+x^7}{1-2x^2+x^4}B(x)+x$$
最后回到 $(1)$ 式，已经胜利在望了！
$$B(x)=\frac{x^2-2x^4+x^5+x^6+x^7}{1-2x^2+x^4}B(x)^2+xB(x)+1$$
这是一个二次函数方程，暴力求解（指多项式开根）可以做到 $\Theta(n \log n)$。

但这样还是比较暴力，如果能 $\Theta(n)$ 算出这个二次方程中的 $\sqrt \Delta$，剩下的就能线性解决了。  
略去一堆麻烦的计算，能得到
$$\sqrt \Delta=\frac{\sqrt{1-2x-5x^2+4x^3+7x^4-6x^5-3x^6-4x^7}}{1-x^2}$$

分母很简单可以先不管，分子这个多项式比较短♂，可以利用这个式子快速开根（也适用于所有实数幂）：  
$$f(x)=g(x)^k$$
$$f'(x)g(x)=kf(x)g'(x)$$
过于显然就不证明了，提取系数就有
$$\sum_{i=0}^n(i+1)f_{i+1} g_{n-i}=k\sum_{i=0}^n(i+1)g_{i+1}f_{n-i}$$
$$(n+1)g_0f_{n+1}+\sum_{i=0}^{n-1}(i+1)f_{i+1}g_{n-i}=k\sum_{i=0}^n(i+1)g_{i+1}f_{n-i}$$
这样就能递推计算 $f(x)$ 的系数，别忘了 $g(x)$ 次数是个小常数，高次系数都为 $0$，所以算一项的复杂度为 $\Theta(1)$ 而非 $\Theta(n)$。  
至此就能 $\Theta(n)$ 计算 $\sqrt \Delta$ 的所有 $n$ 项系数了。 

最后还要除一个原方程的二次项系数（也是一个多项式），还可以用上面提到的方法求逆，然后暴力乘上分子就好了，同样是 $\Theta(n)$ 的，就不再赘述（

代码太丑就不贴了。

顺便提一句，可以证明 $B(x)$ 微分有限，那么 $b$ 为整式递推数列（这在 zzq 的 IOI2019 候选队论文中有证明），求其第 $n$ 项可以做到 $\Theta(\sqrt n \log n)$。  

这里它是一个 $14$ 阶 $1$ 次的的整式递推，感兴趣的同学可以把递推式搞出来。 