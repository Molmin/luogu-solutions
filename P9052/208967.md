首先题意可以转化为从 $A$ 点开始的任意一条路径都经过 $B$。

必要性：如果有一条路径不经过 $B$，那么 Bob 就沿着这条路径选就是了。

充分性：从 $A$ 点开始，Bob 选择任意一个出边指向的点 $x$，根据定义有 $x$ 点开始的任意一条路径都经过 $B$。显然 Bob 在走到 $B$ 点前没法选择之前走过的点，不然成环且这个环内不包括 $B$，不符合定义，那么最后一定能走到 $B$。

上面这条性质多少沾点支配树了（感觉是只会支配树），但是支配树是求 $A$ 点到 $C$ 点的任意一条路径都经过 $B$ 这样子。需要进一步观察性质。

如果 $(u,v)$ 和 $(u,v')$ 都合法，显然 $(v,v')$ 和 $(v',v)$ 至少一个合法，且关系具有传递性。所以我们可以拉出几个极大子图 $G$，满足子图内存在 $root$，使得 $\forall i \in G$ 有 $(i,root)$ 合法。于是若 $(x,y)$ 的两点不在同一子图，就不可能合法，问题独立开来了，而且满足 $\forall i \in G$，任意一条路径都经过 $root$，我们把 $root$ 的出边删掉之后就是一个 DAG，可以建支配树维护了。

关于拉极大子图，可以枚举每个点当 $root$，反向拓补出 $S$ 满足 $x\in S$，$(x,root)$ 合法。显然 $S_x,S_y$ 要不不交要不包含，对于已经被扔进 $S$ 的点不去拓补，保证总拓补时间复杂度是线性的。但是如果一个已经被扔进 $S_x$ 的点在 $root=y$ 的时候应该被拓补，那么最后把 $S_x$ 和 $S_y$ 合并，显然可能对于一个 $y$ 可能有多次合并，所以要启发式合并的。

先考虑 $k=n$ 的情况，考虑定 $x$ 计算有多少个 $y$ 满足 $(x,y)$ 合法，首先是 $x$ 在支配树上的祖先，以及 $root$ 的出边连向的所有点的 lca 的祖先（包括 lca）。

扩展到 $k \in [1,n]$ 上，就是预处理每个 $x$ 到自己的最近支配点 $y$ 可能经过的点的编号最大值 $w$。对 $k$ 从大到小做扫描线，如果 $w_{x}>k$ 就把边断掉。关于维护的话就是拉 dfn 线段树维护 $f(x)$ 表示 $x$ 在支配树上的祖先（如果 $(x,y)$ 之间有断边就不管）。单点查全局查区间减即可。

需要注意若 $x$ 与 $root$ 仍然相连，那么 $x$ 的贡献还需要加上“$root$ 的出边连向的所有点的 lca 的祖先”（当然也考虑断边）。特判一下就好了。