观察到每个数贡献的系数为 $2^p$，$p$ 具有以下性质：

1. $p_1=0$
2. $\forall i>1,p_i\ge 1$
3. $p_i\le p_{i-1}+1$

必要性是显然的，对于充分性，考虑数学归纳法。

$n=1$ 显然成立。对于 $n>1$，找到最后一个 $p_i=1$（注意到 $p_2=1$，必然可以找到），使得将 $i-1$ 和 $i$ 最后一个合并，那么分裂为 $[1,i-1]$ 和 $[i,n]$ 两部分。$[1,i-1]$ 显然满足条件，$[i,n]$ 全部减一，然后只有开头是 $0$，同样满足条件。

不妨特判 $p_1$，然后令 $p_{2\dots n}$ 从零开始。

注意到最优解中 $p_i=p_{i-1}+1$ 或 $p_i=0$。这个性质感觉是显然的，就，如果 $a_i\ge 0$ 那肯定 $p_i=p_{i-1}+1$；如果 $a_i<0$，就如果以 $i$ 开始的某个子段贡献是正的就 $p_i=p_{i-1}+1$，否则 $p_i=0$。

所以 $p$ 的结构是若干段从零开始单调递增的段。

考虑逐个从末尾加数，每个数的 $p$ 会发生变化，且只会从 $0$ 变成 $p_{i-1}+1$，就这个后缀有任何一个正的前缀就应该会变成 $p_{i-1}+1$。

而且这个结构后缀应该是最优的，这个性质感觉显然。

那就显然了，扫描线维护单调栈状结构，每次从末尾加数然后如果是正的就肯定要和上一个合并，否则肯定不能合并，查询就对单调栈维护个前缀和，二分一下分整段和一个散段，维护一下 $a_i2^i$ 的前缀和 $O(n+q\log n)$ 的。