经典题，考虑区间 dp，$f_{l,r}$ 表示只考虑 $[l, r]$ 区间，先手得分减后手得分最大值。

对于第一种操作直接 $f_{l,r} \gets \max(a_l - f_{l+1,r}, a_r - f_{l,r-1})$，第二种操作，考虑枚举 $[l,r]$ 长为 $r - l + 1 - B$ 的子段，即可转移。第三种操作同理。

那么我们得到了[一个 $O(n^3)$ 的做法](https://atcoder.jp/contests/abc303/submissions/41798440)。考虑优化。发现瓶颈在于枚举子段。发现因为子段长度固定，所以可以直接查固定区间长度的形似 $f_{p,p+k-1}$ 的最大值。考虑使用 ST 表，按区间长度从小到大计算每个 $f_{l,r}$，当一个长度的区间都计算完了，就把它们扔给 ST 表预处理。

时空复杂度均为 $O(n^2 \log n)$。

[code](https://atcoder.jp/contests/abc303/submissions/41798797)