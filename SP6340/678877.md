[题目传送门](https://www.luogu.com.cn/problem/SP340)

容易想到区间 dp，考虑设计状态。

首先如果只有 $l,r$ 两维的话，是无法转移的。然后发现 $m$ 是转移的一个必要的条件，可将加入 $m$ 这一维。由于是区间 dp，所以只需考虑向左或向右加珠子，不妨令 $f_{i,j,k}$ 为向左放 $k$ 颗与 $i$ 珠相同颜色的珠子后消除 $[i,j]$ 的最少步数。

$f$ 首先要赋为一个极大值，初始条件显然为 $f_{i,i,j}=k-1-j$。

转移需要分类讨论一下。

首先，如果 $a_i = a_{i+1}$，就可以从 $f_{i+1,j,k+1}$ 递推而来。
然后也可以由 $f_{i,j,k+1}$ 递推得到，即在前面多一颗珠子。还有一个就是找到某点 $p$，满足 $a_i=a_p$，此时就是 $f_{i+1,p-1,0}+f_{p,j,k+1}$。

即 $f_{i,j,k}=\min\{f_{i+1,j,k+1},\min\limits_{p=i+1,a_i=a_p}^{j}\{f_{i+1,p-1,0}+f_{p,j,k+1}\}, f_{i,j,k+1}+1\}$。

[评测记录](https://www.luogu.com.cn/record/118941335)