#### 前言

~~看了下剩余的两篇题解，可以说除了方向相同就没有共同点了。~~

#### 正文

这个题显然的融合，两问之间并无联系，所以分开解决。

在此之前做出一些定义：

- $ r=\prod\limits_{i=1}^{m}(1-p_i) $
- $ r'=\prod\limits_{i=0}^{m}(1-p_i)=r(1-p_0) $

形象地来看，对于每一天每个零食，$ r $ 即为所有小朋友都不会吃到它的概率，$ r' $ 即为 Ys 和小朋友都不会吃到它的概率。

首先来解决第一个问题：Ys 期望吃掉多少零食。

可以发现题目中的计划之后 $ T $ 天吃掉可以进行转化，变为前 $ T $ 天只有小朋友能吃，然后对于题目条件列出式子：

$$ Q_1=n\sum_{i\geq T+1}r^Tr'^{i-T-1}p_0 $$

好的，来看一下这个式子，$ n $ 个零食是一样的，所以先对于每个零食求解再乘上数量。第一项表示前 $ T $ 天这个零食不被小朋友吃掉的概率，第二项表示在接下来的 $ i-T-1 $ 天这个零食不被 Ys 和小朋友吃掉的概率，第三项表示 Ys 在第 $ i $ 天吃掉这个零食的概率。

$$ Q_1=np_0\sum_{i\geq T+1}(\frac {r'} {1-p_0})^Tr'^{i-T-1} $$

$$ Q_1=\frac {np_0} {(1-p_0)^T}\sum_{i\geq T+1}r'^{i-1} $$

$$ RHS=\sum_{i\geq T+1}r'^{i-1}=\sum_{i\geq T}r'^{i} $$

$$ RHS=\sum_{i\geq 0}r'^i-\sum_{i=0}^{T-1}r'^i=\frac 1 {1-r}-\frac {r^T-1} {r-1} $$

$$ Q_1= \frac {np_0} {(1-p_0)^T}RHS $$

至此，第一个问题已顺利解决，接着来看第二问：零食期望在几天后吃完。

这类全部完成的问题显然可以转化为第一次完成，使用 min-max 容斥：

$$ E[\max\{P\}]=\sum_{\varnothing\neq Q\subseteq P}(-1)^{|Q|-1}E[\min\{Q\}] $$

在本题中，$ \max $ 可理解为所有零食都被吃掉，$ \min $ 可理解为集合中某一个零食被吃掉。由于零食之间是不区分的，所以可以改写式子，使其只与集合大小有关（咋逐渐二项式反演了呢）：

$$ Q_2=\sum_{S=1}^n(-1)^{S-1}\binom n S g(S) $$

来看一下这个式子，$ \binom n i $ 表示子集个数，$ g(S) $ 是一个作用于整数 $ S $ 上的函数，表示 $ S $ 个零食，其中某一个零食被吃到的期望时刻。$ n $ 是可枚举范围内的，所以只需快速求出 $ g(S) $ 即可。

先做出一些定义：

- $ q=r^S $
- $ q'=r'^S=q(1-p_0)^S $

形象地来看，对于每天这 $ S $ 个零食，$ q $ 即为所有小朋友都不会吃到它的概率，$ q' $ 即为 Ys 和小朋友都不会吃到它的概率。

$$ g(S)=\sum_{i=1}^Tq^{i-1}(1-q)i+\sum_{i\geq T+1}q^Tq'^{i-T-1}(1-q')i $$

这个式子的前半部分表示前 $ T $ 天被吃掉的期望，即只有小朋友，后半部分表示 $ T+1 $ 天以后被吃掉的期望，即 Ys 也参与进来。令左式为 $ LHS $，右式为 $ RHS $。

$$ LHS=\sum_{i=1}^Tq^{i-1}(1-q)i=(1-q)\sum_{i=0}^{T-1}q^i(i+1) $$

$$ RHS=\sum_{i\geq T+1}q^Tq'^{i-T-1}(1-q')i $$

$$ RHS=\sum_{i\geq T+1}(\frac {q'} {(1-p_0)^S})^Tq'^{i-T-1}(1-q')i $$

$$ RHS=\frac {1-q'} {(1-p_0)^{ST}}\sum_{i\geq T}q'^i(i+1) $$

还是太复杂，令 $ X=\sum\limits_{i\geq T}q'^i(i+1) $

$$ RHS=\frac {1-q'} {(1-p_0)^{ST}}X $$

$$ X=\sum_{i\geq T}q'^i(i+1) $$

$$ X=\sum_{i\geq 0}q'^i(i+1)-\sum_{i=0}^{T-1}q'^i(i+1) $$

减号前半部分直接使用二项式定理扩展：推得 $ \frac 1 {(1-q')^2} $

然后我们发现后半部分有些眼熟，它的类似形式在上文求解 $ LHS $ 出现过，所以不妨定义出一个函数：

$$ R(n,x)=\sum_{i=0}^nx^i(i+1) $$

$$ xR(n,x)=\sum_{i=0}^nx^{i+1}(i+1)=\sum_{i=0}^nx^{i+1}(i+2)-\sum_{i=0}^nx^{i+1} $$

$$ xR(n,x)=\sum_{i=0}^{n+1}x^i(i+1)-\sum_{i=0}^{n+1}x^i $$

$$ xR(n,x)=R(n,x)-\sum_{i=0}^{n+1}x^i+x^{n+1}(n+2) $$

$$ (x-1)R(n,x)=x^{n+1}(n+2)-\frac {x^{n+2}-1} {x-1} $$

$$ R(n,x)=\frac {x^{n+1}(n+2)} {x-1}-\frac {x^{n+2}-1} {(x-1)^2} $$

$$ LHS=(1-q)R(T-1,q) $$

$$ RHS=\frac {1-q'} {(1-p_0)^{ST}}X,X=\frac 1 {(1-q')^2}-R(T-1,q') $$

$$ g(S)=LHS+RHS $$

$$ Q_2=\sum_{S=1}^n(-1)^{S-1}\binom n S g(S) $$

至此，整个问题已经基本解决，只需对特殊情况进行一些特判便可通过此题。