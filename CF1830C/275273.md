每一步思路都非常自然的题。

考虑先从一些简单的 case 入手。

### 1. $k = 0$

设 $g_i$ 为长度为 $i$ 的合法括号串数。显然 $\forall i \nmid 2, g_i = 0$。对于偶数的 $i$，这是一个经典问题，$g_i$ 就是第 $\frac{i}{2}$ 项卡特兰数，因此 $g_i = \binom{i}{\frac{i}{2}} - \binom{i}{\frac{i}{2} - 1}$。

### 2. 区间互不相交

考虑把这些区间删去，那么剩下的括号也要构成合法括号串。设 $len_i$ 为第 $i$ 个区间的长度，$r$ 为区间长度总和，答案即为 $g_{n - r} \times \prod\limits_{i=1}^k g_{len_i}$。

### 3. 区间两两不交或包含

考虑建树，每个区间向**包含它且最短的区间**连边，那么会构成一片森林。设 $f_u$ 为第 $u$ 个区间**内部**的方案数，$r_u$ 为 $\sum\limits_{v \in son_v} len_v$，那么由互不相交的 case 我们得到 $f_u = g_{len_u - r_u}\prod\limits_{v \in son_u} f_v$。

### 4. 区间可能相交并且不包含

举个例子，如果 $[3, 6]$ 和 $[5, 8]$ 都是合法括号串，画出折线图，可以发现相当于 $[3, 4], [5, 6], [7, 8]$ 都是合法括号串。也就是我们要把相交的部分分裂出来。考虑异或哈希，每个区间赋一个随机权值，把区间里的每一个数都异或上这个权值，最后把每个权值**第一次出现的位置**和**最后一次出现的位置**拎出来作为新的区间。显然它们只会两两不交或包含了。

复杂度是线性对数。

[code](https://codeforces.com/contest/1830/submission/207643493)