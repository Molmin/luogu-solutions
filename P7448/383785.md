二维分块板。

首先这道题是不弱于 ylstII 的，即复杂度至少 $\mathcal O(n\sqrt n)$，跟着 ylstII，考虑二离。

为方便讲，只讲右端点扩展的情况，其他三种同理。因为他是本质不同逆序对，所以：

- 如果他的前一个相同的数（设为 $x$）在区间外：加上 $[l,r]\to r+1$ 的贡献。

- 否则加上 $[x+1,r]\to r+1$ 的贡献。

因为他贡献区间是变化的，所以考虑不用前缀拆贡献，直接算。那么我们就需要一个数据结构，支持 $\mathcal O(\sqrt n)$ 加入一对 $x_i, y_i$，$\mathcal O(1)$ 查询 $x\ge x_i~\land~y\ge y_i$ 的对数，满足所有 $x_i,y_i$ 互不相同.

**人类智慧二维分块**：

讲他之前，先来看一个简单点的例子：

如何做到 $\mathcal O(1)$ 修改、$\mathcal O(^3\!\!\!\sqrt n)$ 查询的 [线段树 1](https://www.luogu.com.cn/problem/P3372)？

分块，以 $n^{\frac 23}$ 为块长，维护和、暴力询问，这样整块的复杂度是对的，但是散块却是 $\mathcal O(n^{\frac 23})$ 的，于是考虑再分一个 $n^{\frac13}$ 的块，复杂度就平衡掉了。

回归正题。

考虑一个 $n\times n$ 的二维平面，将其以 $n^{0.75}\times n^{0.75}$ 分块，嵌套 $n^{0.5}\times n^{0.75}$ 与 $n^{0.75}\times n^{0.5}$ 的块，再嵌套 $n^{0.5}\times n^{0.5}$ 的块，每一种块存的都是他在他作用域内的前缀和（最大块 $n\times n$，次之 $n\times n^{0.75}$，再次则是 $n^{0.75}\times n^{0.75}$，见下图），这样每次修改是 $n^{0.25}\times n^{0.25}=\sqrt n$ 的。

![](https://cdn.luogu.com.cn/upload/image_hosting/3f23w8zl.png)

（图片比较草，将就看）

对于查询，我们会发现整块查完了 $\sqrt n\times\sqrt n$ 的散块还得处理。此时抓住性质：$x,y$ 不重复，询问的点都是已插入的点，则可在修改时将在同 $\sqrt n$ 行/列且在插入点右上方的点加贡献。

实现相关细节：

- 为了维持性质，先将原数组的相同数变成不同（$1,1,4,5,1,4$ 变成 $1,2,4,6,3,5$）

- 操作时注意去除相等元素的贡献

- 两个块长必须成倍数

代码就不放了，有需要私信