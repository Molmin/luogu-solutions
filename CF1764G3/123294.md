这种题目一般都考虑从较特殊的 $k = 2$ 或 $k = n$ 入手。$k = n$ 看起来不太可行，因此考虑 $k = 2$。

从 $30$ 次询问限制可以想到二分。设 $\mathrm{solve}(l, r)$ 表示已知答案 $a \in [l, r]$，希望确定答案。设 $m = \frac {l + r} 2$。

关键问题在于确定答案究竟在 $[l, m]$ 还是 $[m + 1, r]$ 中。这里有个有趣的思想，就是我们不能将眼光仅局限于 $[l, r]$，因为 $\mathrm{solve}(l, r)$ 并不是一个严格的子问题，$l\sim r$ 并不是 $1\sim r - l + 1$ 的排列，我们依然需要依靠 $p_1\sim p_n$。换言之，我们只需要确定答案在 $[1, m]$ 或 $[m + 1, r]$ 中。

根据这样的思想，考虑如何询问。

将 $p_i$ 全部除以 $2$ 下取整，称 $x, y$ 配对当且仅当 $p_x, p_y$ 除以 $2$ 下取整相同。

当 $n$ 为奇数时，除了 $a$ 以外的所有位置均有与其配对的位置，而询问 $Q(l, r, 2)$ 相当于求出 $r - l + 1$ 减去区间配对数，则区间落单数可由 $r - l + 1$ 减去两倍区间配对数得到，即 $2Q(l, r, 2) - (r - l + 1)$。设 $f(l, r)$ 表示 $[l, r]$ 的区间落单数，则对于 $f(1, m)$ 和 $f(m + 1, n)$，因为每个除了 $a$ 以外的区间落单位置会同时在 $[1, m]$ 和 $[m + 1, n]$ 中出现，所以只需递归进入 $f$ 较大的那个区间即可。时间复杂度询问次数 $2\lceil\log_2 n\rceil \leq 20$。

当 $n$ 为偶数时，设 $p_b = n$，则 $a, b$ 均没有与其配对的位置。类似地，求出 $f(1, m)$ 和 $f(m + 1, n)$。若已知 $b\leq m$ 或 $b > m$，则扣除 $b$ 的贡献后类似 $n$ 为奇数做。否则，若 $f(1, m) > f(m + 1, n)$，说明 $a, b\leq m$。若 $f(1, m) < f(m + 1, n)$，说明 $a, b > m$。若 $f(1, m) = f(m + 1, n)$，说明 $a, b$ 在 $m$ 的两侧。

考虑确定 $b$ 的位置。注意到将所有数除以 $n$ 下取整之后，只有 $p_b = 1$，其它均为 $0$。利用这一点，我们断言若 $r - l + 1 \geq 2$，则 $b\in [l, r]$ 当且仅当 $Q(l, r, n) = 2$。因此，若 $m > 1$，可直接询问 $Q(1, m, n)$ 确定 $b$ 是否在 $[1, m]$ 中。否则 $m = 1$，因为 $n\geq 3$，所以询问 $Q(m + 1, n, n)$ 确定 $b$ 是否在 $[m + 1, n]$ 中。

确定 $b$ 的位置后，因我们向相反方向递归，所以若此时 $b\leq m$ 则接下来一定有 $b\leq m'$，若此时 $b > m$ 则接下来一定有 $b > m'$。询问次数 $2\lceil\log_2 n\rceil + 1 \leq 21$，可以通过 G2。

最后优化通常是通过已知信息简少询问次数。

考虑到卡满 $\lceil \log_2 n\rceil$ 上界的二分过程必然经过 $r - l + 1 = 2$ 的情形。当 $l \neq 1$ 时，我们必然询问过 $Q(1, l - 1, 2)$，否则 $Q(1, l - 1, 2) = 0$。当 $r\neq n$ 时，我们必然询问过 $Q(1, r, 2)$，否则 $Q(1, r, 2) = \lfloor \frac n 2\rfloor + 1$。对于 $Q(l, n, 2), Q(r + 1, n, 2)$ 同理。

考虑 $[l, r]$ 中不是 $a$ 的位置 $x$。我们容易根据此时是否确定 $b$ 来判断 $x$ 是否等于 $b$。若 $x = b$，则直接进入判断 $b$ 的位置的分支，只需花掉一次询问。若 $x\neq b$，则考虑与 $x$ 配对的位置，若与 $x$ 配对的位置 $< l$，则 $Q(1, r, 2) - Q(1, l - 1, 2) = 1$ 且 $Q(l, n, 2) - Q(r + 1, n, 2) = 2$。若与 $x$ 配对的位置 $> r$，则情况相反，不再赘述。

基于此，不妨设与 $x$ 配对的位置 $< l$，则若 $Q(1, l, 2) = Q(1, l - 1, 2)$，说明 $x = l$，$a = r$，否则说明 $x = r$，$a = l$。同样只需花掉一次询问。

综上，我们在 $r - l + 1 = 2$ 的分支少花掉了一次询问，询问次数 $2(\lceil \log_2 n\rceil - 1) + 1 + 1\leq 20$。[代码](https://codeforces.com/contest/1764/submission/183178528)。