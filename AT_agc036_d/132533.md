**sol of AGC036D**

没想到差分约束啊。其实后面的 dp 难度还好。

我们考虑不存在负环其实有个很好的限制：存在至少一组差分约束。

从 $1$ 开始标号。我们令 $p_i$ 表示一个点到虚拟源点 $0$ 的距离，显然 $p_i \geq p_{i + 1}$，我们靠考虑差分一下令 $o_i = p_i - p_{i + 1}$，则 $o_i \geq 0$。

考虑对于 $i < j$ 的边本质就是限制了 $x_i - 1 \geq x_j$ 即 $x_i - x_j \geq 1$，写成差分的形式即 $\sum_{k = i} ^ {j - 1} o_k \geq 1$。记这种边为一类边。

对于 $i > j$ 的边推一下，发现是 $\sum_{k = j} ^ {i - 1} o_k \leq 1$。记这种边为二类边。

我们发现若出现 $o_i \geq 2$ 显然不优于令 $o_i = 1$，因为两者都可以满足 $o_i \geq 0$ 且不会使得一个本身留下来的一类边被剔除（因为相当于不会影响区间和 $\geq 1$），但是却更有可能使得区间和 $\leq 1$，从而保留二类边。

有了这么个强大的性质，就直接对 $o$ 数组硬上 dp 就好了：设 $dp_{j,i}$ 表示倒数第二个 $1$ 在 $j$ 位置，最后一个 $1$ 在 $i$ 位置，我们枚举一个之前的状态 $dp_{k,j}$ 转移：

- 对于一类边要求区间和 $\geq 1$，则可新产生的左端点在 $[1 , j]$，右端点在 $[j + 1 , i]$ 内；

- 对于二类边，要求区间和 $\leq 1$，则可新产生的左端点在 $[k + 1,i]$，右端点在 $[j + 1 , i]$。

发现两类贡献都可以由若干个矩形拼成，预处理二维前缀和转移即可。

时间复杂度 $O(n ^ 3)$。

