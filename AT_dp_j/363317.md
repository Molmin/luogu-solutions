
期望 DP，好题。

我们发现有很多的盘子，但盘子里的寿司数量 $1 \le a_i \le 3$，而第几个盘子并不会影响它选到的概率！我们完全可以用多维数组，表示每种个数的寿司的盘子的数量。

但是这里有吃完的即 $0$ ，我们需要表示 $0,1,2,3$ 个寿司的盘子数量，四维是开不下的。根据套路，$4$ 种的数量和为 $n$，我们可以省去一维，省去 $0$ 这一维，就可以开得下了。

这样我们确定了状态：$f(i,j,k)$ 表示要使得有 $i,j,k$ 个 $1,2,3$ 个寿司的盘子和 $(n-i-j-k)$ 个没寿司的盘子，操作次数的期望值是多少。

接下来考虑怎么转移。我们知道根据期望的定义 $E(X)=\sum_{i \in \Omega} P(i) R(i)$，即期望值等于每种可能的结果乘以其概率之和，我们就要根据它来转移，对于 $f(i,j,k)$：

- 如果这个位置选了个 $0$，啥也不动，其概率为 $\dfrac{n-i-j-k}{n}$。
- 如果这个位置选了个 $1$，即从 $f(i-1,j,k)$ 转移，概率为 $\dfrac{i}{n}$。
- 如果这个位置选了个 $2$，即从 $f(i+1,j-1,k)$ 转移，概率为 $\dfrac{j}{n}$。
- 如果这个位置选了个 $3$，即从 $f(i,j+1,k-1)$ 转移，概率为 $\dfrac{k}{n}$。


最后，注意操作次数要 $+1$。

因此，我们得到了一个初步的式子：
$$
f(i,j,k)=\dfrac{n-i-j-k}{n} \times f(i,j,k)+\dfrac{i}{n} \times f(i-1,j,k)

$$
$$
+\ \dfrac{j}{n} \times f(i+1,j-1,k)+\dfrac{k}{n} \times f(i,j+1,k-1) \color{red}+1
$$
式子两边都有 $f(i,j,k)$ 不行，但是我们整理移项，拿草稿纸算算就能得到：
$$
f(i,j,k)=\dfrac{1}{i+j+k} \times(i \times f(i-1,j,k)+ \ j \times f(i+1,j-i,k) + k\times f(i,j+1,k-1) \color {red}{+ n} \color{black})
$$
这样就能转移了。由于顺序比较复杂，我选择了记忆化搜索，当然先后顺序弄对直接 DP 就行。

时间复杂度 $O(n^3)$，但是跑得有点慢 qwq。

[提交记录](https://www.luogu.com.cn/record/98182781)