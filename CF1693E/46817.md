容易发现一个位置的操作是每次变成左侧小于他的最大值和右侧小于它的最大值的较小值。

考虑快速做这件事情，从大到小枚举值域，当一个位置的左右侧的小于它的最大值都被扫到时，我们让它操作一次。

每次对于已经扫过的数的位置维护这三种标记之一：$?$，$\leftarrow$，$\rightarrow$。分别表示左右都未出现最大值，左侧未出现和右侧未出现。

容易发现 $?$ 的出现位置是区间，另外两种是前后缀。

新出现一种数时如何改变标记？设这种数的出现区间是 $l,r$，那么区间内的所有标记，以及左边的 $\rightarrow$，右边的 $\leftarrow$ 会变成 $?$，其它的是另外两种标记。

用树状数组快速计算答案。