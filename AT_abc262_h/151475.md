某位歌姬的故事。

首先假设 $mx_i$ 表示第 $i$ 个位置最大能取到多少，我们可以用并查集或线段树维护出 $mx$。现在有一个关键性质：不同的 $mx$ 之间独立。

考虑一个区间 $[l,r]$ 以及限制 $w$，首先肯定有这个区间内所有位置的 $mx_i\le w$，若 $mx_i<w$，那么这个位置一定取不到 $w$，也就是条件变成了在这个区间内满足 $mx_i=w$ 的点必须至少一个满足 $a_i=w$。

所以我们只要枚举每个 $mx$ 的值，拎出所有 $mx$ 相等的位置和对应的区间限制算答案，最后再乘起来即可。（没有被任何区间覆盖的需要单独讨论）

问题转化成：有若干个点和若干个区间，要求这些点满足 $a_i\le mx$，且每个区间内至少有一个点的 $a_i=mx$，求方案数。

注意到包含其他区间的区间是没用的，把它们扔掉后剩下的区间排序一定满足随着左端点增加右端点也增加。考虑 $dp_i$ 表示目前做到第 $i$ 个点，要求第 $i$ 个点必须满足 $a_i=mx$，并且 $i$ 之前的区间都满足限制的方案数。考虑 $dp_i$ 可以从 $dp_k$ 转移过来的条件是找到 $i$ 前面最后一个与 $i$ 无交的区间，$k$ 不能小于这个区间的左端点。也就是 $k$ 是一段区间，可以算出来。

转移的时候把式子列出来，大概形如：

$$dp_i=\sum_kdp_k\times mx^{i-k-1}$$

$mx$ 有逆元的话就可以前缀和优化，特判 $mx=0$。

时间复杂度是线性对数，瓶颈在于一开始的并查集和快速幂。代码写的有点丑，而且是按照 某位歌姬的故事 改的，所以还把下标离散化了，更难写。