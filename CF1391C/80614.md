我们知道，想要在 $n$ 个点的图中产生环，至少要有 $n$ 条边。而除排列 $p$ 中最大的数对应的点外其它的每个点至少会产生 $1$ 条边，也就意味着图最少有 $n-1$ 条边。且我们可以证明图一定连通（因为如果我们按照 $p_i$ 从大到小连边的话，假设之前的图已经连通了，那么再加一个新点来连边，连边的话肯定是连之前的图中的点，这样形成的新图也一定连通，而且初始状态是 $1$ 个点时一定连通，所以这 $n$ 个点的图一定连通），且无重边，无自环。所以我们只要保证这个图至少有 $n$ 条边就行了。不妨我们就考虑不产生环的做法，也就是这个图恰好有 $n-1$ 条边，其实就是对于每个 $i$ 都要保证满足 $p_j>p_i$ 的所有 $j$ 都要小于 $i$ 或者都要大于 $i$。但是这样不太好构造，所以我们把它换换形式，变成对于每个 $i$。保证如果 $i<j$ 则 $p_i>p_j$ 或者如果 $i>j$ 则 $p_i>p_j$。那么我们就按照 $1$~$n$ 的顺序放置排列，把对于每个 $i$。必须填在排列中剩余部分的边界上，这样当 $i<n$ 时，可以填左边界，也可以填右边界，这样就有 $2$ 种方法，但是当 $i=n$ 时，只有一种方法了，这样不产生环的种数就有 $2^{n-1}$ 种（这样填的证明：因为我们知道前面填过的数一定都是小于 $i$ 的，所以如果我们填边界的话就能保证有一边能保证所有的数都小于 $i$。但如果不填边界的话，那么它的两边一定还有未填的数，但这未填的数将要填一个比 $i$ 大的数，那就不能保证如果 $i<j$ 则 $p_i>p_j$ 或者如果 $i>j$ 则 $p_i>p_j$，所以对于每个 $i$。必须填在排列中剩余部分的边界上），我们知道 $n$ 个数的全排列一共有 $n!$ 种，所以满足产生环的种数一共有 $n!-2^{n-1}$ 种。

最后怎么计算我就不用说了吧。。。

时间复杂度：$O(n)$