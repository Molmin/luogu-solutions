首先考虑只有 $3$ 个顶点的情况。可以发现只有当 $p_2<p_1$ 且 $p_2<p_3$ 时可以构成环。

那么推而广之，对于 $n>3$，只需要有任意一个 $k$ 满足 $p_k<p_{k+1}$ 且 $p_k<p_{k-1}$，即需要有一个谷。

考虑计算这样的方案数，发现正面做不是很好做，考虑排除不合法的方案。不合法的方案就是先递增后递减（可以看做在 $0$ 和 $n+1$ 的位置都放了一个 $0$）。

那么只需要考虑最大值在不同位置的情况，加起来即可。

当最大值在第 1 位时，剩下 $n-1$ 个数需要在左边选 0 个数，在右边选 $n-1$  个数排出单调递减的序列，有 $C^{0}_{n-1}*C^{n-1}_{n-1}$ 种方法也就是 $C^{0}_{n-1}$。

当最大值在第 2 位时，剩下 $n-2$ 个数要在左边选出一个数，右边选出 $n-2$ 个数，即 $C^{1}_{n-1} * C^{n-2}_{n-2}$ 也就是 $C^{1}_{n-1}$。

当最大值在第 3 位时，同理有 $C^{2}_{n-1}$ 种方法...

所以不合法方案数是$\sum_{i=0}^{n-1}C^{i}_{n-1}$。

根据二项式定理我们可以知道这个式子是 $(1+1)^{n-1}$。

但是这个需要一点点数学基础，所以不妨换个角度思考。这个式子的直观意义就是，从 $n-1$ 个数中取 $0,1,2,...,n-1$ 个数的方案数之和。那么问题就可以转化为——有 $n-1$ 个数，每个数可以取或不取，有多少种方案数。那么对于每个数都有两种选择，根据乘法原理可以很轻松的得到这样的方案数是 $2^{n-1}$。

于是，合法方案数就是总方案减去不合法的，即 $n!-2^{n-1}$。

代码很好写，就不给了。