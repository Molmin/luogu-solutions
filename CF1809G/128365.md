小清新计数题。

分析合法序列的构成，可以发现其是由若干段序列组成，每段第一个元素的值大于其余元素最大值加 $k$。并且相邻两段的第一个元素 $u,v$，满足 $u+k<v$（$u$ 在 $v$ 前）。

那么这就直接考虑从大到小 DP。设 $f_i$ 表示考虑从 $n$ 到 $i$ 形成合法序列的方案数。可以预先 $O(n)$ 处理出 $L_i$ 和 $R_i$，表示最左和最右的满足与 $a_i$ 差的绝对值不大于 $k$ 的位置。

那么转移分为两种。一种是 $i$ 插入到之前段的某个位置；一种是 $i$ 成为一段段头。

如果直接考虑第一种情况，会比较难处理。那么可以先考虑第二种情况的影响。发现就是 $L_i$ 到 $i-1$ 的元素，会少 $1$ 个位置可以插。因为由于段头与段头差的约束，使得一个元素不可以插的段只有上一段，且该段只有一个元素。这样可以算得比原来 $i$ 不单独成段的贡献多了个 $\frac{1}{n-L_i}$的系数。（原先，对于 $x$（$L_i\le x\le i$），有 $n-x$ 个位置可以插，$i$ 单独成段后，变成 $n-x-1$ 个位置可插，且 $i$ 只有一种插法了）。

这样，就可以对 $f$ 稍微做个调整。变为带系数的值。第一种情况就直接将 $f_{i+1}$ 贡献给 $f_i$ 即可。第二种情况则变为将 $\frac{1}{n-L_i}f_{R_i+1}$ 贡献给 $f_i$。最后再整体乘上 $(n-1)!$ 即可。

上面的调整实际可以理解为选择 DP（指系数上）和前缀和思想。
