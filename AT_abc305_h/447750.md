一个问题可以由二元组 $(A,B)$ 描述其难度。对于一个问题的集合 $S$，解决它所需要花费的精力，是任意重排内部顺序后，令 $x=0$，依次执行 $x\gets Ax+B$ 得到的最终的 $x$。

给定长度为 $n$ 的问题序列，你需要将其划分为若干子段，并把每段作为独立的问题集合来解决，总精力消耗是每一段的精力消耗之和，你希望这个值不超过 $X$，求最少需要划分的段数 $K$，以及在划分成 $K$ 段的情况下最少总精力消耗。

$n\leq 2\times 10^5$，$1\leq B_i\leq \sum B_i\leq X\leq 10^8$，$1\leq A_i\leq 10^5$，3s。

第一个观察是，对于所有 $A_i=1$ 的可以忽略，最后累加其 $B_i$，因为无论分在哪一段都会最后操作。那么序列里剩下的元素一定是 $A_i>1$ 且 $B_i\ge 1$ 的，那么同一段里如果长度超过 $O(\log X)$，最终精力消耗和必定大于 $X$。对于同一段，内部元素可以按照 $\frac{B}{A-1}$ 从小到大排序。

如果要 dp，现在要记录的信息是段数以及 $\sum x$，优势是转移只用枚举前 $O(\log X)$ 个段，可以预处理其贡献，抽不到万叶了怎么办，但仍然无法避免前两个巨大信息的记录。现在要么改变状态，要么猜性质。分段先猜一手凸，那么如果是凸的怎么做呢？

首先最小代价关于分的段数 $k$ 是单调的。考虑 wqs 二分一个代价 $c$，这样能切到并算出分某个 $k$ 段的最小代价，如果这个代价不超过 $X$，那么可以增大代价 $c$ 以减小 $k$。也就是 wqs 二分并不一定需要一个目标段数，它的本质是用一个斜率去切答案凸包上的某个点/某条线段，本题中因为首先满足单调性质，所以可以直接根据切到的点来判断接下来的方向。$O(n\log^2 X)$。

实现上注意要首先尽可能合法（最大化操作次数），这样会找到同斜率的一段里面代价最小的，最终如果距离上界 $X$ 还有距离，那就可以向左上爬到段数最小的点。[code](https://www.luogu.com.cn/paste/z2oobzp1)

关于凸性：根据 2023 集训队论文《浅谈函数的凸性在 OI 中的应用》，权值矩阵满足四边形不等式的序列划分问题关于段数 $m$ 是凸的。