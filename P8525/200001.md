用线段树维护区间内的关键点和相邻关键点之间的信息。

一个线段树节点在所有节点都加入的时候 build，从左右孩子归并关键点，并维护相邻关键点之间的信息。


两个 $\log$ 的做法是简单的，我来详细讲一下如何变成一个 $\log$（感谢 [Ntokisq](https://www.luogu.com.cn/user/203623) 的私信指导）：

瓶颈在与在每个线段树节点上的二分。

对于 build 过的区间，我们顺便维护这个点往左孩子往和右孩子会到哪个位置，这样往左往右的二分都变成 $O(1)$ 了

父亲没有 build 过的区间构成一个右链区间序列，每次插入相当于是 pop 若干个，然后 push 一个，我们维护右链区间序列相邻元素的分散层叠状物。假设我们要维护 $u$ 和 $v$ 的分散层叠状物，我们均匀的从 $u$ 中取出 $\mathrm{sz}(v)$ 个，然后和 $v$ 进行归并，维护分散层叠状物的复杂度是 $O(\mathrm{sz}(v))$ 的。如果为我们知道了这个数字在 v 中的位置，那么我们可以花费 $\mathrm{sz}(u)/\mathrm{sz}(v)$ 复杂度得到这个数字在 u 中的位置。

因此我们可以花费 $\sum O(\log(\mathrm{sz}(u_i)/\mathrm{sz}(u_{i+1})))=O(\log(n))$ 得到在所有右链区间的位置，然后由于这些右链区间都是 build 过的，往左往右都是 $O(1)$ 的，因此总的复杂度就是 $O(\log(n))$

