## P3339 【向量集】

### 题意

+ 空二元组数组 $a$，支持：
1. 在 $a$ 末尾加入一个二元组 $(x, y)$（下标从 $1$ 开始）；
1. 给出 $x,y,l,r$，查询 $\max\limits_{i=l}^{r}(x\times a_i.x+y\times a_i.y)$。
+ $|x|,|y|\le10^8$，$1\le n\le4\times10^5$，保证询问合法，强制在线。

### 做法

明显是斜率优化，但是有区间限制，考虑线段树维护凸包，查询时拆成 $O(\log n)$ 个被完全包含的线段树区间，每个区间一次三分，单次查询复杂度 $O(\log^2n)$。

暴力合并子树的话单次修改复杂度为 $O(n\log n)$。

注意到只有插入，可以用 `set` 维护凸包，单次修改 $O(\log^2n)$。可过。~~但是我不会写。~~

注意到只有被完全包含的线段树区间里的凸包才会被用到，而且每次修改只在数组末尾。所以每个线段树区间只需要在子树被填满那一刻合并即可，此前不会用到这个线段树区间的凸包，此后不会修改到这个线段树区间。总修改复杂度 $O(n\log n)$。