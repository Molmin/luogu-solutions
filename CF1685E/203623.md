### 题解 CF1685E The Ultimate LIS Problem

很难，我也不知道这种解法是怎么想出来的。

复读题解，并详细证明了一些关键步骤。感谢多头的教导。❤dottle

设 $b_i=\text{sgn}(a_i-n-1)$。

考虑一个循环移位，$\forall1\le i\le 2n+1$，$\sum_{i=1}^i b_i\ge 0$。（天哪这是怎么想到的）

#### 引理 1：若这个循环移位的 LIS 长于 $n$，则 $n+1$ 必然存在 LIS 中。

证明：

考虑反证。若 $n+1$ 不存在 LIS 中，那么 LIS 就是 $x$ 个 $\le n$ 的数接上 $\ge n-x+1$ 个 $>n+1$ 的数。那么这 $x$ 个 $\le n$ 的数前就有 $\le x-1$ 个 $>n+1$ 的数。那么前缀和就 $<0$ 了。

所以 LIS 一定是 $x$ 个 $\le n$ 的数接上 $n+1$ 接上至少 $n-x$ 个 $>n+1$ 的数。

然后 $b$ 中 $1,-1$ 均有 $n$ 个所以 $n+1$ 前后 $1,-1$ 的数量是相等的。

我们可以得到另一个引理：

#### 引理 2：对于 $b$，$0$ 前的前缀和 $0$ 后的后缀均满足所有前缀和 $\ge 0$。

证明：前缀显然，而因为前缀的和等于 $0$ 所以后缀的所有前缀和 $\ge 0$。

下面是两个强大的推论：

#### 推论 1：如果 $n+1$ 在最前的移位存在一个前缀和 $<0$，那么任意一个满足所有前缀和均 $\ge 0$ 的移位均满足其 LIS 长度 $\le n$。

证明：

考虑证明他的逆否命题，即“如果存在前缀和均 $\ge 0$ 的移位满足其 LIS 长度长于 $n$，那么 $n+1$ 在最前的移位满足所有前缀和 $\ge 0$”。

考察这个前缀和均 $\ge 0$ 的移位，将 $n+1$ 前的前缀移动到末尾。根据引理 2，移动后满足所有前缀和均 $\ge 0$。

#### 推论 2：若 $n+1$ 在最前的移位满足所有前缀和 $\ge 0$，且 $1\sim n+1,n+1\sim 2n+1$ 按顺序出现（环形），那么无解。

将 $n+1$ 在最前的移位的任何前缀移动到末尾，容易发现，LIS 长度都不会减小，因为前缀均 $\ge 0$，而移动到末尾的所有 $>n+1$ 的数都可以按顺序接上原 LIS（或者 IS）。

移动后缀同理。

至此我们可以得到算法流程：

1. 判断 $n+1$ 在最前的移位是否满足所有前缀和均 $\ge 0$。若不满足，根据推论 1，任意一个满足所有前缀和均 $\ge 0$ 的移位均为解。
2. 判断 $1\sim n+1,n+1\sim 2n+1$ 是否按顺序出现，若不按顺序出现，根据引理 1，$n+1$ 分别在最后或最前的移位即为解。
3. 若满足上面两个条件，根据推论 2，无解。

我们需要用数据结构维护这些：

1. 判断 $n+1$ 在最前的移位是否满足所有前缀和均 $\ge 0$。
2. 找到一个移位满足所有前缀和均 $\ge 0$。
3. 判断 $1\sim n+1,n+1\sim 2n+1$ 是否按顺序出现。

考虑一个移位何时满足所有前缀和均 $\ge 0$。设原序列对应的 $b$ 的前缀和为 $s$，当前移位的首项对应原序列的 $x$。那么，因为序列的和为 $0$，所以不难看出，所有前缀和均 $\ge 0$ 等价于 $\forall 1\le i\le n$，$s_i \ge s_{x-1}$。

维护 $s$ 的最小值即可。

对于 3，存在多种维护方式。可以用 set 维护。