标签：找性质、数据结构。

又是一道神仙分析性质。~~这种近 AGC 题真的有训练的必要吗？练再多估计碰到类似的题也想不到（~~

首先这东西一脸不好数据结构维护的样子，我们肯定首先要分析一下题目给的 $2n+1$ 和 $n$ 有什么用。记 $<n+1$ 的数为 $-1$，$>n+1$ 的数为 $1$，$=n+1$ 的数为 $0$。那么我们考虑一个特殊的循环移位，满足将 $a_i$ 对应到 $-1,+1,0$ 后任意一个前缀和都 $\ge 0$。我们首先需要证明一个非常关键的结论：

> 性质 1：在这个循环移位中，如果 $\text{LIS}>n$，那么 $\text{LIS}$ 必然包含 $n+1$。

我们考虑 $n+1$ 前面的部分，假设有 $x$ 个 $<n+1$ 的数，$y$ 个 $>n+1$ 的数，那么 $n+1$ 后面的部分就有 $n-x$ 个 $<n+1$ 的数和 $n-y$ 个 $>n+1$ 的数。那么如果 LIS 不包含 $n+1$，那么最多只能选出 $x+n-y$ 个数，而 $x\le y$，因此选出的数的个数 $\le n$。

我们考虑一个特殊的循环移位，满足这个循环移位以 $n+1$ 为开头，记这个循环移位为 $a'$，那么

> 性质 2：如果这个循环移位不满足所有前缀和 $\ge 0$，那么我们找到满足这个条件的循环移位，它必然满足条件。

证明：假设这个循环为在 $a'$ 基础上将 $a'_p$ 移到第一位得到，那么显然 $[1,p-1]$ 的前缀和 $<0$，这样假设 $[1,p-1]$ 中 $<n+1$ 和 $>n+1$ 的数分别为 $x,y$，这样新的循环移位的 LIS 长度最大是 $x+1+n-y$，由于 $x<y$，$x+1+n-y\le n$，符合条件。

那如果这个循环移位符合所有前缀和都 $\ge 0$ 的条件呢？是否一定不合法呢？手玩样例发现不一定。我们先特判掉一些 corner case，比方当 $n+1$ 为开头时，$n+1,n+2,n+3,\cdots,2n+1$ 的位置不是递增——此时该循环移位满足条件。以及当 $n+1$ 为末尾元素时，$1,2,3,\cdots,n+1$ 的位置不是递增——此时以 $n+1$ 为末尾元素的循环移位满足条件。那么对于其他情况呢？接下来又有结论：

> 性质 3：特判掉上述两种 corner case 后其他情况都无解。

对于任意一个循环移位，$n+1$ 前面的 $<n+1$ 的数必然形成递增数列，$n+1$ 后面 $>n+1$ 的数也形成递增数列，而根据以 $n+1$ 为开头的循环移位的所有前缀和都 $\ge 0$ 可知任何一个循环移位中 $n+1$ 前面 $<n+1$ 的数的个数都不少于 $>n+1$ 的数的个数，这样这个 LIS 长度必然 $>n$。

---

第一种情况可以线段树维护，第二、三种情况可通过维护 $\sum\limits_{i=n+1}^{2n}(pos_{i+1}-pos_i)\bmod (2n+1)+(pos_{n+1}-pos_{2n+1})\bmod(2n+1)$ 并判断其是否等于 $2n+1$ 来求解。这样总复杂度 $n\log n$，于是我们做完了。