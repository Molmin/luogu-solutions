好牛逼的题呀。


**本题解中的 $a,b$ 均是从 $0$ 开始计数的.**

考虑 $a_0$ 对矩阵每个位置的贡献。我们不会数学，先打个表：
```
1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0
1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0
1 0 0 0 1 0 0 0 1 0 0 0 1 0 0 0
1 1 1 1 0 0 0 0 1 1 1 1 0 0 0 0
1 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0
1 1 0 0 0 0 0 0 1 1 0 0 0 0 0 0
1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0
1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0
1 0 1 0 1 0 1 0 0 0 0 0 0 0 0 0
1 1 0 0 1 1 0 0 0 0 0 0 0 0 0 0
1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0
1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0
1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0
1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0
1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
```
上面是 $n=16$ 时的表，其中 $1$ 表示 $a_0$ 对这个位置有贡献，$0$ 表示没有贡献。建议对着这张表阅读以下内容。



设第 $i$ 行第 $j$ 个数为 $c_{i,j}$，$f_{x1,y1,x2,y2}$ 为 $c_{x1,y1},\ldots,c_{x2,y2}$。通过观察，我们有以下结论：

**结论一**：若 $c_{i,j}=1$，则 $a_{n-j+1}$ 对 $b_{i,n}$ 有贡献。

证明：$a_1$ 对 $b_{i,j}$有贡献，因此 $a_{n-j+1}$ 对 $b_{i,(n-j+1)+(j-1)}$ 有贡献。

通过这个结论，可以看出来将 $c$ 左右翻转就是 $a_j$ 对 $b_{i,n}$ 的贡献情况。

**结论二**：$c_{i,i}(i>0)=0$

证明：由于贡献的最唯一根本来源 $c_{1,1}$ 在 $c$ 矩阵的对角线上，所以该矩阵是关于对角线对称的，因此 $c_{i,i-1}=c_{i-1,i},c_{i,i}=c_{i,i-1}\oplus c_{i-1,i}=0$。

**结论三**：第 $i(i>0)$ 行的周期为 $2^{\lceil \log_2 (i+1) \rceil}$，且后半周期均为 $0$。

证明：数学归纳法。$k=1$ 时，该结论显然成立。设 $x=2^{k-1},2^{k-1} \leq y < 2^k$。不妨设前 $x$ 行都已经满足此结论。行和列是等价的，因此该周期实质上是矩阵的周期，即 $f_{x,0,2x-1,x}=f_{x,0,x,x},\ldots,c_{x,x}$，这是前半周期。根据结论一，$c_{y,y}=0$，而 $f_{y+1,y-1,2y-1,y-1}$ 都可以通过平移的方式认为是上方某个周期的后半周期，即全 $0$，因此 $f_{y+1,y-1,2y-1,y-1}$ 也全为 $0$。

有以上结论后，由于二进制的优良性质，我们先考虑 $n=2^k$。令 $x=2^{k-1}$，$y,z$ 是 $<x$ 的某个自然数。通过结论三，我们发现，$b_{y+x,n}$ 为只考虑所有的 $z$ 在第 $y$ 行产生的贡献，$b_{y,n} \oplus b_{y+x,n}$ 为只考虑所有的 $z+x$ 在第 $y$ 行产生的贡献，因此我们可以将原问题转化为两个大小为 $x$ 的子问题求解，类似分治树的结构，每一层的时间复杂度为 $\Theta(n)$，因此总时间复杂度为 $\Theta(n\log n)$。

接着考虑 $n\neq2^k$。我们发现对于分治时的中心大矩阵，它通过上述做法并不能重新凑出一个足够大的新矩阵。令 $s= n-2^k,s<2^k$，我们先去计算大小为 $s$ 的边角小矩阵，算出 $a_s,\ldots,a_{n-1}$。让 $i \geq n$ 的 $a_i$ 都为 $0$，将矩阵补全后再去解决中心大矩阵就可以了。相对于 $n=2^k$，还需要枚举 $n$ 的每个二进制位，因此时间复杂度提升到 $\Theta(n \log^2n)$。

### 后记
看了其它选手的题解，发现这个表其实是一个 `FWT` 的形式，~~可惜我太菜了没有看出来，~~ 可能通过这个角度思考会更加方便。还有神仙用组合意义更简洁地做出来了，这道题的方法还是很多的。