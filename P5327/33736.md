首先考虑给定一些点，计算这些点形成的虚树还原到原树包含的边数。显然题目可以转化到这个问题上。

我们考虑按照dfs序从小到大排序，假设排序完的点集为$A_1,A_2,...,A_n$。

则树上的边数=$(dis(A_1,A_2)+dis(A_2,A_3)+...+dis(a_{n-1},a_n)+dis(a_n,a_1))/2$

因为我们按照$A_1,A_2,...,A_n$遍历的时候每条边都会恰好净多两次所以他是正确的。

这样我们就可以使用线段树来维护对于这个点来说的虚树节点按照dfn序排序的结果，同时也可以非常方便的合并

在采用$O(nlog)-O(1)$LCA的情况下可以做到$O(nlog)$