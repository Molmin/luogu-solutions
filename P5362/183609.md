#### 题意简述

定义 $\text{TM}$ 数列 $T$ 为通过如下递归式得到的 $\texttt{01}$ 字符串（下标从 $0$ 开始）：

- $T_0=0$；
- $T_{2n}=T_n$；
- $T_{2n+1}=1-T_n$。

给定一个 $\texttt{01}$ 字符串 $S$ 和一个非负整数 $k$，求有多少种 $\text{TM}$ 字符串的连续子串 $T$ 满足 $S$ 为 $T$ 的前缀且 $|T|=|S|+k$。

**多组询问。**对于 $20\%$ 的数据，满足 $k\le100$；   
对于 $40\%$ 的数据，满足 $1\le k\le5\times10^4$。   
对于全部数据，$T\le100$，$|S|\le100$，$k\le10^{18}$。   

#### 题目解法

先来考虑 $k=0$ 的情况，即判断 $S$ 是否为 $\text{TM}$ 字符串的子串。

发现题目中的 $\text{TM}$ 字符串其实就是 $\text{Thue}-\text{Morse}$ 数列，考虑 $\text{Thue}-\text{Morse}$ 的以下三种生成方式：

- 每个数二进制表达中的 $1$ 的个数的奇偶性；
- 从 $\texttt{0}$ 开始，每次将自身取反后接在后面；
- 从 $\texttt{0}$ 开始，每次将所有的 $\texttt{0}$ 替换为 $\texttt{01}$，将所有的 $\texttt{1}$ 替换成 $\texttt{10}$。

发现，第三种生成方式比较适合此题，因为对于一个 $\text{TM}$ 的子串而言，此操作是**可逆的**。

考虑一个串 $S=s_1s_2\cdots s_n$，我们可以把它每两位划分为一段，然后按照上述第三种生成方式合并为一个字符，如果某一段内两个字符相同，则意味着这样划分是不合法的。

如果两侧有落单的段，则可以依据规则推理出对应的另一个字符，也可以将其补上。

可以证明，当 $|S|>3$ 时，**合法的合并方案是唯一的**，因此可以通过对合并方案的计数来实现对串的计数。

设 $f(S,k)$ 为当前字符串为满足 $S$ 为 $T$ 的前缀且 $|T|=|S|+k$ 的 $\text{TM}$ 字符串的连续子串 $T$ 的种类数，则当 $|S|+k>3$ 时可以直接枚举两种可能的划分方案**递归计算**，其间可以**使用哈希表进行记忆化搜索**。

发现本质不同的状态数为 $\mathcal{O}(|S|+\log k)$ 级别，可以通过本题。

#### 总结

关于这类递归生成数列的问题可以换种生成方式考虑，有时可以取得意想不到的效果，平时可以记忆一些常见递归数列的其它生成方式。