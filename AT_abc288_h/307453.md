如果没有不降的限制很好做：设 $f(i,j)$ 表示填到从高到低的第 $i$ 位，有 $j$ 个数顶上界的方案数。

异或和 $=X$ 相当于限制这一位的奇偶性。对于 $\le M$ 的限制讨论一下即可转移。

复杂度是 $O(N^2\log M)$。那么可以在 $O(N^3\log M)$ 的时间内求出 $1,2,\cdots,N$ 个数时的答案。

现在考虑怎么处理不降。考虑钦定某些位置是 $=$，某些位置是 $<$。

发现相当于对这 $N$ 个数进行划分，划分出的集合内部两两相同，不同集合中的数两两不同。

从每个奇数大小的集合中选一个代表元，考虑怎么算 $g(i)$ 表示 $i$ 个数两两不同的方案数。

尝试仿照 ABC236Ex 使用集合不相等容斥；发现这个异或和的限制没办法把连通块拆开，但是偶数大小的连通块方案数直接就是 $M+1$，奇数大小的连通块若有 $x$ 个，方案数是 $f(\lfloor \log_2M\rfloor +1,x)$。重新设 $h(x,y)$ 表示 $x$ 个数划分成若干连通块，其中 $y$ 个大小为奇数的容斥系数和；转移类似于求个 exp，枚举 $1$ 所在连通块大小，有
$$
h(x,y)=\sum_{i=1}^xh(x-i,y-(i\bmod 2))\times(-1)^{i-1}(i-1)!\times\binom{x-1}{i-1}
$$
可以做到 $O(N^3)$。那么 $g(i)=\sum h(i,y)f(\lfloor \log_2M\rfloor +1,y)$。

那么最终相当于要在 $g$ 的基础上，从 $[0,M]$ 中选出 $2i$ 个数，且每个数的出现次数均为偶数。插板可得方案数位 $\binom{M+i}{i}$。于是答案即
$$
\sum_{i=0}^{\lfloor N/2\rfloor}\frac{g(N-2i)}{(N-2i)!}\binom{M+i}{i}
$$
总的复杂度是 $O(N^3\log M)$。好像有 $O(N\log M)$ 做法但是我不会/hsh

https://atcoder.jp/contests/abc288/submissions/39938834