2023/2/23 Upd：发现类似题目 [Gym103428B](https://codeforces.com/gym/103428/problem/B)。

~~这么简单的模型居然能引出这么多东西。~~

本文中认为 $M$ 为原题面中的 $N$，$n$ 为原题面中的 $M+1$。

先将 $\leq$ 容斥为 $<$，假设已经求出 $M=m$ 时要求 $A_1 < A_2 < \cdots < A_m$ 的方案数 $s_m$。

枚举每个 $\leq$ 填 $=$ 还是 $<$，考虑每个 $=$ 连成的连续段，则有 $i$ 个长为偶数的连续段和有 $j$ 个长为奇数的连续段的方案数为：

$$\dbinom{(M-i-2j)/2+i+j-1}{i+j-1} \dbinom{n-i}{j} s_i$$

意思是先将不同的 $i$ 个数排好，再在剩下的 $n-i$ 种数中选出 $j$ 个与它们排列。

该部分复杂度 $O(M^2)$。下面考虑计算 $s_m$。

考虑对 $m$ 个数间的相等关系进行容斥，那么问题分为两部分：

1. 对所有 $m=0,1,\cdots,M$ 计算序列 $A_1,A_2,\cdots,A_{m}$ 的数量 $f_m$，使得 $0 \leq A_i < n$ 且 $\oplus a_i=X$。

2. 计算容斥系数。

### Part 1

事实上 Xor 有很好的性质：一个在 $[0,2^k)$ 的数与一个定值 $x$ 异或的结果仍相当于在 $[0,2^k)$ 中随机。

将 $[0,n)$ 划分为 $O(\log n)$ 个集合，由某一位 $t$ 产生的集合 $S_t$ 中的数 $x$ 形如：第 $t$ 位上 $x$ 为 $0$ 而 $n$ 为 $1$，比 $t$ 位高的位上 $x$ 与 $n$ 相同。

假设枚举每个 $a_i$ 属于哪个集合，那么只关心这些集合中的最高位 $t$，则比 $t$ 高的位已被确定，比 $t$ 低的位相当于随机选取。

那么枚举最高位 $t$ 与有多少数属于 $t$ 产生的集合，即可做到 $O(m \log n)$。

还可以再优化，式子写出来形如 $\sum_{2 \mid i} \dbinom{m}{i} w^i$。记 $F(x)=(1+x)^m$，所求即 $(F(w)+F(-w))/2$。

于是该部分单次复杂度 $O(\log n)$，总复杂度 $O(M \log n)$。

### Part 2

对边集容斥，然而边集过大难以计算。

注意到一组边集的限制条件实际上是将整个图划分为一些点集，要求每个点集内部全部相等，那么可以改成枚举点集划分。

一个大小为 $s$ 的点集的容斥系数为 $(-1)^{s-1} (s-1)!$。这个模型可见 [ABC236Ex Distinct Multiples](https://atcoder.jp/contests/abc236/tasks/abc236_h)，这里不再赘述。

设大小为奇数和偶数的点集分别有 $c_0,c_1$ 个，一组点集划分对应的实际方案数为 $f_{c_0} n^{c_1}$。

设 $x$ 表示点集大小，$y$ 表示对 $c_0$ 的贡献，那么：

$$F(x,y)=\sum\limits_{i \geq 1} (-1)^{i-1} (i-1)! n^{[2 \mid i]} \dfrac{x^i}{i!} y^{[2 \nmid i]}=\dfrac{1}{2}[(n+y) \ln (1+x)+(n-y) \ln (1-x)]$$

所求即：

$$[x^m] G(x)=[x^m] e^{F(x)}=[x^m] (1+x)^{(n+y)/2} (1-x)^{(n-y)/2}$$

一种做法是对 $y$ 求值并插值，通过对 $x$ 递推可以做到 $O(M^2)$，~~不太聪明~~这里不展开叙述。

一种更好的做法可以直接对所有 $m$ 和 $t$ 求出 $[x^m y^t]G(x)$。注意到 $G(x)$（关于 $x$）是 D-finite 的，对其关于 $x$ 求偏导：

$$\dfrac{\delta}{\delta x} G(x,y)=\dfrac{n+y}{2(1+x)} G(x,y)-\dfrac{n-y}{2(1-x)} G(x,y)$$

$$(1-x^2) \dfrac{\delta}{\delta x} G(x,y)=(y-nx)G(x,y)$$

$$ig_{i,j}=g_{i-1,j-1}+(i-2-n)g_{i-2,j},i \geq 1$$

可以在 $O(M^2)$ 内求得容斥系数 $g_{i,j}$。

综上，整道题的总时间复杂度为 $O(M \log n+M^2)$。

#### Code

代码中 Part 1 的实现是 $O(M \log M \log n)$ 的。

[插值做法](https://atcoder.jp/contests/abc288/submissions/38866249)

[递推做法](https://atcoder.jp/contests/abc288/submissions/38869896)
