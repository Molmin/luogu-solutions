首先先把 $a$ 排序。看到这个题目可能会想到 dp，但是如果直接 dp 的话比较难转移。设每组第一个数是 $l$，最后一个数是 $r$，那么这段区间的贡献就是 $a_r-a_l$，这提示我们可以把贡献拆开来。一个一个加数的时候，对于每一组，如果这一组里的数已经全部加完了那么就称这一组是闭合的。那么对于新加的一个数 $a_i$，有以下 $4$ 种可能：

- 加到了前面任何一个没有闭合的组里，这一组还是没有闭合，对总数的贡献是 $0$。
- 加到了前面任何一个没有闭合的组里，让这一组闭合了，对总数的贡献是 $a_i$。
- 新成立了一个没有闭合的组，这一组没有闭合，对总数的贡献是 $-a_i$。
- 新成立了一个没有闭合的组，这一组闭合了（即这一组只有它一个数），对总数的贡献是 $0$。

那么可以设 $dp_{i,j,k}$ 表示前 $i$ 个数，有 $j$ 个未闭合区间，此时的总数为 $k$ 的情况，转移就分成上面四类转移：

$dp_{i,j,k}=dp_{i-1,j,k}\times j + dp_{i-1,j+1,k-a_i} \times (j+1)+dp_{i-1,j-1,k+a_i}+dp_{i-1,j,k}=(j+1)\times (dp_{i-1,j,k}+dp_{i-1,j+1,k-a_i})+dp_{i-1,j-1,k+a_i}$。

然而……这样子会出现负下标的情况，状态数是 $n^2 \sum a_i$ 级别的，过不去。

思考一下原因：计算贡献的时候有减有加，这样的话会让第三维的下标变的很小。如果把这个过程变成单调不减的过程，那么就没有那么多事情了。

那么，怎么变呢？差分！对于 $a_r-a_l$ 这个东西，把他转化成 $\displaystyle \sum_{i=l+1}^r {a_i-a_{i-1}}$。那么算加入第 $i$ 个数之和的贡献的时候，不就相当于是 $j \times (a_{i}-a{i-1})$ 了吗（$j$ 是之前没有闭合的组，显然每个没有闭合的组都会产生 $a_{i}-a_{i-1}$ 的贡献）。

那么可以轻松得到 dp 方程（$d=a_i-a_{i-1}$）：$dp_{i,j,k}=dp_{i-1,j,k-d\times j}\times j+dp_{i-1,j+1,k-d\times(j+1)}\times (j+1)+dp_{i-1,j-1,k-d\times (j-1)}+dp_{i-1,j,k-d\times j}=dp_{i-1,j,k-d\times j}\times (j+1)+dp_{i-1,j+1,k-d\times (j+1)}\times (j+1)+dp_{i-1,j-1,k-d\times (j-1)}$。时间复杂度 $O(n^2 k)$。

[code](https://www.luogu.com.cn/paste/x8yoc3oq)。