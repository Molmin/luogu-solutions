提供一种和题解区相比更加机械的斜率优化的方法。

设 $f_i$ 为至 $i$ 为止的最小花费，显然有转移：

$$
f_i=\min_{j<i}\left\{f_j+(h_i-h_j)^2\right\}+C
$$

假设有两个决策 $j,k(j<k)$，直接令 $k$ 优于 $j$，考虑 $k$ 需要满足的条件：

$$
f_j+(h_i-h_j)^2>f_k+(h_i-h_k)^2
$$

$$
f_j+h_i^2-2h_ih_j+h_j^2>f_k+h_i^2-2h_ih_k+h_k^2
$$

因为我们需要最小化 $f_i$，因此需要分离和 $i$ 有关的项：

$$
f_j-f_k+h_j^2-h_k^2>2h_i(h_j-h_k)
$$

由于 $j<k$，因此 $h_j-h_k<0$。从而：

$$
\frac{f_j+h_j^2-f_k-h_k^2}{h_j-h_k}<2h_i
$$

现在假设有三个点 $j_1,j_2,j_3$，设前后两边上左式分别为 $k_1,k_2$。考虑：
- 若 $k_1<2h_i$，则 $j_2$ 优于 $j_1$；
- 若 $k_2\geqslant 2h_i$，则 $j_3$ 不优于 $j_2$。

由此可得，当这三个决策点在 $h_i$ 为横坐标、$f_i+h_i^2$ 为纵坐标的坐标系上构成下凸壳时，$j_2$ 才有可能成为最优决策。因此新的决策点进入时，用一个单调队列去维护。

转移时，在队首不断比较队首两点斜率和 $2h_i$，如果满足上式，说明 $k$ 优于 $j$，弹出 $j$，直至不满足为止。