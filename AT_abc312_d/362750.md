令 $1$ 表示左括号，$-1$ 表示右括号，$0$ 表示问号。

$f_{i,j}$ 表示 $1\sim i$ 前缀和为 $j$ 的方案数。

则 

$$
f_{i,j}=
\begin{cases}
f_{i-1,j-1} &(s_i=1)\\
f_{i-1,j+1} &(s_i=-1)\\
f_{i-1,j-1}+f_{i-1,j+1} &(s_i=0)
\end{cases} 
$$

不用考虑 $j$ 为负数的情况，因为合法括号序列的前缀和非负。

$\Theta(n^2)$。