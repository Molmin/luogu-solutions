> 我希望能讲清楚思路，代码就不放了。
 
$n$ 个点每个点连出一条边，这显然是一棵（片）基环树（森林）。

### 处理树的部分

不断寻找入度为零的点：没有任何人还他钱，只能由市长给他钱。市长需要给 $u$ 这个人 $B_u$ 元. 如果 $u$ 已经有了 $C_u$ 元，市长只用给 $B_u - C_u$ 元。

一旦 $u$ 得到了足够的钱，即 $C_u \ge B_u$，就会触发还债动作，$C_{A_u} \gets C_{A_u} + B_u $. 

- 还债后 $A_u$ 的入度减一，因而这一部分可以用类似拓扑排序的方式做。

- 如果 $A_u$ 也得到了足够的钱，那就继续下去……因而称作连锁反应。注意这行为对每个人都适用，也就是每个人得到钱之后都要检查是否足够还债。

- 值得注意的是，在环上的人如果有能力还债了，环就“破了”。如

![](https://cdn.luogu.com.cn/upload/image_hosting/1a7une9x.png?x-oss-process=image/resize,m_lfit,h_353,w_441)

### 处理环的部分

这时图中只剩下一些环。只要政府给环中一个人足够还债的钱，环就“破了”，变成一条链，可以照上面方法处理。那么政府该给谁钱呢？

![](https://cdn.luogu.com.cn/upload/image_hosting/ss3nhy19.png?x-oss-process=image/resize,m_lfit,h_416,w_514)

可以发现，每个人作为债主都会得到别人的钱。市长“希望”每个人都能先拿到别人的钱再拿政府的钱，这样政府付给他的钱就会尽可能少一些，即给 $A_u$ 这个人 $W_{A_u} = \max \lbrace B_{A_u} - C_{A_u} - B_u, 0 \rbrace$ 元

但是市长要先给一个人钱，如果选择 $u$，就要给他 $V_u = B_{A_u} - C_{A_u}$ 元而不是 $W_u$ 元。政府就共支出 $\sum W - W_u + V_u$.

只要选择 $- W_u + V_u$ 最小的那个人就可以了。

实际上实现并不需要先破成链再像第一部分处理，只需遍历一遍环，记录下 $\sum W$ 和 $\min{- W_u + V_u}$ 即可。