根据题意可以得到一些简单的结论

设每次操作前的序列$a$,当前操作的位置为$x$，则$s+=\prod a_i-(a_x-1)\prod_{i!=x}a_i$

设最后每个数被操作$b_i$次，于是最终的$S=\prod a_i-\prod (a_i-b_i)$

我们可以转而求$\prod (a_i-b_i)$ 的期望

继而可以求出所有情况下$\prod (a_i-b_i)$的和除以$n^k$

每种$b_i$序列出现的方案数是$C_k^{b_1}\times C_{k-b_1}^{b_2}···C_{k-b_1···-b_{n-1}}^{b_n}=\frac{k!}{b_1!b_2!···b_n!}$

于是我们把$k!$单独拿出来，剩下的$\frac{1}{b_1!b_2!...b_n!}$

我们可以用一个指数生成函数解决这个东西

对于每个$i$，有$F_i=\sum_j (a_i-j)\frac{x^j}{j!}$

答案就可以表示为$k! [x^k]\prod F_i$

对于指数生成函数有$e^x=\sum\frac{x^i}{i!}$

那么$F_i=a_ie^x-xe^x=(a_i-x)e^x$

$\prod F_i=(e^x)^n \times (\prod(a_i-x))$

$\prod (a_i-x)$可以$O(n^2)$得到一个n次多项式

剩下一个$\sum_{i=0}^n c_ix^i$

而$(e^x)^n=e^{xn}=\sum\frac{x^i n^i}{i!}$

把俩部份乘起来最后得到的$x^k$的系数是$\sum_{i=0}^{\min(n,k)} c_ix^i \frac{x^{k-i}n^{k-i}}{(k-i)!}$

我们发现$\frac 1{(k-i)!}$这个东西没法快速维护，其他部分都可以直接维护

我们把$k!$乘到式子当中，$\frac{k!}{(k-i)!}$是一个下降幂的形式，$\frac{k!}{(k-i)!}=\sum_{j=0}^{i-1}(k-j)$

于是可以$O(n^2)$解决它

当然，下降幂可以递推，而$\prod (a_i-x)$可以启发式合并多项式，尽管需要MTT，但可以优化复杂度只$O(nlog^2n)$但对于$n\le 5000$来说没有必要且代码难度和常数都很大