**P7898**题解。

标题不魔怔了。

我愿称其为数据结构思博题！！！

先简介一下这类平衡树：

- 是一类 leafy tree 结构，维护的信息可以是不带逆元的，且可支持可持久化及树套树。

- 单次插入/删除严格 $O(\log n)$ 数量级，但常数较大。

- 其主要思想是通过牺牲一定的常数代价，完成一个信息的合理分裂，以保证时间复杂度数量级的平衡。

- 可惜的是，除了常数大，在结构上这个东西如果要做区间反转，合并，分裂，是只能维护得 $O(1)$ 合并的信息，因为区间反转和平衡树合并以及分裂是双向归约的，应该是做不了的。

由于要严格 $O(\log n)$，可以考虑用一种比较优秀的伪静态结构维护，我们不难发现假设进行了 $10 ^ 6$ 次操作，这个玩意儿现在已经被卡满了，那么它是不超过一个叶子个数为 $10 ^ 6$ 的静态线段树的。

我们考虑将叉数换成 $15$，严格来说我们先钦定一个静态的 leafy tree 结构，使得第 $x$ 层的节点满足其维护的集合节点大小范围为 $[4 ^ {x - 1},4 ^ x)$，则显然的一个节点不会有超过 $15$ 个儿子，树高大小也为 $O(\log_4 n)$ 实际使用时大致为 $9$。

考虑在一个第 $i$ 层的节点 $x$ 大小达到 $3 \times 4 ^ {i - 1}$ 时准备分裂。考虑分裂成的两个新节点 $u,v$，在 $x$ 之后每次进行插入时对 $u,v$ 进行四次 $x$ 内部元素的转移插入，可以发现这样在 $x$ 达到 $4 ^ i$ 大小时可以完好分裂。

由于我们最后得到的总结点大小是有限的，即分裂出来的节点个数是线性的，所以分裂的次数也是线性的。

这样的话这道题的代价以及时间复杂度其实是很好证明的，代价与树的深度正相关，寻找的时间复杂度带一个 $15$ 的常数，分裂的时间复杂度也与满叉的树大小正相关。

这里有个小细节是分裂不要求两个分裂出去的集合大小相等或相差不大，只要求能合法分裂两个大小即可，因为总的分裂次数具有上界。

我们来讲一下这么做的合法性：可以发现的是一个节点的信息维护是类似标记永久化的，与儿子之间不存在信息的转移关系只存在结构上的关系（即标记永久化的线段树），所以儿子的分裂是不会影响祖先的信息维护的，这对于此题而言是极好的性质，但是如果信息能 $O(1)$ 转移其实怎么都无所谓。

接着是父亲的指向问题，你会发现祖先子孙不管谁先分裂最后父节点的指向都是正确的，这样信息与结构都是具有合法性的。

然后这道题就结束了，代价插入删除查询是大常数 $O(n \log n)$，时间复杂度是 $O(15 n \log n)$ 的。

拓展一些东西。

~~以下是纯口胡。~~

如果能支持信息 $O(1)$ 合并的话，还可以支持区间反转，具体我们可以考虑 split，类似 fhq-treap 分裂直接从上往下分即可，合并时候从下至上调整一下每层的分配具体地每层都得对中间的两个点进行合并或儿子分配的讨论。区间反转就直接对分裂出来的区间打全局反转标记即可。据 @[gxy001](https://www.luogu.com.cn/user/55707)说合理运用 leafy tree 的性质可以做到空间线性，我还是没懂怎么做到的只能说强强。

实现的时候难点是分裂时怎么找到要加入的元素，这个可以每次维护两个分裂集合的指针指到哪里了然后往子树里面暴力找，时间复杂度可能会退化成 $O(15n\log^2 n)$ 因为每个节点要被找至多 $\log n$ 次，每次要消耗至多 $\log n$ 的代价寻找且遍历叉数 $15$，咨询了一下 gxy 这么写~~是能过的~~，个人实现的时候用了一个平衡树维护查询却慢了很多，不知道为什么。

