我们稍微改变一下题意的叙述方式：给定正整数 $n,k$，请在 $n\times n$ 棋盘上选取 $C=n^2-(n-k+1)^2$ 个格子，使得给定的某些格子必选，且：

- 不存在 $k$ 个选出的格子 $(x_1,y_1),...,(x_k,y_k)$ 满足 $x_1 < x_2 < \cdots < x_k$，$y_1 < y_2 < \cdots < y_k$。（条件 A）

方便起见，下面我们记 $x$ 轴正方向为向右，$y$ 轴正方向为向上。

----------------

可以隐约感觉到这个 $C$ 是一个设计好的值。我们先来证明

**观察** 在满足条件 A 的情况下，至多只能从棋盘上选出 $C$ 个格子。

**证明** 考虑每一条左上 - 右下的 $45^\circ$ 斜线，注意到这条斜线上的任意 $k$ 个格子都违反了条件 A，因而这条斜线上只能选 $k-1$ 个格子。所有斜线的长度依次为 $1,2,...,n,...,2,1$，故能选出的格子数量的最大值不超过

$$
\sum_{i=1}^n\min\{i,k-1\}+\sum_{i=1}^{n-1}\min\{i,k-1\}
$$

计算一番，这个值就是 $C$。

---------------

进一步地，我们可以直接知道：

**观察** 在棋盘上选取 $C$ 个满足条件 A 的格子，那么对于每一条左上 - 右下的 $45^\circ$ 斜线，如果其长度不超过 $k-1$，那么这条线上的格子必须全选；如果长度大于 $k-1$，则需要选 $k-1$ 个格子。（条件 B）

但这似乎并不是等价的条件，我们需要继续探索。方便起见，下设 $t=k-1$。我们先来研究一些简单情形。当 $t=1$ 时，可以直接观察得到：

**观察** $t=1$ 时，所选的格子合法当且仅当它们构成了一条从左上到右下的路径。

证明不难。

----------------------

对于 $t$ 更大的情况，我们先画出所有必须选的格子（如下左图）。方便起见，称长度恰为 $t$ 的对角线（共 $2$ 条）为 **关键线**，上面的格子为 **关键格**（图中所有非空白也非黄色的格子）。手玩一下可以发现，似乎每组合法方案都对应着左上的所有关键格到右下的关键格的 $t$ 条路径（下右图）。

![](https://cdn.luogu.com.cn/upload/image_hosting/8gotzt0j.png)

我们猜想：

**猜想** 一组格子满足条件 A，当且仅当：

- 这组格子满足条件 B。
- 可以将两条关键线之间的所有格子划分为 $t$ 组，使得其中第 $i$ 组恰好连接了上关键线的第 $i$ 格和下关键线上的第 $i$ 格。


**证明** 

**能划分为路径则满足条件 A** 注意到两条关键线上以及关键线以外的格子不可能出现在某个长度为 $k(=t+1)$ 的上升序列中（这些位置一侧的列数 + 另一侧的行数 $< k$）。在剩下的格子中选 $k$ 个，则必有两格属于同一条路径，这两格之间不可能是上升的。

**满足条件 A 则能划分为路径** 考虑相邻的两条长度都 $\geq t$ 的对角线。假设上面的那条对角线上选中的格子从左到右依次为 $P_1,...,P_t$，下面的那条对角线上选中的格子从左到右依次为 $Q_1,...,Q_t$。我们将证明：对每个 $1\leq i\leq t$，$Q_i$ 要么在 $P_i$ 正下方，要么在 $P_i$ 正右方。

- 若不然，那么 $(P_i,Q_i)$ 之间是上升的，那么则可以选出 $k$ 个格子 $P_1,...,P_i,Q_i,...,Q_t$ 违反条件 A。

那么所有的格子便构成了一系列左上到右下的路径，证毕。

----------------

把结构探索清楚后，我们最后来考虑怎么解决原问题。

我们相当于是要用 $t$ 条路径覆盖所有输入中给定的必须出现的格子。我们先来分配每个必须出现的格子究竟属于哪条路径。考虑从左到右依次为每对起、终点分配：

**策略** 每次都选取剩下的点中能加入当前路径的点中最靠左的，如有多个选择最靠上的。

接着我们需要连接每条路径。

**策略** 对于每条路径上两个待连接的相邻点，我们总是从左侧的点先一路向右到达目标列，再一路向下。

容易证明这个策略是正确的。稍微优化一下找格子的过程，时间复杂度 $O(n^2\log n)$ 或 $O(n^2)$。

------

**后记**

Anton 鸽鸽最新力作，全 CF 都在看！（bushi）

一开始读反了题意，以为是某些格子被强制 **不能选** 而不是一定要选。这个题意似乎也可以做，相当于是在一个挖掉了一些格子的棋盘上找到若干条不相交的路径。也是考虑从左到右依次确定每对起、终点间的路径，贪心选取方向（能下则下，不能则右）即可。