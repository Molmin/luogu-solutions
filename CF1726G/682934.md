瞎写的东西过了，震撼。

假设最终的数是 $X>\max a_i$（$X=\max a_i$ 稍后讨论），考虑合法的条件。设最终的排列为 $p$，需要满足：

* 若 $b_{p_i}=0$，那么 $\sum\limits_{j>i}[a_{p_j}<a_{p_i}]=X-a_{p_i}$，这是因为前面的 $j<i$ 的 $p_j$ 都已经操作过了，现在它们开心值是 $X>\max a_i$，不可能比 $a_{p_i}$ 小。
* 若 $b_{p_i}=1$，那么 $\sum\limits_{j>i}[a_{p_j}>a_{p_i}]=X-a_{p_i}-(i-1)$，这是因为前面操作过之后值为 $X>\max_j a_j\geq a_{p_i}$，所以它加上的值为后面比它大的值和前面所有数。补集转化一下变成 $\sum\limits_{j>i}[a_{p_j}\leq a_{p_i}]=n-i-(X-a_{p_i}-(i-1))=n-X+a_{p_i}-1$，这是一个定值。

所以尝试按照 $a_i$ 从小到大的顺序插入排列。

先考虑 $a_i$ 互不相同的情况，那么可以发现，$a_i$ 插入的位置是固定的，因为我们需要保证有定值个比 $a_i$ 小的数排在 $a_i$ 后面，所以容易确定 $a_i$ 的位置。

再考虑 $a_i$ 可能相同的情况。$b_i=0$ 的情况稍简单，我们首先讨论。显然，所有满足 $a_i=y,b_i=0$ 的数插入的位置一定在确定的两个数之间，且不同的数之间可以任意排列，所以假设这样的数有 $c_0$ 个，方案数为 $c_0!$。再讨论 $b_i=1$ 的情况。可以发现，若有两个数 $p,q$ 满足 $a_{p}=a_{q}=y,b_{p}=b_{q}=1$，那么 $a_p$ 和 $a_q$ 后面小于等于它们的数必定不相等。假设 $p$ 插入排列中的位置 $pos_p<pos_q$，那么 $p$ 后面小于等于 $y$ 的数有 $a_q$ 和 $a_q$ 后面所有小于等于 $y$ 的数，这显然严格大于 $a_q$ 后面小于等于 $y$ 的数，所以出现两个以上 $a_i=y,b_i=1$ 的方案数是 $0$，否则方案数是 $1$。

注意到对于方案数的讨论与 $X$ 无关，这说明对于任意 $X>\max a_i$，方案数是相等的。不过我们需要考虑 $X$ 的范围。对于 $b_i=0$，需要满足 $X-a_i\leq \sum_{j\neq i} [a_j<a_i]$，对于 $b_{p_i}=1$，需要满足 $0\leq n-X+a_{i}-1\leq \sum_{j\neq i}[a_j\leq a_i]$。扫一遍判断即可。

接下来只需要讨论 $X=\max a_i$ 即可。不过可以发现，这种情况与上面的情况唯一的区别是，对于 $a_i=\max_j a_j,b_i=1$ 的数，它可以放在排列中任何位置，而其余条件与上面相同，所以假设这些数的个数为 $c_1$ 个，将答案乘上 $n^{\underline{c_1}}$ 即可。

时间复杂度 $\mathcal{O}(n)$。

[code](https://codeforces.com/problemset/submission/1726/211313442)