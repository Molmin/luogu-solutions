提供一种不用分层图的**正确**做法并给出了证明。（虽然我已经会分层图的做法了）

开始并没有看懂分层图，直到看到了一篇做法清晰明了又好懂，就是没有证明。（主要是估计他也不会/不想证。。。）

众所周知，暴力建边要 $O(n^2)$，于是直接想办法建 $O(nK)$ 的边。

先给出结论，对于每个点只用对于每种颜色连前驱和后继，再补上每个点直接到 $n$ 的边。

显然只有 $O(nK)$ 条边，至于找点随便用个指针带着走也不至于有 $\log$。

------------

证明：

考虑由一个点 $i$ 颜色为 $c_i$ 走到另一种颜色为 $c_j$ 的点 $j$ 上，不妨设 $i<j$。

如果有最近的一个点 $k$ 满足 $c_k=c_j$ 在他中间，即 $i<k<j$，在当前建图下显然就走不到 $j$ 而只能到 $k$ 了。

但是如果我们接下来希望从 $j$ 走到另一个点 $x$，那么一定有 $S_{c_j,c_x}=S_{c_k,c_x}=1$。

首先一定有 $x>j$，因为显然当 $x\le j$ 时走 $j$ 一定没有 $k$ 优。

继续考虑 $x$ 与 $k$ 中间最近的点 $y,c_y=c_x,k<y<x$ 也是如此，这样走就必须一直向右走直到某个颜色。

直到你不找下一个点了，那么就得直接跳到 $n$。

这样只走后继显然也是能一直往右找到那个颜色的，这里的长度均为 $n-i$。

或者你不走其他点 $j$ 而直接走最近的后继 $k$ 的情况在图中已经表示出来了，跑最短路肯定就能跑到。

那么 $j<k<i$ 的情况也类似，我们肯定往左走到某个点 $p$ 直接转移到 $n$，但我们在新图上走，同理分析一定能找到同样颜色的点 $q\ge p$，那么 $|p-i|+|n-p|\ge |q-i|+|n-q|$，一定不劣。

否则就是直接走最近的前驱也加边表示出来了。

故可以代替原图来找最短路。

------------

对一个边数 $O(nK)$ 点数却只有 $O(n)$ 的图跑最短路，可以随手用个最简单的基数堆优化到 $O(nK+n\log)$ 的复杂度，时间复杂度并不劣。