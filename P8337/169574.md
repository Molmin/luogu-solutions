## Preface

为什么我写的这么卡常呢？

## Analysis

首先不难发现合法的集合大小一定 $2^k$，即这些数的二进制表示有 $1$ 的为有 $k$ 位，且所有这些数全部存在于集合中。因此集合大小只有 $\log n$ 种。考虑对每种集合大小分别计算答案。

显然对于一种集合大小，以每个位置为右端点的**合法区间的左端点**一定是一个区间。于是我们考虑双指针算出对于每个右端点的这个左端点区间。

想必大家都做过 [CF1100F](https://www.luogu.com.cn/problem/CF1100F) 吧，他可以帮我们维护一个类似区间线性基的东西。这样我们就可以 $O(n\log V)$ 建出前缀线性基，然后 $O(\log V)$ 查询出一个区间的线性基集合大小了。

我们同时维护这 $\log n$ 种大小的合法集合的左端点区间位置。

首先我们不管是否能取遍这 $2^k$ 个数，我们算出只关心线性基大小时的左端点区间。右端点移到一个位置时，我们查出这个前缀线性基，前缀线性基中靠后的 $\log n$ 个位置就是这 $\log n$ 个大小的合法集合在仅考虑线性基大小时的左端点的区间范围了（有点绕，请读者自行理解）。

然后我们还要算区间元素种类数是否满足是 $2^k$。我们算出每个位置的前驱，那么我们在移动指针时就能快速确定一个位置对区间种类数的贡献，于是直接双指针扫描即可。最终我们在 $O(n\log V)$ 的时间复杂度内求出了所有的合法左端点区间。

接下来考虑统计答案。首先 $\log n$ 种大小的答案我们分开计算。以下讨论针对于一种集合大小。

我们把所有的贡献抽象成二维平面上的线段，就会有如下图的贡献。

![](https://cdn.luogu.com.cn/upload/image_hosting/fu42au3p.png)

且这些线段有很好的性质，就是左右端点都是分别单调不降的。一次询问是问如图红色三角形内的线段长度之和。考虑将线段沿直线 $r=l$ 差分，变成如下线段。

![](https://cdn.luogu.com.cn/upload/image_hosting/c2ktrof2.png)

即橙色线段长度和减去绿色线段长度和。而所有线段的左端点又是单调，所以询问的三角形区间下半部分是顶着边界的，上半部分是所有线段的长度和。预处理前缀和和到达每个横坐标的最小纵坐标位置，即可做到 $O(1)$ 的查询，预处理是 $O(n)$ 的。

由于有 $\log n$ 种集合大小，于是这一部分的复杂度是 $O(n\log n + q\log n)$ 的。

假设 $n,q$ 同阶，复杂度 $O(n\log V+n\log n)$。

## Code

[Submission](https://www.luogu.com.cn/record/98398832)。听说 Ynoi 最近流行不放代码，所以不放了，要代码私信（~~感觉代码比我在这里瞎逼逼清楚~~）。