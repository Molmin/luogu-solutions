为了方便，我们把在山谷内的点称为黑点，其他点称为白点，黑连通块内部不与外部联通的白点为空腔。

性质一：以每个点为最大值的山谷如果存在是唯一的。因为从这个点开始，相邻的比他小的点一定选，比他大的点一定不选。

性质二：两个不同的黑连通块除了它们内部以外不会形成空腔。这是由题目性质决定的，我们在考虑黑连通块时是四联通，而白连通块是八联通。简单画一画可以发现无论这两个黑连通块挨得再近都一定可以被八联通的白点分开（如下图）。

![](https://cdn.luogu.com.cn/upload/image_hosting/bc90agai.png)

那么我们可以考虑从小到大加入黑点，发现加入了一个黑点后可能会把若干个黑连通块连起来。发现这样可以形成一棵树的结构，类似于克鲁斯卡尔重构树。

这棵树有什么用呢？由于我们要看白点是否全部联通，如果是加入黑点则需要删边，不好处理。而如果是加边，我们就可以用并查集动态维护连通块个数了。而这棵树就是我们要进行的加边顺序。

那么我们遍历到了一个点，我们把它变成白点，连一圈边，维护出了连通块个数。现在我们要以此考虑它的子树是不是合法的山谷，也就是没有空腔。

如果是全局没有空腔，条件显然是连通块个数为 $1$。但是其他子树内部也可能有空腔，会造成影响。但由于性质二，我们不需要考虑子树两两之间会形成空腔。

发现如果一棵子树内部没有空腔的话，把这棵子树全部变成白点后连通块个数是不变的。于是我们在进入一棵子树时记录下当前的连通块个数，递归完后判断一下和当前的是否相等即可。

除了并查集外复杂度 $O(N^2)$。