把 $(i,i+1)$ 看成一段线段，一次操作的贡献就可以摊到区间内的所有线段上。

关注到两次操作若线段有交必定不如对并集操作一次，因此每个线段对每个区间贡献不超过 $1$。

考虑 $(i,i+1)$ 对 $[l,r]$ 无贡献（$l\le i<r$），当且仅当 $\max\{a_{l\dots i}\}\le \min\{a_{i+1\dots r}\}$，此时左右两半可视为独立。

考虑统计线段总共有多少次无贡献，容斥减一下就好。

记 $pre_i$ 表示 $i$ 左侧第一个 $a_x>a_i$ 的位置（没有记 $0$），$nxt_i$ 表示 $i$ 右侧第一个 $a_x>a_i$ 的位置（没有记 $n+1$）。

枚举左半最大值 $a_x$，那么可选区间左端点为 $[pre_x+1,x]$。由于无贡献线段必须满足右半 $\min$ 大于等于左半 $\max$，因此对于一个 $x$，其能讨论到的线段有且仅有 $(las_x-1,las_x)$。此时右端点可以在 $las_x$ 所在，由 $>a_x$ 的元素构成的连续区间中任选。

因此我们从大到小插入每个数。用 $0/1$ 表示某个数是否被插入，问题变为找每个位置前后第一个 $1$ 位置、维护每个 $1$ 连通块大小。

关注到插入顺序的特殊性，第一个问题可以单调栈预处理。关注到询问的特殊性，第二个问题只需要维护连通块两个端点的信息。

由于需要离散化，复杂度 $O(n\log n)$。[record](https://codeforces.com/contest/1827/submission/208579526)。