这是一道好题。说实话思路并不好想。
****
先口胡一个东西，就是如果在一次循环**结束**之后**离开了染色子树**但**没有完成对染色子树的遍历**，这种命令是不可行的。

来个证明，因为在根节点处不能向上，所以机器人的**整体运动趋势肯定是远离根节点**的。

这个结论还有一个推论，就是某次循环完后到达节点 $x$，那么**染色树中非 $x$ 子树的必须完成遍历**。这个其实也很好理解。

还有一个重要的结论就是每次机器人循环开始的起点和终点**相对位置不变**。

于此我们可以画出一张图，其中红色的表示每次循环开始的起点终点。

![4ygOdH.png](https://z3.ax1x.com/2021/09/26/4ygOdH.png)

这样我们就可以开始着手设计循环了。

首先起点终点的相对位置不变，而且二叉树无限大，所以我们可以试着在每次循环内把所有的不同的情况都遍历掉。

什么意思呢，我们要在一次循环内把下图中绿圈圈起的三个部分遍历完

![4yRIKK.png](https://z3.ax1x.com/2021/09/26/4yRIKK.png)

考虑合并这三个部分。

![4y5ATU.png](https://z3.ax1x.com/2021/09/26/4y5ATU.png)

显然除了合并，我们还要到达下次开始的节点，也就是图中左下角的节点。

考虑一下每次命令需要的长度，显然最优的情况是红点到红点之间的链只走一次，其他走两次。

那么 $\texttt{ans}=\left(\texttt{size}-1\right)\times2-\texttt{dep}$.其中 $\texttt{size},\texttt{dep}$ 分别表示这棵树的大小和红点间的距离。

至于怎么寻找红点，考虑暴力枚举。

综合时间复杂度 $\mathcal{O}\left(n^2\right)$.

最后做一个提醒，递归建树的时候切记不可开全局变量！！！

需要代码的私信找我要。

