以下讨论只针对 H1，由于 H1 和 H2 做法不太一样，所以如果想知道 H2 的做法可以去看 zky 的题解或者官方题解。

非常好的 AGC 风格的题，给出题人点个赞。

首先考虑给定的基环内向森林 $a$，如何对 $b$ 计数？我们假设 $S_i$ 表示 $i$ 在 $b$ 中出现的位置集合，那么不难发现 $S_i$ 最多只有四种可能：$\varnothing,\{i\},\{a_i\},\{i,a_i\}$。考虑这三种情况什么时候出现。我们假设我们确定 $S_i=\{i,a_i\}$，考虑这会带来怎样的影响，显然 $a_i\notin S_{a_i}$，如果 $S_{a_i}=\varnothing$ 那么这个 $S_i$ 带来的影响就到此为止了，如果 $S_{a_i}=\{a_{a_i}\}$ 那么 $a_{a_i}$ 也不能属于 $S_{a_{a_i}}$，以此类推一定会到达一个 $S_i=\varnothing$ 的点，不难发现这构成了若干个长度 $\ge 2$ 的链。显然每个点最多属于一条链，但是并不一定所有点都属于恰好一个链，我们考虑孤立点有什么性质，如果我们将它们视作长度为 $1$ 的链，那么有结论：每个孤立点不能连向其他链的链尾节点，其他点都是合法的，因为孤立点 $x$ 连到一个链尾节点 $y$，如果 $x$ 比 $y$ 先操作 $y$ 就死了，如果 $y$ 比 $x$ 先操作，那么有 $b_y\ne y$，而链尾节点必须有 $b_y=y$，因此不合法。而对于其他节点，假设我们连到的节点为 $y$，$y$ 在链上下一个节点为 $z$，那么我们操作完 $y$ 后直接操作 $x$，再直接操作 $z$ 即可消除 $x$ 带来的影响。

接下来考虑如何计数，由于孤立点和其他点不一样，我们先枚举孤立点个数 $x$，再枚举 $\ge 2$ 的链的条数 $y$，那么将剩余 $n-x$ 个点划分成 $y$ 条链的方案数是 $[x^{n-x}](n-x)!·\dfrac{1}{y!}B(x)^y$，其中 $B(x)$ 为长度为 $l$ 的 $\ge 2$ 的链的方案数的 EGF，为 $\sum\limits_{i\ge 2}\dfrac{i!x^i}{i!}=\sum\limits_{i\ge 2}x^i$，直接背包即可，确定孤立点和其他点的相对标号的方案数为 $\dbinom{n}{x}$，确定链头节点的 $a$ 的方案数为 $(n-x-y)^x·(n-1)^y$，乘起来求和就是答案。

时间复杂度 $n^2$。