首先通过二分答案变为判定性问题

显然在走的过程中每次回到一个已经过的点时，与 $1$ 联通的点之间可以互相走到，于是一个自然的想法是每次从已经经过的点出发**扩展一些未经过的点**

一次合法的扩展有以下两种情况：

- 形成一个由未经过点构成的环，形状类似于逗号，出发点就是逗号的尾巴那端

- 从已经过到已经过

如果直接dp之类的想法，比如设 $f_u$ 表示从某个已经过的点到  $u$ 最终的权值最大是多少，应该是类似于最长路的，而后者是np的

考虑一个暴力搜索的过程：每次经过一个点，就把它最大的权值更新。如果两次更新到同一个点 $u$，可以在第二次的路径走完后倒序走第一条路径，由于 $b$ 都非负，显然合法。

因此每个点只会被更新一次，时间复杂度 $O(nm\log a)$

[提交记录](https://codeforces.com/contest/1558/submission/127149871)