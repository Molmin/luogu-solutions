不妨设原来的矩阵中一共有 $C$ 种数字。

**结论一** $C\leq k$ 时，答案为 $k-C$。

**证明** 每次操作至多让 $C$ 增加 $1$，且 $C < n^2$ 时一定有一种操作方法可以使 $C$ 增加 $1$。

**结论二** $C > k$ 时答案不超过 $2$。

**证明** 观察以下一系列方案，其中，黄蓝两色分别表示两个需要覆盖正方形区域，绿色表示两个正方形的重叠区域。不妨假定我们将两个正方形区域赋为同一个值，且该值没有在其他地方出现过。可以发现，此时的 $C$ 等于图中空白部分的数字种数加上 $1$。

![](https://cdn.luogu.com.cn/upload/image_hosting/vsrv48n3.png)

这些方案是这样构造的：方案分成 $n$ 行，第 $i(1\leq i\leq n-1)$ 行第 $1$ 个方案只用了一个正方形（黄色），它位于全图的左下角，边长为 $i$。接着，一个右上角为 $(i+1,i+1)$ 的正方形（蓝色）开始不断扩展，直到它把黄色正方形整个吞噬为止，此时进入了下一行。特别地，第 $n$ 行只有一个方案，该方案中一个正方形覆盖了全图。

（上面是一个 $n=6$ 的例子，简便起见只画了前三行。）

注意到在这样的顺序下，每一种方案的空白区域比前一个方案都少了 $1$ 个或者 $2$ 个。那么，空白区域的数字种数也只会减小 $0,1$ 或 $2$。那么，其中一定有一种方案，其空白区域数字种类数为 $k-1$ 或 $k$。如果为 $k-1$ 那么直接解决；如果为 $k$，注意到我们前面钦定了染色时两个正方形都染一种从未出现过的颜色，我们改染 $k$ 个颜色中的一种即可让总颜色数变为 $k$。得证。

------------------

所以，我们只需要判断 $C > k$ 时，答案能否为 $1$ 即可。注意到总正方形数只有 $O(n^3)$ 个，可以采用相对暴力的判法。考虑枚举正方形一条对角线所在的直线，那么每个颜色对应一个区间 $[l,r]$：当且仅当正方形左右边界坐标完全包含 $[l,r]$ 时，该颜色被全部包含在正方形内。求一次二维前缀和即可知道每个正方形外的颜色数，判断是否为 $k$ 或 $k-1$ 即可。时间复杂度 $O(n^3)$。