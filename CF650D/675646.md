[题目传送门](https://www.luogu.com.cn/problem/CF650D)

这道题我们可以先求出以第 $i$ 个数结尾的 LIS 长度 $d[i]$。

同理反着求一遍也可以求出以第 $i$ 个数开头的 LIS 长度。

回到本题，对于每次修改 $a[i]=x$。

很显然有2种情况：

1. 新的 LIS 包含 a[i]。

2. 新的 LIS 不包含 a[i]。

所以我们先求一定包含 $a[i]$ 的 LIS，预处理出以第 $i$ 个数结尾的 LIS：$left[i]$ 和以第 $i$ 个数开头的 LIS：$right[i]$。

现在我们只要求出左边 $\max(left[j])$ 和右边 $\max(right[j])$，两者长度相加再加 $1$ 就是包含 $a[i]$ 的新 LIS 了！

如果这个值大于原序列的 LIS，那它就是答案，输出即可。

接下来我们分析 LIS 不包含 $x$ 的情况：

1. 如果修改的数在原序列的 LIS 中，则不包含修改的数的 LIS 一定会减少 $1$。

2. 如果修改的数不在原序列的 LIS 中，则不包含修改的数的 LIS 则不会变化。

于是这道题就变成了对于序列中的每个数，判断其是否出现在 LIS 中。

先用之前的思路算出包含 $a[i]$ 的 lis：$len[i]=max(left)+1+\max(right)$。

如果 $len[i]$ 等于原序列的 LIS，那么 $i$ 可能出现在 LIS 中。

那如果 i 可能出现，就又如果存在 $j<i$ 且 $a[j]\geqslant a[i]$ 且 $j$ 可能出现在LIS中，当然 $i$ 也可能不出现在 LIS 中。

同理如果存在 $j>i$ 且 $a[j]\leq a[i]$ 且 j 可能出现在 LIS 中，
那么 $i$ 可以不出现在LIS中。

所以如果 $i$ 不满足可以不出现在 LIS 中的条件，则 $i$ 一定出现在 LIS 中。

则对于每次修改 $a[i]=x$，先计算包含 $x$ 的LIS长度。如果比原序列 LIS 大，则一定是答案。

否则，如果 $i$ 可以不出现，则 LIS 不变，否则如果 $i$ 一定出现，则 LIS 会减少 $1$。

回过头来，它就是计算 $\max(left[j])$，也就是经典二维数点问题。

对 $a[j],x$ 排序。从小到大枚举 $x$，把 $a[j]<x$ 的 $left[j]$ 插入树状数组的第 $j$ 个位置。

所以我们把维护更新和询问树状数组的加法变成求 $max$，问题就转化成了求前缀最大值。

这样我们就可以解决这道题了！