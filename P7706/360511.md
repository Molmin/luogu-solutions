NOIP 考前一天，写一篇题解 rp++。

直接用线段树来维护，考虑 $3$ 操作怎么搞。

线段树每一个区间不妨直接维护 $\psi$ 的最大值，那么就转化成怎样快速地合并信息。

如果 $u$ 的左右孩子分别为 $lc$ 和 $rc$，那么最简单的一种情况是，$u$ 的最大的 $\psi$ 的 $i,j,k$ 都位于 $lc$ 或则都位于 $rc$，这种情况直接取 $lc$ 的 $\psi$ 和 $rc$ 的 $\psi$ 的最值即可。

那么还剩下两种情况：$i,j$ 位于 $lc$，$k$ 位于 $rc$ 或者 $i$ 位于 $lc$，$j,k$ 位于 $rc$。

我们设 $sub_{u,1}$ 表示在 $u$ 这个子树中，$a_i-b_j$ 的最大值是多少，另设 $mxa_u$ 表示 $u$ 这个子树中 $a_i$ 的最大值，其中 $i<j$。那么对于情况 $1$，$u$ 的 $\psi$ 应该取为 $sub_{lc,1}+mxa_{rc}$。对于情况 $2$ 也同理，只不过需要再设 $sub_{u,2}$ 表示 $a_i-b_j$ 的最大值，其中 $i>j$。

现在问题在于怎样快速地处理出 $sub_{u,1/2}$。这个很好维护，我们再维护 $a_i$ 最大值，$b_i$ 最小值，每次合并信息时，$sub_{u,1}$ 等于 $lc$ 的 $a$ 的最大值减去 $rc$ 的 $b$ 的最小值。

代码方面 $\text{push\_up}$ 的时候有一个技巧，返回一个两个节点合并出来的节点，这样在查询时需要合并并没有直接关系的节点会有很大帮助。

~~代码不贴了，写得太丑了。~~

[$\text{AC}$ 记录](https://www.luogu.com.cn/record/62983150)