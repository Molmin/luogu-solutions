我真是弱到爆了，竟然不知道自己想的方法能用线段树维护，真的是联赛退役了什么都不会了。。。

这个跟维护最大子段和的方法差不多，你其实只需要用线段树维护 $A_i$ 的最大值，$B_i$ 的最小值，$A_i-B_j$ $(i<j)$ 的最大值，$A_k-B_j$ $(j<k)$ 的最大值和 $A_i-B_j+A_k$ $(i<j<k)$ 的最大值即可。

向上合并就很容易了，跟最大子段和也大差不差。

时间复杂度：$O(n+m\log n)$。