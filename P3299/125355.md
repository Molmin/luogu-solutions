# 题目

[传送门](https://www.luogu.com.cn/problem/P3299)

补充一个数据范围：

对于 $30\%$ 的数据，保证 $n\le 10^3$；

对于 $50\%$ 的数据，保证 $n\le 10^4$；

对于 $70\%$ 的数据，保证 $n\le 10^5,1\le d,x,a \le 10^6$；

对于所有数据，保证 $n\le 10^6,1\le d,x,a\le 10^{12}$；

# 题解

明白题意——不存在伤害溢出，即豌豆射手可以在一秒钟内，前 $0.3s$ 攻击前一个僵尸，后 $0.7s$ 攻击另外一个僵尸。

形象地说，这是高级豌豆射手了，发射的是激光......

先分析如何拿到部分分：

## 对于前一组数据

由于是 $n\le 10^3$，我们可以考虑一下暴力，首先 $n$ 的枚举是不可或缺的，而后，对于每一组的答案来说，单调性是显然的，那么我们可以考虑二分一个 $x$，用 $n$ 来检查这个 $x$ 的合法性，总复杂度在 $\mathcal O(n^2\log a)$.

## 对于前两组数据

往深挖掘一下题目性质，我们发现这个二分是根本没有必要的。

对于第 $i$ 组的第 $j$ 只僵尸（显然有 $j\le i$），显然要打倒它需要先将其前面的所有僵尸以及它自己的血量减到 $0$，而它需要走过的距离为 $x_i+d\times (i-j+1)$，由于我们要使攻击力最小，那么就需要它刚刚好在走到门口的时候将其打死，那么一只僵尸的最低要求即为
$$
\frac{\sum_{t=j}^ia_t}{x_i+d\times (i-j+1)}
$$
考虑用前缀和来简化柿子，记 $pre_t=\sum_{i=1}^ta_i$，而我们要让每只僵尸都满足要求，那么我 们要取所有僵尸中的最大值，那么对于每一组，实际上我们要求的是
$$
\max \left (\frac{pre_i-pre_{j-1}}{x_i+d\times (i-j+1)} \right )
$$
可以发现这样做其实是 $\mathcal O(n^2)$ 的，刚好过得去 $n\le 10^4$ 的数据。

## 对于正解

继续分析柿子，将柿子变换一下
$$
\begin{aligned}
\frac{pre_i-pre_{j-1}}{x_i+d\times (i-j+1)}&=\frac{pre_i-pre_{j-1}}{x_i+d\times i-d\times (j-1)}
\end{aligned}
$$
发现一些相同的地方，比如 $i$ 和 $j-1$，这个时候要斜率联系起来了，将柿子中的两个部分分别看成两个点 $(x_i+d\times i,pre_i)$ 与 $(pre_{j-1},d\times (j-1))$，那么这个柿子其实就是这俩点连线的斜率，最后我们要求的其实就是斜率的最大值。

发现后面一个点，也就是 $(pre_{j-1},d\times (j-1))$ 与 $i$ 无关，即**它在组数变化时独立，只和僵尸本身的信息有关**，那么我们可以考虑将所有僵尸保存在一个数据结构中，每次移动一个 $i$ 时，就是加入一个僵尸的信息（其信息为一个点 $(pre_{i-1},d\times (i-1))$），也相当于在一个点集中加入一个点，而询问，就是在所有僵尸的点构成的一个点集中询问定点与点集中的斜率最大值。

考虑使用凸包维护点集，应该维护其上凸性，下面给出证明：

假设存在这样的情况：

<div align="center">
    <img src="http://61.186.173.89:2019/2020/08/26/be28b5904ed63.png">
</div>

可以看出，这是一个下凸包，和我们所说的相反，现在我们要证明，点 $2$ 是不可能成为答案的，对于我们的目标点（也就是点 $(pre_{j-1},d\times (j-1))$）我们分开讨论它在凸包下与凸包上

- 目标点在凸包下方，那么它和每个点的连线是这个样子：

<div align="center">
    <img src="http://61.186.173.89:2019/2020/08/26/7ef542333a6a6.png">
</div>

可以看出，$i-1$ 这条线的斜率大于 $i-2$；

- 目标点在凸包上方，连线是这个样子

<div align="center">
    <img src="http://61.186.173.89:2019/2020/08/26/eadbf3a792dc9.png">
</div>

显然 $i-3$ 斜率比 $i-2$ 大；

两种情况 $2$ 都不可能成为答案，那么加点时我们维护一个上凸包即可。

对于寻找斜率最大值，显然可以用二分来做（机房大佬们人均三分，但是我似乎有什么误解），二分寻找斜率最大值即可。

由于每个僵尸只会加进去一次，也只会出来一次，所以均摊是 $\mathcal O(1)$ 的，主要还是询问的二分，最终复杂度为 $\mathcal O(n\log n)$.

# 代码

```cpp
https://www.cnblogs.com/Arextre/p/13567206.html
```

