提供一个在线做法。

动态维护一个支持插入的字符串集合，查询集合中有多少个串是查询串的子串，这个显然可以使用 AC 自动机做。

每次插入模版串都需要重构自动机，复杂度无法接受。

考虑二进制分组，在一个栈内维护多个 AC 自动机，每个自动机大小（内含字符串个数）均为 $2^p$ 且单调下降，每次插入一个字符串时新建一个自动机压入栈中，若栈尾两个自动机大小相等则合并，直至不存在大小相等的自动机，任意时刻下自动机个数不超过 $\log q$。

具体实现可以参考 CF710F。