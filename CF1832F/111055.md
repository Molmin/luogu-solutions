DP 好题。

先转成最大化 $a_i$ 和 $b_{p_i}$ 的交集的和。

考虑每个给定区间 $a_i$ 会匹配到哪个我们构造的区间 $b_{p_i}$，显然将 $a,b$ 按照中点 sort 之后可以发现 $p_i\leq p_{i+1}$，因此直接设 $f_{x,y}$ 为前 $x$ 个 $a_i$ 用掉 $y$ 段 $b_i$ 的答案。

用脚想都知道这玩意满足四边形不等式然后可以决策单调性优化，于是只需要快速求一个区间的答案 $g_{l,r}$ 即可，考虑本质不同的区间左端点只有 $2n$ 个（如果区间左右端点都不在 $a_i$ 的端点上，那么移过去答案不变），再用一次决策单调性优化就做完了。

求区间答案 $g_{l,r}$ 的只需要枚举所有决策点，是 $O(n^2)$ 的，但是后面这个求全局答案 $f_{x,y}$ 的的需要分治求同一行每一列的决策点，会多一个 $\log n$。

时间复杂度 $O(n^2\log n)$。