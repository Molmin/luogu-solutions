这也能紫题吗哥？

首先显然答案不会超过 $a_n$，所以每层只能取 $\sqrt{2a_n}$ 个。

考虑从前往后 DP，每层选若干个之后 $\div2$ 转移到下一层。

然后你用脚都能看出来前 $x-1$ 层的决策和第 $x$ 层的决策都是凸的，所以直接双指针扫一遍（你也可以叫它闵可夫斯基和）处理当前层决策即可。

时间复杂度 $O(n\sqrt v)$。