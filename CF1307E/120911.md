考虑枚举 $i$ 是左边走的最远的那个人走到的位置，$j$ 是右边走的最远的人走到的位置。然后考虑维护颜色为 $k$ 的人能放到左边的有 $x_k$ 个，右边的有 $y_k$ 个，都能放的有 $z_k$ 个。那么这个颜色能放两个的方案数是 $x_k\times y_k-z_k$。能放一个的方案数是 $x_k+y_k$。这样就能枚举 $[l,r]$ 求出 $i\leq l,r\leq j$ 的方案，二维差分一下是 $O(n^2)$ 的。

但是上述做法貌似并不能通过。因为要求逆元，第一个可以注意到要求逆元的数在 $n^2$ 级别，所以可以线性求逆元。但是貌似线性求逆元会 TLE？？？我流汗了。

然后就是发现枚举 $j$ 没有用，直接钦定一个一定在 $i$ 上就行了，这样逆元也可以直接快速幂了，时间复杂度 $O(n\log n)$。

所以我不能理解啊，出题人为啥不直接 $n$ 开大点，$n$ 开 $5000$ 是什么操作，用来误导选手然后发现自己做法常数过大吗。

[代码](https://codeforces.com/contest/1307/submission/187864681)，这里实现是维护了一个 $cnt_{k,0/1/2/3}$ 表示颜色为 $k$ 的 $4$ 种状态分别有多少个。大同小异。