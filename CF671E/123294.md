### *[CF671E Organizing a Race](https://www.luogu.com.cn/problem/CF671E)

设 $a_i = a_{i - 1} + w_{i - 1} - g_{i - 1}$ 且 $a_1 = 0$，则 $a_j - a_i$（$i < j$）表示从 $i$ 到 $j$ 且不吃 $j$ 的加油站时，需要消耗多少油量。

设 $b_i = b_{i + 1} + w_i - g_{i + 1}$ 且 $b_n = 0$，则 $b_i - b_j$（$i < j$）表示从 $j$ 到 $i$ 且不吃 $i$ 的加油站时，需要消耗多少油量。

那么 $k = 0$ 时 $[l, r]$ 合法当且仅当 $a_l \geq \max_{p = l} ^ r a_p$ 且 $b_r\geq \max_{p = l} ^ r b_p$。

给 $g_i$ 加 $1$ 产生的影响为将 $a_{i + 1\sim n}$ 减去 $1$，将 $b_{1\sim i - 1}$ 减去 $1$。因为只比较相对大小，所以也可以理解为将 $a_{1\sim i}$ 加上 $1$，将 $b_{i\sim n}$ 加上 $1$。

考虑从左往右开，发现当遇到 $g_i > g_l$ 时，需要在 $l\sim i - 1$ 的位置进行 $g_i - g_l$ 次操作，之后 $g_l$ 变成 $g_i$，可以继续开。考虑到还要从右往左走，一定是操作 $i - 1$ 最优。反证 + 调整易证。

设 $suc_i$ 表示最小的 $j > i$ 使得 $g_j > g_i$，那么从 $l$ 出发相当于操作 $g_{suc_i} - g_i$ 次 $suc_i - 1$，操作 $g_{suc_{suc_i}} - g_{suc_i}$ 次 $suc_{suc_i} - 1$，以此类推。从右往左扫描线，用单调栈 + 线段树维护从 $l$ 出发进行所有这样的操作之后现在的 $b$，记作 $b'$。

求出 $lim$ 表示最小的 $j > i$ 使得 $g_j > g_i + k$，那么 $r\geq lim$ 不合法。

对于剩余操作，直接加在 $g_r$ 上最优。因此，问题转化为求最大的 $r < lim$，使得 $b_r + k \geq \max_{i = l} ^ r b'_i$。显然 $r$ 一定在单调栈上，即若 $r_1 < r_2$ 且 $b_{r_1} > b_{r_2}$，那么 $r_2$ 没用。但是我们不能二分，因为 $r$ 合法不代表 $r' < r$ 也合法，即使是在单调栈上。枚举也不行。

但令人惊讶的是，我们可以检查一段区间 $[p, q]$ 内是否有合法的 $r$。找到区间最大的 $b_i$。因为 $b_i$ 最大，而 $b'_j$ 由 $b_j$ 加上一个不大于 $k$ 的值得到，所以 $b'_{p\sim i}\leq b_i + k$。如果 $b_i$ 不合法，那么 $\max_{j = 1} ^ {p - 1} b'_j > b_i + k$，显然整个区间也不合法。

于是我们又可以二分了。每次二分需要查询 $b$ 和 $b'$ 的区间 $\max$，前者 ST 表，后者线段树。时间复杂度 $\mathcal{O}(n\log ^ 2 n)$。

不妨认为 $b_{1\sim l - 1} = -\infty$，直接在线段树上二分即可做到 $\mathcal{O}(n\log n)$。向右递归时，将当前维护的 $\max_{j = 1} ^ {p - 1} b'_j$ 和左子树的值取 $\max$。[代码](https://codeforces.com/contest/671/submission/211420685)。

