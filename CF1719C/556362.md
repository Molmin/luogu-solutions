分享一种线性做法（CF 上的标签我一个也没用到）：

对于 $a_x=n$，当和他比较时，是它就会多胜利一次，我们可以分三种情况：$y<x-1$，此时是不会比较到 $x$ 的；否则在比较不到 $x$ 时，前面的数会比较 $\max(x-2,0)$，那么答案就是 $y-\max(x-2,0)$。

否则，记录 $num_x$ 表示 $[x,n]$ 出现的最靠左的位置，那么此时如果 $\min(num_{a_x+1})<x$（$x$ 被弹出）或 $y<x-1$（还没到关于 $x$ 的操作）答案都是 $0$；否则如果弹出 $x$，就需要 $num_{a_x+1}-2$ 次比较，但是最多比较次数为 $y$，所以上界就是 $\min(num_{a_x+1}-2,y)$，下界是比较到 $x$，此时仍需要 $\max(0,x-2)$ 次操作，所以答案就是 $\min(num_{a_x+1}-2,y)-max(0,x-2)$。

时间复杂度 $O(n+q)$。