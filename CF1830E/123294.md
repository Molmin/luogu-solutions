### [CF1830E Bully Sort](https://www.luogu.com.cn/problem/CF1830E)

先考虑怎么求 $f(p)$。

若 $p_n = n$，则令 $n$ 减去 $1$。否则相当于交换 $n$ 和它后面最小的数。

直接从一个数被移动的次数考虑太困难了，尝试找不变量或易求变量之间的关系。

我们发现一个关键性质：设 $n$ 当前位置为 $i$，它后面最小的数的位置为 $j$，那么 $p_j\leq i$，即 $p_j$ 还要继续向左移动：因为 $i\sim n$ 共有 $n - i + 1$ 个互不相同的数，所以 $p_{i\sim n}$ 的最小值一定不大于 $i$。

考虑一次交换：设 $k = j - i$，那么它使得 $\sum |i - p_i|$ 减少 $2k$，而逆序对数减少 $2k - 1$。又因为最终 $\sum |i - p_i|$ 和逆序对数均为 $0$，所以操作次数 $f(p) = \sum |i - p_i| - \sum_{i < j} [p_i > p_j]$。

前半部分容易线性维护，后半部分就是动态逆序对板子了。使用你喜欢的三维偏序解法即可。

时间复杂度 $\mathcal{O}(n\log n + q\log ^ 2 n)$。[代码](https://codeforces.com/contest/1830/submission/207768904)。