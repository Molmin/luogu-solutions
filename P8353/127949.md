[题目传送门](/problem/P8353)

提供一种不需要邪道（如 `fseek` 等）的树剖做法。

首先，树剖需要两个 dfs 预处理出父亲、子树大小、重儿子、深度、dfs 序和链顶。

显然，不能同时存下 $6$ 个数组是一个大问题。但如何 dfs 也是一个难点：你不可能把所有儿子存到 `vector` 里面正常遍历。

注意到题目中保证 $fa_i<i$，这条性质十分有用。

首先，树剖的第一遍 dfs 可以直接倒着枚举，得到重儿子；第二遍 dfs 直接正着枚举，先遍历重儿子，得到 dfn 序。

同时，上面所提到的性质，保证了我们不需要存深度，直接比较就行了。

但这样还是要存 $3$ 个数组，看起来还是不够。

观察到所有数的值域都是 $[1,n]$，可以用 `int24` 进行存储，压掉 $\dfrac14$ 的空间，就存的下了。

这样还有一个问题：点权是 $32$ 位的，两个 `int24` 加上一个 `unsigned` 还是开不下。

然而，强制在线的 $lastans$ 只有低 $20$ 位有用，我们可以先只做低 $20$ 位，这样可以知道树剖需要用到哪些点的 $fa$。注意做的时候要用分块，因为剩下的空间不足以使用线段树等数据结构。

需要用到 $fa$ 的点数是 $O(q\log n)$ 的，可以把它们单独存起来，用不到的 $fa$ 扔掉。这样就有足够的空间开下点权了，直接做就行。

手写内存池，最终空间 $62.8$ MB。[提交记录](//loj.ac/s/1721217)。