**注意下标从$0$开始**

对于每个位置 $i$,它的上界 $R_i$ 与下界 $L_i$ 都是确定的.
$$\forall i\in [0,n),L_i=\lceil \sqrt{n^2-i^2}\rceil,R_i=\lfloor \sqrt{4n^2-i^2}\rfloor$$
$$\forall i\in[n,2n),L_i=0,R_i=\lfloor \sqrt{4n^2-i^2}\rfloor$$

容易发现的是,$L_i,R_i$ 单调不递增,且 $\max_{i\in [0,n)}\{L_i\}\leq \min_{i\in [0,n)}\{R_i\}$

考虑如果没有 $L_i$ 的限制该怎么做.将 $R$ 从小到大排序,这样答案就是 $\prod_{i\in[0,2n)}R_i-i+1$.(下标从$0$开始)

然后考虑容斥出有下界的合法方案.设钦点 $k$ 个位置不满足下界的答案为 $f_k$ (即钦点这 $k$ 个位置的上界为 $L-1$ ).然后发现只有前面 $n$ 个位置可能不满足下界.

$$ans=\sum_{i=0}^{n}(-1)^i\times f_i$$

考虑怎么 $\texttt{DP}$ 出这个 $f$.

假设现在已经按新的上界为第一关键字,位置**的负数**为第二关键字将所有位置排序(因为考虑 $rank$ 的话相同的值比较麻烦)

$\forall i\in[n,2n)$,排在位置 $i$ 之前的位置有且仅有

- $[n,2n)$ 中按 $R$ 排序后本身就排在 $i$ 之前的位置
- $[0,n)$ 中取上界为 $L-1$ 且排序后排在 $i$ 之前的位置

$\forall i\in[0,n)$,若取 $R$ 为上界,排在位置 $i$ 之前的位置有且仅有

- $[0,n)$ 中取上界为 $R$ 且按 $R$ 排序后本身就排在 $i$ 之前的位置
- $[n,2n)$ 中的所有位置
- $[0,n)$ 中取上界为 $L-1$ 的所有位置

$\forall i\in[0,n)$,若取 $L-1$ 为上界,排在位置 $i$ 之前的位置有且仅有

- $[n,2n)$ 中按 $R$ 排序后本身就排在 $i$ 之前的位置
- $[0,n)$ 中取上界为 $L-1$ 且排序后排在 $i$ 之前的位置

这样,将 $[0,n)$ 中的元素按 $L$ 为第一关键字, $R$ 为第二关键字, $[n,2n)$ 中的元素按 $R$ 为第一关键字, $0$ 为第二关键字排序,从前往后 $\texttt{DP}$.

设 $dp_{i,j}$ 表示 $\texttt{DP}$ 到 $i$ 位置,有 $j$ 个位置取上界为 $L-1$ 的总方案数. $dp_{0,0}=1$.

设 $from_i$ 表示位置 $i$ 的来源,$cnt1_i$ 表示前 $i$ 个位置中 $from\in[n,2n)$ 的个数,$cnt2_i$ 表示前 $i$ 个位置中 $from\in [0,n)$ 的个数,$k$ 表示要求的是有 $k$ 位置取上界为 $L_1$ 的答案

考虑 $dp_{i,j}$ 怎么转移.

## $from_{i}\in[n,2n)$

显然这种时候只能取上界为 $R$

$$dp_{i+1,j}\leftarrow dp_{i,j}\times (R-(cnt1_i+j)+1)$$

## $from_{i}\in[0,n)$

### 取上界为 $L-1$
$$dp_{i+1,j+1}\leftarrow dp_{i,j}\times(L-(cnt1_i+j))$$

### 取上界为 $R$

$$dp_{i+1,j}\leftarrow dp_{i,j}\times (R+1-(n+k+(cnt2_i-j)))$$

[代码](https://www.luogu.com.cn/paste/vxg80rl1)