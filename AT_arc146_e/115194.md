算是自己想出来的（？）

考虑按 $1,2,3,\cdots,n$ 的顺序将这些数加入序列，显然，我们只关心加完所有值 $\le i$ 的数之后，有多少个相邻的数大小都为 $i$，因为如果存在两个相邻相同的 $<i$ 的数那么在后面的步骤中我们肯定无法将这一对数消掉。因此这个序列必然没法变成合法的序列。

思考一下我们每次加入所有值 $=i$ 的数会发生什么。显然我们需要用 $i$ 来填补上一轮相邻的 $i-1$ 之间的空隙，剩下的 $i$ 有两种选择：要么与已有的 $i$ 相邻形成连续段，如果序列的某一侧是 $i-1$，那么我们这个 $i$ 还可以填在 $i-1$ 的边上。比方说如果上一轮是 $3,2,3,3,2,1,2,3,3$，那么下一轮可以变成 $4,3,2,4,3,2,1,2,4,4,4,3,4,4$。

不难发现后一种转移与开头和结尾中有多少个是 $i-1$ 有关（$0/1/2$），因此我们额外记录下这个变量即可，也就是说我们记 $dp_{i,j,k}$ 表示填入了前 $i$ 个数，目前有 $j$ 对 $i$ 相邻，开头和结尾有 $k$ 个数是 $i$ 的方案数。转移插板法算一下即可。朴素 DP 是 $n^2$ 的，不过注意到一个性质：记 $c_i$ 表示插入值 $\le i$ 的数的时候，每一步都不在边上放 $i$，这样会有多少对 $i$ 相邻——显然这是一个定值，那么所有可能的 $j$ 都在 $c_i$ 附近，大概枚举 $[c_i-7,c_i+7]$ 就可以过了。