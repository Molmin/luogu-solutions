提供一种简单的分治做法。

图的直径太难了，记 $dis(i,j)$ 为 $i$ 和 $j$ 的距离，再记 $p(i)=\max_j\{dis(i,j)\}$，那么我们任意找一个点 $x$ 求出 $p(x)$，若真正的直径为 $d$，那么有 $d\le 2p(x)\le 2d$。方便起见我们取 $1$ 就行。

但我们发现题目要求甚至更松，于是我们再砍个 $\frac{1}{2}$。首先，$p(1)$ 在不断操作后显然是单调变小的。可以想到，我们求出 $i$ 次操作后的 $p(1)$，记其为 $p_i$，同理定义 $p_j$，那么如果 $p_i\le 2p_j$，那么我们不妨用 $p_i$ 替代 $p_j$。

根据上述思路我们可以考虑分治。首先记 $l=0,r=q$，然后求出 $p_l$ 和 $p_r$，在记 $mid=\lfloor\frac{l+r}{2}\rfloor$，求出 $p_{mid}$。查看左右区间，如果有一个区间全部可以用 $p_l$ 或者 $p_{mid}$ 替代了，就不分治它，否则分治下去。

然后就做完了撒花撒花。