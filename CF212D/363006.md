## 前提一笔

> 这道题是多么的美好啊！优雅而不失自然。  ——XXX


这道题耗费了本人大量的时间，写作不易，~~请一键三连~~。

## 题意

给你一个长度为 $n$ 的序列 $a$，每次询问给出一个 $k$，求这个序列所有长度为 $k$ 的子串内的最小值的平均值。

## 思路

这道题目肯定会有人想直接用数据结构解决这些问题，但是明显不可行。

看着题意很复杂，但是我们可以把它化简成两个问题：

- 所有长度为 $k$ 的子串个数。

- 所有长度为 $k$ 的子串中最小值之和。

显然第一个问题的答案就是 $n - k + 1$，我们把注意力放在第二个问题。

我们这么想，如果没有 $k$ 的限制，变成所有子串的最小值之和，我们该怎么办？

这是一个经典的问题，考虑每一个数对答案的贡献，我们设 $L_i$ 为 $1 \sim i - 1$ 内**从右往左**数第一个**小于等于** $a_i$ 的数的下标，如果不存在则为 $0$，$R_i$ 为 $i + 1 \sim n$ 内**从左往右**数第一个**小于** $a_i$ 的下标，如果没有则为 $n + 1$。

现在答案就显然了，区间要包含 $i$ 的话，那么答案的贡献即是 $(i - L_i) \times (R_i - i)$，就是 $i$ 左边的比它大的数以及 $i$ 跟 $i$ 右边比它大的数以及 $i$ 两两配对成一段区间，所有的区间内最小值一定为 $a_i$。

那么我们再回到原问题，原问题要求上述所配对的区间长度必须为 $k$，那么就相当于给配对的区间加上了一个长度的限制，我们考虑怎么做。

**请注意**：在解题过程中，我们保证所有的 $L_i$ 和 $R_i$ 满足 $(i - L_i) < (R_i - i)$。

我们分成三种情况考虑（这种问题常见的方法之一就是分类讨论）：

1. $k < (i - L_i)$，即在长度为 $k$ 的配对区间中，左端点碰不到 $L_i$，右端点碰不到 $R_i$。

2. $(i - L_i) \le k < (R_i - i)$，即在长度为 $k$ 的配对区间中，左端点可以为 $L_i$，但右端点碰不到 $R_i$。

3. $(R_i - i) \le k$，即在长度为 $k$ 的配对区间中，左端点可以为 $L_i$，右端点可以为 $R_i$。

接着看个图：

![](https://cdn.luogu.com.cn/upload/image_hosting/mltp84dw.png)

横轴代表在变化的 $k$，而纵轴表示的是在 $k$ 变化过程中，配对区间的变化过程。

可以看出，$a_i$ 对答案的贡献分为三个段，也对应三种情况，第一个段是一个形如 $1, 2 ... (i - L_i)$ 的等差数列（指配对区间个数），而第二段则是形如 $(i - L_i) ... (i - L_i)$，第三段形如 $(R_i - i - 1) ... 1$。对答案的贡献显然可以用二维差分解决。

而上面的 $L_i$ 和 $R_i$ 则可以用二分加 ST 表解决。

总时间复杂度 $O(n \log_2 n)$。