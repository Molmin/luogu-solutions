$\quad\rm ExKMP+$前缀和优化 $\rm DP$。

$\quad$记 $f_i$ 表示 $a_{1\sim i}$ 有多少种合法的划分方案，显然有一个 $\Theta(n^2)$ 的暴力 $\rm DP$，即往前枚举转移点 $j$，判断转移是否合法后累加即可。

$\quad$观察到合法的转移点是一段连续的区间，若令 $len_l$ 和 $len_r$ 分别表示两限制字符串的长度，显然对于满足 $len_l<i-j<len_r$ 的转移点 $j$，这个转移都是合法的，现在的问题在于判断当 $j=i-len_l$ 或 $j=i-len_r$ 的时候转移是否合法。

$\quad$考虑用 $\rm ExKMP$ 对任意一个 $i$， 求 $\rm LCP(s_{i\sim n},l)$ 和 $\rm LCP(s_{i\sim n},r)$，这样就可以快速求出 $s_{i-len_l+1\sim i}$ 与 $l$ 的最长公共前缀 $zl_{i-len_l+1}$，并通过比较 $s_{i-len_l+1+z_{i-len_l+1}}$ 与 $l_{z_{i-len_l+1}+1}$ 的大小判断当 $j=i-len_l$ 时转移是否合法，同理，当 $j=i-len_r$ 时转移是否合法也可以通过相同方式判断。

$\quad$这样，合法转移点的区间就在 $\Theta(1)$ 的时间内求出来了，剩下的用前缀和记录一下即可。需要注意的是，由于不能出现前导零，所以当转移点的后一位为 '$0$' 时不能将其加入前缀和数组。

$\quad$总时间复杂度 $\Theta(n)$.