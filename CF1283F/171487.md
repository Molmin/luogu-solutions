考虑每次选的点，必然包含了没选的点中最大的那个。

并且它的父节点已经被选了。

根节点显然是 $a_1$。

那么你考虑依次加点。

如果当前点是

- 新出现的点，且不等于最大值，那么最大值仍然在它的子树中，从而它是上一个点的子节点。

- 新出现的点，且等于最大值，那么它是上一个点的子节点，同时更新剩下的最大值，这个新的最大值在其子树内。

- 出现过的点。这说明最大值是上一个点的子节点，新的最大值在新的节点的子树内。

按照这个东西模拟即可。

[code link](https://codeforces.com/contest/1283/submission/135730730)