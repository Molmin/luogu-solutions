写在前面：感谢 SyadouHayami 对我的一些指导与帮助。本题解主要是对 SyadouHayami 题解的一些补充与说明。

首先构造一个概率 $p_i$：最终点亮了 $i$ 盏灯后流程结束的概率。这样便于我们去计算最后的期望：

$$E=\sum_{i=1}^{n} ip_i $$

但是这个概率并不好计算：因为 $p_i$ 并没有与灯的组合联系起来，并且很难找到递推式，因而我们考虑改造一下这个式子。

构造 $\displaystyle s_i=\sum_{j=i}^{n} p_j$， 这样$\displaystyle E=\sum_{i=1}^{n} s_i$。此处为数学上的变形，可以使用后缀和去理解。

考虑 $s_i$ 的实际意义：合法放置 $i-1$ 盏灯的概率。由定义，$s_i$ 为从 $i$ 到 $n$ 的 $p_j$ 概率和，它代表了所有的放置了大于等于 $i$ 盏灯的概率。但是它不一定放置了符合要求的 $i$ 盏灯——我们只能保证它成功执行了第 $i-1$ 步，而不能保证第 $i$ 步被成功执行，因而它代表了成功执行 $i-1$ 步的概率，也就是成功放置了 $i-1$ 盏灯的概率。后面任意步（如第 $j$ 步，满足 $j \geq i$）失败了无法继续都可以在 $s_i$ 中找到对应的概率—— $p_{j-1}$。

这样这个概率就简化成为了单个、无需转移的状态并且是一个古典概型。

考虑这个古典概型。显然所有的方案总数为 $\dbinom {n}{i-1}$—— $n$ 个灯里选取 $i-1$ 个灯亮。再考虑合法的方案总数。此处有三个理解：

1. 考虑先将状态转化成合法的再计算方案数。我们先把 $i-1$ 盏亮的灯放在一起，然后向点亮的灯中间的 $i-2$ 个空隙每个插入 $k-1$ 盏不亮的灯。这样就有 $(i-2)(k-1)+(i-1)$ 盏已经被安排好的亮与不亮的灯，而且这个方案一定合法。接下来，把剩余的 $j=n-[(i-2)(k-1)+(i-1)]$ 盏不亮的灯插入到 $i-1$ 盏亮的灯构成的 $i$ 个空隙中。问题抽象化为 $j$ 个相同的球放入 $i$ 个不同的箱子中，每个箱子允许空放，问方案总数。这是一个隔板法的经典题：先预支 $i+1$ 个球，用作每个箱子的打底；再用正常的隔板法求出每个箱子至少一个球的方案总数，再将每个箱子预支的 $1$ 个球收回。因而方案总数为 $\dbinom {i+j-1}{i-1}=\dbinom {n-(i-2)(k-1)}{i-1}$。

2. （SyadouHayami 题解的做法，只是大概理解）考虑放完灯之后空位分布。为了保证方案合法，可以放亮的灯的地方并不是 $n$，而是 $n-(i-2)(k-1)$——要保证相距至少为 $k-1$。因而最后的方案数就是在这些合法放灯的位置随机选取 $i-1$ 个—— $\dbinom {n-(i-2)(k-1)}{i-1}$。

3. 地道的插板法：同方法 1 一样将 $i-1$ 个亮着的灯摆在一起。问题转化为剩余不亮的 $n-(i-1)$ 盏灯插入到亮着的 $i-1$ 盏灯构成的 $i$ 个空隙中，即 $n-(i-1)$ 个相同的球放入 $i$ 个不同的箱子中，但是对于首尾两个箱子，可以空放；中间的 $i-2$ 个箱子，必须放置 $k-1$ 个球。提前满足要求——对于首尾两个箱子，各预支一个球用于满足要求；中间的 $i-2$ 个箱子，提前各放置 $k-2$ 个球，使得每个箱子至少都有 $1$ 个球，这样才符合插板法的要求。因而总球数变为 $n-(k-2)(i-2)+2$，使用插板法可得方案总数为 $\dbinom {n-(i-2)(k-1)}{i-1}$。

因而 $\displaystyle s_i=\frac{\dbinom {n-(i-2)(k-1)}{i-1}}{\dbinom {n}{i-1}}$。然后就可以使用逆元求解，代码可以见 SyadouHayami 的题解。