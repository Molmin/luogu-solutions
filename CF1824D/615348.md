赛后发现没开 `long long`，痛失一千多分，呜呜呜。

先把询问差分。

我们定义 $f(l, r, x) = \sum_{i =l}^r \sum_{j=1}^y g(i, j)$。

我们先考虑对于同一个 $r$，如何快速计算 $\sum_{l=x}^y g(l, r)$，我们考虑扫描线，每次把当前位置戳成 $1$，把上一个和该元素相同的位置戳成 $0$，然后 $g(i, r)$ 就等于 $i$ 及以后第一个 $1$ 的位置，于是问题变为区间覆盖区间和。

当然你可以记 $dis_i$ 等于 $i$ 下一个 $1$ 的位置减去 $i$，这样就变为了区间加区间和。

然后我们发现求解 $f$ 变为了前 $x$ 个版本中的区间和，可以直接拉一个历史版本和线段树。

这样是不会很卡常的：）。