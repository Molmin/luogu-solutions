温馨提示：建议做出来之前不要看题解，不然没意思。

如果不会，提示：

- 一定可以使所有 portal 都 good。

如果还不会，提示：

- 解唯一。

---

我们构造性地证明，一定可以使所有 portal 都 good。

按照 $s$ 从小到大考虑每一个 portal，对于每个 portal $(i,j)$ 的每个入口 $(i,j,dir)$，维护 $sum_{i,j,dir}$ 表示当前处理过的、已经射到 $(i,j,dir)$ 这个入口的 laser 的能量值和，$num_{i,j,dir}$ 表示这样的 laser 的数量。

因为是按照 $s$ 从小到大考虑，所以考虑到 $(i,j)$ 时，它消耗的 energy 就是 $S=\sum_{dir}num_{i,j,dir}\times s_{i,j}-sum_{i,j,dir}$。因为按照 $s$ 从小到大考虑，所以从此以后它都不会消耗 energy 了！

所以我们令 $ans_{i,j}=S\bmod 2$，然后根据题目描述用并查集维护哪些 $num,sum$ 变化了，继续处理。

如果不理解，可以阅读代码：https://codeforces.com/contest/1740/submission/178657715

你可能会想，这题怎么赛时只有不到 20 个人过？然而我感觉这题其实并不简单，因为干扰太多了，很多看似奇怪的条件是没用的，而你很难坚定地把它们剔除。