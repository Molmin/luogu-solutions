注意到：一颗弹珠一旦经过某个格子，之后的能量值就会一直大于等于该格子的能量值；如果一颗弹珠经过某个能量值不超过它的格子，那么不会对该格子的能量值产生影响。这意味着，我们可以按格子的能量值从小到大依次设定每个格子的类型，能量大的格子设定什么类型是不会影响能量小的格子所收到的能量的。

我们按能量值从小到大依次枚举每个格子，每次需要计算出进入这个格子能量（的奇偶性）来决定这个格子的类型。为此，我们需要维护门之间相连形成的有向图，注意到该图应当由若干链 / 环组成，而且形成环的门就不会影响之后的格子了，因而我们只需要维护每条链的起点 / 终点，以及从这条链两端射出的能量（的奇偶性）即可。合并两条链可以用并查集的数据结构辅助。时间复杂度 $O(nm\alpha(nm))$（不计排序）。