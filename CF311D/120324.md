每次把一段区间的指数乘 $3$。$p$ 是素数，指数可以对 $\varphi(p)=p-1$ 取膜。取膜之后，有长度为 $48$ 的循环节。

于是可以用分块进行维护。具体地，对每块求出整块操作 $k \in [0, 48)$ 次之后整块的和，散块操作时暴力重构。取块长为 $T$，则有 $48T=n/T$，平衡得到 $T=\sqrt{n/48}$ 时最优。