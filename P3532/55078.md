好题。

首先我们只能考虑基于值域处理。

然后因为计算 $f(i,\ j)$ 的时候 $i$ 和 $j$ 是相互影响的我们无法直接操作他。

于是推得 $f(i,\ j) = \dfrac{d(i) \cdot d(j)}{d(\gcd(i,\ j)^2)}$。其中定义 $d(i)$ 为 $i$ 和 $1$ 的距离。容易预处理出来 $d$。

然后考虑枚举 $\gcd$。再枚举 $\gcd$ 的倍数计算。

我们再处理出每一个数的倍数中，出现在数列中的数的 $d$ 的最小值及其位置。就可以非常方便地计算了。

注意到一个细节就是倍数不一定符合 $\gcd$ 的条件。

但其实这里不影响，因为如果不符合 $\gcd$ 的话就一定是 $\gcd$ 的因数。只会使答案更小而不会影响。

如果有人会这题最小改为最大的做法可以私信教我一下 /kk。