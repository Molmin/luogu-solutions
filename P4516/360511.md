[同步发表于我的 $\text{cnblogs}$](https://www.cnblogs.com/UperFicial/p/16657044.html)。

[传送门](https://www.luogu.com.cn/problem/P4516)。

考虑这个树形 DP 状态的设计，题目涉及的所有量都放进状态中。

设 $f_{i,j,0/1,0/1}$ 表示，以 $i$ 为根的子树中，除 $i$ 节点都被监听了，一共放置了 $j$ 个监听设备，$i$ 点是否放置了监听设备，$i$ 是否被监听（`0` 表示没有，`1` 表示有）的方案数。

考虑转移，设 $v$ 的父节点为 $u$：

- $f_{u,i+j,0,0}$ 的转移：
- 
  - $u$ 没有被监听，说明 $u$ 的儿子都没有放置监听设备。
   
  - 用树形背包来转移，即每访问完一个节点，就用当前状态与当前子树一一配对。
   
  - 枚举 $v$ 用的监听器数量 $j$，则 $f_{i,i+j,0,0}\leftarrow f_{u,i+j,0,0}+f_{u,i,0,0}\times f_{v,j,0,1}$。
   
  - 注意，这里的 $f_{u,i,0,0}$ 表示的是，$v$ 子树之前的那些子树对 $u$ 造成的贡献，实际操作中，我们可以另用一个数组表示。
   
- $f_{u,i+j,0,1}$ 的转移：
 
  - $u$ 没放置设备，但是被监听了。我们不知道它被父亲监听，还是被孩子监听，所以分两种情况讨论。
  
    - 如果 $u$ 被除 $v$ 以外的节点监听，$v$ 放不放置监听器就不重要了。所以我们得到 $f_{u,i+j,0,1}\leftarrow f_{u,i+j,0,1}+f_{u,i,0,1}\times \left(f_{v,j,0,1}+f_{v,j,1,1}\right)$。
     
    - 如果 $u$ 只被 $v$ 监听，那么 $v$ 只能放置监听器，$f_{u,i+j,0,1}\leftarrow f_{u,i+j,0,1}+f_{u,i,0,0}\times f_{v,j,1,1}$。注意，是从 $f_{u,i,0,0}$ 转移而来，因为我们刚刚提到过，$u$ 单独被 $v$ 监听，若还有其余的，会与第一种情况算重。
     
- $f_{u,i+j,1,0}$ 的转移：
 
    - $u$ 放置了监听器，但是没有被监听。这个条件也是十分好做的；
     
    - $u$ 没有被监听，说明 $v$ 没有放置监听设备。

    - $u$ 放置了监听器，说明在 $v$ 这个子树中，$v$ 是否被监听到是无所谓的，因为总会有 $u$ 监听 $v$。
     
    - 转移很明了：$f_{u,i+j,1,0}\leftarrow f_{u,i+j,1,0}+f_{u,i,1,0}\times \left(f_{v,j,0,0}+f_{v,j,0,1}\right)$。

- $f_{u,i+j,1,1}$ 的转移：

    - $u$ 被监听，根第二种情况一样，我们分两种情况讨论，是被儿子监听，还是被父亲监听。

      - 如果 $u$ 是被 $v$ 监听，$v$ 是否被监听是无所谓的，因为 $u$ 点放置了监听器，同时 $v$ 必须放置监听器。$f_{u,i+j,1,1}\leftarrow f_{u,i+j,1,1}+f_{u,i,1,0}\times \left(f_{v,j,1,0}+f_{v,j,1,1}\right)$。
      
      - 如果 $u$ 是被父亲监听，那么 $v$ 是否被监听是无所谓的，是否放置监听器也是无所谓的，开摆即可。$f_{u,i+j,1,1}\leftarrow f_{u,i+j,1,1}+f_{u,i,1,1}\times f_{v,j,0/1,0/1}$。

细节主要就是用一个数组保存除了 $v$ 子树的前面的子树的 DP 值。

考虑它的复杂度，性感证明即为考虑 $\text{siz}>k$ 的点不会超过 $\dfrac{n}{k}$ 个，总复杂度约为 $\Theta(nk)$。

[代码](https://www.luogu.com.cn/paste/r2du3bte)。