考虑给每个连通块钦定一个“代表元”，转化为计数合法的代表元.

我们有以下结论：若树上三个结点 $x,y,z$ 满足 $\Delta_x\leq\Delta_y\leq\Delta_z$，那么 $\delta(x,y)\leq\max\{\delta(x,z),\delta(y,z)\}$(其中 $\Delta$ 表示深度、$\delta$ 表示距离).

考虑 $x,y,z$ 三个结点构成虚树的直径，设 $\theta_u$ 表示距离 $u$ 结点最远的结点(之一)，我们有：对于 $\forall_u$ 而言，$\theta_u\sim\theta_{\theta_u}$ 是树的一条直径.

对树根 $\text{Rt}$ 应用该结论，得到：对于具有最大深度的结点 $u$，$u\sim\theta_u$ 是树的一条直径；在虚树上，即 $x\sim z$ 和 $y\sim z$ 之一是虚树的直径(其两端点均必不为虚点)，于是得证.

求出原树的 $\text{Bfs}$ 序 $\tau$，根据结论，可以钦定连通块中 $\tau$ 值最小的结点为代表元.

显然，$u$ 是代表元当且仅当 $u$ 不和 $\tau$ 值更小的结点连通；应用上述结论，我们加强该论述：当且仅当 $u$ 的 $k$(即原题中的 $C$)邻域内，不存在 $\tau$ 值更小的结点.

这是因为，$u$ 要想走到 $i$，不可能只能通过绕往 $\tau$ 值更大的结点；考虑绕路的过程中，$\tau$ 值的局部最大值，则应用刚才的结论，绕的这一步是毫无必要的，归纳即可得到.

考虑对于每个结点 $u$ 求出 $\alpha_u$ 和 $\beta_u$，即 $u$ 的 $k$ 邻域内 $\tau_v<\tau_u$ 的结点 $v$ 中，最大的 $v<u$ 以及最小的 $v>u$；则只有当保留结点区间 $[l,r]\subseteq(\alpha_u,\beta_u)$ 时，$u$ 才能够是合法的代表元.

审视结点 $v$ 的条件：$\delta(u,v)\leq k$ 和 $\tau_v<\tau_u$，考虑用点分治处理掉 $\delta(u,v)\leq k$ 条件.

分治时转化为 $\Delta_u+\Delta_v\leq k$，考虑将所有结点按照 $\Delta$ 排序(可以直接 $\text{Bfs}$)，倒着扫描一遍，双指针维护满足 $\Delta_v\leq k-\Delta_u$ 的一段前缀，每次将新的合法的 $v$ 加入数据结构中.

该数据结构是以结点编号为下标的线段树，其中的结点维护该区间中 $\tau$ 值的最小值，查询最大的 $v<u$ 时，直接在线段树二分出满足 $\tau_v<\tau_u$ 的最大结点 $v$ 即可.

注意这里的点分治并不需要区分子树，因为同子树只会使得距离被计算小了，不会往大了计算；在递归到下一层点分治之前，需要将线段树中的残留信息全部回退掉.

在得出所有 $\alpha_u,\beta_u$ 以后，直接二维数点即可：询问 $[l,r]$ 统计满足 $\alpha_u<l\leq u\leq r<\beta_u$ 的结点 $u$，则结点 $u$ 的贡献是矩形 $(\alpha_u,u];[u,\beta_u)$；将询问都离线下来，用扫描线配合树状数组计算即可.

该算法的时间复杂度为 $\mathcal{O}(n\log^2 n+q\log n)$，空间复杂度为 $\mathcal{O}(n+q)$.

代码实现(具有极其严重的个人风格)：https://www.luogu.com.cn/paste/zpesm5lt.