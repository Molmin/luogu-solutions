首先进行一些显然的转化：

- 当 $S_i\cap T_i=\varnothing$ 时，这个 $S_i$ 没用，可以忽略；
- 当 $|S_i\cap T_i|=1$ 时，这个 $S_i$ 一定是选 $S_i\cap T_i$ 更优，转化为 $|S_i|=1$ 的情形。
- $|S_i\cap T_i|=2$，这意味着 $S_i=T_i$。

对每个 $T_{i,0},T_{i,1}$ 连边（这里我们认为 $|T_i|=1$ 时令 $T_{i,1}=T_{i,0}$）得到一张 $n$ 点 $n$ 边的无向图。现在相当于把每条边定向，使得每个点的入度不超过 $1$；$S_i$ 则表示某条边如果定成某个方向会有若干的代价，$|S_i|=2$ 的则代表 Alice 可以自由选择代价的方向。

考虑每个连通块，如果边数小于点数则无解，否则一定是树或者基环树；对于基环树，环上点有两种定向方案，环外点必然是形成基环外向树，已经唯一确定。对于环内点，若 Alice 可以自由选择 $C$ 次，目前全部指左和指右已有的代价分别为 $A,B$，那么 Alice 就是要把 $C$ 分配给 $A,B$，让 $\min(A,B)$ 最大。简单分讨一下即可；对于环外点，由于每个点的 Bob 的方案唯一，Alice 很容易做出选择。

对于树，Bob 有 $n$ 种选择方案（让某个点为根得到一棵外向树）。考虑设 $w_i$ 表示点 $i$ 为根的答案，那么对于 Alice 的每条可以自由选择的边 $(u,v)$，不妨设 $u=fa_v$，那么 Alice 可以选择在 $v$ 子树内 $w_i$ 全都 $+1$（即定向为 $v\to u$），或者是 $v$ 子树外的 $w_i$ 全都 $+1$（即定向为 $u\to v$），要求最大化 $w$ 的最小值。

~~然后我场上写到这里就不会了orz~~

考虑 Alice 的两条边 $(a,b),(c,d)$，不妨设 $a=fa_b,c=fa_d$，若 $b,d$ 不互为祖孙关系则不可能两条边分别定向为 $b\to a,d\to c$（否则定向为 $a\to b,c\to d$ 一定更优）；若 $b$ 是 $d$ 的祖先则不可能两条边分别定向为 $a\to b,d\to c$（否则反过来更优）。总之，我们发现一定不可能有两条边是“互相面对面”的。

这也就是说，所有由儿子指向父亲即对子树内贡献的边一定都存在于根到某个点的路径上，并且一定是根到这个点路径上的所有可选边。称这个点为**关键点**。套路地先做 DFS 求出 DFS 序转为区间加全局 min，先令每条可选边均指向儿子，再做一遍 DFS，每次经过一条可选边 $u\to v$ 的时候就把 $(u,v)$ 的方向反向，回来的时候再反向回去，就能处理出以每个点为关键点时的线段树形态。时间复杂度 $O(n\log n)$。

[AC Code](https://www.luogu.com.cn/paste/15nu8x6q)