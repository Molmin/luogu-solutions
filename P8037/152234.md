不妨设左小右大，然后反着扫一遍。

扫描线。对于每个右端点，它的每一个合法左端点都应该是后缀最小值，这形成一个单调栈。而单调栈中只有一个后缀能成为合法左端点，因为还要求右端点是区间最大值。

注意到一个点如果被弹出栈了，我们只需把它作为左端点的最长区间放入线段树即可，因为它再也不可能称为合法左端点了。对于栈中的元素我们则要维护其最远右端点，而由于每次更新一个后缀，于是也可以线段树维护。

查询分为两部分，对于不在栈中的只需线段树查询，对于在栈中的也是后缀查询，只是我们需要在线段树中多维护一个区间长度最大值即可。

时间复杂度线性对数。代码没什么细节，不放了（没写）。