考虑钦定一些位置进位，设 $f(x)$ 表示第 $x$ 位是否被钦定进位。除去进位的影响，每一位的决策显然是独立的。

- 若 $f(x) = 1$ 且 $f(x - 1) = 1$，则 $a_x$ 和 $b_x$ 不能同时为 $0$，有 $3$ 种方案。
- 若 $f(x) = 1$ 且 $f(x - 1) = 0$，则 $a_x$ 和 $b_x$ 必须同时为 $1$，有 $1$ 种方案。
- 若 $f(x) = 0$ 且 $f(x - 1) = 1$，则 $a_x$ 和 $b_x$ 必须同时为 $0$，有 $1$ 种方案。
- 若 $f(x) = 0$ 且 $f(x - 1) = 0$，则 $a_x$ 和 $b_x$ 不能同时为 $1$，有 $3$ 种方案。

我们发现对于一个极长进位段 **连带着它前面一位**，对方案数的贡献为 $3 ^ {\mathrm{length} - 2}$。也就是说，本来方案数为 $3 ^ n$，但每个极长进位段会让方案数的指数减小 $2$，除了顶到最高位的进位段只会让方案数的指数减小 $1$。

考虑枚举进位段数 $i\in [1, k]$ 且最高位是否进位。首先有将 $k$ 个进位位分成 $i$ 段的方案数 $\dbinom {k - 1} {i - 1}$。

- 若进位，则剩余 $r = n - k + i + 1$ 个自由位，需要插到 $i$ 个空隙当中（最高位之前不能插），方案数为 $3 ^ {n - 2i + 1} \dbinom {r + i - 1} {i - 1}$。
- 若不进位，则剩余 $r = n - k + i$ 个自由位，需要插到 $i + 1$ 个空隙当中，方案数为 $3 ^ {n - 2i} \dbinom {r + i} i$。

时间复杂度 $\mathcal{O}(n)$，注意特判 $k = 0$ 的情况。[代码](https://codeforces.com/contest/1761/submission/183450884)。