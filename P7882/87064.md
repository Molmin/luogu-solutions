自带大常数，呜呜呜呜呜。

## Description

[传送门](https://www.luogu.com.cn/problem/P7882)

## Solution

令 $f(l,r)$ 为 $a[l,r]$ 的绝对众数。特别的，若绝对众数不存在，则 $f(l,r)=0$。问题即为，每次查询 $[l,r]$ 各子区间的 $f$ 之和。

考虑根号分治，令阈值为 $D$。

若 $v$ 在 $a$ 中出现次数 $cnt_v \le D$，则 $\forall f(l,r)=v$，满足 $[l,r]$ 的长度 $\le 2D-1$。而这样的 $[l,r]$ 只有 $O(nD)$ 个，可以暴力枚举。考虑离线下来对 $l$ 从大到小扫描线，则会进行 $O(nD)$ 次单点修改，$O(n)$ 次前缀和查询。使用根号平衡即可。

若 $v$ 在 $a$ 中出现次数 $cnt_v>D$，则这样的 $v$ 只有 $O(\frac n D)$ 个。对于每个这样的 $v$，令 $s_i=\sum_{j=1}^i [a_j=v] - \sum_{j=1}^i [a_j \neq v]$，则问题等价于区间正序对数，莫队二次离线即可。然而复杂度含 $O(n \sqrt m)$，要跑 $O(\frac n D)$ 次，无法接受。

首先一个观察是，$s$ 中相邻元素之差的绝对值为 $1$。这样一来，我们不需莫队二次离线，只需维护桶、两端点的当前贡献，端点伸缩的影响可 $O(1)$ 计算。

接着发现，存在较多位置 $p$，不存在任何包含 $p$ 的区间使其 $f=v$。删去这样的 $p$ 后，新序列断成了若干段区间，而各区间的长度之和关于 $cnt_v$ 线性。对各区间分开处理即可。

对于单个 $v$，时间复杂度 $O(m+\sum len_i \sqrt m)$，其中 $len_i$ 表示断成的第 $i$ 段区间长度。那么，本部分总复杂度为 $O(\frac {mn} {D} + n \sqrt m)$。

总复杂度 $O(nD+\frac {nm} {D}+n \sqrt m+m \sqrt n)$，取 $D=\sqrt {m}$ 即可做到 $O(n \sqrt m+m \sqrt n)$。

----

一些常数优化：

- 对根号平衡而言，整块部分可从 $L$ 所在的块开始枚举，其中 $L$ 表示当前扫描线位于的点。
- 对段长而非出现次数进行根号平衡，可以得到相同的复杂度，但常数更小。