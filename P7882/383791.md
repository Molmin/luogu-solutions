挺难的一道题，暴力莫队竟然一分不给。。。

# Solution

认真阅读一下式子应该就能很好的理解题意。本来是计算子段个数，但是它乘了个 $c$，于是就要对每种颜色分别讨论，或者用一个方便的求和工具和一种美妙的转化方法去做。显然不能使用后者~~不信你试~~，因为他至少是一个六维的东西：询问的 $l,r$，子段的 $L,R$，还要颜色和其数量 $col,cnt$。于是就只能用前者，或者阈值分治后在小范围内用后者（~~埋伏笔~~）。

考虑由于我们要将颜色分类讨论，而且符合条件的子段中当前颜色 $x$ 的数量一定大于其他颜色的数量，所以我们将 $x$ 设为 $1$，其他的设为 $-1$，这样就是求区间中和大于 $0$ 的子段数，即前缀和的顺序对数，这里可以用普通莫队实现（~~当然你可以二离~~），由于只有 $1,-1$，所以左右端点移动时值的增减只有 $1,-1$，于是维护两端的数和区间中的数产生的顺序对数就很容易，比如：我们将 $r←r+1$，若 $a_{r+1}=x$，则 $a_{r+1}=a_r+1$，所以产生的顺序对数就增加了区间中等于 $a_r$ 的元素个数，这东西很好实现（~~不然就是你没打过莫队~~），其他的同理。~~肯定没有这么简单~~，注意到每个数都跑一遍的话那总复杂度是 $O(SIZE\times(n\sqrt m+m\sqrt n))$，$SIZE$ 是值域，显然爆掉。

考虑到数的总量为 $n$，所以对每个数要缩小范围，使得总的处理区间在 $O(n)$ 以内。考虑极端情况下，$x$ 只出现一次，那跑整个序列的莫队就显得很没有意义，所以我们将每个数符合条件的区间的并求出来，然后对这东西跑莫队。如果就这个优化，那每个区间的复杂度为 $O(n_i\sqrt m+m\sqrt n_i)$，由于有这个优化 $\sum n_i=O(n)$，则总复杂度是 $O(n\sqrt m+m\sum\sqrt n_i)$，后者还是爆了······所以我们还要优化。可以发现 $\sum\sqrt n_i$ 中有很多范围很小的区间，对这种区间跑莫队是很浪费时间的，所以考虑阈值分治，令阈值为 $T$，由于 $\sum[n_i>T]=O(\frac{n}{T})$，所以上面的复杂度上界就是 $O(n\sqrt m+mT)$，对于 $n_i<T$，我们可以考虑开头埋下的伏笔，即暴力转化。对于询问的 $l,r$ 我们可以离线处理，对于子段的 $L,R$，我们可以暴力处理，然后 $col,cnt$ 由于暴力处理了就只剩 $col$ 了，我们可以用一个 $O(1)-O(\sqrt n)$ 的分块处理，注意到暴力的复杂度是 $n\sum n_i^2$，由于这里 $n_i\le T$，所以当所有 $n_i=T$ 是取最大复杂度，此时总数量是 $O(\frac{n}{T})$ 的，所以复杂度是 $O(\frac{n^2}{T})$。

综上，总复杂度是 $O(n\sqrt m+mT+\frac{n^2}{T})$，由于 $n,m$ 同阶，所以当 $T=\sqrt n$ 时取最小值 $O(n\sqrt n)$。

记得根据常数合理调整阈值。