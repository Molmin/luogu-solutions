前两天还在看 psj 的论文，但是这场比赛时在考 TACA，于是只能回家后看题然后发现是板子（

这道题里只用到了棋盘多项式理论里很少的一部分。

第一点就是在 $n \times n$ 方格棋盘中放入 $m$ 个车使它们互不攻击的方案数为 $\binom{n}{m}^2m!$，即 $n \times n$ 棋盘的多项式为

$$f(S)=\sum_{m=0}^{n}\binom{n}{m}^2m!x^m$$

第二点就是两个不存在重复行或重复列的棋盘之并的多项式等于它们的多项式之积，即若 $\forall (x_1,y_1) \in S_1,(x_2,y_2) \in S_2$ 有 $x_1 \neq x_2,y_1 \neq y_2$，则 $f(S_1 \cup S_2)=f(S_1)f(S_2)$。

为了解决此题，我们考虑将「大罪司教」转化成车。先画个图。

![6](https://cdn.luogu.com.cn/upload/image_hosting/d25zwal7.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

![7](https://cdn.luogu.com.cn/upload/image_hosting/fvtuonih.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

以上是 $6 \times 6$ 和 $7 \times 7$ 的情况。其中同样颜色的线代表同一个「大罪司教」能掌控的位置。

显然有 $n$ 为奇数时同样颜色沿副对角线方向（左上到右下，下同）的线上的 $n$ 个格子对应分别在 $n$ 种不同颜色的沿主对角线方向（右上到左下，下同）的线上。所以我们可以直接将其转化为 $n \times n$ 的棋盘。那么答案为

$$\binom{n}{m}^2m!$$

显然可以 $O(m)$ 计算。

又 $n$ 为偶数时同样颜色沿副对角线方向的线上的 $n$ 个格子对应在 $\frac{n}{2}$ 种不同颜色的沿主对角线方向的线上，每种颜色上各两个。我们对其从上到下编号为 $1$ 到 $n$ 后，则编号为奇数的沿副对角线方向的线只与编号为偶数的沿主对角线方向的线有交点且两两恰有两个交点，反之亦然。

则显然这等价于在棋盘 $S=\{(x,y) : 1 \le x,y \le n,2 \not| x+y\}$ 中放入 $m$ 个车使它们互不攻击，每一个格有两种放置方法。

我们把它拆成奇行偶列和偶行奇列两个棋盘，显然它们都等价于一个 $\frac{n}{2} \times \frac{n}{2}$ 的棋盘。因此答案就是

$$2^m\sum_{i=0}^{m}\binom{\frac{n}{2}}{k}^2k! \times \binom{\frac{n}{2}}{m-k}^2(m-k)!$$

显然可以预处理，$O(m)$ 计算。