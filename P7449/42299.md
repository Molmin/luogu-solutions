### 题意简述

这是一题提交答案题。

在二维平面上，找到一条长度最小的环形路径，使得它覆盖给出的 $n$ 条有向线段。可以分多次走一条线段。

相关 NPC 问题：[Travelling salesman problem](https://en.wikipedia.org/wiki/Travelling_salesman_problem)

### 测试点 $1, 2$

- 所有有向线段构成一个环。
- 测试点 $1: n = 15$，环按照输入顺序给出。
- 测试点 $2: n = 50$。

任取一条线段的起点为当前点。每次选择一条以当前点为起点且未经过的线段，经过该线段，并将当前点改为该线段的终点。重复 $n$ 次即遍历了所有线段。

注意：以一个点为起点的线段可能有多条。例如环 $A \to B \to A \to C \to A$ 中以 $A$ 出发的线段有两条。所以在实现时不能直接用 `map`，应该使用 `multimap` 或者 `vector` 等可重数据结构。

因为数据规模较小，也可以手工完成排序。

### 测试点 $3, 4, 5$

- 所有有向线段随机分布，且长度不超过 $\sqrt{2}$。
- 测试点 $3: n = 8$。
- 测试点 $4: n = 16$。
- 测试点 $5: n = 100$。

将有向线段视作点，这个问题即经典的 NPC 问题 — TSP 问题。

比较容易实现的随机算法是枚举一个排列，然后爬山 + 2-opt。其中爬山指的是调整后取较优的排列；2-opt 指的是调整的方法，即随机取一个区间，并且反转这个区间。

注意到 std 写的 TSP 不优秀。即使随机次数不多，也很容易能通过所有测试点。

### 测试点 $8, 9, 10$

- 所有有向线段形成若干个“团”。
- 每个“团”中有 $200$ 条有向线段。
- 测试点 $8$：“团”的数量为 $8$。
- 测试点 $9$：“团”的数量为 $16$。
- 测试点 $10$：“团”的数量为 $100$。

**测试点 $10$**

使用测试点 $5$ 的方法求出遍历“团”的最优顺序，并按照这个顺序重新排列所有“团”。

在“团”的内部按照原顺序输出即可。

注意：直接使用 `cin` 和 `cout` 会取得 Wrong Answer。因为坐标范围超过 $10^6$，在 `cout` 的时候可能输出形如 `1e+6` 的字符串。

**测试点 $8, 9$**

我们还要优化遍历“团”内部线段的顺序。

除了第一个“团”，每个“团”的起始点是这个“团”中距离上一个“团”结束点距离最短的一个。

在每个“团”中，使用测试点 $5$ 的方法求出遍历每个“团”中线段的最优顺序。

### 测试点 $6, 7$

- 有向线段随机分布。
- 测试点 $6: n = 50$。
- 测试点 $7: n = 200$。

**测试点 $6$**

用 TSP 求出遍历所有线段的最优顺序。

这里距离权值是不对称的，需要将它转化成对称的 TSP。算法见[参考资料 1](https://en.wikipedia.org/wiki/Travelling_salesman_problem#Special_cases)。

这种做法也可以直接通过测试点 $6$，并在测试点 $7$ 得到 $9$ 分。

**测试点 $7$**

对于非对称的 TSP，答案存在一个下界：可以走多次，每次任意指定起点的情况。这个下界可以用[参考资料 2](https://www.comp.nus.edu.sg/~gilbert/CS4234/2015/lectures/06.ATSP.pdf) 中的算法得出。

这里提供一个简单描述：

设线段 $i$ 的终点到线段 $j$ 的起点的距离为 $w_{i, j}$。

如果经过线段 $i$ 后直接经过线段 $j$，那么 $x_{i, j} = 1$，否则 $x_{i, j} = 0$。

则答案为 $\min \sum w_{i, j} \cdot x_{i, j}$。

限制：  
- $\forall i \in [1, n], \sum_{j} x_{i, j} = 1$  — 每个点的出度为 $1$；  
- $\forall j \in [1, n], \sum_{i} x_{i, j} = 1$  — 每个点的入度为 $1$；  
- $0 \leq x_{i, j} \leq 1$；

可以用线性规划程序解出答案。该线性规划存在最优解使得 $x_{i, j}$ 都为整数。也可以转化为二分图匹配，用最小费用最大流求解。

在得出下界后，将结果表示为若干个环。注意到所有环的总长度和与 std 的答案相同。

这是因为环之间的相交关系形成连通图。如果两个环相交，不妨设为 $A \to B \to A$ 和 $A \to C \to A$，其中 $A$ 为交点，则这两个环可以合并为 $A \to B \to A \to C \to A$。将得出的所有环合并即为答案。

[提交记录 (100 pts)](https://loj.ac/submission/843717)

代码：

因为这是提交答案题，所以没有代码。
