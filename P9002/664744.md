本题解应该与其他题解略有不同，可能较长，我会讲对于结论题没有思路时如何打表寻找规律。最后才会有结论的证明。也谨以此题解记录我 OI 生涯第一次赛时切绿。

# solution

以下的变量除特殊说明外都是题目中的变量名称。注意到如此庞大的数据范围，我又没有各路神仙那么强大到可以直接发现性质并证明，所以直接~~打表出奇迹~~！

如何打表呢？对于这种题来说当然是观察所有 $B-$ **好的**数之间的关系啦。

- 当 $B=2$ 时。我们令 $n=30,B=2$，然后掏出我们的暴力代码，将所有合法的答案输出，是这个东西：```1 2 3 5 6 7 11 13 14 15 23 27 29 30 31```。然后我们对这串答案相邻的数取差，可得 ```1 1 1 2 1 1 4 2 1 1 8 4 2 1 1```，好像有点规律？我们继续观察其他情况。

- 当 $B=3$ 时。我们令 $n=90,B=3$，所有合法答案求差后可得 ```1 1 2 1 2 1 6 2 1 6 2 1 18 6 2 1 18 6 2 1```。

- 当 $B=4$ 时。我们令 $n=70,B=4$，所有合法答案求差后可得 ```1 1 1 3 1 3 1 3 1 12 3 1 12 3 1 12 3 1```。

以上三种情况求差的第一个数是 $0$ 和第一个合法数的差值，现在我们[把以上三种进制整理一下](https://www.luogu.com.cn/paste/2s76gyvj)，规律其实很明显了：对于给出的 $B$ 进制数，设数据大小位于 $B^k$ 和 $B^{k+1}-1$ 之间，其 $B-$ **好的**数之间差值为 $(m-1) \times B^{k-1}$、$(m-1) \times B^{k-1} \div m^1$、$(m-1) \times B^{k-1} \div m^2$ $\cdot \cdot \cdot \cdot \cdot \cdot$ $1$。这里最后的 $1$ 和前面的没什么关系，特判计算即可。

当然了，作为~~职业打表人~~，只找到这点规律哪够呢？我们还可以统计某一段区间内合法的答案数！上面的整理链接中还整理了特定区间内答案数，其实可以发现就是等差数列，所以我们提前计算 $B^k \le n$ 中最大的 $k$ 值，直接等差数列求出这一段的答案数，剩下如果还有多余的就用上面找到的差值间的规律求就行了。

实现这些需要快速幂等等操作，基本都是 $\log$ 的复杂度。

最后讲一下结论及其证明，以下内容均为赛后向 [@lzqy_](https://www.luogu.com.cn/user/288716)  和 [@Demeanor_Roy](https://www.luogu.com.cn/user/297806) 两位大佬请教而得知。

先给出结论：当一个数 $m$ 转为 $B$ 进制后，当且仅当去除最高位后，每一位的大小都为 $B-1$ 或仅有一位为 $B-2$ 时 $m$ 为合法数。

证明：我们让 $m$ 最高位减 $1$，其他位为 $B-1$。容易证明，这个数是小于 $m$ 的数中 $B$ 进制下数位和最大的。所以可见只要这个数的数位和大于等于转换后的数位和即为合法数。至于为什么至多可以有一位为 $B-2$ 呢？显然 $B-2$ 与 $B-1$ 是相邻两个数，都是合法的。

实现的话可以枚举可能的位数，设当前有 $s$ 位，除去最高位外还有 $s-1$ 位，$B-2$ 可能存在于任意位上，加上全是 $B-1$ 这种情况。而最高位有 $B-1$ 个情况，所以位数为 $s$ 的答案即为 $s \times (B-1)$。设共有 $w$ 种可能的位数，那么答案即为：
$$\sum\limits_{s=1}^ws \times (B-1)$$

最后把 $n$ 转换 $B$ 进制后最高位特殊处理一下就好了，不懂的话可以去看其他题解，讲得已经很清楚了，代码中有简单注解。

# code

[找规律](https://www.luogu.com.cn/paste/frjifuqi)

[运用性质](https://www.luogu.com.cn/paste/m6n4xpqz)

每次询问都是 $\log$ 的，所以总复杂度为 $\mathcal {O}(T \log n)$。

大概就讲完了，当没有头绪时打表找一下答案间的关系也是不错的方法哟。
