[题面](https://www.luogu.com.cn/problem/P3688)

~~由题目标题得正解肯定不是树状数组~~

手摸一下可以发现可怜的树状数组维护的是后缀和，再加上对 2 取模的特性，可以得出可怜所求出的是 $[l-1,r-1]$ 的区间和。

那么答案正确的充要条件就是 $a_{l-1} = a_{r} $。

用二维线段树维护平面内点对 $(x,y)$，表示 $a_x$ 与 $a_y$ 相等的概率。

显然只需要维护 $x \le y$ 的部分。（其实 $x\ge y$ 的部分也可以维护，只是查询时用不到）

那么对于一个修改 $[l,r]$，可以看做把整个平面分成了 9 份。

![](https://cdn.luogu.com.cn/upload/image_hosting/dhoikmy9.png)

其中四条线分别为 $x=l$，$x=r$，$y=l$，$y=r$。

其中 6、8、9 三个块 $x \ge y$，不需要维护。

而 1、3、7 三个块不会受到这次修改的影响。（左右端点都没有被 $[l,r]$ 覆盖）

设 $len=r-l+1$。

而 2、4 两个块内的点对满足其中一个点在 $[l,r]$ 中，有 $\frac{1}{len}$ 的概率被修改导致两项不等。

5 块内点对中的两个点都在 $[l,r]$ 中，有 $\frac{2}{len}$ 的概率两个点中的一个被修改而导致两项不等。

考虑概率的合并问题：

如果一个点对 $(x,y)$ 先有 $p$ 的概率相等，再有 $q$ 的概率相等，那么总的相等的概率就是 $pq+(1-p)(1-q)$。

1. 不等的情况只有 $(1,0)$ 和 $(0,1)$ 两种，如果再来一次不等修改就会改回相等的情况，所以“负负得正”两次不等会导回相等。

2. 这也算是证明了概率合并这个操作满足结合律，所以可以使用标记永久化。（具体证明建议自己手摸一下）

还有就是线段树的第二维要动态开点，因为是区间修改单点查询，所以要标记永久化。

最后还有一件事，返回题目可以看到题中的 query 函数有一个 $x=0$ 返回 0 的特判，这使得当 $l=1$ 时正确答案是 $[1,r]$ 的区间和而可怜求出的是 $[r,n]$ 的区间和，所以可以单独开一棵线段树记录一个节点 $i$ 的前缀和后缀和是否相等。

对于一次修改 $(l,r)$：

如果 $i \le l $ 或 $i \ge r$，那么前缀后缀肯定不等。

如果 $ l \le i \le r$，那么有 $\frac{len-1}{len}$ 的概率前缀后缀不等。
 
~~花了好久时间才弄懂这题，希望能给你些帮助。~~

[CODE](https://www.luogu.com.cn/paste/t9vmrghe) 