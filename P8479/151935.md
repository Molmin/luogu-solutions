考虑虚实链剖分，在 LCT 上 $\text{split}$ 出 $u,v$ 这条路径，那 $u,v$ 毛毛虫的结构就由以下组成：

1. 实链的点
2. 实链上每个虚儿子的链顶，按照编号顺序

这是一个适应题目信息的结构，可以维护。

我们想要设计一个结构，使得 pushup/pushtag 的时候能用到 每个虚儿子的链顶 的信息（设计和虚儿子的链顶的父子关系），并且虚儿子的链顶还要有序。

于是对每个点开一个平衡树放所有虚儿子的链顶（按照编号顺序的平衡树），一个点的点权就是自己的信息加上它平衡树根的信息。一条链的权值就是从上到下依次合并每个点的点权。

在一条实链上维护出从上到下和从下到上的最大子段和信息（因为 LCT 有 reverse 一条链操作），如下：

```cpp
void up(int x){
	s[x]=s[ls(x)]+v[x]+T::s[T::rt[x]]+s[rs(x)];
	s1[x]=s1[rs(x)]+v[x]+T::s[T::rt[x]]+s1[ls(x)];
	sz[x]=sz[ls(x)]+1+T::sz[T::rt[x]]+sz[rs(x)];
}
```

这样就能支持询问了。考虑修改：

我们维护一个 tag，表示这条实链以及实链上每个虚儿子的链顶被修改成 $x$。push tag 的时候，对于这个点的平衡树也进行 push tag，就支持了修改。

从平衡树中删一个点的时候，注意要把 LCT 上的点权更新成平衡树上的点权。插入一个点就是平衡树上的点权更新成 LCT 上的点权。

平衡树的复杂度无法均摊，所以是 $O((n+q)\log^2 n)$。

[代码，坑点写注释里了](https://www.luogu.com.cn/paste/vv4webyc)