[题传](https://www.luogu.com.cn/problem/P8479)

P8479 「GLR-R3」谷雨 ×

【模板】毛毛虫剖分 ×

[Ynoi ？？？] 干掉毛毛虫 √

自己写的关于这类剖分方法的 [$blog$](https://www.cnblogs.com/sizeof127/p/16693494.html)

### 题意简述

称一条链和与其有连边的点 构成的点集 为 “毛毛虫”，链上的点为 “毛点”，某个 “毛点” $x$ 的脚（与之右边但非链点）的点集为 $T_x$。

操作：给出一条 “毛毛虫” 的两端 $u, v$，将该“毛毛虫”内的点的点权改为 $k$；

询问：开始有个空序列 $q$，给出一条 “毛毛虫” 的**头、尾** $u, v$，从头到尾按链上的顺序遍历 “毛点”，每走到一个 “毛点” $x$，现将 $x$ 的点权加入 $q$，然后将 $T_x$ 内的点的点权按点编号从小到大顺序放入 $q$。操作完后，询问 $q$ 的最大子段和（可以为 0）；

### 主要思路

考虑根据重链构造满足题目修改要求的 dfn 序，然后直接线段树维护。

设 $S$ 为将重链作为 “毛毛虫” 时的 $T$。

dfn 序满足：

>每条重链的 $S$ 的编号连续；

因为跳重链时会出现半条链的情况，所以需要额外满足：

>对于每条重链上的点 $x$，$x$ 与 $x$ 所有在 $S$ 中的拓展点（即 $T_x$）编号连续；

注意到题目中询问分向上走和向下走两种，因此还有一个限制：

>重链点的编号的偏序关系和重链点的深度偏序关系全部相同或相反（分别对应向下和向下的情况）。

对于第三个限制，由于不能同时正序和倒序，所以构造两个不同的 dfn 序分别满足相同和相反，分开两棵线段树进行维护。

接下来，考虑构造。

将 1 号点的重链加入队列中，接下来，每次取出队头重链，进行如下操作：

1. 按照需要构造的偏序关系，自上往下/自下往上 遍历重链，假设现在在 $x$ 点；

1. 给 $x$ 点编号，随后给与 $x$ 有边但不是当前重链上的点编号，并将其的重链（这些点必定是某个重链的 $top$）加入队列。

不难看出，这样构造的 dfn 序，有点瑕疵：

重链上的 $top$ 和 $S$ 中其他点编号不连续，$top$ 的父亲也没被我们当成 $S$ 中的点

不过这个简单，~~小小~~大力分讨即可。

### 代码细节

细节巨多 /px。

首先需要维护每个节点轻儿子的区间。

修改重链的毛毛虫时，

对于链底，需要单独把它的重儿子修改，因为构造中的重链是**整条重链**，而修改可能只涉及半条重链。

对于 $u, v$ 的 $\operatorname{LCA}$，它的父亲也需要单独修改。

修改还算好，因为赋值操作重叠没有关系，但是询问就有点痛苦。

对于一次询问 $(u, v)$。

在 $\operatorname{LCA}$ 处的父亲比较烦，考虑拿掉 $\operatorname{LCA}$ 再做不用考虑父亲的，最后再合并，注意 $\operatorname{LCA}$ 的轻儿子区间要删除向下的链。

跳链的时候，对于链底 $y$，需要把下面一个被覆盖到的链的 $top$ 在 $y$ 的轻儿子序列中删去贡献，同时也要把 $y$ 的重儿子加入序列，具体看个人实现。

### Code

什么时候我重构一遍，过了就放 [博客园](https://www.cnblogs.com/sizeof127/p/16698002.html)