~~自己搞出了一个 AGC F，真不容易~~

~~虽然比较水~~

考虑 $\max A_i$。若为 $M+1$，则存在一些行是空的。可以枚举这些行，这一部分比较好处理过会再说。

若不为 $M+1$，则枚举 $v=n-\max A_i+1$，那就是说从右数前 $v-1$ 列可以任意取，第 $v$ 列有一些黑格，设它们所在行 $x_{1\cdots k}$，那么第 $v$ 列以后的列不可以有黑格在 $x_{1\cdots k}$ 行上。那么我们处理第 $v$ 列以后的列时我们可以直接把这 $k$ 行删掉，这是等价的。

所以可以考虑 DP，令 $f(m,n)$ 表示 $n$ 行 $m$ 列要求每行都非空的方案数，则

$$ f(m,n)=\sum_{v=1}^m \left(\frac{n(n+1)}{2}+1\right)^{v-1} \sum_{k=1}^n \binom{n+2}{k+2} f(m-v,n-k) $$

（答案为 $\sum_{k=0}^n \binom{n}{k}f(m,k)$）

其中 $k$ 是第 $v$ 列的黑格数，$\binom{n+2}{k+2}$ 是选出第 $v$ 列的黑格并确定 $B_v,C_v$ 的方案数，它的算法就是对于 $B_v,C_v$ 将它们也看做特殊的黑格，但由于它们可以与选出的黑格重合所以将 $B_v$ 减 1，$C_v$ 加 1，那么就是 $n+2$ 个里选 $k+2$ 个。

令 $F(m,n)=\sum_{k=1}^n \binom{n+2}{k+2}f(m,k)$，对于相同的 $m$ 它可以由一遍卷积得出。对于递推式 $f(m,n)=\sum_{v=1}^m (\frac{n(n+1)}{2}+1)^{v-1} F(m-v,n)$，可以化为

$$f(m,n)=(\frac{n(n+1)}{2}+1)^{m-1}\sum_{v=1}^m \frac{F(m-v,n)}{(\frac{n(n+1)}{2}+1)^v}$$

这里就可以对于相同的 $n$ 用前缀和优化，所以最后的总复杂度为 $O(mn\log n)$。