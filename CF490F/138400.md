考虑这题的 $n\leq 10^5$ 加强版。

考虑枚举以每个点 $x$ 为 lca 的 LIS。那么就设 $dp1_x$ 表示从 $x$ 往下的 LDS，$dp2_x$ 是 LIS，那么贡献有三种：

1. $\max(dp1_x,dp2_x)$；
2. 对两个不同的儿子子树里的节点 $y,z$，满足 $a_y<a_x<a_z$，$dp1_y+1+dp2_z$；
3. 对两个不同的儿子子树里的节点 $y,z$，满足 $a_y<a_z$，$dp1_y+dp2_z$。

第一种傻逼。第二种我们要搞一个子树内值域在某一范围内的 $\max$（相当于是个不可差分的二维数点），DP 的转移也要，第三种则更难。

先考虑这个类二维数点。它是在线、动态的，必须用树套树，由于不可差分还必须要用线段树套线段树。我曾尝试用后序遍历编号，这样可以假装是静态的，可以用主席树处理……吗？它不可差分…………所以树套树是大常数 2log 的，而且还不想写。

对于子树数颜色之类不可数据结构维护的东西，我们很容易想到 dsu on tree。但像这种暧昧的，可以区间 ds 维护但又比较劣的就想不到 dsu on tree。事实上是可以 dsu on tree 的，我们考虑之。就实时维护该子树内，关于值域的一个线段树。那么类二维数点这玩意就搞完了，第三种怎么处理呢？考虑在 dsu on tree 的轻子树合并进来的时候，与实时维护的到目前去掉当前子树的所有子树的 $\min\max$ 发生关系即可。这样子是小常数 2log，是个经典的 dsu on tree 优化 DP。

那么这个 dsu on tree 还可以改成线段树合并。对于第三种怎么处理呢？合并两个线段树的时候，类似 cdq 分治地在以每个节点为分界的地方更新答案即可。