## CF1411E 【Poman Numbers】

### 题意

+ 有长度为 $n$ 的数列 $a$；
+ 函数 $f(l,r)$ 的计算方法：
+ 1. 若 $l==r$，$f(l,r)=2^{a_i}$；
  1. 否则，任选一个 $m$ 使 $l\le m<r$，$f(l,r)=-f(l,m)+f(m+1,r)$；
+ 给定 $x$，判断 $f(1,n)$ 是否可能为 $x$；
+ $2\le n\le10^5,0\le a_i\le25,\mid x\mid\le10^{15}$。

### 做法

对每个 $2^{a_i}$ 对答案的贡献记为“+” 或“-”，按顺序整理出一个符号序列 $s$，显然有最后两个符号一定为“-+”（长度为 $1$ 除外）。

接下来证明必要性，即如果 $s$ 后两个符号为“-+”，前面的符号无论怎么选，都存在合法方案。

先解决一些特殊情况，比如说目标序列 $s$ 只有在最后有一个“+”，那就每次选 $m=l$。

否则，$s$ 至少有两个“+”，显然不能还像上面那样每次选 $m=l$。

前面说了合法方案的序列最后两个符号一定为“-+”，也就是对于选的 $m$，一定有 $s[m-1]=$“+”，$s[m]=$“-”（要反过来）。发现 $s[r-1]=$“-”，也就是说倒数第二个“+”的前面一定是“-”，这样就可以分出两个更小的子问题，从而递归地证明。

现在问题转化成有一堆数，最后两位符号确定，前面符号任选，判断是否可以计算出数 $x$。没法 DP，更不能暴力。

先修改 $x$ 去除最后两位的影响。发现所有数都是 $2$ 的整数次方，那就贪心地从大到小排序，对于每个 $a_i$，当 $x<0$ 时选“+”，否则选“-”，然后修改 $x$。

当 $x<0$ 时如果选“-”，且最终 $x=0$，那修改的过程中一定会出现一个位置使 $x'$ 正好等于当前的 $x$。此时如果把前面的操作取反，最终结果不变且在一开始选了“+”。而如果此时本来就选“+”，修改的过程中不一定有 $x'$ 正好等于原来的 $x$。综上，此时选“-”一定不会更优。