神仙题。

（后面一部分没有独立思考出来的参照了一些CF上给的解答）

首先很容易注意到每种长度要分开统计。

其次注意到正序和倒序、回文和非回文词会对统计产生影响。由于每个词都可以正反两种方法读，我们直接将原字符串和倒序字符串一同加入我们的字符串集合，顺便去重。这时对于每个剩下的串对应了“从首字符到尾字符连边的一种方式”，显然中间部分对答案没有影响了。就用 $a[s][t]$ 记录端点为 $s$ 和 $t$ 的方案数吧，于是每个字符串 $[s\dots t]$ 都会对 $a[s][t]$ 产生 $1$ 的贡献。同时有 $a[s][t]=a[t][s]$。

这时最容易想到的是枚举 $8$ 个顶点的 ${|\Sigma|}^8$ 种填字方式，每种方式对答案的贡献为 $\prod a[u][v]$，其中 $u,v$ 是某条边的两端点。复杂度（除了预处理的 $O(n)$ 以外）是 $O({|\Sigma|}^8)$。

考虑优化。发现 $8$ 个顶点可以染色成各自独立的两组，即 $3-$正则二分图的形式，每组之内独立考虑。设 $d[a][b][c]$ 为以任意相同字母开头，分别以 $a,b,c$ 结尾的字符串三元组的个数。一组顶点为 $a,b,c,d$ 的话，答案即为 $d[a][b][c]\cdot d[a][b][d]\cdot d[a][c][d]\cdot d[b][c][d]$。这部分复杂度 $O({|\Sigma|}^4)$。至于 $d$ 的计算，可以看出 $d[j][k][l]=\sum\limits_{i\in\Sigma}a[i][j]\cdot a[i][k]\cdot a[i][l]$。同样是 $O({|\Sigma|}^4)$。

还能优化。注意到很多方案之间是互相对称的，于是想到群论方法。发现对于正方体的 $48$ 种摆放方式，其中只有一半会改变两个顶点组的位置。至于怎么发现的就不（会）解释了。（或者也可以当正四面体来想。）如果一组中的 $a,b,c,d$ 各不相同，只算 $a<b<c<d$ 的答案再乘上置换数 $24$ 就好。要是有相同的就用 $(a,b,c,d)$ 的排列数去乘。总之就是数一个顶点组（正四面体）的放置方式，详情参考群论方面资料。另外处理 $d$ 的时候显然 $d[a][b][c]=d[a][c][b]=\dots=d[c][b][a]$，于是可以只算 $a\le b\le c$ 的。最后优化下来加上预处理能达到 $O(n+{|\Sigma|}^4/6)$。
