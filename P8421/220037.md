令 $A[l:r]$，$B[l:r]$，$C[l:r]$ 为 $l\dots r$ 的按位与，按位或，和公约数。当固定 $l$，最多有 $O(\log n)$ 个不同的 $A[l:r]$，$B[l:r]$，$C[l:r]$，于是有 $O(\log n)$ 个不同的价值，并且每一个价值对应一个 $r$ 区间。

我们可以对 $l=n\to 1$ 扫描线并同时维护 $s_r$ 为 $[l:r],[l+1:r],\dots,[r:r]$ 所有区间价值之和；当更新 $l+1\to l$ 需要对 $s$ 的 $O(\log n)$ 个区间加对应价值。

询问答案对应当时候的 $l$ 的 $s[l:r]$ 之和，可以使用树状数组维护，时间复杂度 $O(n\log^2 n+q\log n)$。可以用 p8283 trick 做到 $O((n+q)\log n)$。