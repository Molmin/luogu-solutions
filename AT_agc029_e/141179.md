vp 的时候没调完……吐了。

考虑点 $u$ 时候的答案，设点 $u$ 到点 $1$ 所经过的编号最大的点（不包括本身）是 $p_u$，在到达过 $p_u$ 之前，所有编号 $< p_u$ 的点都会被经过，这意味着若 $u<p_u$，那么点 $u$ 的联通块中所有的点都会被经过，否则点 $u$ 到 $p_u$ 的前一级祖先中的联通块，以及 $u$ 的所有儿子的联通块，都会被经过，然后到了点 $p_u$ 之后，答案并不是简单的加上 $p_u$ 的答案，因为你在 $p_u$ 时候的答案与原来的点本身还会有算重，算重的部分就是对于所有 $<p_{p_u}$ 的点的联通块中的连通块大小。

然后你全部离线下来然后转换成加点用并查集维护就好了。

[code](https://atcoder.jp/contests/agc029/submissions/27904871)。