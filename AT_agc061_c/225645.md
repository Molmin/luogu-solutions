> 结论：对于每一个合法排列 $P$，存在唯一的长为 $n$ 的序列 $i_1,i_2,\cdots,i_n$ 使得 $\forall t, A_{P_t}=i_t \vee (B_{P_t}=i_t \wedge i_{t-1}>A_{P_t})$。

> 证明：先证明存在性：由于 $P$ 合法，先选出序列 $i'_1,\cdots,i_n$ 满足前两个条件 $\forall t, A_{P_t}=i_t \vee B_{P_t}=i_t$；再对不满足第三个条件的 $t$ 进行调整，每次调整 $\sum i_t$ 严格变小，故有限次调整后得到合法序列。
> 
> 再证明唯一性：设序列 $i_1,\cdots,i_n$  和 $j_1,j_2,\cdots,j_n$ 均合法。求出两个序列的最长公共前缀长度 $l(l<n)$，则由于 $i_{l+1} \neq j_{l+1}$，有 $A_{P_{l+1}}=i_{l+1},B_{P_{l+1}}=j_{l+1}$，那么 $i_l=j_l < j_{l+1}$，于是 $j_{l+1}$ 不满足第三个条件，矛盾，故唯一性得证。
> 
> 综上，证毕。

那么现在每个人有两种选择：

- 选择 $A_i$。

- 选择 $B_i$，要求 $[A_i,B_i)$ 内有数被选择。

对第二种选择容斥，每个人有三种选择：

- 选择 $A_i$，容斥系数为 $1$。

- 选择 $B_i$，容斥系数为 $1$。

- 选择 $B_i$，要求 $[A_i,B_i)$ 内无数被选择，容斥系数为 $-1$。

由于题目保证 $A,B$ 均递增，考虑朴素 DP，设 $dp_i$ 表示考虑前 $i$ 个人，第 $i$ 个人选择第三种选择的方案数。转移枚举上一个选择第三种选择的人 $j$，可以计算出 $(j,i)$ 的人选择前两种选择的方案数。

DP 可以前缀和优化，总时间复杂度 $O(n)$。

[**Code**](https://atcoder.jp/contests/agc061/submissions/38949043)