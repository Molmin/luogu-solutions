我们首先要知道怎么快速计算 $S(n,m)$ 代表用 $[1,m]$ 中的正整数组成的长度为 $n$ 的非降序列个数

给出结论，$S(n,m)=\binom{n+m-1}{n}$ 或者用小学组合数的写法，$S(n,m)=\operatorname{C}_{n+m-1}^n$

原因？考虑一个长 $n+m-1$ 的操作序列，其中有 $n$ 个 `x` 操作，$m-1$ 个 `+` 操作

设一个数 $v$ ，初始 $v=1$，序列 $a$，初始为空。依次执行这个操作序列的每一项，若为 `+`，则 $v\gets v+1$ ，若为 $x$ ，则将 $v$ 加入到序列 $a$ 后面。

显然，这样构造的序列非降且长度为 $n$ 且每个数在 $[1,m]$ 之间，并且易证每一个序列唯一对应着一个操作序列。

所以我们对操作序列计数即可。显然一共 $n+m-1$ 个操作，我们选择其中 $n$ 个为 `x` （其它自然为 `+`），即 $n+m-1$ 中取 $n$ 个的方案数，即 $S(n,m)=\binom{n+m-1}{n}$ 

接下来就不是问题了

题目告诉我们两边分别是一个非降和非升序列，值域在$[1,m]$，而 $a_x=a_y$（$a$是任意一个合法序列）

我们分类讨论，若$x\leq n<y$， $x,y$ 在序列两边

又因为 $a_x=a_y$，我们考虑枚举 $a_x$

则对于 $a_x=a_y=k$，方案数为 $S(x-1,k)S(n-x,m-k+1)S(2n-y,k)S(y-(n+1),m-k+1)$

就是说，把序列分成四段，$[1,x-1],[x+1,n],[n+1,y-1],[y+1,2n]$，发现枚举了 $k$ 之后，可以确定它们中的元素的值域分别应该是 $[1,k],[k,m],[k,m],[1,k]$，且每个都是非降/非升序列，所以直接套用原来的公式。

否则，不妨设 $x<y\leq n$

我们发现右边完全没有限制，看左边。

依然枚举 $a_x=a_y=k$ 方案数为 $S(x-1,k)S(n-y,m-k+1)S(n,m)$

我们发现 $[x,y]$ 间的元素一定都 $=k$，考虑两侧，$[1,x-1],[y+1,n]$ 的值域分别为 $[1,k],[k,m]$。又因为右边完全没有限制，直接是 $S(n,m)$ 故得上式。


综上，预处理组合数 $O(n+m)$，枚举 $k$ 需要 $O(m)$ ，总复杂度 $O(n+m)$