# AT2180 Solution

首先不难观察出，其实就是对斐波那契数列做 $n-1$ 次前缀和，然后求第 $m$ 项。

对斐波那契序列做前缀和，不难想到相关定理：$\sum_{i=1}^na_i=a_{n+2}-1$。（此处及后文的 $a$ 均指斐波那契数列，其中 $a_1=a_2=1$）

于是观察一下 $d$，不难发现：
$$
\begin{aligned}
d_{1,n}&=a_n\\
d_{2,n}&=a_{n+2}-1\\
d_{3,n}&=\sum_{i=1}^n d_{2,i}=\sum_{i=1}^n (a_{i+2}-1)=a_{n+4}- n-3\\
d_{4,n}&=\sum_{i=1}^n d_{3,i}=\sum_{i=1}^n(a_{i+4}-i-3)=a_{n+6}-\frac{1}{2}(n^2+7n+16)
\end{aligned}
$$
到这里规律大概就能发现了，$d_{n,m}=a_{m+2(n-1)}+P(m)$，其中 $P(m)$ 是一个 $n-2$ 次的多项式，可以归纳证明。

对数列做前缀和，不难想到经典生成函数：$F(x)=1+x+x^2+\cdots+x^n+\cdots=(1-x)^{-1}$。

于是有 $D_n=A\times F^{n-1}$，这里的 $D_n$ 指序列 $d$ 的第 $n$ 行的生成函数，$A$ 指斐波那契序列的生成函数。

对于后面那个 $n-2$ 次多项式，不难想到用 Lagrange 插它，前面的 $a_{m+2(n-1)}$ 随便搞个快速幂就可以得到。

于是问题变成怎么快速得到 $D_n$ 的点值，这个简单。

相信大家都会 $\Theta(n)$ 求 $A$，我们有 $a_{n}=a_{n-1}+a_{n-2}$。

相信大家都会 $\Theta(n)$ 求 $F^{n-1}$，这是经典的短多项式快速幂。

> $F^{n-1}$ 怎么做还是说一下。
>
> 把 $F$ 记作 $(1-x)$ 吧。
>
> 设 $G=F^{k}$，当 $k = 1-n$ 时，$G$ 即为所求。
> $$
 \begin{aligned}
 G'&=kF^{k-1}F'\\
 G'F&=kGF'
 \end{aligned}
 $$
> 不难得到 $F'$，并且有 $[x^n]G'=(n+1)g_{n+1}$。然后我们观察这个等式两边的 $[x^n]$，可以得到一个等式，化简后即可递推。
>
> 化简后差不多是这么个东西：
>
> $$g_n = \dfrac{\sum\limits_{i=1}^n(ki-(n-i))f_{i}g_{n-i}}{nf_0}$$
>
> 因为 $F$ 是短多项式，所以大部分 $f_i=0$，这个可以近似看作 $O(n)$。

模数是 $998\,244\,353$，相信大家都会 $\Theta(n\log n)$ 的 FFT。

得到 $d_{n,i}$ 后，分别减去 $a_{i+2(n-1)}$ 即可得到多项式在 $1,2,\dots,n$ 处的点值，我们可以 $\Theta(n)$ 快速插它，最后带入即可。

时间复杂度 $\Theta(n\log n + \log m)$。

~~比[楼上](https://www.luogu.com.cn/blog/da32s1da/solution-at2180)劣多了呀~~