无内鬼，来点老鲤笑话。

出题人：保证每个人都会发一条学术消息！

Danno：我不用！

众人：我用两次！

~~好吧虽然好像这个做法第二问还是需要这个性质。~~

那么先来看第一问吧。

### 第一问

### 我会暴力！

一种十分显然的做法是把每条消息向其所有能为其产生贡献的消息连边，如果是楼上消息  ```A B loushang``` 就把这条消息向所有 B 发出的消息连一条边，假如是楼下消息 ```A B louxia``` 就把所有 B 发出的消息向这条消息连边，然后跑一个最小路径覆盖即可。

然后你就会发现连出的边是 $n^2$ 的然后还会发现里面还有环233那怎么搞呢。

### 我会优化暴力！

然后观察到上述做法边十分多的原因是因为我们直接用消息来连边，我们尝试把消息归到人上。

首先来看一看就很好做的性质 C 怎么搞。

考虑到每条消息的前面除了最前面那条一定会接一条消息，后面也除了最后面那条会接一条，考虑把每个人拆成 $A_1,A_2$ ，对 $S-A_1,A_2-T$连边，凡是有一条 $A$ 发出的消息那么就把上述两条边的容量 +1 表示 $A$ 的前面与后面又可以多接一条消息。

然后对于诸如 ```A B loushang``` 与 ```B A louxia```的消息从 $A_1$ 向 $B_2$ 连边，表示要消耗一个 $A$ 的下接口和 $B$ 的上接口来做出一个贡献。

然后你就会开心地发现消息之间可能会出现环~~cnmd~~

其实只需要再连一条 $T-T'$ 容量 $m-1$ 表示最多只能匹配 $m-1$ 个就可以了（

### 我会优化优化的暴力！

再来看一看没有 C 怎么搞。

首先我们发现有可能在匹配时贡献不为 $1$ 而是 $2$ ，因为有可能会有 ```A B loushang``` 和 ```B A louxia``` 这个东西。

那么是时候使用费用流了！对于这个东西每有一对我们就把其中一条边的费用改成 $2$ 这样跑个费用流就可以随便T飞啦。

~~对是T飞我才不会说想卡过去交了一页呢~~

很明显费用流的 $O(nmF)$ 跑不过啊！

### 我会优化优化的优化暴力！

然后我们发现为什么要为这一对消息专门建边呢。

如果我们不匹配这一对消息，那么这对消息中的两条消息产生的贡献一定是小于等于 $2$ 的，还会消耗其他消息。

那为什么不直接配上呢？？？

然后完全不需要为这东西建边，然后就只有费用为 $1$的边。

所以为什么不直接跑网络流呢？？？然后这是个二分图，可以过。

这样就解决第一问了。

[50分的纪录](https://www.luogu.com.cn/record/75583148)

### 第二问（代码先咕着）

经过第一问我们可以知道哪些消息是被选出来有贡献的。

然而我们不知道它们是怎么排的啊。

想一下，那些没有贡献的消息可以直接看成学术，然后这就把问题转成一个 B 性质的问题。

~~于是翻了一圈题解，发现并没有题解讲只有性质 B 怎么做，然后回来一看题目似乎并没有给出只有性质 B 的点~~

这里参考一下 [Itst](https://www.luogu.com.cn/blog/pengSiJin/lian-ge-xing-xuan-2022-xue-shu-she-ou-analysis) 的解法。

对于每个人拆成 $A_1,A_2$ 两个点。

对于楼上消息 ```A B loushang``` 从 $A_1$ 向 $B_1$ 连边。

对于楼下消息 ```A B louxia``` 从 $B_2$ 向 $A_2$ 连边。

对于一对消息 ```A B loushang``` 和 ```B A louxia``` 从 $A_1$ 向 $B_2$ 连边。

然后通过向虚点 $T$ 连边保证出入度平衡，跑一个欧拉回路就完了。

具体做法和证明详见 Itst 的题解。~~实际上就是把别人的 BC 做法和完整做法揉成一坨来搞~~

~~由于太懒不想写第二问先咕咕咕吧~~

总结：

本来想提供一个不同的建图方式，~~然后发现这个做法巨丑无比第一问第二问还要分开做233~~

code还没写完~~不想写了~~就不放了吧，以后有时间来补第二问。