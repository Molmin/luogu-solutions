## 题意

有 $n$ 个人和 $m$ 个消息，一个消息有三种情况：

- `A B loushang`：发消息的人叫 $A$，它产生贡献当且仅当下一条消息是 $B$ 发的；
- `A B louxia`：发消息的人叫 $A$，它产生贡献当且仅当上一条消息是 $B$ 发的；
- `A xxx xxx`（其他情况）：$A$ 发的一条学术消息，永远不产生贡献。

每人至少有一条学术消息，你要找到一种重排消息的方案，使得所有消息贡献之和最大。

$T$ 组数据，$T \leq 100$，$n \leq m \leq 77777$，$\sum m \leq 2.5\times 10^5$。

## 题解

考场写了个 72 ~~但是手贱加了一手输出方案然后写挂爆零了~~，后来发现容易完善到满分做法。思路与官方题解不太一样，但我写了一手似乎是对的，欢迎论破。

### 模型转换

首先不难想到，把每个消息看做一个点，$x\to y$ 的权值设为把消息 $y$ 接在消息 $x$ 后面产生的贡献（$\in \{0,1,2\}$），得到一张有向完全图。我们要构造一条哈密顿路径，使得上面的权值之和最大。

### 性质 C

考虑性质 C 的简单情况，也就是不会出现 $2$ 的边权。首先我们可以把所有权值为 $0$ 的边去掉，问题变成最小不交路径覆盖。如果这是个 DAG，我们直接跑二分图匹配就完事，但很可惜会出现环。

考虑 DAG 的建图，在一般有向图中为什么会跑错？它有可能出现 $1$ 的入点匹配了 $2$ 的出点，$2$ 的入点匹配了 $3$ 的出点，$3$ 的入点匹配了 $1$ 的出点，这一条路径被统计了 $0$ 次，就寄了。

但是此题保证每个人至少一条学术消息，如果出现了上述匹配成环的情况，我们直接随便取一个环上的点 $x$，将这个环并到 $x$ 发的学术消息上去（具体而言，在环匹配的前面/后面塞一条学术消息），这样就等效成一条大学术消息了。故我们直接使用 DAG 的建图来跑网络流，得到的答案是正确的。

边太多，需要优化建图将边数压到线性，这很容易。以上是考场想到的。

### 满分做法

一个贪心：如果出现了 `A B loushang` 和 `B A louxia`，可以直接让他俩匹配在一起。这样是必然不劣的，证明容易。

回归性质 C 的做法，这样的一组匹配等效于一条 $A$ 进 $B$ 出的学术消息（下面把这种点称为等效点），依然是可以跑网络流的，因为等效点间不会有边直接相连，所以匹配成环时一定可以找到一个非等效点并过去。这样就解决了这道题，时间复杂度 $O(m \sqrt m)$。

无输出方案参考代码：[Code](https://www.luogu.com.cn/paste/a5n8q1l3)

完整代码 ~~最劣解~~（跑起来很卡，不保证任何时间提交都能通过）：[Code](https://www.luogu.com.cn/paste/0wp7xxqx)