首先考虑欧拉函数的计算式 $\varphi(n) = n\prod_{p | n} \dfrac{p - 1}{p}$，所以我们考虑对每一个 $a_i$ 进行因式分解，然后计算每个质因子的贡献。

不难发现我们考虑一下重复质因子的贡献就做完了，这玩意在线不太好做，所以我们考虑离线。将询问按右端点排序，然后考虑一个一个加入，假设我们现在要在第 $i$ 个位置加入一个质因子 $p$，我们用 $last_p$ 表示 $p$ 上次出现的位置，然后我们在 $last_p$ 上乘一个 $\dfrac{p}{p - 1}$，再在 $i$ 上乘一个 $\dfrac{p - 1}{p}$ 即可，注意更新 $last_p$ 的值。

开个树状数组维护区间乘积就做完了，时间复杂度 $O(n\log n\log V)$。[Code](https://codeforces.com/contest/594/submission/207056887)