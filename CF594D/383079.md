提供一个在线做法。

这个问题的本质是二维数点，所以对于离线做法也存在一个可持久化线段树的做法。

考虑使用可持久化线段树维护，内层的区间乘积就是该点的答案 $\varphi$。

令指针 $i$ 从 $1$ 向 $n$ 扫，每次对于一个 $a_i$，考虑它会哪些区间的 $\varphi$ 值造成什么样的贡献。

我们将 $a_i$ 分解质因数，对每一个质因数 $p$，令 $las_p$ 表示上一次出现 $p$ 的位置。

- 若 $las_p$ 不存在，则直接在当前这颗线段树的位置 $i$ 乘上 $(p-1)p^{v_p(a_i)-1}$。

- 若 $las_p$ 存在，那么要消除掉 $las_p$ 处的贡献，就给这颗线段树的 $las_p$ 处乘上 $\frac{p}{p-1}$，然后再给 $i$ 接着乘上 $(p-1)p^{v_p(a_i)-1}$。

对于询问 $[l,r]$，我们只要在第 $r$ 棵线段树上询问 $[l,r]$ 这个区间的乘积即可。

预处理复杂度 $O(n\log a_i\log n)$，询问复杂度 $O(\log n)$，空间复杂度 $O(n\log a_i\log n)$。

相较于离线做法，是用空间换的在线。