# Solution

本题实际上是一个模拟题，需要维护当前念到了哪个字母以及当前的方向（顺时针或逆时针）。对于 UPIT 操作，可以在每次念完字母后更新记录每个字母出现次数的数组。注意，在做 SMJER 操作前也需要先更新一遍出现次数数组。

## 时间复杂度

对于每次 UPIT 操作，最坏情况下需要遍历所有前面的字母，故总时间复杂度为 $O(qn)$，会超时。我们考虑如何优化。

首先，注意到每次 UPIT 操作中的 $n$ 是递增的，因此可以采用类似前缀和的思想，即维护一个前缀和数组 $sum_i$ 表示前 $i$ 个字母中每个字母出现的次数之和。这样在计算某次 UPIT 操作时，可以只需统计 $x$ 字母在前 $n$ 个字母中出现的次数，即 $sum_n(x)-sum_{n-1}(x)$。这样可以将单次查询的时间复杂度优化到 $O(1)$。但仍然无法通过本题，因为在 SMJER 操作时需要重新计算整个前缀和数组。

接下来引入一个 Trick：在 SMJER 操作后，将前缀和数组翻转，即 $sum_i$ 变为 $\sum_{n-i+1}$。这样在之后的 UPIT 操作中，只需按照原来的方法计算 $x$ 字母在前 $n$ 个字母中出现的次数，即 $sum_n(x)-sum_{n-1}(x)$，再将结果翻转一下即可。这样可以保证在 SMJER 操作后仍然能够正确统计每个字母的出现次数。

时间复杂度优化后，总时间复杂度为 $O(q+n)$，可以通过本题。