刻画加入一条边产生的贡献：若加入 $(x,y)$，我们提取出树上 $x$ 到 $y$ 的路径为根，计算出路径上每个点的子树大小 $s_i$，增量即为 $\frac 12\sum_{i\in\operatorname{path}(x,y)}s_i(n-s_i)$（每个子树到子树外的点路径数量都恰好加一）。

即最小化路径上每个子树的大小平方和，令 $f_i$ 为 $i$ 子树内某点到 $i$ 的最小平方和，容易转移。

枚举 lca，在 lca 处拼合两条路径：

$$\min f_x+f_y+(n-sz_x-sz_y)^2$$

斜率优化，复杂度 $O(n\log n)$（瓶颈在排序，可以离线基排做到线性）。