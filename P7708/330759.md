蓝的一些话：

蓝的本篇题解仅讲述 八云蓝自动机Ⅰ 莫队解法，不讲述 八云蓝自动机Ⅱ 正解以及 八云蓝自动机Ⅰ 部分分做法。

首先珂以发现操作1和操作2同时存在很难处理，考虑一个简单的转化：将所有操作1，即赋值操作转化为操作2。考虑在数组中建立一些额外的项，对于 `1 x k` 操作，我们珂以提前建立一个值为 $k$ 的项 $a_y$，然后将修改操作转化成 `2 x y`，容易证明这两个操作是完全等价的。这样就只有交换操作和单点询问啦。

接下来考虑莫队（相信大家都已经熟练掌握这个算法啦）。假设现在扫到的是区间 $[l,r]$，我们维护区间 $[l,r]$ 所有询问得到的答案之和 $ans$，令交换后的序列为 $a'$，维护序列 $b$ 满足 $a'_i=a_{b_i}$，维护序列 $id$ 满足 $a'_{id_i}=a_i$，维护序列 $c$ 满足 $c_i$ 为区间 $[l,r]$ 询问原序列 $a_i$ 的询问数（例如交换 $a_2$ 与 $a_3$，询问 $a_3$，即为询问原序列 $a_2$）。并对于端点的挪动进行分类讨论：

1. 左端点左挪，即扫到的区间变成了 $[l-1,r]$，这时有两种可能：加入询问操作，设加入的询问操作为 `3 x`，将 $ans$ 加上 $a_x$，并将 $c_x$ 加一；加入交换操作，设加入的交换操作为 `2 x y`，将 $b_{id_x}$ 和 $b_{id_y}$ 交换，交换 $id_x$ 和 $id_y$，更新答案（令原答案为 $ans$，新的答案为 $ans-c_x\times a_x-c_y\times a_y+c_x\times a_y+c_y\times a_x$），并将 $c_x$ 与 $c_y$ 交换。

2. 左端点右挪，即扫到的区间变成了 $[l+1,r]$，这时有两种可能：撤销询问操作，设撤销的询问操作为 `3 x`，将 $ans$ 减去 $a_x$ 即可；撤销交换操作，由于将两个数进行两次交换操作相当于没有进行交换操作，所以设撤销的交换操作为 `2 x y`，将 $b_{id_x}$ 和 $b_{id_y}$ 交换，交换 $id_x$ 和 $id_y$，更新答案（柿子和上面的一样），然后交换 $c_x$ 与 $c_y$ 的值即可。

3. 右端点右挪，即扫到的区间变成了 $[l,r+1]$，交换操作相信大家都会（注意要交换 $id_{b_x}$ 和 $id_{b_y}$），考虑加入询问操作，设加入的询问操作为 `3 x`，由于我们维护了序列 $b$ ，只要将 $ans$ 加上 $a_{b_x}$，然后将 $c_{b_x}$ 加一就行啦。

4. 右端点左挪，即扫到的区间变成了 $[l,r-1]$，相信到这里大家都会了，减一减或是交换一下即可，不再赘述。

然后这道题就做完啦（撒花），时间复杂度为 $O(n+m+q \sqrt{m})$，因为 $n,m,q$ 同级，所以事 $O(m\sqrt{m})$ 的（珂以注意到 $n$ 能开到 $10^7$，但是没什么意义）。

