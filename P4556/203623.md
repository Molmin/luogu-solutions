对每种颜色分别处理。

对每种颜色的操作建立虚树。这里对原树预处理 $O(n)-O(1)$ LCA 即可线性。

那么对虚树上每一条边即原树上的一条链，可以求出他被加入这种颜色多少次，设为边权。

那么相当于若干次操作，每次对一条链取 $\max$。

把所有虚树上的边按权排序。从大到小扫描，维护树上并查集。即维护每个点最深的没有被操作过的祖先。每次取 $\max$ 相当于从链底向上跳，利用并查集跳过已经被操作过的点，把未被操作过的点 $\max$ 设成当前虚树边的权值并标记即可。

这个树上并查集是可以线性的。树分块后四毛子或者利用位运算即可。