还不错的题。

对 b 序列序列分块，那么只需维护整块答案和，以及 $O(1)$ 查询 a 序列的某个前缀和。

后者显然可以使用 $O(\sqrt n)$ 加 $O(1)$ 查的分块维护，重点在前者。

操作 1 使用颜色均摊转化成 $O(n)$ 次区间加，每次加完之后我们都得重构每个整块的答案，考虑贡献：

$$\sum_{i=l}^r\sum_{j}[b_j\geqslant i]v$$

差分成：

$$\sum_{i=1}^c\sum_{j}[b_j\geqslant i]v=v\sum_j\min(b_j,c)$$

那么我们就要在每个块内，对于每个值 $k$ 维护有多少个 $b_j=k$，并支持 $O(1)$ 的前缀和查询。

操作 2 整块可以打标记，上式维护平凡。每个散块颜色均摊一下，那么就变成了 $O(1)$ 个位置的修改，使用 $O(\sqrt n)-O(1)$ 分块维护即可。

复杂度 $O(n\sqrt n)$。