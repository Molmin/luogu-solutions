思路来自 @[茫茫星辰1208](https://www.luogu.com.cn/user/323204)，拜谢模拟赛踩 std 的神仙。

## Description

给一个 $1$ 到 $n$ 的排列 $p$，你可以选择一个数 $x$，每次可以翻转一个长度为 $x+1$ 或 $x-1$ 的区间。构造一个方案，在 $20n$ 次操作内使排列有序。

## Solution

首先可以发现我们选的 $x$ 一定是奇数。

考虑若 $x$ 为偶数，无论如何翻转区间都无法改变一个数下标的奇偶性。故当数 $x$ 与其位置的奇偶性不同时，会导致无解。

---


假设该序列足够长，考虑如何在不影响其他数的情况下交换 $p_a$ 和 $p_b$。

规定 $a<b$，则 $a$ 与 $b$ 之间的距离为 $b-a$。  
当 $b-a=x$ 时，可以通过依次操作 $[a,b]$、$[a+1,b-1]$ 交换它们的位置。设该操作为 $\text{swap}(a,b)$，代价为 $2$，要求 $b-a=x$。  
显然，当 $\operatorname{dis}(a,b)\ge x$ 时，可以先通过重复操作 $\operatorname{swap}(b-x,b)$ 使它们的距离小于 $x$。故我们只讨论 $\operatorname{dis}(a,b)<x$ 的情况。

设 $r=a+x$，那么我们只需要考虑怎么把 $b$ 换到 $r$ 的位置上。  
当 $b$ 与 $r$ 奇偶性不同时，容易求出一个区间 $[L,R]$，使 $b,r$ 关于区间中点对称。那么，我们先 $\operatorname{reverse}(L,R)$，此时的 $b$ 在 $r$ 的位置上。那么我们 $\operatorname{swap}(a,r)$ 把 $a,b$ 交换，最后再把 $[L,R]$ 翻回来即可。  
考虑 $b$ 与 $r$ 奇偶性相同怎么办。其实操作前先 $\operatorname{swap}(b,b+x)$ 就好了，因为这样 $\operatorname{dis}(b,r)$ 还是小于 $x$，可以直接套用上面操作。

至此我们解决了交换任意 $p_a,p_b$ 的问题。

---

注意到这个方法需要在 $a$ 后面有大约 $2x$ 长度的额外空间。把序列分为两半，分别从两端向中间构造，两边都可以获得 $\dfrac{n}{2}$ 的额外空间。

$x$ 的取值满足 $\dfrac{n}{2}\ge 2x$，解得 $x\le\dfrac{n}{4}$。  
对于每个数 $b$，使其与 $a$ 的距离小于 $x$ 的 $\text{swap}$ 需要至多 $2\times \dfrac{n}{x}$ 次操作，后续需要至多 $6$ 次操作。  
总操作次数的上限约为 $\dfrac{n(n+1)}{x}+6n$，在 $x$ 取 $\dfrac{n}{4}$ 时最优，上界不足 $10n$。实测操作数稳定在 $5000$ 左右，可以通过。

