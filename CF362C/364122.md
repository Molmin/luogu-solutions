线性 DP

设 $f_{i.j}$ 表示前 $i$ 个数有多少个数小于 $j$，$g_{i,j}$ 表示前 $i$ 个数有多少个数大于 $j$

这个很好 dp，前缀和就好了。

$f_{i,j}=f_{i-1,j}+[a_i<j]$

$g$ 同理。

设 $sf(l,r,i)=f_{r,i}-f_{l-1,i}$ 表示区间 $[l,r]$ 中有多少个数小于 $j$

设 $sg(l,r,i)=g_{r,i}-g_{l-1,i}$ 表示区间 $[l,r]$ 中有多少个数大于 $j$

然后考虑 $\Theta(n^2)$ 枚举交换的两个点 $l,r$，$\Theta(1)$ 查询逆序对数量，假设为修改前的逆序对数量为 $s$，假设增量为 $\Delta$，注意可能为负数。将 $l,r$ 交换后，$[l,r]$ 内原本小于 $a_l$ 的数现在移动到了 $l$ 的右侧，就要减去，原本大于 $a_l$ 就要加上；$r$ 同理

那么 $\Delta=sg(l,r,a_l)-sf(l,r,a_l)-sg(l,r,a_r)+sf(l,r,a_r)$，然后将答案和 $s+\Delta$ 取最小值即可。