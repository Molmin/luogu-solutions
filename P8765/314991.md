**合法括号序列** 可以被等价地描述为：

- 序列中左括号与右括号数量相等。
- 序列的任意前缀中，左括号数量不小于右括号数量。

更易接受的叙述是：如果将左括号赋值为 $1$，右括号赋值为 $-1$，则序列的和与最小前缀和均为 $0$。

注意到，序列的最小前缀和在 $l$ 固定时关于 $r$ 单调不增。由此可以考虑线段树上二分。

具体而言，建立线段树，并在每个结点维护：

- 和
- 最小前缀和
- 所有最小前缀和对应端点中最靠右者

查询时，在线段树上二分，如果最小前缀和已经小于 $0$，则考虑向左走；否则继续向右走。由于 $l$ 与二分所得端点（记为 $r'$）所构成区间最小前缀和恰好为 $0$，答案即为 $[l,r']$ 所有最小前缀和对应端点中最靠右者。

考虑如何修改。不难发现，翻转操作本质上是给区间乘了一个 $-1$。额外维护最大前缀和，最大前缀和端点最靠右者即可。

复杂度 $\mathcal O(n\log n)$。使用更加简明的 $\mathcal O(n\log^2n)$ 实现同样可以通过。