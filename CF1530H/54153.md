考虑把整个过程倒过来，问题就转化为了：

给定 1 ∼ $n$ 的排列 $p_1$, $p_2$, ⋯ , $p_n$。 

初始时你在数轴的原点处，每一步你可以向左或向右走一个单位长度（也可以不动）。

第 $i$ 步结束后，如果你当前的位置上没有数，就写上 $p_i$ 。
 
求最终数轴从左到右的所有数的 LIS 的最大值。

----------

考虑在行走的过程中你关心什么？

只用考虑 LIS 中的元素。

当前在 LIS 的左侧还是右侧？

LIS 中有几个元素？

LIS 首尾元素的值？

怎样判断能否将当前元素加入到 LIS 的左 / 右侧？

设 $f_L(k,i)$ 表示 LIS 长度为 $k$ 时，末尾是 $p_i$ ,开头的最大值。

$f_R(k,i)$ 同理表示末尾的最小值。

写出转移，发现可以 BIT 优化。

LIS 的长度期望 $O(\sqrt n)$

于是就 $O(n\sqrt n \log n)$过了此题