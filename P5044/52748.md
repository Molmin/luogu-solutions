首先需要考虑复杂度为 $O(n^2)$ 的暴力动态规划。

设 $f_{l, r}$表示询问 $[l, r]$ 的答案。

转移的时候，需要观察到区间里的最大值作为关键点一定是不优的。所以有转移方程：

$$f_{l, r} = \min \lbrace f_{l, p -1} + a_p \times  (r - p + 1) , f_{p + 1, r} + a_p \times (p - l + 1) \rbrace$$

$p$ 为区间最大值所在的位置。含义就是关键点放在 $p$ 两边取个最优。

进一步优化需要使用到笛卡尔树。因为转移需要用到最值的位置。

先手动把一个询问拆成两半，相当于求 $f_{l, p - 1}, f_{p + 1, r}$，然后可以直接合并起来得到答案。同时 $p-1, p+1$ 一定是笛卡尔树上的端点，所以可以把询问都离线下来挂到笛卡尔树的结点上。

那么问题就变成了对于笛卡尔树上的一个结点 $[l, r]$，求 $f_{l, i}, i \in [l, r]$。

我们可以分治解决这个子问题，先求出两个儿子的信息。

也就是已知 $f_{l, i}, i \in [l, p - 1]$ 和 $f_{p + 1, i}, i \in [p + 1, r]$ 。

再观察一下上面给出的转移方程，左边一项相当于区间对一次函数取最小值，右边相当于直接区间加，考虑用线段树维护，但是问题在于直接维护复杂度是线性的。

那么现在再观察一下性质，$f_{p+1, r}$ 的每移动一位，增量一定不超过 $a_p$，因为 $a_p$ 是区间最大值。所以当右边一项更优的时候，往右走一定都是更优的，那么就可以用线段树维护了，在线段树上二分即可。

再来总结一下：

离线询问，挂到每个笛卡尔树的区间上，用线段树维护区间信息，需要支持**区间加**，**区间对一次函数取最小值**，单点查询。时间复杂度为 $O((n+q)\log n)$。