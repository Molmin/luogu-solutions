考虑根号做法，对编号分块。

记 $pa_i$ 表示点 $i$ 离开块的第一个祖先，$fa_i$ 表示父亲。

对于询问，不断像树剖那样跳父亲即可，单次 $\mathcal O(\sqrt n)$。

对于修改，散块暴力，整块也暴力。

因为 $fa_i<i$ 且每次修改 $fa_i$ 都会减少，故对一个块修改 $\sqrt n$ 次 $fa_i$ 后，块内每个元素跳 $fa_i$ 都会跳出块，此时 $pa_i=fa_i$，打个标记即可，上界 $\mathcal O(n\sqrt n)$。

时间复杂度 $\mathcal O(n\sqrt n)$。