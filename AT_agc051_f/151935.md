~~终于做出了 AGC 纪念。很多结论都是猜的，没有证明。~~

对于 $a+b\sqrt2$，发现 $a>0,b>0$ 肯定是能得到的，对于 $a<0,b>0$，就是要求出对于某个 $b$，能得到的最小 $a$ 是多少，$a>0,b<0$ 同理。

首先题目中的操作太抽象，要用**合理、直观的方式刻画操作**。于是想到用 $(x,y)$ 表示第一个漏斗掉落了 $x$，第二个漏斗掉落了 $y$ 的状态。

看做一个小球，从初始点 $(0,0)$ 开始，从 $(-1/0/1,-1/0/1)$ 八个方向中选择一个不断运动，直到 $x\in\{0,1\},y\in\{0,\sqrt2\}$ 时可以改变方向。（这步好像和官方题解一样，就上这张图）

![](https://img.atcoder.jp/agc051/71818d155faf01fd3d1684a7bb88c17e.png)

但这样是在网格里循环的走，还是不直观，那就**扩充到一个二维坐标系**。

在坐标系里，$x$ 轴每格长为 $1$，$y$ 轴每格长为 $\sqrt 2$。我们规定小球只能向上下左右，和右上、左下 6 个方向走，碰到坐标系的一条线时可以改变方向。

![](https://cdn.luogu.com.cn/upload/image_hosting/5dfuzvup.png)

接下来我们想找出怎样走是最优的。

上图中红线长度分别表示 $\sqrt 2-1,2\sqrt 2-2,3\sqrt 2-4,4\sqrt 2-5...$，蓝线长度表示 $2-\sqrt 2,3-2\sqrt 2,5-3\sqrt 2...$。

经过手玩和暴力验证，发现一直走斜线是比某一次走上下左右优的。

假设我们要凑出的是 $a+b\sqrt 2(a<0,b>0)$，我们可以走到一条红线的地方，在红线上来回走。比如走到 $(1,1)$，然后不断走 $\sqrt 2-1$ 红线，就能得到所有 $2\sqrt 2-1,3\sqrt 2-2,4\sqrt 2-3...$，也就是 $1+k(-1+\sqrt2)$。（这也是暴力输出路径的结果）

但这样不是最优的，如果走到 $(4,4)$，虽然要付出走过 $4$ 时间的代价（要减的 1 的系数多了），去 $3\sqrt 2-4$ 的红线走可以减少的 1 的系数更多。但这样前两段红线刷的次数都得是偶数次，最后一条红线是任意次。可以表述为 $4+2k_1(-1+\sqrt2)+2k_2(-2+2\sqrt2)+k_3(-4+3\sqrt 2)$。

那么我们的策略也固定了：走到某一条红线处，前面的每条红线刷偶数次，最后一条红线刷任意次。

显然，如果一条红线比前面的所有红线都更优（也就是 $1$ 上的系数除以 $\sqrt2$ 上的系数更大），我们才会去走到它来得到更优。

打表一下，发现似乎只有 $\log$ 条有用的红线。下面是一部分打出的表。

其实是取不断逼近 $\sqrt 2$ 的所有真分数 $p/q$，并且 $p,q$ 尽量小，不难想到可以在 Stern-Brocot 树上二分求出，同时也证明了数量是 $\log$ 的。~~数据范围才 1e9，直接贴打出来的表也行~~

```
1 1 1.000000000000
3 4 1.333333333333
5 7 1.400000000000
17 24 1.411764705882
29 41 1.413793103448
99 140 1.414141414141
169 239 1.414201183432
577 816 1.414211438475
985 1393 1.414213197970
3363 4756 1.414213499851
5741 8119 1.414213551646
19601 27720 1.414213560533
33461 47321 1.414213562057
114243 161564 1.414213562319
```

那对于询问，可以枚举走到哪条红线，然后枚举最后一条红线走了奇数次还是偶数次。那现在变成了前面若干条红线都要走偶数次。

下面把每条红线 $(\sqrt2 的系数,-1的系数)$ 看做一个向量，询问也看做一个向量。

这样问题就变成了：询问一个向量 $(a,b)$，对于前若干个向量，每个向量都要取偶数个，问能不能加起来得到向量 $(c,d)$ 使得 $c\le a,d\ge b$。（$a,c$ 代表 $\sqrt2$ 的系数，$b,d$ 代表 $-1$ 的系数）

令 $a\to \lfloor a/2\rfloor,b\to \lceil b/2 \rceil$，去掉偶数的限制。

猜一个结论，设最后一个向量（最后走到的红线）是 $(p,q)$，只需要满足 $\frac{a}{b}\ge \frac{p}{q}$ 就行了。

虽然不会证，但感觉就很能用调整满足。用暴力 DP 验证，发现结论是正确的！

对于 $a+b\sqrt 2(a>0,b<0)$ 也就是走蓝线的情况，所有的结论都是类似的，不再赘述一遍。要求的向量也是比值逼近 $\sqrt2$ 的若干个 $p/q$，可以在 Stern-Brocot 树上二分时一并求出。下面是部分向量的表。

```
2 1 2.0000000000000
3 2 1.5000000000000
10 7 1.4285714285714
17 12 1.4166666666667
58 41 1.4146341463415
99 70 1.4142857142857
338 239 1.4142259414226
577 408 1.4142156862745
1970 1393 1.4142139267767
3363 2378 1.4142136248949
11482 8119 1.4142135731001
19601 13860 1.4142135642136
66922 47321 1.4142135626889
```

[代码](https://atcoder.jp/contests/agc051/submissions/39143097)