确实只有 Div.2 D 难度。但是场上为什么只有这么点人过呢？

---

阅读理解题。

注意题面中的两个小细节：

1. 连边是 $p_i$ 与 $p_i+1$ 连边，而不是 $p_{i+1}$。
2. 当 $a_{p_i}=1$ 时 $p_i$ 向 $p_i+1$ 连边，而不是 $a_i=1$ 时。

先考虑 $\forall i,a_i=0$ 的情况。

套路地算每个点的贡献。考虑何时 $p_i=x$ 有贡献：

- $x$ 已经与点 $1$ 连通。
- 点 $1$ 没有出边。

每次 $p_i$ 向 $p_i+1$ 所在弱连通分量连边，若将边视作无向，则每个连通块一定是一段区间，每次连边形如合并 $p_i$ 与 $p_i+1$ 所在连通块。

因此，$x$ 与 $1$ 连通等价于 $1$ 至 $x-1$ 均在 $x$ 前出现。

再考虑 $a_x=1$ 的情况。此时 $x$ 一定没有贡献，且若 $1$ 与 $x$ 已经联通，会消除所有 $j>i$ 的贡献。

---

于是就可以递推了。记 $ans_i$ 表示长度为 $i$ 的前缀的答案，$f_i$ 表示若 $a_{i+1}=0$ 会产生的总贡献。

考虑 $i$ 在排列中的位置。可以发现，插入中间不会改变原有的贡献。

当 $a_i=0$ 时，放在最后会额外产生 $1$ 的贡献；$a_i=1$ 时，放在最后会消除后续所有贡献。

于是有：
$$
\begin{cases}
f_i=f_{i-1}\cdot i,\ ans_i=ans_{i-1}\cdot i+f_{i-1}&a_i=0\\
f_i=f_{i-1}\cdot(i-1),ans_i=ans_{i-1}\cdot i&a_i=1
\end{cases}
$$

相当于 $a_i=1$ 时不能放在最后。