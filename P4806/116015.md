我们把原先的 $n$ 条边称作**实边**，其它边称作**虚边**。

先求出原图的最小生成树 $\mathcal{T}$ 。

对于 $D=0$ 的情况，最优的方案肯定就是 $\mathcal{T}$ ，那么答案就是 $\mathcal{T}$ 中虚边的数量。

对于 $D\ge 0$ 的情况，显然地，使用管道推进器的边一定是“有效方案”里的最大边。

我们考虑在 $\mathcal{T}$ 上进行调整，由于使用推进器的边费用至多被减为 $0$ ，那么用实边 $x\notin \mathcal{T}$ 替换虚边 $y\in \mathcal{T}$ 使得费用总和不变的充要条件是：

- 将 $x$ 替换  后还是一棵生成树（保证方案有效）。
- $y$ 是 $\mathcal{T}$ 中的最大边。
- $w(x),w(y)\le D$ ，即使用推进器后 $x,y$ 费用均为 $0$ （保证总费用不变）。

于是只需要判断是否存在满足条件的 $x,y$ ，若无则答案同 $D=0$ 的情况，反之答案为 $D=0$ 的情况 $-1$ 。

那么怎么判断呢？~~只要找到满足条件的 $y$ ，然后**相信**一定存在满足条件的 $x$ 把它替换就能过了。~~

只要找到满足条件的 $y$ ，然后枚举边权 $\le D$ 且不在 $\mathcal{T}$ 上的实边 $x$ ，判断一下 $y$ 是否在 $u(x)$ 到 $v(x)$ 在  上的路径里即可，这个写个 LCA 就能维护了。