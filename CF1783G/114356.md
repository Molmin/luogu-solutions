CF1783G Weighed Tree Radius 题解。

发现 $w$ 的定义具有方向性，这样其实不利于分析。

考虑重定义一种 $w$ 为 $w'(x,y)=a_x+a_y+d(x,y)$。

据此可以定义一颗树的直径为最大的 $w'(x,y)$。（此时直径可能为 $w'(x,x)=2a_x$ 的形式）

这样定义的直径保留了传统直径的许多有利性质。

首先，直径路径上一定存在一点 $z$ 使得 $w_z(x)=\lceil{w'(x,y)\over 2}\rceil$。

证明显然，因为 $d$ 总是连续的，且 $a_x\le a_y+d(x,y)$、$a_y\le a_x+d(x,y)$。后者存在的原因是 $w'(x,y)\ge w(x,x)$、$w'(x,y)\ge w(y,y)$。

其次，$e(z)=\max(w_z(x),w_z(y))$。

证明可以把 $a_x$ 或者 $a_y$ 看成连在 $x$ 或 $y$ 上的一段距离，就和树的直径的证明方法相同。

结合两个性质可以得到 $e(z)\ge\lceil{w'(x,y)\over 2}\rceil$，且一定能取等。所以所求即后式。

那么只需维护直径 $(x,y)$ 即可。

接下来考虑修改对询问的影响。若 $a_z$ 的修改量 $\Delta\ge 0$，则新的直径只可能是 $d(x,z)$、$d(y,z)$、$d(z,z)$ 中的一个，直接分讨即可。否则不太好做。

这个操作类似回退，因此可以将修改映射到时间上，使 $a$ 不降。那么对修改做线段树分治即可。

时间复杂度 $O(n\log^2n)$ 或 $O(n\log n)$（$n$、$m$ 同阶），视 LCA 的实现而定。