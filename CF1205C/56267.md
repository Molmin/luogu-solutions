考虑对距离为3的两个元素进行询问，此时得到的回答即是始末元素是否相同。

首先将矩阵奇偶染色，发现左上角和右下角这两个已知元素同色，称这种颜色的元素为偶数元素。偶数元素共有$(n*n+1)/2$个，可以通过$(n*n+1)/2-2$次询问求得所有偶数元素的确切值。

对于奇数元素，共有$(n*n-1)/2$个，并且可以通过$(n*n-1)/2-1$次询问求得所有奇数元素的相对值。不妨设$a[1][2]=1$，那么我们得到了一个完整的矩阵。

此时我们共计使用了$n*n-3$次询问。而还需要验证，$a[1][2]=1$是否符合原矩阵。

考虑距离为4的询问，假设其中一条路径为$c_1,c_2,c_3,c_4$。如果$c_1\oplus c_2\oplus c_3\oplus c_4=0$，那么当且仅当$c_2=c_3$时构成回文路径，否则$c_1\oplus c_4 = c_2\oplus c_3 =1$即$c_1$,$c_4$不等，自然不可能回文。

值得注意的是，由于$c_1$,$c_3$同色，那么他们之间的关系我们是确定的，自然异或和也确定。$c_2$,$c_4$同理。所以四个数的异或和也是确定的。

我们需要在矩阵中寻找一条长度为4的路径满足上述，用以验证。

因为$a[1][1]=1,a[n][n]=0$，必然存在$i$，使得$a[i][i]\oplus a[i+2][i+2]=1$。

于是
$$(a[i][i]\oplus a[i+1][i]\oplus a[i+1][i+1]\oplus a[i+2][i+1])$$
$$(a[i+1][i]\oplus a[i+1][i+1]\oplus a[i+2][i+1]\oplus a[i+2][i+2])$$

必然不同。

在两条路径之中必然能找出一条，满足$c_1\oplus c_2\oplus c_3\oplus c_4=0$。进行一次询问用以验证，符合则直接输出，否则奇数元素取反输出。

代码丑，不放了。