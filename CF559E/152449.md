参考了 xht 的做法，画了几张图，可能会好理解一些。

首先对所有线段按给出的端点位置排序，然后考虑 DP。令状态 $f(i,j,p)$ 表示处理了前 $i$ 条线段，它们覆盖的最右边的一段由线段 $j$ 贡献，且 $j$ 的方向为 $p$（左 $0$ 右 $1$）。如果正常的考虑加入一条线段转移，即由 $i$ 转移到 $i+1$，应该考虑线段 $i+1$ 的贡献。但这个贡献是不好处理的，如图：

![](https://cdn.luogu.com.cn/upload/image_hosting/o3p7w7jq.png)

黑色的表示已经计入贡献的线段，红色的表示新加入的线段。发现黑色中间的空隙是算不了的，所以这样会产生后效性。但是同时我们发现第二段黑色线段是没有任何用的，我们扔掉这种「没有用的线段」，加入时就只需要考虑 $j$ 右端点后面的部分了。所以，我们从 $i$ 转移到 $k\in[i+1,n]$ 的所有线段，并不计线段 $i+1\sim k-1$ 的贡献。但是注意，还是需要考虑一种贡献：

![](https://cdn.luogu.com.cn/upload/image_hosting/6op82xst.png)

这里紫色的线段 $x$ 超过了 $k$ 的右端点，并成为最靠右的线段。假设 $x$ 的方向为 $y$，那么 $f(i,j,p)$ 应该转移到 $f(k,x,y)$，还要加上 $k$ 后面一段的贡献。$x$ 应该从 $i+1\sim k-1$ 中取右端点的最大值，而从小到大顺次枚举 $k$ 时可以直接维护。所以转移的复杂度是 $O(n)$，总复杂度就是 $O(n^3)$。