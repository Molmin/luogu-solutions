
将绝对值拆开，如果 $i$ 对于答案的贡献为 $-1$ 那么记为 L，否则记为 R，将 $p$ 与数列 $\{1,2...n\}$ 分别当作两个排列，那么问题即在两者上连边，满足权值和为 $k$ 的合法方案数。

我们不考虑具体的连边关系，只考虑每个点往前连边还是往后连边，然后将这两个 $\{1\sim n\}$ 的数列写在一起，变成 $\{1,1,2,2...n,n\}$，那么某个点如果是 L，那么它可以向之前的点中位置的奇偶性与其不同的 R 连边。

于是问题变为给定数列 $\{1,1,2,2...n,n\}$，给每个点赋予一个权值 L/R，如果为 L 那么可以向前面的一个 R 连边，一个数列的权值定义为 R 的权值和减去 L 的权值和，求满足权值为 $k$ 的 L/R 数列以及连边方案数。

显然每个 L 的出现都必须伴随着连边，事实上我们只关乎前面的数列中剩余的奇数位与偶数位的 R 的数量，这样直接 dp 就可以做到 $\mathcal O(n^5)$ 了，我们肯定要压缩状态，$k$ 的维度显然无法压缩，那么只能将奇偶数位上的 R 的数量压缩掉一个。

我们注意到一个性质，假设每次决策将 $12,34$ 等位置一起处理，那么设奇数位上剩余的 R 数量为 $j$，当前在第 $i$ 位，那么当前匹配的 L,R 数量必然为 $(i/2-j)$，所以偶数位上会剩余且仅剩余 $i/2-(i/2-j)=j$ 个，换而言之两者的数量时刻保持相同。

所以就可以压缩掉一个维度了，当然更方便的处理方法是记录一下奇数位上的 R 的数量然后统计一下偶数位上与其的数量差，容易注意到差值必然是 $-1,0,1$