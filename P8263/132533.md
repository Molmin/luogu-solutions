**P8263**题解。

感谢 sjy 帮忙纠正。

不会 AVL 和红黑树，今天才知道 fhq 的可持久化区间复制也是假的。。。

~~其实之前还一直以为是平衡树维护 bitset 之类的做法。看来对区间复制还是太不敏感了。~~

所以就和题解一样用了可持久化的 WBLT 维护。

具体地我们发现，难点在于 $2$ 操作，而 $2$ 操作如果一个节点的编号 $\times 2$ 是不会改变它们是否反转这个性质的。这提示你可以考虑用可支持倍增区间复制的可持久化平衡树去解决这个问题，即不删除历史版本节点的情况下可以用 $O(1)$ 的空间代价得到一个原区间完全复制后与原区间拼接得到的一个区间。

对于 $1$ 操作直接复制，对于 $2$ 操作我们直接开一个反串的倍增节点，每次两者互相更新，这样最后把需要用到的节点组合到一起即可。

对于 $3,4$ 操作，$3$ 操作直接用 WBLT 的 split 做就可以了，$4$ 操作二分一下就可以了。

其实完全可以加强到区间 $1$ 的 $k-th$ 位置，只是确实也没意思了。

时空复杂度 $O(n \log n)$，具体证明是由于考虑在倍增的时候，合并的时空复杂度用差分抵消一下等价于 $O(\log \frac{\max_{sz}}{\min_{sz}})$，即 $k$ 的二进制位上的最大 $1$ 位置与最小 $1$ 位置的距离差，即 $O(\log n)$。

