### [CF1621H Trains and Airplanes](https://www.luogu.com.cn/problem/CF1621H)

设 $f_{u, j}$ 表示从 $u$ 出发会在国家 $j$ 被罚几次，容易 $\mathcal{O}(nk)$ 预处理。

称一个集团为极大同色连通子图，记为 $S_i$，其中 $i$ 为该集团的最浅点。很显然，对于每个 $j$，每个集团的 $f_{u, j}$ 相差不超过 $1$。

设 $g_{i, j} = \min_{u\in S_i} f_{u, j}$，$T_u = \{j\mid f_{u, j} > g_{i, j}\}$（$u\in S_i$），那么一个集团只有 $\mathcal{O}(k)$ 种不同的 $T$。这是因为，从 $i$ 往上跳，每个国家将深度模 $t$ 的同余类 $K_{0\sim t - 1}$ 分成三段区间，每段区间对应的所有 $u$ 的 $f_{u, j}$ 相同，即 $dep_u\bmod t$ 在该区间内的 $f_{u, j}$ 相同。故总断点数量不超过 $\mathcal{O}(k)$。

对每个点 $u$ 预处理出其子树内所有和它颜色相同的点 $v$ 的所有本质不同的 $T_v$，回答询问时直接暴力即可。时间复杂度 $\mathcal{O}(nk + qk ^ 2)$。[代码](https://codeforces.com/contest/1621/submission/211328181)。

从上往下分裂求出所有断点，再用二进制数记录每个点的子树内是否有颜色与其相同且深度落在对应等价类的点，从下往上合并，回答询问时按顺序扫一遍断点即可，类似扫描线。因为断点对答案计算的影响是 $\mathcal{O}(1)$ 的，所以总复杂度 $\mathcal{O}((n + q) k)$。