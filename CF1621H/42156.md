
注意到从 $x$ 开始，在 $i$ 区域被查票的次数是定的，设为 $s(x,i)$，可以用 $26$ 次倍增预处理。那么 $f(v)$ 可以写成：
$$
\sum_{i\ne z_v}\min(fine(v,i)s(v,i),pass(v,i))
$$
然而询问很奇怪，直接写成以上形式并不好回答询问。

注意到在询问中，在不是出发点所在区域的 $i$ 区域行进的总时间是定的，因此被查票的次数只会是 $A$ 或 $A+1$。进一步，注意到查票次数为 $A,A+1$ 的与出发点的深度的关系：是一段区间内，查票次数为 $A$，另一段内，查票次数为 $A+1$！

故一共只有 $O(k)$ 个区间，把整个模 $T$ 余数分成了 $O(k)$ 段，每段 $fine,pass$ 均完全相同，对于每个点，都可以用主席树预处理出来（离线一下可以不用主席树）这些段内子树中有没有元素，询问时就可以直接回答了。

时间复杂度 $O(nk\log n+qk\log T+qk^2)$。

感觉整个题行云流水，做完（当然是看了题解）后大呼好妙。

代码上的坑点：

1. 主席树空间开够，我 $1.2\times 10^7$ 会 RE，$1.5\times 10^7$ 才能过。
2. $fine\times s(x,i)$ 会爆 long long，记得判一下。

---

认真读了一下题解，发现其实不用主席树的，注意到对于同一个同色连通块，它们的这些区间都一样，从下往上合并一下就可以空间 $O(qk)$ 了。

同时询问也可以做到 $O(qk)$，只需要动态维护当前答案而不是每次重新去扫。

最终的复杂度是 $O(nk\log n+qk)$。