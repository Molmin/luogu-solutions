## Preface

这种复杂度不是人能想出来的。

## Analysis

首先只保留边权为 $a$ 的边，求出所有连通块。显然根据最小生成树性质，同一连通块间不可能选边权为 $b$ 的边作为最小生成树上的边。所以一颗最小生成树一定是每个边权为 $a$ 的连通块内通过边权为 $a$ 的边构成生成树，再通过边权为 $b$ 构成最小生成树。

显然有如下性质：对于无向图上的这一条简单路径，必然有一棵**生成树**（非最小）是包含这条路径的。构造只要由这条路径上的点向外 dfs 即可。

我们把所有边权为 $a$ 的边构成的连通块缩成一个点，只要用边权为 $b$ 的边连结所有缩完的点（缩成的点内不能连），且不构成环，就一定存在一个合法的最小生成树。也就是说不能回到已经离开的连通块。我们用 $f_{S,u}$ 表示已经离开的连通块集合为 $S$，到点 $u$ 的最短路径。可以用类似 dijkstra 的方式计算。复杂度 $O(2^nm\log(2^nm))$。

观察性质发现，如果一个连通块的大小 $\le 3$，那么块内点的最短路只有 $2a$，如果出块再回块，路径长度已经到达了 $2b$，由于 $b>a$，故在跑最短路时，根据最短路性质就不会出该块再回到该块，所以这一类连通块可以不计入 $S$ 的状态。因此，需要记录的连通块个数最多只有 $\frac{n}{4}$ 个。最终复杂度 $2^{\frac{n}{4}}m\log(2^\frac{n}{4}m)$。

## Code

[Codeforces Status](https://codeforces.com/contest/1149/submission/174462216)