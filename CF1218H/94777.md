容易发现若将 $i\to a_i$ 连边，序列就变为了内向基环树，而 $f(i,m)$ 就是让 $i$ 在基环树上走 $m$ 步，查询就是求到内向基环树一点 $y$ 距离为 $m$ 的点数。

考虑对 $y$ 分类讨论：

- 若不在环上，只有子树内深度为 $dep_y+m$ 的点能恰好走 $m$ 步到达，离线之后在每棵树 dfs 即可。

- 若在环上，首先因为要在环上走若干圈，而最后还是要回到一点，先将 $m$ 对环长 $l$ 取模。考虑设一个任意的定点 $p$，设 $p$ 到 $y$ 的距离为 $d$，那么到 $y$ 距离为 $m$ 就是到 $p$ 距离为 $(m-d)\bmod l$ 的点，设此值为 $k$。那么，现在询问的点固定为 $p$，而只要经过 $p$ 则必须从 $p$ 的出边出去再次回来，而步数已经对 $l$ 取模过了，所以 $p$ 的出边没有用，直接断掉。此时基环树变成了树，而 $p$ 是这颗树的根。那么求的值变为了深度模 $l$ 余 $k$ 且到 $p$ 距离小于等于 $m$ 的点数，可以离线下来一边 dfs 一边统计。

时间复杂度 $O(n)$，偏口胡，具体实现应该有更多细节。