考虑暴力怎么做：

- 把前 $k$ 个区间每个区间连一条链，根据 $a_i$ 从小到大连起所有下标成一条链。连完 $k$ 条链后就得到了一个符合条件的 DAG，但不是最小的。
- 接下来，如果有边 $u\to w,w\to v,u\to v$，则可以删去边 $u\to v$，删完后得到边数为答案。

这样是 $O(qn^2)$ 的。

我们发现现在是对每个询问算答案，转换一下思路，变成每条边对询问算答案。

考虑一条边 $u\to v$ 在什么时候出现，什么时候消失：

- 当有一个区间包含 $u\to v$ 时出现。
- 当有一个区间包含 $u,v,w$ 且 $a_u<a_w<a_v$，那 $u\to v$ 就被删掉。

如果区间 $[u,v]$ 中就有这样的 $w$，那 $u\to v$ 不可能出现；否则我们可求出一个能到左和到右不被删去的极限，$L(u,v),R(u,v)$ 表示出现包含 $[L(u,v),\max(u,v)]$ 和 $[\min(u,v),R(u,v)]$ 的区间时 $u\to v$ 会被删掉。（$L(u,v),R(u,v)$ 就是最接近 $[u,v]$ 区间的上文的 $w$）

此时加入时间和删掉时间就是一个二维数点，由于要考虑 $n^2$ 条边，只能做到 $O(n^2)$。

----

接下来有一个牛逼的观察。

实际上可能有用的边数是 $n\sqrt q$ 级别的。考虑对 $q$ 个询问的区间做莫队，维护一个链表表示当前区间内根据 $a$ 有序的一条链。莫队加入一个点是最多产生的影响是（插入链表时）删一条边，加两条边，莫队移动端点 $n\sqrt q$ 次，在整个莫队过程中，最多出现 $n\sqrt q$ 种不同的边。

于是使用回滚莫队求出所有可能有用的边，用分块平衡二维数点复杂度，做到 $O(n\sqrt q+q\sqrt n)$。

不过由于 $n$ 小，$n^2$ 或者根号带 log 都能过。