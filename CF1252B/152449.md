如果题解页面公式显示错误，请[在博客中查看](https://www.luogu.com.cn/blog/Hakurei-Reimu/solution-cf1252b) .

对于节点 $u$，它可以向它的儿子发最多 $2$ 条边。同时，它的连边有三种情况：

- 向它的儿子一共发了恰好 $2$ 条边，此时它的父亲不能向它连边（不可选）。将方案数记为 $f_{u,0}$。
- 向它的儿子一共发了 $0$ 或 $1$ 条边，此时它的父亲可以不向它连边（可选）。将方案数记为 $f_{u,1}$。
- 向它的儿子一共发了 $0$ 或 $1$ 或 $2$ 条边，且没有连边的儿子不会与它构成链，此时它的父亲可以不向它连边（可不选）。将方案数记为 $f_{u,2}$。

对以上三种情况分别考虑转移。如果是第一种的情况，则 $u$ 连边的儿子必须可选，没有连边的儿子必须可不选：
$$
f_{u,0}=\sum_{x,y\in son_u\wedge x\neq y}f_{x,1}f_{y,1}\prod_{v\in son_u\wedge v\neq x,y}f_{v,2}
$$
如果是第二种情况，若 $u$ 发了 $0$ 条边，则它的所有儿子都必须**不可选**，因为如果有一个儿子可选则会与 $u$ 构成链，且无论父亲怎么决策都无法消除影响，所以这样就会直接不合法；若 $u$ 发了 $1$ 条边，则 $u$ 连边的儿子必须可选，没有连边的儿子必须可不选：
$$
f_{u,1}=\prod_{v\in son_u}f_{v,0}+\sum_{x\in son_u}f_{x,1}\prod_{v\in son_u\wedge v\neq x}f_{v,2}
$$
如果是第三种情况，若 $u$ 发了 $0$ 条边，则同理它的所有儿子都必须不可选；若 $u$ 发了 $1$ 条边，则 $u$ 连边的儿子必须可选，没有连边的儿子必须**不可选**，因为如果有一棵儿子可选则会与 $u$ 构成链，那么 $u$ 的父亲必须向 $u$ 连边（$u$ 必须选），违反了状态的定义；若 $u$ 发了 $2$ 条边，则与第一种情况相同：
$$
f_{u,2}=f_{u,0}+\prod_{v\in son_u}f_{v,0}+\sum_{x\in son_u}f_{x,1}\prod_{v\in son_u\wedge v\neq x}f_{v,0}
$$
假设我们以 $1$ 为根，则最终的答案为 $f_{1,2}$。

考虑 DP，直接转移是 $O(n^3)$ 的，但可以将其优化。下面是我的优化方式，以第一种情况的转移为例：
$$
f_{u,0}=\sum_{x,y\in son_u\wedge x\neq y}f_{x,1}f_{y,1}\prod_{v\in son_u\wedge v\neq x,y}f_{v,2}
$$

$$
=\sum_{x,y\in son_u\wedge x\neq y}\frac{f_{x,1}f_{y,1}}{f_{x,2}f_{x,2}}\prod_{v\in son_u}f_{v,2}
$$

$$
=\frac{1}{2}\left[\left(\sum_{x\in son_u}\frac{f_{x,1}}{f_{x,2}}\right)^2-\sum_{x\in son_u}\left(\frac{f_{x,1}}{f_{x,2}}\right)^2\right]\prod_{v\in son_u}f_{v,2}
$$

其他两种情况的优化比较容易，在这里就省略了。

还有个问题是 $0$ 在模意义下无逆元，因此要特殊处理。具体就是记下 $0$ 的位置再讨论讨论，同样不难处理。

时间复杂度为 $O(n\log mod)$，这里的 $\log$ 是求逆的复杂度。实际上如果用前缀和优化可以做到 $O(n)$。