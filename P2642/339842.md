这道题类似于[合唱队形](https://www.luogu.com.cn/problem/P1091)。

## 思路：
对于 $30\%$ 的数据，可以枚举断点，然后向两边计算最大子段和。

对其优化，发现求最大子段和这个过程可以预处理出来。

所以我们预处理出从前向后的最大子段和和从后向前的最大子段和。

处理这个东西用 dp。

![](data:image/png;base64,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)

$head_i$ 可以从 $head_{i-1}$ 转移过来，还可以直接用 $a_i$。然后更新 $head$ 数组。

$tail$ 数组同理。

处理完从首尾出发的最大子段和之后枚举断点，计算两边最大的和，求出答案。

## 坑点：

中间一定要隔一个位置！！！

还有一个情况，就是 $head_1+tail_3$ 也可能是最终答案！

## 代码：

```cpp
#include <bits/stdc++.h>
using namespace std;
int n,a[1000010],head[1000010],tail[1000010],ans;
int main(){
	cin >> n;
	for(int i=1;i<=n;i++) cin >> a[i];
	//从前往后找最大子段和 
	head[1]=a[1];
	for(int i=2;i<=n;i++) head[i]=max(head[i-1]+a[i],a[i]);
	for(int i=2;i<=n;i++) head[i]=max(head[i-1],head[i]);
	//从后往前找最大子段和 
	tail[n]=a[n];
	for(int i=n-1;i>=1;i--) tail[i]=max(tail[i+1]+a[i],a[i]);
	for(int i=n-1;i>=1;i--) tail[i]=max(tail[i+1],tail[i]);
	//枚举断点 
	ans=head[1]+tail[3];
	for(int i=3;i<n;i++) ans=max(ans,head[i-1]+tail[i+1]);
	cout << ans;
	return 0;
}
```
