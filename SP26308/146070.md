建议评紫

首先我们有笛卡尔树科技。建出树后我们就能知道一个点左边走多少格，右边走多少格以内最大值都是 $a_i$ 。

把区间左端点，也就是左边能走的范围当作第一维，区间右端点，也就是右边能走的范围当作第二维，这时发现相同长度的区间在这个二维平面上是一条斜线。

然后就转成了矩阵加，斜线求和的问题。这个可以拆成两段等差数列和一段区间加，直接用线段树维护。

总复杂度 $O(n\log n)$