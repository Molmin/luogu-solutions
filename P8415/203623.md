我也不知道题目在说啥，试图嘴巴。

题目描述的应该是对 $l'\le i<r'\ a_{i+1}=b_{a_i}$ 。

令 $t_i=[a_{i+1}=b_{a_i}]$，每次就是 $t$ 的单点修改。

然后维护的其实就是 $t$ 的极长连续段。

$[l,r]$ 左右的连续段就阿巴阿巴维护一下。

中间的就根号分治一下。

$x$ 少就枚举每个 $x$ 然后判断一下包含他的极长连续段。

这个要维护一个集合，在单点修改的时候插入删除一下。

然后还要维护前驱。

分块就行。

$x$ 多就少

所以在单点修改的时候枚举一下 $x$ 就行。

这个也要维护前驱（或者维护区间和），反正分块。

大概就这样。

一指禅雪糕掉键盘


---

upd：

感谢 OUYE2020 大佬的提醒，之前坏掉了。

之前做法对题目的转换应该是没有好的做法的。

但是题目的性质是好的。

题目的真实意图是：一个子区间满足条件当且仅当这个是置换环上的一条路径且这条路径包含 $x$！！

所以有用的子区间只能是 $x$ 所在的环中的。

这就有两种情况：

1. 路径包含了整个置换环

这种情况显然是满足包含 $x$ 的，对这些直接取 $\max$。

2. 路径没有包含整个置换环

这种情况可以把置换环展开，那么一条路径就是一个子区间或者前后缀的并。

修改对应的是修改一条路径。

所以把路径对应的区间添加上其长度，用平衡树维护之，就是 $O(n\log^2 n)$ 的时间复杂度。