# CF1192B Dynamic Diameter

## 题目大意

[题目链接](https://codeforces.com/problemset/problem/1192/B)

有一个 $n$ 个点的带权无向树，$q$ 次操作，每次修改一条边的权值，要求在每次修改后，输出树的直径大小，强制在线。

数据范围：$1\leq n, q\leq 10^5$。

## 本题题解

介绍一种简单易懂的 $\mathcal{O}(q \log^2 n)$ 做法。

首先，有一个众所周知的结论是：对于树上任意两个点集 $S, T$，设 $S$ 的直径为 $(u_S, v_S)$，$T$ 的直径为 $(u_T, v_T)$，则点集 $S\cup T$ 的直径，两个端点都在 $\{u_S, v_S, u_T, v_T\}$ 中产生。也就是说，我们在合并两个点集，并维护直径时，只需要讨论 $\mathcal{O}(1)$ 种可能的直径。

在 dfs 序上建一棵线段树。线段树的每个区间 $[l,r]$，维护 dfs 序在 $[l,r]$ 内的这些点组成的点集的直径。

考虑修改一条边的权值，会对线段树上哪些点集产生影响。设修改的边的儿子节点为 $x$，记以 $x$ 为根的子树的 dfs 序区间为 $[\text{st}_x, \text{ed}_x]$。则线段树上一段区间 $[l,r]$ 的答案可能发生改变，**仅当 $[l,r]$ 与 $[\text{st}_x, \text{ed}_x]$ 有交且不被 $[\text{st}_x, \text{ed}_x]$ 完全包含**。因为无交时，说明整个点集都在子树外，肯定不会被影响到；被完全包含，说明整个点集都在子树内，也不会被影响到。

考虑“有交且不被包含”，其实就相当于，在线段树上定位 $[\text{st}_x, \text{ed}_x]$ 时，所**经过的所有非终点节点**。这样的节点只有 $\mathcal{O}(\log n)$ 个，只需要对它们的直径进行更新即可。

更新时，还是从儿子那里继承，然后分类讨论。相当于我们只需要实现一个线段树的 ``push_up`` 函数，就能解决所有问题。

``push_up`` 时，涉及到求树上某条路径的长度。另外要支持修改边权。我们可以用数据结构（树状数组或另一棵线段树）维护每个点到根的距离。这样修改就变成区间加。查询就是先求 $\text{LCA}$，然后做三次单点查询。于是查询是 $\mathcal{O}(\log n)$ 的。

总时间复杂度 $\mathcal{O}(n + q \log^2 n)$。

