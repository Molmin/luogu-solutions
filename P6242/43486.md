其他题解已经把本题的过程讲述得很详尽了，这里仅说一点对懒标记的理解。

所谓懒标记，本质是记录了一段操作序列，用一个值或一些值描述出来。而懒标记的下传，就是将这段操作序列的影响更新到子结点处，并且将这段操作序列添加到子结点操作序列的后面，然后清空原结点操作序列的过程。每访问到一个结点就下传该点的懒标记，意义就在于维护所有操作序列的有序性。有些操作的操作顺序不会影响到询问的结果，如区间加区间求和，此时才可以标记永久化，不下传标记。

回到本题的“历史版本最大值”，所求即为 **操作序列的前缀和的最大值** 。令 $add_x$ 表示线段树上结点 $x$ 的区间加标记， $add'_x$ 表示结点 $x$ 的历史最大加标记，设 $x$ 的儿子结点为 $y$ ，将 $x$ 的标记下传至 $y$ 时，有 $add'_y=\max\{add'_y,add_y+add'_x\}$ ，即将 $x$ 的操作序列接在 $y$ 的操作序列之后，前缀和的最大值。

最后再说一下在标记下传时需要注意的两个问题：

1. 在下传前，要先判断儿子结点的区间里有没有当前结点的区间里的最大值，如果没有，则区间非最大值加法标记会影响到儿子结点区间的最大值，区间最大值加法标记不会影响儿子结点区间。

2. 不能因为区间加标记等于 $0$ 就不下传标记，可能经过一系列操作后区间加标记变成了 $0$ ，但是历史最大加标记不为 $0$ 。

代码太丑，就不放出来啦，在理解本题应该维护哪些值哪些标记以及如何下传标记后，代码实现不会很难。