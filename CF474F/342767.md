题解区线段树刷屏/fad

所以我要写的是使用 st+二分，萌新都能轻松看懂的题解/kel

- 前置知识

st 表，stl 库函数

- 题目分析

首先看到题目，我们发现得到满分等价于同时是所有数的因子。

题解区都说显然是当且仅当这个数是区间 $\gcd$ 才得到满分/fad

对于我这种 MnZn 很不友好，所以我要稍微证一下

如果我们把区间划分成两部分：

一部分是我们验证是否为满分的这个数；

另外一部分是其他所有数。

我们设其他数的 $\gcd$ 为 $u$，这个数为 $v$，假设 $v$ 是区间 $\gcd$。

因为 $\gcd$ 有结合律，当且仅当 $\gcd(u,v)=v$ 时 $v$ 是满分，此时区间 $\gcd$ 为 $\gcd(u,v)$，此时 $v$ 是 $u$ 的因子。

但是，如果我们把**此时的** $v$ 调成**刚才的**区间 $\gcd$ 的因子，那么区间的 $\gcd$ 也会跟着变为 $v$，此时依然成立：$v$ 是区间 $\gcd$。

所以，我们得出，一个数得到满分等价于它是区间 $\gcd$。

这道题就等价于：给定一个数列，多次询问区间内有多少个数**不是**区间 $\gcd$。

而区间 $\gcd$，由于它的可覆盖性，可以直接用 st 表维护。

我们正难则反，加强问题，就得到了新的题目：

给定一个数列，多次询问区间内有多少个数与给定数相同。

而我们知道，区间的 $\gcd$ 有一个特点：它小于等于区间的任何一个数。

所以问题又又又转化为区间最小值出现的次数。

接下来，就是另一道题了。

- 细节解析

我们输入后，除了做区间 $\gcd$ 的 st 表，我们要再用另一个各个元素与原来的数组元素相同的数组，排序去重后我们用一个 `vector` 数组和一个 `map`。

下面把第一个数组叫做旧数组，第二个数组叫做新数组。

`vector` 是从新数组推到旧数组，用来**顺序**存储每一个在新数组的指定**位置**对应的旧数组的所有元素下标，而 `map` 是由旧数组推到新数组，用来存储每一个旧数组的**元素值**对应的新数组的元素下标。

对每一组询问，先求出这个区间的 $\gcd$，然后通过 `map` 求出下标。

由于 `vector` 数组是新数组下标推向旧数组下标，所以对这个下标，我们放到对应的 `vector` 里，接下来我们求的，是这个数组中范围在 `l~r` 的数的个数。

通过前缀和的思想，只要求 `1~r` 的数的个数减去 `1~l-1` 的数的个数即可。

而这两个值我们都可以用 `vector` 中的 `upper_bound` 来实现。

到此，我们终于，做完了本题。

- 详解代码

变量定义：

```cpp
int n,t,l,r/*输入*/,a[100005]/*新数组*/,f[100005][32]/*st 表的数组*/;
vector<int> e[100005];//vector 数组
map<int,int> b;//map
```

预处理：

```cpp
cin>>n;
for(int i=1;i<=n;i++)
{
    cin>>f[i][0];//这里直接输入成 st 表了（旧数组）
    a[i]=f[i][0];//这是新数组
}
sort(a+1,a+n+1);//排序
int l=unique(a+1,a+n+1)-a-1;//去重
for(int i=1;i<=n;i++)
{
	int poi=lower_bound(a+1,a+1+l,f[i][0])-a;//找对应位置
	e[poi].push_back(i),//这个是顺序排的，下面才能二分
   b[f[i][0]]=poi;//设置位置
}
//下面是 st 表
for(int j=1;(1<<j)<=n;j++)
    for(int i=1;i+(1<<j)-1<=n;j++)
        f[i][j]=__gcd(f[i][j-1],f[i+(1<<(j-1))][j-1]);
```

对于每一组询问：

```cpp
cin>>l>>r;
int len=r-l+1,//区间的长度
k=(int)log2(len);
int poi=b[__gcd(f[l][k],f[r-(1<<k)+1][k])];//区间 gcd 对应的原数组位置
int lef=upper_bound(e[poi].begin(),e[poi].end(),l-1)-e[poi].begin();//左端点
int rig=upper_bound(e[poi].begin(),e[poi].end(),r)-e[poi].begin();//右端点
int cnt=rig-lef;//区间内都是
cout<<len-cnt;
```

加了两个不影响代码原意的小彩蛋/cy

写题解很慢，球球点个赞/kel