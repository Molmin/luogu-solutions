### *[CF1810H Last Number](https://www.luogu.com.cn/problem/CF1810H)

找点规律。

打表发现问题分成两部分：第一部分的 $S_{\min} = i$，第二部分的 $S_{\min}$ 等于上次操作的结果。设 $p$ 为第一次 $2S_{\min} \geq S_{\max}$ 的操作，那么 $1\sim p$ 为第一部分，$p + 1\sim n - 1$ 为第二部分。

设 $r_i$ 表示第 $i$ 次操作的 $S_{\max}$，$l_i$ 表示 $S_{\min}$，$d_i = r_i - l_i$，答案即 $r_{n - 1} - (r_{n - 2} - (\cdots - (r_p - l_p)))$。因为 $l_p = p$，所以只要求 $\sum_{i = p} ^ {n - 1} r_i(-1) ^ {n - 1 - i}$ ，这要求我们用优秀的方式描述 $r_i$。

在操作 $1\sim p$ 的部分，$l_i$ 递增，且 $r_i$ 不降，所以一个数最多只会加入 $S$ 一次。注意到第 $i$ 次操作后所有 $\geq d_i$ 的数不会再改变，设这些数为 $T$。考虑随着 $i$ 增大 $T$ 的变化情况：

- 若 $r_i = r_{i - 1}$，相当于往 $T$ 中加了两个 $d_i$。
- 若 $r_i = r_{i - 1} - 1$，相当于往 $T$ 中加了两个 $d_i$ 和一个 $d_i + 1$。

$$
\begin{aligned}
40 - 0 = 40 \quad & T = \{40\} \quad  \\ 
40 - 1 = 39 \quad & T = \{{\color{red} 40}, 39, 39\} \\ 
39 - 2 = 37 \quad & T = \{{\color{red} 40}, {\color{red} 39}, 39, 38, 37, 37\} \\ 
39 - 3 = 35 \quad & T = \{{\color{red} 40}, {\color{red} 39}, {\color{red} 39}, 38, 37, 37, 36, 36\} \\ 
38 - 4 = 34 \quad & T = \{{\color{red} 40}, {\color{red} 39}, {\color{red} 39}, {\color{red} 38}, 37, 37, 36, 36, 35, 34, 34\} \\ 
37 - 5 = 32 \quad & T = \{{\color{red} 40}, {\color{red} 39}, {\color{red} 39}, {\color{red} 38}, {\color{red} 37}, 37, 36, 36, 35, 34, 34, 33, 32, 32\} \\ 
37 - 6 = 31 \quad & T = \{{\color{red} 40}, {\color{red} 39}, {\color{red} 39}, {\color{red} 38}, {\color{red} 37}, {\color{red} 37}, 36, 36, 35, 34, 34, 33, 32, 32, 31, 31\} \\ 
\end{aligned}
$$

设 $s_i = r_{i - 1} - r_i$，那么 $s_i = 0$ 相当于在 $T$ 末尾加入 $1, 0$，$s_i = 1$ 相当于在 $T$ 末尾加入 $1, 1, 0$。

不断进行操作，得到无限长度的字符串 $s$ 形如 `0 / 10 / 110, 10 / 110, 110, 10, 110, 10 / ...`，其中每一层都是上一层的字符串的 `0` 变成 `10`，`1` 变成 `110`，然后拼接而成。设 $h$ 表示 $s$ 的前缀和，那么 $r_i = n - h_i$。

考虑答案式 $n - h_{n - 1} - (n - h_{n - 2} - (\cdots - (n - h_p - p)))$。

- 当 $n - p$ 是偶数时，答案为 $p - s_{n - 1} - s_{n - 3} - \cdots - s_{p + 1}$。
- 当 $n - p$ 是奇数时，答案为 $(n - h_p - p) - s_{n - 1} - s_{n - 3} - \cdots - s_{p + 2}$。

问题转化为：给定前缀长度 $p$，求 $s$ 的前缀和，前缀奇数位置和，前缀偶数位置和。设 $f_{i, j} = (a, b, c, d)$ 表示从 $i$ 开始迭代 $j$ 次，得到的字符串的长度，和，偶数位置和，奇数位置和。按顺序合并两个四元组 $(a_1, b_1, c_1, d_1)$ 和 $(a_2, b_2, c_2, d_2)$ 时：

- $a = a_1 + a_2$。
- $b = b_1 + b_2$。
- 当 $a_1$ 为偶数时，$c = c_1 + c_2$，否则 $c = c_1 + d_2$。
- 当 $a_1$ 为偶数时，$d = d_1 + d_2$，否则 $d = d_1 + c_2$。

预处理这些信息后容易做到单次查询 $\mathcal{O}(\log n)$。

二分求出 $p$，容易通过 $\mathcal{O}(1)$ 次查询求出答案。时间复杂度 $\mathcal{O}(\log ^ 2n)$。

$p$ 可以类似查询的方式做到 $\mathcal{O}(\log n)$ 计算。时间复杂度 $\mathcal{O}(\log n)$。[代码](https://codeforces.com/contest/1810/submission/209557067)。

实际上 $s$ 就是斐波那契串，那么 $r_i = n + 1 - \lceil\frac i {\phi} \rceil$。将 $\phi$ 用分数近似表示后转化为经典和式：使用类欧几里得算法求解。