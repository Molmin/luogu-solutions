### [Ж-function](https://www.luogu.com.cn/problem/CF1098F)

神仙题目。

的到了一种新的维护方法，将 $x$ 插入到在重链跳到跟的过程中经过的所有点（$\log n$ 个）。

先考虑最暴力的情况，一下用 $s_{l,r}$ 表示子串 $s[l,r]$

$f(l,r)=\sum\limits_{i=l}^r \text{lcp}(s_{l,r},s_{i,r})$。

求 $\text{lcp}(s_{l,r},s_{i,r})$，可以直接上 $SAM$，建出原串的反串，那么 $s_{a,b}$ 和 $s_{c,d}$ 的 $\text{lcp}$ 就是 $\min(len_{a,b},len_{c,d},mx_{\text{lca}(end_a,end_c)})$。

$end_i$ 表示的是在 $parent\ tree$ 上 $end\ pos$ 中包含 $i$ 的最深的节点。

那么式子变为:

$f(l,r)=\sum\limits_{i=l}^r\min(len_{l,r},len_{i,r},mx_{\text{lca}(end_l,end_i)})$。

（$len_{l,r}\ge len_{i,r}$ 可以直接省略）

如果没有取 $\min$ 这玩意就是 [[LNOI2014]LCA](https://www.luogu.com.cn/problem/P4211)。

所以我们用类似的思想，先离线下来。

由于取最小值，可以对于两种情况分别算贡献。

对于每一个询问，将 $l$ 差入到在重链跳到跟的过程中经过的所有点所在的集合中（$\log n$ 个）。作为询问点。

对于每一个点，同理插入到祖先中的关键点上，作为贡献点。
以下询问点为 $x(end_x)$，贡献点为 $y(end_y)$，他们对应的关键点为 $p_{x/y}$，并且 $p_x,p_y$ 在同一重链上。

分成四种情况：

1. $p_x$ 为 $p_y$ 的祖先。此时贡献为 $mx_{p_x}$。
	
    考虑修改限制，让他成为偏序问题。
    
    想要有贡献，那么 $l\le y\le r$ 并且 $mx_{p_x}\le y-l+1$ 。将两者合并: $\max(l,mx_{p_x}+l-1)\le y\le r$。
    
    那么这就是一个二维偏序，第一维是 $dep_{p_y}\le dep_{p_x}$，第二维是 $\max(l,mx_{p_x}+l-1)\le y\le r$。
    
    第一维可以通过扫描线，从重链向上扫，然后枚举询问点，查询在区间内的贡献点个数即可。

2. $p_x$ 为 $p_y$ 的祖先，但是贡献为 $len_{y,r}$。

	和上面基本一样 $mx_{p_x}> y-l+1$。
    
    $l\le y\le \min(mx_{p_x}+l-2,r)$
    
    一样直接二维偏序就好了，直接查询区间和即可。
    
需要注意一点，对于每一个贡献点，如果他插入了 $i$，需要记录具体是从哪个孩子插入的，或者是直接就处于这个点，在求解从 $j$ 来的询问点的时候需要将从 $j$ 来的贡献点删去。

3. $p_y$ 为 $p_x$ 的祖先，贡献是 $mx_{p_y}$。思路也很清晰，或许可以和上面一样直接扫？

	如果直接扫，那么需要枚举 $y$，可以算出 $y$ 对所有询问的贡献，但是这是不行的，我们需要清楚地知道 $y$ 对每一个询问的贡献才能求出答案。
    
    那么能不能反过来从上向下扫？
    
    容易发现，如果还用之前的条件，现在的 $p_y$ 的信息会丢失，因为 $p_y$ 是 $\text{lca}(x,y)$，还需要用到它的信息。
    
    所以把东西拆一下：
    
    $mx_{p_y}\le y-l+1\to l\le y-mx_{p_y}+1$
    
    那么限制就有三个了：
    
    $dep_{p_y}<dep_{p_x},l\le y-mx_{p_y}+1,l\le y\le r$
    
    直接上三维偏序就好了。
    
4. $p_y$ 为 $p_x$ 的祖先，贡献是 $len_{y,r}$。

	和3差不多。
    
    限制是 $dep_{p_y}<dep_{p_x},l\ge y-mx_{p_y},l\le y\le r$。