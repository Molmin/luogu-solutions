感谢这道题让我加深了主席树删除的理解。

先上 2-SAT，暴力建边是 $O(m^2n)$ 的，考虑优化。

首先是 $n$，我们枚举了蚂蚁走过的路径，这是容易优化的，我们采取树剖+线段树~~大概~~可以做到 $O(m^2\log^2n)$ 的复杂度。

然后是 $m^2$，我们枚举了两只蚂蚁，我们希望一只蚂蚁直接对一条路径进行覆盖从而避开。

注意我们需要保证所有的交都能被连边体现，这样指引我们先把**所有蚂蚁**的标记打在对应的路径上（被线段树区间连边）。

发现此时一只蚂蚁无法正常向它的链上连边，因为会出现直接指向自己的自环，有以下的解决思路：

- 抛弃上一步的思路，换一条路子走，我们通过编号的顺序来保证所有有交**且编号成偏序关系的被连边体现**。

  按次序连边并加入蚂蚁的标记，考虑一只蚂蚁 $x$，有 $\forall y<x,xy$ 有交的都被连上了边。

  我们倒着做一次就使得$\forall y>x,xy$ 有交的也被连上了边，也即其他所有蚂蚁连上了边，建图完成。
- 接着上一步的路子走，我们需要做到的是删除，如果你学的够深刻或是你看题解看到了这里：

  **你会知道主席树是可以删除的！** 现在我们的建图就需要它，因为建边是永久性的，删除是暂时的，我们需要可持久化保存版本。
  
  实际上在做 hlcpq 的时候我们利用了这一点，但是那题有其他更精巧的 trick 使得这一小 trick 被我们忽略了。
  
  具体来说我们往主席树对应位置插入一个空节点覆盖原点，得到的版本即**只删除自己这只蚂蚁本身的建图**，直接往**这个版本**上连，完成建图。
- 在此基础上釜底抽薪，我们将原来的树剖丢掉，将一条链拆成两条**到 lca 链**。

  这样的好处是链直上直下，我们只需要在下端插入，上端删除，有上述基础我们是可以删除的。
  
  这样有了更直观的优势：我们自下而上使用线段树合并取代了树剖，将 $\log^2\to \log$。
  
  考虑何时连边，如何连边，我们深知：两条链交仍为链，且直上直下，**且上端必为其中一条链的 lca**。
  
  于是我们在**上端删除后**，立刻进行一次连边即可完成建图。
  
  注意我们为了连完其他所有边，应在完全版本（即未进行删除前的版本）的基础上制造出**只删某一条边的版本**，利用这些版本连边。
  
  再制造全部删去的版本传给父亲，**切忌边删边连**。（机房大讨论在这里挂了一会）
  
以上就是一些常见的连边方式了，有一个细节是需要注意的：一只蚂蚁两条链自身有交。

对于第一种思路，我们采取同一蚂蚁编号的链一起连边一起加的策略可以避免。

对于后面的思路，既然我们可以删除，不妨删除整只蚂蚁，也就是把这只蚂蚁所有的链能删的都删了再连边。

------------

以下扯胡是在梦里写的不用看。

感谢 [@feecle6418](https://www.luogu.com.cn/blog/feecle6418/cf1007d-ants)（orzorzorz） 看 CF 官解的先锋精神，感谢机房口胡小分队的大力支持，~~感谢lg市面上两篇口齿不清的题解推动我们思考~~。