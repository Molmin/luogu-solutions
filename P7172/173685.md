大致题意：一棵 $n+1$ 层的树，第 $i$ 层有 $i$ 个结点，树从上往下，从左往右依次从 $1$ 开始编号，第 $i$ 层的结点 $a_i$ 会有两个儿子，同层其它点只有一个儿子，儿子从下一层的最左结点开始依次分配，$q$ 次询问两个点的最近公共祖先，**强制在线**。

$1\leq n,q\leq 2\times 10^5$。

首先考虑这棵树里会有很多的直链，即这条链上的点除了链尾都只有一个儿子。如果我们用链尾结点代替这条直链，保留连通性建树，那么树的点数为最后一层的 $n+1$ 个点以及向上 $n$ 层每层新增的一个点，即 $2n+1=O(n)$。

思考这棵树的性质，我们发现询问的答案要么是其中一个点，要么是一个链尾，所以我们如果实际建出了这棵树，并能查询每个点对应的直链编号，那么就可以方便地回答询问。

考虑一个朴素的过程，对于每一层点分别维护它们对应的直链编号，观察自底向上维护的时候的更新可以发现，从第 $i+1$ 层到第 $i$ 层，只有第 $i$ 层的特殊结点和它后面的一个位置的编号合并成了一个新的编号，即只有 **单点删除，查询第 $k$ 个没被删除的元素，单点修改** 三种操作，这个过程可以用经典的主席树来解决。

于是这题就做完了，时间复杂度 $O(n\log n+q\log n)$。

[代码](https://www.luogu.com.cn/paste/g6gk92b6) 不到 100 行，不到 3kb，极其好写。