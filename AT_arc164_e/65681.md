考场看错题了/fn/fn/fn

考虑转化一下构建线段树的过程，构造一条 $n$ 个点的链，假设当前区间为 $[l,r]$，深度为 $dep$，选取的分割点为 $mid$，则我们给 $mid\to mid+1$ 的边 $dep$ 的权值，并断开这条边。

那么区间查询 $[l,r]$ 时访问到的最深深度即为 $l-1\to l$ 的权值和 $r\to r+1$ 的权值的最大值。

先考虑第一问，对于一次区间查询 $[l,r]$ 我们给第 $l-1$ 条边和第 $r$ 条边打上标记，显然我们只需要考虑打过标记的边，记这些边数量为 $cnt$，则我们只需要考虑由这 $cnt$ 条边组成的 $cnt+1$ 个点的链。

不难发现 $d=\lfloor\log_2cnt\rfloor+1$，即对这 $cnt$ 条边建立正常的线段树（以线段中点为分割点）。

再考虑第二问，此时我们需要确定哪些边的权值是 $d$，倒着考虑构建线段树的过程，显然给一条边权值 $d$ 相当于把左右两个线段树节点合并为一个节点，那么我们需要不断合并直到剩余节点能用 $d-1$ 层线段树表示，假设我们给 $i$ 条边权值 $d$，则 $i$ 需要满足 $\lfloor\log_2(cnt-i)\rfloor+1<d$。

此外，根据构建线段树的过程，相邻两条边的权值一定不同，所以我们问题就转化为了从 $cnt$ 条边里选 $i$ 条边，其中 $\lfloor\log_2(cnt-i)\rfloor+1<d$ 且相邻两条边至多选一条，要求这 $i$ 条边的标记数量和最小。

记 $f_{i,j,0/1}$ 表示前 $i$ 条边，选了 $j$ 条，当前边选/没选的最优值，转移显然。

时间复杂度 $\mathcal O(n^2+q)$。