# [ABC277G] 题解

## Random Walk to Millionaire

### 题目大意

给定一张 $n$ 个点，$m$ 条边的有向图，每个点有两种类型：经验池和副本。有一个人一开始在 $1$ 号节点，等级为 $0$ 。现在他进行恰好 $k$ 次随机游走操作，一次随机游走操作定义为：从所在点的所有出边中等概率选择一条出边走出去。如果目标点是经验池，则等级 $+1$ ，否则若当前等级为 $X$ ，获得 $X^2$ 个金币。求最后的金币期望值。$n,m,k \leq3000$。

### 题目解析

观察数据范围，感觉大概是一个 $O(n^2)$ 的做法。挺套路的一个题。不过这里可不能使用求所有的和，再除方案的方式，因为每一种走法的概率不是平均的。

看一下题目中的金币获取方式，是一个平方，感觉不好处理，不难想到类似于 `OSU!` 这种题，我们拆贡献。

具体的，我们从后向前考虑，假设我们已经知道了这 $k$ 次随机游走的具体方案，每次考虑经过一个经验池升级之后带来的影响。设我们在经过这个点之后经过的所有副本点和不考虑这个点和之前的所有经验点所的等级构成的有序对 $(x,l)$ 构成的集合为 $S=\{(x_1,l_1),(x_2,l_2),\cdots,(x_t,l_t)\}$，在不考虑当前经过这个经验池的时候，这些副本点得到的金币总和为：$\sum\limits_{i\in[1,t]} l_i^2$ ，而将这个点的等级加上之后得到的金币总和为 $\sum\limits_{i\in[1,t]} (l_i+1)^2=\sum\limits_{i\in[1,t]} l_i^2+\sum\limits_{i\in[1,t]} 2l_i+t$ ，所以我们对于一种方案只需要知道每一步的 $\sum\limits_{i\in[1,t]} l_i^2,\sum\limits_{i\in[1,t]}l_i,t$ 即可，由于这里使用的是加和，所以期望也可以直接这么求。所以我们需要知道的是三件：每个点出去走 $k$ 步的期望金币数量，期望副本等级和，期望副本数量即可。

我们分别设其为 $dpsq_{u,k},dps_{u,k},dpc_{u,k}$。对于经验点，我们有：

$dpsq_{u,k}=\frac{\sum \limits_{v\in Son_u} dpsq_{v,k-1}+2\times dps_{v,k-1}+dpc_{v,k-1}}{|Son_u|}$

$dps_{u,k}=\frac{\sum \limits_{v\in Son_u} dps_{v,k-1}+dpc_{v,k-1}}{|Son_u|}$

$dpc_{u,k}=\frac{\sum \limits_{v\in Son_u} dpc_{v,k-1}}{|Son_u|}$


而对于副本点，我们有：

$dpsq_{u,k}=\frac{\sum \limits_{v\in Son_u} dpsq_{v,k-1}}{|Son_u|}$

$dps_{u,k}=\frac{\sum \limits_{v\in Son_u} dps_{v,k-1}}{|Son_u|}$

$dpc_{u,k}=\frac{\sum \limits_{v\in Son_u} (dpc_{v,k-1}+1)}{|Son_u|}$


最后的答案就是 $dpsq_{1,k}$ ，但是需要注意的是，如果第一个点是经验池，他并不会升级，因为升级和打副本只发生在随机走出边之后。这部分可以考虑把第一个点在 **刚开始的时候** 视为一个副本，反正是零级不会影响答案。不过后面的时候再经过要正常升级了。

### CODE

太难看了，而且定义写的很诡异，不贴了。感觉讲的还是不模糊的。

