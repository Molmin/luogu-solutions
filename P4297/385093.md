## [网络收费](https://www.luogu.com.cn/problem/P4297)

发现题目中的贡献方式是以点对给出的，点对这个东西非常恶心，我们尝试把贡献放到点对中单独的点上。

我们尝试把每个非叶节点也分为 A,B 两种节点，如果非叶节点 $u$ 管辖的叶节点中 A 节点的个数  $n_A$ $\ge$ B 节点的个数 $n_B$，则把该非叶节点令为 A 节点，否则令为 B 节点。此时再看题目给出的计算贡献表格，发现对于叶节点 $i,j$，若 $LCA(i,j) = P$，若 $i$ 与 $P$ 异色则贡献一个 $F(i,j) $，若 $j$ 与 $P$ 异色则再贡献一个 $F(i,j)$，则叶节点 $i$ 对于其祖先 $P$ 的贡献 $f_{i,P}$ 即：

$f_{i,P} = \sum F_{i,j} (LCA(i,j) = P \land \text{i,P异色})$。

这个时候考虑 dp 来计算最小贡献，第一个问题不是设计状态，而是 dp 的顺序。

第一时间想到把叶子序列拿出来一个一个考虑要不要反色，显然不行。因为具有后效性，某个叶子对它的某个祖先的贡献可能受到后面叶子是否反色的影响。

果然还是得靠着这个树的结构去 dp，想到用 $dp_{u,i}$ 表示 $u$ 点子树内有 $i$ 个 A 号点的最小代价，开始想到这个的时候很兴奋，因为这样轻松地确定了 $u$ 点的颜色。但是当时思考的时候仍限于一般树形 dp 的套路，想的是 $u$ 点的答案通过 $u$ 点的左右子树的答案之和再加上 $u$ 的贡献。但是从非叶节点是很难计算贡献的，因为没走到树的底端时是没办法知道叶子的颜色的。所以仍然只能在叶子处计算答案。

那么我们汇总一下信息：

1.贡献只能在叶子处计算。

2.非叶节点的颜色可以通过 dp 的第二维确定。

3.叶子节点计算答案时所需要的信息只是它的祖先 $P$ 的颜色和它是否相同，与另一个叶子节点 $j$ 的颜色没有关系。

4.树的层数最多区区 $n$ 层，而 $n \le 10$。

正解呼之欲出。

在 dfs 的时候用一个二进制数记录根到当前点路径上的点的颜色状态，就可以在叶子节点处完美计算出 $dp_{u,0}$ 和 $dp_{u,1}$，几乎已经做完了。

但是这个 dfs 和以往有所不同，因为 dfs 的时候记录的信息随着 dp 的第二维变化，就会想到要不要在循环的过程中递归调用 dfs，但是这样血炸。仔细一想唯一可能发生变化的也就只有最右链的颜色状态，而且也就两种情况，可以只 dfs 两次。

dp 的部分相对容易，$dp_{u,i} = \min\{dp_{lc(u),j} + dp_{rc(u),i - j}\}$

需要注意的是枚举 $j$ 之前要先把 $dp_{u,i}$ 重置为初始值，因为需要保证 $dp_{lc(u),j}$  和 $dp_{rc(u),i - j}$ 都是在这次的颜色状态下计算出来的值，不能受到之前状态的影响。