对于题解中时间复杂度为 $O(kmc^2)$，其中 $c$ 是颜色数，我提供一种复杂度为 $O(k^\epsilon c^3+mc^2)$ 的做法。

我们把答案拆成关键点和关键点到链上所有点的贡献和其它的贡献，其中第二部分是好算的，答案就是 $4^\text{点的个数}$。

对于第一部分，建立出虚树，这里的虚树指包含所有的 $m$ 个点和他们的 $\text{LCA}$ 的最小点集，显然虚树的点数是 $O(m)$ 的。

我们用 $f_{i,j}$ 表示第 $i$ 个点染色 $j$ 的方案数，用 $g(i,j)$ 表示颜色 $i, j$ 是否能相邻。那么对于 $i$ 的孩子 $v$，$f_{i,j} = f_{i,j}\sum_{g(j,k)}f_{v,k}$，我们发现转移中只有虚树上的点是可能不平凡的，其它的转移都是一样的，我们发现这个转移是一个乘上矩阵的形式，所以说虚树上点和点间的的那条链的转移可以用矩阵幂运算维护，预处理好这个矩阵的幂就可以做到 $O(k^\epsilon c^3+mc^2)$。