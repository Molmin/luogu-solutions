题目中关于路径的限制特别强。容易发现有至多 $n$ 条可能合法的路径。

我们不妨考虑对每个点所在的合法路径存起来，这样看上去是一个二分图，看上去不太可做。所以考虑从原图是个树入手，看看有没有什么好的性质。

我们将所有的合法路径建一个点，原本的点都建一个点，然后每个点与所有它所在的路径对应的点连边。

然后会发现这个二分图实际上也是一个树/森林。因为如果这不是一棵树/森林，相当于有环的出现，那么原图上也一定会有个环。这就矛盾了。

对于每棵树，将一个原树上的点作为根，那么能保证每个路径只有唯一的一个父亲。我们用每个父亲搞一个支持单点修改和整体修改的数据结构去管辖它的儿子。这样，所有路径都能被唯一的点所管辖。

修改的时候，考虑对一个点管辖的儿子整体加减，对父亲的父亲单点修改即可。然后拿一个堆或者 multiset 维护每个点管辖的可用的儿子的最大值即可。

https://codeforces.com/contest/1787/submission/192148553