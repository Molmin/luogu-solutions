[更好的阅读体验](https://www.cnblogs.com/eastcloud/p/17279237.html)

简单概括一下题目：询问有多少组边集，满足原图删去后分为若干个联通块，联通块大小的极差不超过 $k$，如果存在一条边 $(u,v)$，被删除了，称 $u$ 和 $v$ 为删除点（并没有删除，只是这么叫），图还得满足每个联通块只有一个删除点。

先考虑题目中的极差，对于 $k=0$ 的情况，连通块大小肯定是 $n$ 的因子，而 $k=1$ 时连通块的大小也只能是 $\lfloor \frac{n}{s} \rfloor$ 和 $\lceil \frac{n}{s} \rceil$ 的（$s$ 为 1 到 $n$ 之间任意一个整数），结合整除分块的相关知识可以知道所有可能的联通块大小只有不超过 $2\sqrt n$ 种，这复杂度加个线性还在我们的接受范围之内，继续考虑其他条件。

再先考虑有关删除点的条件，这个条件只与点有关，而且考虑边的话解的判断和求解不太好实现，于是试着把删除边转化为选择点，这里的选择指的是找到一些点放到一个联通块里。

类似 dp 中构造转移方程，考虑在已有点的情况下还需要和还可以加入哪些点，首先，我们发现如果存在两个点在已选择的点集内，且都有向外连的边，设其为 $(a,b)$ 和 $(c,d)$，那么 $c$ 与 $d$ 我们一定要选择一个点，否则就会导致删除点不只一个。

若 $c$ 与 $d$ 是同一个点怎么办呢？这等价于存在一个点有两条不同的到达选择的点集的路径（只用终点不同就行），可以看出这个点也必须选择。前面的表述是否有些熟悉？这与我们对点双连通分量的定义有些相似，把它套进去可以发现对于一个点双中的点，只要有两个被选到同一个联通块，其他点也必须选到那个联通块中。

点双和选择问题，自然的想到建出圆方树进行 dp 处理，我们设 $siz_u$ 表示子树 $u$ 的圆点个数，$f_u$ 表示子树 $u$ 能单独形成合法解（能被分成若干个满足上述条件的联通块）的合法解的数量，设计转移方程：

如果 $u$ 是圆点：

* $siz_v < siz_u$，此时肯定不能把 $v$ 单独割下来，使 $tot$ 变为 $tot+siz_v$。

* $siz_v = siz_u$，此时 $v$ 可以割也可以不割，考虑 $f_v$，如果 $f_v=0$，使 $tot$ 变为 $tot+siz_v$，否则使 $cnt$ 变为 $cnt+1$。

* $siz_v > siz_u$，此时必须割 $v$，使 $ned$ 变为 $ned \cdot siz_v$。

$tot$ 初值为 1，可以看到我们记录了很多变量，现在考虑统计答案，首先，如果 $d \leq tot \leq d+1$（$d$  为枚举出的联通块大小），那么 $f_i$ 加上 $ned$，若 $ tot > d $，肯定无解，剩下情况只有 $tot=1$ 时有可能有解，此时答案加上 $ned \cdot cnt$ 表示考虑 $cnt$ 种多余的割还是不割，最多只能不割一个，我们考虑不割哪个后剩下就只有 $ned$ 种情况，二者相乘就得到了结果，注意第二种点既可以合并也可以不合并，第一和第三种情况可以共存，而 $k=0$ 时同理。

对于方点，$f_u = \Pi_{v \in son(u)} f_v $，这个转移方程的意义在于只考虑把每个圆点各自分开的情况，不过可以发现全部合起来的情况会在其父亲圆点那里被考虑，因此不用进行处理。

最后，我们还差一个根节点没有确定，由于我们对于状态的特殊定义，根节点若是圆点，必须是对应联通块的删除节点，若是方点，子节点必须全部分割，可以发现重心刚好符合我们的要求，若其不是删除节点，那么该联通块要么有不止一个删除节点，要么对应联通块大小肯定大于 $\frac{n}{2}$，若是方点则同理。

由于常数较大，我们还需要加入一点剪枝，例如，当 $siz_u<d$ 时不进行处理，当 $siz_u>d$ 且 $f_u=0$ 时直接无解等，于是此题得到解决。