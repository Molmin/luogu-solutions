有删减，原文见[**我的博客**](https://www.cnblogs.com/SharpnessV/p/14872855.html)。

值得一想的构造题（评分虚低？

先考虑第一问，求总代价最小。

对于叶子节点，它可以和它的父节点交换。

但是它有的兄弟节点是叶子，而父节点只有一个。

我们将所有兄弟节点排成一行，那么第 $i$ 个点移动到第 $i+1$ 个节点，父节点移动到第 $1$ 个节点，最后一个节点移动到父节点。这正好是一个满足条件的偏序。手算一下也不难得到如果有节点移动到父节点和兄弟节点之外的节点，一定不会使答案更优。

第二问，求总代价最大。

考虑对每条边计算贡献，假设一条边两侧的子树大小分别为 $sz_a,sz_b$ ，那么对这条边对答案的最大贡献为 $2\times \min\{sz_a,sz_b\}$ 。

很好理解，如果两侧子树相等，则两两互换可以卡满上线。否则最多互换 $\min$ 对，贡献为两倍 $\min$ 。

所以我们想着构造一种方案使得每条边都达到上线。

如果存在一条边，两侧子树大小都是 $\dfrac{n}{2}$ ，那么两两配对即可。

但是这样的边不一定存在。$\dfrac{n}{2}$ 这个数提供了一个新的思路，我们可以考虑割掉一个点，那么重心无疑是最优的选择，对于割掉重心后每棵子树的大小都不大于 $\dfrac{n}{2}$ 。

那么这就是一个经典问题！我们一定可以两两配对使得每一对的两个点属于不同的子树。

用堆维护当前最大的子树，每次选择最大的子树和次大的子树中个一个点配对即可。注意 $n$ 为奇数时需要特判。

时间复杂度 $\mathcal{O}(N\log N)$ 。