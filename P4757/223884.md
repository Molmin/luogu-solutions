考虑每一条路径 $(u, v)$ ，在其 LCA 处创造贡献。

设 $dp_u$ 表示以 $u$ 为根节点的子树的最优解，$f_{u, v}$ 表示以 $u$ 为子树时，去掉 $(u,v)$ 这一整条路径的最优贡献。

那么有
$$
f_{u, v} = f_{w'_v, v} + sum_{u, w'_v}
$$
其中 $w$ 表示 $u$ 的子节点， $w'_v$ 表示在 $(u, v)$ 这条路径上的一个 $w$ ， $sum_{u, w_v'}$ 表示去掉这个 $w'_v$ 子树时对于 $u$ 子树的最优解。

考虑每个路径对 $dp_{lca}$ 的贡献，就是 $f_{w'_u, u} + f_{w'_v, v} + 1$ ，当然，如果有根节点为 $w$ 的子树没有路径有贡献，那么贡献就为 $dp_w$ 。

显然，两路径若不能同时出现时，两条路径的四个端点不能有两个出现在同一个子树中。

由于每个点的度数很小，可以直接暴力状压 DP ，枚举每个子树的状态和每条路径，这样总复杂度是 $\mathcal{O}(m 2 ^ d)$ ，在最不科学的时候可以达到 $5\times 10 ^ 8$ 还大的级别，非常玄。

可以改变一下枚举对象，每次枚举两个子树，若两个子树中分别有点能连成一条链相连，就可以取其中最大值转移了，时间复杂度变成了 $\mathcal{O}(\sum d_u ^ 2 2 ^ d)$ ，在极为不科学的情况下，可以达到 $10 ^ 8$ ，可以卡过。

发现状压 DP 顺便解决了上述 $sum$ 的问题，问题得到解决。

由于查询 LCA 的次数是 $\mathcal{O} (n ^ 2)$ 级别的，所以用 ST 表求 LCA 的效率更高。

时间复杂度 $\mathcal{O}(n\log n + n ^ 2 + m + \sum d_u^ 2 2 ^ d) = \mathcal{O}(n ^ 2 + \sum d_u^ 2 2^d)$ 。