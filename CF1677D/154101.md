首先，设 $\sum\limits_{j=0}^i[p_j>p_i]=f_i$，那么 $0 \le f_i\le i-1$，并且 $f$ 序列与排列一一对应。

然后对于每一次冒泡操作，相当于 $f_i=\max(f_{i+1}-1,0)$，那么 $k$ 次操作相当于 $f_i=\max(f_{i+k}-k,0)$。然后就很好做了。

具体的，对于 $1\le i\le k$，每个 $i$ 都能选 $[0,i-1]$，共 $i$ 钟选法。剩下的情况，若 $a_{i-k}=0$ 则能选 $[0,k-1]$，共 $k$ 种选法。若 $a_{i-k}=-1$，那么能选 $[0,i-1]$，共 $i$ 种选法。否则的话就是一个定值，共 $1$ 种选法。

注意判一下不合法，就是后 $k$ 个数不能出现 $>0$ 的数，如果出现了答案就是 $0$。

[赛时代码](https://codeforces.com/contest/1677/submission/156345926)，其实挺短的...