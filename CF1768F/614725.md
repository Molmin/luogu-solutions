这题，太优美了。

首先 $O(n^2)$ 的朴素 DP 是显然的：设 $dp_i$ 表示跳到第 $i$ 个位置的最小步数，则有：$dp_i=\min\limits_{1\le j< i}\{dp_j+(j-i)^2\times T\}$。其中 $T=\min\limits_{j\le k\le i}\{a_k\}$。

这个东西看上去很玄，由于最小值的存在很难用数据结构维护或是斜率优化等东西。因此只能考虑减少冗余转移。

但是看到 $a_i$ 的值域是 $[1,n]$，说明肯定要利用这个东西了。

考虑什么样的 $i\to j$ 转移可能最优。显然，其花费必须不大于一步一步跳的花费。利用值域放缩之后化简得到 $\min\limits_{j\le k\le i}\{a_k\}\le \frac{n}{i-j}$。看到这个结果，你想到了什么？显然根号分治。我分类讨论：

* $(i-j)\leq \sqrt n$

决策不多，直接暴力转移即可。

* $(i-j)\ge \sqrt n$

可以发现此时 $\min\limits_{j\le k\le i}\{a_k\}\leq \sqrt n$。首先有一个结论：若 $i\to j$ 一步转移最优，则取最小值的 $k$ 一定不能位于 $(j,i)$，否则分两步 $i\to k\to j$ 转移更优，这个容易计算。

那么，就只能是 $k=j$ 或 $k=i$ 取最小值了，仍然分类讨论：

若 $k=j,$ 则 $a_j\leq \sqrt n$。此时我们记录所有位于 $[1,\sqrt n]$ 的数上一次出现的位置，枚举转移。

若 $k=i,$ 则 $a_i\leq \sqrt n$。我们从后往前枚举 $j$，直到 $a_j\leq a_i$。这样暴力，使得每一个位于 $[1,\sqrt n]$ 的数 $v$ 都至多一共扫描 $n$ 次，均摊下来单次转移 $O(\sqrt n)$。

总时间复杂度 $O(n\sqrt n)$。[代码](https://codeforces.com/contest/1768/submission/209281531)。