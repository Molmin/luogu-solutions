提供一个思路直接的其他做法。

首先特判 $m=1$ 此时可以直接用 $\text{set}$ 维护还没有加入的 $a$ 数组内的数，修改直接暴力加入，然后用线段树维护即可。

其他情况 3e5 明示根号。

令 $b$ 为 $a$ 排序的结果。

对于集合大小根号分治：

大集合考虑沿用上面的做法，但是会多一个 $\log$。于是我们将值域分块，散块暴力，整块判断一下是否存在没有加入的数，如果没有就暴力加入所有数，然后线段树改成一个 $O(1)-O(\sqrt n)$ 的分块。

小集合考虑操作只有根号个，所以值域可以分成 $O(\sqrt n)$ 段，每一段的加入时间一定相同，我们先预处理出这些值域段以及在 $b$ 中的区间。加入一个段的时候，我们将 $b$ 序列分块，散块暴力加入（仍然是 $O(1)-O(\sqrt n)$ 的分块），整块打标记，在询问的时候枚举每个整块计算贡献。

但是你会发现计算整块贡献的时候需要 $O(n\sqrt n)$ 空间，我赛时就被卡空间了！！！1

我们可以对于每个值域块，将其在序列中出现位置排序，然后建一个分散层叠，使用分散层叠 $O(\sqrt n+\log n)$ 大力计算询问区间左端点和右端点在每个值域块的后继即可做到线性空间。

代码很丑也很长，就不放了。

