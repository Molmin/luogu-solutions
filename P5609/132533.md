感觉想到了还是不难的一道题。               

首先我们不难发现 $n,m$ 的数据范围为 $10 ^ 6$ 和 $2 \times 10 ^ 5$，猜测时间复杂度为 $O(n \log n + m \log ^ 2 n)$ 类似的东西。          

原问题可以拆分为若干个子问题的复合，定义一个子问题如下：一个数 $v$ 通过区间变成数 $w$。               

那么不妨考虑维护 $v$，这是一个经典的套路。                 

仔细分析一下这个东西，我们发现对于一个固定的区间 $[l,r]$，我们可以将值域划分为若干段，使得任意一个属于一个段的值 $v$ 跑一遍这个区间得到的值可以表示为 $v + sum_{l,r} - k \times p$，其中 $k$ 对于每一段固定，并且值域段上的 $k$ 单调递增。                         

由于对于一个区间 $k$ 只会有 $r - l + 1$ 种，所以直接开线段树维护一下线段树上所有区间的分段情况就好了，合并的话就类似分段函数的复合，用双指针扫就好了。                  

这样预处理的时间复杂度是 $O(n \log n)$。                

查询的话将 $\log$ 个线段树节点从左到右依次遍历一遍，二分找到应该被减去的 $k$ 的大小后模拟一遍即可。              

最终时间复杂度 $O(n \log n + m \log ^ 2 n)$。