一张 $n$ 个点的有向图，点从 $0\sim n-1$ 编号，初始对于 $0\leq i\leq k-2$，有边 $i\to i+1$，前 $k$ 个点称为关键点。$m$ 次操作在图中加入一条有向边，你需要回答加入之后图中是否存在包含至少一个关键点的环，强制在线。

子任务：$n\leq 3\times 10^4$，$m\leq 5\times 10^4$，$k\leq 10^3$。

$n\leq 3\times 10^5$，$m\leq 3\times 10^5$，$1\leq k\leq n$。2s。

1. 关注这条链的特殊性：动态判图中是否存在环是困难的。是困难的。是困难的。

   对于每个点 $u$，$u$ 能到这条链上的一个后缀，设后缀起点为 $R_u$；这条链上的一个前缀能到 $u$，设前缀终点为 $L_u$。则如果出现了 $L_u\ge R_u$，那么存在环 $u\to R_u\to L_u\to u$。注意到 $L,R$ 的值域是 $O(k)$ 的，于是暴力维护这个过程，势能分析是 $O((n+m)k)$ 的（每个点只会在被更新时遍历，每条边只会在某个端点被更新时遍历）。

2. 直观想法是减少关键点的数量，所以可以考虑对关键点分块，如果只维护 $L,R$ 所在的块，那么相当于只有 $O(\sqrt k)$ 个关键点，根据上面的势能分析，复杂度是 $O((n+m)\sqrt k)$ 的；但是当 $L,R$ 在同一个块时，我们需要知道其具体节点编号以判断是否有环。这个可以当 $x,y$ 中的某一个从不在同一块到在同一块时，暴力地搜索有用的点。例如 $x$ 的区间是 $[S,R]$，$y$ 的区间是 $[L,S]$ 时，会被合并成 $[S,S]$，那么从 $y$ 出发，在原图上搜索：如果是 $[L',S]$ 的区间则继续搜；如果是 $[S,S]$ 的区间那么已经有具体编号了，可以直接继承，不用继续搜。搜到的点都会被更新成在同一块内的情况，也就是这部分均摊到每个点上也是 $O(1)$ 的。反图上同理。这样对于在同一块内的情况我们也暴力更新，这部分也是 $O((n+m)\sqrt k)$ 的。

3. 如何再拓展呢？上面的做法让我们更加关心区间 $[L_u,R_u]$ 信息。不妨讨论一下区间之间的关系，发现产生环的情况的必要条件是两区间无交，有交时虽然产生一些更新，但是不会直接导致环的产生。所以我们需要一个能够判断区间是否不交，维护有交时更新的结构。一个想法是，肯定不能维护完整的 $L,R$ 的值的信息，突破口在于查询只需要判断区间是否一定不交。这样就能产生一个分治结构：把区间放在第一个跨过中点的分治区间，也只记录其对应的分治区间端点 $p_u=[l_u,r_u]$，那么对于边 $x\to y$，产生环的情况即为 $r_y\leq l_x$，否则如果 $p_x$ 在 $p_y$ 的右子树，那么 $p_y$ 会向右分治区间至少走一步；如果 $p_y$ 在 $p_x$ 的左子树，$p_x$ 会向左分治区间至少走一步。由于“走一步”这样的更新次数是 $O(n\log k)$ 的，所以可以暴力每次只走一步。至此可以看作是只有 $O(\log k)$ 次更新的原问题，势能分析自然是 $O((n+m)\log k)$ 的。
4. 有了正解再回首观察直接的分块做法，本质就是层数比较少，或者说儿子数比较多的分治，“确定具体编号”这一步实际上是在找它应该被挪向哪一个儿子，但由于没有比较明显的分治结构，找起来反而是比正解更麻烦的。于是两个做法本质上是相通的。
5. 整体的思考流程是 $k$ 比较小引出势能分析的 $O((n+m)k)$ 做法，再为了减少关键点引出分块的 $O((n+m)\sqrt k)$ 做法，最后重点关注区间信息，讨论需要支持什么操作，导出分治结构引出正解。

[code](https://www.luogu.com.cn/paste/cv48uqwe)

