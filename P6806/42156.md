我不会做题，我只是英文题解的翻译工

------

以下认为 $n=R,m=C$。

我们只解决 K 的情况，因为其他题解已经把另外几个说得很详细了。

首先，因为 $n\ge m$，第一问答案一定是 $n-1$。

既然第一问答案一定是 $n-1$，那每一步一定要么向右，要么向右上，要么向右下。可以写出朴素 dp，设 $f_{i,S,j}$ 为 $(1,S)$ 走到 $(i,j)$ 的方案数：

$$
f_{i,S,j}=\left\{
\begin{aligned}
f_{i-1,S,j-1}+f_{i-1,S,j}+f_{i-1,S,j+1}\ (1<j<m)
\\
f_{i-1,S,j}+f_{i-1,S,j+1}\ (j=1)
\\
f_{i-1,S,j}+f_{i-1,S,j-1}\ (j=m)
\end{aligned}
\right.
$$

矩阵快速幂优化 dp 即可通过 $m\le 100$ 的测试点。

注意到瓶颈在于矩阵乘法，考虑优化矩阵乘法。

又注意到矩阵快速幂时本质上只用到了以下两种乘法：

$$A^n\to A^{n+1},A^n\to A^{2n}$$

只需分别优化。第一种显然可以 $O(m^2)$ 搞定，因为 $A$ 中有值的只有 $O(m)$ 项。问题在于第二种。

观察发现以下几个结论：

1. 任意 $n$，$A^n_{i,j}=A^n_{j,i}$（显然）
2. 任意 $n$，$A^n_{i,j}=A^n_{m-j+1,m-i+1}$（显然）
3. 任意 $n$，若 $i+j-1\le m$，则 $A^n_{i,j}=A^n_{i-1,j-1}+A^n_{1,i+j-1}$

假如结论都成立，那我们只用求出 $A^{2n}$ 的第一行、第一列，就可以直接递推出整个矩阵了。这样，$A^n\to A^{2n}$ 的变换可以 $O(m^2)$ 完成，整个题也就可以 $O(m^2\log n+q)$ 解决了。怎么证明第三条结论呢？

考虑归纳法，先证明 $i=2$ 成立：

因为 $A^{n+1}_{1,i}=A^{n+1}_{i,1}$，所以 $A^n_{1,i-1}+A^n_{1,i}+A^n_{1,i+1}=A^n_{i,1}+A^n_{i,2}$。

又因为 $A^n_{1,i}=A^n_{i,1}$，所以 $A^n_{i,2}=A^n_{1,i-1}+A^n_{1,i+1}=A^n_{i-1,1}+A^n_{1,i+1}$。

然后证明 $i$ 成立推出 $i+1$ 成立，过程和上面类似，对 $A^{n+1}_{i,j}$ 算两次即可，留作习题。