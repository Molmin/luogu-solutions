这题居然是之前某场模拟赛（contest 701）的 T1……（@Vidoliga 场切但是被卡常/bx）

下面记 $m$ 为原题面中的 $K$，$a_i$ 为原题面中的 $P_i$。

不难发现后手的策略是把所有段按照段的第一个数从大到小排序接在一起。

考虑若 $a_1 \le m$，则先手能把所有 $\le m$ 的数都作为段头。

若 $a_1 > m$，操作后的排列字典序一定大于等于原排列（后手可以选择不动）。于是先手想让与原序列的 $\text{LCP}$ 尽量大。

预处理出以 $a_1$ 开头，$a_i$ 结尾的 $\text{LDS}$，记为 $f_i$。考虑枚举 $i$，那么 $i$ 和 $i$ 前面有 $f_i$ 个元素可以作为段的开头，设它们为 $1 = p_1 < p_2 < \cdots < p_{f_i} = i$，则后面还需要 $m - f_i$ 段。找到后面第一个位置 $k$ 使得 $\sum\limits_{x=k+1}^n [a_x < a_i] = m - f_i$，那么 $k$ 就是前面分成 $f_i$ 段 $p_1 \sim p_{f_i}$ 这种方案的 $\text{LCP}$。注意如果 $\text{LCP}$ 相同，则先手想让 $k + 1 \sim n$ 还需要分的段尽量少（即 $m - f_i$ 尽量小）。

找 $k$ 可以使用主席树+二分，因此时间是 $O(n \log^2 n)$ 的。

[code](https://atcoder.jp/contests/arc114/submissions/40816234)