# **逆序对**

**Key Observation**：一个排列 $\{a\}$，任意交换两个位置 $p_1,p_2$ 上的数，逆序数奇偶性改变（$p_1\neq p_2$）.

证明：

不失一般性，令 $p_1<p_2$ .

当 $p_2=p_1+1$ 时（交换相邻的两个数），这一对数相对顺序改变，所以逆序数加一或减一，于是奇偶性改变 .

下面把一次交换相邻的两个数称作一次「操作」.

若不然，令 $l = |p_1-p_2|-1$，则可以先通过 $l+1$ 次操作把 $p_1$ 移动到 $p_2$ 位置上，此时原先 $p_1+1\dots p_2$ 位置上的数全部左移一位 .

于是再用 $l$ 次操作就可以将 $p_2$ 移动到 $p_1$ 位置上，共用 $2l+1$ 次操作 .

例如：

排列 `1 8 2 5 7 3 6 4`，要交换 8 和 3，具体步骤如下：
1. 交换第 2, 3 位，排列变成 `1 2 8 5 7 3 6 4` .
2. 交换第 3, 4 位，排列变成 `1 2 5 8 7 3 6 4` .
3. 交换第 4, 5 位，排列变成 `1 2 5 7 8 3 6 4` .
4. 交换第 5, 6 位，排列变成 `1 2 5 7 3 8 6 4` .
5. 交换第 4, 5 位，排列变成 `1 2 5 3 7 8 6 4` .
6. 交换第 3, 4 位，排列变成 `1 2 3 5 7 8 6 4` .
7. 交换第 2, 3 位，排列变成 `1 3 2 5 7 8 6 4` .

而根据前面的推导，我们知道交换奇数次逆序数奇偶性一定改变 .

命题获证 .

***

于是我们考虑一次区间翻转对于排列 $\{a\}$ 逆序数 $N(a)$ 的影响 .

设翻转区间长度为 $n$，则：
- 当 $n=2k$（$k\in\mathbb N_+$）时，显然可以将翻转换为 $k$ 次交换 .
- 当 $n=2k+1$（$k\in\mathbb N_+$）时，同样也可以将翻转换为 $k$ 次交换 .

于是有翻转后序列的逆序数满足 $N(a')\equiv N(a)+\left\lfloor\dfrac k2\right\rfloor\pmod 2$ .

于是区间翻转对于排列逆序数的影响就被解决了 .

***

于是，1 操作（区间交换）可以拆成 4 次区间翻转操作 .

具体的，若交换区间 $[l_1,r_1],[l_2,r_2]$（$l_1\le r_1< l_2\le r_2$），则可以依次翻转区间 $[l_1,r_2]$，$[l_1,l_1+r_2-l_1+1]$，$[l_1+r_2-l_2+1,r_2-r_1+l_1-1]$（若 $l_2=r_1+1$，则不翻转这个），$[r_2-r_1+l_1,r_2]$

大概就像这样（下面是 $l_2\neq r_1+1$ 的情况）：
```plain
A : [l1, r1] ; B : [r1+1, l2-1] ; C : [l2, r2]

 A  B  C    原始序列
~C ~B ~A   第一次操作后（~L 表示原来 L 区间翻转过来）
 C ~B ~A   第二次操作后
 C  B ~A   第三次操作后
 C  B  A   第四次操作后
```

于是 1 操作对于逆序对的影响解决，2 操作是 1 操作的特例，自然也解决（将 $[l,r]$ 向后移动到第 $k$ 个数字与第 $k+1$ 个数字之间可以看做交换区间 $[l,r]$ 和 $[r+1,k]$）.

3, 4 操作是平凡的，考虑在排列 $\{p\}$ 的开头插入一个数 $x$，它对逆序数的贡献必然为 $\{p\}$ 中比 $x$ 小的数的数量，这个可以树状数组维护 .

在末尾插入（4 操作）可以换成一次全局翻转和一次 3 操作然后再全局翻转一次 .

于是所有问题被解决，时间复杂度 $O(q\log n)$ .