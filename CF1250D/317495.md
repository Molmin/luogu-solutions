~~好人类智慧~~

### 题意

给定 $n$ 个区间 $[l_i,r_i]$，每个区间有一个颜色（可能不确定）。定义若一个区间和与它有交的所有区间都颜色一样，则它为一个好区间。求可能的好区间最大数量。

$n\le500,l_i,r_i\le10^6,c\le200$。

### 分析

先将所有区间以 $r$ 为第一关键字，$l$ 为第二关键字排序。定义 $S_i$ 为排序后与区间有交的区间集合。显然一个区间是否是好的只取决于 $S_i$ 中 区间的颜色数，据此可分出四类：
1. 有两种以上非 $0$ 颜色。
2. 只有一种非 $0$ 颜色。
3. 有 $0$ 和一种非 $0$ 颜色。
4. 只有 $0$。

前两种可以直接统计进答案并忽略，只用考虑后两种。

为了方便的表达 $S$，我们再设 $p_i$ 为最小的满足 $r_j \ge l_i$ 的 $j$。那么 $S$ 可以被分为两部分：$\{j|p_i \le j \le i\}$ 和 $\{j|p_j \le i \land j>i\}$。我们考虑集合 $S_i$ 和 $S_j$ 相交（$i<j$）的条件：
1. $i$ 的第一部分和 $j$ 的第一部分相交：$p_j \le i$。
2. $i$ 的第二部分和 $j$ 的第一部分相交：$\exists x \in [p_j,j] \land p_x \le i$。
3. $i$ 的第二部分和 $j$ 的第二部分相交：$\exists x > j \land p_x \le i$。

可以将二三合并，就是 $\exists x \ge p_j \land p_x \le i$，所以如果我们在统计 $suf_i=\min_{x=i}^np_x$，就可以将这个条件写成：$suf_{p_j} \le i$。在定义 $f_i=\min(suf_{p_i},p_i)$，那么相交的条件就可以很优美的写成：$f_j \le i$。

这个时候就可以考虑 `dp` 了。设 $dp_i$ 表示考虑前 $i$ 个区间的最大好区间数。我们可以考虑钦定当前区间的颜色 $j$，枚举该颜色形成的极长连续段 $(k,i]$。显然与 $i$ 有交的集合必须被算进去，所以 $k < f_i$。统计这个连续段中的好区间数要求满足集合所有区间都在这个范围内且颜色为 $j$，对每个颜色开一颗树状数组就行了。

复杂度 $\mathcal O(n^2k\log n)$。

### code

<https://codeforces.com/problemset/submission/1250/211217308>