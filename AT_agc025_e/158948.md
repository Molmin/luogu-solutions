细节题，但我好像没挂什么细节，自己 yy 了一堆处理方法竟然是对的。

这里提供的是比上面题解优的 $O(nm)$ 做法，简单来说就是用细节换复杂度。

思路就是每次把叶子丢掉，考虑叶子往父亲那条边的最优策略：

- 没有路径从叶子出发，不管。

- 恰有一条路径出发，怎么定向都可，直接改为从父亲出发。

- 起码有两路径从此出发，随便选两条路径，假设 $1$ 为叶子，$3$ 和 $4$ 分别为路径的另外一端，$2$ 为两条路径恰相交处，此处 $1\to2,2\to3,3\to4$ 中间的点省略：

  ![](https://cdn.luogu.com.cn/upload/image_hosting/lsdaa706.png)

  最优策略显然是一条上一条下，$1$ 到父亲的贡献就算满了，不难发现 $1$ 到 $2$ 之间的贡献也必定算满，而 $3$ 到 $4$ 之间的贡献再算即可。

  具体来说，把 $(1,3),(1,4)$ 两路径删掉，直接改为 $(3,4)$。

  除这两路径的其他路径与贡献无关，直接改为从父亲出发。

策略就是这样，但这道题要求最大贡献还要给路径定向，显然只要我们给路径定了向，可以最后再暴力遍历统计贡献 $O(n^2)$。

那么就只用考虑定向的问题，发现整个过程，改为从父亲出发的路径们与定向无关，只有合并两条路径时要求一上一下。

由于两条合成一条，最多合 $m$ 次，不难想到建新路径，并制约前两条路径的方向。

这里建议每条路径都为 $(x,y)$ 的形式，固定这个二元组，然后给这个二元组打标记表示是否翻转。

于是制约转化为标记上的制约，如果 $1$ 代表正向，$2$ 代表反向，处理一下原来两条路径和新路径的关系，即是否需要异或 $3$。

由于前两条路径已被删去，那么只会由新路径制约，最后的关系一定形如一棵外向树或外向树森林。

从根往下传递关系即可，由于建新路径的顺序我们可以倒着遍历，很方便。

这里可能有新路径制约新路径，只是理解上的问题，顺便提一下。

注意判路径是否被缩完，即一条叶子到父亲的路径丢给父亲就是从父亲到父亲的路径。

再注意一下路径是否在另一端被合成了新路径，合了就不能要。

截止本文都是 rk1 的[代码](https://www.luogu.com.cn/paste/t90b3al2)，其实思路懂了都没必要看，~~所以我就懒得删调试了~~。