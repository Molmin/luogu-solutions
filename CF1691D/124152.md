看到题解区线段树横行，给一个不用码线段树的做法。

首先可以求出 $a_i$ 作为最大值的区间 $[l_i, r_i]$，这个可以用单调栈在 $O(n)$ 的时间里求出。

接下来只需要求 $[l_i, r_i]$ 中跨越了 $i$ 的最大子段和。用线段树是容易做的，但是 ST 表更好写。具体来说，考虑 $a_i$ 的前缀和 $pre_i$ 和后缀和 $suf_i$，用 ST 表维护 $pre_i$ 和 $suf_i$ 的区间最大值，那么 $[l_i, r_i]$ 中跨越了 $i$ 的最大子段和就是 $\max \limits_{i \le r \le r_i} pre_r - pre_{i - 1} + \max \limits_{l_i \le l \le i} suf_i - suf_{i + 1} - a_i$。如果这个数大于 $a_i$，就找到了一个不合法的区间。

时间复杂度 $O(n \log n)$。