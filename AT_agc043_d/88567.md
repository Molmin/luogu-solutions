### sol
直接对构造的三元组显然是不好计算的

于是我们可以考虑直接计算合法的序列 $P$

首先会发现一个必要条件是连续下降子串长度不超过 $3$

考虑证明:

对于一个三元组 $(x_i,x_{i+1},x_{i+2})$,只有当 $x_i>x_{i+1}$ 的时候才会出现下降的情况,而且选了 $x_i$ 之后下一个必然会选 $x_{i+1}$ ,所以最长下降子串不超过 $3$,同时第一个位置被选当且仅当它是一个前缀最大值

于是我们就可以把每一个前缀最大值的分成一段, $P$ 合法的必要条件之一就是每段的大小都不超过 $3$

然后考虑如下构造,把排列看成一些段,长度为 $1,2,3$ ,然后把 $1,2$ 拼接起来变成一个三元组,然后发现这样还需要满足长度为 $2$ 的串的数量要小于等于长度为 $1$ 的串的数量,因为对于每一个满足条件的排列我们都可以构造出来一组三元组,所以这就是 $P$ 合法的充要条件

设每一段的大小为 $a_1 , a_2....... a_k$ 的话,那么选择的方案数就是 $\frac{n!}{a_1(a_1+a_2)......(a_1+a_2+.....+a_k)}$,其实就是强制每一段的开头是前缀最大值

于是就可以考虑设 $f_{i,j}$ 表示考虑了前 $i$ 个数,长度为1的段的数量-长度为2的段的数量为 $j$ 的方案数,转移是 O(1) 的.