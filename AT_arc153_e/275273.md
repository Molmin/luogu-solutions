我们考虑给定 $X$，如何贪心地求 $f(X)$。

- 队列为空时加入队首或队尾都是一样的。
- 队列不为空，设队首为 $c$。因为我们的目标是最小化字典序，于是如果 $X_i \le c$，我们把 $X_i$ 加入队首，否则加入队尾。由此也容易发现，加入队首的数一定单调不升。

考虑到既可以在头部加数也可以在尾部加数，套路地考虑区间 dp。设 $f_{l, r}$ 为 $Y_{l \sim r}$ 对应的 $X$ 个数。设 $n = |Y|$，初值 $\forall i \in [1, n], f_{i, i} = 1$。有转移：

$$Y_{l - 1} \le Y_l, f_{l, r} \to f_{l - 1, r}$$

$$Y_l < Y_r, f_{l, r} \to f_{l, r + 1}$$

答案为 $f_{1, n}$。

至此可做到 $O(n^2)$。

考虑一些神奇的事情。我们对于 $(l, r)$ 建出网格图，若 $(l, r)$ 可转移到 $(l - 1, r)$ 或 $(l, r + 1)$ 就在二者之间连边。例如对于 $Y = \texttt{12234433442}$ 我们可以得到以下的网格图：

![](https://img.atcoder.jp/arc153/73eee5519e98726eadeb026a76db9503.png)

现在问题转化成了求这张网格图上，$\forall i \in [1, n], (i, i) \to (1, n)$ 的路径个数之和。

观察这张图，发现很多点和边是多余的。考虑删除它们。设 $Y_{1 \sim p}$ 是极长不降子段，那我们仅保留 $l \le p$ 的点。对于一个 $l$，它延伸出去的 $r$ 满足 $[l, r]$ 中除与 $l$ 在同一个同色连续段的点后不存在 $Y_i \le Y_l$。并且与 $l$ 在同一个同色连续段的非右端点的点没有向右的转移。

简化后的网格图长这样：

![](https://img.atcoder.jp/arc153/430a57378f7bf877ed591d3c72403725.png)

考虑倒序枚举 $l$，动态维护 $f_{l, r}$。对于一个同色连续段的 $l$ 合并考虑。设连续段长度为 $k$，你每次要做这样的事情：

- 在 $f_l$ 前添加 $k$ 个 $1$；
- 做 $k$ 遍从连续段右端点到 $R$ 的前缀和，其中 $R$ 为 $f_{l, r}$ 有效的最大的 $r$。

求序列 $a_{1 \sim n}$ 的 $k$ 阶前缀和容易使用 NTT 优化至 $O(n \log n)$，这里简单讲一下。设 $b_i$ 为 $k$ 阶前缀和后的序列。考虑 $a_j$ 对 $b_i$ 的贡献系数。不难发现每次前缀和时 $j$ 可以贡献到 $\ge j$ 的所有位置。贡献系数也就是满足 $p_0 = j \le p_1 \le p_2 \le \cdots \le p_m = i$ 的 $p$ 序列个数。容易插板法得到贡献系数为 $\binom{i - j + k - 1}{k - 1}$。于是我们有 $b_i = \sum\limits_{j = 1}^i a_j \times \binom{i - j + k - 1}{k - 1}$，这是显然的加法卷积形式，NTT 优化即可。

因为有效的 $l$，$Y_l$ 单调不降，所以同色连续段个数是 $O(|\Sigma|)$ 的。因此最后的时间复杂度就是 $O(|\Sigma| n \log n)$。

[code](https://atcoder.jp/contests/arc153/submissions/43226101)

------

**启发：对于 $f_{l, r}$ 只能贡献到 $f_{l + 1, r}$ 和 $f_{l, r - 1}$ 的 区间 dp，考虑建出网格图，去除无用点和边后可能可以做到更优。**