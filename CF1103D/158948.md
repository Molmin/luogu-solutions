有意思的一道题，但题解好像说的都不太清楚（第一篇太混乱了看不懂

我也来一篇详细的！

------------

首先我们先对所有数求出他们的 Gcd，目标是消完以后 Gcd 为 $1$，那么我就对着现有的 Gcd 里的素数消。

考虑 Gcd 的定义是 $\prod p_i^{\min_j c_{i,j}}$，即在每个质数在所有数中最小的那个指数幂乘起来，其中 $c_{i,j}$ 表示 $a_j$ 里面质数 $p_i$ 的个数。

为了使得最终的 Gcd 为 $1$，同时为了最优化代价，每个质数 $p_i$ 肯定都是**只**找一个数 $j$ 把 $c_{i,j}$ 消成 $0$ 然后就不管这个质数了。

显然 $c_{i,j}$ 消成其他的形式（指不是上述消法）都是不优的。

------------

手算一下 $10^{12}$ 最多能包含 $11$ 个质数（$2\times 3\times\cdots\times 31$），令个数为 $m$，我们可以设计一个 $m\times 2^m$ 个状态的 DP 来解决此问题。

即 $f_{i,j}$ 表示选出了 $i$ 个数，消掉了 $j$ 的质数集合（注意一个数是可以消掉多个质数的）的最小花费。

这里有个很重要的一点是每次选一个数必定消掉一个新的质数（如第一部分所叙述），最后至多选 $m$ 个，也即第一维只有 $m$，后面有用到都默认已知晓。

每次转移就考虑一个数，枚举当前状态，复杂度已达 $O(nm2^m)$，转移是枚举一个超集然后把中间要填的质数填掉，复杂度 $O(nm3^m)$。

显然过不去，接下来就是很神的（是我太菜了）几步减少状态以及转移。

------------

首先 $n$ 个数应该有很多重复的，就是考虑这 $m$ 个质数所有的指数幂组成方式，即所有情况的 $c_i>1$ 中 $\prod p_i^{c_i}$ 有多少个本质不同的。

这个玩意真得爆搜，解释不清（我又太菜了），据说搜出来就是 $12000$ 个，令为 $M$。

由于我们只会选 $m$ 个数，所以每种数都保留 $m$ 个，更具体的，我们保留最便宜的 $m$ 个。

注意一种数是有多种消质数的方法的，也就是一种数（前提是有多个）可以用不同的修改来消掉多种的质数。

所以我们将 $n\to M\times m$，大概是 $10^6\to 10^5$，算是优化了一个级别，但它的用处并不在于此。

------------

这一步才是关键优化，我们考虑 _飞跃式的_ 减少转移，因为就算是 $nm3^m\to Mm\times m3^m$ 也没优化多少，而 $m3^m$ 的瓶颈也有很大的影响。

再次思考我们的状态，只有 $m2^m$ 个，枚举超集的部分没法优化，大头还是在 $n$（或者说 $Mm$）的转移上。

更具体的，我们考虑到每次枚举超集后中间填补的那部分质数集合，令为 $S$（这玩意状态数显然 $2^m$）。

 _神仙一步（关键一招）警告：_ 

发现对于 $S$，因为最后只会选 $m$ 个，**只有所有的 $S$ 的前 $m$ 个东西的并集的这些东西是有用的**，同时一个东西的有用体现在**只有它出现在这个 $S$ 的前 $m$ 个中才可能转移这种 $S$**。

根据这一步我们只搞这些转移，复杂度优化至 $O(m^23^m)$，相当于直接把 $n/Mm\to m$。

如果你感觉有什么没说到的大概率是**黑体字**没读清楚，反正那里特别关键，但~~我很短~~可能被你忽略了，多看几遍如果还有问题再来问我吧（

------------

你可能疑惑前面 $n\to Mm$ 这一步有什么用，实际上是后面这一步 $S$ 的前 $m$ 个需要预处理，而直接用 $n$ 个东西预处理达到了 $n\times 2^m\times m$ 就挂掉了。

我们先处理成 $M$ 种本质不同的，再拿去预处理就只剩下 $M\times 2^m\times m$ 了，根据实现的不同或处理的不当可能出现 $M\times 2^m\times m^2$ 或者是 $M\times 2^m\times m\log$ 的东西，~~但笔者只会口胡就默认大家都会精细实现做到最优复杂度了~~

这样想来此题的做法每一步都十分精巧，总复杂度为 $O(Mm2^m+m^23^m)$。