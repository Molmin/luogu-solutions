## 思路（详细）

首先我们这个题目可以进行一下简单的转化，下面是转化后的题意。

> 对于每组数据，给定一个长度为 $n$ 的数列 $a$，在该数列中取一个区间 $[l,r]$，在 $[l,r]$ 中取一个数 $a_i\land i\in[l,r]$，它的贡献是该区间内 $a_i$ 的数量减去不是 $a_i$ 的数的数量，对于任意区间的任意 $a_i$，找到最大贡献。

容易发现从区间难以着手，我们不妨试着从每个 $a_i$ 入手，首先对每个 $a_i$ 进行离散化操作。接着容易发现这样一个性质：

- 性质 $1$：如果我取到了一段连续的 $a_i$ 中的一部分，我肯定会把这段给取完。

接下来定义使得贡献最大时，我选择的 $a_i$ 为 $x$。

明显，由于我想要取的数是 $x$，既然我都取到了这一段里面，那我把这段取完的贡献会增加。于是我们能够发现这样一个推论：

- 推论 $1$：从性质 $1$ 出发，容易发现贡献最大的 $[l,r]$ 满足 $l$ 是一段连续 $x$ 的左端，$r$ 是一段连续 $x$ 的右端。

假设我现在得到了每个数在 $a$ 中的每一个连续段的信息（这很好实现），我如何知道对于每个数它应该怎么取更好？不妨从时间复杂度开始分析，明显本题应该做到复杂度 $O(n^2)$ 以下，我们不妨考虑线性。很容易发现我们先枚举数，再枚举该数分成的连续段，这两个循环乘起来是 $O(n)$ 的，我们考虑做 $O(1)$ 的贪心。

我们不妨对于考虑这样的三段：$[l_1,r_1],[l_2,r_2],[l_3,r_3]$。我们假设目前已经取了 $[l_1,r_1]$ 和 $[l_2,r_2]$。那么有结论：

- 性质 $2$：若 $[l_1,r_2]$ 的贡献，再减去为了取到 $l_3$ 中间要扣掉的数的个数的这个值 $s$ 小于等于 $0$，那么我如果取了 $[l_3,r_3]$，我必然不取 $[l_1,r_2]$ 这一部分。

这个结论是同样显然的，如果这一段和 $[l_3,r_3]$ 组合在一起，那么对于 $[l_3,r_3]$ 来说是一个负贡献或者没用，还不如不取，所以我不如直接把它给断开，$[l_3,r_3]$ 就不要和前面的放在一起了。

这个结论因此可以被扩展为：

- 推论 $2$：若 $[l_i,r_j]$ 的贡献，再减去为了取到 $l_{j+1}$ 中间要扣掉的数的个数的这个值 $s$ 小于等于 $0$，那么我如果取了 $[l_{j+1},r_{j+1}]$，我必然不取 $[l_1,r_j]$ 这一部分。

反过来，如果 $s>0$，那么我必须取走这一段，因为这可以扩大我的答案。这样做之后，这些连续段就可以被划分为几个集合，我的答案必然来自这些集合中的某一个。

实现的时候，我遇到一个 $s\leqslant 0$ 的情况我就去统计前面那一段的答案，然后算贡献就行。

注意边界情况可能会叉了你。

## 记录

[AC 记录](https://www.luogu.com.cn/record/78159780)