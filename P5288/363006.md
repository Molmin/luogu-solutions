## 前言

建议把题目仔细读一遍，~~我绝对不会告诉你我看错了题意。~~

## 思路

我们考虑 $w = 0, m = 0$ 的情况下怎么解决这个题。

由于题目要求 $1 < a < b < c < d \le n$，观察样例解释即可发现最终状态一定是都连向 $n$ 的。

考虑最小操作次数一定是每次都把一条不连向 $n$ 的边连向 $n$，这一定是最优且符合条件的。所以这一问的答案即为 $n - 1 - p$，$p$ 为已连向 $n$ 的点数（算 $1$ 和 $n - 1$），$1$ 表示去除 $n$ 本身。这个东西很好搞，用个 vector 存一下就好了。

考虑 $w = 1, m = 0$ 的情况。

设与 $n$ 已经相连的点为 $a_1, a_2, ..., a_k$，我们就可以把除了 $n$ 以外的点分为若干个区间：$[1, a_1], [a_1, a_2], ... [a_k, n - 1]$，我们发现这若干个区间内除了两边外，其他任何点都没有连向 $n$，而且同时发现一个优美的性质，想让任意一个区间满足最终状态，那么操作的 $a, b, c, d$ 一定都是在区间内的（除了 $d$ 有可能是 $n$ 外）。

我们设第 $i$ 个区间的所有旋转操作序列的长度为 $siz_i$，那么 $[a_{i - 1}, a_i], [a_i, a_{i + 1}]$ 这两个区间都达到最终状态的方案数便为 $C_{siz_i + siz_{i + 1}}^{siz_i}$。这里要仔细想想。

然后我们只需要求出 $siz_i$ 就行了，考虑怎么求。我们可以把 $[a_{i - 1}, a_i]$ 不断分治下去，形成一棵二叉树。此时 $siz_i = siz_l + siz_r + 1$，但是我们要把 $[a_{i - 1}, a_i]$ 分成两个什么区间呢？或者说，$mid$ 是什么呢？应该是第一个**大于** $l$ 且与 $r$ 连边的点，可以看作是把这条边给断开，然后再与 $n$ 点连接，因为如果换做其他的边，则会产生交叉的现象（可以自己动手画图）。所以此时我们可以把 $[a_{i - 1}, a_i]$ 分成 $[a_{i - 1}, mid], [mid, a_i]$，需要注意的是，由于我们分成了二叉树，最终的方案数应该要乘上每个节点的方案数。每个节点的方案数则可以由子节点的 $siz$ 按照上述方式计算。~~我应该说清楚了吧。~~

至于求出 $mid$，用二分就 OK 了。

然后考虑 $w = 0, m > 0$ 的情况。

如果此时所在区间有父亲（不难看出边的两个端点一定是某一个区间的边界），这里可以看看提题解区的图，发现其实对于整棵树而言，类似于平衡树的旋转操作，并没有改变 $siz$ 的结果，或者说，并不对第一问的答案产生影响。

如果没有父亲，意味着这是上述的大区间，此时如果旋转，就会把本来连向 $n$ 的边改为不连向了，所以答案得 $ - 1$。就解决完了。

最后考虑 $w = 1, m > 0$ 的情况。

我们发现，每一次旋转操作是并不是对于每个节点的答案贡献都有影响的，换句话说，只对旋转位置有影响的节点产生不同贡献，所以我们可以把这些节点的贡献先给除掉，然后再乘上新的贡献就 OK 了。一样的像第三种情况分两类讨论。

最后题解提醒您：

- 多测不开 $tmp$，亲人两行泪。
- 没有判边界，亲人两行泪。
- 没有开 long long，亲人两行泪。