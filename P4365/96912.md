给定 $n$ 个点的树，每个点有权值 $a_i\in [1,w]$，对求出树上每个连通块第 $k$ 大权值（相同计算多次）的和，对 $64123$ 取模。$n,w,k\leqslant 1666$。

先考虑 /dao 掉这个第 $k$ 大。
$$
\begin{aligned}
&\sum_S\mathrm{kth}(S)\\
=&\sum_{i=1}^wi\sum_S[\mathrm{kth(S)}=i]\\
=&\sum_{i=1}^w\sum_S[\mathrm{kth(S)}\geqslant i]\\
=&\sum_S\sum_{i=1}^w[cnt_{S,i}\geqslant k]
\end{aligned}
$$
其中，$S$ 表示任意一个连通块，$cnt_{S,i}$ 表示 $S$ 中权值大于等于 $i$ 的点的个数。

我们考虑一个暴力 dp，钦定一个根，设 $f(u,i,j)$ 表示以 $u$ 为 lca 的所有连通块，权值大于等于 $i$ 的点的个数为 $j$ 的连通块个数。转移是一个背包的形式。我们只需要求出来。这样可以做到 $O(n^2w)$ 的复杂度，卡卡常能过。

现在我们考虑优化，注意到第三维是一个背包，我们考虑把第三维改写成生成函数的形式，那么第三维是一个卷积，由于次数不超过 $n$，我们考虑用拉格朗日插值去插出这个多项式。

为了方便获取答案，再设一个 $g(u,i,j)$ 表示 $u$ 及其子树内的所有 $f(v,i,j)$ 之和，那么新的转移为
$$
F_{u,i}=z^{[a_u\geqslant i]}\prod (F_{v,i}+1)\\
G_{u,i}=F_{u,i}+\sum G_{v,i}
$$
对其带入某个值 $z=t$，则有
$$
\newcommand{\F}{\hat{F}}
\newcommand{\G}{\hat{G}}
\F_{u,i}=(a_u\geqslant i?t:1)\prod (\F_{v,i}+1)\\
\G_{u,i}=\F_{u,i}+\sum \G_{v,i}
$$
这里的乘法是对应位相乘。

现在考虑固定某个位，把 $i$ 这一维看作下标，对某个 $u$ 我们的转移过程是什么样的：

1. 把 $\F$ 整体赋为 1。
2. 对于下标大于等于 $a_u$ 的地方，区间乘 $t$。
3. 枚举子树 $v$，令子树 $v$ 的 $\F$ 全局 +1，然后 $\F$ 对应相乘，$\G$ 对应相加。
4. 让 $\G$ 和 $\F$ 对应相加。

我们考虑设计一个变换 $(a,b,c,d):(f,g)\rightarrow (f',g')$，其输出为 $(af+b,cf+g+d)$，考虑变换之间的结合：
$$
(a_2,b_2,c_2,d_2):((a_1,b_1,c_1,d_1):(f,g))=\\
(a_1a_2f+b_1a_2+b_2,(c_2a_1+c_1)f+g+c_2b_1+d_1+d_2)\\
(a_1,b_1,c_1,d_1)\cdot(a_2,b_2,c_2,d_2)=(a_1a_2,b_1a_2+b_2,c_2a_1+c_1,c_2b_1+d_1+d_2)
$$
可以验证这个变换满足结合律，且存在单位元 $(1,0,0,0)$。同时注意到对于初始值 $(0,0)$，最后的值为 $(b,d)$。

现在考虑维护，我们使用线段树维护，除了过程 3 都很好直接通过打标记维护，过程 3 只需要线段树合并即可。注意由于现在是区间修改，所以在合并的时候需要注意如果合并的两个结点都没有左右儿子就不 pushdown 而是直接合并信息返回，同时虽然这个操作没有交换律，但是在线段树合并的时候交换 $x,y$ 后 $b,d$ 的值不变，而我们并不会再用到 $a,c$ 的值，所以复杂度依旧正确。最后某个 $x_i$ 对应的 $y_i$ 是所有叶节点的 $d$ 之和。

现在考虑怎么在求出点值之后还原系数，先放出来拉格朗日插值公式：
$$
F(x)=\sum_{i=1}^ny_i\prod_{j\neq i}\frac{x-x_j}{x_i-x_j}
$$
我们先考虑计算出 $\prod(x-x_j)$，然后枚举 $i$，$\prod x_i-x_j$ 和 $y_i$ 都是常数，然后再把全部乘积除上 $(x-x_i)$ 即可。一次插值的复杂度 $O(n^2)$ 或 $O(n^2\log p)$。

认为 $n,k,w$ 同阶，则我们可以在 $O(n^2\log n)$ 的时间内解决问题。

草暴力比正解快 30 倍，建议把 ML 改成 4MB/mgx。
