线段树。总体思路为记录一下 rotate/flip 的情况然后就是普通线段树了。

### swap

单查 $2$ 次得到 $i,j$ 的颜色，然后赋值单修两次。

### paint

赋值区修，要懒标记。

### count / countsegment

区查，记录一下一个区间内的“部分”的个数，左界颜色，右界颜色。

合并：若左子树的右界颜色和右子树的左界颜色一样，那么答案为左子树“部分” $+$ 右子树“部分” $-1$ 。否则答案为左子树“部分” $+$ 右子树“部分”。

### rotate/flip

开两个变量 $R,F$ 记录 rotate/flip。

更新 rotate 时，$R$ 变为 $R+k$。

更新 flip 时，rotate 会变换方向，所以 $R=n-R$。

这里注意对 $n$ 取模时候的一些特殊情况。

### 将 $x$ 变为原环上的下标

说白了就是往回转 $R$ 步。存在 flip 取个反。注意对 $n$ 取模。