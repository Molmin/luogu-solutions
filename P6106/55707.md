这题没有题解，我就来贡献一篇，简单说下思路。

首先，我们只考虑斜率为正的线段，对于斜率为负的，我们把平面倒过来再做一次就行了。

我们发现这题的贡献可减，所以考虑将一个询问拆成四个前缀矩形的询问。

对答案有贡献的线段分为两种，与矩形边界无交和有交的。

无交的线段的右上角一定被包含了，把贡献放在右上角的点上，做一个二维偏序就可以解决；

有交的线段一定只和上边界和右边界之一有交（交在顶点上的扰动一下就变成交在边上了），我们分两遍处理，只考虑与右边界相交的线段。考虑扫描线（一条竖线），维护所有线段与扫描线的交点，由于线段两两不交，交点顺序不会改变，所以考虑用平衡树维护线段到当前扫描线的长度和。查询的时候就是查一个前缀的长度和。

代码我实现的很烂，就不给了，看懂了的应该都能实现出来，没看懂的可以问我。