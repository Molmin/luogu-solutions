## 题意

给定一个序列 $\{a_i\}$，求其中最长的合法区间。一个区间合法当且仅当其中的众数不唯一。

## 解法

考察极长合法且不靠边的区间的性质。如果其两边至少有一个数不是此区间中的众数，我们显然可以让这个区间向那个方向延长 1 格，所以这个区间必然不是极长的。

如果两边都是这个区间的众数且不相等，那么显然可以让区间同时向左右各延长 1 格，所以这个区间也不是极长的。

所以极长合法且不靠边的区间，其两边必然是相等的数，并且那个数一定是这个区间中的众数之一。

为了消除歧义，接下来称极长合法且不靠边的区间的众数为其两侧的那个数。

接下来考虑到如果一个区间 $[l, r]$ 是极长合法且不靠边的区间，其众数为 $k$，那么必然 $[L, R](L \leq l, R\geq r, [L, R]\not=[l, r])$ 都不合法。也即所有包含 $[l, r]$ 的区间，其必然有唯一的众数。容易发现除非 $k$ 是全局众数，必然存在这样的一个区间 $[L, R]$ 包括 $[l, r]$，使得 $[L, R]$ 的唯一众数不是 $k$。不妨设那个数是 $t$。考虑将 $L$ 移动到 $l-1$, 将 $R$ 移动到 $r+1$ 的过程中，区间中 $t$ 的出现次数减去 $k$ 的出现次数。下称为区间的价值。若 $L$ 或 $R$ 移动 1 步，区间的价值至多变化 1。又因为起始时区间的价值大于 0，结束时区间的价值为 -2，所以必然存在一个中间状态，区间的价值为 0。这与假设（$[l, r]$ 是极长合法且不靠边的区间）不符。

由此我们得知了可能是(极长合法且不靠边的区间)的区间 $[l, r]$ 的性质：

- 包含全局众数 $k$, 且 $a_{l-1} = a_{r+1} = k$，且 $[l, r]$ 的众数为 $k$;

- 存在一个数 $t$, $t$ 和 $k$ 在 $[l, r]$ 中的出现次数相等。

由此我们得到了一个算法：枚举每个 $[l, r]$ 区间的 $t$，对于每个右端点 $R$，找到位置最前的左端点使得 $[L, R]$ 中，$t$ 和 $k$ 的出现次数相等。这样的区间数量是 $O(n)$ 的。值得注意的是不需要考虑这些区间是否合法：因为如果这个区间是不合法的，那么肯定不优（不包含全局众数）。

<https://codeforces.com/contest/1446/submission/189158202>

我们考虑对于区间中包含的全局众数个数根号分治。如果区间中包含的全局众数的数量不多于 $T$，容易在 $O(Tn)$ 的时间复杂度内计算出这些区间中最长合法且不靠边区间的长度。

否则只需要考虑那些总共出现次数多于 $T$ 的数，这些数的个数是不多于 $n/T$ 的。对于这些数做 D1 的算法即可。

取 $T = \sqrt n$，得到时间复杂度 $O(n\sqrt n)$。

<https://codeforces.com/contest/1446/submission/189181040>

笔者代码中没有考虑到“不需要考虑这些区间是否合法”。