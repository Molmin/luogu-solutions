模拟赛放这个题，愉快场切。

题目难点在于发现这个题是个简单题。

先把 $d=1$ 的判掉。

观察对序列的两种操作，发现满足条件的序列必须是单谷的，也就是先递增再递减或者先递减再递增。手模一下发现所有情况只要是单谷序列（包含单调序列）都有且仅有两种操作方式。

对于一般的单谷序列（不是单调序列），两种情况即为讨论顶点归属左边或者右边；对于单调序列，两种情况为操作第 $1$ 个点改变整个序列单调性，或者操作第 $k-1$ 个点让第 $k$ 个点更大或更小。

容易发现 `Ember` 一定会保证自己必胜，也就是说无论 `Storm` 怎么选选出来的序列都是单谷序列。也就是说选出一个满足条件的树后，它的贡献是 $2n(n-1)$。因为 `Storm` 能选出 $n(n-1)$ 条路径，每条路径对应两种操作方式。也就是说剩下的问题就是对符合条件的树计数。

我们发现满足条件的树一定会有一个中心点，所有子树从下往上要么单调递增要么单调递减。因此我们可以枚举这个中心点，把这个树分成两部分，一部分递增一部分递减。我们考虑对其中一部分计数，容易发现递增和递减是一样的，考虑对递增的树计数。

设 $f_{i,j}$ 表示 $i$ 个点，点 $i$ 做根，度数为 $j$ 的树的数量。转移考虑 $i$ 号点一定有一个儿子是 $i-1$，枚举其所在的子树大小 $k$，那么：

$$
f_{i,j}=\sum_{k=1}^{i-1}\sum_{l=0}^{d-1}f_{k,l}f_{i-k,j-1}\dbinom{i-2}{k-1}
$$

做前缀和：

$$
s_{i,j}=\sum_{k=0}^jf_{i,k}
$$
$$
f_{i,j}=\sum_{k=1}^{i-1}s_{k,d-1}f_{i-k,j-1}\dbinom{i-2}{k-1}
$$

直接转移 $O(n^3)$，可以多项式优化到 $O(n^2\log^2 n)$。

考虑统计答案，直接统计会记重，我们发现可能出现中间一条链，两边挂着子树的情况，这样子中间一条链的点都可以选做中心点。

解决方式可以用经典代表元计数，我们让每种情况在它中间这条链的最大的点那里统计，发现这个限制要求最大的点的度数（除去另一边）不能为 $1$，否则就会有更大点作为中心点。

$$
ans=\sum_{i+j=n+1}\sum_{k\in[0,d]\wedge k\not=1}f_{i,k}s_{j,d-k}
$$

统计答案复杂度 $O(n^2)$。

总时间复杂度 $O(n^3)$ 或 $O(n^2\log^2 n)$。

---

补充一下具体如何多项式优化。

考虑分治 `NTT`，先向左递归，然后在这一层中，处理 $i\in[l,mid]\vee j\in[l,mid],k\in[mid+1,r]$ 时 $f_is_j$ 对 $f_k$ 的贡献（即处理新增的贡献），然后再向右递归。

这是经典的分治 `NTT`，区别是这一题是二维，然而我们考虑分治是对每一个 $j$，考虑所有范围内的 $f_{i,j}$ 的贡献。

每次计算贡献是 $O(n)$，分治复杂度是 $O(n\log^2 n)$，总复杂度 $O(n^2\log^2 n)$。~~然而这一题需要任意模数，常数极大，和 $O(n^3)$ 谁跑得快还不好说~~。