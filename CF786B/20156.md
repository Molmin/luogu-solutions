看到区间很容易就能想到线段树


一个线段树上的节点代表它在线段树上代表的区间的所有点


一棵线段树表示进,另一颗表示出


表示进的线段树要向上连边


表示出的线段树要向下连边


(画个图理解一下?)


所以进来的线段树$son->fa$长度为$0$


出去的线段树$fa->son$长度为$0$


对于操作$2$


设$pos_u$表示$u$在第一棵线段树上的节点编号


那么就把$pos_u$向所有$[ql,qr]∈[l,r]$的极大子区间的节点编号连一条长度为$w$的边


操作$3$同理,只要反过来建边就好了


每一次新建边的操作复杂度是 $O(2logn)$


最后就只要输出$s$到所有点在第二棵树上位置的点的距离就$ok$了
