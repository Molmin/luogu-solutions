## 前言

题解里面都是一堆 `pb_ds` 科技，但是本题的纯种解决办法应该是可持久化平衡树。由于我用可持久化 FHQ 写这题写得有点痛苦，这里为之后所有用这题练习可持久化 FHQ 的人一个参考。

## 思路和代码

首先这明显是一个可持久化数据结构题，鉴于有插入和删除，我们不妨考虑可持久化平衡树。

在完成此题之前，您应该先通过[【模板】可持久化文艺平衡树](https://www.luogu.com.cn/problem/P5055)，了解可持久化文艺平衡树的基本打法并基本理解它。

为了表述方便，我们约定 $now$ 表示目前字符串的长度。

### 操作 $1$

首先取出上一个版本的根并复制到这个版本上。将这个版本的 FHQ 裂成两半：一半是 $[1,p]$，另一半是 $[p+1,now]$，我们的只需要在这两半中间 `merge` 那个字符串进去就行。

对于一次性 `merge` 一长串东西，我们可以用一种较快的方法 `merge`。我们从中间断开这个字符串，建立一个节点 $rt$ 为中间那个字符，然后去处理左边，让左边归到左儿子上，再处理右边，让右边归到右儿子上，这样我们就可以 $O(n)$ 把整个字符串 `merge` 进去了！

这部分的完整代码如下：

```
string s;
void change(int x){
	a[x].siz=a[a[x].l].siz+a[a[x].r].siz+1;
} 
int newp(char c){
	tot++;
	a[tot]={rand(),1,0,0,c};
	return tot;
}
void qins(int &rt,int l,int r){
	if(l>r){
		return;
	}
	int m=(l+r)>>1;
	rt=newp(s[m]);
	qins(a[rt].l,l,m-1);
	qins(a[rt].r,m+1,r);
	change(rt);
}
```

接下来我们就可以得到这个字符串建立出的 FHQ 的根了，把这个根并进去即可：

```
if(opt==1){
	cin>>p>>s;
	p-=d;//强制在线的东西
	tnt++;
	rt[tnt]=rt[tnt-1];//复制前一个版本过来
	split(rt[tnt],p,t1,t3);//裂成两半
	qins(t2,0,s.length()-1);//注意字符串下标从 0 开始
	rt[tnt]=merge(t1,merge(t2,t3));//三段合在一起
}
```

### 操作 $2$

同样的取出上一个版本的根到这个版本上，然后裂成两半，一半是 $[1,p-1]$，另一半是 $[p,now]$。

对于第二段，我们再裂一次，裂成 $[p,p+c-1]$ 和 $[p+c,now]$。

那么我们就得到了三段 FHQ，分别是 $[1,p-1]$，$[p,p+c-1]$ 和 $[p+c,now]$。我们直接扔了中间那段，把两边合一起就行：

```
else if(opt==2){
	cin>>p>>c;
	p-=d,c-=d;//强制在线
	tnt++;
	rt[tnt]=rt[tnt-1];//复制上个版本
	split(rt[tnt],p-1,t1,t2);//第一次裂
	split(t2,c,t2,t3);//把后半部分拿来继续裂
	rt[tnt]=merge(t1,t3);//首尾合在一起，中间就没了
}
```

### 操作 $3$

根据 FHQ 的定义，要想按照顺序输出原序列的一段，只需要对 FHQ 进行中序遍历即可。那么我们的做法也就很显然了。

我们首先取出需要的版本的根 $rt$，接下来我们的所有的行动都在这颗根为 $rt$ 的 FHQ 上进行。

按照操作 $2$ 的方法，我们可以用两次分裂分裂出他想问的字符串所在的 FHQ。我们一共会得到三段 FHQ：$[1,p-1]$，$[p,p+c-1]$ 和 $[p+c,now]$。

我们直接对中间那段进行中序遍历即可：

```
void print(int rt){
	if(a[rt].l){//当然要有儿子才能去儿子那里
		print(a[rt].l);//走左儿子
	}
	cout<<a[rt].val;//输出父亲
	d+=(a[rt].val=='c');//强制在线的需要，不能忘记！
	if(a[rt].r){
		print(a[rt].r);//走右儿子
	}
}
```

那么这一操作的完整代码也就很容易写出了：

```
else{
	cin>>v>>p>>c;
	v-=d,p-=d,c-=d;
	split(rt[v],p-1,t1,t2);//在需要的版本上第一次分裂
	split(t2,c,t2,t3);//第二次分裂
	print(t2);//中序遍历输出
	puts("");//记得换行
}
```

## AC 记录

代码就不给了，文章中已经分段给出。最基础的 `split` 和 `merge` 与其他题目没有区别。当然存 FHQ 节点的时候要将 `val` 设为 $\texttt{char}$ 类型。

[AC 记录](https://www.luogu.com.cn/record/76148681)