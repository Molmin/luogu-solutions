没咋写过线段树合并，于是来写写这道水题。

首先观察 $W$ 的交换定义，显然的发现就是笛卡尔树可以交换左右子树进行逆序对贡献。

假设交换点 $x$ 的左右子树 $ls_x,rs_x$，那么 $ls_x,rs_x$ 子树内部的贡献不变，因为段整体交换。

同时 $x$ 子树以外的贡献不变，分别看 $x$ 子树左边和右边就会发现都没变。

所以边的贡献就只有 $ls_x,rs_x$ 互相的贡献，也就是本来的逆序对变成了正序对。

那么我们统计逆序对的个数，正序对就是所有对数减去逆序对数，贪心取两个中最小的即可。

两个子树互相的逆序对数直接上线段树合并，我们就会做没有修改的问题了。

~~由于我只想练习写线段树合并而不想练习线段树合并统计贡献，于是我使用了启发式统计贡献。~~

复杂度为 $O(n\log n)$，如果是启发式合并/统计贡献也可以做，复杂度是 $O(n\log^2n)$ 的。

空间复杂度由于后面要可持久化所以是 $O(n\log n)$ 的，启发式合并的话会是 $O(n\log^2 n)$，启发式统计贡献没有空间复杂度。

考虑修改，首先由于 $W$ 是随的，所以笛卡尔树树高是 $\log n$ 的。

直接对每个点的贡献都进行修改，发现就是看改的那个值有几个逆序对加上或减去即可，我们之前线段树合并的时候可持久化一下这里就可以直接用了。

由于询问不独立，于是每次还要修改，如果直接可持久化修改我就爆空间了，所以再开一棵动态开点线段树来维护询问的影响。

反正线段树部分都是 $O(\log n)$ 的，然后乘上修改的点数 $\log n$，询问复杂度 $O(q\log^2n)$。

~~空间复杂度也是 $O(q\log^2n)$ 的，我也不知道为什么动态开点线段树就没被卡空间了（~~

还有笛卡尔树随便建就行了，总复杂度 $O(n\log n+q\log^2n)$，我启发式所以是 $n\log^2n$ 的，但 CF 机子快也就过了。

[代码](https://www.luogu.com.cn/paste/l0rk8ahi)还是放一下。