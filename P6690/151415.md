这是一篇不需要考虑新数域内原根 $(x+g)$ 的题解，做法可能与其本质等价。

## 一些性质

首先我们意识到新数域中的乘法没有一些明显的特殊性质，新的一次项形式很怪异，这让我们联想到二次剩余算法中对 i 进行的扩域，二次剩余算法中通过对 $a+bi$ 的 $p$ 次方进行计算，然后约掉许多项，获得了十分漂亮的结论。这引导我们对该数域中数的 $p$ 次方进行探索。

#### Lemma 1.$(ax+b)^p=b$

证明：$(ax+b)^p=pab^{p-1}x+b^p=b^p=b$

#### Lemma 2.$(ax+b)^{p-1}=-a/bx+1$

证明和上面同理或者除一下就可以得到。

此时我们注意到对 $A=0$ 的情况只要凑出 $qx+B$ (其中 $q$ 是任意数)然后再将其取 $p$ 次方就能得到 $B$ 了，这样就可以忽略 $a_i$ 的取值，造出单个的常数。但此时我们注意到没有 $A=0$ 的部分分，而是 $A=B=1$ 的部分分，这引导我们向 $x+1$ 的性质发起探索。

#### Lemma 3.$(x+1)^k=kx+1$

#### Lemma 4.若 $ab \equiv 1\ (\bmod p)$，则有 $(ax+1)^b=x+1$，即 $(ax+1)^{bc}=(cx+1)$

证明：$(ax+1)^b=(x+1)^{ab}=(ab)x+1=x+1$

#### Lemma 5.对任意 $a,b$，$(ax+b)^{p(p-1)}=b^{p-1}=1$，即 $p(p-1)$ 是一个普适的循环节

## 构造

首先，取一些元素，使其常数项的乘积能构造出 $B$ ，再将得到的某个 $mx+B$ 自乘到 $p$ 次方，成为 $B$。

其次，若 $A \neq 0$ ，找到（在前一步中需要保证有这样的元素）一个 $a \neq 0$的元素，将其变为其 $p-1$ 次方，以得到某个 $mx+1$ ，其中 $m \neq 0$，这样保证了 $m$ 在模 $p$ 意义下有逆元。

接着，将 $mx+1$ 自乘到 $A/Bm$ 次方，得到 $A/Bx+1$，再将其乘以 $B$ 就得到了我们想要的多项式。

为什么这是用了最小个数一次函数的构造呢？~~其实我也不知道，我是按可行解做的~~。按 Lemma 1，凑出 $Ax+B$ 就能凑出 $B$ ，而我们构造了方法使凑出 $Ax+B$ 的使用个数比 $B$ 最多多一（在凑出 $B$ 的元素均有 $A=0$ 时多一，其他情况不变）

在凑出 $B$ 的元素均有 $A=0$ 时，光靠这些元素显然凑不出我们需要的结果，因此加一是最优的结果。

## 如何构造 $B$

1. 找出原根 $g$

2. 使用 BSGS 找出所有 $b_i$ 以及 $B$ 的对数，分别记为 $lnb_i$,$lnB$

3. 将所有对数值与 $p-1$ 取 gcd，然后对其分解质因数，问题转化为找到最小解集使其 $\operatorname{gcd}$ 整除 $\operatorname{gcd}(lnB,p-1)$

4. 对每个质因数以及是否有 $A$ 非零的元素做状压，最后的答案就是dp[n][ALL]。

## 一些细节

1. 注意超过 $10^{18}$ 时对 $p(p-1)$ 取模

2. BSGS 注意平衡复杂度做到 $O(\sqrt{nq})$，实测 $B=1300000$ 跑得比较快