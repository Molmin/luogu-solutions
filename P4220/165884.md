## 任务：

给定三颗树，求 $ \mathop{max}\limits_{x,y} \{ dis1(x,y)+dis2(x,y)+dis3(x,y) \} $ 

$ 2 \leq n \leq 10^5,0 \leq w \leq 10^{12} $ 

## 算法：

三棵树，因此我们只能一步步算出每棵树的距离,将多个算法嵌套起来。

对于第一棵树，我们需要枚举出所有的路径距离，所以可以选用边分治。

设当前分治边为 $ (st,ed) $ 。那么我们需要处理的路径 $ (a,b) $ 应该满足经过该边，即 $ a $ 和 $ st $ 属于一个连通块， $ b $ 和 $ ed $ 属于一个连通块。

因此可以直接将 $ st $ 和 $ ed $ 侧的点进行黑白染色。

于是当前任务就变成了:在当前分治树中，寻找一个黑点 $ a $ , 一个白点 $ b $  ,使得

$ dis1(a,st)+dis1(ed,b) + val1(st, ed) + dis2(a,b) + dis3(a,b) $ 最大。

$ dis2(a,b) = dep2(a) + dep3(b) - 2 \cdot dep2(lca2(a,b)) $ 

$ dis3(a,b) = dep3(a) + dep3(b) - 2 \cdot dep 3(lca3(a,b)) $ 

除了 $lca$ 的项,我们对于 $a$ 和 $b$ 只需要求出  $ w(x) = dis1(x, st/ed) + dep2(x) + dep3(x) $ 

所以原式变为 $ w(a) + w(b) - 2\cdot dep2(lca(a,b) - 2\cdot dep3(lca3(a,b)) $ 

此时,我们需要通过第二棵树的边来判断 $ dep2(lca2(a,b)) $  ，根据边分治的性质,我们可以将黑点与白点以第二棵树的连通性建立虚树。	

此时就可以在虚树上枚举 $ lca2(a,b) $ 统计答案,假设当前枚举的点为 $ p $  ,那么我们只需要从 $ p $ 的不同子树中找到一对点 $ (a,b) $ , 满足 $ a $ 是黑点， $ b $ 是白点，且最大化 $ w(a) + w(b) - 2\cdot dep3(lca3(a, b)) $ 。

如果 $ w(a) $ 代表 $ dep3(a) $  ,那么上式子就变成了第三棵树的直径,由于边权非负，我们可以通过树形DP进行求解。( 子树的直径合并等于四个直径端点两两组合)

$w($x$) = dis1(x, st/ed) + dep2(x) + dep3(x)$

因此，我们可以建立虚点 $ a' $ 和 $ b' $  ,然后边权设为 $ dis1(x, st/ed) + dep2(x) $  , 这样原式就变为了 $ (a',b') $ 的距离。

时间复杂度  $ O(nlog^2n) $  ,排序和 $LCA$ 优化之后可以达到 $ O(nlogn) $ 。