首先，众所周知地，有限制的排列计数问题可以转化为带禁止位棋盘的車的放置问题。

题目的限制是 $|P_i-i|\geqslant X$，它不便于直接求得。但因 $X\leqslant 5$，故在类似 $|P_i-i|\leqslant X$ 的限制下是易求的，因为我们有复杂度可以接受的状压。因此考虑容斥。

众所周知地，设 $r_k$ 为只取 $k$ 个車放入棋盘且全部在禁止位的方案数，那么 $r_k(n-k)!$ 就是钦定 $i$ 个車处于禁止位的方案数。我们要算出的是恰好 $0$ 个車在禁止位的方案数，它就是：

$$
\sum_{k=0}^n(-1)^kr_k(n-k)!
$$

$r_k$ 只需状压即可求出。设 $f_{i,j,S}$ 表示往前 $i$ 行的禁止位放入 $j$ 个車，第 $i$ 行状况为 $S$ 的方案数，其中 $S$ 的某一位为 $1$ 表示该位不能放置。

从第 $i$ 行扩展到 $i+1$ 行，初始状况为 $S\!>\!\!>\!1$。转移为：

$$
f_{i+1,j,S\!>\!\!>\!1}\;\longleftarrow\;f_{i+1,j,S\!>\!\!>\!1}+f_{i,j,S}
$$

再计算放置了一个車后的转移。设放了一个車后 $i+1$ 行的状态变为 $T$，则有转移：

$$
f_{i+1,j+1,T}\;\longleftarrow\;f_{i+1,j+1,T}+f_{i,j,S}
$$

最终 $r_k$ 只需对最后一行的每一种状况求和：

$$
r_k=\sum_{S\subseteq U}f_{n,k,S}
$$

最后容斥即可。至此我们解决了问题。

[***code***](https://atcoder.jp/contests/abc309/submissions/43470057)