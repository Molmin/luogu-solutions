我们维护一个 pre 和 nxt 数组，对于 $i$ 表示满足 $j<i$ 且 $a_i=a_j$ 的 $j$ 的最大值和满足 $j>i$ 且 $a_i=a_j$ 的 $j$ 的最小值。如果没有满足条件的 $j$ 则 $pre_i=0$，$nxt_i=\inf$。

那么现在问题就转化为了求区间中的一个 $a_i$ 满足 $pre_i<l$ 且 $nxt_i>r$。

思考一个在线做法。这么鬼畜的东西感觉用树套树搞起来比较稳。。（但其实似乎是个三维偏序。。）

一贯的套路，线段树套一个 vector 里面上二分。vector 里面保存三个东西：$pre_i,nxt_i,a_i$。按照 $pre_i$ 排序，然后第一个条件 $pre_i<l$ 二分一下就搞定了。第二个 $nxt_i>r$ 因为有第一个限制条件所以就是从 $0$ 开始存一下最大值就可以了。

我把这个 $2\log$ 的做法写到常数巨大。naive 的我直接用了 vector，然后跑的和莫队差不多。