\*2900

这道题在第一步上会分出两种解法：你看没看出 $ans_x\ge ans_{x+2}$。

- 如果你看出来了，~~而且你和 zky 一样强~~，你可以直接对所有可能距离为 $d$ 的集合进行考虑。

  由于 $\ge d+2$ 的可以直接继承，只用考虑距离恰为 $d$ 的，从而得到正确的复杂度。
- 如果你没有看出来，你需要对每种 $S_{x,y}$ 集合对距离 $x/y$ 的贡献进行考虑，这里 $S_{x,y}$ 表示点对距离含 $x,y$ 的集合。

第一种解法左转隔壁看 zky 的，代码写得很好，我是来讲第二种平民解法的：

------------

如果 $S_{x,y}$ 中距离 $x,y$ 都存在，由于 $|x-y|=1$，其中必定存在奇数。

先特殊考虑只有偶数的情况，集合形如 $S_{2d}$。

从集合中取出两个点 $a,b$，令它们的路径中点为 $c$，那么对于这个集合的其他所有点都得是从 $c$ 接上去的，否则到 $a,b$ 的距离不可能都等于 $2d$。

那么我们枚举中点 $c$，贪心的使每个子树对集合贡献尽可能多，设对 $ans_{2d},ans_{2d-1}$ 的贡献为 $T_d$，则 $T_d=\sum_{p\in son_c}[mxd_p\ge d]$，其中 $mxd_p$ 为从 $p$ 延伸到子树内的最长单链的长度。

考虑含奇数长度的集合 $S_{2d+1,?}$，还是取两个点 $x,y$，则中点为一条边 $e_{u,v}$。

首先集合内的其他点必须从 $u,v$ 接到路径上，分两种情况考虑：

- 只从 $u,v$ 中的一端接入，接入的长度 $k\in\{d,d+1\}$ **且均相等**，若接入长度为 $d$ 则对 $ans_{2d}$ 产生贡献，若接入长度为 $d+1$ 则对 $ans_{2d+1}$ 产生贡献。

  我们枚举接入的那一端，贡献不好形式化的写出来：
  
  - 一个 $mxd_p\ge d$，其他的有 $\sum[mxd_q\ge d+1]$ 个，则对 $ans_{2d}$ 产生 $1+\sum[mxd_q\ge d+1]$ 的贡献。
  - 一个 $mxd_p\ge d+1$，其他的有 $\sum[mxd_q\ge d]$ 个，则对 $ans_{2d+1}$ 产生 $1+\sum[mxd_q\ge d]$ 的贡献。
- 从 $u,v$ 两端都接入，那么接入长度只能为 $d$，对 $ans_{2d}$ 产生贡献。

  不能枚举边再枚举儿子，菊花图就卡成 $n^2$ 了，应该枚举儿子接入长度为 $d$，然后给父亲的 $d$（对应位置）取 $\max$，再在父亲处考虑贡献。
  
不难发现，只要使得每个点 $x$ 儿子的 $mxd$ 排好序，相邻两项 $mxd$ 区间的贡献相同，把区间提出来离线单调栈一下即可。

瓶颈在排序，由于对每个点的儿子最长单链都要排序，不能进行桶排，根据实现复杂度为 $O(n\log_2n)$ 或 $O(\min{(n\log_wn,n\log_2w)})$。

~~不要问我后面那个丢人的复杂度是怎么来的。~~