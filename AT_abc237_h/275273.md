下文令 $|S| = n$。

**引理：** 一个字符串中本质不同的回文串数量 $\le n$。

**证明：** 每在字符串末尾添加一个字符，本质不同回文串数量最多增加 $1$。

考虑反证，设字符串在添加 $s_n$ 后，$s_{x...n}$ 与 $s_{y...n}$（令 $x < y$）都是 **之前没有出现过** 的回文串，那么根据回文串的定义，可得 $s_x = s_n = s_y = s_{x+n-y}$，$s_{x+1} = s_{n-1} = s_{y+1} = s_{x+n-y-1}$，以此类推，我们得到 $s_{x...x+n-y}$ 与 $s_{y...n}$ 完全相同，矛盾。因此引理得证。

考虑给每个本质不同的回文串编个号，然后建一个 DAG，$x \to y$ 当且仅当 $x$ 是 $y$ 的子串。那么若选了 $x$ 就不能选所有能到达 $x$ 和所有能从 $x$ 到达的点，所以题目求的就是这个 DAG 的 **最大反链** 。

根据 Dilworth 定理，可知在 DAG 中最大反链数 = 可重叠路径的最小划分数，也就是选出若干条链（可以重复经过某点），使得每个点都被覆盖至少一次。求最小可重路径覆盖可以二分图匹配。建一个二分图，若在原 DAG 上 $x$ 可达 $y$，就从 $x$ 的左部点连向 $y$ 的右部点。感性理解，设原 DAG 结点数量为 $m$，一开始每个点形成一条路径，一个匹配意味着原来的 $m$ 条路径中有两条结合了。

建图后跑一遍 Dinic 求出二分图最大匹配，再用 $m$ 减去它就是最终答案。

由于回文串数量 $\le n$，因此总时间复杂度不超过 $O(n^3)$。

[code](https://atcoder.jp/contests/abc237/submissions/36735942)