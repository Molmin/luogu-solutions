首先我们发现一个公司包管的线路可以组成一些连通块，但是这些不同连通块之间完全可以考虑成不同公司。所以可以化简成每个公司只会包管形成一个连通块的子图，即每个公司包管的点可以互通。这里一定需要注意复杂度不能假，必须把所有公司拆开来考虑，对每个公司内部进行一个再拆分。这样才能保证每个点被访问 $O(\deg )$ 次，即总共（如果用并查集的话）复杂度为 $O(m\alpha)$。（我代码实现中为了简便做了一个简单的去重多了个 $\log$，实际上可以不需要，而且这个并查集也是可以用线性的 dfs 解决掉的，不过不影响大局）。

容易发现我们乘车相当于不断地换乘，每次换乘永远是 $1$ 元。对于这种情况，可以建立一些辅助点，每个点代表一个公司（的连通块），然后所有其连通的点以 $\frac{1}{2}$ 的边权与它相连，然后跑一个最短路即可（这样每次出入都是 $1/2$，所以进行一次换乘的代价就是 $1$）。

每个点连的额外边最多为 $\deg(u)$，然后原图上的原边是可以去掉的，也就是说新图总边数 $\le \sum \deg(u)=2m$，总点数 $\le m+n$。还有实际操作的时候由于边权全是 $1/2$ 所以先当 $1$ 来做最后全部除以 $2$ 即可。

代码：https://atcoder.jp/contests/arc061/submissions/28443592

p.s. 感谢兔兔对这篇题解的细致纠错和治好了我的眼睛。