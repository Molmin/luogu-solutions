官方题解qwq。

首先可以发现这个性质：最后的答案一定是 $\sum\limits_{i=1}^n v_ia_i$ 的形式，其中 $v_i$ 是和 $a_i$ 无关的常数。

我们试图求出 $v_i$。为了方便定义，定义 $w_{i,j}$ 为序列长度为 $i+j-1$ 时，$v_j$ 的值，也就是前面 $i$ 个，后面 $j$ 个。

根据区间权值的定义，一个区间的权值为所有真子区间的权值之和，考虑 $w_{i,j}$，它是所有包含 $j$ 的子区间对这一项的贡献之和，再注意一下位置，就可以得到

$w_{i,j}=\sum\limits_{x \le i,y \le j,(x,y) \neq (i,j)}w_{x,y}$

这里，只用注意到原来序列的第 $j$ 位可能是一个长为 $x$ 的子区间的 $1,2,...,j$ 位。

这时记 $S_{x,y}=\sum\limits_{i \le x}\sum\limits_{j \le y}w_{i,j}$ 为 $w$ 数组的二维前缀和，上面的式子化简为 $2w_{x,y}=S_{x,y}$。

再结合二维前缀和的基本递推有 $S_{i,j}=S_{i,j-1}+S_{i-1,j}-S_{i-1,j-1}+w_{i,j}$，代入化简得到

$w_{i,j}=2w_{i-1,j}+2w_{i,j-1}-2w_{i-1,j-1}$

如果到此停止，写一个 $O(n^2)$ 的 $dp$，能得到 $10$ 分的好成绩。

继续推式子，我们设第 $i$ 行的生成函数为 $f_i(x)$，那么根据上面的递推式直接能得到

$f_{i+1}(x)=2(x+1)f_i(x)-2xf_{i-1}(x)$

直接当做二阶线性递推数列就能解得 $f_x=\frac{(x+\sqrt{x^2+1})^n-(x-\sqrt{x^2+1})^n}{4 \sqrt{x^2+1}}$。

如果这时候直接计算 $f_n(x)$ 就可以得到所需要的答案，使用倍增或者你喜欢的方法并结合 NTT 都可以做到 $O(n\log n)$ 的复杂度。

然而这还不够优秀，我们只用对所有的 $i$ 求出 $\bmod k$ 于 $i$ 的项的系数和。

为此，我们可以求出 $f_n(x)$ 在 $w,w^2,\cdots,w^k$ 处的点值，其中 $w$ 为本原的 $k$ 次单位根，然后进行一次 IDFT 就能得到系数和。当 $k=60928$ 时，$k|p-1$，所以单位根有模意义，只用扩域维护根号就能求出点值。

当然这一做法还是不够优秀，我们直接写出正解：

本质上我们要求的是这个多项式 $\bmod (x^k-1)$ 之后的余式，那么我们所有的操作都可以直接在这个模意义下完成。

如果是这个模意义下的两个正常的多项式，那么直接循环卷积就能得到最后的答案，但是问题就是根号，所以我们带着根号一起维护，也就是维护 $P(x)+\sqrt{x^2+1}Q(x)$ 形式的多项式，其中 $P,Q$ 为不超过 $k-1$ 次的多项式。乘法的时候直接使用 $(\sqrt{x^2+1})^2=x^2+1$ 就可以了。

对这样的数做快速幂就能在 $O(k\log n \log k)$ 的复杂度内解决问题。

当然这看着是 $2\log$ 但是并不能十分轻松的过题，就好比你 LCT 多一个 $\log$ 不能十分轻松的通过 $10^5$ 的数据范围。

数据还是比较友善的，部分点 $n$ 中的 $1$ 比较少方便常数较大的通过。

稍微说几个卡常技巧：

（1）NTT 板子最好预处理单位根并使用 DIF 版本。

（2）计算这种数的乘法的时候，例如是 $(a+b\sqrt{w^2+1})(c+d\sqrt{w^2+1})$ 的时候，只用计算 $3$ 次乘法 $ab,cd,(a+b)(c+d)$，和 Karatsuba 算法原理相同。

（3）在平方的时候，可以只计算一遍 DFT 点值。 

时限为 std 的 $4$ 倍。

