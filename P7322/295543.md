设 $f_n$ 表示长度为 $n$ 的排列的答案。我们考虑如何递推。可以枚举 $n$ 的位置在哪算贡献。

$$f_n=\sum_{i=1}^n((n-1)!+f_{i-1}\cdot \binom{n-1}{i-1}\cdot(n-i)!+f_{n-i}\cdot \binom{n-1}{i-1}\cdot (i-1)!)$$

含义就是，我们枚举 $n$ 的位置在哪，那么如果一个区间扫到 $n$。这个 $n$ 的贡献可以直接加入答案，因为 $n$ 是独一无二的在这个位置，他贡献了 $(n-1)!$ 。剩下的位置被我们分割成了两个子区间，并且满足互不干扰。因为中间的 $n$ 将他们隔开了。每个区间的贡献首先得乘一个组合数，然后它的另外一个区间随便排。

简单化简一下：

$$f_n=n!+2\cdot \sum_{i=0}^{n-1}f_i\cdot \binom{n-1}{i}\cdot(n-i-1)!$$

我们把组合数拆开来继续化简。

$$f_n=n!+2\cdot\sum_{i=0}^{n-1}f_i\cdot\frac{(n-1)!}{i!(n-1-i)!}\cdot(n-1-i)!$$

$$f_n=n!+2\cdot (n-1)!\sum_{i=0}^{n-1}\frac{f_i}{i!}$$

然后就能随便前缀和优化一下做啦。边界条件 $f_k=k!$ 。答案 $f_n$ 。