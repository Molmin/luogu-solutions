括号串诸位都知道吧 ~~（不知道的话~~[~~右转~~]()~~一头撞南墙）~~。一个由括号组成的字符串是一个符合要求的括号串当且仅当：

- 对于任意一个前缀，左括号数>=右括号数（否则最右边一个右括号匹配不上）

- 所有左括号数=右括号数（否则最左边一个左括号匹配不上）

我们把左括号当作1，右括号当作-1，那么点1满足当且仅当最小前缀和非负，点2满足当且仅当总和为0。而最大嵌套层数······只不过是最大前缀和而已（有一堆左括号等待被匹配）。

这里面只不过添加了“文本”这一项。文本的插入并不影响括号串的合法性，这里把它当成0来看待。

然后呢？单点修改（0,1,-1）整体查询，在想了会儿没有线性做法后，线段树食用最佳。这次要维护的是最小、最大前缀和和总和，合并公式：

- 总和=左子树总和+右子树总和（叶子节点时=字符代表数字本身）

- 最小前缀和=左子树最小前缀和与左子树总和+右子树最小前缀和的最小值（叶子节点时=字符代表数字本身与0的最小值）

- 最大前缀和=左子树最大前缀和与左子树总和+右子树最大前缀和的最大值（叶子节点时=字符代表数字本身与0的最大值）

代码不PO，已经发现有一对中学生猴子抄我P4815的题解代码了。

望$\tiny\color{white}\colorbox{pink}{兔}$能通过······