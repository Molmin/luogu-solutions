### $\texttt{Solution}$

首先对于排列 $p$ 的每个轮换环分开考虑，对于一个环，考虑从其最小值处断环为链，最后这个环中朝上的硬币个数为**长度为奇数的极长上升子段个数**。

这个通过手玩可以发现，是做法中最关键的性质。

考虑把所有环按最小值大小排序，从大到小的排成一排得到一个新的排列 $q$，$p$ 和 $q$ 显然有双射。

朝上的硬币个数为 $q$ 中长度为奇数的极长上升子段个数。

奇数实在是不好处理，再一步离谱的转化是把每个极长上升子段的奇数位置标 `A`，偶数位置标 `B`，如果子段长度为奇数，结尾标 `C`。

考虑一个 ABC 串对应到排列 $q$ 的方案数，列举其中的限制：

1. A 后面只能是 B，且 A 比 B 小。

2. C 后面可以是 A 或者 C，C 比其后面的数大。

3. B 后面只能是 A或者 C，没有大小限制。

我们在每一个 B 的位置断开，串将被分成若干段，除去最后一段不含 B 的若干个 C，其他段均形如：（若干个  C）+AB 的形式。

生成函数算下就好了，只要使用一次求逆和一次卷积，复杂度 $O(n\log n)$。

[code](https://atcoder.jp/contests/arc134/submissions/35452995)