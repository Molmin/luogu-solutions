期望其实是吓人的，设伤害值为 $d$ 时，亵渎发生的次数为 $f(d)$。那么答案就是：
$$
\sum_{d=L}^{R}{f(d)}
$$
形象化地说， $f(d)$ 代表：将值域每隔 $d$ 分一个块，从第一个块开始的极长包含 $1$ 的块的个数。注意到块数是调和级数 $O(n \ln n)$ 级别的，这题就没有什么难的了。

对于每一个 $d$ ，维护一个指针，记录当前极长 $1$ 块扩展到了哪，指针的移动次数是 $O(n \log n)$ 级别的，可以接受。那么问题就是怎样在插入一个数之后，快速找到需要被拓展的指针。考虑将这 $O(n \log n)$ 个块扔到线段树上，每个块会被划分为 $O(\log n)$ 个区间。那么插入 $h$ 后，包含它的块就是线段树上从根节点到 $h$ 这个叶子的路径上经过的所有节点上挂着的块，将这些块对应的 $d$ 的指针暴力移动即可。

分析时间复杂度。一个块最多会被分成 $O(\log n)$ 个区间，这个的规模是 $O(n \log^2n)$ 的，指针移动次数为 $O(n \log n)$。总时间复杂度为 $O(n \log^2n + m \log n)$。

[Code](https://www.luogu.com.cn/paste/wyx23l8e)