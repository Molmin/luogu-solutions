注：这篇题解主要阐述了本题的一个重要结论的证明，缘于 @xtx1092515503 题解的证明和网上一众题解的证明都有很明显的不完全之处；在一些地方的陈述上借鉴了 @xtx1092515503 题解的说法，在这里我还是表达感谢，但是也希望能够将正确的证明传递出去。至于在得到了该结论以后的做法，是相对容易的，各位做 ZJOI 2022 的想必肯定都会，这篇题解就不再赘述了。

在一般图上，求解「两结点间所有简单路径权值和」是困难的 —— 这启示我们从这张图的特殊性质出发思考问题。这张图 $G$ 的特殊性质是什么呢？应该是「存在一种**将 $G$ 的边权重新赋值**的方法，使得**在重新赋值过后**图上任意两个简单环的边权和相等」；我们称这样的图 $G$ 是优雅的。

优雅的图具有什么样的性质？我们很难从正面直接来回答这个问题；因此我们考虑换一个角度，即**具有什么样的性质的图是不优雅的**。我们注意到，有若干个简单环「交织在一起」的图通常来说是不优雅的。经过一些讨论，我们发现如下结论：

分析 $1$.「双弦矛盾」：若 $G$ 的某个子图 $G'$ 形如「一个简单环再加上两条不同的弦」的形式，则 $G$ 一定是不优雅的。

这里「加上两条不同的弦」指的是：在该简单环上存在两对(不完全相同的)无序结点对 $(u_0,v_0)$ 和 $(u_1,v_1)$，使得 $u_0$ 到 $v_0$ 之间、$u_1$ 到 $v_1$ 之间分别存在两条(除在顶点处外)不相交的路径 $u_0\sim v_0$ 和 $u_1\sim v_1$，当然这两条路径都是不能使用任何在该简单环上的边的。

![ABC.png](https://s2.loli.net/2022/05/16/cRik1GMAbZxpE9Y.png)

一种情况如上图所示，其中 $A\sim B\sim C$ 是我们关注的简单环，$A\sim X\sim B$ 和 $A\sim Y\sim C$ 是该环上加上的两条弦。注意该图上的任意一条边**都可以代表 $G'$ 中的一条路径**。

注意到 $(A\sim X\sim B)\sim A$ 和 $(A\sim X\sim B)\sim C\sim A$ 是两个简单环，二者的边权和一定相等 —— 这也就是说，$B\sim A$ 的长度等于 $B\sim C\sim A$ 的长度；但是从另一方面来说，$(A\sim Y\sim C)\sim A$ 和 $(A\sim Y\sim C)\sim B\sim A$ 也是两个简单环，二者的边权和也一定相等，这意味着 $C\sim A$ 的长度等于 $C\sim B\sim A$ 的长度；综上，$B\sim C$ 的长度一定为零，而这显然与「正整数边权」相矛盾。

也就是说，这一种情况肯定是不能出现在 $G'$ 中的。

![ABCD.png](https://s2.loli.net/2022/05/16/njlWTLAeoPKIb2i.png)

另一种情况如上图所示，其中 $A\sim B\sim C\sim D$ 是我们关注的简单环，$A\sim X\sim C$ 和 $B\sim Y\sim C$ 是该环上加上的两条弦。注意该图上的任意一条边仍可以代表 $G'$ 中的一条路径。

类似于刚才的论证，我们必有 $A\sim C$ 的长度等于 $A\sim X\sim C$ 的长度，同理 $B\sim D$ 的长度等于 $B\sim Y\sim D$ 的长度；而 $(A\sim X\sim C)\sim A$ 和 $(B\sim Y\sim D)\sim B$ 又是两个边权和一定相等的简单环，故而这四个长度一定两两相等。然而 $(A\sim C)\sim(D\sim B)$ 也是一个边权和与之相等的简单环，因而 $A\sim B$ 的长度、$C\sim D$ 的长度二者都一定为零，再一次与「正整数边权」相矛盾。

也就是说，这一种情况也是不能出现在 $G'$ 中的，这样就完整地阐明了「双弦矛盾」。

这样一来，在一个环上还能出现什么结构呢？「双弦矛盾」指出了在一个环上不能存在两条不同的弦，然而一个环上可以存在的是**多条相同的弦**，即无序结点对 $(u,v)$ 之间存在多条不相交的路径 $u\sim v$，如下图所示：

![AB.png](https://s2.loli.net/2022/05/16/aFmxq62jyIOpNUH.png)

其中 $A\sim B\sim C$ 是我们关注的简单环，$A\sim X\sim B$、$A\sim Y\sim B$、$A\sim Z\sim B$ 是 $A,B$ 之间的多条弦：这样的结构是合法的。现在，从单个环的角度出发已经得不到什么有意义的结论，考虑将目光转向**多个环之间的位置关系**的层面上。

受到「任意一个点不在 $\geq2$ 个简单环上」的部分分(即 $G$ 是**点仙人掌**时的情形)的启发，我们考虑 $G$ 的**点双连通分量**；显然「$G$ 是否是优雅的」这件事是「点双独立的」，即「$G$ 是优雅的」的充分必要条件是「$G$ 的每个点双连通分量都是优雅的」，这是因为跨两个不同的点双连通分量之间是不存在环的。那么，一张点双连通图 $C$ 什么时候是优雅的？我们有以下结论：

分析 $2$. 一张点双连通图 $C$ 是优雅的，当且仅当 $C$ 形如「一个简单环再加上若干条相同的弦」的形式(除却 $C$ 只包含有两个结点的特殊情形以外)。

也就是说在 $C$ 中，除却某两个结点 $S,T$ 以外，其他所有结点的度数都 $=2$。我们考虑寻找到两个 $\geq3$ 度的结点 $S,T$，我们希望 $S,T$ **共处在一个环上且还存在 $S,T$ 之间的弦**(即 $S,T$ 之间存在 $3$ 条不相交的路径)，因为这样一来，$C$ 的结构就已经大致确定下来了。

考虑点双连通图的性质：在点双连通图中，**过任意两个结点 $u,v$ 一定存在一个简单环**。除却特殊情形以外，由于 $C$ 是点双连通图，故而 $C$ 中一定存在至少一个简单环；我们考虑其中任意一个简单环。

考虑该简单环上的结点分别被哪些简单环所包含：若存在另外一个简单环，与该简单环拥有 $\geq2$ 个交点，则若两简单环之间的交是**连续的一段**，则显然可以去该连续段的段首段尾作为 $S,T$；否则我们选取靠得最近的两个(其之间交的部分**不连续的**)交点作为 $S,T$，则 $S,T$ 除了共处在原来的简单环上以外，又有另外一个环上的路径作为一条弦，二者之间就找到了 $3$ 条不相交的路径。

否则若存在另外一个简单环与其恰拥有 $1$ 个交点，设该交点是 $\tau$，我们在两个简单环上各取一个 $\tau$ 以外的结点 $u,v$，则由点双连通图的性质可知过 $u,v$ 一定存在一个简单环；前面已经说过，若 $C$ 中存在两个有 $\geq2$ 个交点的简单环则 $S,T$ 就已经找到，故而我们可以假设 $C$ 中任意两个简单环的交点个数 $\leq1$；因此，该「过 $u,v$ 的简单环」与原来简单环的交点**只有** $u$、与另一个简单环的交点**只有** $v$；故而可以直接取 $u,v$ 作为 $S,T$，则 $S,T$ 除了共处在该「过 $u,v$ 的简单环」以外，又有 $u\sim\tau\sim v$ 作为一条弦，二者之间也就找到了 $3$ 条不相交的路径。

最后若所有其他的简单环与其都没有任何交点，说明 $C$ 就是该简单环，这样的情形显然是符合要求的。

否则的话，我们就找到了两个节点 $S,T$，其之间存在着 $3$ 条不相交的路径。将 $S,T$ 与这 $3$ 条不相交的路径**看作一个「整体」**，我们考虑把 $C$ 的其他部分全部都整合到这个「整体」里来。

删去该「整体」的所有边后，若该「整体」中的所有结点的度数均 $=0$，则说明 $C$ 就是该「整体」，论证结束；否则若还存在度数 $\neq0$ 的结点 $u$，我们从 $u$ 出发任意游走，最后**总能够游走到该「整体」中的另外一个节点 $v$ 上**(否则 $u$ 就是割点了，与点双的条件相矛盾)。考虑 $u,v$，若 $(u,v)=(S,T)$，则直接**将「游走路径」加入到该「整体」当中去**即可；否则分类讨论：(1) $\{u,v\}$ 中存在 $S$ 或 $T$ (2) $u,v$ 原来在该「整体」中的同一条弦上 (3) $u,v)$ 原来在该「整体」中不同的两条弦上，容易说明矛盾。

这样一来，我们就说明了一张点双连通图 $C$ 是优雅的的充分必要条件。