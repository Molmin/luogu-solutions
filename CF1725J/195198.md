不带传送就是典题，答案是所有边权和 $\times\,2\, -$ 直径长度。

带上传送了，那么 $a \rightarrow b$ 的传送操作明显就是又把一条链省去了。因此这个时候需要在一棵树里选两条链使结果最小。

因为是取并集，显然不能直接做，可以考虑 DP。

但是直接这么做也没啥头绪，尝试找找性质之类的。

性质：两个链分成两种情况：

- 相交在一点：

	![](https://cdn.luogu.com.cn/upload/image_hosting/lob49a9x.png)
    
	直接对这个交点进行考虑。
    
- 不相交：

	![](https://cdn.luogu.com.cn/upload/image_hosting/0gqdg3t8.png)
    
    由于两条链中，有一条是有去无回的 ，中间会漏掉一些点，所以必须让它们最后走到两个相邻的点结束。
    
    两条链之间的这条边不被经过，所以我们可以考虑把每个边定为“儿子 -> 父亲”中，儿子对应的边，然后进行考虑。

相交在一点的情况：

- 考虑换根 DP。无非就是求两个过这个点的最长链的长度之和罢了。

	考虑 $dp_{u,0/1/2/3/4}$ 记录从 $u$ 出发，向下的最长 / 次长 / 第三长 / 第四长的链，以及从 $u$ 向上走的最长链。那么求过 $u$ 的两个最长链，就是选四个最大的拼起来罢了。同时我们要记录这些链的来的方向是哪些儿子，方便后面转移用。
    
    转移：$dp_{u,0/1/2/3}$ 的实质就是打擂台；$dp_{u,4}=\max dp_{fa,0 \sim 4}+W(u,fa)$。
    
    答案统计就是 $\max\limits_{i=1}^{n} \left(\sum\limits_{j \in [0,4]} dp_{i,j}-\min\limits_{j \in [0,4]}dp_{i,j}\right)$。
    
两个链不相交的情况：

- 依然是换根 DP。记录的内容和上面相同，但是这次答案统计不太一样，我们需要求出 $u$ 子树内的直径和子树外的直径。

	$u$ 子树内直径是可以直接求得；子树外的直径 $exc_u$ 也需要换根：
    
    1. 子树外的直径在 $u$ 的父亲 $fa_u$ 的子树外：$exc_u=\max\{exc_u,exc_{fa_u}\}$。
    
    2. 子树外的直径过 $fa_u$：选取 $fa_u$ 的最长的两个不经过 $u$ 的链拼起来。
    
    3. 子树外的直径在 $fa_u$ 的子树内：选取 $fa_u$ 子树内的、不在 $u$ 子树内的最长直径。
    
上述所有内容可以使用三次 dfs 解决。
    
复杂度 $O(n)$。
    
[Code & Submission](https://codeforces.com/contest/1725/submission/211711671)