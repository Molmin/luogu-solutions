- 你以为它需要字符串算法吗？
- 不，它需要的是你的脑子(╯▔皿▔)╯。
- 感谢 [$\text{ZillionX}$](https://www.luogu.com.cn/user/283913) 大佬送出的思维好题，愿其信息学道路光芒璀璨。
- 但是洛谷将我已经打好的文章给吃了 qwq，所以我只好重新打一份。
- 本文所有的字符串符号来源于[此文](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/post-zi-fu-chuan-lun)。

**题意**
- [题目](https://www.luogu.com.cn/problem/CF506E)。
- 给定字符串 $s$ 和数字 $n$，计算在该字符串中加入 $n$ 个字符后生成的回文串的个数。
- $|s|\le 200,n\le 10^9$。

**分析**
- 首先看到这个数据范围你会想到什么算法，一个数超级大，另一个数却超级小，矩阵乘法满足这个要求。
- 还有一个特殊的要求，那就是不同的操作但最后字符串相同的算作一种方案，做过[这道](https://www.luogu.com.cn/problem/AT3878)的应该都知道如何应对，应该从结果而非过程入手。
- 所以这道题目就被转化为了这种形式：计算以 $s$ 为子序列的长度为 $|s|+n$ 的回文串的个数。
- 但转化到这里并没有很好地解释这题与矩阵乘法的关系，我们先对这题进行一个简化，即计算以 $s$ 为子序列，长度为 $|s|+n$ 的字符串个数，然后找到它与矩阵乘法的关系。
- 做过[这道](https://www.luogu.com.cn/problem/AT3878)应该都知道这题一种常见的思路是标准化。
- 如何标准化？遵循贪心匹配的原则，从左到右匹配上，最后能够匹配上的一定是可以的，我们可以列出状态转移，并将其表示成矩阵的形式，这增强了我们的信心。
- 对于回文串的情况，我们希望找到一种类似的方法进行标准化。
- 没错，容易将其标准化为如下形式：相同的字符可以分别匹配掉 $s$ 的第一个位置和最后一个位置，当然，对于奇回文串，情况比较特殊，不过我们只需要特别加上只剩下一个字符的情况即可。
- 接下来我们来表示成一个形式化的式子，设矩阵 $A(i,j)$ 为当前 $s(i,j)$ 还没有完成匹配的方案数，初始时 $A(i,j)=[i=1][j=|s|]$。
- 我们考虑多一对字符串的贡献。
- 对于所有 $A(i,j)$：如果 $i\le j$，如果 $s(i)= s(j)$ 那么转移 $25$ 的贡献到 $A(i,j)$，转移 $1$ 的贡献到 $A(i+1,j-1)$，如果 $s(i)\ne s(j)$ 那么转移 $24$ 的贡献到 $A(i,j)$，转移 $1$ 的贡献到 $A(i+1,j)$，转移 $1$ 的贡献到 $A(i,j-1)$，然后我们就有了 $O(|s|^2n)$ 的算法，[代码实现](https://www.luogu.com.cn/paste/k36vmya6)。
- 问题来了，这鬼东西也能够矩乘优化吗？如果表示为 $|s|^2\times |s|^2$ 的矩阵，我们会获得 $O(|s|^6\log n)$ 的~~优秀~~时间复杂度，这显然不可接受。
- 不过我们有对于这是正解的自信，所以理理思维。

**思维**
- 我们有的工具是什么？
- 使用矩阵乘法，给出一个点数为 $m$ 的图，用每条边表示它的重数，我们可以利用矩阵乘法在 $O(m^3\log n)$ 的时间复杂度内求出该图上所有不同的长度为 $n$ 的（不一定简单的）路径。
![](https://cdn.luogu.com.cn/upload/image_hosting/pewjs3fn.png)
- 我们一开始的思路就是将整个关系图建成图直接暴力上矩阵乘法，然后得到 $O(|s|^6\log n)$ 的不可过复杂度。
- 我们唯一的方法就是尝试发现性质，简化问题的规模。
- 性质有什么？
- 我们只需要考虑起点到终点的情况，这个图也很有特点，除去所有的自环，它是一个无权（边权都为 $1$）的有向无环图，而且除了结尾有一个权为 $26$ 的自环，中间的自环权不是 $24$ 就是 $25$。
- 考虑从起点到终点的任意一条路径（长度为 $\lceil|s|/2\rceil$ 到 $s$），容易发现，$24,25$ 权重的自环是顺序是无关紧要的，重要的是它们的个数。（可以尝试建立双射证明这点）
- 所以如果我们 $O(|s|^3)$ 计算所有可能的本质不同的路径（容易发现它们的条数是 $O(|s|)$ 的），计算它们分别有几条，再分别对它们进行矩阵乘法，复杂度是 $O(|s|^4\log n)$ 的。
- 当然，这似乎显得很浪费，状态之间有着相当多的相似性，我们将所有可能的状态分为自环 $24$ 和自环 $25$ 两层，上下的连边之权重恰好为起点到终点这条路径（我们算出来的）条数，对这条类似于路径的东西进行矩阵乘法，复杂度就是 $O(|s|^3\log n)$，为可过复杂度。
![](https://cdn.luogu.com.cn/upload/image_hosting/yfh2vfya.png)

**细节问题**
- 如何特判奇回文串的情况？
- 感觉把 $A(i,i)$ 强行设为终止状态跑就可以了（其实感觉有许多方法）。
- 另外：通过自环为 $24$ 的个数 $c$ 其实也可以推出自环为 $25$ 的个数为 $\lceil \frac{n-c}2\rceil$。
- [代码实现](https://www.luogu.com.cn/paste/qn3mu0do)，轻微卡常，可以尝试利用有向无环图的性质使得矩阵乘法常数变为原来 $1/6$。
- 感觉教训就是要充分利用性质，我直接研究一般化的问题发现不可做，结果和[大佬](https://www.luogu.com.cn/user/52881)讨论他弄出了一大堆基于性质的优化（我直接尴尬。