[ABC278G](https://www.luogu.com.cn/problem/AT_abc278_g)

## 前置知识

$\text{nim}$ 游戏，$\text{sg}$ 函数。

## 思路

### $\text{Step 1}$

在博弈寻找必胜策略时有一种经典思路——将自己的操作和对手的操作一一对应，只要对手能够操作，自己就能够操作。

一个典例就是：轮流取石子，每次可以取 $1$ 个到 $3$ 个，取到最后一个石子的胜利。若石子总数为 $4$ 的倍数，有后手必胜策略：对手取 $x$ 个石子，自己就取 $4-x$ 个石子；否则有先手必胜策略：先一步取走除以 $4$ 的余数个石子，然后按照后手必胜策略做。

这道题，我们也希望能找到这样的一种“对应策略”。

具体地，我们先手将“正中心”取走一段 $[l,r]$ 。然后若对方选 $[1,l)$ 中的一段，我们就选 $(r,n]$ 中对应位置上的一段，反之亦然。

这种策略在绝大多数情况下都适用，但有一个 $\text{bug}$——当 $L=R$ 且与 $n$ 奇偶性相反时，无法取走“正中心”。

### $\text{Step 2}$

对这种情况，我们需要寻找另外的思路。

考虑一个游戏局面——由若干不交区间组成。这相当于一个 $\text{nim}$ 游戏：每一个区间都是一个独立的公平博弈游戏，每次操作只能选择且一定要选择一个区间进行游戏。

于是，预处理出 $sg_i$ 表示长度为 $i$ 的区间的 $sg$ 函数值后，就可以通过 $\text{xor}$ 表示出任意局面的 $sg$ 函数值。（$\text{nim}$ 游戏的结论）

从小到大枚举长度 $i$，求 $sg_i$ 时枚举进行一次取走操作能到的后继状态——枚举 $j$ 表示取走 $[j+1,j+L]$，则 $sg_i=\text{mex}\{sg_{j}\oplus sg_{i-j-L}\}$。复杂度 $O(n^2)$。

初始时的局面就是 $sg_n$，若 $sg_n>0$ 有先手必胜策略，否则有后手必胜策略。

如何构造方案呢？

已知当前局面是必胜态，要求找到一种当前状态的后继必败状态。

设当前共有 $k$ 条线段，长度分别为 $a_1$ 到 $a_k$。

则 $sg_{now}=sg_{a_1}\oplus sg_{a_2}\oplus\cdots\oplus sg_{a_k}$。

目标是找到一个区间 $i$，将其取走长为 $L$ 的一段，剩下两段长度分别为 $j$ 和 $a_i-j-L$，使得 $sg_{now}\oplus sg_{a_i}\oplus sg_{j}\oplus sg_{a_i-j-L}=0$。

即 $sg_{now}\oplus sg_{a_i}=sg_{j}\oplus sg_{a_i-j-L}$。

枚举 $i$，左半部分是好求的，右半部分在预处理 $sg$ 时在 $\text{xor}$ 的值域上开个桶顺便记录一下，直接查即可。单次操作复杂度 $O(n)$。

总复杂度 $O(n^2)$。

## 代码

[提交记录](https://atcoder.jp/contests/abc278/submissions/36702819)


