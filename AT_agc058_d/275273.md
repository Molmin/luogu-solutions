Orz H6_6Q，感谢他给我们带来了这道容斥好题。

这个东西看起来很不好搞。可以尝试容斥。

但是我们要容斥啥？钦定 `ABC` 不出现，其他任意？感觉还是很难算。

观察不合法子串，发现它们很有特点。如果我们钦定 $\texttt{A}$ 为 $0$，$\texttt{B}$ 为 $1$，$\texttt{C}$ 为 $2$，那么不合法串相当于 $S_i + 1 \equiv S_{i + 1} \pmod 3$。

并且我们还发现一个性质，如果 $S_{i \sim i + 2}$ 不合法，即 $S_{i \sim i + 2}$ 为 $\texttt{ABC}, \texttt{BCA}, \texttt{CAB}$ 中的其中一个，并且 $S_{i + 1 \sim i + 3}$ 也不合法，那么 **$S_{i \sim i + 3}$ 也不合法**。因为由上面不合法子串的特点我们得到了这个东西具有**传递性**。

现在我们尝试考虑每个**极长**不合法子串。发现它们既有起点又有终点。我们尝试**容斥起点**。即我们钦定有 $i$ 个极长不合法子串的起点。

极长不合法子串的长度还不确定，但是我们发现只要钦定它们的长度 $\ge 3$，即每个字母至少出现一次即可。

于是我们现在相当于有 $a - i$ 个 $\texttt{A}$，$b - i$ 个 $\texttt{B}$，$c - i$ 个 $\texttt{C}$ 是自由的。我们需要把它排成一个**初始串**。这部分的方案数由多重组合数易得为 $\frac{(a + b + c - 3i)!}{(a - i)! (b - i)! (c - i)!}$。

然后，我们需要把 $i$ 个串，每个都是 $\texttt{ABC}, \texttt{BCA}, \texttt{CAB}$ 中**之一**的串插入一开始排成的那个初始串。如果插入的位置在开头，那么 $3$ 个串都可以被选择插入；如果在中间，因为我们**容斥的是极长不合法子串的起点，也就是说它们必须是起点，其他的可以是也可以不是**，所以我们不能接在字母序上一个字母后面，导致这个字母成为了起点。具体一点就是，$\texttt{ABC}$ 不能接在 $\texttt{C}$ 后面，$\texttt{BCA}$ 不能接在 $\texttt{A}$ 后面，$\texttt{CAB}$ 不能接在 $\texttt{B}$ 后面。我们发现无论插入位置前一个字母是什么，插入的串都有 $2$ 种选择。

现在考虑统计**插入初始串并选择是 $\texttt{ABC}, \texttt{BCA}$ 还是 $\texttt{CAB}$** 的方案数。分类讨论。

- 如果没有串被放到开头，那么初始串有 $a + b + c - 3i$ 个空隙。我们需要把 $i$ 个起点分配成 $a + b + c - 3i$ 份，每份可以为空，然后再按份对应地插入到这么多空隙中，再乘上选择插入的是哪个串的方案数。于是这部分的方案数就是 $\binom{i + a + b + c - 3i - 1}{a + b + c - 3i - 1} \times 2^i$。
- 如果有 $1$ 个串被放到开头，那么我们先放一个起点到开头，那么现在的串有 $a + b + c + 3i + 1$ 个空隙，并且我们还剩 $i - 1$ 个起点。由上面的推法可得这部分的方案数为 $\binom{i - 1 + a + b + c - 3i}{a + b + c - 3i} \times 2^{i - 1} \times 3$。

然后，我们把排成初始串的方案数，和上面统计的插入并选择的方案数相乘，再乘上容斥系数 $(-1)^i$。对于每个 $i \in [0, \min(a, b, c)]$ 求和，即是答案。

**启发：容斥的东西可以是非常规的，不一定是题目直接给出的东西。**

[code](https://atcoder.jp/contests/agc058/submissions/43324511)