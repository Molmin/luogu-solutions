# D - Yet Another ABC String
首先基础的容斥是考虑**不合法位置起点集合** $\{p_1, p_2, \dots, p_k\}$，表示 $s_{p_i}s_{p_i + 1}s_{p_i + 2}\in\{\texttt{ABC},\texttt{BCA},\texttt{CAB}\}$。容斥系数就是 $-1^{k}$。

但这并不好算，因为不合法位置可能重合，这时候是比较难计数的（还要枚举重叠情况进行拼接）。

于是转而考虑直接容斥**不合法线段**：用序列 $L=(L_1, L_2, \dots, L_k)$ 表示有长度为 $L_1, L_2, \dots, L_k$ 的**不合法线段**，这时候是比较好计数的，但是容斥系数需要搓一下。

对于一个长度为 $L_i$ 的**不合法线段**，用上面的**不合法位置起点集合**的容斥系数计算，可以得到：
$$
\begin{aligned}
F_3 &= -1 & \{\{1\}\}\\
F_4 &= 1 & \{\{1, 2\}\}\\
F_5 &= 0 & \{\{1,2,3\},\{1,3\}\}\\
F_6 &= -1 & \{\{1,2,3,4\},\{1,2,4\},\{1,3,4\}\}
\end{aligned}
$$
再往下就不列举了，其实可以得到递推式，$F_k=-F_{k-1} - F_{k - 2}$，从在末尾添加点的角度考虑不难理解该式。

通过上述式子，可以找规律并归纳证明：
$$
F_i=
\begin{cases}
-1&i\equiv0\pmod 3\\
1&i\equiv1\pmod3\\
0&i\equiv2\pmod3
\end{cases}
$$
得到容斥系数之后，考虑怎么算出所有序列 $L$ 的贡献。

首先只需要考虑 $L_i=3m$ 和 $L_i=3m+1$ 的情况，前者是直接填 `ABC` 各一个上去，后者是还要多填一个单独字符。

那么可以设计一个 dp，记 $f_{i, j}$ 表示已经构造了长度为 $i$ 的字符串，多填了 $j$ 个单独字符的容斥系数。
$$
f_{i, j}=f_{i-1, j-1}+\sum_{k = 3}^{i}[k\equiv1\pmod3]f_{i-k, j - 1}-3[k\equiv0\pmod3]f_{i-k,j}
$$
前面的 $f_{i-1,j -1}$ 是指随便填一个字符，不组成**不合法线段**。

最后把计数一并加上去：
$$
\mathrm{Ans}=\sum_{i=0}^{\min(a,b,c)}\binom{n-3i}{a-i,b-i,c-i}f_{n,n-3i}
$$
得到了一个 $O(n^3)$ 的做法，瓶颈在于 dp 太慢了。

注意起点是 $f_{0, 0}=1$，转移系数固定，生成函数非常适合。

设 $G(x,y)$ 为 $f_{x, y}$ 的生成函数，可以得到：
$$
\begin{aligned}
F& = xy+\sum_{i\ge1}x^{3i+1}y-3\sum_{i\ge1}x^{3i}=\sum_{i\ge0}x^{3i+1}y-3\sum_{i\ge1}x^{3i}\\
G& = \sum_{i\ge0}F^i
\end{aligned}
$$
经典错项减一减就可以搞出来辣：
$$
\begin{aligned}
&x^3F=\sum_{i\ge1}x^{3i+1}y-3\sum_{i\ge2}x^{3i}\\
&(1-x^3)F=xy-3x^3\\
&F=\frac{xy-3x^3}{1-x^3}\\
&G=\frac{1}{1-F}=\frac{1-x^3}{1-xy+2x^3}
\end{aligned}
$$
想搞 $[x^ny^m]G$，先拆成 $G'=\frac{1}{1-xy+2x^3}$，则 $[x^ny^m]G=[x^ny^m]G'-[x^{n-3}y^m]G'$。

问题变成怎么计算 $[x^ny^m]G'$：这东西可以拆成 $G'=\displaystyle\sum_{i\ge0}(xy-2x^3)^i$，好消息是可以直接解方程。

设左边贡献 $p$ 次，右边贡献 $q$ 次，有 $\begin{cases}p+3q=n\\q=m\end{cases}$，解出 $p, q$ 后不难得到 $[x^ny^m]G'=\binom{p+q}{p}(-2)^{q}$。

直接枚举 $[x^ny^{n-3i}]G$ 即可，时间复杂度 $\Theta(n)$。
