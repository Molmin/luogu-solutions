先判掉原序列已经排好序的情况，此时答案是 $0$ 或 $1$。其他情况总可以使逆序对减少。

先做排列。发现交换 $p_x,p_y(x<y,p_x>p_y)$ 的贡献是 

$$1+2\sum_{i=x+1}^{y-1}[p_y<p_i<p_x]$$

容易发现答案选择的 $x,y$ 需要满足 $p_x$ 前面不存在比他大的（否则应该选那个），也就是前缀最大值，同时 $p_y$ 也要是后缀最小值。这样一来，我们提出所有前缀最大值，后缀最小值。放到平面里去，那么每个 $p_i$ 的贡献就是一个矩形，做一个扫描线维护最大值就行。

相同的情况也是容易的，可以发现当 $p_i=p_x$ 或 $p_i=p_y$ 时，贡献从 $2$ 变成了 $1$，于是只要加入几个矩形就行。