## CGOI Round 3 T4 灵气 题解

### subtask 1
每次加入删除点的时候直接更新每个点的答案，并取 $\max$。

### subtask 2
树剖什么的各显神通整就完了。

### subtask 3

没有删除操作，等价于最大值在当前时刻取，即去掉了“历史最大值”。

开一个数组 $sum$。

加入一个点 $x$ 时，先改 $x$ 的答案。如果 $x$ 的父边方向为 $x\rightarrow fa_x$，就令 $sum_{fa_x}$ 加上 $a_x$ 并继续往上跳，否则停止。

询问一个点时，先累加 $sum_x$。如果该点 $x$ 的父边方向为 $fa_x\rightarrow x$，就累加 $sum_{fa_x}$ 并继续往上跳，否则停止并输出答案。

这可以树剖解决。

~~但是这和正解没什么关系（）~~

### subtask 4
#### 前置知识：线段树合并

考虑离线，求出每个节点在集合中的时间段。

定义父边方向为 $x\rightarrow fa_x$ 的点为上节点，反之，为下节点。

以节点 $1$ 为根 dfs，每到一个上节点 $x$，按顺序做下列事情：

1. dfs 所有为上节点的儿子节点的子树。因为这些子树里的点的答案不会被外界干扰，所以可以直接当做独立的一棵树求。

2. 给 $x$ 开一棵 维护每个时刻集合内能到 $x$ 节点的点的权值和 的线段树，将所有为上节点的儿子节点的线段树与之合并，并将 $x$ 的区间加入其中。

3. 求出这个节点上所有询问的答案（区间最大值线段树）。

4. dfs 所有为下节点的儿子节点的子树。


到一个下节点 $x$，按顺序做下列事情：

1. 将父亲节点的线段树复制给当前节点，“复制”的意思为：
```root[x]=root[fa]```，```root[x]``` 表示 $x$ 点线段树的根节点。
2. dfs 所有为上节点的儿子节点的子树，合并。合并时需新开节点，防止污染到父亲节点的线段树。

3. 求答案，并且 dfs 所有为下节点的儿子节点的子树。

具体实现可以见 [std](/paste/d22s4is7)。
___

### 复杂度分析
瓶颈在于线段树合并。分两类考虑线段树合并操作：

对于合并至下节点的操作，可以考虑每个询问所贡献的节点被合并的次数，显然次数为 $1$。

![](https://cdn.luogu.com.cn/upload/image_hosting/cpvjl6u5.png?x-oss-process=image/resize,m_lfit,h_200,w_450)

（红色节点上的询问贡献的节点几经周折后只会经历一次合并到下节点的操作）

这一部分复杂度为节点数：$\mathcal O(n\log q)$。

对于合并至上节点的操作，为一般的线段树合并，复杂度为线段树的总结点数 $\mathcal O(n\log q)$。

证明可以用势能分析（by @ljc1301）：

可以考虑线段树总节点数的变化。

区间修改可以视为加入一个区间，一次操作最多会增加 $\log q$ 个节点。

合并两个节点时可以视为其中一个节点没了，那么每合并两个节点，总结点数会 $-1$。

再考虑每一个节点，会在一次区间修改中加入，某一次合并中被删除，所以对每个节点的时间复杂度是 $\mathcal O(1)$。
___
### 写在后面的废话
这道题真的出了很久很久~~~

这题源自于一年前的 idea，是把这道题去掉历史最大值，把树变成有向图的版本（可以缩点变成 dag），但是发现根本不可做，就放弃了。

然后某天学了淀粉质，以为把这道题放到树上就可淀粉质做。

把没有历史最大值的版本给 ac 做，被 ac 用树剖秒了，于是加上了历史最大值，以为用淀粉质还是能做。

后来发现淀粉质假飞了。但又发现把这题转成离线的方法很新，于是继续思考。

于是想了个 dsu 的做法。

后来发现 dsu 假了，于是想了个线段树合并。

我甚至打完了 std，调试的时候才发现还要撤销，以为暴力撤销复杂度是对的，并且随机数据跑很快，极限数据也很快。

和 ac 交流发现复杂度假了，而且极限数据造错了，刚准备自闭，ac 告诉我其实线段树合并可以可持久化。

（上面说的是我之前以为的做法）

之后一直以为这题是个只能停留在口胡上的题，码量爆炸且不可调。

不过打完 std 发现也不长（）

之后提交 rated 被认为假了，但我 AFO 了之后成了废物（虽然之前也是），就找了众多金钩爷（金牌爷）交流，发现是题解想错了，std 没错（就离谱），其实只是正常的线段树合并。之后修改了题解。

rated 了！

赛时被大佬用在线做法切了，神/bx/bx/bx/bx/bx。之前本来想加强成一段时间区间内的最大值，但怕容易被看出是离线，就没改。结果真的有在线做法。

附上 @ljc1301 对在线做法的理解。

![一张图](https://cdn.luogu.com.cn/upload/image_hosting/4r6lj76a.png?x-oss-process=image/resize,m_lfit,h_300,w_300)

随机数据很水，不会出数据，不会构造/kk

不过，Terraria 真是一个很好玩的游戏，快来入坑！！！/kx