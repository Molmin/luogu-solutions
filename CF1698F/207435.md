我们可以发现每次变换首尾和相邻元素组成的无序数对是不会变的，所以这一条件必要性显然，尝试证明充分性。

首先我们给出形式化的充要条件：

- $a_1 = b_1, a_n = b_n$
- $\left[\left\{a_i, a_{i+1}\right\}|1\leq i< n\right] = \left[\left\{b_i, b_{i+1}\right\}|1\leq i< n\right]$

我们可以用归纳来证明充分性。

首先 $n=1$ 时显然，假设 $n\leq m$ 时都成立，下面证明 $n=m+1$ 时也成立。

- 当 $a_2 = b_2$ 时，我们可以删去 $a_1$ 和 $b_1$，$a$ 和 $b$ 剩下的 $m$ 个元素依然满足条件，由假设得知成立。

- 当 $a_2\neq b_2$ 时，由条件可知一定存在一个 $i\geq 2$ 有 $\left\{a_i, a_{i+1}\right\}=\left\{b_1, b_2\right\}$。

  - 当 $a_{i+1}=b_1$ 时，那么一定有 $a_i=b_2$。我们可以简单地对 $[a_1,...,a_{i+1}]$ 进行变换，并且在变换后删去 $a_1$ 和 $b_1$ 也满足条件，由假设得知成立。

  - 当 $a_{i+1}\neq b_1$ 时，那么一定有 $a_{i+1}=b_2$ 和 $a_i=b_1$。[官方题解](https://codeforces.com/blog/entry/104310)中直接表示 $\left\{a_1,...,a_i\right\}\cap \left\{a_{i+1},...,a_n\right\}\neq\varnothing$ 是显然的，我们这里尝试反证。假设 $\left\{a_1,...,a_i\right\}\cap \left\{a_{i+1},...,a_n\right\}=\varnothing$，那么一定有 $\left[a_{i+1},...,a_n\right]$ 这些数只有 $a_{i+1}$（$b_2$）和 $a_i$（$b_1$）这个值有且只有一次相邻，其余的数和 $\left\{a_1,...,a_i\right\}$ 这些数都不相邻。所以对于任意的 $j\geq 2$ 都有 $b_j\in \left\{a_{i+1},...,a_n\right\}$，又由于 $a$ 和 $b$ 中数的出现次数是相同的，所以矛盾。所以 $\left\{a_1,...,a_i\right\}\cap \left\{a_{i+1},...,a_n\right\}\neq\varnothing$，我们可以选择两边相同的元素进行变换后，再把从 $a_1$ 到 “$a_i$ 新换到的位置” 进行变换，并且在变换后删去 $a_1$ 和 $b_1$ 也满足条件，由假设得知成立。

综上，得证。
