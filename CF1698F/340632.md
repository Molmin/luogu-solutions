给一个完全是图论的解法。

容易发现，如果我们连 $a_{i}\rightarrow a_{i+1}$ 这样一条有向边，从 $a_1$ 开始沿着 $a_{i}\rightarrow a_{i+1}$ 走，则会走出原图的一个欧拉路径。

当我们反转 $[l,r]$ 的时候，到底发生了什么？不难发现 $a_l\rightarrow a_{l+1}\rightarrow ... \rightarrow a_{r}(a_l)$ 是一个环，我们反转以后相当于把它反过来走了一遍。

把边看为无向边，然后设初始图为 $G$，显然，$G$ 的任何一条欧拉路，都可以对应出一个序列 $b$。关键是证明：所有这样得到的序列 $b$ 都可以通过对序列 $a$ 操作得到。

假设 $a$ 与 $b$ 序列在第 $x$ 处开始不同，由题意 $1\lt x\lt n$，否则无解。

设 $u=a_x,v_1=a_{x+1},v_2=b_x$。则一开始我们在 $u$ 点，会走 $u\rightarrow v_1$ 这条边，我们需要证明可以通过若干次环的反转，可以使得其走 $u\rightarrow v_2$ 这条边。

需要注意的是我们走的第一个环一定是边 $u\leftrightarrow v_1$ 所在的环。因为反转环只是调整了你遍历这个环内部点的顺序，但是两个环谁先遍历谁后遍历自始至终是严格确定的。

需要注意的是，在 $a$ 中，虽然你先遍历的是 $u\leftrightarrow v_1$，但是你同样需要在后续某个时刻遍历 $u\leftrightarrow v_2$；在 $b$ 中，虽然先遍历的是 $u\leftrightarrow v_2$，但同样需要在某个时刻遍历 $u\leftrightarrow v_1$ 这条边。这告诉我们，在图 $G$ 中，这两条边都会在一个环上。

好，假设在 $a$ 的欧拉路中，最后 $u\leftrightarrow v_2$ 这条边定向是 $v_2\rightarrow u$，我们发现路径 $u\rightarrow v_1\rightarrow ... \rightarrow v_2\rightarrow u$ 就是一个环，反转它，则就变成了先遍历 $v_2$ 而不是 $v_1$。

类似地，我们假设最后这条边定向是 $u\rightarrow v_2$，则由于它在一个环中（这个环应该不包含边 $u\leftrightarrow v_1$，一定有这样一个环存在，证明见下），反转这个所在环，则定向变为 $v_2\rightarrow u$，回到了上述情况。

由此，我们证明了 $G$ 跑任何一个欧拉路跑出来的序列都是可以得到的，由此我们可以判断是否有解等价于两个序列构造出来的图是否同构。

然后考虑构造方案，根据刚才的证明过程，实质上告诉我们可以从前往后一位位确定，而且每一位的操作次数不超过 $2$（最多反转两次）。

具体地，设 $a_i\neq b_i$，假设存在一个 $j\gt i$ 使得 $a_j=a_{i-1}$ 且 $a_{j-1}=b_i$，则执行一次翻转 $[i-1,j]$ 就可以让第 $i$ 位相同。我们发现其实这等价于上面证明中的第一种情况（即定向为 $v_2\rightarrow u$）。

如果没有这样的 $j$ 存在，那就是第二种情况，也就是存在某个 $\ge i$ 的 $j$ 满足 $a_j=a{i-1}$ 且 $a_{j+1}=b_i$ 了。此时一定存在一个子区间，左端点 $\ge l-1$ 且包含 $[j,j+1]$（也就是上面说的：一定存在于“一个环”中），找到这个区间，反转后又变成了上述情况。

欸我们发现其实这里的构造和上面的证明完全是一一对应的啊。所以操作次数其实 $\le 2\times (n-2)$，时间复杂度 $O(n^3)$。

[记录](https://codeforces.com/contest/1698/submission/162711548)

--------

P.S. 关于所谓的环一定存在的证明。（其实就证明了官方题解所谓的一定存在一个能反转的区间包含 $[j,j+1]$）

我们设 $u\rightarrow v_1\rightarrow ...\rightarrow u$ 是个极小环，当且仅当这个环只出现了两次点 $u$（中间没有再回到过点 $u$）。

那么 $u\rightarrow x$ 和 $y\rightarrow u$ 的边只会出现刚好一次。

所以 $u\rightarrow v_1$ 和 $u\rightarrow v_2$ 不可能同时出现在这个极小环上。

又因为 $u\rightarrow v_2$ 在某个环，所以这个“某个”环不应该存在 $u\leftrightarrow v_1$。

这个东西其实挺难表述出来的，但是想通了以后并不难。如果遇到困难欢迎私信交流（）

Bonus：CF1458D（其实我觉得比这个题简单）