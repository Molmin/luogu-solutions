## $\text{Statement}$

对于一个长度为 $n$、其中元素取值为 $[1,n]$ 内整数的序列 $A = (A_1, A_2, \dots, A_n)$，以及一个整数 $i(1\le i \le n)$，我们按如下方式定义一个长度为 $10^{100}$ 的序列 $B_i = (B_{i, 1}, B_{i, 2}, \dots, B_{i, 10^{100}})$：

- $B_{i, 1} = i$。
- $B_{i, j + 1} = A_{B_{i, j}} (1 \le j < 10^{100})$。

此外，我们定义 $S_i$ 为 $B_i$ 中只出现一次的整数的数量。定义一个序列的贡献为 $\sum_{i=1}^n S_i$。

给定正整数 $n, m$，你需要求出总共 $n^n$ 种可能的序列的贡献之和模 $m$ 的值。

$1\le n \le 2\times 10^5,\ 10^8 \le m\le 10^9$。

## $\text{Solution}$

由于答案具有对称性，任意 $S_i$ 的贡献等于 $S_1$，接下来我们只需要讨论 $S_1$。下文中简记 $B_{1, i}$ 为 $B_i$。

我们令 $k$ 为一种可能中满足前 $i$ 个元素彼此不同的最大的 $i$，随后来分别对确定的 $k$ 计数种类数。 

我们已经确定了 $B_1 = 1$，这样就需要从 $n-1$ 个彼此不同的元素中选 $k-1$ 个，也就有 $A(n-1, k-1)$ 种可能性。关注 $B_{k + 1}$，可以发现其必定与前 $k$ 个中的一个元素相同。假设 $B_p = B_{k + 1} (1\le p \le k)$，则我们可以发现，$B_p$ 到 $B_k$ 的子序列定会无限循环下去。  
因此，只有 $B_1$ 到 $B_{p-1}$ 对应的子序列是只在 $B$ 中出现一次的序列，对答案的贡献即为 $p-1$。对所有可能的子序列贡献求和得到这一部分对答案的贡献 $\sum_{p=1}^k (p - 1) = p(p-1)/2$。

现在固定 $B_1$ 到 $B_{k + 1}$ 段的序列，考虑有多少 $A$ 满足当前的条件。由于 $B_i$ 固定等价于 $A_{B_{i-1}}$ 被确定，可以发现 $A_{B_1}, A_{B_2}, \dots, A_{B_k}$ 都是已经确定了的，因此 $A$ 中没有确定的元素还有 $n - k$ 个。  
因此对 $k$ 的答案即为

$$A(n-1, k-1)\times n^{n-k}\times \frac{p(p-1)}2 $$

对 $1\le k\le n$ 求和即可得到 $S_1$。总时间复杂度 $O(n)$。

[Submission](https://atcoder.jp/contests/abc284/submissions/37849720).