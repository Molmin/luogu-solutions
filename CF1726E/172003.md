[题目链接](https://www.luogu.com.cn/problem/CF1726E)

题目大意：$T$ 组数据，每组给定一个 $n$，求对于所有 $n$ 阶排列 $p$，设其逆为 $q$，有多少个使得对于任意 $1\le i\le n$ 有 $|p_i-q_i|\le1$。其中，$p$ 的逆 $q$ 为满足 $q_{p_i}=i$ 的唯一排列。

$1\le T\le10^3,1\le\sum n\le3\times10^5$

小清新数学题。

首先发现，对于任意 $i$ 有 $|p_i-q_i|=1$ 等价于对于任意 $i$ 有 $|p_{p_i}-i|=1$。

然后，很容易想到把排列转换成有向图，即 $i$ 向 $p_i$ 连边，那么，这个图实际上是由若干个环构成。

那么，条件就是任意点 $i$ 沿边跳两下跳到 $j$ 都有 $|i-j|\le1$。

于是，我们可以两下两下的跳，由于 $i$ 一定在某个环里，可以发现最后一定会跳回 $i$：$i\to i_1\to i_2\to\cdots\to i_k\to i$。

然后，我们发现，只要 $k\ge2$，即跳的步数超过 $2$，那么这个排列一定不合法。

为什么呢？

考虑由于 $i_1\ne i$，必有 $i_1=i+1$ 或 $i_1=i-1$。

如果 $i_1=i+1$，则由于 $i_2\ne i_1$，必有 $i_2=i_1+1$ 或 $i_2=i_1-1$。

而 $i_2\ne i=(i+1)-1=i_1-1$，故 $i_2=i_1+1=i+2$。

同理，$i_3=i_2+1=i+3$，$i_4=i+4$，$\cdots$，$i_k=i+k$。由于 $k\ge2$，故 $i_k=i+k\ge i+2$，故 $|i_k-i|\ge2$，不合法。

$i_1=i-1$ 情况类似。

然后，我们就可以把 $p$ 拆成环，考虑每个环的合法性。

一元环、二元环的合法性是平凡的，因为其上面任何一个点跳两步都会跳回自己。

三元环可以吗？不行。假设这个三元环是 $\begin{pmatrix}a&b&c\\b&c&a\end{pmatrix}$，那么从 $a$ 开始跳就会跳出 $a\to c\to b\to a$，跳的步数超过 $2$，不合法。

四元环呢？可以，但有条件。假设这个四元环是 $\begin{pmatrix}a&b&c&d\\b&c&d&a\end{pmatrix}$，那么 $a\to c\to a$，$b\to d\to b$，所以 $|a-c|\ge1$，$|b-d|\ge1$，而 $a\ne c$，$b\ne d$ 故 $|a-c|=|b-d|=1$。

然后，五元环、六元环及更长的环一定要跳超过 $3$ 步才能回来。所以，题目等价于求只由一元环、二元环和满足下列条件的四元环的 $n$ 阶排列个数：

- 若这个四元环是 $(a,b,c,d)$，那么 $|a-c|=|b=d|=1$。

发现一元环和二元环没有多余的限制，发现只由一元环、二元环构成的排列个数只与长度有关。于是设 $f_i$ 为长度为 $i$ 的，只由一元环、二元环构成的排列个数。

可以推出式子来：

$$f_i=f_{i-1}+(i-1)f_{i-2}$$

$f_{i-1}$ 表示第 $i$ 个元素自成一环，$(i-1)f_{i-2}$ 表示枚举第 $i$ 个和前面 $i-1$ 个中的某一个凑成二元环。

于是，想到把 $n$ 个元素选出若干个组成四元环，再乘上剩下来的元素的 $f$ 值。

而两个相邻的、没有重复元素的元素对可以组成两种四元环，即 $(a,a+1)$ 和 $(b,b+1)$ 可以组成 $(a,b,a+1,b+1)$ 和 $(a,b+1,a+1,b)$ 两个不同的四元环，而一个相邻的元素对可以对应这对元素间的间隔，那么选出两个这样的元素对就是在 $n$ 个元素的 $n-1$ 个间隔中选出两个不相邻的间隔。

假设我们要选出 $k$ 个四元环，那么我们要选出 $2k$ 个不相邻的间隔，再把这 $2k$ 个间隔两两配对组成 $k$ 个四元环，那么我们最终的答案是

$$\sum_kf_{n-4k}g_kh_k2^k$$

其中 $g_k$ 为 $n-1$ 个间隔选出 $2k$ 个不相邻的间隔的方案个数，$h_k$ 为把 $2k$ 个间隔两两配对的方案数，多出来一个 $2^k$ 是因为每一个间隔的配对可以产生两种四元环。

$h_k$ 是简单的，考虑枚举第 $2k$ 个间隔和前 $2k-1$ 个间隔中的哪个配对，即

$$h_k=(2k-1)h_{k-2}$$

递推得 $h_k=(2k-1)\times(2k-3)\times\cdots\times3\times1=\dfrac{(2k)!}{k!2^k}$。

而 $g_k$ 可以用组合意义推出来。

$g_k$ 等价于有 $n-1$ 个排成一排的一样的球，选 $2k$ 个，使得其两两不相邻。

可以先选出 $2k$ 个球排成一排，再把剩下的 $n-2k-1$ 个球插到 $2k$ 个球的间隙里，使它们不相邻。（注意，由于球是一样的，所以选出 $2k$ 个球排成一排的方案数是 $1$）

由于不能相邻，我们可以先把 $n-2k-1$ 个球中选 $2k-1$ 个插到 $2k$ 个球的间隙里，确保不能相邻。（这里的方案数也是 $1$）剩下 $n-4k$ 个球。

然后，我们要把 $n-4k$ 个球放到 $2k$ 个球包括两端的 $2k+1$ 个间隙里，没有限制，用隔板法可知是 $\dbinom{n-2k}{2k}$。

所以，最终答案即为：

$$\sum_kf_{n-4k}\dbinom{n-2k}{2k}\dfrac{(2k)!}{k!2^k}2^k=\sum_kf_{n-4k}\dfrac{(n-2k)!}{(n-4k)!k!}$$

代码里 $a$ 是阶乘，$b$ 是阶乘的逆元，还是很好写的。

```cpp
#include <bits/stdc++.h>
#define P 998244353ll
#define ll long long
using namespace std;
namespace QYB {
    ll f[300005], a[300005], b[300005];
    int main() {
        f[0] = f[1] = a[0] = 1; b[300000] = 988693096ll;
        for (int i = 2; i <= 300000; i++) f[i] = (f[i - 2] * (i - 1) % P + f[i - 1]) % P;
        for (int i = 1; i <= 300000; i++) a[i] = a[i - 1] * i % P;
        for (int i = 300000; i >= 1; i--) b[i - 1] = b[i] * i % P;
        int t; scanf("%d", &t);
        while (t--) {
            int n; ll ans = 0; scanf("%d", &n);
            for (int i = 0; i * 4 <= n; i++) {
                (ans += f[n - 4 * i] * a[n - 2 * i] % P * b[n - 4 * i] % P * b[i] % P) %= P;
            } printf("%lld\n", ans);
        } return 0;
    }
} int main() {
    return QYB::main();
}
```