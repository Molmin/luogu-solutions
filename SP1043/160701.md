>题目传送门: [$SP1043$](https://www.luogu.com.cn/problem/SP1043)    

题意:给出了序列以及$m$组询问，求每组询问区间内的最大子段和.  

首先，$GSS$全是数据结构题，因此我们不会去用之前$O(n)$的方法查询，因为这样在最坏情况下时间会退化为$O(nm)$  

否决了$O(nm)$的做法之后，再考虑数据结构的话，线段树就是一个不错的选择了.  

但是这颗线段树需要维护些什么呢，我们来具体分析一下。  

目标是最大子段和，我们以根节点与左右子节点的$push\_up$关系来加以阐明,查询也就没什么区别了  

对于一个大区间的最大子段和(记为$dat$),它无非有三种情况:  
1. 它就是左区间的最大子段和(一定在左区间)  
2. 它就是右区间的最大子段和(一定在右区间)  
3. 它横跨左右两个区间  

这三种情况取最大值即可。对于前两种情况,我们很好维护，但第三种呢?  
举个例子:
```
2 -4 3 1    -2 4 3 1
```  
这个区间的最大子段和是$[3,8]$,对于横跨两边的最大子段和，毋庸置疑的是它一定包括:**左区间的右端点和右区间的左端点**。此后的一切都是它根据这个延伸出来的。比如在上面的例子中，我们将左区间的$1$再扩展到$3\ 1$,将右区间的$-2$扩展到$-2\ 4\ 3\ 1$

再继续观察，我们可以发现:  
*  对于左区间,它的延伸区间一定是以右端点为终止点的最大子段和.($lmaxn$)  
*  对于右区间,它的延伸区间一定是以左端点为起始点的最大子段和.($rmaxn$)  

所以我们的线段树再维护一个$lmaxn$和$rmaxn$,那我们又怎么求出每个区间的$lmaxn$和$rmaxn$呢.还是举两个例子  

```
2 4 -3 5  2 -3 1 2
```  
对于这一个区间,它的$lmaxn$是$[1,5]$  

```
2 4 -9 5 2 -3 1 2
```  
对于这一个区间,它的$lmaxn$是$[1,2]$  

多举几个例子，很容易看出:  
* $lmaxn$要么就是左区间的$lmaxn$,要么就是整个左区间加上右区间的$lmaxn$  
* $rmaxn$要么就是右区间的$rmaxn$,要么就是整个右区间加上左区间的$rmaxn$  
至于这个结论为什么成立，读者自证.  

到这里，我们就能够明确地看到，这个线段树要维护$4$个信息:$dat,lmaxn,rmaxn,sum$ ，更新方式为:  
$$\texttt{tr[p].dat=max\{tr[p<<1].dat,tr[p<<1|1].dat,tr[p<<1].rmaxn+tr[p<<1|1].lmaxn\}}$$

$$\texttt{tr[p].lmaxn=max\{tr[p<<1].lmaxn,tr[p<<1].sum+tr[p<<1|1].lmaxn\}}$$  

$$\texttt{tr[p].rmaxn=max\{tr[p<<1|1].rmaxn,tr[p<<1|1].sum+tr[p<<1].rmaxn\}}$$  

$$\texttt{tr[p].sum=tr[p<<1].sum+tr[p<<1|1].sum}$$  

查询时也以此类推，即可求出最大子段和。  

[$\mathcal{CODE}$](https://www.luogu.com.cn/paste/bl26t9vc)