下文中称御道为黄金边、非御道为普通边，先考虑 $30$ 分暴力怎么做.

任意求出原图的一棵生成树，借助这棵生成树求出黄金边的集合.

枚举不在生成树上的边 $(u,v)$，考虑将 $(u,v)$ 以及生成树上 $u$ 到 $v$ 的路径上，边的属性都确定下来.

- 若在之前，这些边的状态都未被确定：

  注意到 $(u,v)$ 以及该生成树共同构成一棵生成基环树，在该环上任意去掉一条边，均为一棵生成树.

  依次枚举去掉哪条边，并询问该生成树，则一共只有两种可能的答案；去掉某条边之后，答案比较大说明该条边是普通边，比较小说明是黄金边.

  若所有边去掉之后，答案都一样，由于不可能都是黄金边，则说明都是普通边.

- 若在之前，至少有一条边的状态已被确定：

  在该基环树上，任取一条已被确定的边，断开并询问；再依次枚举未被确定的边，断开并询问，比较两次询问的结果，一样说明该条边和取的那条边属性一致，不一样说明属性不一致.

以上算法用一次询问，可以处理一个未被确定的边的属性，并在每个环上至多浪费一次询问；故而，消耗的询问个数 $\leq2m$，可以获得 $30$ 分.

继续推进，考虑在上述步骤中，只求出生成树上的边的属性.

具体地，若之前都未被确定，则基环树在断开 $(u,v)$ 后就是原生成树，无需额外询问，其他照常枚举即可；若之前存在被确定，则任取一条，断开并询问之后，再枚举的时候，只枚举在生成树上未被确定的边即可.

在求出生成树上的边的属性之后，依次枚举不在生成树上的边 $(u,v)$，在 $u$ 到 $v$ 的路径上，任意断开一条边并加上 $(u,v)$ 这条边，比对其询问结果与原生成树询问结果，一样说明属性一致，否则不一致.

则生成树上的边，每条各最多消耗两个询问，总共消耗的询问个数 $\leq2n$；不在生成树上的边，每条各最多消耗两个询问，总共消耗的询问个数 $\leq m$，可以获得 $51$ 分.

考虑减少浪费，注意到其实，可以指定任意生成森林，并用一次询问求出，该生成森林中的边，一共有多少条黄金边；具体地，只需要维护一个并查集，先将该生成森林中的边加入并查集中，再依次考察生成树上的边，若其端点，在并查集中不已经连通，则将该边加入并查集中；用一次询问问出并查集中的所有边，中的黄金边条数，再去除掉生成树上的边，所带来的贡献即可.

一个结点的所有邻接边，构成一片生成森林；考虑依次枚举每个结点，并找出该结点的邻接边中，所有的黄金边；我们先将所有邻接边，单独拎出来考虑，设共有 $\mu$ 条邻接边，编号为 $1,2,\cdots,\mu$.

分治，当前处理的区间是 $[1,\mu]$；在处理区间 $[l,r]$ 时，需要已知该区间的邻接边中，黄金边的条数；若为 $0$ 则直接返回即可，若 $l=r$ 则说明，找到了一条黄金边；否则设 $p=\lfloor\dfrac{l+r}2\rfloor$，询问出区间 $[l,p]$ 中黄金边的条数，并递归到 $[l,p]$ 和 $(p,r]$ 进行处理.

设区间 $[1,\mu]$ 中一共有 $\gamma$ 条黄金边，则以上算法，用不超过 $\gamma\cdot\lceil\log\mu\rceil$ 条询问，即可找出所有的黄金边.

该算法所消耗的询问次数为 $n\log n+3n-\mathcal{O}(1)$，时间复杂度为 $\mathcal{O}(n^2\log n)$，空间复杂度为 $\mathcal{O}(n^2)$.

代码链接：https://loj.ac/s/1380935