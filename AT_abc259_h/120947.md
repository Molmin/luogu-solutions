## Solution

根号分治。

第一种做法，也是最自然的，枚举两两颜色相同的数。假设点 $(a,b)$ 要走到点 $(c,d)$，方案数是 $C_{c+d-a-b}^{c-a}$。

第二种做法，对于每种颜色分开考虑。我们设 $dp_{a,b}$ 是从某个钦定颜色走到格子 ${a,b}$ 的方案数。显然有 $dp_{a,b}=dp_{a,b-1}+dp_{b,a-1}+[col_{a,b}=tag]$。

这两种做法都是 $O(n^4)$ 的。

但是你细品，如果同种颜色的数很少，那么第一种做法很快。

如果颜色种类很少，也就是同种颜色的数很多，那么第二种做法很快。

这种根据数据大小确定复杂度的，而且正好存在各有所长的两种做法，考虑使用根号分治。

假设一个阈值 $B$。那么 $\ge B$ 的数用第二种做法。最多有 $\frac{n^2}{B}$ 种这样的颜色，所以复杂度为 $O(\frac{n^4}{B})$。

$< B$ 的数用第一种方法。假设每种颜色的个数是 $x_i$，那么你要在 $\sum x_i$ 一定的时候最大化 $\sum x_i^2$ 来估算最差复杂度。

由于 $(a+b)^2 \ge a^2+b^2$，那么应当每个数都取到最大值。也就是 $x_i=B$。这样最多有 $\frac{n^2}{B} \times B^2=n^2B$ 的计算次数。

总复杂度是 $O(n^2B+\frac{n^4}{B})$。当 $B=n$ 时取最小值  $O(n^3)$。

代码非常简单。