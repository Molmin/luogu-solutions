[获得更不好的阅读体验，你可以前往我的博客](http://zhylj.cc/index.php/archives/59/)。

观察样例可以发现，最开始的 $4\times 4$ 的每一行 / 每一列都包含了 $1,2,3,4$ 四个元素。再注意到表格有一部分是重复的，于是猜想：

**引理 1**：对于左上角 $2^{n}\times 2^n$ 大小的矩形，每一行每一列都包含 $1,2,\cdots,2^n$ 的数。

**证明**：考虑对 $n$ 施归纳法，当 $n = 1$ 时显然成立。

否则当 $n > 1$ 时由归纳假设左上角的 $2^{n-1}\times 2^{n-1}$ 矩形的每行每列都包含了 $1,\cdots,2^{n-1}$，故左下角和右上角的 $2^{n-1}\times 2^{n-1}$ 矩形不可能包含在 $1,\cdots,2^{n-1}$ 之中的数，这相当于把 $\operatorname {mex}$ 的「最小正整数」的限制，变为「$>2^{n-1}$ 的最小整数」的限制。故把左上角的数加上 $2^{n-1}$ 放在左下角和右上角即是新的方案。而对于右下角的数，只受内部和右上角、左下角的影响，但左上角、右下角又全部超过了 $2^{n-1}$，所以实际上不可能影响到它，故这部分的数也就和左上角完全相同了。

容易验证新的矩阵仍然满足条件。

**引理 2**：$a_{i,j}=(i-1)\oplus (j-1) + 1$，其中 $\oplus$ 为按位异或。

**证明**：考虑先前的构造方法，假如我们把整个矩阵所有数减一，并且行列的编号也全部减一，那么我们递归的过程实际上是在依次考察 $i,j$ 的最高位：若 $i,j$ 的最高位不同（位于左下角或右上角），则加上 $2^{n-1}$，然后去掉最高位（进入左上角）。可以发现这就是异或的过程。

接下来我们考虑直接把整个矩阵所有数减一，并且行列的编号也全部减一后的答案。

考虑数位 dp，首先矩阵可以拆成四个前缀，然后记 $f_{0/1,0/1,0/1,n}$ 表示考虑了最高 $n$ 位，$i$ 是否顶到了上界，$j$ 是否顶到了上界，$i\oplus j$ 是否顶到了上界的方案数。转移考虑直接枚举 $i,j$ 在这一位分别是什么，判断一下是否合法以及是否继续顶着上界即可。

[代码链接](https://codeforces.ml/contest/809/submission/129928248)。