### *[CF1845E Boxes and Balls](https://www.luogu.com.cn/problem/CF1845E)

用序列 $b$ 描述球的状态，其中 $b_1 < b_2 < \cdots < b_{|b|}$ 表示所有有球的位置。

设初始状态为 $a$。考虑状态 $b$ 合法的充要条件。

首先球的个数 $c$ 不变，因此 $|a| = |b| = c$。

求出从 $a$ 变成 $b$ 的最小步数 $f(b) = \sum_{i = 1} ^ c |a_i - b_i|$，如果 $f(b) > k$ 则不合法。否则我们可以让一个球反复横跳，使得恰好操作 $f(b) + 2t$（$t\in \mathbb N$）次也可以达到状态 $b$。因此若 $k - f(b)$ 是偶数，则状态合法。否则 $k - f(b)$ 是奇数，而每次操作必然改变 $\sum b_i$ 的奇偶性，所以恰好操作 $k$ 次时 $\sum a_i$ 和 $\sum b_i$ 奇偶性不同，一定不合法。

因此，一个状态合法当且仅当 $|a| = |b|$ 且 $f(b)\leq k$ 且 $2\mid k - f(b)$。

设 $f_{i, j, s}$ 表示考虑到第 $i$ 个位置，已经放了 $j$ 个球且当前 $f$ 值为 $s$ 的方案数，枚举 $i + 1$ 是否放球转移到 $f_{i + 1, j, s}$ 和 $f_{i + 1, j + 1, s + |i + 1 - b_{j + 1}|}$。复杂度是 $\mathcal{O}(n ^ 3)$，不够优秀。

关于不降序列对应位置距离之和，有经典套路：**在每个间隔处统计答案**。设 $z(b, i)$ 表示方案 $b$ 相较于原方案，在 $i$ 前缀多出的球的个数。若 $z(b, i) < 0$ 说明 $a$ 比 $b$ 在 $i$ 前缀多出 $-z(b, i)$ 个球。那么需要有 $|z(b, i)|$ 个球通过位置 $i\sim i + 1$ 之间的间隔，$f(b) = \sum |z(b, i)|$。

因为序列递增，所以 $z(b, i)$ 和 $z(b, i + 1)$ 相差不超过 $1$。根据等差数列求和公式，$\max |z(b, i)| = \mathcal{O}(\sqrt k)$。

设 $f_{i, j, s}$ 表示考虑到第 $i$ 个位置，$z(b, i) = j$ 且 $\sum_{p = 1} ^ i |z(b, i)| = s$ 的方案数，枚举 $i + 1$ 是否放球，求出 $z(b, i + 1)$，然后将 $s$ 加上 $|z(b, i + 1)|$。

答案即 $\sum f_{n, 0, k - 2t}$。时间复杂度 $\mathcal{O}(n ^ 2\sqrt n)$。[代码](https://codeforces.com/contest/1845/submission/211558765)。

类似题目：CF1615F。