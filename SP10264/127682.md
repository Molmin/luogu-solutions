> 高一刚开始学这个，wtcl

***
**带修区间第 $k$ 小**

整体二分：一些题目可以二分解决。但如果有多次询问的话，很有可能会超时。这时候我们可以用到整体二分（离线），将多个询问一起解决。也叫按值域进行分治。

查询序列第 $k$ 小，显然可以二分答案，记为 $ans$ ，对于每一个 $ans$，扫一遍全序列，看看比 $ans$ 小的有多少个。如果小于 $k-1$ 个，答案大于 $ans$，反之一样的道理。

如果有若干个操作：

1. 修改序列一个数

2. 求 $[l_i,r_i]$ 的第 $k_i$ 小是多少

每次都二分复杂度爆炸，考虑整体二分。

首先要注意的是，修改和询问的相对顺序无论如何二分分治是都不能改变的，因为要保证时间的顺序性。

如何整体二分？依旧二分答案的值域，设我们二分当前值域为 $lval,rval$，则 $(lval+rval)/2=mid$ 即为当前 $ans$。由于每次二分出来的 $ans$ 是不变的。可以维护一个树状数组快速得出每个询问 $[l_i,r_i]$ 中比 $ans$ 小的有多少个。也就从而知道了这个询问的答案是 $[lval,ans)$ 还是 $[ans,rval]$。

得知了每个询问答案与 $ans$ 的关系，那么很多信息其实就对这个询问无用了。比如我知道第十个操作是询问，知道询问答案的值域是 $[5,10]$，那么如果第七个操作是将修改，将序列第二项原本的 $2$ 改成 $4$。对第十个操作询问答案值域是没有任何逼近作用的。

所以这个询问，我们只用管修改之前的数在 $[5,10]$ 之间的和修改之后的数在 $[5,10]$ 之间的修改操作。这样容易算重，我们把修改改成一个删除操作加一个添加操作就可以了。注意初始的序列也可以把它变成添加操作。

我们只需要将所有答案值域在 $[lval,ans]$ 的询问和添加或者删除值在 $[lval,ans]$ 的所有操作放一起，将所有答案值域在 $(ans,rval]$ 的询问和添加或者删除值在 $(ans,rval]$ 的所有操作放一起分别递归即可。

这里的询问信息是可以传递的，因为如果它答案值域比 $ans$ 小，它还是左值域的第 $k$ 小，如果它答案值域比 $ans$ 大，那询问的 $k$ 就变成了 $k-cnt$ 个， $cnt$ 为这个询问 $[l_i,r_i]$ 中比 $ans$ 小的有多少个。

最后就是边界情况，$lval==rval$ 的时候当前序列所有询问答案即为 $lval$。如果序列为空，直接返回。

***

**[SP10264 METEORS](https://www.luogu.com.cn/problem/SP10264)**

依然是整体二分，二分答案的值域，初始为 $[1,k]$，依旧设我们二分当前值域为 $lval,rval$，则 $(lval+rval)/2=mid$ 即为当前枚举的 $ans$。

如果 $lval == rval$ 直接扫一遍 $[l,r]$ 更新答案。注意一个小技巧，为了判断如果 $k$ 轮依然不够的情况，我们可以在后面自己添加一场流星雨，是 $[1,m]$ 范围且数量极大。这样如果搜出来的答案是 $k+1$ 那么就是无解。

假设 $[1,lval)$ 场流星雨我们都已经算过了，那我们现在只需要算 $[lval,mid]$ 次流星雨即可。将操作序列扫一遍，将前 $mid-lval+1$ 场拿树状数组维护 ( 维护差分序列 )，并放入左边的递归序列。将剩下的场次直接放入右边的递归序列。

对于每个国家的询问，我们暴力枚举它拥有的所有空间站所拥有的陨石数，记和为 $cnt$。如果大于等于 $p[i]$ ，那么答案值域即为 $[lval,mid]$，放入左侧递归序列。否则答案值域为 $(mid,rval]$，将 $p[i]$ 减去 $cnt$，把这个操作放入右边的序列，它只需要递归右边的时候再下 $p[i]-cnt$ 个陨石就行了。

还有一个小技巧，如果 $l > r$ 的话把它拆成两个操作就行，就不用考虑环了。但注意计数的时候还要把它们看成一场流星雨。



