其实就是求：

$$
ans(l, r)=\sum_{i=l}^r\sum_{j=i}^r[\max(i, j)-\min(i,j)=j-i]
$$

考虑扫描线

对于一个右节点，它到上一个比它大的节点之间的所有节点最大值变成它，最小值类似

注意到剩余点不变，然后右端点 +1

注意到移动右端点的时候我们需要处理贡献

考虑每一个点的贡献是它能与右边多少个节点产生贡献

考虑这东西其实并不好修改

他完全可以出这种 `2 1 4 3 6 5` 的数据恶心死你

不过其实线段树是支持计算区间某个特定数的个数的

没错这个数就是 $0$ 

考虑对于每一个左端点，维护有多少个右端点和他满足 $\max - \min - (j-i) = 0$

考虑对于一个点 $\max \min$ 修改次数都是 $O(1)$ 的

考虑 $j$  每一次移动就是区间减

因此其实右端点贡献个数可以维护。。。就是值为 $0$ 的点数。。。

考虑它还有区间修改什么的

因此还要维护一个区间最小值和最小值个数

然后还有一个问题就是要记录历史答案

考虑每一次修改前打个 tag 就做完了

注意一下这个 tag 只能打给符合条件的点

复杂度 $O(n\log n)$