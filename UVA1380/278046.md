一个结论，忽略无向边后，设图上的最长链包含 $k$ 个点，则答案为 $k$ 或 $k + 1$。

于是我们二分一个 $x$，检查是否能够通过给无向边定向使得最长链不超过 $x$。

*   $f(i)$ 表示 $i$ 子树内定向后向上最长链最小值。
*   $g(i)$ 表示 $i$ 子树内定向后向下最长链最小值。
*   不合法的状态为正无穷。

*   $u, v$ 间为有向边：
    *   $v \rightarrow u$，$f(u)' = \max f(v) + 1$。
    *   $u \rightarrow v$，$g(u)' = \max g(v) + 1$。
    *   $f(u)' + g(u)' \gt x$，$f(u) = g(u) = + \infty$。
    *   $f(u)' + g(u)' \le x$，$f(u) = f'(u)$，$g(u) = g'(u)$。
*   $u, v$ 间为无向边：
    *   计算 $f(u)$：
        *   $f'(u) + g'(u) \le x$ 的前提下 $f'(u)$ 最小。
        *   按 $f(v)$ 排序。
        *   将 $f(v)$ 前 $p$ 小的 $v$ 定向为 $v \rightarrow u$，其余 $v$ 定向为 $u \rightarrow v$。
        *   用有向边的方法计算。
    *   计算 $g(u)$：
        *   同理。