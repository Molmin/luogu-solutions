这道题~~怕是一道假黑题~~。。

首先看到这个$m$的大小就会发现可以状压。。

我们首先可以考虑设置状态$f[i][j]$表示第$i$行棋的摆放方式为$j$时合法的方案数，然后再枚举$k$为下一行的状态，如果$j$和$k$相邻摆放的时候棋子不会互相攻击的话，我们就可以这么转移一下:

$f[i+1][k]=(f[i+1][k]+f[i][j])\ \%\ mod$

但是算一下时间复杂度:

$O(N*2^{2M}=10^6*2^{12} \thickapprox 4*10^9)$

完美爆炸。。

这样最多做掉$50\%$的数据。。

那么$100\%$的数据呢？

经过观察，我们可以发现相邻两行之间的转移实际上是**定向**的。

何谓定向？

定向，就是不管当前是在哪一个阶段，我们转移的方向不会因为阶段而改变。

比如说这道题，当攻击矩阵已知的时候，对于任何一个自身并不矛盾的行的状态$j$来说，它所能转移的下一行的状态肯定是某些确定的状态。

而且对于这种定向的转移，我们拥有一个堪称完美的武器可以解决这种DP超时的问题——矩阵快速幂。

我们只要有了存储了转移方向及转移时需要乘上去的常数的矩阵和初始状态，那么我们就可以用初始状态$*$矩阵A的$n$次幂就可以解决问题了。

这样的时间复杂度就是:

$O(2^{3M}*log_2N \thickapprox 2.5*10^5*20=5*10^6)$

~~完美解决~~