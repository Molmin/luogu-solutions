好牛逼啊，虽然做过兔子跳那题但是还是不会。为啥会去差分呢？为啥要发现是乘 2 呢？

考虑执行 $t$ 次操作后（$2^t|n,2^{t+1}\not| n$），整个序列会变成一些长度为 $2^{t+1}$ 的段和一个长度为 $2^t$ 的段。可以发现之后一直会保持此结构，故最终结果是 $[a,a,b,b,c,c,d,d,e]$ 这样子的。考虑执行一次操作后变成 $[a+e,a+e,a+d,a+d,b+d,b+d,b+c,b+c,2c,2c]$。

接下来就特别牛逼的一步，考虑对 $[a,b,c,d,e]$ 这个数组执行差分，看差分的变化：$[b-a,c-b,d-c,e-d]\to [d-e,b-a,c-d,c-b]$

（这一步的 intuition 是啥呢？其实很容易发现经过几次操作之后整个会很平均，然后就会想去每个位置都减掉最小值之类的找规律，然而“差分”其实也是其中一种处理方式）

也即 $[b_1,b_2,b_3,b_4]\to [-b_4,b_1,-b_3,b_2]$ 这样。这就是置换形式，直接求幂可以做到 $O(qn)$。

接下来又是很离谱的一步，考虑把排列补全成这样子：$[b_1,b_2,b_3,b_4,-b_4,-b_3,-b_2,-b_1]$（可能并不需要，但这样更直观），然后变成 $[-b_4,b_1,-b_3,b_2,-b_2,b_3,-b_1,b_4]$。

注意到这个排列其实是 $[1,2,3,4,5,6,7,8]\to [5,1,6,2,7,3,8,4]$。来考虑 $1$ 的位置变化，发现是 $1\to 2\to 4\to 8\to 7\to 5\to 1$ 这样，*观察到* 就是 $x\to (2x\bmod (2\times 4+1))$！所以这个“置换”其实就是把每个位置在模 $2\times n-1$ 意义下乘二，也即每个置换环的大小都是 $\varphi(2n-1)$ 的约数（$2^{\dots}=1$）。

（草，这一步我真的不懂 intuition 是啥，有没有人告诉我！）

因为给出差分数组 $b_1,b_2,\dots,b_{n-1}$ 以及和（显然和每次翻倍），可以求出 $a_1=(S+\sum b_i(n-i))/n$，$a_x=a_1+b_1+\dots+b_{x-1}=S/n+\sum_{i<x}b_i(2n-i)/n+\sum_{i\ge x}b_i(n-i)/n$，设 $w_i$ 是 $i$ 位置的差分对 $x$ 的贡献，则每个置换环内部的贡献方式就是循环卷积状物，用 FFT 做到 $O(n\log n)$（总共）。然后对于每种置换环长度，用 $O(n)$ 的时间处理出这时对整个长为 $\varphi(2n-1)$ 的序列的总贡献，这部分是 $O(nd(n))$。$2^k$ 用光速幂处理，询问单次 $O(1)$。总复杂度 $O(n\log n+nd(n)+q)$。

https://uoj.ac/submission/565383