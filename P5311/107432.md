第一道黑 Ynoi，写一篇题解纪念一下。

首先我们发现题目太难了，所以我们要转换题意。

保留每个点，等价于在算到**符合要求**的点**以前**不计算这些点的贡献。

所以针对每个询问，我们可以将它理解成到 $x$ 的路径上**编号的最小值**大于等于 $l$ 并且**编号的最大值**小于等于 $r$ 的颜色种类。

因为他要处理一大堆树上路劲，所以我们考虑**点分治**求解答案。

在求出重心之后，我们计算经过当前重心的答案，也就是询问中 $x$ 是当前重心的答案，因为其他点的答案会在其余的分治中被求出来。

那么我们考虑怎么计算当前分治中心的答案呢？

我们从当前的分治中心开始搜索，记录从**分治中心**到**当前节点**中点编号的最大值和最小值，每次搜到一个点时将点的编号与当前路径上的最大值与最小值取 $\max$ 与 $\min$ 即可。

并且每次搜到一个点，还需要更新这条路径上的颜色——编号在 $l$ 到 $r$ 之间的点都可以享受到当前颜色的贡献。

搜到一个点时，如果这个点上**询问的 $r$ 大于等于**路径上点编号的最大值，并且这个点上**询问的 $l$ 小于等于**路径上点编号的最小值，并且这个询问**没有被访问过**，那么就把这个询问加入**搜索这个点时**所发现**可以解决**的询问——然后标记这个询问已经被访问过了。

如果搜到一个点时，这个点上有询问没有被访问过但是**不满足**上述对点编号的要求，那怎么办？因为每一次搜索都会对**全图**进行一个搜索，所以如果当前询问不满足对点编号的要求，那只能说明**当前路径**不满足其要求而不能说明**全图都不满足**不满足其要求，所以会在下一次满足时将该询问加入**可以解决**的询问的集合。

---

现在我们有了从一个点开始搜一次图所有的**颜色**与**符合条件**的询问集合，该统计答案了。

因为答案都是以点编号的区间进行标号的，所以我们可以从左往右处理颜色和询问。

具体地，我们从左到右遍历每一个询问，就像 [P1972](https://www.luogu.com.cn/problem/P1972) 一样，处理所有**右端点**小于等于**当前询问右端点**的颜色区间，如下所示：

如果当前询问的左端点大于当前颜色的**最右的颜色区间**能代表的**最右位置**，说明这个颜色失效了，将当前的颜色区间**右端点**插入树状数组，并且删掉上一个**目前颜色**代表的颜色区间（如果有的话）。

每次统计完答案，要清空树状数组。

[代码](https://www.luogu.com.cn/paste/vsyvnnex)