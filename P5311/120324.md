保留编号在 $[l, r]$ 中的节点求连通块，等价于 $x$ 到某个点的路径上标号最小值 $\ge l$ 且标号最大值 $\le r$。由此，问题转化成了关于 $x$ 的路径问题。

考虑用点分治解决。设分治中心为 $u$，`dfs` 到的点为 $v$，$u \to v$ 路径上标号最小、最大值分别为 $L_v, R_v$。

对于询问 $x$，当且仅当 $L_x \ge l$ 且 $R_x \le r$ 时，$x$ 与 $u$ 连通。一个点 $v$ 要和 $x$ 连通，也需要满足 $L_v \ge l$ 且 $R_v \le r$。

把 $[L_v, R_v]$ 看成有色线段。因为要求 $[l,r]$ 包含 $[L_v, R_v]$，所以根据 [HH 的项链](https://www.luogu.com.cn/problem/P1972) 的套路，可以按 $L$ 排序，把颜色放在 $R$ 上，从右往左扫的同时把*新颜色*标记放在最靠近 $L$ 的点上。可以用树状数组维护。

此时还有一个问题：如何确定一个点应当在哪个分治中心被统计。如果按照传统的套路，仅在不同字数间合并，那么统计是困难的。

本题可以放宽限制，允许同一子树合并。这样做并不会影响答案的正确性。若 $x$ 能通过 $u$ 到达 $v$，则一定能通过更深的分治中心 $u'$ 到达 $v$。[为什么？](https://www.luogu.com.cn/paste/0h83hp6e)

钦定每个询问仅在第一次能到达分治中心的时候统计，这样才不会算重。

[代码](https://www.luogu.com.cn/paste/7kzb4a6s)