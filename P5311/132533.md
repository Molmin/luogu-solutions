不理解，为什么自定义排序写成 if 判断句永远会爆奇怪的错误……

总的来说还是比较 ez 的。

**P5311**题解。

--------------------------------------------------------

刚开始糊涂了，很快就糊了个点分树上差分二维点上数颜色的做法，没有推完性质。

最关键的一个性质：对原树进行点分治后，任意连通块一定有一个在点分树上最浅的节点，其子树完全包含连通块。

这个可以考虑用反证法，如果在连通块上但是不在子树里面说明还有更浅的在连通块上的点分树节点。

然后就简单了：一个点被联通的条件是到根路径上的节点都在区间 $[l,r]$ 内，不难想到一个点在根确定时的限制就是路径上节点编号的最小值/最大值组成的二元组信息 $(l_i,r_i)$，同时其贡献是颜色 $col_i$。

对每个根单独操作，按照 $r$ 扫描线，每次维护每个颜色的 lst 就可以像 HH 项链那样数颜色了，由于是单点加区间查直接上树状数组即可。

时间复杂度 $O(n \log^2 n + q \log n)$，贸然在处理点分治的时候多带一个 $\log n$ 预计会 T 飞。

