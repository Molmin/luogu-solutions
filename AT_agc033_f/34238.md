对上面一些题解的补充和修正。

注意到如果一条路径上依次存在三个点 $u,v,w$，且 $(u,v),(u,w)\in E$，那么我们可以删去 $(u,w)$，加上 $(v,w)$ 而不改变最终产生的图。

考虑上述操作无法进行时产生的图 $G'$，我们可以发现一个引理：一条边 $(u,v)$ 存在当且仅当本来就有连边或者存在路径 $u=p_1,p_2,p_3,\cdots,p_{k-1},p_k=v$ 使得对于任意相邻三个点 $p_i,p_{i+1},p_{i+2}$，$(p_i,p_{i+1}),(p_{i+1},p_{i+2})\in E$，且 $p_i,p_{i+1},p_{i+2}$ 在同一条路径上。

对于上述引理的证明，考虑充分性是显然的，必要性根据 $G'$ 的极小性也不难证明。

考虑如何求出 $G'$，我们依次加入每一条边，然后动态地维护 $G'$。于此同时，我们维护 $f(u,v)$ 表示当 $T$ 取 $u$ 为根时，与 $u$ 相连的，离 $v$ 最近的点。那么对于新加入的一条边 $(u,v)$，我们根据 $f(u,v)$ 的值讨论，同时维护一个队列表示正要加入的边：

- 若 $f(u,v)=v$，则已经存在边 $(u,v)$，我们可以忽略这条边。
- 若 $f(u,v)$ 存在且不为 $v$（$f(v,u)$ 存在且不为 $u$ 的情况是类似的，不再赘述），那么 $u,v$ 路径上存在一个点 $f(u,v)$ 与 $u$ 有连边，根据之前的结论我们可以把 $(u,v)$ 缩短为 $(f(u,v),v)$ 而不改变最后的答案，于是把新的这条边放入待处理的队列。
- 若 $f(u,v),f(v,u)$ 均不存在，那这条边可以被直接加入，我们分别从 $u,v$ 开始向以 $v,u$ 为根时 $u,v$ 的子树内修改 $f$，根据 $f$ 的意义，我们只需要修改没有值的点，若遇到一个有值且不为我们修改的值的 $f$，则这个 $f$ 代表的边要修改，我们继续把它丢到队列里。

最后，我们再从每个点开始 DFS 上述引理所述的路径，就可以求出所有边了。

注意到每次搜索要么给一个点的 $f$ 变成有值的，要么缩小一条边，而二者的总次数分别是 $\mathcal O(N^2)$ 和 $\mathcal O(NM)$ 的，故总的时间复杂度为 $\mathcal O(N(N+M))$。