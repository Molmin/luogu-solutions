写一下我的思考路径。

首先考虑 $a_i$ 形成一个排列的话怎么做。我们发现假如 $a_i$ 恰好形成一个置换环，那么如果 $n>1$ 且 $n$ 为奇数那么答案就是 $2$（可以 $p_{p_i}=a_i$），否则就是 $1$。

然后我们发现 $a$ 所形成的不同置换环之间还可以合并。而可以合并的两个置换环的充要条件是两者大小相等。因为我们合并两个环 $x_1\to \dots\to x_m$ 和 $y_1\to \dots\to y_m$，最后一定是形如 $x_1\to y_i\to x_2\to y_{i+1}\to\dots\to x_m\to y_{i-1}$ 的大环，如果大小不相等会出问题。然后我们也能求出合并后的方案数为 $m$，即环的大小。

所以对于每个环的大小我们都做一次 DP，$f_i$ 表示 $i$ 个大小为 $m$ 的环，可随意合并的方案数，于是 $f_i=p\times f_{i-1}+m\times(i-1)\times f_{i-2}$，其中 $p$ 为上面所说过的不合并时一个大小为 $m$ 的环的答案。

然后考虑有重复的 $a_i$ 的情况。首先考虑由 $E=\{(i,a_i)\}$ 组成的有向图，我们取出所有弱连通块。这个弱连通块只可能是基环树或环。通过上面的推理我们也可以得知基环树是无法和环合并的。所以可以分开独立考虑。如果这个弱连通块是一个环，那么上面已经说过了。否则就是一棵根向基环树，所以我们独立考虑每一棵基环树。

这里我画了很多种情况。一个可以尽可能保证讨论到位的办法可能就是写个暴力然后看看有哪些情况吧。

对于一棵基环树，我们发现它有解的一个必要条件是把环拆掉后会形成几条链。于是我们来看一条链的影响。手动模拟可知（假如环上点标号为 $1,\dots,k$），一条挂在 $x$ 节点上的长 $r$ 的链（假如链上点标号为 $k+1,\dots,k+r$）有两种处理方式：第一种是 $p_{k+1}=x,p_{x-1}=k+1,p_{k+2}=x-1,p_{x-2}=k+2,\dots,p_{x-r}=k+r$，第二种是 $p_{x-1}=x,p_{k+1}=x-1,p_{x-2}=k+1,\dots,p_{x-r-1}=k+r$。

于是对答案的贡献可以这样计算：对于挂了长 $r$ 的链的节点 $x$，如果它之前 $k+1$ 个点都没挂链，那么贡献是 $2$；如果只有 $k$ 个点没挂链，那么贡献是 $1$；否则就无解了。

可能有些小细节。

https://atcoder.jp/contests/agc008/submissions/40485618