## 题意

状态：

- 有 $2n$ 个人，按照 $(1,2),(3,4),\cdots,(n-  1,n)$ 的顺序分成 $n$ 组。 
- 每个人处于两种状态之一：愿意、不愿意。
- 一组两个人都愿意时可以选择合作或不合作，两人有任意一个不愿意都不可合作。

代价：

- 第 $i$ 个人选择愿意代价为 $c_i$，选择不愿意代价为 $d_i$，$i$ 选愿意 $i$ 的队友选不愿意代价为 $e_i$。
- 有 $m$ 个四元组 $(A,B,a,b)$ 代表：
  - $A$ 和 $A$ 的队友 **不合作**（任意一人不愿意或者都愿意且选择不合作）且 $B$ 选择 **愿意**，付出 $a$ 的代价。
  - $B$ 和 $B$ 的队友 **合作** （都选择愿意且选择愿意合作）且 $A$ 选择不愿意，付出 $b$ 的代价。

给定上述的 $n,m,c,d,e$ 和 $(A,B,a,b)$，最小化代价。

## 解法

首先考虑只有 $c,d,e$ 这三个条件时如何最小化代价，可以转化为网络流模型，使用最小割解决。

每个人分配一个点，令与源点连通的点集表示不愿意合作，与汇点连通的点集表示愿意合作，那么与源点连通需要割与汇点相连的边，此时需要付出代价 $d_i$，也就是 $[1,2n]$ 每个点向汇点连一条容量 $d_i$ 的边，同理，源点向每个点连一条容量 $c_i$ 的边。

如果一队人 $(u,v)$ 中 $u$ 与源点连通，$v$ 与汇点连通需要付出 $e_v$ 的代价，那么从 $u$ 到 $v$ 连一条容量为 $e_v$ 的边，从 $v$ 向 $u$ 连一条容量为 $e_u$ 的边。

然后考虑把是否合作这一部分加入模型，首先建立 $n$ 个虚点代表 $n$ 个组是否愿意合作。

虚点与源点连通表示不合作，与汇点连通表示合作，这样一组两点任意一个不愿意都必须选择不合作，为了先割表示代价的边， 源点向 $n$ 个虚点连无限流边，虚点向汇点连无限流边。

由于 $n$ 个虚点与源汇都相连需要多割 $n \times \inf$，最后减去即可。

以下令 $PA$ 表示 $A$ 的队友点，$PB$ 表示 $B$ 的队友点，$WA$ 表示 $A$ 所在那一组是否合作的虚点，$WB$ 表示 $B$ 所在那一组是否合作的虚点。

### 代价 $a$ 情况一

此时 $B$ 选择愿意，$A$ 与 $PA$ 有任意一个不愿意或者都愿意且不合作。

即 $B$ 与汇点相连，$WA$ 连源点：

此时我们从 $A,PA$ 向 $WA$ 连无限流的边防止被割，从 $WA$ 向 $B$ 连一条容量为 $a$ 的边。

![](https://cdn.luogu.com.cn/upload/image_hosting/m4dpainh.png)

### 代价 $b$

此时 $A$ 选择不愿意且 $B$ 和 $PB$ 合作。

即 $A$ 与源点连通，$B,PB$ 均与汇点连通且 $WB$ 连汇点。

从 $A$ 向 $WB$ 连一条容量为 $b$ 的边。

![](https://cdn.luogu.com.cn/upload/image_hosting/xitvgn20.png)

## 代码

最大流部分记得开 `long long`，以及 `INF` 开大一点。

```cpp
int main() {
    memset(head,-1,sizeof(head));
	int n = read(),m = read(),cnt = n << 1;
	s = ++cnt,t = ++cnt;
	rep(i,1,(n << 1)) {
		int c = read(),d = read(),e = read();
		int pi = (i & 1) ? i + 1 : i - 1;
		AddEdge(s,i,c),AddEdge(i,t,d);
		AddEdge(pi,i,e);
	}
	rep(i,1,n) {
		co[i] = ++cnt;// 虚点编号
		AddEdge(s,co[i],INF);
		AddEdge(co[i],t,INF);
		AddEdge((i << 1) - 1,co[i],INF);
		AddEdge((i << 1),co[i],INF);
	}
	rep(i,1,m) {
		int A = read(),B = read(),a = read(),b = read();
		int WA = co[(A + 1) >> 1],WB = co[(B + 1) >> 1];
		AddEdge(WA,B,a);
		AddEdge(A,WB,b);
	}
	write(dinic() - (ll)n * INF),enter;
    return 0;
}
```