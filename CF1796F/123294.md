### *[CF1796F Strange Triples](https://www.luogu.com.cn/problem/CF1796F)

比较牛的题目。

注意接下来介绍的做法不是标算。

设 $10 ^ y\geq b$，$10 ^ z\geq n$ 且 $y, z$ 最小，则 $\frac {10 ^ z a + n} {10 ^ y n + b} = \frac a b$，即 $10 ^ zab + nb = 10 ^ yna + ab$。

$n$ 肯定是不能枚举的，所以 $n = \frac {(10 ^ z - 1)ab} {10 ^ y a - b}$，注意这一步要枚举 $z$。

因为式子里面含有 $10 ^ y$，所以枚举 $b$。

如果能消除 $a$ 对 $10 ^ ya - b$ 的整除性的影响，那就好办了：注意到 $\sum_{z = 1} ^ 9d(10 ^ z - 1) = 185$，直接枚举 $b(10  ^ z - 1)$ 的因数作为因子，总枚举量只有 $185 \times B\ln B$。

设当前枚举的的 $b(10 ^ z - 1)$ 的因数为 $d$，那么分母形如 $kd = 10 ^ y a - b$，其中 $k = \gcd(a, b)$。为了让 $a$ 有解，需要满足 $kd + b\equiv 0\pmod {10 ^ y}$。解得 $k$ 形如 $k'c + r$，其中 $c$ 是 $10 ^ y$ 的因数，$k'$ 为任意非负整数，$r$ 是常数。

又因为 $k\mid b$，感性猜测这样的 $k$ 很少，暴力枚举一下发现真的很少，只有 $7.5\times 10 ^ 6$ 个。求出 $k$ 之后，带回 $kd = 10 ^ y a - b$ 解得 $a$，检查是否有 $k = \gcd(a, b)$ 且 $a < A$，然后算出 $n$，检查是否有 $10 ^ {z - 1} \leq n < \min(N, 10 ^ z - 1)$。若全部检查通过，则 $(a, b, n)$ 为一组合法解。

亿些细节：

- 在 $185\times B\ln B$ 的枚举量下，为避免解同余方程时每次求 $\gcd$ 和逆元，需要对每个 $i\mid 10 ^ 5$ 和 $0\leq j < i$ 预处理 $\gcd(i, j)$，对每个 $i\perp j$ 预处理 $j ^ {-1}\pmod i$。
- 使用取模优化，否则求解同余方程就 T 了。需要对 $1\sim B$ 每个数开一个 Barett Reduction。
- 不能暴力分解 $b(10 ^ z - 1)$ 的质因数：枚举 $10 ^ z - 1$ 的因数 $d_2$，那么 $b$ 的因数 $d_1 = \frac d {d_2}$ 合法当且仅当 $d_1\perp \frac {10 ^ z - 1} {d_2}$。可以先枚举 $d_2$，然后枚举每个合法的 $d_1$，枚举其倍数 $b$，保证求 $\gcd$ 不要在 $185B\ln B$ 的枚举量里面。

然而最要命的是求得 $c, r$ 之后怎么求 $k = k'c + r$ 且 $k\mid b$。虽然合法 $k$ 很少，但直接枚举就彻底爆炸了。

注意到 $c\mid 10 ^ y$，考虑对每个 $b, r$ 和 $10 ^ 5$ 的因数 $c$，求出 $b$ 的所有模 $c$ 余 $r$ 的因数。但是不能直接存，因为总共涉及 $36B\ln B$ 个数，空间开不下。

那就只能先枚举 $b$，设 $buc_{c, r}$ 表示 $b$ 的所有模 $c$ 余 $r$ 的因数，这是 $36\times n$ 个 `vector`，处理完再清空。这样就没法先枚举 $d_2$ 了，只能预处理设 $f_{i, j}$ 表示 $d_2 = i$ 时 $j$ 是否合法，这是 $185$ 个的长度为 $B$ 的 `bitset`。

再卡卡常就可以擦时限通过了。[加注释代码](https://codeforces.com/contest/1796/submission/209732178) 和 [代码](https://codeforces.com/contest/1796/submission/209734394)（代码里面的 `z` 应该开 `long long`）。

我们再研究一下标算：
$$
10 ^ y a - b \mid ab(10 ^ z - 1)
$$
将 $a$ 对整除的贡献去掉：因为 $\gcd(a, 10 ^ y a - b) = \gcd(a, b)$，所以设 $k = \gcd(a, b)$，$a = a'k$，$b = b'k$，那么
$$
10 ^ ya' - b'\mid b(10 ^ z - 1)
$$
枚举 $d_b\mid b$ 和 $d_z\mid 10 ^ z - 1$：
$$
10 ^ ya' - b' = d_bd_z
$$
因为 $b' < 10 ^ y$，所以 $b' = 10 ^ y - (d_bd_z\bmod 10 ^ y)$，这里只要枚举 $y$。那么 $a' = \frac {d_bd_z + b'} {10 ^ y}$。

到这里再枚举 $b$，相当于枚举 $k$，算出 $a = a'k$ 和 $b = b'k$，进一步算出 $n$，检查是否合法即可。将 $k$ 的枚举范围限制在 $[\lceil\frac {10 ^ {y - 1}}{b'}\rceil, \lfloor {\frac {10 ^ y - 1} {b'}} \rfloor]$，发现枚举 $d_b, y, k$ 的总复杂度就是 $B\ln B$，所以总复杂度为 $\mathcal{O}(B\ln B)$，有 $185$ 倍常数。[未卡常加注释代码](https://codeforc.es/contest/1796/submission/209756610) 和 [卡常后代码](https://codeforc.es/contest/1796/submission/209758816)，为 CF 非打表最优解（2023.6.15）。

对比一下第一种思路和官方解法，发现问题出在 $kd = 10 ^ ya - b$ 这一步。此时我们已经枚举了 $d_b, d_z$ 和 $b$。如果注意到 $k\mid a$，就会发现 $\frac b k$ 是好求的，继而直接算出 $k$ 而不需要再枚举 $k$ 了！