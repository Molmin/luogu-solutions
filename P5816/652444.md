#### [题目传送门](https://www.luogu.com.cn/problem/P5816)

扫描线的做法这里不说了，挺多题解都讲的挺不错的。这里分享一个**主席树**的写法。

首先我们明确的是，第一步变化之后，整个图就不会变了。为什么呢，第二步才改变的点 $q$ 肯定是因为第一步改变的某个点 $p$ 或者好几个点变成黑点才改变的。如果 $q$ 因为 $p$ 而改变且 $p$ 在 $q$ 的水平左侧，那么 $p$ 左侧肯定还有点，因为 $p$ 是第一步变成黑点的点，那么在此情况下， $q$ 第一步也应当变成黑点，不应该等到第二次才变化。其他几个方向或者多个点的情况是同理的。也就是说第二步整个图就不会发生变化了，因此以后永远也不会再变化。

那么会从白变黑的点肯定是夹在两个 $y$ 相等的相邻点中间的点，现将这两个相邻点表示为 $(x_1,y)$ 和 $(x_2,y)$ ,那么我们只要对每一对这样的相邻点去求答案最后加和就可以了。那么其中间的点可以表示为 $\left\{(x,y)|x\in\left[x_1+1,x_2-1\right]\right\}$ ,那么这里有多少个点可以变成黑点其实也就是对于这里的每个 $x$ ，去看是否其上下分别至少都存在一个点，但是我们发现这样不好计算，于是我们反过来算，我们算有多少个不满足条件。不满足条件就是，对于 $x$ 这一列来说，要么只有 $y$ 的上方没有点，要么只有下侧没有点，要么都没。那么我就想：

1. 以纵轴为时间轴建立主席树，可以算出 $y$ 上方在 $[x_1+1,x_2-1]$ 内有多少种 $x$ ，那么用总的种类数减一下，也就可以算出缺了多少种 $x$ ，也就算出了 $y$ 的上方有多少纵列是空的。

1. 再以纵轴为时间轴反向建立主席树，就可以得到 $y$ 的下方在 $[x_1+1,x_2-1]$ 内有多少种 $x$ ，也可计算出 $y$ 下方有多少纵列是空的。

1. 然后我们用正向建立还是反向建立的主席树都可得到对于全局在 $[x_1+1,x_2-1]$ 内有多少种 $x$ ，同理算出全局   $[x_1+1,x_2-1]$ 内有多少纵列是空的。

这里我们将前两项相加减去第三项算出 $[x_1+1,x_2-1]$ 内，有多少纵列要么 $y$ 上面是空的，要么 $y$ 下面是空的，要么 $y$ 的上下全是空的。说白了我们就算出了无法变成黑点的情况，那么减一下，不就变成了可以变成黑点的情况。

注意这里用主席树没用使用区间求值的操作，因为种类数不满足前缀相减的性质，所以这里正反建了两颗主席树。

这里不贴代码了，Bye！