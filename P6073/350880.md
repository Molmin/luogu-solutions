**写在前面**：由于本题要求值的式子经过出题人精心设计，故可能部分推导与前两篇题解有所重合。本文在前两篇题解的基础上，重点在于 **给出了一阶欧拉数**（非数学归纳法）、**二阶欧拉数通项** 的具体推导，**第二类斯特林数与二阶欧拉数的关系式** 和本题中某些重要恒等式的 **组合意义理解** 。

（已经过多次修改，如仍有内容或格式上的疏漏，请指出，谢谢！）

&nbsp;

参考文章：

[Karry5307 出题人的题解](https://www.luogu.com.cn/blog/Karry5307/solution-p6073)

[Spasmodic 大佬的题解](https://www.luogu.com.cn/blog/Othinus-blog/solution-p6073)

**《具体数学》6.2 节**

**Deng J Q.  - _On the second order Eulerian numbers_**

**I. Gessel and R.P. Stanley - _Stirling Polynomials_**

**Amy. M. Fu - _Some Identities Related to the Second-Order Eulerian Numbers_**

&nbsp;

---

在这里先给出一些定义与重要结论的证明，以便于在题目中直接使用它们。

**可能有一些定义与其它文章或文献有所出入，但由于这些定义本身早已在各文章内产生分歧，故还是以下面定义的为准。**

定义 **欧拉数** $A(n,k)$ 表示，对 $\{1,2,\cdots n\}$ 进行排列得到排列 $P_{1,2\cdots n}$，并且恰有 $k$ 个位置 $i\in[2,n]$ 满足 $P_i>P_{i-1}$ 的排列数量。

该定义与 [P5825](https://www.luogu.com.cn/problem/P5825) 的题面保持一致。

定义 **二阶欧拉数** $B(n,k)$ 表示，对 $\{1,1,2,2,\cdots,n,n\}$ 进行排列得到排列 $P_{1,2,\cdots 2n}$，满足对于任意 $m\in[1,n]$，位于两个 $m$ 之间的数均大于 $m$ 并且恰有 $k$ 个位置 $i\in[2,2n]$ 满足 $P_i>P_{i-1}$ 的排列数量。

由上述定义易得 $A(n,0)=B(n,0)=1,A(n,n)=B(n,2n)=0$. 实际上，$\forall i\in[n,2n],B(n,i)=0$.

第二类斯特林数的定义与它处保持一致。

&nbsp;

## Part0. 一个组合恒等式

$\displaystyle\binom{n+1}{k+m+1}=\sum_{j=0}^n\binom{j}{k}\binom{n-j}{m}$.

考虑其组合意义：现有 $n+1$ 个球排成一行，要从中选择 $k+m+1$ 个球。我们轮流钦定编号为 $j\in[0,n]$ 的球必须选，那么实际上以这个球为分界线，将这个序列分为了左右两部分，那么相当于在大小为 $j$ 和 $n-j$ 的两组内分别选出 $k$ 个和 $m$ 个。

为什么不会算重？考虑一个选球的方案，我们发现它仅会在钦定该方案第 $k+1$ 个球的时候被统计到。

&nbsp;

## Part1. 求欧拉数的一行

给定 $n$ ，对于 $\forall i\in[0,n]$，求出 $A(n,i)$.

也就是 [P5825](https://www.luogu.com.cn/problem/P5825).

定义 $f(k)=A(n,k)$，$g(k)$ 表示钦定排列中有 $k$ 个升高的方案数。

得到下式：

$\displaystyle g(k)=\sum_{i=k}^{n-1}\binom{i}{k}f(i)$.

由二项式反演的外推形式得到：

$\displaystyle f(k)=\sum_{i=k}^{n-1}(-1)^{i-k}\binom{i}{k}g(i)$.

现在要求 $g(i)$. 注意到钦定序列中有 $i$ 个位置必为升高，那么我们将这个序列从左至右划分为 $n-i$ 组且每一组的开头均不是钦定的位置，这样我们发现既然每组最多含有一个不是升高的数，那么每一组都是单调递增的。

啊……那这就是把 $n$ 个有序元素分到 $n-k$ 个有序集合，每个集合至少有一个元素的方案数。二项式反演裸题。设 $F(t)=g(n-t)$ 表示恰有 $t$ 个集合内有数的方案，$G(t)$ 表示至多有 $t$ 个集合内有数的方案，那么有

$\displaystyle t^n=G(t)=\sum_{i=0}^t\binom{t}{i}F(i)\iff F(t)=\sum_{i=0}^t(-1)^{t-i}\binom{t}{i}G(i)=\sum_{i=0}^t(-1)^{t-i}\binom{t}{i}i^n$.

于是可以进行两次 NTT 优化二项式反演解决这个问题。其中第一个容斥是一个减法卷积。

然后我们发现这个 $g(i)$ 实际上呢就是 $(n-i)!\begin{Bmatrix}n\\n-i\end{Bmatrix}$，因为这是第二类斯特林数的通项嘛。由于 $g(n)=0$，枚举上限可以扩展到 $n$.

于是 $\displaystyle A(n,k)=f(k)=\sum_{i=k}^n(-1)^{i-k}\binom{i}{k}(n-i)!\begin{Bmatrix}n\\n-i\end{Bmatrix}$.

&nbsp;

## Part2. 欧拉数的通项

**指数公式定理** ：对于有序元素单集合分组的指数生成函数 ${\rm EGF} \ F(x)$ 与有序元素可空无序集合划分的指数生成函数 ${\rm EGF}\ G(x)$ 有 $G(x)=\exp(F(x))$.

其推论即，有序元素分为 $k$ 个无序集合的指数生成函数为 $\displaystyle\frac{f(x)^k}{k!}$. 对于 **有序集合** 则可以写成 $f(x)^k$.

注意到第二类斯特林数的生成函数的 $\rm EGF$ 为 $e^x-1$，于是在 Part1 中有组合意义的 $g(i)$ 还可以写成

$n![x^n](e^x-1)^{n-i}$. 这里的 $n!$ 是指数生成函数还原为数列自带的系数。

$\displaystyle A(n,m)=\sum_{i=m}^{n-1}(-1)^{i-m}\binom{i}{m}n![x^n](e^x-1)^{n-i}$
 
$\displaystyle=\sum_{i=m}^{n-1}(-1)^{i-m}\binom{i}{m}n![x^n]\sum_{k=0}^{n-i}(-1)^{n-i-k}e^{kx}\binom{n-i}{k}$
 
$\displaystyle=\sum_{i=m}^{n-1}(-1)^{i-m}\binom{i}{m}\sum_{k=0}^{n-i}k^n(-1)^{n-i-k}\binom{n-i}{k}$

$\displaystyle=\sum_{k=0}^{n-m}k^n(-1)^{n-m-k}\sum_{i=m}^{n-k}\binom{i}{m}\binom{n-i}{k}$.

右侧的求和号就是 $Part0$ 里的组合数等式。因为组合数性质可以调整上下限。

$\displaystyle=\sum_{k=0}^{n-m}k^n(-1)^{n-m-k}\binom{n+1}{k+m+1}$.

对于欧拉数有一个重要的性质，$A(n,k)=A(n,n-k-1)$. 可以通过将上升和下降对应互换得到。

于是我们可以将上式中的 $m$ 原封不动地换为 $n-m-1$.

$\displaystyle=\sum_{k=0}^{m+1}k^n(-1)^{m-k+1}\binom{n+1}{n+k-m}$

$\displaystyle=\sum_{k=1}^{m+1}k^n(-1)^{m-k+1}\binom{n+1}{m-k+1}$

$\displaystyle=\sum_{k=0}^m(k+1)^n(-1)^{m-k}\binom{n+1}{m-k}$

$\displaystyle=\sum_{k=0}^m(m-k+1)^n(-1)^{k}\binom{n+1}{k}$.

注意到，如果预处理幂并递推组合数，计算这个式子的复杂度为 $O(m)$.

&nbsp;

## Part3. 由二阶欧拉数导出第二类斯特林数

来自 **I. Gessel and R.P. Stanley** 的智慧结晶。

用组合意义与映射关系证明：$\displaystyle\begin{Bmatrix}n+m\\n\end{Bmatrix}=\sum_{i=0}^mB(m,i)\binom{n+2m-i-1}{2m}$.

定义可重集合 $Q_k=\{1,1,2,2,\cdots k,k\}$；**下文中任何合法的基于 $Q_k$ 的排列均需满足二阶欧拉数中的定义。**

定义 **Bar 序列** 表示在一个数列的任意两个数之间插入任意多个板 **'#'** 得到的序列；

定义 $P_k$ 为基于 $Q_k$ 的排列的 Bar 序列 的集合；

定义 $P_{k,n}$ 表示恰好插有 $n$ 个板，**且每个上升之前的缝隙中间与第一个数之前的位置必须插至少一个板** 的 $P_k$ 内的序列集合。例如：$|P_{2,2}|=7$，其中统计了

$\#11\#22$，$\#1\#221$，$\#\#2211$，$\#2\#211$，$\#22\#11$，$\#221\#1$，$\#2211\#$.

它们均是 $P_2$ 中的 Bar 序列。

&nbsp;

**引理1. $\displaystyle\sum_{n=0}^\infty |P_{k,n}|x^n=\sum_{i=0}^k\frac{B(k,i)x^{i+1}}{(1-x)^{2k+1}}$.**

证明较为容易。考虑 $\displaystyle\frac{1}{(1-x)^{2k+1}}$ 就是往 $2k+1$ 个空里随便插。那便无妨我 **钦定在每个上升的前面和开头之前都强制插入一个板**，并且枚举一下 $k$ 喽。

&nbsp;

**引理2. $|P_{k,n}|=\begin{Bmatrix}n+k\\n\end{Bmatrix}$.**

~~惊喜往往就在一瞬间。~~

采取建立双射的方法。

&nbsp;

---

#### 第一部分：给定一个合法的 $P_{k,n}$ 中的序列，对应一个将 $n+k$ 个元素分为 $n$ 组的划分。

我们一步步来。

&nbsp;

**（1）给定的这个合法的序列，一定可以由以下步骤增量构造而来：第一步，放置一个形如 '##...##' 的子串；之后进行恰好 $k$ 步，其中的第 $i$ 步形如 在上一步形成的序列中某个缝隙中插入 'i##...##i' 状的子串。且该过程有唯一方案。**

想必各位 OIER 对这种神似括号序列的东西都足够敏感，于是不作额外说明。

&nbsp;

**（2）构造方法如下：将每一步均看作将子串从依次左至右顺次添加进某个位置；我们维护一个计数器，每添加一个新元素（板或者数，相同数只算第一个）时，计数器增加并为这个元素赋上计数器当前的值；添加一个板的时候，我们就开辟一个新分组；添加一个数 $i$ （相同数只算第一个）的时候，我们找到这个数左侧的第一个板，将其与这个板归为一组。**

举个例子，增量构造序列 $\#\#11\#2\#3\#443\#2\#$：

| 当前序列 | 当前分组 | 说明 |
| :-----------: | :-----------: | :-----------: |
| $\#\#\#\#$ | $\{1\},\{2\},\{3\},\{4\}$ | 此时为四个板顺次赋上 $1,2,3,4$ 的编号 |
| $\#\#11\#\#$ | $\{1\},\{2,5\},\{3\},\{4\}$ | 第一个 $1$ 左侧板的编号为 $2$，故加入该组 |
| $\#\#11\#2\#\#2\#$ | $\{1\},\{2,5\},\{3,6\},\{4\},\{7\},\{8\}$ | 第一个 $2$ 左侧板的编号为 $6$，故加入该组 |
| $\#\#11\#2\#3\#3\#2\#$ | $\{1\},\{2,5\},\{3,6\},\{4\},\{7,9\},\{8\},\{10\}$ | 第一个 $3$ 左侧板的编号为 $7$，故加入该组 |
| $\#\#11\#2\#3\#443\#2\#$ | $\{1\},\{2,5\},\{3,6\},\{4\},\{7,9\},\{8\},\{10,11\}$ | 第一个 $4$ 左侧板的编号为 $10$，故加入该组 |

由上述过程可以看出，组数就是板数，元素数就是序列长度，符合引理二中斯特林数的形式；且由于序列对应的构造过程唯一与方案唯一，故不同序列得到的分组互不相同。

&nbsp;

---

#### 第二部分：给定一个将 $n+k$ 个元素分为 $n$ 组的划分，对应一个合法的 $P_{k,n}$ 中的序列。

反向操作就可以了，我们仍然一步步来。

**（1）对于给定的分组，我们把每组的最小元素看作板（为了让数保留，用下划线进行标记）。从上述构造过程中我们可以看出每组恰有一个最小的元素代表板。可以看出，剩下的数可以进行离散化。**

$\{1\},\{2,5\},\{3,6\},\{4\},\{7,9\},\{8\},\{10,11\}\rightarrow$

$\{\underline1\},\{\underline2,5\},\{\underline3,6\},\{\underline4\},\{\underline7,9\},\{\underline8\},\{\underline{10},11\}\leftrightarrow$

$\{\#\},\{\#,5\},\{\#,6\},\{\#\},\{\#,9\},\{\#\},\{\#,11\}\rightarrow$

$\{\#\},\{\#,1\},\{\#,2\},\{\#\},\{\#,3\},\{\#\},\{\#,4\}$.

&nbsp;

然后进行增量构造。

**（2）严格按照从左至右的顺序（其实就是按给定分组的最小元素排序后）插入每个组。设当且要插入的组有下划线标记的数为 $i$，若 $i-1$ 是一个没有被下划线标记的数则找到其最左侧出现的位置，插入它的右边，并且将没有被下划线标记的数复制一份加在右侧；若 $i-1$ 是一个被下划线标记的数则这两次插入必然连续，直接放到刚才插入结果的右侧即可。**

举刚才的例子：

| 当前插入 | 当前序列 | 说明 |
| :-----------: | :-----------: | :-----------: |
| $\{\underline1\}$ | $\underline1$ | 插入 $1$ |
| $\{\underline2,5\}$ | $\underline1\underline255$ | 插入上一次插入结果右侧 |
| $\{\underline3,6\}$ | $\underline1\underline255\underline366$ | 插入上一次插入结果右侧 |
| $\{\underline4\}$ | $\underline1\underline255\underline366\underline4$ | 插入上一次插入结果右侧 |
| $\{\underline7,9\}$ | $\underline1\underline255\underline36\underline7996\underline4$ | 插入第一个 $6$ 右侧 |
| $\{\underline8\}$ | $\underline1\underline255\underline36\underline799\underline86\underline4$ | 插入上一次插入结果右侧
| $\{\underline{10},11\}$ | $\underline1\underline255\underline36\underline79\underline{(10)}(11)(11)9\underline86\underline4$ | 插入第一个 $9$ 右侧 |

把下划线还原为 '#' 并对剩下的数离散化就得到：

$\#\#55\#6\#9\#(11)(11)9\#6\#  \rightarrow\#\#11\#2\#3\#443\#2\#$.

这就是我们要求的序列，于是映射建立完毕，引理 2 得证。

&nbsp;

---

我们将引理 1 左右生成函数的 $m$ 次项拿出来对比：

$\displaystyle|P_{k,n}|=\sum_{i=0}^{m-1}B(k,i)[x^{m-i-1}]\frac{1}{(1-x)^{2k+1}}$.

考虑 $\displaystyle[x^{m-i-1}]\frac{1}{(1-x)^{2k+1}}$ 的组合意义是在 把 $m-i-1$ 个相同的球可空地放到 $2k+1$ 个不同的盒子。于是插板法得到 $\displaystyle\binom{2k+m-i-1}{2k}$.

于是 $\displaystyle\begin{Bmatrix}n+m\\n\end{Bmatrix}=|P_{m,n}|=\sum_{i=0}^mB(m,i)\binom{n+2m-i-1}{2m}$.

证毕。

&nbsp;

## Part4. 二阶欧拉数通项公式

在这里我们要证明：

$\displaystyle B(n,k)=\sum_{i=0}^{k}\binom{2n+1}{i}(-1)^i\begin{Bmatrix}n+m-i+1\\m-i+1\end{Bmatrix}$.

考虑将后面的斯特林数用刚推的式子代换：

$\displaystyle B(n,k)=\sum_{i=0}^{k}\binom{2n+1}{i}(-1)^i\sum_{j=0}^nB(n,j)\binom{k-i+2n-j}{2n}$.

枚举左边的 $k$，建立轮换形式：

$\displaystyle\sum_{k=0}^nB(n,k)=\sum_{k=0}^n\sum_{i=0}^{k}\binom{2n+1}{i}(-1)^i\sum_{j=0}^nB(n,j)\binom{k-i+2n-j}{2n}$

$\displaystyle=\sum_{k=0}^nB(n,k)\sum_{j=0}^n\sum_{i=0}^j\binom{2n+1}{i}(-1)^i\binom{j-i+2n-k}{2n}$

$\displaystyle=\sum_{k=0}^nB(n,k)\sum_{i=0}^n\binom{2n+1}{i}(-1)^i\sum_{j=i}^n\binom{j-i+2n-k}{2n}$

$\displaystyle=\sum_{k=0}^nB(n,k)\sum_{i=0}^n\binom{2n+1}{i}(-1)^i\left(\binom{3n-i-k+1}{2n+1}-\binom{2n-k}{2n+1}\right)$.

减号右侧的组合数是 $0$.

$\displaystyle\sum_{k=0}^nB(n,k)=\sum_{k=0}^nB(n,k)\sum_{i=0}^n(-1)^i\binom{2n+1}{i}\binom{3n-i-k+1}{2n+1}$.

用 **“不可以，总司令！”** 的思路 ~~（并且人总是要有梦想的）~~，于是我们直接猜想：

$\displaystyle\forall k\in[0,n],\sum_{i=0}^n(-1)^i\binom{2n+1}{i}\binom{3n-i-k+1}{2n+1}=1$.

接下来我们来证明它。

构造生成函数 $\displaystyle F(x)=(1-x)^{2n+1}$，$\displaystyle G(x)=\frac{1}{(1-x)^{2n+2}}$.

由二项式定理展开式易得 $\displaystyle(-1)^i\binom{2n+1}{i}=[x^i]F(x)$，而 $\displaystyle\binom{3n-i-k+1}{2n+1}$ 就是将 $n-i-k$ 个相同的球放入 $2n+2$ 个不同的盒子里的方案数，于是 $\displaystyle\binom{3n-i-k+1}{2n+1}=[x^{n-i-k}]G(x)$.

于是

$\displaystyle=\sum_{i=0}^n[x^i]F(x)[x^{n-i-k}]G(x)=[x^{n-k}](F(x)\times G(x))$

$\displaystyle=[x^{n-k}]\frac{1}{1-x}=1$. 原式得证。

&nbsp;

---


**题意**：给定长为 $n$ 的序列 $g,h$，再给定 $n$，求 $\displaystyle\sum_{k=0}^nk^ng_kh_{n-k}$ 的值。共有 $5$ 个子任务，对于每个子任务会额外给定限制，它们之间相互独立。每个测试点仅包含 $1$ 个 子任务，但有 $q$ 组数据。

&nbsp;

## Subtask1.

给定 $n$，对于每组数据给定 $m$. $g_k=[k<m],h_k=1$.

$\displaystyle\sum_{k=0}^nk^ng_kh_{n-k}=\sum_{k=0}^{m-1}k^n$. 由于 $n$ 均相同，对于每个数处理出其 $n$ 次幂并做前缀和即可，复杂度 $O(m\log p+q)$.

&nbsp;

## Subtask2.

对于每组数据给定 $n,m$。$\displaystyle g_k=\frac{1}{(k+m+1)!},h_k=[k\geq m]\frac{(-1)^{k-m}}{(k-m)!}$.

首先不考虑 $h$ 定义式中对于 $m$ 大小的限制。

$\displaystyle Ans=\sum_{k=0}^nk^n\frac{1}{(k+m+1)!}\times\frac{(-1)^{n-k-m}}{(n-k-m)!}$

$\displaystyle (n+1)!\times Ans=\sum_{k=0}^nk^n(-1)^{n-k-m}\binom{n+1}{k+m+1}$.

由 Part0 的结论得：

$\displaystyle=\sum_{k=0}^nk^n(-1)^{n-k-m}\sum_{j=0}^n\binom{j}{k}\binom{n-j}{m}$.

因为存在组合数，有 $j\geq k$.

$\displaystyle=\sum_{k=0}^n\sum_{j=k}^nk^n(-1)^{n-k-m}\binom{j}{k}\binom{n-j}{m}$

$\displaystyle=\sum_{j=0}^n\binom{n-j}{m}\sum_{k=0}^jk^n(-1)^{n-k-m}\binom{j}{k}$.

分离一项 $(-1)^{n-k-m}=(-1)^{j-k}\times(-1)^{n-m-j}$.

$\displaystyle=\sum_{j=0}^n(-1)^{n-m-j}\binom{n-j}{m}\sum_{k=0}^jk^n(-1)^{j-k}\binom{j}{k}$.

第二类斯特林数的通项公式为：$\displaystyle\begin{Bmatrix}n\\m\end{Bmatrix}=\frac{1}{m!}\sum_{i=0}^m(-1)^{m-i}\binom{m}{i}i^n$.

代入得

$\displaystyle=\sum_{j=0}^n(-1)^{n-m-j}\binom{n-j}{m}j!\begin{Bmatrix}n\\j\end{Bmatrix}$.

由 Part1 结论有

$\displaystyle A(n,k)=f(k)=\sum_{i=k}^n(-1)^{i-k}\binom{i}{k}(n-i)!\begin{Bmatrix}n\\n-i\end{Bmatrix}$.


令 $k=m$ （题目给出），$j=n-i$. 

$\displaystyle=\sum_{j=n-m}^{n}(-1)^{n-m-j}\binom{n-j}{m}j!\begin{Bmatrix}n\\j\end{Bmatrix}$.

由组合数范围性质，枚举可以下限调整为 $0$. 于是该式等于原式。

我们得到答案 $\displaystyle Ans=\frac{A(n,m)}{(n+1)!}$.

在一开始，我们忽略了 $h$ 的定义式对下标大小的限制。由于该限制本质上是截取了求和号的一部分，于是真正的答案为

$\displaystyle Ans=\frac{A(n,m)-A(m-1,m)}{(n+1)!}$. 而由一阶欧拉数的定义，$A(m-1,m)=0$。

问题来了，$q$ 组数据，如何计算 $A(n,m)$？利用反演式计算复杂度为 $O(n)$，无法采用。

但我们刚才证了 Part2，那么用结论就好了。于是复杂度 $O(nm+qm)$，可以通过。

&nbsp;

## Subtask3.

数列同 Subtask2，但是 $n$ 的范围扩展到了模数级别。

这只对答案分母上的阶乘和幂的预处理造成影响。我们考虑设置一个阈值 $B=10^6$，然后 $\forall i$，打表 $(iB)!$ 的值，那么我们可以做到 $\displaystyle O(B)$ 的查询复杂度。

因为幂的底数只有 $20$ 种，于是对每个数都根号 $n$ 预处理光速幂，用的时候直接 $O(1)$ 就行。

复杂度 $O(q(m+B))$.

&nbsp;

## Subtask4.

对于每组询问给定 $n,m$. $\displaystyle g_k=\frac{k^m}{k!},h_k=\frac{(-1)^k}{k!}$.

$\displaystyle Ans=\sum_{k=0}^nk^n\frac{k^m}{k!}\times\frac{(-1)^{n-k}}{(n-k)!}$

$\displaystyle=\frac{1}{n!}\sum_{k=0}^nk^{n+m}(-1)^{n-k}\binom{n}{k}$.

这是什么？看一下？第二类斯特林数！

$\displaystyle=\begin{Bmatrix}n+m\\n\end{Bmatrix}$.

虽然 sub4 两组数据 $n$ 的范围十分毁天灭地，但是我们有 Part3 的结论，也就是求：

$\displaystyle\sum_{i=0}^mB(m,i)\binom{n+2m-i-1}{2m}$.

二阶欧拉数有一个递推式，通过组合意义易证。

$B(n,k)=(k+1)B(n-1,k)+(2n-1-k)B(n-1,k-1)$.

先 $O(m^2)$ 递推。注意到 sub4 有两部分分，对于 $n$ 较小的部分预处理逆元，复杂度 $O(mq)$，对于 $n$ 较大但 $q$ 较小的部分快速幂，复杂度 $O(mq\log p)$.

需要一个快读取模 ~~（慢读）~~。这里的正确性由 $Lucas$ 定理保证，由于 $m$ 很小，$\displaystyle\binom{n}{m}\bmod p=\binom{n\bmod p}{m}\times\binom{n/p}{0}\bmod p=\binom{n\bmod p}{m}\bmod p$.

&nbsp;

## Subtask5.

对于每组数据给定 $n,m$，求 $\displaystyle Ans=\sum_{k=0}^m(k+1)^m\frac{(k+1)^{n+1}}{(k+1)!}\sum_{i=0}^{m-k}\frac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}$.

$\displaystyle=\sum_{i=0}^m\sum_{k=0}^{m-i}\frac{(k+1)^{m+n+1-i}}{(k+1)!}\frac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!}$

$\displaystyle=\sum_{i=0}^m\sum_{k=0}^{m-i+1}\frac{k^{m+n+1-i}}{k!}\frac{\binom{2n+1}{i}(-1)^{m-k+1}}{(m-k+1-i)!}$

$\displaystyle=\sum_{i=0}^m\binom{2n+1}{i}(-1)^i\sum_{k=0}^{m-i+1}\frac{k^{m+n+1-i}}{k!}\frac{(-1)^{m-k+1-i}}{(m-k+1-i)!}$

$\displaystyle=\sum_{i=0}^m\binom{2n+1}{i}(-1)^i\begin{Bmatrix}n+m+1-i\\m+1-i\end{Bmatrix}$.

由 Part4 的结论，这就是二阶欧拉数的通项公式。

由于数据范围较小，直接 $O(nm)$ 递推即可。

&nbsp;

---

后话：希望能对大家有所帮助，另外，望通过本篇题解。

题目里有个很深的坑，那就是 $B(0,0)=1$. ~~因为这个 WA 了无数遍。~~

```cpp
#include<bits/stdc++.h>
using namespace std;

#define int long long
#define MAXN 200055
#define mod 998244353
const int B = 1000000;
const int D = 35000;

inline int read(){
	int x = 0; char ch = getchar();
	while( ch < '0' || ch > '9' ) ch = getchar();
	while( ch >= '0' && ch <= '9' ) x = x * 10 + ch - 48,ch = getchar();
	return x;
}

inline int readmod(){
	int x = 0; char ch = getchar();
	while( ch < '0' || ch > '9' ) ch = getchar();
	while( ch >= '0' && ch <= '9' ){
		x = ( x * 10 % mod + ch - 48 + mod ) % mod;
		ch = getchar();
	}
	return x;  
}

void write( int x ){
	if( x >= 10 ) write( x / 10 );
	putchar( x % 10 + 48 );
}

int Id,n,m,q;
int prepow[MAXN] = {0},fac[MAXN] = {0},ifac[MAXN] = {0},inv[MAXN] = {0};
int poww[22][MAXN] = {0};
int facblock[] = {1,373341033,45596018,834980587,623627864,428937595,442819817,499710224,833655840,83857087,295201906,788488293,671639287,849315549,597398273,813259672,732727656,244038325,122642896,310517972,160030060,483239722,683879839,712910418,384710263,433880730,844360005,513089677,101492974,959253371,957629942,678615452,34035221,56734233,524027922,31729117,102311167,330331487,8332991,832392662,545208507,594075875,318497156,859275605,300738984,767818091,864118508,878131539,316588744,812496962,213689172,584871249,980836133,54096741,417876813,363266670,335481797,730839588,393495668,435793297,760025067,811438469,720976283,650770098,586537547,117371703,566486504,749562308,708205284,932912293,939830261,983699513,206579820,301188781,593164676,770845925,247687458,41047791,266419267,937835947,506268060,6177705,936268003,166873118,443834893,328979964,470135404,954410105,117565665,832761782,39806322,478922755,394880724,821825588,468705875,512554988,232240472,876497899,356048018,895187265,808258749,575505950,68190615,939065335,552199946,694814243,385460530,529769387,640377761,916128300,440133909,362216114,826373774,502324157,457648395,385510728,904737188,78988746,454565719,623828097,686156489,713476044,63602402,570334625,681055904,222059821,477211096,343363294,833792655,461853093,741797144,74731896,930484262,268372735,941222802,677432735,474842829,700451655,400176109,697644778,390377694,790010794,360642718,505712943,946647976,339045014,715797300,251680896,70091750,40517433,12629586,850635539,110877109,571935891,695965747,634938288,69072133,155093216,749696762,963086402,544711799,724471925,334646013,574791029,722417626,377929821,743946412,988034679,405207112,18063742,104121967,638607426,607304611,751377777,35834555,313632531,18058363,656121134,40763559,562910912,495867250,48767038,210864657,659137294,715390025,865854329,324322857,388911184,286059202,636456178,421290700,832276048,726437551,526417714,252522639,386147469,674313019,274769381,226519400,272047186,117153405,712896591,486826649,119444874,338909703,18536028,41814114,245606459,140617938,250512392,57084755,157807456,261113192,40258068,194807105,325341339,884328111,896332013,880836012,737358206,202713771,785454372,399586250,485457499,640827004,546969497,749602473,159788463,159111724,218592929,675932866,314795475,811539323,246883213,696818315,759880589,4302336,353070689,477909706,559289160,79781699,878094972,840903973,367416824,973366814,848259019,462421750,667227759,897917455,81800722,956276337,942686845,420541799,417005912,272641764,941778993,217214373,192220616,267901132,50530621,652678397,354880856,164289049,781023184,105376215,315094878,607856504,733905911,457743498,992735713,35212756,231822660,276036750,734558079,424180850,433186147,308380947,18333316,12935086,351491725,655645460,535812389,521902115,67016984,48682076,64748124,489360447,361275315,786336279,805161272,468129309,645091350,887284732,913004502,358814684,281295633,328970139,395955130,164840186,820902807,761699708,246274415,592331769,913846362,866682684,600130702,903837674,529462989,90612675,526540127,533047427,110008879,674279751,801920753,645226926,676886948,752481486,474034007,457790341,166813684,287671032,188118664,244731384,404032157,269766986,423996017,182948540,356801634,737863144,652014069,206068022,504569410,919894484,593398649,963768176,882517476,702523597,949028249,128957299,171997372,50865043,20937461,690959202,581356488,369182214,993580422,193500140,540665426,365786018,743731625,144980423,979536721,773259009,617053935,247670131,843705280,30419459,985463402,261585206,237885042,111276893,488166208,137660292,720784236,244467770,26368504,792857103,666885724,670313309,905683034,259415897,512017253,826265493,111960112,633652060,918048438,516432938,386972415,996212724,610073831,444094191,72480267,665038087,11584804,301029012,723617861,113763819,778259899,937766095,535448641,593907889,783573565,673298635,599533244,655712590,173350007,868198597,169013813,585161712,697502214,573994984,285943986,675831407,3134056,965907646,401920943,665949756,236277883,612745912,813282113,892454686,901222267,624900982,927122298,686321335,84924870,927606072,506664166,353631992,165913238,566073550,816674343,864877926,171259407,908752311,874007723,803597299,613676466,880336545,282280109,128761001,58852065,474075900,434816091,364856903,149123648,388854780,314693916,423183826,419733481,888483202,238933227,336564048,757103493,100189123,855479832,51370348,403061033,496971759,831753030,251718753,272779384,683379259,488844621,881783783,659478190,445719559,740782647,546525906,985524427,548033568,333772553,331916427,752533273,730387628,93829695,655989476,930661318,334885743,466041862,428105027,888238707,232218076,769865249,730641039,616996159,231721356,326973501,426068899,722403656,742756734,663270261,364187931,350431704,671823672,633125919,226166717,386814657,237594135,451479365,546182474,119366536,465211069,605313606,728508871,249619035,663053607,900453742,48293872,229958401,62402409,69570431,71921532,960467929,537087913,514588945,513856225,415497414,286592050,645469437,102052166,163298189,873938719,617583886,986843080,962390239,580971332,665147020,88900164,89866970,826426395,616059995,443012312,659160562,229855967,687413213,59809521,398599610,325666688,154765991,159186619,210830877,386454418,84493735,974220646,820097297,2191828,481459931,729073424,551556379,926316039,151357011,808637654,218058015,786112034,850407126,84202800,94214098,30019651,121701603,176055335,865461951,553631971,286620803,984061713,888573766,302767023,977070668,110954576,83922475,51568171,60949367,19533020,510592752,615419476,341370469,912573425,286207526,206707897,384156962,414163604,193301813,749570167,366933789,11470970,600191572,391667731,328736286,30645366,215162519,604947226,236199953,718439098,411423177,803407599,632441623,766760224,263006576,757681534,61082578,681666415,947466395,12206799,659767098,933746852,978860867,59215985,161179205,439197472,259779111,511621808,145770512,882749888,943124465,872053396,631078482,166861622,743415395,772287179,602427948,924112080,385643091,794973480,883782693,869723371,805963889,313106351,262132854,400034567,488248149,265769800,791715397,408753255,468381897,415812467,172922144,64404368,281500398,512318142,288791777,955559118,242484726,536413695,205340854,707803527,576699812,218525078,875554190,46283078,833841915,763148293,807722138,788080170,556901372,150896699,253151120,97856807,918256774,771557187,582547026,472709375,911615063,743371401,641382840,446540967,184639537,157247760,775930891,939702814,499082462,19536133,548753627,593243221,563850263,185475971,687419227,396799323,657976136,864535682,433009242,860830935,33107339,517661450,467651311,812398757,202133852,431839017,709549400,99643620,773282878,290471030,61134552,129206504,929147251,837008968,422332597,353775281,469563025,62265336,835064501,851685235,21197005,264793769,326416680,118842991,84257200,763248924,687559609,150907932,401832452,242726978,766752066,959173604,390269102,992293822,744816299,476631694,177284763,702429415,374065901,169855231,629007616,719169602,564737074,475119050,714502830,40993711,820235888,749063595,239329111,612759169,18591377,419142436,442202439,941600951,158013406,637073231,471564060,447222237,701248503,599797734,577221870,69656699,51052704,6544303,10958310,554955500,943192237,192526269,897983911,961628039,240232720,627280533,710239542,70255649,261743865,228474833,776408079,304180483,63607040,953297493,758058902,395529997,156010331,825833840,539880795,234683685,52626619,751843490,116909119,62806842,574857555,353417551,40061330,822203768,681051568,490913702,9322961,766631257,124794668,37844313,163524507,729108319,490867505,47035168,682765157,53842115,817965276,757179922,339238384,909741023,150530547,158444563,140949492,993302799,551621442,137578883,475122706,443869843,605400098,689361523,769596520,801661499,474900284,586624857,349960501,134084537,650564083,877097974,379857427,887890124,159436401,133274277,986182139,729720334,568925901,459461496,499309445,493171177,460958750,380694152,168836226,840160881,141116880,225064950,109618190,842341383,85305729,759273275,97369807,669317759,766247510,829017039,550323884,261274540,918239352,29606025,870793828,293683814,378510746,367270918,481292028,813097823,798448487,230791733,899305835,504040630,162510533,479367951,275282274,806951470,462774647,56473153,184659008,905122161,664034750,109726629,59372704,325795100,486860143,843736533,924723613,880348000,801252478,616515290,776142608,284803450,583439582,274826676,6018349,377403437,244041569,527081707,544763288,708818585,354033051,904309832,589922898,673933870,682858433,945260111,899893421,515264973,911685911,9527148,239480646,524126897,48259065,578214879,118677219,786127243,869205770,923276513,937928886,802186160,12198440,638784295,34200904,758925811,185027790,80918046,120604699,610456697,573601211,208296321,49743354,653691911,490750754,674335312,887877110,875880304,308360096,414636410,886100267,8525751,636257427,558338775,500159951,696213291,97268896,364983542,937928436,641582714,586211304,345265657,994704486,443549763,207259440,302122082,166055224,623250998,239642551,476337075,283167364,211328914,68064804,950202136,187552679,18938709,646784245,598764068,538505481,610424991,864445053,390248689,278395191,686098470,935957187,868529577,329970687,804930040,84992079,474569269,810762228,573258936,756464212,155080225,286966169,283614605,19283401,24257676,871831819,612689791,846988741,617120754,971716517,979541482,297910784,991087897,783825907,214821357,689498189,405026419,946731704,609346370,707669156,457703127,957341187,980735523,649367684,791011898,82098966,234729712,105002711,130614285,291032164,193188049,363211260,58108651,100756444,954947696,346032213,863300806,36876722,622610957,289232396,667938985,734886266,395881057,417188702,183092975,887586469,83334648,797819763,100176902,781587414,841864935,371674670,18247584};
int cd[22][D + 5] = {0},Bk[2005][2005] = {0};

inline int fp( int x , int p ){ int res = 1; while( p ){ if( p & 1 ) res = res * x % mod; x = x * x % mod; p >>= 1; } return res; }
inline int Fac( int T ){
	int Ans = facblock[T / B];
	for( int i = T / B * B + 1 ; i <= T ; i ++ )
		Ans = Ans * i % mod;
	return Ans;
}
inline int mpow( int x , int k ){ return cd[x][k / D] * poww[x][k % D] % mod; }
inline int C( int n , int m ){ return n >= m ? fac[n] * ifac[m] % mod * ifac[n - m] % mod : 0; }

inline void solve1(){
	n = read(),q = read();
	for( int i = 1 ; i <= n ; i ++ ) prepow[i] = fp( i , n );
	for( int i = 1 ; i <= n ; i ++ ) prepow[i] = ( prepow[i] + prepow[i - 1] ) % mod;
	for( int i = 1 ; i <= q ; i ++ ){
		m = read();
		write( prepow[m - 1] ); puts("");
	}
}

inline void solve2(){
	for( int i = 0 ; i <= 21 ; i ++ ){
		poww[i][0] = 1;
		for( int j = 1 ; j <= MAXN - 5 ; j ++ ) poww[i][j] = poww[i][j - 1] * i % mod;
	}
	q = read();
	for( int i = 1 ; i <= q ; i ++ ){
		n = read(),m = read();
		int Ans = 0,t = 1;
		for( int k = 0 ; k <= m ; k ++ ){
			Ans = ( Ans + 1ll * poww[m - k + 1][n] * t % mod * C( n + 1 , k ) % mod ) % mod;
			t = mod - t;
		}
		printf("%lld\n",Ans * ifac[n + 1] % mod);
	}
}

inline void solve3(){
	for( int i = 0 ; i <= 21 ; i ++ ){
		poww[i][0] = 1;
		for( int j = 1 ; j <= MAXN - 5 ; j ++ ) poww[i][j] = poww[i][j - 1] * i % mod;
		cd[i][0] = 1;
		for( int j = 1 ; j <= D ; j ++ ) cd[i][j] = cd[i][j - 1] * poww[i][D] % mod;
	}
	q = read();
	for( int i = 1 ; i <= q ; i ++ ){
		n = read(),m = read();
		int Ans = 0,C = 1,t = 1;
		for( int k = 0 ; k <= min( m , n + 1 ) ; k ++ ){
			Ans = ( Ans + mpow( m - k + 1 , n ) * t % mod * C % mod ) % mod;
			t = mod - t,C = C * inv[k + 1] % mod * ( n + 1 - k ) % mod;
		}
		printf("%lld\n",Ans * fp( Fac( n + 1 ) , mod - 2 ) % mod);
	}
}

inline int getrev( int x ){ if( x <= MAXN + 100 ) return inv[x]; else return fp( x , mod - 2 ); }

inline void solve4(){
	q = read();
	for( int i = 0 ; i <= m ; i ++ ) Bk[i][0] = 1;
	for( int i = 1 ; i <= 20 ; i ++ ){
		Bk[i][0] = 1;
		for( int j = 1 ; j <= 20 ; j ++ )
			Bk[i][j] = ( ( j + 1 ) * Bk[i - 1][j] % mod + ( 2 * i - j - 1 ) * Bk[i - 1][j - 1] % mod ) % mod;
	}
	for( int i = 1 ; i <= q ; i ++ ){
		n = readmod(),m = read();
		int Ans = 0,tmp = 1;
		for( int i = n ; i <= n + 2 * m - 1 ; i ++ ) tmp = 1ll * tmp * i % mod * getrev( i - n + 1 ) % mod;
		for( int i = 0 ; i <= m ; i ++ ){
			Ans = ( Ans + 1ll * tmp * Bk[m][i] % mod ) % mod;
			tmp = 1ll * tmp * getrev( n + 2 * m - i - 1 ) % mod * ( n - i - 1 ) % mod;
		}
		printf("%lld\n",Ans);
	}
}

inline void solve5(){
	for( int i = 1 ; i <= 2000 ; i ++ ){
		Bk[i][0] = 1;
		for( int j = 1 ; j <= 2000 ; j ++ )
			Bk[i][j] = ( ( j + 1 ) * Bk[i - 1][j] % mod + ( 2 * i - j - 1 ) * Bk[i - 1][j - 1] % mod ) % mod;
	}
	q = read();
	for( int i = 1 ; i <= q ; i ++ ){
		n = read(),m = read();
		printf("%lld\n",Bk[n][m]);
	}
}

signed main(){
	fac[0] = 1; for( int i = 1 ; i <= MAXN - 5 ; i ++ ) fac[i] = fac[i - 1] * i % mod;
	inv[1] = 1; for( int i = 2 ; i <= MAXN - 5 ; i ++ ) inv[i] = ( mod - mod / i ) * inv[mod % i] % mod;
	ifac[0] = 1; for( int i = 1 ; i <= MAXN - 5 ; i ++ ) ifac[i] = ifac[i - 1] * inv[i] % mod;
	Id = read();
	if( Id == 1 ) solve1();
	else if( Id == 2 ) solve2();
	else if( Id == 3 ) solve3();
	else if( Id == 4 ) solve4();
	else if( Id == 5 ) solve5();
	return 0;
}
```