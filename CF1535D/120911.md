首先重标号，我们将所有的标号反转一下就会发现 $i$ 的儿子是 $i\times 2$ 和 $i\times 2+1$ 。


设 $dp[i][0/1]$ 为第 $i$ 场比赛选 $0$ 或 $1$ 的赢家个数。


容易发现若选 $0$ 的话必然是小的儿子赢，否则比虽然是大的儿子赢。也就是 $dp[i][0]=dp[i\times 2 +1][0]+dp[i\times 2 +1][1],dp[i][1]=dp[i\times 2 ][0]+dp[i\times 2 ][1]$ 。由于重标号了所以标号大的原来反而小，编号小的原来反而大。

修改操作容易发现只对当前节点到根的链的答案有影响，这条链最长为 $k$ 。

所以这道题就做完了 $O(qk)$