**年轻人的第一道 dp of dp**

虽然不是我的第一道 dp of dp。但是这题十分的经典，很符合我对 dp of dp 的想象。

考虑如果每个点的权值是固定的，这就是经典的 [没有上司的舞会](https://www.luogu.com.cn/problem/P1352) 。设 $f_{i,0/1}$ 分别表示在 $i$ 的子树中，强制 $i$ 不选 / 强制 $i$ 选的最大权值。

发现 $k<5$ ，因此 $f_{i,0/1}$ 的值是 $O(n)$ 级别的。我们考虑**将dp的值作为状态**，设 $g_{u,i,j}$ 表示 $f_{u,0}$ 和 $f_{u,1}$ 分别为 $i$ 和 $j$ 时的方案数。转移直接枚举 $u$ 和其儿子 $v$ 的状态转移即可。

发现这样光是状态数就已经是 $O(n^3)$ ，无法通过。

考虑优化内层 dp。我们重新设 $f_{i,0/1}$ 为强制 $i$ 不选 / **不强制** $i$ 选的方案个数。

发现强制 $i$ 不选最多比不强制 $i$ 选权值少 $k$ ，也就是 $i$ 本身的权值。因此我们做一个差分，设 $g_{u,i,d}$ 表示 $f_{u,0}$ 和 $f_{u,1}$ 分别为 $i$ 和 $i+d$ 时的方案数。这次我们的状态数降到了 $O(n^2k^2)$ 。接下来直接 dp 即可，可以通过。
