参考自自己在[这道题的加强版](https://www.luogu.com.cn/problem/P7416)中的[题解](https://www.luogu.com.cn/blog/ICANTAKIOI/solution-p7416)。

我们不妨考虑这道题的加强版，即不问前后缀而是问一段区间 $(l,r)$。

先将询问离线，挂在 $r$ 上，然后从 $1\sim n$ 依次加入每段栅栏。

每次向右移时先加自己的代价，再考虑能不能和前一个颜色连起来，如果可以就把前面的代价删掉，查询就是区间和，树状数组维护单改区查即可。

这里判能不能连起来可以用 RMQ，但码量太大，可以复制一遍树状数组，检查两个相同颜色中间有没有比其小的。

设当前颜色为 $c$，也就是看当前比 $c$ 小的个数和上一个 $c$ 前比 $c$ 小的个数差是否为 $0$。

这道题直接把前后缀的和累加在一个答案数组上即可。

坑点：字符集虽然比 $26$ 小但可能比 $n$ 大。