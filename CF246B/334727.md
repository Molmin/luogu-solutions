## [$\color{Blue} \text{CF246B  Good Sequences}$](https://www.luogu.com.cn/problem/CF264B)

### $\large \text{Describe}$
给定一个严格上升的序列，求其最长的子序列，满足子序列中任两个相邻的元素不互质。

### $\large \text{Solution}$

这题要求的一眼看过去就是类似于最长上升子序列的东西，不如说是最长相邻不互质子序列。管他最长啥啥啥子序列，$O(n^2)$ 都是一定可以做到的，只要枚举这一项的前一项就好了。

至于优化——最长上升子序列可以用二分（我喜欢线段树/树状数组来搞）等算法优化，这个东西就要用一个技巧了。

首先我们考虑一个元素 $a_i$ 之前的所有元素，如果与 $a_i$ 有相同的质因子，这个元素的前一个元素可以是它。设 $\text{dp}_i$ 为以它结束的最长相邻不互质子序列，$\text{dp}_{i}= \max \limits_{\gcd(a_i,a_j)>1} \normalsize ( \text{dp}_{j}+1)$。


在这个元素之后，如果又和 $a_i$ 质因子相同的元素 $a_k$ ，那么之前 $a_i$ 枚举过的 $j$ 会再被枚举一遍。为了避免这种多次计算，我们考虑用一个数组 $f$，$f_x$ 表示当前枚举的元素之前，含有质因子 $x$ 的元素的 $\text{dp}$ 值的最大值。我们就可转化方程式，如下：

$\text{dp}_i= \max \limits_{x|a_i,x\in \text{prime}} (f_x+1)$

然后算完这个 $\text{dp}$ 值，这个元素可以为下一个元素服务了，我们要更新一下 $f$ ，对于所有的是 $a_i$ 是质因子的 $x$：

$f_x = \max \{ f_x,\text{dp}_i\}$

这样时间复杂度变成每个元素找出其质因子的枚举次数加上其质因子数量，应该是 $O(n \sqrt{n})$ 。

至于[代码](https://paste.ubuntu.com/p/PZmwhsCZxb/)，过于烂，自己看吧。