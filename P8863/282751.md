令 $sum=\sum b_i$。

考虑看成有 $\frac{sum}{2}$ 个盒子，每个盒子可以放两个球，这两个球不能相同，第 $i$ 种球有 $b_i$ 个。

然后考虑一个一个 $b_i$ 的加。

我们需要知道的是有多少个盒子能放两个球，多少个能放一个，多少个放不了了。

设 $dp_{i,j}$ 表示加了前 $i$ 个元素，还有 $j$ 个盒子能放一个。那么我们知道目前我们一共加了 $S=\sum_{k=1}^{i}b_k$ 个球，有 $j$ 个放了一个，就有 $\frac{S-j}{2}$ 个盒子放了两个（不整除就不合法），又因为我们知道一共有多少盒子，也就知道了还有多少个盒子没有放球。

记 $dp_{i,j}$ 对应的三种元素数量为 $(a,b,c)$，$a=\frac{S-j}{2},b=j,c=\frac{sum}{2}-a-b$。

考虑从 $i-1$ 转移，暴力的转移是枚举一个 $k$ ，从 $dp_{i-1,k}$ 转移到 $dp_{i,j}$ ，记 $dp_{i-1,k}$ 对应 $(a',b',c')$。考虑转移的系数，原来有 $c'$ 个没有球的盒子，现在只有 $c$ 个，那么有 $c'-c$ 个空的变成装了一个球的盒子（显然不能变成装两个），所以这里要乘 $C^{c'-c}_{c}$，然后原来有 $a'$ 个装了两个的盒子，现在变成了 $a$ 个，那么有 $a-a'$ 个装了一个的盒子又装了一个。再乘一个 $C^{a'-a}_{b'}$。即 $dp_{i,j}=\sum dp_{i-1,k}\times C^{c'-c}_{c} \times C^{a'-a}_{b'}$。

这样做的复杂度是 $O(n w^2)$ 的，其中 $w=\sum b_i$。

注意到一个 $(a,b,c)$ 对于每个 $i$ 唯一确定了一个 $dp_{i,k}$ ，考虑枚举 $a'$ ，根据刚才的式子可以反推出 $b',c'$，也就知道所对应哪个 $dp_{i-1,k}$ ，我们发现 $|a-a'|\le b_i$（这里变量名重了，问题不大），所以总复杂度变成了 $O(w^2)$ ，常数较小，可以通过。