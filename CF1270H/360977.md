本题要维护的东西十分怪，为连通块个数，看上去便不太能直接维护，于是考虑观察一下连边的性质。可以发现若 $(i,j) (i < j)$ 有一条连边，则 $\forall x \in [i,j]$，$x$ 与 $i,j$ 在同一个连通块内。证明考虑因为 $a_i < a_j$，若 $a_x > a_i$，则 $x$ 与 $i$ 有一条连边，若 $a_x < a_i$，则 $a_x < a_j$，那么 $x$ 与 $j$ 有一条连边。有了这个性质，也就说明连通块一定是一个区间。

根据上述证明，我们又可以发现，若区间 $[l_1,r_1]$ 与区间 $[l_2,r_2]$ 不在一个连通块内，当且仅当 $\min_{i=l_1}^{r_1} a_i > \max_{i=l_2}^{r_2} a_i$。因此，总连通块个数其实可以转换为 $\min_{i=1}^p a_i > \max_{i=p+1}^n a_i$ 的 $p$ 的个数。

接着，因为值域不大且每个数各不相同，考虑一个常见套路，即枚举 $\max_{i=p+1}^n a_i$，设其值为 $v$，则将 $a_i \le v$ 的数变为 $0$，将 $a_i>v$ 的数变为 $1$，则连通块个数为所有在 $a$ 中出现过的 $v$ 形成的形如 $111\dots000\dots$ 这样的由一个前缀的全 $1$ 序列和一个后缀的全 $0$ 序列构成的 $a$ 的个数。

考虑在变换后 $a$ 的前面加上一个 $0$，在 $a$ 的后面加上一个 $1$，则原条件等价于新的 $a$ 上只会有一次 $1 \rightarrow 0$ 的交替，我们可以发现 $a_i,a_{i+1}$ 会发生 $1 \rightarrow 0$ 或 $0 \rightarrow 1$ 交替当且仅当 $v \in [\min(a_i,a_{i+1}),\max(a_i,a_{i+1}) )$ 中。

考虑维护一棵值域线段树，维护每个 $v$ 的 $0 \rightarrow 1$ 和 $1 \rightarrow 0$ 的出现次数和（因为我们的序列是以 $1$ 开头以 $0$ 结尾的，所以出现次数和为 $1$ 就意味着只出现了一次 $1 \rightarrow 0$ 交替），以及区间出现次数最小值和最小值在 $a$ 中的个数。初始化时直接对于每个 $a_i,a_{i+1}$ 做一次区间加，在每个 $a_i$ 的位置给其个数 $+1$，单点改时设改的位置为 $pos$，将原本的 $a_{pos-1},a_{pos}$ 和 $a_{pos},a_{pos+1}$ 对次数的贡献和 $a_{pos}$ 对个数的贡献减掉，并算上新的贡献即可。

[Code](https://www.luogu.com.cn/paste/gxnxue81)