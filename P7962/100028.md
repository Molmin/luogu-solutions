转述一下，本人水平不够并没有代码实现，但是 @AThousandMoon 场上用这个做法过了，应该没有大问题。

首先注意到操作相当于交换差分数组的相邻两项。自己推一推，很好懂。

设差分数组为 $b_1,\dots,b_{n-1}$，不需要知道原序列第一项就可以算出方差。

方差（题目要求 $n^2$ 倍，以下将其称为 $ans$）计算公式为：

$$ans=n\sum_{i=1}^na_i^2-(\sum_{i=1}^na_i)^2$$

由于 $a_1$ 没用，直接认为 $a_i$ 为 $b_1$ 至 $b_{i-1}$ 的和即可。

经过大力拆括号可以推出：

$$ans=\sum_{i=1}^{n-1}b_i^2i(n-i+1)+\sum_{i=1}^{n-1}\sum_{j=i+1}^{n-1}b_ib_ji(n-j+1)$$

现在可以重排序列 $b$ 使得此式最小。

首先注意到最优的 $b$ 必然是先降后增。应该可以调整法~~或感性理解~~之类证明。

那么最小的那 $i$ 个数一定是形成一个长度为 $i$ 的区间。假设 $[l,r]$ 内填了最小的 $r-l+1$ 个数。

接下来考虑在 $l-1$ 或者 $r+1$ 选一个位置填入第 $r-l+2$ 小的数。可以发现新增的贡献只和已经填入的 $\sum b_ii$ 有关。

所以可以设 $f_{l,r,s}$ 表示填了 $[l,r]$，这里面的 $\sum b_ii=s$，式子的最小值。

转移大概是（其中 $x$ 为第 $r-l+2$ 小的数，$p_i$ 为前 $i$ 小的数的和）：

$$f_{l-1,r,s+(l-1)x}\leftarrow f_{l,r,s}+x^2(l-1)(n-l+1)+2x(l-1)(np_{r-l+1}-s)$$

$$f_{l,r+1,s+(r+1)x}\leftarrow f_{l,r,s}+x^2(r+1)(n-r-1)+2x(n-r-1)s$$

这个转移式子的意义，就是考虑和式中新出现的每一对 $i,j$ 的贡献（也即 $i,j$ 一个在 $[l,r]$ 内一个为新加的）。

第三维的大小至多为 $n\sum b_i=na_n$。此时时间复杂度 $O(n^3a)$，期望得分 72 分，如果实现优秀可以期望得分 84 分。

~~应该是大多数人的标准结局？~~

本人只保留被访问到的位置进行 DP，场上大样例只用了 0.5s，最终官方数据得分 100 分。然而各个地方自测都是 84 分，所以考虑更优秀的做法。

~~CCF 你数据比随机数据还水真的有点厉害~~

再次审视一下这个转移式子，可以发现固定 $[l,r]$ 时，只有在下凸包上的点 $(s,f_{l,r,s})$ 有用。如果不在下凸包上，用将其覆盖住的那条凸包上线段的两个端点代替 $[l,r]$ 内的决策（保持 $[l,r]$ 外决策不变），至少有一个比现在优。

证明应该不难，就考虑这三个方案中，$i,j$ 均在 $[l,r]$ 外的贡献都一样，恰一个在 $[l,r]$ 内的贡献是个关于 $s$ 的正比例函数加上只关于 $l,r$ 以及 $[l,r]$ 外部的方案的定值，均在 $[l,r]$ 内的贡献就是 $f_{l,r,s}$。

所以只保留凸包上的点进行转移即可。

据 @AThousandMoon 所说，考场上大样例满足每个凸包的点数都是 $O(1)$，不知道这是数据水了还是可以证明某些东西。

若看作凸包点数为 $O(1)$，则时间复杂度为 $O(n^2)$。

最后同样需要用 $b$ 中至多 $a_n$ 个非零数的结论，将前面等于零的放在一起考虑，少了很多状态，时间复杂度 $O(\min(n,a)^2)$ 至 $O(n\min(n,a))$，取决于实现。

若有证明（或证伪）欢迎在评论区讨论。