我们尝试用抽象代数的语言理解这个题。

下文中 $p, q$ 都表示置换，即

$$
p = \binom{1,2, \cdots, n}{p_1, p_2, \cdots, p_n}, q = \binom{1, 2, \cdots, n}{q_1, q_2, \cdots, q_n}
$$

在这个代数系统中，满足结合律，存在逆元和单位元。

容易观察到 $(pq)^{-1} = q^{-1}p^{-1}$。

根据题意，有 $f(p, q)p = q$，也就是 $f(p, q) = qp^{-1}$。

然后我们多列几项：

$$
\begin{aligned}
a_1 &= p \\
a_2 &= q \\
a_3 &= qp^{-1} \\
a_4 &= qp^{-1}q^{-1} \\
a_5 &= qp^{-1}q^{-1}pq^{-1} \\
a_6 &= qp^{-1}q^{-1}p^2q^{-1} \\
a_7 &= qp^{-1}q^{-1}pqpq^{-1} \\
a_8 &= qp^{-1}q^{-1}pqp^{-1}qpq^{-1}
\end{aligned}
$$

如果令 $A = qp^{-1}q^{-1}p$，那么 $A^{-1} = p^{-1}qpq^{-1}$，我们发现 $a_7 = ApA^{-1} = Aa_1A^{-1}$，$a_8 = AqA^{-1} = Aa_2A^{-1}$，接下来继续列几项：

$$
\begin{aligned}
a_9 &= Aqp^{-1}A^{-1} = Aa_3A^{-1} \\
a_{10} &= Aqp^{-1}q^{-1}A^{-1} = Aa_4A^{-1}
\end{aligned}
$$

至此，规律已经很显然了，这个序列以 $6$ 为周期，每六项就会在两边分别乘上一个 $A$ 和一个 $A^{-1}$。

由于置换的乘法是符合结合律的，可以用快速幂在 $O(\log k)$ 的时间内计算。乘法本身的时间复杂度是 $O(n)$，总的时间复杂度为 $O(n \log k)$。