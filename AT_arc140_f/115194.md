巨大蠢题。这是我见过的最垃圾的 ARC，没有之一。

首先考虑将一个 $P$ 映射到 $P^{-1}$ 上——显然 $P$ 中一个 $|P_i-P_{i+1}|=m$ 的位置就对应 $P^{-1}$ 中一个 $|P_i-P_{i+m}|=1$ 的位置，因此我们可以直接对每个 $\bmod m$ 的剩余系做 $m=1$ 的情况，然后快速幂合并即可。由于 $\bmod m$ 的剩余类最多只有两种不同的大小，因此我们只需解决 $m=1$ 的情况，就解决了整道题。

考虑 $m=1$ 的情况怎么解决。一看就是一个非常典的问题。我们考虑设 $g_k$ 表示钦定 $k$ 个位置满足 $|P_i-P_{i+1}|=1$ 的可能的排列个数，然后二项式反演一下即可得到答案。考虑怎样求 $g_k$，显然这等价于将序列划分为 $n-k$ 段，对于每一种划分方法将 $2^{\text{长度不小于二的连续段个数}}$ 累加求和，然后乘个 $(n-k)!$ 就是 $g_k$。

这样我们可以写出 $g$ 的生成函数：$g_k=(n-k)![x^n]F(x)^{n-k}$，其中 $F(x)=x^1+2x^2+2x^3+2x^4+\cdots$，发现 $F(x)=\dfrac{2x}{1-x}-x$，故 $[x^n]F(x)^{n-k}=\sum\limits_{i=0}^{n-k}\dbinom{n-k}{i}·(-1)^i·2^{n-k-i}·\dbinom{n-i-1}{n-k-i-1}$，这东西是可 NTT 的，然后直接 NTT 就完事了。