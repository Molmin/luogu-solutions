考虑对于原问题，在 $n$ 意义下令 $G(x)$ 表示长为 $n$ 且完美数个数为 $x$ 的排列个数。                        

接着我们定义 $F(x)$ 为在 $n$ 意义下长为 $n$ 且在一开始时指定了 $x$ 个固定完美数其余位置随便放的方案数。

显然 $F(x)$ 会对每个 $G(i),i \geq x$ 重复统计 $\binom{i}{x}$ 次，所以可以得到一个等式：

$F(x) = \sum_{i = x} ^ n \binom{i}{x} G(i)$

可以通过二项式定理变成：         

$G(x) = \sum_{i = x} ^ n (-1) ^ {i - x} \binom{i}{x} F(i)$

考虑快速计算 $F(x)$ 的方法。                

此时需谨慎根据 $F(x)$ 的定义列转移柿，我们显然可以通过枚举哪些位子被固定成了完美数后对答案乘上 $(n - x)!$ 计算，同时一个位子被固定成完美数只与 $(i - 1)$ 和 $(i + 1)$ 有关，从此处设计我们的 dp：

定义 $dp_{i,j,0/1,0/1}$ 表示将前 $i$ 个位置里面固定了 $j$ 个位置变成完美数，其中数 $i$ 在此次抉择之后没选过/选过，数 $i + 1$ 在此次抉择之后没选过/选过的方案数。              

考虑转移，如果当前位置要变成完美数，则：

- 若让 $(i - 1)$ 放到这个位置，那么得保证之前状态里 $(i - 1)$ 未被用过，并且由于我们知道，放数这个过程对于任意数 $i$ 只会放到 $(i - 1)$ 和 $(i + 1)$ 这两个地方，所以若 $i$ 这个位置填了 $(i - 1)$，$(i + 1)$ 这个数肯定未被填过；          

转移方程:

$dp_{i,j,0,0} \leftarrow dp_{i-1,j-1,1,0}$

$dp_{i,j,1,0} \leftarrow dp_{i-1,j-1,1,1}$

- 若让 $(i + 1)$ 放到这个位置，那么不知道 $(i - 1)$ 这个数被放过没有，所以得转移两个状态；

转移方程：

$dp_{i,j,0,1} \leftarrow dp_{i-1,j-1,0,0} + dp_{i - 1,j - 1,1,0}$

$dp_{i,j,1,1} \leftarrow dp_{i-1,j-1,0,1} + dp_{i - 1,j - 1,1,1}$ 

如果当前位置不需变成完美数，显然 $(i + 1)$ 还是不能出现的，所以转移方程：

$dp_{i,j,0,0} \leftarrow dp_{i-1,j,0,0} + dp_{i-1,j,1,0}$

$dp_{i,j,1,0} \leftarrow dp_{i-1,j,0,1} + dp_{i-1,j,1,1}$

最后反演求出 $G(k)$ 即可。

时间复杂度 $O(n^2)$。

