考虑画出一个楼梯的轮廓线。边界格数等于规则（左边与上边）轮廓线长度减一，也等于不规则轮廓线长度减一。

还有一个很好的性质：一个子楼梯的不规则轮廓线，一定是整个楼梯的不规则轮廓线的某一个子区间。更进一步，某个轮廓线子区间对应一个合法子楼梯的充要条件是这个子区间第一步轮廓线方向向下，最后一步轮廓线方向向左。

然后我们考虑用 $0$ 和 $1$ 表示轮廓线（分别表示向下和向左）。我们求出整个轮廓线对应的 $01$ 序列 $S$，记其长度为 $x$。根据条件我们有 $(q-1)|(x-1)$。找到子楼梯，等价于找到一对 $i,j$，满足 $S_i=0,S_j=1,j-i=q-1$。我们只考虑 $S_1,S_{1+q},...,S_{x}$ 这些位置，其中 $S_1=0,S_{x}=1$。我们尝试二分答案，假设我们现在保留了 $S_{1+l \times q},...,S_{1+r \times q}$，其中 $S_{1+l \times q}=0,S_{1+r \times q}=1$。那么我们每次取出 $S_{1+mid \times q}$，根据它是 $0$ 或 $1$ 来调整 $l$ 或 $r$ 的范围，当 $r-l=1$ 时，我们便得到了一组合法答案。

现在唯一的问题是支持修改，快速求出某个位置的轮廓线方向。这时我们可以考虑直接用可持久化线段树维护序列，某个位置的轮廓线方向也容易通过序列上的线段树二分在 $O( \log V)$ 的时间复杂度内求出。

这样，我们的总时间复杂度为 $O(n \log^2 V)$。