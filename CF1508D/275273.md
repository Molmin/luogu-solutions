先忽略掉所有 $a_i = i$ 的点。

考虑我们钦定一个点 $s$，每次与 $a_s$ 换直到 $a_s = s$ 为止。不难发现这样相当于在置换环上删掉 $a_s$ 这个点。这样可以解决 $s$ 所在的环。

问题是可能会形成很多个环。

我们把其他点按照 $s$ 极角排序，注意此处 $s$ 应选取横坐标最小的点，作用是保证不存在两点夹角 $> \pi$。排序后如果相邻的点不在同一个连通块就交换它们。容易发现对于不在同一个置换环上的两个点，交换它们的 $a_i$ 相当于合并这两个环。

交换完一遍后容易发现只存在一个大的置换环。然后我们就做一遍开头所述算法即可。

使用并查集维护连通性即可。