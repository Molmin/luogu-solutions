## 题目

[P5386 [Cnoi2019]数字游戏](https://www.luogu.com.cn/problem/P5386)

给定一个序列，每次询问：给定 $l,r,x,y$ ，问 $[l,r]$ 有多少个子区间满足其区间所有数使得 $x\leq a_i \leq y$。

$n,q\leq 10^5$。

（和 [第十分块](https://www.luogu.com.cn/problem/P6578) 的分块维护几乎一模一样。）

## 分析

回滚莫队+序列分块。

首先这道题限制很多，但是可以离线，数据范围又是 $1e5$ ，于是理所当然可以想一下莫队。

发现直接莫队就可以去除 $l,r$ 的限制条件，现在问题变成了，询问当前序列有多少个这样的子区间满足 $x\leq a_i \leq y$。

由于 $x,y$ 都是一个静态的给定值，于是可以想到把这个不等关系变成 01 变量来表示，那么这里就可以这样转化成：

定义 $b_i=(x\leq a_i \leq y)$ ，接下来就是询问所有极长连续 1 子区间的 $siz*(siz+1)/2$ 的和，同时还有单点修改，每次 $0->1$ 或者 $1->0$。

那么这里我们要支持这样 $O(1)$ 的单点修改和 $O(\sqrt{n})$ 的单次查询才行，可以考虑序列分块或者链表，这里使用序列分块。

因为 $1->0$ 非常的不好处理，于是我们要想怎么把这个东西去掉。

发现这样的情况只会在这种情况下出现：由于我们使用的是普通莫队，所以我们会导致有一个删除操作，就是这个删除操作会导致有 $1->0$ 这种情况。

那么不删除不就好了？再加上分块可以支持撤回操作（可撤销分块（雾））（像可撤销并查集一样拿一个栈记录操作就好了），于是我们就直接回滚莫队来把删除操作变成撤销操作即可。

块大小取 $\sqrt{n}$，这样时间复杂度是 $O(n\sqrt{n})$ （假设 $n,q$ 同阶）。

## 代码


要的可以私信我 $QWQ$ 。
