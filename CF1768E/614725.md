较为基础的计数题。

首先可以发现至多 $3$ 次操作：按照 $1,2,1$ 的顺序进行操作一定可行。因为经过前两次操作，$[2n+1,3n]$ 内的数一定被放到后 $n$ 个位置了。再经过一次排序就可以成功了。故我们只需分别统计三种排列的个数。

* $f(p)=0$：

即已经有序，一个。记为 $ans_0=1$。

* $f(p)\leq 1$：

容易发现，这等价于前面 $n$ 个或者后面 $n$ 个已经归位，减去重复的后得到数量为 $2\times (2n)!-n!$，记为 $ans_1$。

* $f(p)\leq 2$：

这等价于数 $[1,n]$ 在前 $2n$ 个位置中或者 $[2n+1,3n]$ 在后 $2n$ 个位置中。

分别计算得到 $2\times C_{2n}^n\times (n!)\times (2n)!$。

这题的难点就在于重复情况，即 $[1,n]$ 在前 $2n$ 个位置中且 $[2n+1,3n]$ 在后 $2n$ 个位置中。

发现 $[1,n]$ 的占位情况对 $[2n+1,3n]$ 有多少个可选位置有影响。可以枚举前 $n$ 个位置中有 $i$ 个 $[1,n]$ 中的数，那么我们的问题分三步：给 $[1,n]$ 中的数选位置，给之后的数选位置，以及排列这些数。计算得到这部分答案是 $\sum\limits_{i=0}^n(C_n^i)^2\times C_{n+i}^n\times (n!)^3$。（看上去和某些题解的结论不一样，其实只是枚举方式的不同，实际这两个东西是相等的）

这样，我们终于得到了 $ans_2=2\times C_{2n}^n\times (n!)\times (2n)!-\sum\limits_{i=0}^n(C_n^i)^2\times C_{n+i}^n\times (n!)^3$

$f(p)\leq 3$：

显然就是全部 $(3n)!$ 个排列，记为 $ans_3$。

最后注意我们求出的 $ans_0,\cdots ans_3$ 是互相包含的，类似于前缀和的方式互相减减就行了。[代码](https://codeforces.com/contest/1768/submission/209241243)。