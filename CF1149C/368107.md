[$\tt Link$](/problem/CF1149C)。

树在变化且变化没有规律，我们不好维护树，考虑从括号序入手。

首先讨论一条链在括号序上是怎样的。

+ $\color{red})\cdots)\color{green}(\cdots($
+ $\color{red}(\cdots(\color{green}(\cdots($
+ $\color{red})\cdots)\color{green})\cdots)$

红色和绿色是一段连续的左括号或右括号（路径部分），但是还有一些括号穿插其中，它们互相匹配但是不会在这条链上。

如果带上其它的部分是不好讨论的，我们希望用合理的方法规避掉那些部分。

考虑把左括号和右括号的权值记为 $1,-1$，然后这时 $1\cdots n$ 的直径长度就是 **找到 $p\in[1,n]$，最大的 $\Sigma(p,n]-\Sigma[1,p]$**，其中 $\Sigma$ 为一个区间的权值和。

这样似乎考虑有时把一对括号拆开？并不，拆开一对括号会让答案减小 $2$，所以为了答案的 $\max$ 一定不会拆开括号。

单点修改，全局查询这玩意（但是这玩意并不好搞），考虑上线段树。

这个有点类似最大子段和。线段树维护这些东西：

1. 区间和（辅助转移）
1. 从左或右开始的最大连续和
1. 从左或右开始的最大的差
1. 整个区间的最大的差
1. 区间内（不受限制）的最大的差

转移看代码。主要思想就是看选择的 $p$ 是在这个点的左子树还是右子树。

<https://codeforces.com/contest/1149/submission/166449731>