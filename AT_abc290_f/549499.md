**【置顶】本题解中有一些乱搞内容，如果想要纯粹的正解请右转其他大佬的题解。**

## ABC290F Maximum diameter

### 1. 题意

对于一个长度为 $n$ 的序列 $P$，定义 $f(P)$ 为：

- 如果存在一棵 $n$ 个结点的树，使得第 $i$ 个节点的度数为 $P_i$，则 $f(P)$ 为这棵树的直径长度的最大值。
- 否则 $f(P)=0$。

现在给你一个 $n$，求所有长度为 $n$ 的序列的 $f$ 值的和。

多测，$T\le2\times10^5,n\le10^6$。

### 2. 题解

#### (1) 把 $f(P)$ 具象化

首先你会发现“所有序列”根本就是扯淡，只有满足 $\sum\limits_{i=1}^nP_i=2n-2$ 的 $P$ 才有树符合条件。

然后，“直径长度的最大值”还是一个问题。

不过我们可以发现，树中所有非叶节点是联通的。我们不妨让他们连成一条链，然后两边各连一个叶子节点，直径的长度就是最长的。

所以有 $f(P)=(P$ 中所有满足 $P_i\ge2$ 的 $i$ 的个数 $)+1$。

然后我们就完全把树抛开了。

接下来怎么计算呢？

#### (2) 统计答案

设 $ans_n$ 为 $n$ 的最终答案。

我们可以考虑有 $k(2\le k<n)$ 个叶子的时候，对答案产生多少贡献。

首先，要在 $n$ 个点中选择 $k$ 个作为叶子，即 $\dbinom{n}{k}$。

其次，要把剩下的度数分给 $(n-k)$ 个点，一共有 $2n-2-k$ 个度数，每个点的度数至少为 $2$，根据小学奥数的知识，贡献要乘上 $\dbinom{(2n-2-k)-(n-k)-1}{(n-k)-1}=\dbinom{n-3}{n-k-1}=\dbinom{n-3}{k-2}$。

最后在乘上直径长度 $(n-k+1)$。

于是我们得到了答案：

$$ans_n=\sum\limits_{k=2}^{n-1}\dbinom{n}{k}\cdot\dbinom{n-3}{k-2}\cdot(n-k+1)$$

（注意这里要特判 $n=2$）

做完了。

但还没有完全做完。

### (3) 优化

上面的做法时间复杂度是 $O(Tn)$，会 TLE。（悲

对着式子想了半天，没想到什么优化的思路。

于是开始乱搞。

首先，打表。

$$ans_2=1,ans_3=6,ans_4=26,ans_5=110,ans_6=462,ans_7=1932,ans_8=8052,ans_9=33462,\ldots$$

……看不出任何规律。

于是上 [OEIS](https://oeis.org) 搜。

……搜不到。

于是开始瞪眼大法。

突然发现相邻两项的商接近 $4$。

于是，搞出 $g_x=ans_{x+1}-4\cdot ans_x$。

$$g_2=2,g_3=2,g_4=6,g_5=22,g_6=84,g_7=324,g_8=1254,\ldots$$

发现全是偶数。于是，令 $h_x=\dfrac{g_x}{2}$：

$$h_2=1,h_3=1,h_4=3,h_5=11,h_6=42,h_7=162,h_8=627,\ldots$$

发现 $h$ 可以在 OEIS 上[搜到](https://oeis.org/search?q=1%2C1%2C3%2C11%2C42%2C162%2C627&language=english&go=Search)。

$$h_{n+2}=\dfrac{cat_n\cdot(n^2+2)}{n+2}$$

（其中 $cat$ 是 [$\text{Catalan}$ 数](https://baike.baidu.com/item/%E5%8D%A1%E7%89%B9%E5%85%B0%E6%95%B0/6125746?fromtitle=catalan%E6%95%B0%E5%88%97&fromid=10814050&fr=aladdin)）

$h$ 可以线性计算。

$$ans_{x+1}=4\cdot ans_x+2\cdot h_x\ (x\ge2),ans_2=1$$

然后这题就真的做完了。

### 3. 代码

这里就不放了，代码戳[这里](https://atcoder.jp/contests/abc290/submissions/39046485)。