？为什么都写的那么复杂

考虑没有 $0$ 的情况，那么一个显然的性质：若 $a\times b,b\times c$ 为完全平方数，那么 $a\times c$ 也是完全平方数。随便证一下就好了。维护一个并查集，若 $a_i\times a_j$ 为完全平方数那么就把他们塞到一个集合里，那么问题就变成了区间有多少个集合，不难写出 $\mathcal O(n^2)$ 的做法。

如果有 $0$，为了仍然满足条件，把所有 $0$ 塞到一个集合里就行了。特判一下整个区间全是 $0$ 的情况就行了。

代码就不放了吧。