[更好的阅读体验](https://www.cnblogs.com/LaoMang-no-blog/p/16189295.html)

---

[**你谷 link**](https://www.luogu.com.cn/problem/P7293)

这个题也太妙了，考场根本一点头绪没有。

给定一些图，求这些图的张量积中 $(1,1,\cdots,1)$ 到所有点的最短路和。

首先我们发现这个张量积上的最短路有什么特点，我们可以考虑将所有图分开考虑，每一张图分开做，加入从 $(1,1,\cdots,1)$ 到 $(a_1,a_2,\cdots,a_K)$，可以看成分别从 $1$ 到 $a_1$，$1$ 到 $a_2$，$\cdots$，$1$ 到 $a_K$，同时到达。

我们发现图是无向图，所以可以通过在一条边反复走来达到等待的目的，所以就只和最短路长度的奇偶性相关。

考虑算出每张图上每个点的奇偶最短路，设第 $i$ 张图中 $1$ 到 $j$ 的长度为奇数的最短路长度为 $\text{odd}_{i,j}$，长度为偶数为 $\text{even}_{i,j}$，那么 $(1,1,\cdots,1)$ 到 $(a_1,a_2,\cdots,a_K)$ 的最短路长度为 $\min\{\max_{i=1}^K\{\text{odd}_{i,a_i}\},\max_{i=1}^K\{\text{even}_{i,a_i}\}\}$，这个东西是 $\min$ 套 $\max$，并不是很好处理，所以考虑进行一步转化，将 $
\min$ 展开成 $\max$，最后我们就是要求这样一个式子：

$$
\sum_{1\le a_i\le n_i}\max_{i=1}^K\{\text{odd}_{i,a_i}\}+\max_{i=1}^K\{\text{even}_{i,a_i}\}-\max_{i=1}^K\{\text{odd}_{i,a_i},\text{even}_{i,a_i}\}
$$

发现可以把三个式子分开来算，这样形式是一样的，最后就是要算这样一个东西：

$$
\sum_{1\le a_i\le n_i}\max_{i=1}^K\{V_{i,a_i}\}
$$

考虑这个 $V$ 的范围只有 $n$，所以可以统计 $\max_{i=1}^K\{V_{i,a_i}\}=x$ 的 $(a_1,a_2,\cdots,a_n)$ 的数量。

然后再考虑这个新的式子怎么算，其实也不难，因为求得是 $\max$，又是计数，可以考虑两两合并，这样就只要考虑相邻两项，算以下式子：

$$
F_k=\sum_{\max\{i,j\}=k}A_iB_j
$$

其中 $A_x$，$B_x$ 分别代表待合并的两个数组中满足 $\max_{i=1}^K\{V_{i,a_i}\}=x$ 的数量，$F_x$ 同理，不过是合并结果。

这个式子很像卷积，但显然不是正常的多项式卷积或是位运算卷积之类的，所以肯定不是什么 FFT 或者 FWT 之类的。

这个可以形象地称为 $\max$ 卷积的东西算起来相对 FFT 或者 FWT 更简单地多，但我们可以思考做一种类似 FFT 中 DFT 和 IDFT 的变换来使其成为一种线性变换，发现这个东西可以用一种非常简单的办法，就是直接前缀和，逆变换就是直接再差分回来就好了，读者可以手模一下，具体原理可以看下面这张图：

![](https://s2.loli.net/2022/04/25/JD23HaL9j8zqgWM.png)

这里黑色的格子表示两个要合并的数组，红线表示待求值最顶层要算的，红线和蓝线的和正好是前缀和的积，而蓝线也是前缀和的积，做差分就能得到答案。

这样整道题就做完了，但还有一个细节。

两个数组和合并是 $\mathcal O\left(\text{len}\right)$ 的，如果直接将所有数组合并时间复杂度会退化成 $\mathcal O\left(Kn\right)$，会被卡掉，怎样优化呢？其实直接将数组按长度从小到大合并就好了，这样时间复杂度就是 $\mathcal O\left(\sum n\right)$，是可过的。

[**c++ 代码**](https://www.cnblogs.com/LaoMang-no-blog/p/16189295.html)