对于 $50\%$ 的数据，$n,k\le5000$。这一部分测试点可以递推（DP）解决。

首先可以注意到，对于任何一个序列，我们可以将其中的白色与黑色互换，得到的是一个权值与原序列相同的合法序列，因此白色与黑色的情况完全对称，不需要单独为其设计状态。

令 $f_{n,i},g_{n,i}$ 分别为长度为 $n$、权值为 $i$ 且最后一个格子分别为为黑色和灰色的合法序列的个数，则有如下递推式：

$$ \begin{aligned} f_{n,i}&=f_{n-1,i-1}+g_{n-1,i}\\g_{n,i}&=2f_{n-1,i}+g_{n-1,i}\end{aligned} $$

依以上两式可以在 $O(nk)$ 时间内计算出答案 $2f_{n,i}+g_{n,i}$。


对于 $100\%$ 的数据，我们要进一步思考。

首先，由以上递推式，有

$$g_{n-1,i}-g_{n-2,i}=2f_{n-2,i}$$

考虑 $f_{n,i}-f_{n-1,i}$，有

$$\begin{aligned} f_{n,i}-f_{n-1,i} &= f_{n-1,i-1}+g_{n-1,i}-f_{n-2,i-1}-g_{n-2,i}\\ &= f_{n-1,i-1}-f_{n-2,i-1}+2f_{n-2,i} \end{aligned}$$

即
$f_{n,i}=f_{n-1,i}+f_{n-1,i-1}-f_{n-2,i-1}+2f_{n-2,i}$

这样，我们就得到了一个 $f$ 关于自身的递推式。

令 $F_n(x)=\sum f_{n,i}x^i$，则上式等价于

$F_n(x)=(1+x)F_{n-1}(x)+(2-x)F_{n-2}(x)$

其中边界条件为 $F_0(x)=0,F_1(x)=1$。

仿照二阶线性递推数列通项公式的推导过程，我们可以猜想$F_n(x)$具有以下形式：

$F_n(x)=C_0(x)\Lambda_0(x)^n+C_1(x)\Lambda_1(x)^n$

其中 $C_0(x),C_1(x)$ 为待定幂级数，而 $\Lambda_0(x),\Lambda_1(x)$ 可由下式确定：

$$\Lambda(x)^2=(1+x)\Lambda(x)+(2-x)$$

可以得到

$$\begin{aligned}\Lambda_0(x)&=\frac{1+x+\sqrt{9-2x+x^2}}{2}\\ \Lambda_1(x)&=\frac{1+x-\sqrt{9-2x+x^2}}{2}\end{aligned}$$

并利用初始条件解出 $C_0(x),C_1(x)$，最终可以得到

$$F_n(x)=\frac{\left(\frac{1+x+\sqrt{9-2x+x^2}}{2}\right)^n-\left(\frac{1+x-\sqrt{9-2x+x^2}}{2}\right)^n}{\sqrt{9-2x+x^2}}$$

可以使用 NTT 在 $O(k\log k)$ 时间内计算 $F_n(x)$。

要计算 $g_{n,i}$，只需注意到

$$g_{n,i}-f_{n,i}=2f_{n-1,i}-f_{n-1,i-1}$$

就可以得到

$$g_{n,i}=f_{n,i}+2f_{n-1,i}-f_{n-1,i-1}$$

因此也只需计算 $F_n(x)$ 与 $F_{n-1}(x)$ 就可以计算出 $g$。


综上，我们在 $O(k\log k)$ 的时间内解决了这个问题。
