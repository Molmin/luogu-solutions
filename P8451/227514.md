# **Crosspain**
发现不强制在线，于是考虑离线 .

对这个可持久化形式的操作依赖关系建树，这样 DFS 下去统计答案，每次经过一个点的时候操作一下，然后恢复回来即可 .

这样我们就需要在线维护加字符串删字符串和查询 .

发现删和加是可以拆开的，具体的，考虑维护两个数据结构 $S_{\text{add}}$，$S_{\text{del}}$，每次加的时候加到 $S_{\text{add}}$ 里，删的时候加到 $S_{\text{del}}$ 里 .

那么查询的时候的答案就是 $S_{\text{add}}$ 的答案减去 $S_{\text{del}}$ 的答案 .

于是现在就只需要 **在线** 维护加删字符串和查询，注意到一个类似的东西是 AC 自动机，但是只能静态做 .

于是从 AC 自动机的角度考虑，有两种做法：
1. 根号重构：每 $\sqrt q$ 个串开一个 AC 自动机，攒够 $\sqrt q$ 个就新加进来一个 AC 自动机，每次询问把所有 AC 自动机的答案加起来 .
2. 二进制分组：开若干个 AC 自动机，加的时候开一个只有一个串的，每次如果有两个 AC 自动机的大小相等就合并，这样根据二进制加法器的均摊分析原理可以知道最多合并 $\log$ 次 .
   
   这种做法相当于按 $q$ 的二进制建 AC 自动机了，所以说叫二进制分组 .

做法 1 我没实现，可能会被莫名奇妙卡掉，做法 2 是 std 做法 .

时间复杂度 $O(l\log q)$，$l$ 是串长 .

（话说根分似乎也能做，但是我不是很懂）