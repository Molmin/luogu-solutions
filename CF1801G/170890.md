多模式串匹配问题，先往 AC 自动机上想。

发现询问区间是 $t$ 前缀的询问是很好做的。只需要先跑一遍匹配，记录每个位置的值 $sum$ 即可。

那么，对于其他情况 $[l,r]$，可以用 $sum_r-sum_{l-1}$ 得到一个**初步**的结果。此时跨过了 $l$ 与 $l+1$ 且结束位置 $\le r$ 的串也被统计了进来。只需要把这些串减掉即可。

考虑对于位置 $i$，分析哪些串可以跨过它。设位置 $i$ 对应到该模式串 $s$ 的位置为 $j$，$s$ 长度为 $k$，则有：

- $s_{1,j}$ 为 $t_{1,i}$ 的后缀。
- $s_{j+1,k}$ 为 $t_{i+1,n}$ 的前缀。

回顾 AC 自动机匹配的过程。若 $t_{1,i}$ 在自动机上对应的节点为 $x$，则**其在 $fail$ 树上所有祖先代表的串一定是当前前缀的后缀**。

为了应对第二种情况，需要建立反串的自动机。

$j$ 的划分形成了一种配对的关系，即 $s_{1,j}$ 在正自动机上的节点与 $s_{j+1,r}$ 在反自动机上的节点配对。询问则形如查询两个点到对应根节点的路径上配对点对的数量。

然后就是简单数据结构了。点对数不超过 $\sum|s|$，dfs 第一棵树，对第二棵做子树加，退出时撤销即可。树状数组简单维护。

但注意到还漏了一个重要条件：**跨越串的结束位置不超过** $r$。这个好办，查询时先跳到 $s_{l,r}$ 在反自动机上对应的节点即可，简单倍增一下。

可能有一些卡常，线段树不一定能过。