首先，读题。

题目的意思是寻找到一条经过的边最多的路径，并且 路上的边的路径在**按输入的顺序递增**的同时也**按边的权值递增**。

那么，这个问题不就是 有向图上的最长上升子序列 吗？

既然这样，我们先像最长上升子序列一样 dp 一下。

### 朴素 dp

考虑一个朴素的 dp，设：

$f[i][j]$ 为以点 $i$ 为终点，最后一条边的值为 $j$ 的路径，最多经过多少条边。

显然，对于一条边权为 $w$ 的有向边 $(u,v)$，可以转移：

$f[v][w] = \max \limits_{1 \leq x < w}(f[u][x]) + 1$

这个 dp 的时间复杂度和空间复杂度都是是 $O(N^2)$，显然过不了。

### 优化

我们观察这个 dp 的转移，显然可以被数据结构优化，在这里，我选择线段树。

那么我们对于每个点都开一个维护区间最大值的动态开点权值线段树，直接在线段树上互相转移。

那么，时间复杂度是 $O(n \log n)$ 的。

因为我们使用的是动态开点权值线段树，每次修改最多增加一条长度为 $\log n$ 的节点，那么空间复杂度也是 $O(n \log n)$ 的。

### 代码环节

[指针版](https://www.luogu.com.cn/paste/0hvrswpf)

[数组版](https://www.luogu.com.cn/paste/uj8jw1ge)