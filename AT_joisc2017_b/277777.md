#  港口设施
[宣传博客(小声bb)](https://www.cnblogs.com/kiritokazuto/p/16719796.html#5104700)

可能是我见的题太少，真没看出来这个题是个二分图匹配和并查集优化建图
 首先我们可以发现什么样的区间是不合法的，假如有两个集装箱，他们分别是 $[l_1,r_1]$，$[l_2,r_2]$。
 
如果 $l_1 \le l_2 \le r_1 \le r_2$ 显然两个箱子不可能同时放在一个栈里，我想出出不去，显然不行，其他情况可以证明都可以。
     
所以我们对于不合法的区间连一条边，最后跑二分图匹配，如果有 $ans$ 个二分图，证明他们是时间上互相独立的，我们显然可以任意组合，所以最终的答案就是 $2^ {ans}$。
     
考虑如何建图

首先注意我的并查集和建图是独立的，一个是维护再栈里的连边关系 ($1$ $\sim$ $2\times n$)，一个是在原图上真正建图 ($1$ $ \sim $ $n$)，所以我连边实际上就是每次只连一条，其余冗杂的都通过并查集路径压缩合并了，优化就优化在了这里。
        
我们可以维护一个假的栈，里边存放左端点，当我扫到一个左端点对应的右端点时，显然我从我左端点的下一个左端点到栈顶都和我现在的区间应该连边。

那么我如果暴力连，最终是 $n ^ {2}$ 的显然跑不过去。

我们观察可以发现，其实那一坨左端点可以看成是同一性质的点，我只需要连接一个就可以了(因为我在扫到之后的左端点对应的右端点时又会和下一个连边，最终可以达到全部联通的效果，因为我是跑 ``dfs`` 染色，只要能染上色就行，没必要连那么多边)，我这里连接的是 $(l + 1)$ 的那个点，即是我下一个左端点，但是我要同时进行并查集的路径压缩，所以其实会跳到我并查集的祖宗的。

那么我们再连完一条边之后，应该直接调到下一个性质不同的位置，我们可以考虑维护一个链表，表示下一个可以连接的不同性质的位置，直接跳就行。

注意当我们扫到对应的右端点时应将他的左端点删除，因为对于之后的来说它已经不存在了，具体实现就是将他 ``nxt`` 设置为我的栈顶，直接跳走。

这里再讲一个很多人疑惑的问题，我对于包含的会直接跳过的，不会连边， 可以结合他人代码理解一下，我就不挂了。
        
例如
        
        
![](https://cdn.luogu.com.cn/upload/image_hosting/yqjchak8.png)



我们扫到 $1,2,3$，都是左端点，放到栈里，现在 ``top`` 是 $3$。

当我扫到 $4$ 时，它对应了 $2$，那么应该是 $2, 3$ 连接，没问题。

现在 $2$ 到 $4$ 这个区间已经结束了，那么它的 ``fa`` 成为了 $tot + 1$ 即是 $4$(现在没有这个点(第四个左端点，不是时间 $4$))。

当我扫到 $5$ 的时候它对于 $2$ 会直接连接到 $2$ 并查集里的祖宗，也就是 ``tot + 1``，是空，所以它只会和 $3$ 连边。

之后自己模就行。


