考虑容斥：

答案的方案数为：
$$
\sum_{i,j=0,i+j>0}^{n}C_n^i C_n^j \times (-1)^{i+j+1}\times f(i,j)
$$
其中$i$表示至少选$i$行颜色相同，j表示至少选$j$列颜色相同，$(-1)^{i+j+1}$为容斥系数(选奇数个就加入答案，选偶数个就减去答案)。$f(i,j)$表示至少选$i$行颜色相同，$j$列颜色相同的方案数。

#### 现在我们就要考虑如何求 $f(i, j)$:

首先考虑其中**i或j有一个为0的情况**(下图中$j=0$)

![](https://cdn.luogu.com.cn/upload/pic/64324.png)

那么方案数为:
$$
3^i \times 3^{n*(n-i)}
$$
解释：其中$i$行，每行都有3种颜色可以选择，所以是$3^i$,剩下空白的块每块也有三种颜色可以选择，也就是$3^{n*(n-i)}$

若$i=0$ 时同理。

**再考虑当$i$和$j$都不为零的情况**(如下图$i=2$,$j=3$)：

![](https://cdn.luogu.com.cn/upload/pic/64326.png)

方案数为:

$$3*3^{(n-i)*(n-j)}$$


其中有颜色的块只有三种颜色可以选择，因为他们行与列之间相互制约。剩下的无颜色的块每块有三种颜色可以填，也就是 $3^{(n-i)*(n-j)}$

------

整理一下：

$$f(i,j)=\begin{cases}3^i \times 3^{n(n-i)}&j=0\\3^j \times 3^{n(n-j)}&i=0\\3\times 3^{(n-i)(n-j)}&i>0,j>0 \end{cases}$$

在得出$f(i,j)$的情况下我们根据最上面的式子计算时间复杂度是$O(n^2)$的，这个复杂度是不能接受的。

$$\sum_{i,j=0,i+j>0}^{n}C_n^i C_n^j \times (-1)^{i+j+1}\times f(i,j)$$

考虑优化。

由于$i=0$或$j=0$时的$f(i,j)$函数与众不同，所以我们考虑将它们单独拆出来算。

也就是:

$$2*\sum_{i=1}^{n}C_n^i \times (-1)^{i+1} 3^i \times 3^{n(n-i)}$$

剩下我们需要处理出:

$$\sum_{i=1}^n \sum_{j=1}^n C_n^iC_n^j 3^{(n-i)(n-j)+1} \times (-1)^{(i+j+1)}$$

化式子：

$$\sum_{i=1}^n \sum_{j=1}^n C_n^iC_n^j3^{n^2+1}\cdot 3^{-in}\cdot3^{-jn}\cdot3^{ij}\cdot(-1)^i\cdot(-1)^j\cdot(-1)$$

把能提的先提出来:

$$(-1)\cdot3^{n^2+1}\cdot\sum_{i=1}^n \sum_{j=1}^n C_n^iC_n^j 3^{-in}\cdot3^{-jn}\cdot3^{ij}\cdot(-1)^i\cdot(-1)^j$$

然后分个组：

$$(-1)\cdot3^{n^2+1}\cdot\sum_{i=1}^n C_n^i3^{-in}\cdot(-1)^i\sum_{j=1}^n C_n^j \cdot3^{-jn}\cdot(-1)^j\cdot3^{ij}$$

发现如果没有这个$3^{ij}$就可以$O(nlogn)$求出了，所以瓶颈在于这个$3^{ij}$里。我们需要把它化进一个式子里求，我们合并右边：

$$(-1)\cdot3^{n^2+1}\cdot\sum_{i=1}^n C_n^i3^{-in}\cdot(-1)^i\sum_{j=1}^n C_n^j (-3^{-n+i})^j$$

根据二项式定理:

$$(a+b)^n=\sum_{i=0}^nC_n^ia^ib^{n-i}$$

我们这里把$a=1$,$b=(-3^{-n+i})$代入：

$$(1+(-3^{-n+i}))^n=\sum_{i=0}^nC_n^i 1^i(-3^{-n+i})^{n-i}$$

原式$j$是从$1$开始的，所以我们只需减去$j=0$时候的值即可，所以式子被我们化成了这样:

$$(-1)\cdot3^{n^2+1}\cdot\sum_{i=1}^n C_n^i3^{-in}\cdot(-1)^i\cdot[(1-3^{-n+i})^n-1]$$

使用快速幂，时间复杂度$O(nlogn)$

**注意**：由于常数较大，建议先预处理出3的各个幂，以及$3^n$的各个幂。