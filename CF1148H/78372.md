明示扫描线扫右端点，考虑由区间 mex 的做法（加入 $x$ 将 $\mathrm{mex}=x$ 的区间暴力分裂）拓展，问题转化为：每次将同色区间做覆盖，求区间内历史出现了多少次 $k$。

对每个 $k$ 分别维护，发现贡献是形如「时间 $[l,r]$，位置 $[L,R]$ 都产生 $1$ 的贡献」的矩形。利用扫描线的性质，将矩形差分为 3-side，此时每个点的贡献为一次函数。

主席树维护，时间复杂度 $O(n \log n)$。[Code](https://codeforces.com/contest/1148/submission/156410498)

