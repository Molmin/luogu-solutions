简要题意：有 $k$ 个盒子，每个盒子里有一些数；你要从每个盒子里取出一个数，然后可以将它们放进另一些盒子里（每个盒子里最多只能放回去一个数）。问能不能一次操作之后让所有盒子里的数的和相等。

如果所有数的和不是 $k$ 的倍数，显然不行。

否则求出相等的时候每个盒子里的数的和应该是多少。

对于盒子里的每一个数，如果拿出去的是这个数，那么满足要求拿进来的数只有一个。

这样我们就可以建出一个有向图，每个点指向替换它的那个数。

题目求得是一个合法的置换，置换可以拆成若干个轮换；所以我们把建出的有向图里的所有环找出来。

对于一个环，如果上面有两个在同一个盒子里的数，直接扔掉不管。

对于剩下的环，处理环上有哪些盒子里的数，压进 $S$ 里。

显然，我们要选出若干个环，这些环上的数所属的盒子两两不同，并且每个盒子中都有数在这些环上。

可以状压 $\text{DP}$ 做，复杂度 $O(n+2^k)$。