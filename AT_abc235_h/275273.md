为啥洛谷唯一一篇题解那么长啊![](//图.tk/5)。其实没这么复杂的吧。

考虑边权从小到大排序后建 Kruskal 重构树。那么每次操作相当于，选择一个点，把它子树内的叶子全部染色。注意因为边权相等的边的存在，这里建树要把边权相等的边放一起考虑，建的树也可能不是二叉树。

考虑**把选点的方案一一对应到最终被染色的叶子集合**。不难发现只需要限制：

- 选的点不能存在祖先 - 后代关系；
- 一个点的所有儿子不能同时被选。

考虑树形 dp，设 $f_{u, i, 0/1}$ 表示 $u$ 子树内进行了 $i$ 次操作，**目前**儿子有或没有同时被选，且 $u$ **不被选**的方案数。添加儿子 $v$ 时把 $f_{v, j, 1}$ 暴力树形背包合并进来即可。注意因为 $f_{v, j, 1}$ 规定了 $v$ 不被选，所以还要考虑选 $v$ 的情况。

时间复杂度 $O(m \log n + nk)$。

[code](https://atcoder.jp/contests/abc235/submissions/42769795)