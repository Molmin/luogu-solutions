当树是条链时，询问即为区间顺序对数，所以这道题肯定是根号题。

我们考虑把这个问题转化为树上链查询，建出询问点集的虚树 $T$，设虚树根为 $rt$，答案即为 $\sum\limits_{u\in leaf(T)}f(rt,u)-\sum\limits_{u\in T\land u\notin leaf(T)}(s_u-1) f(rt,u)$，其中 $leaf(T)$ 表示虚树的所有叶子，$s_u$ 表示 $u$ 的儿子数，$f(a,b)$ 表示 $a$ 到 $b$ 这条链的答案，这样拆分后总询问数不会超过 $\sum (2t_i-1)$，且每个询问内两点都是祖先关系

下文中的 $m$ 均指拆分后的询问数。

由于询问数较多，所以我们考虑 $O(n\sqrt m)$ 的莫队算法，显然是要莫队二离的。先树分块，分块大小 $B=O(\frac n{\sqrt m})$，最好用 Top Cluster。

先考虑不在同一块内的询问，我们把询问按照上端点所在的块分类，把上端点在同一块内的询问按照下端点排序，直接在树上跑莫队。发现移动的时候的贡献是一个上下的路径中有多少个权值大于/小于 $a_i$，按照莫队二离的套路进行差分后要求的就是根到 $j$ 的路径上有多少个权值大于/小于 $a_i$，和普通莫队二离一样扫描线，就是 dfs 一遍，顺便用分块维护根到当前点路径上的边的权值。

对于在同一块内的询问，我们发现路径长度是 $O(B)$ 级别的，直接在上面说的 dfs 的时候顺便求出答案就好。

讲得可能不是很清楚，但你如果会莫队二离和树分块应该能看懂，要代码的可以私信我。