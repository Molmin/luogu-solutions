$K \leq 17$ 显然是要我状压了。最小值最大可以二分，那么 check 就得是 dp 了，但是一开始写出来的是 $n2^k k^2 $ 的垃圾 dp ，dp 的状态是记录当前已经满足要求的字母，最后一个字母是啥，然后 dp 值是最后一个字母的连续段长度，这样每次枚举下一个位置填啥，大概不如直接爆搜。

二分长度 $len$，check 具有一点贪心性质。考虑全都是问号的串，显然我们会充分利用，在前边每 $len$ 个放一种字母。但是现在有一些位置已经放了字母，有些位置可能无法满足放一个长度为 $len$ 的某种字母的串。实际上我们可以延续贪心的做法，假设我就要从这个位置开始填一种字母，那么我们可以找出它最少得填到哪才行，中间多出来的部分就废掉。

那么 dp 就有一个轮廓了，我们状压当前已经满足条件的字符的集合，dp 值为达到当前状态至少要填完长度为多少的前缀，枚举下一个填哪种字母转移，实际上就是枚举了我们贪心填每种字母的顺序，正确性是比较显然的。转移可以预处理出 $Minr_{i,c}$ 表示从第 $i$ 个位置开始填第 $c$ 种字母，至少需要填到什么位置才出现长度为 $len$ 的连续段，倒序枚举一遍即可，如果从 $i$ 开始的恰好为 $len$ 的段恰好能填那么就是 $i+len-1$，否则直接继承下一个位置的值即可。check 的复杂度为 $O(nk+k2^k)$，外层再套一个二分。