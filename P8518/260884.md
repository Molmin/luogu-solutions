- 以下是[第二个版本的博客](https://www.luogu.com.cn/paste/9ywvtwup)，现在是第三个版本。
- 感谢[0htoAi](https://www.luogu.com.cn/user/335366)，[gzw2005](https://www.luogu.com.cn/user/53118)和[Pozhu](https://www.luogu.com.cn/user/581564)，祝愿其信息学之路光明璀璨。
- 感谢 UOJ 的高人，他们的实现简洁而精妙，让我学到了很多，如果我有机会，一定要感谢他们。
- 如果我有机会，一定要写篇题解讲代老师的分块做法。
- 作者已经退役，因为[这件事](https://www.luogu.com.cn/discuss/475189)挨批，然后又得重写一遍博客，心情还是有点难受的。
- 不过，心中真正有光明的人，即使仰望茫茫宇宙，意识到自己生活的一切痕迹都将被抹去，不解自己为何被离弃，也会安然坦然地走下去。
- 我极喜欢张晓风的那句“我在”：
```
	《旧约·创世纪》里，堕落后的亚当在凉风乍至的伊甸园把自己藏匿起来。上帝说：“亚当，你在哪里？”
	他噤而不答。
	如果是我，我会走出，说：“上帝，我在，我在这里，请你看着我，我在这里。不比一个凡人好，也不比一个凡人坏，我有我的逊顺祥和，也有我的叛逆凶戾，我在我无限的求真求美的梦里，也在我脆弱不堪一击的人性里。上帝啊，俯察我，我在这里。”
```
- 同样，尽管退役，我依然在这里。


**题意**
- [题目链接](https://uoj.ac/problem/660)。
- 长为 $n$ 的数列 $a_i$，与一个恒定的数列 $c_i$，支持区间加操作，但是每次操作之后，所有 $a_i$ 与 $0$ 取较大值，与 $c_i$ 取较小值，要求在所有操作之后输出 $a_i$。

**分析**
- “在所有操作之后输出结果”是经典的离线问题，有这句话几乎意味着在线不可做，与这个类似的还有[rprmq](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/post-kai-bai-ji-hua-1-ren-pin-ran-mei-qu)，[这篇例题 3](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/post-ji-chu-you-hua-fen-kuai)等一系列神秘题目。
- 把时间维度与数列下标维度交换（如果您不了解这个技巧，可以参照上面的第二道例题）（具体而言：我们打算对于每个元素 $a_i$，用数据结构维护对应的操作序列，那么只需要 $O(q)$ 次增加或删除“修改操作”的操作），我们得到了一个问题：给定（对于一个单独元素的）操作序列，求最后的结果。
- 由于原来的问题不太好思考，可以尝试去掉上界思考：
![](https://cdn.luogu.com.cn/upload/image_hosting/e2jrxe41.png)
- 因此，如果去掉上界，我们只需要在线段树上二分找到最小的前缀和，如果大于等于零，对 $0$ 取 $\max$ 没有发生，否则操作序列的后缀和就是答案。
- 接下来，考虑上界 $c_i$：
![](https://cdn.luogu.com.cn/upload/image_hosting/31swz6ci.png)
- 如果找到左端点最右的一段区间满足这个条件，那么它一定是成功对 $0$ 取 $\max$ 和对 $c_i$ 取 $\min$ 两者交替（或者在它的后面一段），而在这之后的的区间只会出现其中一种情况，这种情况只需要再次取操作序列的极值即可。

**代码实现**
- 利用区间前缀最大值，前缀最小值和区间和这三个变量可以表示一切（注意两者相减就是绝对值最大子段和）。
- 我们需要找到最右的，绝对值大于 $c$ 的区间的左端点，在线段树上，二分的同时维护后缀信息，容易在 $O(\log q)$ 的时间内查询得到结果。
- 找到最右的左端点之后，可以利用该点的正负说明这个操作是上面四种情况的哪一种（触底后碰顶，碰顶后触底，触底后半段，碰顶后半段），然后找到极值点，再判断要不要清 $0$，最终的代码是简短的，[代码](https://www.luogu.com.cn/paste/njzmvld2)。