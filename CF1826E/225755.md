首先考虑一个暴力 dp，设 $dp_{i,j}$ 表示选了 $i$ 个 model，上一个选的编号为 $j$，那么枚举状态并转移是 $O(n^2m^2)$ 的。

我们从这个暴力中得到启发，能转移到某个 $j$ 的所有点 $x$ 必须满足的是所有城市中，$x$ 的 rating 都小于 $j$，也就是构成了偏序关系。如果我们以这些偏序关系建图，会得到一个 DAG，直接在这上面跑 dp 的话，时间复杂度就降为 $O(n^2)$。

那么剩下的问题是如何求出所有偏序关系。我们对每个城市的 rating 排序，从后往前扫一次并维护一下每个点能到哪些点，这样做是 $O(n^2m)$ 的，使用 bitset 优化这个维护的过程就能做到 $O\left(\dfrac{n^2m}{w}\right)$ 了。

[代码](https://codeforces.com/contest/1826/submission/204619145)。