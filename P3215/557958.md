[题目传送门](https://www.luogu.com.cn/problem/P3215)

[更好的阅读体验](https://www.luogu.com.cn/blog/d-a-n-n-y-1-0-1/solution-p3215)

#### 题目大意：

维护一段括号序列，要求支持：

- 区间赋值

- 区间翻转

- 区间取反

- 查询区间要变成合法括号序列的最少次数

#### 大致思路：

明显的 `FHQ Treap`。

前两种操作是基本操作，不再赘述。

先考虑查询：

对于一串不合法的括号序列，如 $()))((())()$，将合法的部分消掉得 $))($，发现一定是 $\underbrace{)))\dots)}_{k\text{个右括号}}\underbrace{(((\dots(}_{\kern0.5eml\text{个左括号}}$ 这样的形式。

于是，为了方便操作，记 `(` 为 $-1$，`)` 为 $1$。

记录转换后的数组的前缀最大值（记为 $pmax$）和后缀最小值（记为 $smin$），那么最后不合法的序列就是 $pmax$ 个右括号和 $smin$ 个左括号，最少操作次数就为 $\bigg\lceil\dfrac{pmax}{2}\bigg\rceil+\left\lceil-\dfrac{smin}{2}\right\rceil$。

再来考虑第三个修改操作：

将区间取反后，所有的 $1$ 都变成 $-1$，所有的 $-1$ 都变成 $1$，相当于直接变成相反数。因此，进行以下修改：

- 将当前节点的权值变为它的相反数

- 将当前节点的前、后缀最大最小值变为它的相反数

- 将当前节点的赋值懒标记变为它的相反数

- 交换最小值和最大值

还是比较麻烦的。

最后，还有一点要注意：因为有翻转操作，除了前缀最大值和后缀最小值外，还要维护前缀最小值和后缀最大值。

代码就不贴啦~