### 题意简述

已知一张 $n$ 个点，$m$ 条边的简单有向图，求出该图的所有哈密尔顿回路。

$n \leq 50$，哈密尔顿回路数量非零并小于 $10^4$，数据随机生成。

---

### 题解

要解决一个 NPC 问题，最好的方法是：把它转化为另一个 NPC 问题。

精确覆盖问题也是一个 NPC 问题，但是舞蹈链算法（DLX）可以高效地求解这个问题。参考 DLX 的[模板题](https://www.luogu.com.cn/problem/P4929)，这个算法能够解决 $N, M \leq 500$ 的数据。

---

哈密尔顿回路可以被转化为精确覆盖问题。

哈密尔顿回路要求选择一些有向边，使得每个点的入度和出度都恰好为 $1$。

精确覆盖问题要求选择一些集合，使得这些集合两两不交，且并集恰好是集合 $S$。

所以，令集合 $S := \{in_1, in_2, \cdots, in_n, out_1, out_2, \cdots, out_n\}$，表示每个点的入度和出度都恰好为 $1$。每条有向边 $u \to v$ 对应集合 $\{out_u, in_v\}$。要求选择一些边，使得这些边对应的集合两两不交，且并集恰好为 $S$。

---

上面的转化存在一个问题：只考虑每个点的入度和出度，形成的路径可能是若干个回路的并。

因为所有的排列有 $n!$ 个，对应恰好一个环的排列有 $(n-1)!$ 个，所以不合法的解大约是合法解的 $n$ 倍。因为 $n$ 很小，所以对复杂度的影响不大。

所以，用 DLX 算法求出以上精确覆盖问题的所有解。对于每个解，验证它是否对应原图中的一条哈密尔顿回路。

时间复杂度：不会证明，但是 $\mathcal{O}(\text{可过})$。

期望得分：$100$ 分。
