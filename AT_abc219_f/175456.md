设 $n$ 表示 $S$ 的长度，首先按照 $S$ 进行一次模拟，即得到 $(0, 0) \to (x_1, y_1) \to (x_2, y_2) \to \cdots \to (x_n, y_n)$。

设 $a = x_n, b = y_n$，并设 $P_i$ 记录第 $i$ 次操作经过的点集。

> $P_1 = \{(0, 0), (x_1, y_1), \cdots, (x_n, y_n)\}$

容易发现之后每一次经过的点集都是 $P_1$ 中的点偏移若干个 $(a, b)$，即：

> $P_i = \{(0 + (i - 1)a, 0 + (i - 1)b), (x_1 + (i - 1)a, y_1 + (i - 1)b), \cdots, (x_n + (i - 1)a, y_n + (i - 1)b)\}$

答案就是求 $|P_1 \cup P_2 \cup \cdots \cup P_n |$。

将 $P_1$ 中的点集扔到二维平面上，发现会重复的点都在某条斜率为 $\dfrac{b}{a}$ 的直线上。取出该直线上的两个点 $(x_i, y_i), (x_j, y_j)$ 满足 $x_i \bmod a = x_j \bmod a$。它们中的一个在 $|\dfrac{x_j - x_i}{a}|$ 次操作后会被第二次访问到，也就是说，它们对答案的贡献为 $\min(|\dfrac{x_j - x_i}{a}|, K)$。

所以做法就是找到每一条直线，对于其上 $x \bmod a$ 相同的点对计算贡献。

具体实现时有些细节：

- 如果 $a=b=0$，直接输出 $|P_1|$。

- 如果 $a=0$，交换两维。

- 如果 $a \lt 0$，取反所有的 $x$。

最后用 `map` 存下每条直线即可。

时间复杂度 $O(n \log n)$。