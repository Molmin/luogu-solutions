
首先条件有多余的，因为同色只会有一个连通块。

考虑在这个连通块的最高点上打一个标记，可以转换为给定一棵树，打 $k-1$ 个标记（注意根必然有标记）情况下的贡献和。

如果 $i$ 处打标记，则额外贡献的为其父亲的权值。

每个父亲最多贡献 $\deg (i)-1$ 次。

第 $i$ 个点复制 $\deg(i)-1$ 次，排个序，前 $k$ 项之和加上基础贡献即为答案，复杂度 $\mathcal O(n\log n)$