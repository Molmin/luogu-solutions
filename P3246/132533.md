比较考技巧与性质的一道莫队题。

不开 O2 根本怎么卡常都过不了，有可能是 ST 表也有常数吧。         

我们考虑用莫队转移区间 $[l , r]$ 至区间 $[l , r + 1]$ ，增加的量即固定下来的右端点到 $l$ 所产生的所有子序列贡献的答案。            

我们考虑维护一个前缀 $Sum_i$ 表示 $[1 , i] , [2 , i] ……[i , i]$ 的答案，考虑如何 $O(n)$ 递推。           

我们找到前面第一个比 $a_i$ 小的数，其位置记为 $pos$ ，那么 $[pos + 1 , i]$ 中没有一个数比 $a_i$ 小，而 $[pos - 1 , i] , [pos - 2 , i] …… [1 , i]$ 中的最小值也一定产生在 $pos$ 之前，令 $val(l , r)$ 为一个区间的答案，那么   

$val([pos , pos]) = val([pos , i]) , val([pos - 1 , pos]) = val([pos - 1 , i]) …… val([1 , pos]) = val([1 , i])$         

即这一部分的贡献等价于 $Sum_p$ ，所以递推式就出来了：         

$Sum_i = Sum_p + (i - pos) \times a_i$               

接着我们倒着把后缀也做一遍类似的操作，记为 $Suf_i$ 。这是为了处理左端点移动时的贡献计算，其实就是把右端点的操作对称一下就好了。                   

之后我们在莫队转移时再换一种方法计算贡献，还是以 $[l , r] -> [l , r + 1]$ 举例。               

我们先找到区间 $[l , r]$ 内最小值对应的点，记为 $P$ ，那么 $[l \sim P , r]$ 的区间贡献就可以 $O(1)$ 算了。            

接着我们考虑 $[P + 1 \sim  r , r]$ 的贡献如何计算，考虑使用我们预处理出来的前缀 $Sum$ 。       

我们知道 $a[P] < min_{i = P + 1} ^ r a[i]$ ，所以如果对于一个左端点不固定的区间 $[ll , r]$ 而言，如果 $ll <= P$ ，那么这个区间的最小值就又不在 $[P + 1 , r]$ 之间了。         

换句话说这些区间的答案又可以和 $[ll , P]$ 等价了，而我们要做的不就是只要 $[P + 1 \sim r , r]$ 这些区间的贡献吗？那么直接用 $Sum_r - Sum_P$ 就好了。            

对于左端点移动的情况就全部反过来就好了。       

关于找最小点和最近的一个比它小的点，前一个我们直接用 ST 表预处理，后一个二分或单调栈都可以做。    

最后时间复杂度 $O(n \log n + n \sqrt n)$ 不知道为什么把莫队卡了，得开 O2 才能过。          

建议 ST 表卡一下 Cache 。