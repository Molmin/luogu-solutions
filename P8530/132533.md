**P8530 sol**

原问题看起来很不弱于三维数点，所以采用二维扫描线看看退化一维的问题。

即我们将在 $[l_1,r_1]$ 的点拿出来，按照 $p_i$ 大小从小到大排序，看起来就是个二维单权颜色数，设 $lst_i$ 表示位置为 $p_i$ 的数前一个（$p_i$ 序排序）颜色相同的数是谁（也用 $p_i$ 作为键值），那么等价于 $l_2 \leq p_i \leq r_2,lst_{p_i} < l_2$ 的二维数点。

问题变得明确：使用不添加莫队代替二维扫描线，可以线性维护所有的 $(p_i,lst_{p_i})$，在回滚时我们删除一个点，就直接从链表里拿出来更改前后相邻信息即可。

问题变成了 $O(n \sqrt m)$ 单点加 $O(q)$ 矩形查询，容易发现所有加入的单点中除了 $lst_{p_i} = 0$ 的所有点坐标都是在两个维上互相不重复的，对于 $lst_{p_i} = 0$ 的单独维护一个一维分块，对于其它点用二维分块，时间复杂度即可平衡到 $O(n \sqrt m)$。

注意时限，卡常。自己~~贺~~的时候因为乱开数组空间每次莫队清空了一个 $10 ^ 6$ 的数组，蚌。

