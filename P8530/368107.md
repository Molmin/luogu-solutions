[$\tt Link$](/problem/P7721)

题意：二维带权数颜色。

## 一维问题

一维数颜色的常见做法是：维护每个颜色的上一个与其颜色相同的位置 $pre$，然后问题转化为区间 $[l,r]$ 中 $pre$ 值小于 $l$ 的数的个数。

因为带权，所以你不得不把这个问题写成二维数点的形式：有 $n$ 个点 $(i,pre_i)$，点有点权。现在你要求 $[l,r][0,l)$ 这个矩阵的权值和。

二维数点用二维分块，没做过可以去写 [$\tt rdiq$](/problem/P7448)。这里的 $pre$ 有着这样的性质：除了有多个位置 $pre_i=0$ 之外其余 $pre$ 互不相等。于是对于 $pre_i=0$ 的情况，写一个一维分块维护。

## 二维问题

二维不好直接做，因为你没有一种合适的顺序维护 $pre$，考虑转化为动态的一维问题。

但是结合 *特殊性质 A* 来想：如果你询问的 $l_1=1,r_1=n$ 会怎样呢？这时我们可以直接把每个点的 $y$ 坐标升序排列，变成一个序列，然后构建 $pre$。

考虑借助莫队这种类似扫描线的东西，把原问题从静态变成动态：我们在 $x$ 轴上莫队，然后对所有在莫队里的点，按 $y$ 坐标从小到大构建 $pre$，转成一维问题。考虑莫队的转移：

+ 插入：因为要保证 $y$ 坐标升序，所以很难做到好的复杂度。
+ 删除：维护 $pre$ 的逆数组 $nxt$，然后用类似链表的写法一通乱搞即可。

删除容易插入难？考虑把莫队回滚，变成不插入莫队。常见的回滚是通过改变指针轨迹做到不删除，这里要求少插入，于是你把不删除莫队的轨迹倒过来即可。

## 代码

[$\tt Code$](https://www.luogu.com.cn/paste/unvfvncb)