### **颜色段怎么能没有珂朵莉？这是一篇在后缀树组上树剖套珂朵莉的题解。**

由于鄙人不会 $\text{SAM}$ 后缀树都是用后缀数组建的。

想想本质不同子串的做法是什么。

有两种做法，第一种容斥，第二种就是树的大小。

考虑第二种。

先对于字符串建出后缀树！

这种形式的询问肯定考虑离线扫描线啊！

那么从左往右扫还是从右往左扫捏？

是从右往左扫哒。

感性思考一下就是左到右加入的是一个字符，右到左加入的是一整个后缀。

现在左端点固定，我们要得到任意右端点的答案。$($ 扫描线的思考方式 $)$

我们考虑新加入一个后缀，它可能造成的贡献范围就是这个后缀开始的叶子到根的路径，如果右端点是 $n$ 的话，这条路径的所有点都会造成贡献，可以看成这条路径被它染了个色，如果右端点是 $n-1$ 的话，这条路径除了叶子的其他点都被它染色了。

那一次询问的答案就是所有被染色点的个数和。

但是一个点可能会被染成多种颜色，但是可以发现它被染的最后一种颜色的优先度大于其他颜色，那这个怎么证明呢，就是考虑右端点左移，就相当于一个从叶子到根褪色的过程，而从右往左扫每次加入的一个后缀的深度是比之前的所有后缀要深的，所以它染得点一定是相较别的颜色褪色最晚的。

然后一种颜色做的贡献实际上是一个一次函数，这个可以用树状数组维护一个常数项和一次项来做，具体来说就是一个长度为 $len$ 的颜色，当右端点距离 $n$ 为 $k$ 时，贡献就是 $len-k$。 

那我们插入一个后缀我们就要把它从叶子到根的路径所有颜色都染成它的颜色，这个东西我们树剖，把它变成序列问题，一种颜色就会染 $\log n$ 条树链。每次染色就用珂朵莉推平顺便维护颜色长度，单次查询用树状数组。

复杂度 $O(n \log^2 n +m \log n)$。

[code](https://www.luogu.com.cn/paste/859m2an0)