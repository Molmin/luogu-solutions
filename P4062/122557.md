
[P4062 Yazid 的新生舞会](https://www.luogu.com.cn/problem/P4062)

> 给定一长度为$n$的序列，求有多少子序列$[l,r]$的众数出现$\frac{r-l+1}{2}$次

- 算法一（针对$n\leq 300$）

考虑枚举所有区间，然后求其众数及出现次数，并判断是否超过区间总长的一半，统计答案即可。时间复杂度$O\left( n^3\right)$

- 算法二（$n\leq 2,000$）

考虑先枚举区间的左端点$l$，再从左到右枚举右端点$r$并用数组维护每个数的出现次数，同时使用变量维护当前众数、众数的出现次数。不难发现，当右端点向右移动时，这些信息都是非常方便维护的。于是我们便可以在$O\left( n^2\right)$的时间复杂度内统计所有答案。

- 算法三（$type=1$）

对于$01$序列，我们不难发现，众数出现次数严格大于子区间长度当且仅当子区间内$0,1$出现次数不同（那么那个出现次数较多的就是众数）。于是我们将原序列中的$0$视作$-1$，并对该序列求前缀和$S$，则子区间$[l,r]$为“新生舞会的”，当且仅当$S_r-S_{l-1}\not= 0$

有了这个性质我们就可以$O(1)$来求解子区间$[l,r]$是不是符合要求了，但是不幸的是这样仍需要枚举$l,r$，复杂度仍是$O(n^2)$。

我们不妨**反着来想**，子区间$[l,r]$**不是**“新生舞会的”，当且仅当$S_r-S_{l-1}=0$即$S_r=S_{l-1}$因此对$S$进行排序并从小到大统计相等的个数然后用总的子区间数量$\frac{n\cdot(n+1)}{2}$减去相等的个数即为答案

- 算法四（$type=2$）

对于所有数的出现次数都较小（不超过$15$）的情况，不难发现所有“新生舞会的区间”的长度也会较小（不超过$2\times 15-1=29$）。于是使用算法二，枚举所有长度少于$30$的区间并统计答案即可。

- 算法五（$type=3$）

对于$A_i\leq 7$的测试点，我们不妨枚举所有值作为众数的情况。考虑统计所有众数为$k$的“新生舞会的”区间，将所有等于$k$的位置取为$1$，不等于$k$的位置取为$-1$，得到新序列$B$并求前缀和得到序列$S$，则区间$[l,r]$需要被统计，当且仅当$S_r-S_{l-1}\geq 1$。从左到右枚举右端点，并用线段树维护当前右端点左边每种前缀和出现的次数即可。时间复杂度$O\left( 8nlogn\right)$

- 算法六（$100pts$）

考虑改进算法五。我们考虑取出所有$B$中的极长$-1$子区间，观察这些区间中的所有点作为右端点对答案的贡献。不难发现极长$-1$子区间$[l,r]$中的所有点作为右端点对答案的贡献为$\sum_{i=1}^{r-l+1}\sum_{j=-\infty}^{S_{l-1}-i-1}cnt[j]$，其中$cnt[j]$表示在区间$[0,l-1]$之间前缀和为$j$的端点数目；在统计这段区间的答案后，我们还需要对区间$[S_{i-1}-(r-l+1),S_{i-1}-1]$中的所有$cnt$均进行$+1$操作。显然地，我们使用一个维护$B_i$和$C_i=i\times B_i$的线段树就可以支持这些查询、修改操作。于是我们使用这棵线段树维护相关信息，并从左到右枚举右端点，统计答案即可。

不难发现，极长$-1$子区间的数目与序列中$k$的数目同阶，因此，对于统计众数为$k$的“新生舞会的”区间的时间开销，不难发现我们通过上述优化将时间开销缩短到了$O\left( number_k\log{n}\right)$

于是，总时间复杂度即为$O\left(\sum_{k} number_k\log{n}\right)$，即$O\left(n\log{n}\right)$。