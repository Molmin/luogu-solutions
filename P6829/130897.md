蒟蒻以前听 **正入IOI**（懂得都懂）的网课，讲这个题，当时完全听不懂，然后昨天一时兴起，就做了这个题，一下午想了 3h，觉得这一路思考的过程是很值得写一写的，于是就写了这篇题解.

大致的思维历程是按照子任务的顺序进行的.

- 子任务 1（保证 $k=2$）：

考虑此时的 $r_i$，本质上相当于我们知道相邻的两项植物之间的高度大小关系.

手玩样例，猜想如果 $x$ 和 $y$ 之间有一条大于号组成的链，或者小于号组成的链，那就能够比较出 $x$ 和 $y$ 之间的大小关系；否则，二者的大小关系就不能够确定.

考虑到该子任务的分值仅有 5 分，可以认为该猜想是正确的；证明留待以后说明.

- 子任务 2（保证 $n\leq5\times10^3$ 且 $2k>n$）：

咳咳，因为个人习惯，以下叙述中所有的编号都从 $1$ 开始，到 $n$ 结束.

如果我们再特殊化这个条件，变为 $k=n$，那么相当于每个植物都和所有其他的植物作过比较了，这时，例如说对于 $r_i=0$，那么 $i$ 的高度就是 $n$；对于 $r_i=1$，那么 $i$ 的高度就是 $n-1$，以此类推.

那么当 $k$ 稍微更小一点的时候，有什么样类似的好的性质呢？

对于任意两个植物，$u$ 和 $v$，要么 $u$ 的 $k-1$ 个后继中包含了 $v$，要么 $v$ 的 $k-1$ 个后继中包含了 $u$，当然也有可能互相包含.

遇到这种还原排列的问题，可以考虑最值；设 $i$ 这株植物的高度为 $n$，那么显然有 $r_i=0$，而且由于对于任意一株其他植物，二者都能相互够到，所以如果还存在其他的植物 $j$，满足 $r_j=0$，那么就说明，$j$ 一定是 $i$ 的 $k-1$ 个后继之一（以下简称后继集），而且一定不是 $i$ 的 $k-1$ 个前驱之一（以下简称前驱集）.

我们找到一株植物 $u$，满足 $u$ 的 $k-1$ 个前驱中，没有任何一个植物的 $r$ 值为 $0$，那么，这样的植物就是唯一的，所以说，我们能够确定下来，$h_u=n$，其中 $h$ 表示植物的高度.

在确定下来 $h_u=n$ 之后，将 $u$ 的 $k-1$ 个前驱的 $r$ 值都 $-1$，然后将 $u$ 这个植物从环上删掉；这样，就递归到了 $n-1$ 的情况，继续去找 $h=n-1$ 的植物.

如此递归下去，最终我们能够唯一确定出所有植物的高度，继而也就不难回答询问了.

顺便提一嘴：这道题在 IOI 当场的平均分只有 14.54，所以如果能独立实现到这里，就已经超过平均分了哦 qwq.

- 子任务 3（保证 $2k>n$）：

在刚才的递归过程中，每步朴素地遍历环去找 $k-1$ 个前驱中没有 $r=0$ 的植物的植物，时间复杂度是 $\mathcal{O}(n^2)$ 的，考虑使用数据结构优化这个过程.

不难发现，其实我们每次只要找一个，$r=0$ 的前驱离 ta 最远的植物就可以了，因为一定存在唯一的一株植物，所以一定是前驱最远的那株植物.

上面那句话的意思是这样的：需要维护一个集合 $S$，$S$ 中包含有所有(目前) $r_i=0$ 的植物 $i$，并且还维护了所有这样的植物，在 $S$ 中的最近前驱，和 ta 之间的距离.

支持的操作有三种：加入一株 $r_i=0$ 的植物，删除一株 $r_i=0$ 的植物，取出最近前驱最远的那株植物的位置.

通过断环成链，断成一条长度为 $3n$ 的链，再维护一个辅助集合，每次插入/删除，就将 $u-n,u,u+n$ 三个点一起插入/删除辅助集合，这两个集合都可以直接应用 $\texttt{STL Set}$，很方便地维护在环上的前驱/后继的位置.

需要特判目前 $S$ 为 $\varnothing$ 的情况；这样，剩下的问题就是，如何找到(目前) $r_i=0$ 的新植物.

本质上来说，我们需要维护一个序列，支持单点修改、区间 $-1$、查找任意一个 $0$ 的位置.

显然，使用线段树，维护区间最小值、最靠左的区间最小值位置，可以符合上述的需求.

这样，通过多个 log 数据结构的配合，可以在 $\mathcal{O}(n\log n)$ 的时间内，唯一确定出所有植物的高度.

- 子任务 4（保证每次 ```compare_plants``` 调用的正确答案是 $\pm1$）.

每次调用的正确答案是 $\pm1$，这一点其实并没有保证任何排列的特殊性质，只是说明了回答询问的时候，有些情况是不需要考虑的而已.

那么，忽略掉什么样的情况，对于我们解题而言是有帮助的？

比如说我们能够判断出 $+1$ 是不可能的，说明答案是 $-1$，但这样是没有用的，因为即使没有这条性质，我们也能够这样去判断；所以好用的应该是这样的表述：如果 $+1$ 是有可能的，说明答案是 $+1$.

什么叫做 $+1$ 是有可能的，也就是说，对于询问调用到的一对 $(x,y)$，如果存在一种可能的排列，使得 $x>y$，那么就说明在所有可能的排列中都有 $x>y$，正确答案也就是 $+1$.

沿袭子任务 3 的思想，考虑在 $2k\leq n$ 的情况下，能够仍能够快速构造出一组合法的高度序列.

我们在子任务 3 中，构造合法的高度序列，是如何应用 $2k>n$ 的性质的；就在于说，例如我们想要确定哪个 $h_i=n$，我们知道按照前驱去找 $0$，找一个 $k-1$ 个前驱中，每个前驱要么非 $0$，要么已经被删掉的植物，这种植物一定是唯一的，进而符合这种条件的植物，一定有 $h_i=n$.

那么在 $2k\leq n$ 的时候，符合 $r_i=0$、且 $k-1$ 个前驱中，每个前驱要么非 $0$，要么已经被删掉，这些条件都符合的植物，不一定是唯一的，这时我们还如何恰当地选择这些植物之一，让这株植物的 $h_i=n$，使得在之后的构造中不出现矛盾呢？

考虑这样的想法：既然不唯一，那么就随便选择一个.

算法实现上，我们直接无视掉是否 $2k\leq n$，沿袭子任务 3 中的构造方法去构造，并据此回答所有的询问；考虑为什么这样的做法是正确的.

对于任意两个植物 $u$ 和 $v$，在构造的过程中，ta 们都分别经历以下三个阶段：第一个阶段，$u$ 在线段树中被确立为 $r_u=0$、并且因此被加入集合中维护；第二个阶段，$u$ 因为不符合前驱的条件，在集合中等待；第三个阶段，$u$ 被从集合中去除，确立 $h_u$ 为目前剩下的高度中的最大值.

故而，$h_u>h_v$ 当且仅当，$u$ 进入第三个阶段的时间，早于 $v$ 进入第三个阶段的时间.

是什么影响着 $u$ 进入第三个阶段的时间？如果说，$v$ 的进入第三个阶段，改变了 $u$ 的 $r$ 值，显然 $h_u>h_v$ 是不可能做到的，类似地，如果说，$v$ 的进入第二个阶段，成为了阻碍 $u$ 的，$u$ 的 $k-1$ 个前驱之一，那么 $h_u>h_v$，就也是不可能做到的.

不难发现，上述的过程中要求 $u,v$ 之间存在前驱、后继的关系，而且，囊括了一切当 $u,v$ 之间存在前驱、后继的关系时，$h_u>h_v$ 的条件，和 $h_u<h_v$ 的条件.

故而，我们会发现，只要我们构造出了一个合法的高度序列，那么对于任何两个相距不超过 $k-1$ 个植物的植物，ta 们之间的大小关系，和我们构造出的序列中，ta 们之间的大小关系是一致的.

进一步地，一个高度排列是合法的，当且仅当该排列中，任何两个相距不超过 $k-1$ 的元素，之间的大小关系，与我们构造出的排列是一致的.

同样，容易说明，我们直接沿袭子任务 3 中的构造方法，一定能够构造出一个合法的高度排列，这里我们选择任意一个，直接选择了集合中，前驱与其距离最长的那一个.

上述证明过程和结论可能有些难以理解，但是对之后子任务的解法是很有帮助的.

- 子任务 5（保证 $n\leq300$）：

考虑子任务 4 中得到的结论，也即，一个高度排列是合法的，当且仅当该排列中，任何两个相距不超过 $k-1$ 的元素，之间的大小关系，与我们构造出的排列是一致的.

如此，我们先构造出一个合法的排列，之后对于每对距离不超过 $k-1$ 的元素对 $(u,v)$，按照 $h_u$ 和 $h_v$ 之间的大小关系连有向边，用 Floyd 算法，求出这张图的传递闭包，即可比较 $h_x$ 和 $h_y$ 之间的大小关系，包括能否确定 ta 们之间的大小关系.

- 子任务 6（每次调用 ```compare_plants``` 时有 $x=0$）：

沿袭刚才的思路，考虑去掉显式建图的过程，直接比较 $h_x$ 和 $h_y$ 之间的大小关系.

为什么必然有 $h_x>h_y$，就是因为存在一条路径 $x\to z_1\to z_2\to\dots\to z_t\to y$，使得每两个相邻的植物之间，都有一条大于号边；这样在传递闭包上，就能够说明 $x\to y$ 有一条大于号链.

不妨设 $x>y$，那么任意 $z_i$，都有 $z_i\in(x,y)\cap\Z$，且 $z_{i-1}>z_i>z_{i+1}$；考虑如果我们要在图上连两条边，一条 $a\to b$，一条 $b\to c$，并且呢，$a$ 和 $c$ 之间的距离也不超过 $k-1$，那么我们可以考虑，省去 $a\to b$ 这条边，和 $b\to c$ 这条边，只连 $a\to c$ 这条边.

这要求我们，如果说存在 $x\to a$ 这一条大于号链，还存在 $a\to c$ 这一条大于号边，并且 $b$ 这个点在 $a$ 和 $c$ 中间，满足 $h_a>h_b$，那么我们其实就可以直接判断出，$h_a>h_x$.

我们发现，这样的判断与 $h_b$ 和 $h_c$ 之间的大小关系是无关的，因此，其实对于 $a$ 点来说，只有一条边是实际上有必要连的，就是将 $a$ 和 ta 的 $k-1$ 个后继中，最靠右的、满足 $h_a>h_b$ 的点 $b$ 之间，连一条大于号边 $a\to b$，就可以了.

考虑对每个植物 $i$，都向它的 $k-1$ 个后继中，最靠右的，满足 $h_i>h_j$ 的点 $j$ 间，连一条大于号边，同理连小于号边，同理靠左也要连，然后遍历两遍序列，即可求出 $1$ 和所有其他植物之间的大小关系.

- 子任务 7（没有附加约束条件）：

仍像子任务 6 那样连边，然后对边作倍增，倍增的过程中保持 $h_x\geq h_y$，如果跳过了 $y$，就说明大于是必然的，答案就是 $+1$，否则答案就是 $0$；小于、向左是同理的.

如此，我们就完整地解决了 P6829 [IOI2020]植物比较，个人认为这道题的部分分，给的是非常之有启发性的，能够一步步引导人走向完整的做法，而且在想不出做法的情况下，也能得到一部分分数.

代码由于太丑，而且线段树是递归实现，常数太大，就不放了.