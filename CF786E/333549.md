首先这个东西本身就长得像网络流。我们把问题转化为最小割：

+ 源点向每个人连，流量 $1$。
+ 每个人连向自己路径的每条边，流量 $+\infty$。

然后观察最小割，发现从两类边流走刚好代表了给人和给路径的两种选择。

输出方案是在跑完最大流的网络上看残余流量。

因为边比较多，所以需要优化建图。

这个是树链的连边，考虑树剖加线段树优化即可。