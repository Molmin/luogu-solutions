有一个显然的合并方法，其操作次数为 $n-1$，若让两个相同颜色的像素 $i,j$ 在同一次操作内更改颜色，则答案会减少 $1$。要这样做的话，我们相当于需要让 $(i,j)$ 的所有像素变成同一个颜色，再让 $[i,j]$ 的所有像素变为同一个颜色。我们称这样过程为优化了 $(i,j)$。容易发现，对于 $a<b<c<d$，我们不能同时优化 $(a,c)$ 与 $(b,d)$。

令 $f_{i,j}$ 表示合并 $[i,j]$ 的最大优化次数。那么最终的答案就是 $n-1-f_{i,n}$。转移方程则是

$$
f_{i,j}=\max(f_{i+1,j},\max_{a_i=a_k}f_{i+1,k-1}+1+f_{k,j}) 
$$

前半部分不赘述，后半部分的含义即我们优化了 $(i,k)$。注意加号后面是 $f_{k,j}$ 而非 $f_{k+1,j}$，原因是我们可以同时优化 $(i,k)$ 和 $(k,j)$，表示这三个像素在同时被更改颜色了。