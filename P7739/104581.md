首先我们可以通过类似辗转相除的做法发现整个过程中 $f$ 的最后一个数分子分母必然互质，不需要约分，所以我们完全可以直接计算和取模。

有区间翻转，大概率平衡树。

考虑将 $a$ 序列的最后一个元素单独拿出来，记作 $x$，然后把 $f(a_0,a_1,…,a_k)$ 看做一个和 $x$ 有关的函数，容易归纳证明出 $f(x)$ 一定是 $\dfrac{ax+b}{cx+d}$ 的形式。

显然 `W` 操作就是令代入函数的 $x$ 加上 $1$，但 `E` 操作分两种情况不好搞，所以我们猜测这两种情况可以被归为一种。

先考虑最后一项不为 $1$ 的情况，手动模拟一下可以发现此时 $f(x)=\dfrac{(ax_0+b)x+(ax_0-a+b)}{(cx_0+d)x+(cx_0-c+d)}$（$x_0$ 为原本代入的 $x$ 的值，$a,b,c,d$ 为原来 $f(x)$ 中的对应的系数），同时令代入的 $x=1$。

然后转回来看最后一项为 $1$ 的情况，我们考虑也使用第二种方式，手动模拟一下也可以发现此时结果和代入第一种方式得到的结果是一样的。也就是说我们可以直接使用上面得出的结论。

考虑矩阵维护 $a,ax,b$（另一部分形式类似，这里不再重复），对于 splay 的每个节点维护子树内操作的变换矩阵，由于翻转和反转后的变换矩阵的结果并不好直接从中看出，所以把 翻转/反转/两者都进行 后的变换矩阵也一起维护出即可。

代码太丑就不贴了。