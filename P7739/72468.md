首先比较显然的，我们可以将数列中的数两两变成一组，对于同一组，我们思考对他进行的操作序列的形式必然是$EE...EWW...WE$ ，我们考虑其最后的数值与操作序列是什么样的。

我们不妨设 $E$ 的个数（除去最后一个 $E$ ，他将作为下一组的 $E$ ）是 $cnt_e$ ， $W$ 的个数是 $cnt_w$ ，那么一组中的两个数就分别是 $cnt_e$ 和 $cnt_w$ 。当然，最后一组的 $cnt_w$ 需要 $+1$ 。这个可以自己手模验证正确性。

我们探讨一下最终式子与 $cnt_e$ 和 $cnt_w$ 的关系。

我们试着可以将一个长度为 $4$ 的序列的答案表示出来。

$$
ans=\frac{a_0a_1a_2a_3+a_0a_1+a_0a_3+a_2a_3+1}{a_1a_2a_3+a_1+a_3}
$$

其中 $a_{2k+1}$ 对应的是 $cnt_w$ ，$a_{2k}$ 对应的是 $cnt_e$ 。

首先易证明得答案中的 $a$ 和 $b$ 一定互质。

我们不妨分别求出 $a$ 和 $b$ ，两者的组合意义我们可以根据式子得出。

$a$ 的意义就是选择以 $E$ 为开头以 $W$ 为结尾的 $EW$ 间隔出现的子序列的方案个数 $+1$ 。

$b$ 的意义就是选择以 $W$ 为开头以 $W$ 为结尾的 $EW$ 间隔出现的子序列的方案个数。

然后维护这个东西配合上后面的两种操作，可以用平衡树来维护。