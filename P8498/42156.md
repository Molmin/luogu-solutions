考虑建 toptree。建法和全局平衡二叉树一样，就是轻儿子 rake 二叉树，重链 compress 二叉树。注意两棵二叉树都要重量平衡。

然后，设 $f(i,0/1,d)$ 表示 $i$ 的子簇，到左边 / 右边的界点，$d$-邻域的信息，$g(...)$ 表示 $i$ 的子簇外，到左边 / 右边的界点，$d$-邻域的信息，在 toptree 上做换根 dp 即可。注意设计一下转移顺序，使得 $f,g$ 的值的界点恰好包含了子簇的某个界点。最终回答询问 $(x,d)$，就倍增找到 $x$ 最浅的祖先使得簇大小 $\le d$，只要换根 dp 的第三维维护到 $fa_i$ 的簇大小，就可以每次询问两次合并解决问题，预处理其中一次即可一次合并。

其实没有任何细节，但是写起来就很难受。

说句闲话，这题好 educational 阿。说不定之后会成为 toptree 入门经典题？

参考实现：https://uoj.ac/submission/582922