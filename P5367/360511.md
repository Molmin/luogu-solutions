# 康托展开模板

### 前言

~~看了亿眼题解就会写了~~

~~但是爆了亿次零/dk/dk~~

这里说说自己对康托展开的理解。

题目链接：[$\text{Link}$](https://www.luogu.com.cn/problem/P5367)

### 题意简述

给定一个 $1$ 至 $n$ 的排列，求它在 $1$ 至 $n$ 的全排列中的排名。

### 题目分析

假设给定的 $n$ 个正整数分别是 $a_1,a_2,\cdots,a_n$。

我们先看一个柿子：

$$\sum_{i=1}^n(v_{a_i}\times (n-i)!)+1$$

其中 $v_{a_i}$ 表示在第 $i+1$ 至 $n$ 位的比 $a_i$ 小的数的个数。

这个柿子就是最终的答案，我们来解释一下。

单考虑第 $i$ 位，它本身可以放 $v_{a_i}$ 个的，因为要计算它的排名的话比它小的数都可以放上去。而剩下的 $(n-i)$ 个位置一共就可以放 $(n-i)$ 个数，你怎么放都行，所以一共有 $(n-i)!$ 种方法。最后需要加上 $1$ 是因为要计算它本身的排名。

那怎么维护 $v$ 呢？我们设 $h_{x}$ 表示到了目前第 $i$ 个位置，数 $x$ 有没有出现过，没出现过为 $1$，出现过为 $0$，显然，一开始所有数都没出现过，$h$ 数组就都应该赋值成 $1$。

当我们要计算 $v_{a_i}$ 时，可以考虑这样一个柿子：$\sum_{j=1}^{a_i-1}h_j$，意思是先把所有比 $a_i$ 小的加上，而那些已经出现过的都已经成为 $0$ 了，完美的维护了 $v$。

显然 $h$ 需要树状数组维护。

阶乘用一个 $O(n)$ 的预处理也维护出来了，不过中间要注意精度的问题。

时间复杂度：$O(n\log n)$。

空间复杂度：$O(n)$。

[$AC$ 记录](https://www.luogu.com.cn/record/47700389)

[$code$](https://paste.ubuntu.com/p/fWCx2WVVX2/)

$$\texttt{The End.by UF}$$

