前置定理：
- 一棵以题述方式组织的递归树，其同层节点只具有最多两种长度。
- 归并排序是稳定排序，令序列 $A,B$ 归并为序列 $C$ 不会改变原序列 $A,B$ 中数的顺序。
- 长度为 $n$ 的随机排列的期望逆序对数为 $\frac{n(n-1)}{4}$。

第二条定理非常有用。于是我们想到可以逐层统计合并时的段间贡献。但是似乎不是很好做。不妨先尝试统计第 $K$ 层。为了方便，我们称叶子节点为递归树第 $K$ 层的节点。

自然，每个叶子节点自身的贡献需要被统计，使用第三条定理即可。现在考虑统计两个叶子节点之间的贡献。考虑统计叶子节点 $A$ 上第 $i$ 个元素，与叶子节点 $B$ 上第 $j$ 个元素的贡献，则有两种情况：

- $A_i$ 或 $B_j$ 是当前最大的。这种情况的概率为 $\frac{2}{i+j}$ 且一定不会产生逆序对。
- 否则，出现逆序对的概率为 $(1-\frac{2}{i+j})\times\frac{1}{2}=\frac{1}{2}-\frac{1}{i+j}$。

那么，我们对于所有这样的 $i,j$ 统计答案即可。

考虑更浅层的合并。虽然排列中的数不再是等概率出现。但我们可以将排列拆成两个排列，这两部分排列的数分别是由底层合并而来。因此这一次合并可以看作是底层的段间合并。

于是，处理所有叶子节点的两两合并的贡献即可。由于定理 $1$，我们可以 $O(n)$ 统计段间贡献。总时间复杂度为 $O(n)$。