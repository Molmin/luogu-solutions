## Dsu on tree  

题意大致是先建出**圆方树**。  
求圆点的子树下有多少个来自不同子树的和它颜色不一样的颜色相同的点的集合数。  
$k \leq 20 $ 可以直接 $dp$，单次复杂度 $O(k)$。  
需要**子树信息的合并**，考虑线段树合并，出题人已经说过了，时间复杂度 $O(n \log n+nk)$，空间复杂度 $O(n \log n+nk)$。  
需要**分颜色处理**，考虑虚树，$\red{S}u\_Zipei$ 讲过了，时间复杂度 $O(n \log n+nk)$，空间复杂度 $O(n)$。  
但我们也可以用 $Dsu \; on \; tree$ 解决。  
对于轻儿子之前的记录，我们可以暴力清除。  
同样与线段树合并相同的是，我们在继承重儿子的时候，只需要知道和它颜色不一样的点的个数即可，然后加入答案。  
在暴扫轻儿子加进dp数组时，需要判断。  
  
> 当前节点是否是圆点，该颜色是否与当前颜色不同  
> 之前是否出现过该节点  
> 之前是否进行过初始化  

这样看来时间复杂度貌似是 $O(kn \log n)$ 的，其实是也是 $O(n \log n+nk)$ 的。  
我们发现只有两个儿子中相同颜色集合合并时，才可能做 $dp$。  
考虑在脑中对相同颜色节点建虚树，发现所有点的 $lca$ 都在虚树上，只有那些 $lca$ 才可能做$dp$。  
我们又知道虚树的节点个数是 $O(n)$ 的，所以$dp$的复杂度为 $O(nk)$。  
常数较小，但细节较多，考场上不推荐，推荐用虚树。  
在$2022年7月29日$是最优解，[代码](https://www.luogu.com.cn/record/81600947)。
