闲话：这能评紫？感觉蓝差不多了吧。

---

首先考虑一棵树怎么做。显然我们对第 $i(i>1)$ 个度为 $d_i$ 的节点有 $(d_i-1)!$ 种遍历顺序（根节点 $1$ 为 $d_1!$），所以整体的方案就是 $d_1!\prod\limits_{i=2}^{n}(d_i-1)!$ 种。

然后考虑基环树怎么处理。基环树就是树 + 一条边。简单模拟一下，我们会发现这个基环树遍历完了之后一定恰好是有一条边没遍历到的，因为最后访问的那条边一定是 $u$ 和 $v$ 已经被搜索过就走不了了。

另外这条边肯定在环上，否则搜出来就不连通了。考虑连边 $x,y$，则环一定是 $\text{LCA}(x,y) \rightarrow y \rightarrow x \rightarrow \text{LCA}(x,y)$ 这样，或者反过来。由于深搜会一直搜到死路，所以最后要么是从 $x$ 到 $\text{LCA}(x,y)$ 的最后一步没搜到，要么是从 $y$ 到 $\text{LCA}(x,y)$ 的最后一步没搜到。

所以我们只需要考虑这两种情况对答案带来的影响。

当我们删除一条边 $(x,y)$ 时，会使得 $d_x \rightarrow d_x-1$，$d_y \rightarrow d_y-1$，答案从 $(d_x-1)!(d_y-1)!$ 变成 $(d_x-2)!(d_y-2)!$。$x$ 或 $y$ 为根节点的少减 $1$ 即可，不再赘述。答案变化了 $\dfrac{1}{(d_x-1)(d_y-1)}$ 倍。

当我们添加一条边 $(x,y)$ 时，会使 $d_x \rightarrow d_x+1$，$d_y \rightarrow d_y+1$。同理可以算出答案的变化为 $d_xd_y$ 倍。根节点需要 +1，不再赘述。

那么答案也会相应的扩大 / 缩小一定的倍数。所以我们只需要预处理一开始的答案，以及 $\text{LCA}$ 和逆元，每次在线进行修改，重新计算贡献就可以了。

复杂度 $O((n+q)\log n)$。