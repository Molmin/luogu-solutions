首先可以发现：由于$a_i \geq 2$，所以质数肯定是被拆成一个奇数和一个偶数。

这样的话很类似一个二分图模型，所以考虑网络流。

当$a_i$是奇数时连边$(S, i, 2)$，当$a_i$是偶数时连边$(i, T, 2)$，表示一个点的邻居最多有两个点。

若$a_i$是奇数，$a_j$是偶数，$a_i + a_j$是质数，则连边$(i, j, 1)$。

跑出来如果最大流不是$n$则不合法，否则直接暴力找环即可。

代码见我的[$\texttt{blog}$](https://www.cnblogs.com/cj-xxz/p/11234253.html)