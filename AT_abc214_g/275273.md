比较平凡的一个容斥。

考虑把问题转化成，求 $\forall i \in [1, n], r_i \ne i \land r_i \ne p_i$ 的 $r$ 方案数。考虑到不弱于错排，所以容斥。设钦定 $i$ 个 $r_i$ 取了 $i, p_i$ 中的一个的方案数为 $f_i$，其余任意，那么：

$$ans = \sum\limits_{i = 0}^n (-1)^i f_i (n - i)!$$

考虑求 $f_i$。连边 $i \to p_i$，对每个环单独考虑。设第 $i$ 个环点数为 $s_i$。这个东西抽象到环上就相当于，每一个点，可以不选，可以选择选它自己，也可以选择选它在环上的下一个点。设 $h_{i, j, 0/1}$ 表示当前考虑到环上第 $i$ 个点，有 $j$ 个点选了，这个点是否选择第 $i + 1$ 个点。枚举第一个点的状态，然后直接做即可。合并到 $f_i$，就是做一个加法卷积，暴力即可。

总时间复杂度 $O(\sum s_i^2 + n \sum s_i) = O(n^2)$。

[code](https://atcoder.jp/contests/abc214/submissions/41890357)