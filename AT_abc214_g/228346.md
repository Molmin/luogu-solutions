容斥，记 $f(i)$ 为钦定 $i$ 个位置不满足要求的方案数。答案即为 $\sum (-1) ^ if(i) (n - i)!$。

将 $a_i$ 向 $b_i$ 连边，一定会连出一些 $a_i = b_{i-1}$ 的环。容易发现，不同环之间不会互相影响，且每个环上的答案只与环的长度有关。记 $ans_{i,j}$ 为在前 $i$ 个环内，选出 $j$ 个位置满足要求的方案数。预处理出 $c_{i,j}$ 表示长度为 $i$ 的环中，选出 $j$ 个位置不满足要求的方案数。

考虑如何处理 $c_{i,j}$。记 $dp_{i,j,0/1}$ 为环上前 $i$ 个位置，选出 $j$ 个位置不满足要求，第 $i$ 个位置必选且选择的是 $a_i$ 或 $b_i$ 的方案数。

$dp_{i,j,0} = \sum_{i'< i} dp_{i',j-1,0} + \sum_{i' < i-1}dp_{i',j - 1,1}$

$dp_{i,j,1} = \sum_{i'< i} dp_{i',j-1,0} + dp_{i',j - 1,1}$

前缀和优化即可。时间复杂度 $O(n^2)$。

对于环上最后一个位置的影响，我们强行钦定后断环成链，考虑以下三种情况对 $c$ 的贡献：

- 第一个位置选 $a$.

初值：$dp_{1,1,0}=1$

贡献：$c_{i,j} = c_{i,j} + dp_{i,j,0} + \sum_{i'< i} dp_{i',j,0} + dp_{i',j,1}$

- 第一个位置选 $b$.

初值: $dp_{1,1,1}=1$

贡献：$c_{i,j} = c_{i,j} + \sum_{i'\leq i} dp_{i',j,0} + dp_{i',j,1	}$

- 第一个位置不选。

初值: $dp_{i,1,0} = dp_{i,1,1} = 1(i\ne1)$

贡献：$c_{i,j} = c_{i,j} + \sum_{i'\leq i} dp_{i',j,0} + dp_{i',j,1	}$

以上三种情况只有初值不同，转移方式相同。注意 $c_{1,1} = 1$。

得到 $c$ 数组后，做一次背包求出 $ans$。如果每次只枚举到环长的上界，那么每对数的贡献只会被计算一遍。总时间复杂度 $O(n^2)$。

[模拟赛赛时代码，可读性较差。](https://www.luogu.com.cn/paste/c9wqs7y8)