\*2900

人很乱，以卷代颓，很经典，但个人认为第一次/忘了确实想不到，~~建议降紫的别跳脸~~。（u1s1，lg题解都看不懂

设 $in_x$ 为能到达 $x$ 的点数，令 $inS_x$ 为能到达 $x$ 的不可重集合，$in_x=|inS_x|$，同理定义 $out_x$ 为 $x$ 能到达的点集合，$outS$ 同。

- 重要点当且仅当 $in_x+out_x=n+1$，因为自己算了两次。
- 次重要点当且仅当 $in_x+out_x=n$，因为定义中刨去了重要点，而次重要点显然是次大的，可以取等。

计数 $in_x,out_x$ 有 bitset 的 $\frac{n^2}w$ 的通用解法，即非重要点均可求，复杂度不优雅故不赘述。

有经典结论 $in_x+out_x=n+1$ 的重要点必定在 DAG 的最长链上，设最长链上点集合为 $s$，大小为 $|S|$，考虑反证：

- 若 $x$ 重要且不在最长链上，设排名为 $i$ 的点 $s_i$ 是能到达 $x$ 且在长链序列中排名最靠后的点。（按拓扑序排名）
- 若 $i=|S|$，则最长链可延伸，矛盾。
- 否则 $i<|S|$，由于 $x$ 重要且 $s_{i+1}$ 不可达 $x$，故 $x$ 可达 $s_{i+1}$。
- 则 $s_i\to x\to s_{i+1}$ 可并入最长链使增长，矛盾。

由于都在最长链上，$inS_{s_i},inS_{s_{i+1}}$ 是有包含关系的，$outS$ 同理。

我们可以每次暴力遍历，**被包含的只在之前遍历一次**，即不重复遍历点，故可计数长链上的 $in_x,out_x$，并给出判断，复杂度 $O(n+m)$。

于是重要点一定都考虑完了，考虑次重要点，若位于长链上也可以判断。

考虑位于长链外的次重要点 $x$，根据之前长链理论的经验我们意识到它不会里长链太远。

与反证法同理的思路，我们设排名为 $i$ 的点 $s_i$ 是能到达 $x$ 且在长链序列中排名最靠后的点，再设排名为 $j$ 的点 $s_j$ 是 $x$ 能到达且在长链序列中排名最靠前的点。

- 有 $j-i-1\le 1$，否则中间的点都不可达则 $in_x+out_x\le n+1-(j-i-1)<n$。
- 同时 $j-i-1\ge 1$，否则长链增长。
- 故 $j-i-1=1$。

注意，若不能达长链则 $j=n+1$，不能被达则 $i=0$，边界情况无误。

不妨根据 $x$ 设 $L_x=i,R_x=j$ 为对应的 $s_i,s_j$ 排名，有 $R_x-L_x-1=1$。

发现 $\forall x,y,L_x\neq L_y,R_x\neq R_y$，考虑反证：

首先 $L_x=L_y\leftrightarrow R_x=R_y$，同时已有 $s_{L_x+1}$ 不在 $x,y$ 的可达范围内，考虑 $x,y$ 是否互相可达：

- 不互相可达，$in_x+out_x<n$，$y$ 同理。
- 互相可达，显然长链可增长，矛盾。

故得证。

这告诉我们，对于非关键点的遍历也可以暴力执行，设 $P_i$ 为 $L_x=i$ 的 $x$。

我们在进行完 $s_{i+2}$ 的集合遍历后对 $P_i$ 的集合进行遍历（因为 $R_{P_i}=i+2$），然后暴力回撤。

我们增加的复杂度为至多为 $s_i,s_{i+1}$ 两点遍历时的复杂度，因为 $s_i$ 可达 $P_i$，故 $outS$ 呈包含关系，$P_i$ 能遍历到的也就是 $outS_{s_i}\oplus outS_{s_{i+2}}$，这里 $\oplus$ 表示对称差。

这样总和还是在可接受的 $O(n+m)$ 范围内，只不过带两倍常数。

不知道为什么其他人都跑的这么慢？[代码](https://www.luogu.com.cn/paste/mgemikve)