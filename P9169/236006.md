细节很多的博弈论毒瘤。

感谢考场上这题没写挂，~~而且 CCF 数据极强~~

一个 ~~笨拙的~~ 设状态方法：设 $(a,b,c,d,e,f,I)$ 表示黑棋的坐标是 $(a,b)$，红棋 $1$ 的坐标是 $(c,d)$，红棋 $2$ 的坐标是 $(e,f)$，当前走棋人是 $I$。

这种方法会设出 $2\times 10^6$ 个状态，常数升天。

设状态 $(a,b,c,d,e,f)$ 表示黑棋的坐标是 $(a,b)$，红棋的坐标是 $(c,d)$ 与 $(e,f)$。

注意这里因为两个红棋本质相同，$(a,b,c,d,e,f)$ 与 $(a,b,e,f,c,d)$ 其实是一种状态，所以我们强制规定 $c<e$ 或 $(c=e,d<f)$。

这样可以把状态数缩小两倍。

状态里为什么没有当前走棋人呢？因为棋子确定的时候，走棋人也就确定了。

> 证明：
>
> 因为走一步就会改变一次曼哈顿距离的奇偶性，所以一个棋子要走到另一个坐标（假如能走到），走的步数的奇偶性一定等于曼哈顿距离的奇偶性。
>
> 所以，现在的状态到初始状态的步数的奇偶性一定等于**三个曼哈顿距离之和**的奇偶性。
>
> 三个曼哈顿距离其实有两种：开始的红棋 $1$ 走到了现在的红棋 $1$，开始的红棋 $2$ 走到了现在的红棋 $2$， 或者开始的红棋 $1$ 走到了现在的红棋 $2$，开始的红棋 $2$ 走到了现在的红棋 $1$。
>
> 而这两种情况的曼哈顿距离之和的奇偶性也是相同的——第二种情况我们让开始的红棋 $1$ 走到开始的红棋 $2$ 的地方，开始的红棋 $2$ 走到开始的红棋 $1$ 的地方，走过的曼哈顿距离相同，所以总曼哈顿距离 $+2d$，奇偶性不变。 
>
> 确定了奇偶性，走棋人也就确定了。

当然，你也可以记录走棋人，状态数本质不会增加，只是清空数组的时候常数变大了一倍。

于是我们成功把状态数压缩到了 $5\times 10^5$。

接下来就是博弈论的内容了。

我们先用 BFS 搜出所有可能到达的状态，没有出度的点一定是必败态，我们将其加入队列。

然后按照队列中的顺序，设队头为 $u$，更新每一个可以到达 $u$ 状态的点 $v$（通过建反图实现）。

- 若 $u$ 为必败态，则 $v$ 一定是必胜态，而且走的步数最少的情况一定是移到状态 $u$（步数的路径：必败态先进入队列 $\to$ 必胜态的最劣解先进入队列 $\to$ 必败态的最优解先进入队列 $\to\cdots\to$ 先到达初始状态），所以更新 $v$，并把 $v$ 加入队列。
- 若 $v$ 能到达的所有状态都是必胜态，则 $v$ 为必败态，取需要获胜步数最多的 $u$ 来更新，并把 $v$ 加入队列。

全部更新完之后，会有一些点没被更新到，则这些点是平局（必定成环）。

最后输出起点的值即可。

注意：

- 黑棋只能走三个方向
- 红棋不能重叠

[参考代码](https://www.luogu.com.cn/paste/bry9cotk)
