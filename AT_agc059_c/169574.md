## C - Guessing Permutation for as Long as Possible

首先转化题意，我们把给出的序列看成一个无向图，边有边权，即为询问这一对点的时间戳。

原问题等价于问你有多少种给无向图定向的方案数，使得没有一条有向边 $(u,v,w)$，存在一条 $u$ 到 $v$ 或 $v$ 到 $u$ 的路径，路径上的边权最大值小于 $w$（若有，那么就能在这一次询问前的值 $u$ 和 $v$ 的大小关系，不用进行这次询问）。

考虑若有一个 $(u,v,w)$ 不合法，必定存在一个点 $p$，使得路径上只经过 $u,v,p$。

证明：若经过超过 $3$ 个点，找到最前面的三个点 $x,y,z$，考虑这两个点之间的边权，若 $>\max(v_{x,y},v_{y,z})$，那么直接选 $x,y,z$ 就不合法，否则可以直接删去 $y$ 点。

于是枚举每个三元组，然后会产生一些约束条件，原问题类似于一个 2-SAT 的计数问题，直接带权并查集即可，令 $k$ 表示最后并查集连通块个数，答案为 $2^k$。

提交记录：[link](https://atcoder.jp/contests/agc059/submissions/37028961)。