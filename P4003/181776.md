你谷带思维题。

## 题面

题目传送门：[Link to Luogu](https://www.luogu.com.cn/problem/P4003)。

> 给定 $n\times m$ 的网格，网格上有些水管（水管样式见原题）。求最少旋转水管（不能旋转直线型管道）次数使其不会漏水，或判断无解。一次旋转只能旋转 $90^\circ$ 而不能一次旋转 $180^\circ$。
>
> $nm\leqslant 2000$。

（我才不会告诉你我把 $nm\leqslant 2000$ 看成 $n,m\leqslant 2000$ 以至于我开题解的时候都在质疑题解复杂度正确性。）

## 题解

下文的配图全部来自原题的图，拆解出每个管子之后在 Excel 里面拼起来。很多接口可能没对齐 QAQ。

### 不会旋转

我们先来考虑一个不会漏水的情况：

![](https://pic.imgdb.cn/item/62157d6b2ab3f51d918beb8d.png)

（为什么画一个这个图？它好就好在所有样式的管子都用过……）

然后你会发现很难有什么思路。但是如果考虑网络流，不难得到所谓“不会漏水”的条件，可以转化为一个满流的问题，即每个水管（的分支口）容量都为 $1$，最终要保证满流。

于是我们先考虑如何对一个不需要旋转的图建模，使得这个图的每个水管的支口满流。可以考虑拆点，如果你和我一样 naive 地把一个点拆成上下左右四个，你发现是完全不可行的。于是我们把一个点拆成：上、下、左、右、中五个点。其中上、下、左、右是“连接点”，负责和别的格子相连，中间点是“主要点”，负责接口源/汇点，并根据水管形状向连接点连边。

然后考虑如何定向、如何分布源汇点，考虑将格子黑白染色，黑色格子由源点连向其主要点，白色格子的主要点连向其汇点。就可以保证最大流下接口都有流量了。

于是关于上面这个图，我们可以得到下面的建边：

![](https://pic.imgdb.cn/item/6215853a2ab3f51d9196142e.png)

当然这里忽略了一些没有用到的连接点，而且相邻两个点的重合的连接点只画了一个……这都是代码实现的细节，这张图足以解释问题。

将源点连接到所有的紫色点，容量为无限；将所有黄色点连接到汇点，容量为无限；所有图中的黑色边容量为 $1$。那么这张图的最大流就是每个接口满流的。

### 怎么转

注意到十字形的管道转不转都是一样的，所以不需要考虑十字形管道怎么转。还要注意题面中写到了直线型管道不能转。

因此，我们把这个图改造一下，分别考虑如何旋转 Q 型、T 型、L 型管道。

![](https://pic.imgdb.cn/item/6215894d2ab3f51d919c14aa.png)

因为“流量”已经用来判是否满流（有解）了，因此我们只能加一个“费用”来代表旋转次数。

可以明确的是，当前图上所有的边（黑色边、源/汇点与紫/黄色点的连边）费用都是 $0$。这是不需要旋转就能得到的局面。

另外，因为同种类的水管，连边方式是等价的。因此在本文中我们只讨论按照上面这个图里被打乱的方向考虑。对于同类型、不同方向的水管，转一下就可以了，本质是一样的。当然还要注意连边方向和黑白染色对应的颜色有关。

例如上图，我们应该要加入一些有费用的边（下图中橙色的边），使其变为一个能满流的图。不难发现应该是如下的情况：

![](https://pic.imgdb.cn/item/62158cda2ab3f51d91a19d9d.png)

然后就对着这个图开始分讨吧 =.=

------

#### Q 型

见上图中第三行第三列，我们以朝上的 Q 型水管为例子讨论。

因为只有一个接口，这很好做。往左、往右都是旋转一次，往下需要旋转两次。因此从上连接点向左、右连接点连接流量 $1$，费用 $1$ 的边；向下连接点连接流量 $1$，费用 $2$ 的边。

#### L 型

见上图中第一行第四列，我们以连接右、下两个两个方向的 L 型水管为例子讨论。

我们考虑将其旋转为连接左、下两个方向的水管，可以视为下面的水管没动，把右边的水管接到左边来。而旋转到右、上方向同理。因此从右连接点向左连接点连流量 $1$，费用 $1$ 的边，下连接点向上连接点连流量 $1$，费用 $1$ 的边。

如果要旋转到左、上方向？相当于下面的水管接到上面、右边的水管接到左边。恰好是上述两个连边方向的总和，不需要额外考虑。

### T 型

见上图第而行第一列，我们以下端没有接口的 T 型水管为例子讨论。

如果要把它变成左端或右端没有接口的水管，只需要旋转一次就可以了；如果要变成上端没有接口的水管，则需要旋转两次。因此由下连接点向左、右连接点连流量 $1$，费用 $1$ 的边；向上连接点连流量 $1$，费用 $2$ 的边。

------

于是所有的情况都已经讨论完了，建完边之后，跑一遍最小费用最大流。若没有满流，则说明无解；否则旋转次数就是最小费用。

建模实在难写、情况真多……

## 代码

代码很长，酌情阅读。

我也是人傻常数大，开 O2 才能过……

[Link](https://www.luogu.com.cn/paste/vx9ui5mm)。