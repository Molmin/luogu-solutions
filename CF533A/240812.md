好像已经有 $114$ 年没写题解了。（悲）

提供一个做法，不用数据结构，只需要排序。

预处理出每个点到根的最小限制和次小限制后，可以将最小限制相同的连通块合并，如果修改的话必然是修改该连通块的根（深度最小的点），带来的收益是可以提高这个连通块里所有点的最小限制，当然次小限制还是不会发生任何变化。

假如没有修改操作，如何安放工人？感性理解一下，应该把最高的工人安排在限制最大的节点，次高的放在次大的 $\dots$ 但是现在有一次修改机会。根据上文，修改能影响到的范围是一个连通块，假如该连通块里有的工人身高本来就没有超过限制，那么其实就浪费了他所在的这个位置（节点）。

换句话说，有可能有两个身高超过限制的工人在原计划中并不在一个连通块里，但是可以通过交换其他工人将这两个身高超过限制的工人放到一个连通块里，然后对这个连通块进行修改，使得这两个工人的身高限制同时被满足，而且其他位置不受影响。

这就是大体思路，再讲讲怎么实现的。

将工人以身高从大到小排序。再将每个节点以最小限制（从大到小）为第一关键字，dfs 序（从小到大）为第二关键字，次小限制（从大到小）为第三关键字排序，枚举连通块，那么对于每个连通块，只有两种情况：
- 不在这个连通块里修改：那么就从当前剩下的工人中选尽量身高尽量高的**而且能符合限制的**。
- 如果选择在这个连通块里修改，首先得有能够修改的资格，需要满足两方面的条件：一个是身高高于该连通块（且没有被前面连通块选中）的所有工人都得放到这个连通块里。因为如果这个连通块放不下，放到后面必然不可能满足身高限制。令一方面，如果在原计划下，接下来的连通块里还有身高过高的工人肯定也不行。判断这两个是简单的。

在被修改的连通块里先把身高高于该连通块（且没有被前面连通块选中）的所有工人放进去，再从剩下的工人里选身高尽量高的 $\dots$ 计算每个工人如果要放到对应的节点上，得增加多少，求最大值。还要注意有些工人安排到的节点满足这个工人的身高比该节点的次小限制还大，那么说明怎么修改都是无法满足的，因此虽然选择了这个连通块要放哪些工人，不代表这是可以随便放的。

策略是把最高的工人放到 dfs 序最小的节点上，次高的工人放到 dfs 序次小的节点上 $\dots$ 这样做是因为在一个连通块中，dfs 序最小的节点次小限制是最小的，dfs 序次小的节点 次小限制 是次小的（有点绕）如果这样贪心放都是不行的，那么就说明这个连通块如果去修改他，是不可能满足题意的，反之，如果修改这个连通块，是能搞出满足题意的解的，**那么就应该将修改这个连通块所消耗的代价作为最终答案**。如果这个连通块仍然绥靖，后面的答案必然不会更优。

上述过程可以用双指针维护，这是因为将每个节点排序后，**每个连通块必然是一段连续的区间**。

我一开始写的时候犯了两个错误，第一个错误比较愚蠢：我在划分连通块的时候直接按照最小限制相等的进行分类，这样肯定是错误的，hack数据如下：

```
3
1145 1 4
1 2
1 3
19 198 10
```

可以将 $2$ 号工人安排到 $1$ 号点。但显然 $2$ 号点和 $3$ 号点不属于一个连通块，因此无论如何都无法将剩下的两个工人安排到同一个连通块里进行补救。解决方案是在预处理的时候不仅预处理最小限制，还预处理最小限制来自于哪一个点，比如 $2$ 号点的最小限制来自于 $2$ 号点，$3$ 号点的最小限制虽然与其相同，但是不是来自于同一个点，因此肯定不是一个连通块。

第二个错误是前一个的衍生物。我一开始的时候排序只用最小限制和次小限制作为关键字，这样排序会导致如果两个连通块的最小限制相同，节点可能会被混到一起，如果按照 dfs 序从小到大排就不会有这个问题。
## 后记
我一开始没有注意到犯的两个错误，但是还是能 AC，~~可见数据之水~~。

但是当我改掉第一个错误后又交了一发，居然就挂了。

这就是 $\color{red}\text{-1}\color{black}\text{+}\color{red}\text{-1} \color{black}\text= \color{green}\text+$ 吗？