给一个不依赖 $\pm 1$ 的做法。

设前缀和是 $p$，问题就是找到最长的 $[l,r]$ 使得 $p_l,p_r$ 分别是区间中的 $\min,\max$。这个其它题解已经充分论述了。

考虑从右往左枚举 $l$，维护递增的非严格单调栈和递减的严格单调栈，那么递增单调栈中的元素 $r$ 都满足 $p_r$ 是区间 $\max$，而递减单调栈中 $l$ 右边第一个元素限制住了 $p_l$ 作为区间 $\min$ 的范围，问题是查询递减单调栈中 $l$ 右边第一个元素在递增单调栈中的前驱。

考虑用链表维护两个单调栈的归并（，同时维护每个元素在这个链表中的位置），在其中从递减单调栈中 $l$ 右边第一个元素向左找就 $O(1)$ 地找到了这个前驱。总复杂度 $O(n)$。

感觉很可能有更简单的（不依赖 $\pm 1$ 的）做法。有没有老哥教教。