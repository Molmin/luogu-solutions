$k<5$ 的情况可以通过之后的分析得出答案，这里省略。

首先我们注意到如果一个数不被强制为 $1,5$，我们肯定不希望它们是 $1,5$，这里被强制为是钦定了是 $1,5$ 或者钦定和某个已经是 $1,5$ 的相同。证明很简单，改成 $2,4$ 就行。注意到 $1,5$ 对于答案的贡献可以改成改变询问里面的 $v_i$，我们认为没有 $1,5$。

现在我们考虑一个只有 $2,3,4$ 的版本，有一些数可以直接确定下来，它们的贡献对于询问的贡献仍然可以认为是改变 $v_i$，我们也认为没有这种数。现在问题变成了这样的形式：

有 $n$ 个数，$m$ 个限制，限制形如 $x_i,x_j$ 不能是一个 $2$ 一个 $4$，或者 $x_i$ 不能是 $2$，或者不能是 $4$。还有一些点被钦定是相等的。然后要将这些数标上 $2,3,4$ 之一，设 $2,3,4$ 标了 $x+y+z=n$ 个，那么总贡献容易算得为

$$M(n^2-2xz)+Ax+Bz+C$$

其中 $M=10^6$，$A,B,C$ 是根据询问而定的常数。

现在我们只用预处理出每一个 $x$ 对应的 $z$ 的最值是怎么样的就行，就可以 $O(nq)$ 处理所有的询问（枚举 $x$）。

考虑经典的网络流模型，左边为可以是 $2$ 的点，右边为可以是 $4$ 的点。把每一组钦定相等的点缩成一个，源点向左边连 $\text{size}$ 的边，右边向汇点连 $l\times \text{size}$ 的边，$\text{size}$ 表示点的大小，$l$ 是一个待定常数。对于不能一个是 $2$ 一个是 $4$ 的限制我们在中间连上 $inf$ 的边，此时考虑这个图的最小割一定能表示为 $x+lz$ 的形式，也就是一个 $l$ 可以让我们在所有可能的 $(x,z)$ 的凸包上二分一次，代价为网络流的复杂度 $O(\text{Dinic}())$。由于值域为 $O(n)$，凸包上至多 $O(n^{\frac{2}{3}})$ 个点，我们就能在 $O(n^{\frac{2}{3}}  \log n\text{Dinic}())$ 的复杂度内完成需要的预处理。