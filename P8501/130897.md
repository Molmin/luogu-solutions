定义问题的「标准形式」如下：有 $n'$ 个结点，要给他们染蓝白橙三种颜色之一。有些结点不能染蓝色，有些结点不能染橙色，另外的结点则都可以染。另有 $m'$ 条边，每条边连接着两个结点 $u,v$，要求是 $u$ 和 $v$ 不能一个染蓝一个染橙。

每个结点有一个 $\text{siz}(u)$。令 $c_蓝$ 表示蓝结点的 $\text{siz}$ 之和，$c_橙$ 表示橙结点的 $\text{siz}$ 之和。对于常数 $w=10^6$ 以及给定的参数 $w_蓝,w_橙$，需要求出所有合法染色方案 $w_蓝c_蓝+w_橙c_橙-2wc_蓝c_橙$ 的最大值。

------

## 一、将原问题转化到「标准形式」

首先将一定相等的连通块缩成一个点，其取值区间是构成结点取值区间的交。这时，有些连通块的取值已经被确定下来。受 $k=3,4$ 情况时的启发，不难想到：如果一个缩点的取值此时未被确定为 $1,5$，则我们一定不会往里面填 $1,5$。这是因为 $1$ 可以调整成 $2$，而 $5$ 可以调整成 $4$。以 $1$ 调整成 $2$ 为例，其所带来的收益一定更好，而且调整完之后一定仍是合法方案。

考虑用已经确定取值的缩点的连边来更新其他缩点的取值区间。进行完这一步之后，可以将这些确定的缩点都给删去。删去后可以将 $1,5$ 从剩下缩点的取值区间中去除掉。在去除掉之后，又会有一些缩点的取值被确定下来。重复上面的步骤，将这些确定的缩点都给删去。由于剩下的取值范围只有 $2,3,4$，因此所有要求差值 $\leq2$ 的连边都没有用了。

最后将一个缩点看成一个结点，$2,3,4$ 分别看成蓝白橙，保留要求差值 $\leq1$ 的所有连边，即可转化到问题的「标准形式」。$w_蓝,w_橙$ 的计算是容易的：首先注意到除了 $-2wc_蓝c_橙$ 一项以外，其余项的贡献可以表达为 $c_蓝,c_白,c_橙$ 的线性组合（再加常数）。然后根据 $c_蓝+c_白+c_橙$ 是常数的事实将 $c_白$ 的贡献摊到 $c_蓝$ 和 $c_橙$ 头上即可。具体计算细节这里不列出。

## 二、分析「标准形式」目标函数的性质

注意到 $w_蓝c_蓝+w_橙c_橙-2wc_蓝c_橙=常数-2w\big(c_蓝-\dfrac{w_橙}{2w})(c_橙-\dfrac{w_蓝}{2w})$。设 $S$ 为所有可以被取到的 $(c_蓝,c_橙)$ 的集合，我们将 $(c_蓝,c_橙)$ 看作是平面上的一个点，那么问题实际上就是：将 $S$ 中的所有点向左平移 $\dfrac{w_橙}{2w}$ 个单位，再向下平移 $\dfrac{w_蓝}{2w}$ 个单位之后，求横纵坐标乘积的最小值。

又注意到全染白，能染蓝的全染蓝其余全染白，能染橙的全染橙其余全染白是三种特殊的合法染色方案。设 $S$ 中 $c_蓝,c_橙$ 的最大值分别为 $\max c_蓝,\max c_橙$，这意味着 $(0,0)$、$(\max c_蓝,0)$、$(0,\max c_橙)$ 这三个点肯定均在 $S$ 中。这样一来，我们就对 $S$ 的形状有了一定的了解。我们考虑对三个点变换后的位置分类讨论：

- 若 $(\max c_蓝,0)$ 在第二象限或 $(0,\max c_橙)$ 在第四象限：此时 $S$ 包含第二或第四象限中的部分。此时选第二或第四象限（而不是第一或第三象限）中的点一定更优。在第二象限中，$(\max c_蓝,0)$ 既最靠左又最靠上，因此肯定选他/她最优。在第四象限中同理，肯定选 $(0,\max c_橙)$ 最优。

- 否则的话，$(0,0)$ 要么在第一象限要么在第三象限，且整个 $S$ 也都在这个象限。若 $(0,0)$ 在第一象限，则肯定选他/她最优。

- 唯一不平凡的情况在于整个 $S$ 都在第三象限。由于 $S$ 右上方的形状未知，我们无法直接下结论。然而此时我们有结论：取到横纵坐标乘积最小值的点一定在 $S$ 的右上凸包上。

  从左到右考虑三个点 $(x_0,y_0),(x_1,y_1),(x_2,y_2)$，其中 $(x_1,y_1)$ 在 $(x_0,y_0)$ 和 $(x_2,y_2)$ 的连线上。那么 $(x_i,y_i)$ 均满足 $y=kx+b$（其中 $k<0$），也就是说 $x_iy_i=x_i(kx_i+b)$ 是关于 $x_i$ 开口向下的二次函数。若其顶点位于 $(x_1,y_1)$ 左侧，则 $x_2y_2<x_1y_1$；若其顶点位于 $(x_1,y_1)$ 右侧，则 $x_0y_0<x_1y_1$。无论如何 $x_1y_1$ 都不可能是最小的那个。而原本的 $(x_1,y_1)$ 位于 $(x_0,y_0)$ 和 $(x_2,y_2)$ 的连线下方，$x_1y_1$ 比连线上的 $x_1y_1$ 更大，更加不可能是最小的那个。

这样一来，我们只需要求出 $S$ 的右上凸包即可，并不需要把 $S$ 中的所有点都求出来。

## 三、构建网络流模型求出 $S$ 的右上凸包

考虑经典的网络流模型。将每个结点 $u$ 拆成两个结点 $A_u,B_u$：其中源点 $S$ 连向 $A_u$，表示 $u$ 染蓝；而 $B_u$ 连向汇点 $T$，表示 $u$ 染橙。边权均为 $\text{siz}(u)$。对于每个限制 $(u,v)$，从 $A_u$ 往 $B_v$ 和从 $A_v$ 往 $B_u$ 各连边权为 $+\infty$ 的边，表示 $u$ 和 $v$ 不能一个染蓝一个染橙；同理还要从 $A_u$ 往 $B_u$ 连边权为 $+\infty$ 的边。

现在我们对该模型作一些改动。我们将 $S$ 到 $A_u$ 的边权都乘上 $\lambda_A$，将 $B_u$ 到 $T$ 的边权都乘上 $\lambda_B$。在网络流模型中，我们知道最小割等于最大流。考虑网络的最小割。割掉 $S$ 到 $A_u$ 就是在说 $u$ 不染蓝色，割掉 $B_u$ 到 $T$ 就是在说 $u$ 不染橙色。那么不染蓝色就需要放弃 $\lambda_A\text{siz}(u)$ 的收益，不染橙色就需要放弃 $\lambda_B\text{siz}(u)$ 的收益。那么考虑剩下来能获得的收益。求出了最小割，就相当于求出了 $\lambda_Ac_蓝+\lambda_Bc_橙$ 的最大值。也就是说，我们可以选定 $\lambda_A$ 和 $\lambda_B$ 的值，并通过一次网络流得到 $S$ 中 $\lambda_Ac_蓝+\lambda_Bc_橙$ 取最大值的 $(c_蓝,c_橙)$ 是什么。利用类似于 $\text{wqs}$ 二分的思想，我们可以还原 $S$ 的右上凸包。

具体的还原方法是分治。设 $(c_蓝,c_橙)$ 和 $(c'_蓝,c'_橙)$ 是已知在凸包上的两个点（其中 $c_蓝<c'_蓝$，$c_橙>c'_橙$）。若在其连线的上方还存在一个点 $(c''_蓝,c''_橙)$，那么取 $\lambda_A=c_橙-c'_橙$ 和 $\lambda_B=c'_蓝-c_蓝$，一定能将 $(c''_蓝,c''_橙)$ 找出来（至少找出其中的一个）。这是因为 $\dfrac{c_橙-c''_橙}{c''_蓝-c_蓝}<\dfrac{c_橙-c'_橙}{c'_蓝-c_蓝}<\dfrac{c''_橙-c'_橙}{c'_蓝-c''_蓝}$ 的缘故（也可以用切线来解释）。那么我们直接分治，初始时我们知道 $(\max c_蓝,0)$ 和 $(0,\max c_橙)$ 这两个点一定在凸包上，每次取 $\lambda_A=c_橙-c'_橙$ 和 $\lambda_B=c'_蓝-c_蓝$ 找 $(c''_蓝,c''_橙)$，如果其在 $(c_蓝,c_橙)$ 和 $(c'_蓝,c'_橙)$ 的连线上那么就说明 $(c_蓝,c_橙)$ 和 $(c'_蓝,c'_橙)$ 之间没有其他的点了，否则就确定 $(c''_蓝,c''_橙)$ 在凸包上，然后继续往两边递归即可。

由于 $(c_蓝,c_橙)$ 都是 $n\times n$ 网格内的整点，通过对本质不同斜率个数的简单分析可得凸包的点数是 $\mathcal{O}(n^{2/3})$ 级别的。因此只需要跑 $\mathcal{O}(n^{2/3})$ 次最小割即可。回答询问可以直接在求出的凸包上二分，答案一定是先增后减的单峰函数，且峰值至多只会在连续的 $2$ 个点处取到，可以直接以相邻两个点处答案的增减关系作为二分的依据。

假定 $m=\Omega(n)$，该算法的时间复杂度是 $\mathcal{O}\big(n^{2/3}\text{Dinic}()+q\log n\big)$，空间复杂度是 $\mathcal{O}(m)$。