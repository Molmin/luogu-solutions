
考虑 $k=5$ 的情况，首先除了限制为 $1,5$ 的其他一定取 $2,3,4$ 更优。把一定确定的数字都当作常数，确定是相等的数字用并查集合并，剩下的数限制是 $\{2,3\},\{3,4\},\{2,3,4\}$ 中的一种，以及有一些限制：某两个数不能取一个 $2$ 一个 $4$。

设选 2 的数个数为 $x$，选 4 的个数为 $y$。

推一下会发现对于一个询问，要最大化 $Ax+By-Vxy$，$A,B$ 为每个询问不同的变量，$V=2\times 10^6$ 为定值。

把式子化成：最大化 $-V(x-C_1)(y-C_2)+C_3$，也就是最小化 $(x-C_1)(y-C_2)$.

把可行的 $(x,y)$ 画在平面上，位置一定都在 $([\min x,\max x],[\min y,\max y])$ 的矩形内，并且能取到 $(\min x,\min y),(\min x,\max y),(\max x,\min y)$ 三个点。

现在问题是平移这个矩形后求 $\min x\times y$。如果平移后的点在一二四象限那么上面 3 个特殊点可以解决，其他点不会更优。

如果点全部都在第三象限，答案的形式和最小乘积生成树一样。于是结论与做法也一样，可能是答案的点是 $(x,y)$ 的右上凸包的点，做法就是分治出整个凸包，可以直接看[最小乘积生成树](https://www.luogu.com.cn/problem/P5540)的做法。

与最小乘积生成树不同的是，现在要求的问题是：选一个 2 的收益为 $dy$，选一个 4 的收益为 $dx$，以及有一些某两个数不能取一个 $2$ 一个 $4$ 的限制，求收益最大的方案。这个可以用经典的最小割模型解决：看作选 2,3,4 的代价为 $\infty-dy,\infty,\infty-dx$，然后使用[切糕](https://www.luogu.com.cn/problem/P3227)的模型。

复杂度为凸包上点数乘网络流。
