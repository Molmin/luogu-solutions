感觉场上人均切 E 阿，怎么会是呢

不难发现一条最短路径横坐标必然单调。这是因为一旦回头就会占满两格，从而不优。结合这一性质，考虑一个分治算法：

欲求出 $[l,r]$ 内的点对最短路径之和，不妨取 $m=\lfloor\frac{l+r}{2}\rfloor$。将对答案的贡献分成几部分：$[l,m],[m+1,r]$ 两个子区间内点对的贡献 和 满足 $X\in[l,m],Y\in [m+1,r]$ 的点对 $(X,Y),(Y,X)$ 的贡献。 对于前两者而言，通过性质我们可以知道无论怎样这些路径都不会走出其所属的子区间，因此可以递归下去求解。只需解决那些跨过中间的询问即可。

考察 $[l,m]$ 内的点跨过 $m$ 时所处位置。有可能在上，也有可能在下。容易通过两次 dp 求得每个点到达这两种位置的最短路径。同理，也可以求得 $[m+1,r]$ 内的点到跨过 $m+1$ 时到达的两种位置的最短路径。如果记在上方的最短路径长度为 $dis_{1,x}$，在下方的为 $dis_{2,x}$，那么就有 $f(X,Y)=\min(dis_{1,X}+dis_{1,Y},dis_{2,X}+dis_{2,Y})$。枚举 $X$ 所有满足 $dis_{1,X}+dis_{1,Y}\le dis_{2,X}+dis_{2,Y}$ 的 $Y$ 的数量以及其对应的 $dis_{1,Y}$ 之和。移项即有 $dis_{1,X}-dis_{2,X}\le dis_{2,Y}-dis_{1,Y}$。明显可以二分 + 前缀和解决。同理可以算出 $dis_{1,X}-dis_{2,X}>dis_{2,Y}-dis_{1,Y}$ 一类情况对于答案的贡献。

总复杂度即 $T(n)=2T(\frac{n}{2})+O(n\log n)=O(n\log^2n)$