设 $f_{i, j}$ 表示在 $i$ 所在子树中走 $j$ 步时能够最多能够走到多少个点。

发现这么一个事情：如果往下走要回来，假设走 $k$ 步，只要结点够，那么一定能够访问到 $\frac {k} {2}$ 个结点。对于一个结点，我们枚举一个它的子结点和一个在子结点中走的步数，得到可以不返回时的访问数 $f_{to}$，再加上走剩下的子树且一定返回的访问数 $\frac {i - j - [\mathrm{is~root}]} {2}$，取最大值便是答案。