[题目链接](https://www.luogu.com.cn/problem/CF1355F)

大概题意：交互库想一个 $[1,10^9]$ 的数 $X$，你可以给定一个 $[1,10^{18}]$ 的数 $Q$，交互库返回 $\gcd(X,Q)$。要你在 $22$ 次之内得到 $X$ 的因数个数。

设你的答案为 $d$，标准答案为 $ans$，只要满足 $|ans-d|\le7$ 或 $\dfrac12\le\dfrac{ans}{d}\le2$ 即算正确。

思维题。

容易想到的是对于每个 $X$ 的质因数确定其次数，再把次数加一乘起来就可以了。

具体操作是对于每个质数询问其最大的小于 $10^9$ 的幂次，得到的结果的次数就是 $X$ 包含的这个质数的次数。一个没什么用的优化是把两个质数的最大幂乘起来，一次询问两个质数。

但是 $10^9$ 的质数实在是太多了，而对于大多数质数 $X$ 询问的值都会返回 $1$，所以考虑先求出 $X$ 有哪些质因子。

我们把一些质数乘起来（比如 $2\times3\times5\times7\times11\times\cdots$），一直乘到刚好不超过 $10^{18}$，询问后求出 $X$ 包含哪些质因数再询问这些质因数的次数。

但是还是不能在 $22$ 次询问完，发现可以不用求出具体的值，即只要满足 $\dfrac12\le\dfrac{ans}{d}\le2$ 即算正确。

那么我们相当于有 $4$ 倍的误差空间。因此想到留两个质因子不询问，即只暴力询问到 $1000$ 以内的质数，$X$ 剩下不超过两个质因子，剩下的质因子对答案的贡献不超过 $4$ 倍，输出当前答案的两倍就可以过了。

但是还是不能在 $22$ 次询问完，考虑用上 $|ans-d|\le7$ 的条件。

如果求出来的答案超过 $2$，则答案至少是 $3$，前面的质数乘起来至少是 $2^2=4$，剩下来的质因子之积至多是 $10^9\div4=2.5\times10^8$，所以可以把质数的上界调到 $\sqrt[3]{2.5\times10^8}\approx630$，这时剩下来不超过两个质因子，对答案的贡献不超过 $4$ 倍，折中输出当前答案的两倍就行了。

如果求出来的答案不超过 $2$，那么有可能剩下来 $3$ 个质因子，答案最小是 $1$，最大是 $2\times2^3=16$，折中输出 $8$ 就行了。

通过打表可得，使用 $630$ 以内的质数不超过 $10^{18}$ 的连乘积求出 $X$ 有哪些质因子需要 $16$ 次询问，$X$ 不超过 $9$ 个质因子（$2\times3\times5\times7\times11\times13\times17\times19\times23\times29>10^9$），结合把两个质数最大幂乘起来询问的方法可以用 $5$ 次求出其最大幂，加起来 $21$ 次询问，可以通过。

代码里 `p[]` 存的是质数，`q[]` 存的是质数的 $16$ 个连乘积，`r[]` 存的是 $16$ 个连乘积的分隔点（即 $q_x=\prod\limits_{i=r_{_{x-1}}}^{r_{_x}-1}p_i$）`s[]` 存的是质数的最大幂。

```cpp
#include <bits/stdc++.h>
#define ll long long
using namespace std;
namespace QYB {
    ll p[] = {
        1000000007ll, 2ll,   3ll,   5ll,   7ll,   11ll,  13ll,  17ll,  19ll,
        23ll,  29ll,  31ll,  37ll,  41ll,  43ll,  47ll,  53ll,  59ll,  61ll,
        67ll,  71ll,  73ll,  79ll,  83ll,  89ll,  97ll,  101ll, 103ll, 107ll,
        109ll, 113ll, 127ll, 131ll, 137ll, 139ll, 149ll, 151ll, 157ll, 163ll,
        167ll, 173ll, 179ll, 181ll, 191ll, 193ll, 197ll, 199ll, 211ll, 223ll,
        227ll, 229ll, 233ll, 239ll, 241ll, 251ll, 257ll, 263ll, 269ll, 271ll,
        277ll, 281ll, 283ll, 293ll, 307ll, 311ll, 313ll, 317ll, 331ll, 337ll,
        347ll, 349ll, 353ll, 359ll, 367ll, 373ll, 379ll, 383ll, 389ll, 397ll,
        401ll, 409ll, 419ll, 421ll, 431ll, 433ll, 439ll, 443ll, 449ll, 457ll,
        461ll, 463ll, 467ll, 479ll, 487ll, 491ll, 499ll, 503ll, 509ll, 521ll,
        523ll, 541ll, 547ll, 557ll, 563ll, 569ll, 571ll, 577ll, 587ll, 593ll,
        599ll, 601ll, 607ll, 613ll, 617ll, 619ll, -1ll
    }, q[] = {
        0ll, 614889782588491410ll, 38655288426304091ll, 22125549654501673ll, 316773187163046517ll,
        9879251463499721ll, 39049078408188253ll, 108538288030848139ll, 309619196508457007ll,
        796229312542859009ll, 4064625951224869ll, 6860596063872959ll, 10626236358872441ll,
        17092564102090369ll, 30150641449095443ll, 43889293834596251ll, 234118799ll, -1ll
    }, r[] = {
        1ll, 16ll, 25ll, 33ll, 41ll, 48ll, 55ll, 62ll, 69ll, 76ll, 82ll, 88ll, 94ll, 100ll, 106ll, 112ll, 115ll, -1ll
    }, s[] = {
        1ll, 536870912ll, 387420489ll, 244140625ll, 282475249ll, 214358881ll, 815730721ll,
        410338673ll, 893871739ll, 148035889ll, 594823321ll, 887503681ll, 69343957ll,
        115856201ll, 147008443ll, 229345007ll, 418195493ll, 714924299ll, 844596301ll,
        20151121ll, 25411681ll, 28398241ll, 38950081ll, 47458321ll, 62742241ll, 88529281ll,
        104060401ll, 112550881ll, 131079601ll, 141158161ll, 163047361ll, 260144641ll,
        294499921ll, 352275361ll, 373301041ll, 492884401ll, 519885601ll, 607573201ll,
        705911761ll, 777796321ll, 895745041ll, 5735339ll, 5929741ll, 6967871ll, 7189057ll,
        7645373ll, 7880599ll, 9393931ll, 11089567ll, 11697083ll, 12008989ll, 12649337ll,
        13651919ll, 13997521ll, 15813251ll, 16974593ll, 18191447ll, 19465109ll, 19902511ll,
        21253933ll, 22188041ll, 22665187ll, 25153757ll, 28934443ll, 30080231ll, 30664297ll,
        31855013ll, 36264691ll, 38272753ll, 41781923ll, 42508549ll, 43986977ll, 46268279ll,
        49430863ll, 51895117ll, 54439939ll, 56181887ll, 58863869ll, 62570773ll, 64481201ll,
        68417929ll, 73560059ll, 74618461ll, 80062991ll, 81182737ll, 84604519ll, 86938307ll,
        90518849ll, 95443993ll, 97972181ll, 99252847ll, 101847563ll, 109902239ll, 115501303ll,
        118370771ll, 124251499ll, 127263527ll, 131872229ll, 141420761ll, 143055667ll,
        158340421ll, 163667323ll, 172808693ll, 178453547ll, 184220009ll, 186169411ll,
        192100033ll, 202262003ll, 208527857ll, 214921799ll, 217081801ll, 223648543ll,
        230346397ll, 234885113ll, 237176659ll
    }, ans;
    int main() {
        int t; scanf("%d", &t);
        while (t--) {
            ans = 1; vector<ll> v;
            for (int i = 1; ~q[i]; i++) {
                printf("? %lld\n", q[i]); fflush(stdout);
                ll res; scanf("%lld", &res);
                for (int j = r[i - 1]; j < r[i]; j++) {
                    if (res % p[j] == 0) v.push_back(j);
                }
            } if (v.size() & 1) v.push_back(0); // 由于后面要把质数最大幂两两乘在一起询问，如果由奇数个质因子就塞进去一个不会出现的大质数
            // v 里面存的是 X 所有质因数的编号
            for (int i = 0; i < v.size(); i += 2) {
                printf("? %lld\n", s[v[i]] * s[v[i + 1]]); fflush(stdout); // 两两组合询问
                ll cnt = 1, res; scanf("%lld", &res);
                while (res % p[v[i]] == 0) {
                    res /= p[v[i]]; ++cnt;
                } ans *= cnt; cnt = 1;
                while (res % p[v[i + 1]] == 0) {
                    res /= p[v[i + 1]]; ++cnt;
                } ans *= cnt;
            } if (ans <= 2) printf("! 8\n"); // 特判
            else printf("! %lld\n", ans * 2);
        } return 0;
    }
} int main() {
    return QYB::main();
}
```