显然 $a_i$ 可以是除了 $i$ 的所有祖先以外的任意点。考虑求 $a$ 的逆排列 $b$，$b_i$ 就不可能是 $i$ 子树内的点。

考虑一个容斥，$g_i$ 为钦定其中 $i$ 个结点不合法的方案数。那么 $ans = \sum\limits_{i=0}^n (-1)^i g_i (n-i)!$。

现在问题转化成了如何求 $g_i$。考虑树形 dp，$f_{u,i}$ 表示 $u$ 子树内有 $i$ 个点不合法 **且只考虑不合法的点** 的方案数。

- 不同子树，因为不合法的范围不交，所以可以直接类似树形背包合并，$f_{u,j+k} \gets f_{u,j} \times f_{v,k}$。
- 最后计算 $u$ 不合法的情况的 dp 值时，$f_{u,i} \gets f_{u,i-1} \times ((sz_u-1)-(i-1))$，意思是 $u$ 原本可以选子树内的 $sz_u-1$ 个点，有 $i-1$ 个点已经被选了。

那么 $g_i = f_{1,i}$。

时间复杂度 $O(n^2)$。

[code](https://atcoder.jp/contests/arc121/submissions/37089728)