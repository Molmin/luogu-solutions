有删减，原文见[**我的博客**](https://www.cnblogs.com/SharpnessV/p/14882215.html)

一个环上有 $N$ 个人，$M$ 个苹果树，每一秒每个人顺时针走一米，每隔 $C$ 秒长一个苹果，$Q$ 次询问，每次询问第 $V_i$ 个人在 $T_i$ 秒内能摘多少苹果。

不难发现如果相邻两个人间隔 $\ge C$ ，那么上一个摘的苹果这个人一定能摘到，否则上一个人摘得苹果这个人肯定摘不到。

所以不难完成第一步转化，对于每个人 $i$ 向它后面距离 $\ge C$ 米的第一个人连边，记作 $p_i$。表示第 $i$ 个人吃了一个苹果，那么下一个在这里吃苹果的人是 $p_i$ 。注意可以自己向自己连边。

每个人只有一条出边，那么这就是基环内向树森林。

基环树比较套路的做法是断开一条边使得变成一棵树，然后计算不经过断开边和经过断开边的贡献。

不经过断开边，那么就是子树查询深度在一定区间内的苹果树，经典二维数点，直接离线树状数组即可。

经过断开边，我们可以先将所有苹果树移动到根节点，设移动的距离为 $x_i$ 。

那么对于一个询问 $(V_i,T_i)$ ，设环上根节点到 $V_i$ 的距离为 $y_i$ ，如果 $V_i$ 就是根节点，则距离设为环的长度 $Len $。注意这里是基环树的环长，不是湖的周长。

那么答案显然为 $\sum \max\{0,\left\lfloor\dfrac{T_i-y_i-x_j}{Len}\right\rfloor+1\}$。 

这个式子非常丑，考虑计算偏序，令 $T_i-y_i\ge x_j$ ，那么可以去掉 $\max$ 。再把 $1$ 塞进去，得到一个好看一点的式子。

$$Ans=\sum\left\lfloor\dfrac{T_i-y_i+Len-x_j}{Len}\right\rfloor$$ 

$Len $ 是一个定值，可以式子可以写作 $\sum\limits_{w_i\ge x_j}\left\lfloor\dfrac{w_i-x_j}{k}\right\rfloor$ 。

直接拆开做即可，本质还是二维数点，离线树状数组即可。时间复杂度 $\mathcal{O}((N+M)\log (N+M))$ 。 