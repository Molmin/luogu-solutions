## $\text{Statement}$

有 $T$ 组询问，每组询问给定 $n, X, Y, Z$。你需要计数满足如下条件的字符串 $S$：

- 长度为 $n$；
- 只包含 `A`、`B` 和 `C`；
- 令 $S_i$ 为 $S$ 的前 $i$ 个字符组成的串，$A_i, B_i, C_i$ 分别为 $S_i$ 中 `A`、`B` 和 `C` 的数量。对每个 $1\le i\le n$ 有
  - $A_i - B_i\le X$；
  - $B_i - C_i\le Y$；
  - $C_i - A_i\le Z$。

**答案对** $\bm 2$ **取模**。

$T\le 10,\ 1\le n\le 10^9, \ 0\le X, Y, Z\le 10^9$。

## $\text{Solution}$

考虑题意转化。重述题意如下：

> 在一个长度为 $m = X + Y + Z + 3$ 的环上有三个人，分别处于 $0, X + 1, X + Y + 2$ 的位置。你需要执行 $n$ 次操作，每次操作指定一个人向正方向走 $1$ 步，在这过程中要求任意两个人的位置不可重合。问可能的操作序列方案数。

不妨确定最终状态而不是初始状态。把过程倒转，考虑 dp 从任意位置开始，结束于 $0, X + 1, X+Y+2$ 的方案数。考虑设 $f(k, i, j)$ 表示走了 $k$ 步，第一个人和第二个人的间隔是 $i$、第二个人和第三个人的间隔是 $j$，需要满足 $i, j\neq 0, i + j < m$。考虑某人走了一步可以得到

$$f(k, i, j) = f(k - 1, i - 1, j) + f(k - 1, i + 1, j - 1) + f(k - 1, i, j + 1)$$

初值就是对 $i, j\neq 0$ 且 $i + j \neq m$ 有 $f(0, i, j) = 1$；答案就是 $f(n, X+1,Y+1)$。这可以得到 $O(nm^2)$ 的复杂度。这显然过不去。

考虑特殊条件，也就是模 $2$ 意义下的性质。设任意 $i, j\neq 0, i + j< m$ 都有 $f(k, i, j) = f(k, m - i, m - j)$。考虑让后两维在模 $m$ 意义下进行，我们能注意到不合法位置的 dp 值恰好为 0。这样我们就可以将这转移写成 gf 风格了。

考虑 $F_k(x, y)$ 是对 $f(k, i, j)$ 的二三维求和得到的 bgf，有循环卷积形式的转移

$$F_k(x, y) = F_{k - 1}(x, y) \left( \frac{1}{x} + \frac{x}{y} + y \right) \pmod{(x^m - 1)(y^m - 1)}$$

初值可以写作

$$F_0(x, y) = \sum_{i = 0}^{m - 1}\sum_{j = 0}^{m - 1} x^i y^j - \sum_{i = 0}^{m - 1} x^i - \sum_{i = 0}^{m - 1}y^i - \sum_{i = 0}^{m - 1} x^i y^{m - i}$$

设 $G(x, y) = \dfrac{1}{x} + \dfrac{x}{y} + y$，答案就是 $[x^{X + 1}y^{Y + 1}] \left(F_0G^n \text{ mod }{(x^m - 1)(y^m - 1)}\right)$。

我们不妨分别考虑 $F_0$ 中的四项，讨论他们的贡献。   
对于第一项，它的意义就是操作序列总方案数，也就是 $3^n$，这显然是奇数，在 $\bmod\ 2$ 意义下为 $1$。   
对于第二项，由于 $x$ 取到了所有可能的值，所以实际上我们需要求的就是 $[y^{Y + 1}] G(1, y)^n$。第三项类似。   
对于第四项，通过与第二项类似的考察能发现，我们要求的就是 $[x^{X + Y + 2}] G(x, 1)^n$。

由于 $G(x, 1)$ 和 $G(1, y)$ 是同构的，原问题已经被转化为了如下的问题：

> 求 $\left(x + 1 + \dfrac{1}{x}\right)^n \pmod{x^m + 1}$ 的第 $k$ 项系数模 $2$ 的值。

可以知道 $(1 + x)^{2^k} \equiv 1 + x^{2^k}\pmod 2$，这给了我们一种简化问题的方式。设 $n = \sum_i 2^{a_i}$，并 $n_i = 2^{a_i}$。显然有 $i$ 的范围是 $O(\log n)$ 的。则原题意就是求 $\prod_i \left(x^{n_i} + 1 + x^{-n_i}\right) \pmod{x^m + 1}$ 的第 $k$ 项系数模 $2$ 的值。

在 $m$ 较小时可以考虑直接通过循环卷积暴力计算如上的多项式，复杂度是单次 $O(m)$，总 $O(m\log n)$ 的。    
在 $m$ 较大时我们不妨考虑枚举 $c$，提取  $\prod_i \left(x^{2n_i} + x^{n_i} + 1\right)$ 的 $cm + k + n$ 项系数。可以用数位 dp 统计每个三项式的选法，在单次 $O(\log n)$，总 $O(\frac{n}{m} \log n)$ 的复杂度内解决该问题。

因此对 $m$ 作根号分治可以在 $O(\sqrt n \log n)$ 的复杂度内解决这问题，这也在同复杂度内解决了原问题。

[Submission](https://atcoder.jp/contests/arc147/submissions/39292065).