首先分析题目所给的限制：我们假设 1 只向其它点连了一条边，那么限制就相当于若干个简单环的异或和等于零。如果 1 在一个三元环中，那么简单环还要加上 1 所在的那个三元环。不难想到用 **线性基** 来维护这些信息。

另外题目给的性质非常强。如果把从 1 连出去的边全都断开，那么就会分成若干个连通块，而且每个连通块至多包含一个原来 1 所在的三连环。那么对于每个连通块，我们可以分开处理。

线性基经过约旦消元之后可以被唯一表示。通过打表，也就是暴力选择 5 个数字组成线性基可以知道，**值域在 $[0,2^5)$ 的本质不同的线性基只有 374 种**。

考虑 DP，给每个本质不同的线性基进行标号，再预处理两个线性基 $(x,y)$ 合并在一起之后的线性基编号 $g(x,y)$。设 $f_{i,j}$ 为处理到第 $i$ 个连通块，且当前所有简单环的线性基编号为 $j$ 的方案数。我们按照连通块内与 1 连接的边数 $k$ 来分类讨论：

设去掉与 1 连接的边后，第 $i$ 个简单环的线性基为 $s_i$，加上后为 $t_i$。

- 删掉所有边，$f_{i,x}\gets f_{i-1,x}$

- $k=1$ 时，保留一条合法边：$f_{i,g(x,s_i)}\gets f_{i-1,x}$

- $k=2$ 时，保留一条合法边：$f_{i,g(x,s_i)}\gets f_{i-1,x}$

- $k=2$ 时，保留两条合法边：$f_{i,g(x,t_i)}\gets f_{i-1,x}$

可以滚动数组来优化空间。时间复杂度 $O(n)$。虽然有个 374 的常数，但由于合法状态数很少所以实际效率很高。

[Code](https://www.luogu.com.cn/paste/c83yka5v)