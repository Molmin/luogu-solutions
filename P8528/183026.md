以 $l$ 为 $x$ 轴，以 $r$ 为 $y$ 轴。一个询问 $[l,r]$ 的答案就是 $([l,+\infin],[1,r])$ 中合法点对的数量。

考察一个点对 $a,b(a<b)$ 和他们的最近公共祖先 $c$：

1. $a<c<b$，没有产生新的不合法的点。
2. $a<b<c$，所有包含 $a,b$ 但不包含 $c$ 的点会被干掉，即满足 $([1,a],[b,c))$ 的点对会被干掉。
3. $c<a<b$，满足 $((c,a],[b,+\infin))$ 的点会被干掉。

然后，我们考虑给被干掉的区间 $+1$，倒着扫描线就是一个区间历史最值和问题，这个线段树可以解决。

但是问题来了，枚举 $a,b$ 的代价是 $\mathcal{O}(n^2)$，这是我们不能接受的。

事实上，对于一个 $c$，并非所有的 $a,b$ 都需要贡献，如果满足 $[a_1,b_1]\sub [a_2,b_2]$，那么 $a_2,b_2$ 是毫无用处的。

考虑启发式合并，每次把 $c$ 的子树内的若干个子树的点加入集合，每次每个点产生的贡献就是不在一棵子树内的前驱后继。

那么有用的点对就是 $\mathcal{O}(n\log n)$ 个。

综合时间复杂度 $\mathcal{O}(n\log ^2 n+q\log n)$。