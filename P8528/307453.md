~~lxl：这种题出出来和做的时候都不用动脑子的 全是套路世界大战~~

考虑一对 $(x,y)$，不妨设 $a_x<a_y$，$\text{LCA}(x,y)=z$，发现如果 $a_{z}\in[a_x,a_y]$，那么这一对 $(x,y)$ 无法对任何 $L,R$ 造成约束；否则，不妨设 $a_z>a_y>a_x$，那么所有 $1\le L\le a_x,a_y\le R<a_z$ 的 $(L,R)$ 均不合法。

考虑 dsu on tree，钦定 $x,y$ 的 $\text{LCA}$ 之后，发现对于每个 $x$，小于 $a_x$ 的部分只有最大的那个 $a_y$ 有效，大于他的部分只有最小的那个 $a_y$ 有效，这样就把总共有效的 $(x,y)$ 数量降低至 $O(n\log n)$。

发现一个 $(x,y)$ 相当于覆盖掉二维平面上的一个矩形，每次查询时需要进行矩形求和。考虑离线做扫描线，则只需要维护区间加，区间 $\min$ 以及 $\min$ 的个数，历史 $\min$ 以及历史 $\min$ 个数。

线段树直接做就行了，复杂度 $O(n\log^2n)$。