一个简单的想法是：我们直接找出图中的每个连通分量，每个连通分量染一种颜色。但询问的信息似乎并不足以我们确定所有连通分量，考虑换一种操作方式。

考虑找到度数最大的节点 $u$。注意到

**引理** 设 $u$ 是图中度数最大的节点，如果某个连通块包含了 $u$ 以及 $u$ 的所有邻点，那么这个连通块是合法的。

**证明** 设 $u$ 的度数为 $d_u$。注意到此时联通块的大小 $n_u > d_u$，且每个点度数都 $\leq d_u$，那么度数总和 $\leq d_un_u < n_u^2$，符合题意。

进一步地，我们可以进一步加强这个引理：

**引理** 对任意节点 $u$，如果某个连通块中所有节点的度数都不超过 $u$ 的度数，且这个连通块包含了 $u$ 的所有邻点，那么这个连通块是合法的。

证明完全一致。

----------------------

我们依据上面的引理设计算法。初始时，将所有节点标记为未染色。接着不断执行下面的操作，直到所有节点都被染色为止：

- 在所有未染色的节点中选取度数最大的节点，设为 $u$。（如有多个任取一个）
- 顺次扫描 $u$ 的出边，如果扫到一个已访问节点（设为 $v$），那么把 $u$ 以及之前扫描到的 $u$ 的邻点全部和 $v$ 染上同一种颜色。如果一直没有找到，那么将 $u$ 和 $u$ 的全部邻点染成一种全新的颜色。

显见给出的染色方案是合法的。总询问次数 $=n-$ 最后的颜色数 $ < n$，符合要求。朴素地实现这个做法，时间复杂度为 $O(n^2)$，已经符合要求；当然也可以进一步优化至 $O(n)$。