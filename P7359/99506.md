前置知识：矩阵乘法，动态规划，树上倍增

首先，我们先考虑链的情况的单个询问怎么处理。

设$f_{i,0/1}$表示当前处于第i个点，当前在走陆路、水路，那么$f_{i,0}=min(f_{i-1,0}+s1,f_{i-1,1}+min(s1,s2))$，$f_{i,1}=min(f_{i-1,1}+s2,f_{i-1,0}+min(s1,s2)+L)$其中，$s1,s2$分别表示走陆路和走水路的时间。

然后考虑优化。

我们发现这是一个矩阵乘法，可以得到转移矩阵
$$\begin{bmatrix}f_{i,0}\\f_{i,1}\end{bmatrix}=\begin{bmatrix}f_{i-1,0}\\f_{i-1,1}\end{bmatrix}* \begin{bmatrix} s1 & \min(s1,s2) \\ s2 & \min(s1,s2)+L \end{bmatrix}$$
其中，这里用的是广义矩阵乘法，这里的广义矩阵乘法的定义为，若：
$$C=A* B$$
其中A是一个$n\times m$的矩阵，B是一个$m\times k$的矩阵，则
$$C_{i,j}=\min_{p=1}^m(A_{i,p}+B_{p,j})$$
可以证明，这东西满足结合律。

所以用在本题上面，我们设$f_{i,j}$表示节点$i$向上走$2^j$的转移矩阵。

不过，由于从$u$到$v$并不等价于从$v$到$u$，所以我们要同时记录上行和下行的状态，最后倍增即可。

不过需要注意：矩阵乘法并不满足交换律，所以不要弄错乘法的顺序。

然后就没了，时间复杂度$O(n\log n)$，常数约为8.