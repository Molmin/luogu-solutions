- 给出一棵 $n$ 个节点的树，初始时第 $i$ 个节点上有一个数字 $i$。
- 每次你可以选择一条未被删除的边，交换这条边连接的两个点上的数字后，删除这条边。
- 现给定一个序列 $a$，第 $i$ 个位置上若不为 $0$，则代表要求最终第 $i$ 个位置上的数要为 $a_i$。否则没有特殊要求。
- 试求出，执行 $n-1$ 次操作之后，有多少种最终局面满足序列 $a$ 的要求。答案对 $10^9+7$ 取模。
- $2 \leq n \leq 5 \times 10^5$，$0 \leq a_i \leq n$。

考虑一些特殊情况：

- $a_i=0$ 且形态是菊花。答案显然是 $(n-1)!$。
- $a_i=0$ 且形态是链。答案没那么显然。不妨考虑每个点最终会去向哪里，假设其不是端点，则第一步会移到两端的边中先被操作的一端，直到操作后另一条边已经被操作了，则停止在当前点。
- 发现此时它到达的位置仅和每个点连出去的两条边操作的先后顺序有关，而与每个点相连的边的先后顺序是互不影响的：把每个点连着的边根据定好的顺序连出有向边表示先后关系，不会连出环，则可以拓扑排序构造一种方案。则这种情况下答案是 $2^{n-2}$。

则得出一条性质：树的最终形态仅与每个点邻边的操作顺序有关，点与点之间独立。

$a_i=0$ 时答案是 $\prod (deg_u!)$，如果能求出每个点邻边的操作顺序个数，其乘积就是答案。由此，考虑当要求「数字 $u$ 最终停在结点 $v$」时对操作的影响（设路径 $u\to v$ 依次经过 $u,x_1,x_2,\cdots x_k,v$，$k\ge 0$）：

- 边 $(u,x_1)$ 是点 $u$ 首次操作的边。
- 边 $(x_k,v)$ 是点 $v$ 最后操作的边。
- 边 $(x_1,u)$ 操作后，下一个关于 $x_1$ 的操作一定是 $(x_1,x_2)$。

于是带来的限制类型有：

1. 固定点 $u$ 第一次操作的边。
2. 固定点 $u$ 最后一次操作的边。
3. 固定点 $u$ 操作边 $e_1$ 后下一次操作边 $e_2$。

则对于类型 3 的限制，点 $u$ 的邻边应该形成若干条链的限制，表示一旦操作链头，接下来就会依次操作这条链里的所有边，可以把它们捆绑在一起。对于类型 1,2 的限制，则对应了其对应链不能任意重排，则如果有解，一个点邻边的操作顺序应该有 $c!$ 种，其中 $c$ 是没被强制开头或结尾链的条数。

讨论一些明显的不合法的情况：

- 先后关系组成的不是链结构，即一条边有多个后继或多个前驱。
- $u$ 首次操作的边不止一条，即超过一个 $a_i=u$。

发现后继关系只有至多 $O(n)$ 条，所以可以暴力地把每条链拉出来添加后继关系，这保证了复杂度是正确的。不过还有一些额外的不合法的情况：

- 后继关系成环。
- 强制开头和强制结尾的边在同一条链中，但没有覆盖这个点的所有邻边，导致邻边无法插入。

判掉这些情况就能过，不过一个可能讨论得更少的写法是拓扑排序。