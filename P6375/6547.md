山 $i$ 的高度为 $h_i$，横坐标是 $x_i$。

需要计算的有：
- 刚到达山 i，且到达山 i 前没有去过相同高度的山，所有这种方案的概率和 $p_{i}$
- 刚到达山 i，且到达山 i 前没有去过相同高度的山，的期望体力消耗 $d_{i}$

容易发现，如果 $h_i = h_j$，会有 $p_i = p_j$，因为只要有一个到达 $i$ 的方案，相应的也会有一个到达 $j$ 的方案，但是由于 $x_i \ne x_j$ 所以 $d_i \ne d_j$。

记 $c_i$ 为高度**小于或等于**山 $i$ 高度的山的数量，
记 $c'_i$ 为高度**小于**山 $i$ 高度的山的数量。

再记 $u_h$ 为刚到达高度为 $h$ 所有山 $i$ 的概率和（$\sum_{i, h_i = h}{p_i}$）；
再记 $v_h$ 为刚到达高度为 $h$ 的山的期望体力消耗（$\sum_{i, h_i = h}{d_i}$）。
这两个用来做在同一个高度上再跑一次的转移。

对于已经算完的山 $i$，考虑高度严格小于山 $i$ 的山 $j$。

一类转移是不走和 $i$ 高度相同的山，$p_j$ 会增加 $p_i / (c_i - 1)$，$d_j$ 会增加 $d_i / (c_i - 1) + p_i / (c_i - 1) \left|x_i - x_j\right|$。

另一类转移是走了一步和 $i$ 高度相同的山，我们将山 $i$ 看做是第二次到达的高度为 $h_i$ 的山，那么第二次到达山 $i$ 的概率是 $p'_i = (u_{h_i} - p_i) / (c_i - 1)$，期望体力消耗是：
$$d'_i = (v_{h_i} - d_i) / (c_i - 1) + \sum_{j, h_j = h_i, i \ne j}{p_j / (c_j - 1)  \left|x_i - x_j\right|}$$
式子里山 $i$, $j$ 高度相同，所以有：
$$d'_i = (v_{h_i} - d_i) / (c_i - 1) + p_i / (c_i - 1) \sum_{j, h_j = h_i, i \ne j}{ \left|x_i - x_j\right|}$$
显然，一个高度算完之后可以按横坐标 $x_i$ 的顺序求个前缀和。$\sum_{j, h_j = h_i, i \ne j}{ \left|x_i - x_j\right|}$ 就可以拆一下绝对值，用前缀和来求，记这个东西是 $w_i$。那么：
$$d'_i = (v_{h_i} - d_i) / (c_i - 1) + w_i p_i / (c_i - 1)$$

最终，另一类转移是，$p_j$ 会增加 $p'_i / c'_i$，$d_j$ 会增加 $d'_i / c'_i + p'_i / c'_i \left|x_i - x_j\right|$。

两类转移中的绝对值不好弄，想办法拆，考虑分治高度，也即 `cdq(l, r)` 之后，应当计算完高度在 $[l, r)$ 内所有山的信息。

首先肯定是递归地处理 `cdq(mid, r)`。然后考虑高度在 $[mid, r)$ 所有山给高度在 $[l, mid)$ 所有山算贡献。

我们把高度在 $[l, r)$ 所有的山按横坐标排序，然后类似前面的玩法维护一下 $p_i / (c_i - 1) x_i$ 的前缀和，以及 $p_i / (c_i - 1)$ 的前缀和，就可以推出来对于 $j$ 所有的转移值了。

写的话 cdq 里面可能会套个 `partition` 和 `sort`，每个元素在第 $i$ 层递归只会被某个递归处理到，每层是 $\mathcal{O}(n \log n)$ 的。离散化高度后，总的时间复杂度是 $\mathcal{O}(n \log^2 n)$。