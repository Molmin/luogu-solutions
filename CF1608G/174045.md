科技普及题。

如果你会后缀数组那这题就是个除了实现之外毫无难度的码农题。你只需要二分定位，支持比较一条链和模板串上的某个后缀的字典序比较，树剖即可。

问题是你也可能跟我一样，是一个只会硬上 SAM 的憨憨。这篇题解就是讲怎么把这道题对于我这种憨憨也变成毫无思维难度的板子题。

首先建出广义 SAM，那么我们只需要把这个链形成的字符串在 SAM 上定位。后缀树的树形结构在这里没有什么优秀的性质，考虑利用转移边。

介绍一种科技：**DAG 剖分**。SAM 的转移边有一个优秀的性质是，每条路径对应一个本质不同子串，所以路径个数是平方级别的。此时我们将这样的边 $(u,v)$ 称为重边：$v$ 出发的路径数大于 $u$ 的一半，到达 $u$ 的路径数大于 $v$ 的一半。

容易发现这样会变成若干条重链，每走一条轻边都会使当前点出发的路径减半，所以每条路径上的轻边数量都是 $O(\log n^2)=O(\log n)$ 级别的。

考虑一个从一个节点开始在 SAM 上匹配的过程。我需要知道能沿着重链走多长，发现只需要求得重链底端对应的子串与匹配的文本串的 lcp。然后我可以直接确定要走哪个轻边。

把这个树也树剖，一条条重链地匹配，则我们只需要把每个重链和重链的反串和所有模板串的反串再丢到一个广义 SAM 里去求个 lca 就行了。

DAG 剖分是一共走 log 个轻边，树剖最多带来 log 的额外贡献，而两个贡献是加而不是乘到一起的，所以匹配一次还是最多求 $O(\log n)$ 次 lcp。定位之后自然是二维数点。

根据你使用的 SAM 构造方法以及求 lcp 的方法，时间复杂度从 $O(n(\log^2n+|\Sigma|))$ 到 $O(n\log n)$ 不等（设 $n$，$m$，$q$ 同阶），空间从 $O(n)$ 到 $O(n(\log n+|\Sigma|))$ 不等。

我使用树剖求 lcp，朴素的写法构造 SAM，时间复杂度是前者，空间复杂度是 $O(n|\Sigma|)$，目前在 cf 上排最优解第一。代码 6.88k，333 行，放上来比较精神污染，丢个[评测记录](https://codeforces.ml/contest/1608/submission/139337232)好了。

属于是难写好调，我写了一天才调了可能一个小时左右就过了。

bonus：在和 Zeven 学长的交流中学长指出，压缩后缀自动机可能可以直接解决这个问题。我是从 ULR1 的题解学到的 DAG 剖分这个技巧，那里也说了从压缩 SAM 的角度来看 DAG 剖分只是对反串后缀树进行了树剖。

但是我并不会压缩 SAM……有没有老哥教教我啊（

感谢 Zeven 学长的指导！