这道题，让人看到直呼 What the f... ~~fuck~~ fantastic！本题其它题解已经写的很全面了，但是我还是想将自己的思路整理一下，同时也希望其它题解看完还有些迷糊的人从我这得到解答。

不难发现，本题的最终答案并没有一定要按照题目所给的顺序求出（枚举两个集合计算贡献）。因此，我们可以考虑使用一些更加高效的处理方式——考虑任意一个数在统计另一个数的情况下是否会对答案产生贡献。

假设，当前有两个数 $x$ 和 $y$，它们分别来自编号为 $a$ 和 $b$ 的集合中的第 $i$ 和 $j$ 位（即 $x = S_{a,i}$ 且 $y=S_{b,j}$），我们对此分类讨论：

- 如果 $x>y$，因为 $x$ 和 $y$ 在两个集合合并之后 $x$ 的下标大于 $y$ 的下标，故 $x$ 所在之处不会影响 $y$ 的下标，不对答案产生贡献；
- 当 $x<y$ 时：
  - 如果 $a=b$，则在当前 $x$ 和 $y$ 共同所在的区间的每一次与其它区间合并中，$x$ 都会产生贡献，此时贡献为 $n-a$；
  - 如果 $a<b$，则当两区间合并时，$x$ 的存在会导致 $y$ 向后移动一位，故贡献为 $1$。
  - 如果 $a>b$，这两个区间永远不会合并，所以不产生贡献。

因此，$y$ 来源于其它所有数对答案的贡献应当为 $(mn_n - mn_b) + (mn_b - mn_{b-1} + 1)\times(n-b)+(n-b)$，其中，$mn_t$ 表示集合 $1$ 至 $t$ 中有多少个比 $y$ 小的数。

代码实现中，我们可以先将所有数排序并记录其所在区间，$mn$ 数组可以用树状数组维护。

[记录](https://atcoder.jp/contests/abc306/submissions/43697216)