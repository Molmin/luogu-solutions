
[传送门](https://www.luogu.com.cn/problem/AT_agc060_e)

## 非常非常非常详细的题解

发现题解区的题解不是很详细啊，所以就自己写了一篇。

里面包含所有结论的详细证明图解，如果哪个地方有问题欢迎指出来。

求过 $\texttt{QwQ}$。

### $\texttt{Description}$

对于一个 $1$ ~ $n$ 的排列 $a$，设 $f(a)$ 表示排列 $a$ 的环数。

给定 $n$,$m$ 和一个排列 $a$，称一个排列 $b$ 是好的当且仅当它满足下列条件：

- 设排列 $c$ 满足 $c_{i}=a_{b_{i}}$，那么 $f(b)+f(c)=m$。

你需要构造一个好的排列 $b$ 或输出无解。

$n\leq 2\times 10^{5}$。

### $\texttt{Solution}$

考虑调整法。

每次交换一个排列的两个元素可以使答案 $\pm 1$。

一种情况是大环分裂成两个小环，答案 $+1$。

另一种情况是两个环合并成一个大环，答案 $-1$。

因为交换 $b$ 的两个元素会交换 $c$ 的两个元素。

所以交换一次答案的变化只有 $2,0,-2$。

那么显然如果 $k$ 与 $f(b)+f(c)$ 奇偶性不同，一定无解。

那考虑构造出最大值，最小值。

然后通过最小值调整到最大值，或者最大值调整到最小值。

所以如果 $k$ 在最大值最小值之中，且奇偶性相同，那么有解。

---

>结论 $1$:最大值是 $f(p)+n$，当 $x_i=i$ 时取到。

反证法证明:

- 如果存在 $f(x)<n$ 并且 $f(x)+f(y)> f(p)+n $。

- 那么 $x$ 一定可以通过交换两个元素使 $f(x) +1$，所以 $f(x)+f(y)$ 不降。

- 当调整到 $f(x)$ 等于 $n$ 时，$y=p$，与 $f(x)+f(y)>f(p)+n$ 矛盾。

---

>结论 $2$：最小值要么是2要么是3。

>x首先 $f(b)+f(c)\ge 2$ 不能再小了。

证明:

- 考虑这么一个构造方法:

- 不要忘了排列对应的图上每个点的入度为 $1$，出度为 $1$。

- 因为我们有两个排列，所以我们想象两个图，一个代表 $b$，一个代表 $c$，初始无边。

- 我们一个一个给每个点连出边，最后一个点确定且会形成环。

	- 怎么连？

- 考虑贪心，如果一个点的出边**连向自己所在联通块**，那么会**使 $f(x)$ 值变大**，所以我们每次都连与自己不相连的连通块，直到不管怎么连都会使 $f(b)$ 增大:

- 首先要注意每个点入度为 $1$，所以一个点所在的连通块，只有一个点可以接收边。

- 假如当前正在给第 $i$ 个点分配出边，那么每个图上都有 $n-i+1$ 个连通块，对于 $i$ 的连边小小分讨一下。

上图！

![](https://cdn.luogu.com.cn/upload/image_hosting/yextseny.png)

一共有两种决策：

![](https://cdn.luogu.com.cn/upload/image_hosting/z008mdqz.png)

![](https://cdn.luogu.com.cn/upload/image_hosting/86xp8suz.png)

聪明的你一定发现了什么时候会出现问题了。

没错！

>当只有两个连通块时，出现 $(1)$ 情况时一定会形成一个环。

>出现 $(2)$ 情况则不会有环。

这时 $i=n-1$。

$i=n$ 的时候连边确定，一定都会形成环。

>所以情况 $(1)$ 就对应了 $f(b)+f(c)=3$。

>情况 $(2)$ 对应了 $f(b)+f(c)=2$。

因为不可能出现答案小于 $2$ 的情况。

自然最小奇数值就是 $3$ 了。

---

然后你通过上述方法构造出了一个下界。

发现其中一定有一个排列是只有一个环的。

先不管另一个排列。

我们对这个环动手脚。

每次通过交换**一步**把他的大环分裂成一个自环和一个大环答案 $+1$，所以这时 $f(b)+f(c)$ 不降。

如果枚举对应变化然后求 $f(x)+f(y)$ 复杂度是 $O(n^2)$ 的。

但是这个东西不降，所以考虑二分自环个数，然后 $O(n) \ \text{check}$。

复杂度 $O(n\log n)$。

代码为了实现方便用了并查集。

[code](https://www.luogu.com.cn/paste/n5un5ld7)