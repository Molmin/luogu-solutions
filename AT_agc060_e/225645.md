设 $k=f(x)+f(y)$。

关键性质：交换 $x_i,x_j$，也会交换 $y_i,y_j$，故 $k$ 的变化量必为 $-2,0,2$ 中的某个。

那么若 $K$ 与 $k$ 的奇偶性不同就已经无解。考虑求出 $k$ 的最大值 $mx$ 与最小值 $mn$，只要 $mn \leq K \leq mx$ 就一定有解。

> 结论：$mx=f(P)+n$，当 $x_i=i$ 时取到。  
> 证明：假设存在 $f(x)<n$ 时 $f(x)+f(y)>f(P)+n$。一定存在 $i,j$ 使得交换 $x_i,x_j$ 后 $f(x)$ 增加 $1$，那么 $f(x)+f(y)$ 单调不降。有限次调整后 $f(x)=n$，而此时 $f(x)+f(y)>f(P)+n$，矛盾。证毕。

> 结论：$mn=2$ 或 $mn=3$。 

$f(x)+f(y) \geq 2$，故显然不能更小了。下面给出一组构造算法：

- 构造两个 $n$ 个点的图，初始无边。

- 枚举每个点 $1,2,\cdots,n-2$，找一个点 $v$ 使得 $i$ 与 $v$ 在 $G$ 中不连通且 $i$ 与 $P_v$ 在 $H$ 中不连通。

    + 这样的 $v$ 一定存在。由于每个点度数不超过 $1$，故 $G$ 与 $H$ 中不能选的点都至多只有一个，那么不能选的点至多只有两个，而剩下的点至少有三个。

- 找一个点 $v$ 使得 $n-1$ 与 $v$ 在 $G$ 中不连通。能找到的原因同上。

- $x_n$ 被唯一确定。

注意到上述算法中只有 $3$ 处会增加环数，故 $f(x)+f(y) \leq 3$。

接下来考虑构造方案。

将取到 $mn$ 的 $x$ 记作 $A$，取到 $mx$ 的 $x$ 记作 $B$。

将 $A$ 通过不超过 $n-1$ 次交换变为 $B$，记这个过程中的 $x$ 分别为 $A=C_0,C_1,C_2,\cdots,C_{t-1},C_t=B$。

显然序列中任意两个相邻的 $x$ 对应的 $k$ 差不超过 $1$，于是可以类似二分求函数零点的方式找到满足条件的 $C_p$。

总时间复杂度 $O(\sum n \log n)$。

[**Code**](https://atcoder.jp/contests/agc060/submissions/37777088)

