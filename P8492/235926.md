假设只有一组询问：

考虑枚举每一个点作为“山峰”，将它左右所有与其高度差至少为 $D$ 的点两两连一条线段，则答案等价于最多能选择出的满足任两条线段交不超过 $1$ 的线段个数加 $1$。首先最优选取方式一定是任两条相邻线段的交都为 $1$，然后考虑在我们的选择中，若某相邻两条无交，则一定可以通过调整变成交为 $1$。

这样直接模拟就是 $O(n)$ 的，倍增一下就可以处理 $D$ 全相等，多组询问的情况。

---

有两个性质：

1. 不存在交大于 $1$ 且不相互包含的线段。
2. 不存在高度大的点所代表的线段包含高度小的点所代表的线段。

这两个性质容易画图证明。

---

然后我们考虑一个点代表的线段什么时候会被选。

我们找到它左右两边第一个高于它的点，不难发现它能被选当且仅当它连出的最短线段不经过高于它的点。这样我们就可以通过区间最值简单计算出它可以被选的 $D$ 的最大值。

那么我们就可以通过按 $D$ 值从大到小建出主席树算出某个 $D$ 值下区间合法“山峰”数。

最后一个问题，就是“山峰”在区间内，不代表线段在区间内。但是满足这个条件的一定只能是最左或最右的“山峰”，我们主席树二分找到这两个点特判一下就可以了。

---

时间复杂度：$O((n+q) \log n)$ 。
