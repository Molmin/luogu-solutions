核心 observation：**$u$ 到 $v$ 的最优线路只应该经过 $u\to v$ 路径上的直线，或者相邻与 $u\to v$ 的直线**。证明：

 - 反证。设第一个不与 $u\to v$ 相邻的线段为 $a\to b$。
 - 将所有未被经过的线段缩为点。
 - 这条线路经过的区域中，必然有离 $u\to v$ 最远的区域。这个区域仅会走进去然后紧接着走出来。
 - 这样的走进去然后走出来肯定会围绕的相同一个点，因为前面进行缩点。
 - 设走进去所跨过的线段为 $x\to y$。
 - 接下来的几步出来肯定在连续的跨过 $x\to z$ 形式的线段。
 - 终于来到 $x$ 第一个儿子左边的时候，跨过了至少 $1$ 条线段。
 - 但是现在所在的区域与进去前相邻，因为这样等于绕了 $x$ 的所有儿子
 - 于是如果选择直接走与 $u\to v$ 更进的区域，只需要跨过 $1$ 条线段。
 - 于是走到离 $u\to v$ 更远的区域肯定不优于走离 $u\to v$ 更近的区域。
 - 归纳，得到必须沿着 $u\to v$ 相邻的线段走。

于是，对于询问 $u,v$，可以只考虑 $u$ 和 $v$ 上的节点以及与这些节点相邻的线段。在这道题里，往儿子求最短路比往父亲求最短路更难。

分两种情况考虑。如果 $u$ 是 $v$ 祖先，或相反，可以直接从更深的节点往上求。否则，先提取 $u$ 到 $u'$ 的最短路以及 $v$ 到 $v'$ 的最短路，其中 $u'$ 和 $v'$ 分别为最浅，但不为 $v$ 和 $u$ 的祖先，的节点。得到这些链再分类讨论往什么方向转。

如何求 $u$ 到 $u$ 的某个祖先的答案？直接对点操作比较麻烦，因为题目禁止经过节点。我们对每一个节点的坐标系 $(x_i,y_i)$ 反而对着 $(x_i-\epsilon,y_i)$ 和 $(x_i+\epsilon,y_i)$ 算，其中前者为“左侧”，后者为“右侧”。预处理每一个节点的左右侧到父亲的最短路，就可以倍增算。这里信息合并即为最短路路径合并。

更详细的说，从左侧走到 $2^k$ 级父亲左侧，需要枚举对于第 $2^{k-1}$ 级父亲，更优来在中途经过其“左侧”还是其“右侧”。

最终时间复杂度 $O((n+q)\log n)$。由于这是静态树信息合并，可以做到 $O(n\log n+q)$（长链剖分 + sqrt tree or 猫树）或 $O((n+q)\log\log n)$（递归树上分块）。

### 后言

ver3 大概是先做一个换根 dp，将每一条边边权设为经过线段的最小花费。

不得不说这是最巧妙的 dp 题吧

sto ClCN orz

代码先咕咕咕，我连题都还没过（）