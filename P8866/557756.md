### 从部分分 $k=2n-2$ 入手

这个数据特征启示我们将所有牌尽量往前 $n-1$ 个栈放，留第 $n$ 个栈作为空栈。

有了这个空栈，不难构造一种策略：将 $2n-2$ 种牌型平均分配到前 $n-1$ 个栈中。对于当前的牌 $i$，设其的种类为 $a_i$，种类 $a_i$ 应分配到的栈为 $s_i$。

- 若栈 $s_i$ 没有第 $a_i$ 种牌，则执行操作 $1$：将牌 $i$ 放入栈 $s_i$。
- 若栈 $s_i$ 已经有第 $a_i$ 种牌，且它在栈顶，则执行操作 $1$：将牌 $i$ 放入栈 $s_i$，并自动消除栈 $s_i$ 最上方的两张相同种类的牌。
- 若栈 $s_i$ 已经有第 $a_i$ 种牌，且它在栈底，则先执行操作 $1$：将牌 $i$ 放入栈 $n$；再执行操作 $2$：消除栈 $s_i$ 和栈 $n$ 的栈底两张相同种类的牌。

上面的策略会保证：**任意时候任意一个栈中最多只有 $2$ 张牌，且从牌堆中新拿一张牌时一定会存在空栈。栈顶的牌在栈顶直接消除，栈底的牌利用空栈消除。**

### 在部分分 $n=2$ 中，将 $k=2n-1$ 转化为 $k=2n-2$

$k=2n-1$ 相比于 $k=2n-2$ 多了一种牌。设当前第一个栈已经有 $2$ 张牌，**栈底的牌的种类为 $x$，栈顶的牌的种类为 $y$**，第二个栈为空栈。

如果将多出的这种牌放入空栈（第二个栈），可能导致空栈被占用而不能消除第一个栈的栈底的牌；如果将其放入第一个栈，可能导致第一个栈有 $3$ 张牌，不能消除中间的牌。我们把**多出的这种牌称为第 $3$ 者**。

从简单入手，设想一种很美好的情况：牌堆中第 $3$ 者后面全是 $y$。那么我们只要把第 $3$ 者放入空栈，$y$ 在栈顶直接消。这种情况显然不可能。因为当前第一个栈中已经有 $x$，所以**第 $3$ 者后面一定会存在 $x$**。

欸～是不是我们可以一次性对**牌堆中从当前的第 $3$ 者到第一张 $x$** 进行处理，处理完后将局面转化为 $k=2n-2$ 时的情况呢？可以！

1. 若牌堆中从第 $3$ 者到第一张 $x$ 的情况是 `3 x`：先执行操作 $1$：将第 $3$ 者放入第一个栈；再执行操作 $1$：将 $x$ 放入第二个栈；再执行操作 $2$：消除第一个栈和第二个栈的栈底两张相同种类的牌。
2. 若牌堆中从第 $3$ 者到第一张 $x$ 的情况是 `3 y y x`：先执行操作 $1$：将第 $3$ 者放入第二个栈；再执行操作 $1$：将 $y$ 放入第一个栈，并自动消除第一个栈最上方的两张相同种类的牌；再执行操作 $1$：将 $y$ 放入第二个栈；再执行操作 $1$：将 $x$ 放入第一个栈，并自动消除第一个栈最上方的两张相同种类的牌。此时空栈变成了第一个栈。

对于其他情况（从第 $3$ 者到第一张 $x$ 中有若干个 $3$ 和 $y$），可以把**多余的** $3$ 放在第二个栈的栈顶**消除**，把多余的 $y$ 放在第一个栈的栈顶消除，将**最后一张** $3$ 或 $y$ 学习上面两种情况的讨论进行类似的处理，具体细节见代码。

### 将部分分 $n=2$ 推广到正解 $n\le 300$

类似地，我们可以一次性对牌堆中从当前的第 $3$ 者到第一张栈底的牌（设该栈为 $s$，该栈的栈底的牌为 $s_x$、栈顶为 $s_y$）进行处理，处理完后将局面转化为 $k=2n-2$ 时的情况。

容易发现在牌堆从第 $3$ 者到第一张 $s_y$ 中我们只需要关心三种牌：$3,s_x,s_y$。因为**其他的牌都是其他栈的栈顶的牌，可以直接在他们各自的栈的栈顶直接消除**。现在我们仅需要利用栈 $s$ 和空栈对牌 $3,s_x,s_y$ 进行处理，发现这就是 $n=2$ 时的情况。

注意特判 $n=1$ 时的情况，此时没有空栈。

理论时间复杂度：$O(S)$。考场上为了代码方便，我写的是 $O(NS)$ 的代码。

具体代码见[剪贴板](https://www.luogu.com.cn/paste/l3cramtm)。

###### 后记

本题有一定的构造思维难度，但是又配之以大模拟，导致考场上想出 T2 构造思路的同学深陷大模拟；考场上对 T2 没思路的同学反而无形中被帮了一把，去写更划算的 T3 了。