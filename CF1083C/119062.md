由于权值是一个排列，所以对于一个集合 $S$，想要凑出集合 $S$ 中数字的极小的链，是唯一确定的。注意这是指 $S$ 是链所包含权值集合的子集。

那么求解 mex 的最大值，可以二分答案 $mid$，判断区间 $[l,mid]$ 是否可以找的这样一个链。

不妨使用线段树，$[l,r]$ 节点维护两个端点 $a,b$，表示当 $S = [l,r]$ 时，链两端点是啥。

发现由于极小的链唯一确定，两个区间是容易合并的。即判断左右儿子是否可以合并成一条新链。

那么有 4 个节点，新链必须包含至少两个其中的节点。（保持极小的性质）

那么枚举 6 种情况判断剩下两个是否在其形成的链上。

这样可以 $O(k \log n )$ 得到一个区间是否可以全部填充。$k$ 是合并复杂度，大搞是 $6\log n$ 的级别。（或者 RMQ $O(1)$ LCA 能做到更优复杂度，但是可能跑不过树剖 LCA？）

这下上述二分过程就可以执行了。 这里使用线段树上二分就可以再去掉一个 log。

交换点权是 simple 的，线段树做两次单点修改。

时间复杂度 $\mathcal{O}((n+q)k\log n)$。