*3300

题和题解都很 der，但是我实力不到 *800，**实力是远低于这道题的，记录一下是有必要的**（见昨晚比赛![](https://cdn.luogu.com.cn/upload/image_hosting/t41xgunq.png)

------------

先解决翻译问题：给你长为 $n,m$ 的两个数列 $a,b$，初始有个值为 $k$ 的计分板。

设 $c$ 一个长为 $n+m$ 的数列，$c$ 中每个数**恰对应 $a,b$ 中的某个数**，令 $d_i$ 为第 $i$ 个数原本属于哪个数列。

依次往计分板中加入数 $c_i$，计分板增加 $c_i-c_{i-1}$ 的权值（可负），**初始有 $c_0:=c_1$ 避开边界情况**。

**计分板始终对 $0$ 取 $\max$，设第 $i$ 个数加入后计分板为 $v_i$，形式化的有 $v_i=\max{(0,v_{i-1}+c_i-c_{i-1})}$。**

在加入 $c_i$ 这个数时，会对 $d_i$ 这个数列产生 $v_i$ 的贡献，设最终的贡献分别为 $W_a,W_b$。

求 $c$ 的所有情况中 $W_a-W_b$ 的最大值。

支持操作：单点修改 $a,b$，给定 $k$ 进行询问。

------------

解法一：手玩，需要比较好的感觉。

首先不考虑支持修改，先手玩一下这个询问。

一秒会做 $k=0$ 的情况，即先倒序的把 $b$ 数列放完，使得 $b$ 的贡献全部没有，$W_b=0$，然后再升序的放 $a$ 数列，可以使得贡献最大。

为了方便默认 $a,b$ 按从小到大排好了序，有：

$$sum=W_a-W_b=W_a=\sum_{i=1}^n(\max(0,a_1-b_1)+a_i-a_1)$$

考虑 $k$ 有值会发生什么变化，首先倒序的把 $b$ 数列放完然后再升序的放 $a$ 数列的策略仍然是我们的优选方案之一。

也即上式加上 $k$ 的贡献，由于要考虑 $b_1\to a_1$ 处的转折，为了方便定义 $M=\min(a_1,b_1)$：

$$sum=W_a-W_b=-\sum_{i=1}^m\max(0,k-(b_n-b_i))+\sum_{i=1}^n(\max(0,k-b_n+M)+a_i-M)$$

发现唯一的可能性就是我们单独拎出一个 $a_x$ 垫在所有的 $b$ 前面，剩下的数同上策略的相对顺序不变。

感性理解一下如果多拎了一个出来把两个中大的那个放回 $a$ 去贡献更大。

于是我们考虑放哪个 $a$ 的得到最优的答案，直接列式：

$$sum=W_a-W_b=k-\sum_{i=1}^m\max(0,k-(a_x-b_i))+\sum_{i=1}^n(\max(0,k-a_x+M)+a_i-M)-(\max(0,k-a_x+M)+a_x-M)$$

考虑维护上述两式的最大值，第一式是简单的，每次改变量 $O(1)$ 整个式子也可以 $O(1)$ 的计算。

第二个式子不太一样，因为有一个变量 $a_x$，考虑按 $a_x$ 为主元归类，有：

$$sum=(-a_x+M)+(n-1)\max(0,k-a_x+M)-\sum_{i=1}^m\max(0,k-a_x+b_i)+k+\sum_{i=1}^na_i-M$$

单调的考察 $a_x$ 变化时的贡献，发现 $a_x$ 的系数一来是 $m-n$，然后会先遇到 $k+M$ 加一个 $n-1$ 变成 $m-1$，后来遇到一个 $k+b_i$ 就减一，直到走过 $b_n$ 变成 $-1$。

故第二式最优值的取值可能为：

- $m<n$ 时：$a_x=a_1$。
- 考虑从 $m-1\to -1$ 的峰，显然是斜率为 $0$ 的段 $[b_{n-1},b_n]$ 内的 $a_x$，若没有则找前后，即维护 $a_x$ 为 $b$ 次大/最大前驱后继的值即可。

$O(1)$ 改变量显然也能维护。

------------

解法二：理性理解。

考虑数列 $c$，先不考虑数列 $d$，即先考虑每个数的贡献而不考虑贡献到了哪里。

发现 $c_1$ 的存在很不利于我们的计算，于是单独拎出来，有这样的公式：

$$v_i=k+c_i-c_1+\max(0,c_1-k-\min_{j\le i}c_j)$$

另外两篇题解都是这种做法然而在这**关键一招**上没解释清楚，实际上可以这样理解：

我们令 $w_i=v_i-c_i$，那么 $v_i=\max{(0,w_{i-1}+c_i)},w_i=v_i-c_i$，考虑维护 $w_i$，就是加上 $c_i$ 后和 $0$ 取个 $\max$ 再减回来。

如果 $c_i$ 抬高了显然碰不到 $0$ 这个位置，于是抬的最低的那次显然决定了当前 $w_i$ 的值。

初始有 $w_0=k-c_1$ 可以使得 $v_1=k$，于是 $w_i=w_1+\max{(0,0-w_1-\min_{j\le i}c_j)}$，即考虑抬 $c_i$ 最低的那次对 $w$ 的贡献，将 $v_i$ 代回此式子即得到上述公式。

发现当 $c_1$ 定了 $v_i$ 就只与自己的 $c_i$ 和在它前面的数有关了，考虑当 $c_1$ 确定时其他数该如何确定 $c_i,d_i$。

首先 $d_i=b$ 的贡献要最少，而 $-\min_j{c_j}$ 不减，于是将它们都放在前面，而为了让 $-\min_j{c_j}$ 小显然倒序放即可。

考虑让剩下的 $d_i=a$ 的贡献尽量多，显然先把最小的 $a$ 放了即可（为了不和我的手玩矛盾可以看作正序放qwq，实际上也可以发现对推式子没有任何影响

然后就根据这个列式即可，和上述手玩出来的式子一模一样，分析斜率即可得到 $c_1$ 的选择在哪里最优。

两种方法的理解过程不同，哪种好想也不好说，你看我就是解法一推了大半找题解的解法二验证了自己的想法。

实际上推其他题解的 $g$ 的式子会得到和手玩一样的发现：直接取最大的 $b$ 当 $c_1$ 即可。