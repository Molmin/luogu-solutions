### 题意

给你一个长为 $n$ 的非负整数序列 $a$，求有多少区间 $[l,r]$ 满足 $\text{popcount}(\max\limits_{i=l}^r a_i)=\text{popcount}(\min\limits_{i=l}^r a_i)$。

$1\le n\le 10^6,0\le a_i\le 10^{18}$。

### 题解

因为 $\text{popcount}$ 和 $\max/\min$ 没有多大关系，所以可以把 $\text{popcount}(a_i)$ 看成 $i$ 的颜色 $b_i,0\le b_i\le 59$。

对每个位置求出 $a_i$ 作为 $\max$ 时向左右最多可以控制到哪个位置，记为 $l_{1_i},r_{1_i}$，表示任意区间 $[x,y]$ 满足 $l_{1_i}\le x\le i,i\le y\le r_{1_i}$，都有 $\max\limits_{j=x}^y a_j=a_i$。对于相同的 $a_i$ 可以用下标比较，总之不能重复。

把每个区间看成二维平面上的点，$\forall i\in[1,n]$，$a_i$ 控制的矩形是 $[l_{1_i},i]\times [i,r_{1_i}]$，把这个矩形染成 $b_i$ 的颜色。容易发现一个区间对应唯一的最小值，所以这个二维平面的上三角矩形恰好每个位置被染了一次色。

对于 $\min$ 同样处理求出 $l_{2_i},r_{2_i}$，再染一次色。

问题转化成 $2n$ 个矩形染色操作，保证上三角矩阵恰好染两次色，求有多少个位置染色相同。

对每种颜色分别进行扫描线，矩形加 $1$，求出有多少个位置权值为 $2$。答案就是所有颜色加起来。

求所有的 $l_{1_i},r_{1_i},l_{2_i},r_{2_i}$ 可以用单调栈做到线性时间，扫描线复杂度 $O(n\log n)$。

总时间复杂度 $O(n\log n)$。本题略微卡常，请合理使用 `fread`。

[code](https://codeforces.com/contest/1609/submission/137319742)