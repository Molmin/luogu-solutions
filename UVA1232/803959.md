该题的核心就是区间取 $\max$。

由于这题保证了答案不超过 $2\times10^6$，所以暴力是可以做的。

但是若抛开该限制，在线段树上暴力做的复杂度肯定是不正确的，可以被锯齿状数据卡掉。

我们在线段树上维护最小和严格次小值（下文简称次小值），还有最大值的出现次数，记 $x$ 为此次修改的 $\max$，每修改到一个线段树上完全覆盖的节点时，有这样三种情况：

$1.$若最小值大于 $x$，则直接退出。

$2.$若最小值小于等于 $x$ 且次小值大于 $x$，则将最小值改为 $x$，打上标记，并将答案累加最小值出现的次数。

$3.$若次小值小于 $x$，则暴力递归子节点修改，然后合并子节点信息。

看上去复杂度不太对，但是我们用势能分析一下，可以粗略的分析出复杂度上界。

设势能函数为区间中每个节点不同数的个数，每次在线段树上找到 $\log$ 个区间最多使 $\log$ 个节点的势能函数 $+1$，最多下传标记 $\log$ 次，所以一次操作增加的势能函数是 $\log$ 级别的，在节点上按照 $3$ 情况递归下去会使势能函数 $-1$，所以复杂度上限就是 $O(n\log n)$ 的。

代码就先不给了。