讲一个详细的选段树方法。

我们令 $S_i$ 表示高度 $i$ 中有 $S_i$ 个船帆，那么答案就是 $\sum\limits_{i=1}^n{\dfrac {Si \times (S_i - 1)}{2}}$。

很容易想到一个正确的贪心：每次都给 $S_i$ 最小的值加上船帆，即让 $S_i$ 的分部尽量均衡。

显然这个和杆的顺序没有排序，那么我们先把每个杆子对 $h_i$ 排序。每次我们都需要在 $1 - h_i$ 中找到前 $k_i$ 小的 $S_i$ 并对他们 $+1$，然而这样的时间复杂度是过不去的。

每次找最小是很麻烦的，我们考虑直接让 $S_i$ 降序。举个例子：当 $\{ S \} =\{ 5,4,3,3,3,2,1 \}$，$h_i = 7$，$k_i=3$ 的时候，$\{ S' \} =\{ 5,4,4,3,3,3,2 \}$ ，与原来相比，只有两段内容改变了。

那么具体的操作是这样的：对于每个 $h$ 与 $k$，先找出 $S_{h-k+1}$ 的值 $p$，再找到 $p$ 出现的范围 $l,r$（即 $S_{l-1} \ne S_l = S_{l + 1} = … = S_{r} \ne S_{r+1}$），那么显然，只要让 $[r+1,h]$ 与 $[l,l + k -h +r-1]$ 这两段都 $+1$ 就可以了。

然后用线段树维护即可。

[code](https://www.luogu.com.cn/paste/c7dkaxlw)。