我们从后往前推，维护 $f_i$ 表示 $i$ 元素能生存到什么时间。那么一个 $t$ 时刻的操作 $[L,R]$ 相当于令：
$$
\forall i\in(L,R],a_i\leftarrow t\\
a_L\leftarrow \max_{j\in[L,R]}a_j
$$
发现 $f$ 的连续段个数的总和只有 $O(n)$ 级别，所以我们可以用 set 来暴力维护这些连续段。在维护 set 的同时，维护一个树状数组，维护每个时间消失的元素个数，就能在树状数组上 $O(\log n)$ 进行一次查询了。