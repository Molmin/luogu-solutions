推销[博客](https://www.cnblogs.com/HaHeHyt/p/17316432.html)，第八题。

自己已经想出一大半了，可还是没切。下面设数 $i$ 的位置为 $w_i$。

首先容易想到先只取 $n-1$ 个数，考虑如果返回了 $1$，则 $n-1\mid \dfrac{n(n+1)}{2}-x$，由于 $\dfrac{n}{2}\in\mathbb{Z}$，于是 $x\equiv 1\pmod {n-1}\Rightarrow x=1\ \text{or}\ n$。

于是找出这两个返回值为 $1$ 的，随便钦定一个位置为 $1$ 另一个为 $n$ 即可。

类似的，如果我们知道了 $1,2,\dots,k,n-k+1,\dots n-1,n$，那么我们>可以 $n$ 次询问知道 $k+1,n-k$ 的位置，设为 $fi,se$。

显然 $k+1,n-k$ 的奇偶性不同，于是我们询问 `? w[1] fi` 即可知道 >$fi$ 位置的奇偶性，进而推出 $p_{fi}$，$p_{se}$ 就是另一个了。

这样询问次数是 $O(n^2)$ 的，在 $n\le 18$ 时可以通过。[代码](https://codeforc.es/contest/1299/submission/210012228)。

---

考虑 $\text{CRT}$，我们想选取最优的模数集使得 $\text{lcm}\ge 800$，显然取 $S=\{3,5,7,8\}$。

按照上面的做法，我们可能会知道 $A=\{1,2,\dots,k,n-k+1,\dots,n\}$ 集合中的数的位置。

我们要求 $\forall\ 3\le p\le 8,0\le i<p,\exists\ k-1$ 个 $A$ 中的数使得它们的和模 $p$ 为 $i$。

发现取 $k=5$ 是最小满足要求的，举个 $p=8$ 的例子：

由于 $\{1,2,3,4,n-4,n-3,n-2\},\{1,2,3,4,n-4,n-3,n-1\},\{1,2,3,4,n-4,n-3,n\},\{1,2,3,4,n-4,n-2,n\},$

$\{1,2,3,4,n-4,n-1,n\},\{1,2,3,4,n-3,n-1,n\},\{1,2,3,4,n-2,n-1,n\},\{1,2,3,5,n-2,n-1,n\}$

这 $8$ 个集合两两差 $1$，于是它们两两模 $8$ 不同，符合要求。其他 $p$ 类似取。

对于还没有确定的**位置** $i$，对于所有 $p\in B$，我们询问这些集合和 $i$，如果返回值为 $1$ 则能确定 $p_i$ 模 $p$ 的值。对于每个模数 $p$ 只需询问 $p-1$ 次，如果还没有返回值为 $1$ 的也能唯一确定余数。

最后做一下 $\text{CRT}$ 即可，由于 $a$ 是一个排列，于是 $p$ 大约平均询问 $\dfrac{p}{2}$ 次。由于初始要询问 $5n$ 次，于是总次数大约为 $(\dfrac{3+5+7 +8}{2}+5)\times n=16.5n$ 次。

实际次数显然比这个大得多，但是[足以通过](https://codeforc.es/contest/1299/submission/210020392)。（魏老师算的是 $17.7n$，看不懂）

---
优化：模 $8$ 的时候可以倍增。对于位置 $i$，先进行 $n$ 次求模 $2$ 的值。

若是奇数，则询问 `? i w[1] w[2] w[4]` 即可知道模 $4$ 余 $1$ 还是 $3$。

偶数则询问 `? i w[1] w[2] w[3]` 即可。

然后再分类 $\equiv 0,1,2,3\pmod 4$ 类似询问即可知道模 $8$，这样每个 $i$ 能**稳定** $3$ 次询问出模 $8$。

估计次数为 $16n$ 次，测试数据中最大次数在 $12000\sim 13000$ 之间。[代码](https://codeforc.es/contest/1299/submission/210017530)。