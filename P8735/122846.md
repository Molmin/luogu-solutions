设 $f_{n}$ 为最后一步长度小于 $k$ 的，总长度为 $n$ 的方案数；设 $g_{n}$ 为最后一步长度大于等于 $k$ 的，总长度为 $n$ 的方案数。那么有：
$$
\begin{aligned}
&f_{n}=\sum_{i=1}^{k-1}f_{n-i}+g_{n-i}\\
&g_{n}=\sum_{i=k}^{p}f_{n-i}
\end{aligned}
$$
我们要求的就是 $f_{L}+g_{L}$。

下面的式子带入上面的式子：
$$
\begin{aligned}
f_{n}=\sum_{i=1}^{k-1}(f_{n-i}+\sum _{j=k}^{p}g_{n-i-j})\\
\end{aligned}
$$
显然 $f$ 满足 $k+p$ 阶线性递推。至于 $g$，可以用递推式分解成 $O(p)$ 个 $f$，这样套用[常系数线性齐次递推的模板](https://www.luogu.com.cn/problem/P4723),就有了一个 $O(p(p+k)\log L\log (p+k))$ 的做法。

上述做法的瓶颈在于 $g$ 的解决是依靠解决很多个 $f$ 来暴力用定义式解出，再观察到递推式中的和式都是连续的下标，于是把 $f$ 和 $g$ 的定义改成原来的前缀和。递推式变为：

$$
\begin{aligned}
&f_{n}-f_{n-1}=f_{n-1}-f_{n-k}+g_{n-1}-g_{n-k} \\
&g_{n}-g_{n-1}=f_{n-k}-f_{n-p-1}
\end{aligned}
$$


目标是 $f_{n}-f_{n-1}+g_{n}-g_{n-1}=f_{n}-f_{n-1}+f_{n-k}-f_{n-p-1}$，相当于求 $4$ 个 $f$ 的单项，套用之前提到的模板即可在求出前 $p+k$ 项之后在$O((p+k)\log L\log (p+k))$的复杂度内求出任意单项，而修改后的递推式在同时递推 $f$ 和 $g$ 时可以做到单项 $O(1)$（运用上面的递推式）。

总复杂度 $O((p+k)\log L\log (p+k))$

PS：注意到模数不是NTT模数，在使用线性递推的模板时需要使用任意模数的NTT。