这道题的子任务有很大的启发性，故可以从子任务入手。

首先交换次数就是逆序对。

对于 B 性质，相当于是确定了一些位置的值，然后其它位置的值不确定，要使逆序对最小。那么对于所有不确定位置，**它们的值一定是不降的**。因为如果存在两个 $i,j$ 满足 $a_i>a_j$，则交换 $a_i,a_j$ 显然会使答案变小。这说明了不确定位置间是不会贡献逆序对的，也就意味着**每个位置填什么都可以独立决策**（与其它不确定位置填什么无关），对于每个位置我们直接选择一个代价最小的填入即可。

对于 A 性质，序列中一定只可能填 $0$ 或 $1$。对于限制 $(l,r,1)$ 说明了这个区间中全是 $1$，而对于限制 $(l,r,0)$ 则说明区间中至少要有一个 $0$，现在要使逆序对尽量小，我们可以用贪心解决：先把那些一定是 $1$ 的位置填上，考虑对于最终的序列，一个 $0$ 的贡献是左侧 $1$ 的个数。故我们可以把所有限制 $(l,r,0)$ 按照左端点从大到小排序，如果当前限制区间中已经有 $0$，则这个限制就合法了；如果没有 $0$，那么把区间中**最靠左的一个还没填的数**填成 $0$ 一定最优（感性理解：因为这样既可以让后面的限制区间尽可能包含 $0$，也可以让这个 $0$ 的贡献尽量小）。这样就已经满足所有限制了，现在还剩下一些位置可以任意填，要使逆序对最小。这就回到了 B 性质。

然后考虑原问题，我们把所有限制区间按照 $v$ 从大到小依次处理。对于最大的 $v$，显然这些限制涉及到位置的值就是 $v$。假设现在处理到 $v=i$，则我们把所有 $v=i$ 的限制拿出来，按照左端点从大到小排序，对于当前限制 $(l,r,i)$：

- 若 $[l,r]$ 中已经有一个数是 $i$，则可以忽略。
  
- 若 $[l,r]$ 中还没有数是 $i$，则要填一个。与性质 A 相同，我们填 $i$ 的位置要尽量靠左。所以我们就将 $i$ 填在最靠左的**没有被任何 $v$ 大于 $i$ 的限制覆盖**的位置，具体实现时可以用并查集。
  

于是现在就满足了所有限制，然后要对其它未确定的位置填数，使得逆序对最小。与性质 B 不同的是，这里对于未确定的位置增加了一个**下界**，这使得问题变得比性质 B 更加复杂，因为上文中“不确定位置不降”的性质就没有了。

我们记一个序列 $b_i$，若 $i$ 已经确定了，则 $b_i=a_i$，否则 $b_i$ 为 $i$ 位置的下界。

考察两个未确定的位置 $i,j$ （$i<j$）（这一部分讨论画个图会更清晰）：

- $b_i\leq b_j$，则一定有 $a_i<a_j$。因为如果 $a_i>a_j$，交换后依然满足下界且答案更优。
  
- $b_i>b_j$：
  
  1. 若 $a_j\geq b_i$，则一定有 $a_i<a_j$。因为如果 $a_i>a_j$，交换后依然满足下界且答案更优。
    
  2. 若 $b_j\leq a_j<b_i$，则一定有 $a_i>a_j$（显然），会产生 $1$ 的贡献。注意这里 $1$ 的贡献只和 $a_j$ 的取值有关，故我们把它看作 $j$ 的贡献。
    

这里的讨论说明了**对于一个未确定位置，它与其它位置的贡献只和自己的取值有关**，和其它不确定位置具体取什么值无关，于是可以对每个位置独立决策。

具体来说，我们从小到大遍历每一个不确定的位置 $i$，并维护数组 $c_x$ 表示当 $a_i=x$ 时会产生多少贡献，考虑 $c_x$ 应该怎么得到：

- 若 $a_j$ 已经确定且 $j<i$，则 $c_{[1,a_j-1]}$ 加 $1$。
  
- 若 $a_j$ 已经确定且 $j>i$，则 $c_{[a_j+1,inf]}$ 加 $1$。
  
- 若 $a_j$ 未确定且 $j<i$，则 $c_{[1,b_j-1]}$ 加 $1$。
  
- 若 $a_j$ 未确定且 $j>i$，此时的贡献与 $a_i$ 的取值无关，在 $j$ 处计算。
  

然后把 $c$ 中值最小的一项的下标填入 $a_i$ 即可，这里的 $c$ 可以用一棵线段树维护。

时间复杂度 $O(n\log n)$。