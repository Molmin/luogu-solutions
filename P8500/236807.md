对于所有长度为 $n$ 的满足下列条件的序列 $a_{1 \dots n}$，求逆序对数最小值。

- $\forall 1 \le i \le m, \min_{j = L_i}^{R_i} = V_i.$

多测，$\sum n, \sum m \le 10^6$。

---

容易看出，一定有一个逆序对数最小的合法序列，$\forall i, a_i \in V$，其中 $V$ 为所有 $V_j$ 构成的集合。于是我们可以将 $V_i$ 的值域离散化到 $[1, m]$ 中。

首先，这些条件对每个给出了下限，记为 $b_{1 \dots n}$。考虑钦定一些位置取到下限，使得条件被满足。

一个简单的考虑是：如果最终的 $a$ 中存在一个逆序对且可以交换，那么交换必然不劣。所以若只考虑一个条件，则我们可以直接找到最靠左的一个 $b_j = V_i \pod{L_i \le j \le R_i}$，并钦定 $a_j = b_j$；若无法找到合法的 $j$，那么无解（容易看出，这里对无解的判定是充要的）。

这个结论可以容易地扩展到多个条件的情况：先按照 $V_i$ 将条件分类，每一类内部按 $L_i$ 从大到小的顺序枚举条件；枚举到一个条件 $(L_i, R_i, V_i)$ 时，我们考虑是否已经有一个 $L_i \le j \le R_j \land b_j = V_i$ 的 $j$ 被钦定，若没有，则找到最小的 $j$，钦定 $a_j = b_j$。

于是，我们将条件转化为：分别给定一些位置的取值；并分别给定其余位置的下限。我们将给定取值的位置称为 A 类位置；给定下限的位置称为 B 类位置。

---

A 类位置内部的逆序对数是确定的，只需要最小化含 B 类位置的逆序对数目。

将填写视作插入，维护一个序列 $c_{1 \dots m}$ 以及一个指针 $p$，$c_i$ 表示当前若在 $p$ 处填写一个 $i$，与已经确定或填好的位置之间所产生的代价。初始时，$p$ 指向 $1$ 位置前，对于每个 A 类位置 $i$，将 $c_{b_i + 1 \dots m}$ 分别 $+1$。我们将 $p$ 向后移动，来填写 $a_{1 \dots n}$。

考虑如何跳过一个 A 类位置 $p$。这是容易的，将 $c_{1 \dots a_p - 1}$ 分别 $+1$，将 $c_{a_p + 1 \dots m}$ 分别 $-1$ 即可。

若填完一个 B 类位置 $p$，则我们应将 $c_{1 \dots a_p - 1}$ 分别 $+1$。

我们发现，若在 $p$ 处填 $x$ 不优于填 $y \pod{x < y}$，则此后无论如何 $x$ 都不会优于 $y$。这启发我们考虑贪心。

对于一个 B 类位置 $p$，我们的所有决策对 $c_{1 \dots b_p - 1}$ 的影响都是一致的（$+1$）。考虑直接选择一个最小的 $c_x$，令 $a_p = x$。由于填写 $b_p \dots x - 1$ 均不优于填 $x$，故将 $c_{b_p \dots x - 1}$ 分别 $+1$ 是不会影响此后的填写工作的。于是我们填写一个这样的 $x$ 是不劣的。

---

整理一下做法。

首先确定每个位置的下限。从右往左考虑限制，若当前限制可能不满足，则在区间内钦定一个尽量靠左的合法（指下限与当前限制的 $V_i$ 相同）位置取到下限，若区间内不存在合法位置，则无解。

然后考虑填写未钦定好的位置 $p$。仅考虑当前已经钦定好或填好的位置与 $a_p$ 之间的贡献即可。

时间复杂度 $O((n + m) \log (n + m))$。

---

考场上 12:30 会了这个做法，没写完。

代码可以找我要。