被卡空间了，又不想换写法，就记录一下。

代码咕了，下次一定。

## 解法一：线段树分治

虽然题目给的是像可持久化一样版本继承的样子，我们可以轻松的建出操作树而在将问题转化到树形结构上。

考虑一个星球，如果没有删除作用的是一个子树，容易想到在 DFS 序上作用一个区间。

再考虑删除，发现是在一个连通块内挖掉一个子树，也就是把 DFS 序上的一个区间挖掉中间一个小区间。

不难发现相当于将作用于一个大区间改为作用于两个分开的区间。

于是一个星球作用于 $t_i$ 个不交区间，有 $\sum t_i=n$。

对于这种作用于区间的问题套路的考虑线段树分治，考虑题目的询问，贪心一下 $y,z$ 两维都为 $0$ 最优，此时花费为 $(x-x_i)^2+c_i=x^2-2xx_i+x_i^2+c_i$。

这个贡献有两种看法，一种就是将 $-2x_i$ 看作 $k$，$x_i^2+c_i$ 看作 $b$，就是很多条 $y=kx+b$ 的直线在 $x$ 处的最小取值，上李超树。

另一种是将 $(x_i,x_i^2+c_i)$ 看作点，$2x$ 看作直线的斜率，要求 $b=y-kx$ 的最小截距，用下凸壳。

而放到线段树分治上，第一个就是可持久化李超树，支持回退即可，第二种在每个**线段树分治区间**上都维护一个凸壳。

由于我们插入区间的顺序任意，回答询问的顺序也只是按照线段树分治的顺序回答，没有任何特殊性质，两种方法都需要 $O(\log)$ 来实现每个操作。

即每个插入 $O(\log)$，每次回答询问 $O(\log)$。

由于线段树分治会将区间拆为 $O(\log)$ 个，故时间复杂度 $O(n\log^2n)$。

空间复杂度来看，凸壳是线性空间不必多说，而线段树分治的结构使得我们每次只用维护当前到某个叶子的一条链，所以李超树只要在回退时回收空间能做到和凸壳一样的空间 $O(n\log n)$。

按理来说这个做法应该卡常，时间不好卡进去，实际上李超树空间极易爆炸，我没有隔壁位域的高端技巧就寄了。

## 解法二：标记永久化线段树

首先明确一点：最好的线段树式拆分区间法解决此问题都会使得区间个数为 $O(\log)$，这里区间的解决必须带个 $\log$。

注意这里说的不是线段树分治，只是这种一类这种结构解决区间问题的办法，也就是线段树结构去拟合区间的这种拆分方式。

李超树是个神奇的算法，不管怎么搞插入询问都是 $O(\log)$，再特殊的顺序都做不到 $O(1)$。

但凸壳不一样，像线性斜率优化的做法一样，我们使 $x$ 递增就可以使用单调队列均摊 $O(1)$ 插入维护凸壳，同时让斜率单增就可以用指针均摊 $O(1)$ 解决询问。

再回到这道题需要解决的问题，发现凸壳的维护并不依赖线段树分治的顺序，反而只是像一般的线段树结构一样在拟合到的线段树区间上插入点。

这种一般的线段树，不依赖下放信息而直接在区间节点上维护信息的方法，通常被大众称之为标记永久化的线段树。

于是我们使用这种线段树而非线段树分治解决这个问题即可，在插入时保证 $x$ 的递增做到线性，询问时保证 $k$ 的递增也能做到线性，最后在 $O(n\log n)$ 的时间内得以解决。

凸壳空间复杂度不变，仍为 $O(n\log n)$。