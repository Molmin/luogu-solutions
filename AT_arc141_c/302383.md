很好的一道题。

首先对原括号序列画折线图，具体方法就是如果是左括号就往上走，否则就往下走。试想，如果整根线一直都在水平线上方，那么一定存在一个序列 $1,2\dots n$ 是合法的，也就是说此时数组 $p$ 也一定等于这个值。

然而事实不总是这样的，这是因为折线图还有低于水平线的部分，对于这部分容易想到在此之中左右括号数量相等（这样才能刚好升到水平线上），所以策略是找第一个左括号然后找第一个右括号，交替进行直到把折线又拉回到水平线上为止。

所以我们得到了一个非常重要的结论，如果 $p_{2i}<p_{2i-1}$ 的话，那么 $p_{2i}$ 对应的位置应该是左括号，$p_{2i-1}$ 对应的位置应该是右括号。同理，会发现数组 $q$ 决定的是水平线以上的部分，两个部分合并起来应该就是完整的数组，所以如果看到重合或者未覆盖的地方就说明不存在合法解。最后求出答案之后验证一次就可以了。

复杂度可以做到线性。