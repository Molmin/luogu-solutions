方便起见，下面用 **价值** 来指代英文题面中的 *value*。

**观察 1** 一棵大小为 $n$ 的树，其根节点的价值不超过 $\lfloor\log_2 n\rfloor$。

**证明** 设 $a_i$ 为根节点价值等于 $i$ 的树的最小节点数。注意到这样的树必然有价值分别为 $0,1,...,(i-1)$ 的子树，因而 $a_i\geq 1+a_0+a_1+\cdots +a_{i-1}$。可以计算得到 $a_i=2^i$，因而得证。

-----------------

我们先离线读入整棵树的形态。本题涉及到树上单点信息的更新以及全局的维护，考虑用树链剖分来解决这个问题。我们对树作轻重链剖分，将每个节点 $u$ 的权值设为其重儿子权值的函数 $v_u=f_u(v_{\mathrm{son}_u})$，其中 $f_u$ 只跟 $u$ 的各个轻儿子的权值有关。注意到 $f_u$ 要么是一个常函数，要么是只在某点处取值不同的函数，因而其复合也可以简单维护。时间复杂度 $O(n\log^2 n)$。