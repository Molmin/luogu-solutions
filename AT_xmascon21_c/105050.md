### 前言

zaky 给我们布置的作业题。![/fad](https://akioi.ml:2022/static/img/qq/fad)![/fad](https://akioi.ml:2022/static/img/qq/fad)![/fad](https://akioi.ml:2022/static/img/qq/fad)

导出双射后，这题就没什么难点了啊！bijective problem 还是太困难了一些。

### 思路

假设我们不考虑 `?`，则有 key observation：

> 把 `0` 看作小于号，`1` 看作大于号，即为将 $0\sim n$ 填入使此不等式组的合法的方案数，也即[「LibreOJ NOI Round #2」不等关系](https://loj.ac/p/575)。

证明？~~我不会我不会。~~

其实可以考虑强制令 `0` 段满足先删后面的，`1` 段先删前面的，填的数表示删除时间。容易验证这是一个合法的双射。

那么的话，`?` 就相当于不做限制，可以把两侧分开处理，最后组合数分配标号。

因此只用考虑只有大于、小于号的情况。

以下即为对「LibreOJ NOI Round #2」不等关系的分析。

考虑容斥。

我们把某处为 $>$ 的答案当作此处不做限制的答案减去此处填 $<$ 的方案数。

我们称 $p$ 处为 $>$ 为 $a_p=1$，否则 $a_p=0$。

我们假设 $f_m$ 表示已经考虑了前 $m$ 个符号的方案数，初始时 $f_0=1$。

dp 时，我们考虑枚举上一项选择为不做限制的位置，得

$$f_m=(-1)^{\sum_ja_{m-j}}+\sum_ka_{m-k}(-1)^{\sum_{j<k}a_{m-j}}\binom{m+1}{k+1}f_{m-k-1}$$

化一下柿子，我们设 $b_m=\sum_ja_{m-j}$，即为

$$
f_m=(m+1)!(-1)^{b_m}(\frac{1}{(m+1)!}+\sum_k\frac{a_{m-k}(-1)^{b_{m-k}}f_{m-k-1}}{(m-k)!(k+1)!})
$$

也即

$$
\frac{f_m}{(m+1)!(-1)^{b_m}}=\frac{1}{(m+1)!}+\sum_k\frac{a_{m-k}(-1)^{b_{m-k}}f_{m-k-1}}{(m-k)!(k+1)!}
$$

设 $g_m=\frac{f_m}{(m+1)!(-1)^{b_m}}$，即

$$
g_m=\frac{1}{(m+1)!}-\sum_k\frac{a_{m-k}}{(k+1)!}g_{m-k-1}
$$

显然是一个半在线卷积。

总复杂度即为半在线卷积的复杂度，朴素实现的复杂度即为 $O(n\log^2n)$，多叉分治实现的复杂度即为 $O(n\log^2n/\log\log n)$。

由于时限很足，可以轻松通过。

