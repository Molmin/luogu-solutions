~~很有趣。~~

转化为每个点的合法方案乘以其权值。

设 $F(n,k)$ 表示从 $n$ 个里面选 $k$ 个桶的方案，这个是容易计算的。另设 $G(n,k,i)$ 表示钦定选 $i$ 情况下再选 $k$ 个的方案，目标是求 $1 \le i \le n,G(n,k,i)$。

对于 $d\le i \le n-d+1$，$G(n,k,i)$ 等价于从 $n$ 个里面选 $k-1$ 个，并且不能选 $i-d+1,\dots,i+d-1$。等价于从 $n-d$ 个里面选 $k-1$ 个，并且不能选 $i-d+1,\dots,i-1$，为 $F(n-d,k-1)-\sum_{i-d+1\le j \le i-1} G(n-d,k-1,j)$。

对于 $i < d$ 和 $i>n-d+1$ 同理，只不过后面 $j$ 的范围稍有变化。

设 $V_t=(G(n-td,k-t,1),G(n-td,k-t,2),\dots,G(n-td,k-t,n-td))$，我们可以从 $V_t$ 利用上述公式逐步推到 $V_0$。

将 $V_t$ 化作形式幂级数 $V_t(x)=\sum _{i=1}^{n-td} G(n-td,k-t,i)x^i$。

那么 $V_{t-1}(x)$ 等于将 $V_t(x)$ 做如下操作：

1. 乘多项式 $\sum_{i=1}^{d-1} -x^i$。

2. 每一位加上常数 $F(n-td,k-t)$。

第二个操作考虑使用全局加法标记 $tag$ 实现，但是会导致多项式前 $d-1$ 和后 $d-1$ 项出现问题，考虑另外维护一个多项式表示当前每一位上与正确值的差值。

显然前 $d-1$ 项和后 $d-1$ 项相应的差值相等，所以只需要维护前 $d-1$ 项的差值，这样就可以分治合并多项式了，复杂度 $O(n\log n \log \frac{n}{d})$。