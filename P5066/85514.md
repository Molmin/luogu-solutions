原题传送门：[P5066 [Ynoi2014]人人本着正义之名](https://www.luogu.com.cn/problem/P5066)

### Upd:2019.4.21 
这道题目比赛的时候并没有将珂朵莉树（ODT）的30分调试过去，事后过了挺长时间才调过去的。

### Upd:2020.3.16 
时隔一年，学会了Fhq-treap之后奋战10h成功AC此题，代码就不放了，既怕有人copy，又怕有人hack。

## 解题思路：

~~珂学的题面布局~~

题目说的很清楚了，区间赋值，区间与或（每个位置同时操作无先后），区间求和。

### 30pts

我们发现 $n,m \leq 10^3$ ，暴力循环模拟即可，时间复杂度 $O(mn)$。

### 50pts

我们发现 $n,m \leq 10^5$ ，暴力循环模拟即可。为什么暴力跑不过去？因为你开的是int数组，换成bool，再开O2/快读就可以了，时间复杂度 $O(mn)$ 。

### 80pts

我们发现整个序列是一个 $01$ 序列，然后发现与或操作只会发生在一段 $0$ 连续段和一段 $1$ 连续段的交界处，于是考虑将一个相同颜色的连续段缩成一个点，然后操作是分裂操作即可，由于数据随机，使用珂朵莉树维护，但珂朵莉树会将一个连续段缩成的点分裂成两个点，循环操作时判断即可，在数据随机的情况下时间复杂度为 $O(m \log n)$ ，否则为 $O(mn)$ 。

### 100pts

我们发现数据范围为 $n,m \leq 10^6$ 且数据不随机，考虑使用时间复杂度在任何时候为 $O(m \log n)$ 的数据结构维护，考虑使用平衡树。

沿用部分分的思路，将一段相同元素的连续段缩成一个点来维护，但与珂朵莉树不同的是，我们要保证这个点是极长的，就是这个点的两个邻点必须与这个点的元素值相反，除非这个点是边界点，则只存在一个相邻点。

考虑到进行操作的时候可能会出现新序列存在非极长点，于是区间赋值的时候我们不仅仅要取出区间内的点，还要取出边界上部分元素位于赋值区间内的点，连着一起取，然后分类讨论赋值即可。

考虑到区间与或的操作只会使 $0$ 段， $1$ 段相反加减，总长度不变，且只会加减 $1$ ，本质上是一样的操作，只用考虑边界即可，考虑使用维护一个点的长度，元素，子树长度和，子树元素和，子树 $0$ 点个数，子树 $1$ 点个数，子树 $0$ 点最小长度，子树 $1$ 点最小长度，加减的懒标记（只用一个即可，比如 $0$ 段加上， $1$ 段减去），然后分类讨论。

点的长度可能会变为 $0$ ，则若区间与或操作后的子树 $0/1$ 最小长度为 $0$ ，则dfs查找点删除，考虑删除后的非极长点合并的情况，**注意当取出的操作区间不连带区间外的部分时的非极长点的合并情况，区间赋值操作不需要dfs但也需考虑此情况**，需要放在一起dfs，均摊 $O(m \log n)$ 这道题就做完了。

使用Fhq-treap实现并轻度卡常。

完结撒花。