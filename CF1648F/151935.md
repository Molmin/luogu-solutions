一道 Educational 的题，做完后学到了很多！！！

考虑判断连通性的求法，建出 dfs 树，非树边赋随机权值，树边权值为覆盖的非树边权值 xor。

设经过一条树边的路径数为 $v(e)$，赋上的哈希权值为 $col(e)$。讨论答案的几种情况：

1. 割一条割边或两条割边（树边）：这个缩一下边双，不难处理。
2. 割一条树边和一条非树边：当有且仅有一条非树边覆盖这个树边时可行。这个用哈希的权值判断。
3. 割两条树边，并且 $col(e_1)=col(e_2)$。答案是恰好覆盖了 $e_1,e_2$ 中的一条的路径数。

考虑非树边都是祖先-后代链，则 $col$ 有如下性质：

1. 相同的 $col$ 只会出现在 祖先-后代链。
2. 不会出现颜色相交，如不会有 $\texttt{ABAB}$。

下面有一个复杂的 1log 做法和更简洁的 2log 做法。

做法 1:

设同时经过 $e_1,e_2$ 的路径为 $\text{same}(e_1,e_2)$，第三种答案为 $v(e_1)+v(e_2)-2\times\text{same}(e_1,e_2)$。

考虑 dfs 一下树顺便维护答案，开一个 dep 为下标的线段树。

然后在某个祖先边的位置维护的是 $v(e_2)-2\times\text{same}(e_1,e_2)$，$\text{same}(e_1,e_2)$ 的话，把路径 $(u,v)$ 拆成 $(u,lca),(v,lca)$，对一个维护点维护子树的线段树合并，在 $u$ 的线段树里把 $(dep_{lca},dep_u]$ 减 2 即可。

还有颜色要相同的问题？

考虑不会出现颜色相交，于是有如下做法：设 $e$ 为某个 $u$ 的祖先边，$e'$ 为 $col(e')=col(e)$ 且 dep 最小的边，对于每个 $e$ 把 $[dep(e'),dep(e)]$ 加 $-\infty$. 这个维护子树的线段树合并也可以维护。

-----

这个做法太烦了，还有另外一个做法：

对于每个颜色，拿出所在的祖先后代链，那么这条链上选两条边是有决策单调性的。

也就是说，对于选边 $e_1,E_1(dep_{e_1}<dep_{E_1})$，它们对应的最优 $e_2,E_2$ 满足 $dep_{e_2}<dep_{E_2}$。

我们可以用主席树实现 $\log n$ 查询 $v(e_1)+v(e_2)-2\times\text{same}(e_1,e_2)$，于是分治做决策单调性，复杂度为 2log，但是可以过。

放个这种做法的[代码链接](https://codeforces.com/problemset/submission/1648/175818575)。