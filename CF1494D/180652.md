首先可以得到根节点权值 $\max lca_{u,v}$。

假设我们得到了一个节点作为子树根节点 $u$ 和其所有子树内叶节点，那么对于两个叶节点 $s_i,s_j$，如果他们的 $lca\neq u$，则这两个点处在一个子树中。所以我们递归处理这一些处在同一个子树中的叶子节点。

由于最多分成 $O(n)$ 个子树，然后每一个节点要 $O(n^2)$ 枚举叶节点，所以总复杂度 $O(n^3)$。

代码：https://codeforces.com/contest/1494/submission/110974588