## 前言

~~退役选手不好好学 whk 跑来颓废~~

本文含有大眼观察/OEIS。

**update：递推式的表有点问题，修了一下**

## 题意

用 $1 \sim k$ 的整数，组成长度为 $n$ 的串，且不能有子串是 $1\sim k$ 的排列。
  
求方案数。

## 解法

首先是暴力 DP，和另一篇题解一样。

$f_{i,j}$ 表示填 $i$ 位的串，最后 $j$ 个数各不相同且最后 $j + 1$ 位有相同的方案数。

对于 $n$ 的答案就是 $\sum_{i = 1}^{k - 1} f_{n,i}$。

然后转移就是 $f_{i + 1,j + 1} \stackrel{+}{\leftarrow} f_{i,j},f_{i + 1,w} \stackrel{+}{\leftarrow} f_{i,j} (w \in [1,j])$

```cpp
#define rep(a,b,c) for(int a = (b);a <= (c);++a)
#define repb(a,b,c) for(int a = (b);a >= (c);--a)
#define repl(a,b,c) for(int a = (b);a < (c);++a)
#define add(x,y) ( (((x) += (y)) >= MOD) && ((x) -= MOD) )

g[0][0] = 1;
int p = 1;
repl(i,1,n) {
	repl(j,0,m)
		add(g[p][j + 1],(i64)g[p ^ 1][j] * (m - j) % MOD);
	repb(j,m - 1,0) {
		ad[j] = ad[j + 1];
		add(ad[j],g[p ^ 1][j]);
	}
	repl(j,1,m) add(g[p][j],ad[j]);
	repl(j,0,m) add(f[i],g[p][j]);
	p ^= 1;
	memset(g[p],0,(m + 1) << 2);
}
```

然后这个 $\mathcal{O} (nk)$ 显然过不去，考虑优化。

首先有一个 naive 的做法是矩阵快速幂，这个是 $\mathcal{O} (k^3 \log n)$ 的，显然还不行。

但是这个方法成功让复杂度倾斜了，考虑继续优化。

形式化定义一个数列 $\{a\}$ 的递归式/递推式为如下形式：

$$\large
\sum_{i = 0}^{k - 1} a_{n - i}r_i = 0
$$

也就是常见的 $a_n = \sum_{i = 1}^{k - 1} a_{n - i}r_i$ 移项后的形式。

考虑一个 $n$ 阶方阵 $M$ 的数列 $\{I,M,M^2,M^3,\cdots\}$，我们首先求 $M$ 的特征多项式 $P$，由 Cayley-Hamilton 定理可知，特征多项式是 $M$ 的一个零化多项式，即 $P(M) = 0$ 且满足 $[x^n]P(x) = 1$，次数为 $n$ 次。

$$\large\begin{aligned}

P(M) &= 0\\

\sum_{i = 0}^{n}  p_{n - i} M^i &= 0\\

\sum_{i = 0}^{n}  p_{n - i} M^{i + j} &= 0\\

\sum_{i = 0}^{n}  p_{i} M^{n + j - i} &= 0\\

\end{aligned}$$

符合上面线性递推的
定义式，于是其最短线性递推式不长于 $n$。

由线性递推的封闭性可知，原数列每个元素乘一个相同的 $n$ 行的列向量仍满足线性递推关系，于是 $f_{n,1} \sim f_{n,k - 1}$ 都满足线性递推，长度为 $n$ 的合法方案数 $g_n = \sum_{i = 1}^{k - 1} f_{n,i}$ 也满足线性递推关系，此时可以暴力求前 $2k$ 项然后 [BM 算法](https://www.luogu.com.cn/problem/P5487) 求出其递推式，线性递推计算即可。

时间复杂度 $\mathcal{O} (k^2 + k \log k \log n)$，但是这个方法只能获得较低的分数，预处理递推式部分复杂度太高，考虑继续优化。

观察对每个 $k$ 得到的递推式：

### $k = 1$ 时

答案恒为 $0$，无解。

### $k = 2$ 时

答案恒为 $2$，全填 $1$ 或 $2$。

### $k \ge 3$ 时

打表如下：

$k = 3$ 时，有 $2$ 阶递推式 $\{2,1\}$

$k = 4$ 时，有 $3$ 阶递推式 $\{3,2,2\}$

$k = 5$ 时，有 $4$ 阶递推式 $\{4,3,4,6\}$

$k = 6$ 时，有 $5$ 阶递推式 $\{5,4,6,12,24\}$

$k = 7$ 时，有 $6$ 阶递推式 $\{6,5, 8,18, 48,120\}$

发现对于  $k \ge 3$ 有 $k - 1$ 阶递推式，满足 $r_{k,i} = (k - i - 1)i!$。

可以~~大眼观察或者~~[查看 OEIS](http://oeis.org/A137948) 得到。

现在只需要知道 $g_{i}$ 前 $k$ 项即可，考虑组合意义，前 $k - 1$ 个数都可以任意填，那么有 $g_i = k^i (i < k)$。

综上，预处理时间复杂度降至 $\mathcal{O} (k)$，总复杂度为 $\mathcal{O} (k \log k \log n)$，可以获得 100 分。

代码是线性递推板子，就只放云剪贴板里了。

[完整代码](https://www.luogu.com.cn/paste/nwh4lwlh)
