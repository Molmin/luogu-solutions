若 $b_i > i$，说明 $i\leq k < b_i$，否则说明 $b_i \leq k < i$。据此可以确定唯一的 $k$。

证明：若我们得到 $k' < k$，考虑 $b_{k' + 1}$，因为 $k' + 1 \leq k$，所以它一定大于 $k$，与 $k'\in [k' + 1, b_{k' + 1} - 1]$ 矛盾。对于 $k' > k$ 同理。

从 $b_x$ 向 $x$ 连边。这些边形成一棵以 $0$ 或 $n + 1$ 为根的树（不可能成环，因为 $b_x$ 在 $a$ 中的下标小于 $x$ 在 $a$ 中的下标），取决于 $b_1$ 是否不大于 $k$。令点 $x$ 的颜色 $c_x$ 为 $[x \leq k]$，则 $b_x\to x$ 的限制形如排列 $b_x$ 和 $x$ 之间不能有其它颜色和 $b_x$ 相同的数 $v$，否则与 $b_x$ 的定义矛盾。又因为 $b_x$ 和 $x$ 的颜色不同，所以假设点 $u$ 有若干后继 $v_1, v_2, \cdots, v_k$，则这些数恰为从 $u$ 到排列中下一个与 $u$ 颜色相同的点之间的所有数。因为保证有解，所以它们当中至少有 $k - 1$ 个数没有后继。任取 $k - 1$ 个没有后继的数排在 $u$ 后面，将剩下一个数排在它们之后，然后类似 $u$ 处理这个数直到它没有后继。

时间复杂度 $\mathcal{O}(n)$。[代码](https://codeforces.com/contest/1738/submission/174184464)。