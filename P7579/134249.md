### 概述

题目简述：在 $n$ 个球中用天平找到 $2$ 个轻球。

本题解在所有测试点中的最大询问次数为 $11$ 次，且在所有在该题范围内的数据都可以做到 $11$ 次，非常优秀。

$f(n)=\left\lceil\log_3\left(\dfrac{n(n-1)}{2}\right)\right\rceil$ 是本问题询问次数的理论下限。

为了尽可能逼近该数值，每次询问都需要尽可能将当前所有状态数进行三等分。

### 对于其它题解在 $n$ 较大时未能够足够逼近下界的论述

为了易于讨论，该部分内容忽略边界条件。

@[Little09](https://www.luogu.com.cn/user/151475) 的方法（方法一）：

简述：将球分为两份，如果相等，每一份都有一个轻球；否则，轻的那一份有两个轻球。之后进行递归处理。

为了更易于理解，此处放上一张图。

![](https://cdn.luogu.com.cn/upload/image_hosting/vq7e0ouh.png?height=100)

（其中横纵坐标均为 $1\sim n$，由于 $n$ 足够大，可以忽略间隙。）

（图中第一个轻球指的是位置编号较小的轻球，第二个轻球指的是位置编号较大的轻球，下同。）

可以发现如果得到的是相等的答案，状态数仅仅变为原来的约一半，远不到 $\frac{1}{3}$。

 @[WYXkk](https://www.luogu.com.cn/user/130151) 的方法（方法二）：
 
简述：将球分为三份，用两次询问获得两两之间的关系。如果有两份比第三份轻，那么这一份都有一个轻球；如果仅有一份比剩下两份轻，那么这一份有两个轻球。同样进行递归处理。

![](https://cdn.luogu.com.cn/upload/image_hosting/zw6jod5h.png)

（括号内第一个字母为靠左的球所在的集合，第二个字母为靠右的球所在的集合。下同。）

可以发现最劣情况为有两份比第三份轻的情况，用 $2$ 次询问仅将状态数变为原来的 $\frac{2}{9}$。

@[Rui_er](https://www.luogu.com.cn/user/122461) 的方法：类似方法一，但处理边界情况更劣。

### 第三种方法的引出

可以发现在方法二中，第一次询问恰好将状态分为 $\frac{1}{3}$，而第二次询问没有达到下界。考虑优化第二次询问：

将球尽可能平均地分为 $3$ 份 $A,B,C$，且要求 $A$ 和 $C$ 中球的数量相同。

第一次询问 $A$ 和 $C$，会分为三种情况：$(A,A)+(A,B),(B,B)+(A,C),(B,C)+(C,C)$。

先讨论 $(A,A)+(A,B)$ 的状态数，发现 $(A,A)$ 的状态数大约占 $(A,A)+(A,B)$ 的状态数的 $\frac{1}{3}$。

因此可以考虑将 $(A,A)+(A,B)$ 分开 $(A,A),(A,B)$ 并将 $(A,B)$ 状态数将为一半。

因此下一次集合可以将 $B$ 中的球均分为两份（是奇数的话从 $C$ 拿一个球，这个球不可能为轻球），进行一次询问。

如果重量相等，那么两个轻球都在 $A$；否则一个轻球在 $A$，另一个在轻的那份里。

$(B,C)+(C,C)$ 的情况类似。接下来讨论 $(B,B)+(A,C)$：

+ 如果 $C$ 可以均分为两份，那么将两份进行一次询问。

如果重量相等，那么两个轻球都在 $B$；否则一个轻球在 $A$，另一个在轻的那份里。

+ 排除上述情况，但所有球可以均分为两份的话，可以将 $A$ 和 $C$ 的一半，以及 $B$ 和 $C$ 的另一半进行询问，可以得到与上述类似的结果。

+ 排除上述情况，但此处球的总数量不为原来的 $n$，则可以从其它地方拿来一个正常球使两边球数相同。

+ 排除上述所有的情况之后，那么只能在第一次询问之前将 $C$ 的大小减一。

图示：

![](https://cdn.luogu.com.cn/upload/image_hosting/om0i76i3.png)

边界情况：

两个球 $a,b$：直接返回。

三个球 $a,b,c$：询问一次即可获得答案。

### 对于三种方法可能未能取到下界的另一个原因

在 $n$ 个球中找到 $1$ 个轻球的下界为 $\left\lceil\log_3n\right\rceil$，且可以取到下界：一直尽可能均分为 $3$ 份。

但分别在一份 $x$ 个球和一份 $y$ 个球中分别找到 $1$ 个轻球的下界是 $\left\lceil\log_3(xy)\right\rceil$，而现在所需要的询问数量为 $\left\lceil\log_3(x)\right\rceil+\left\lceil\log_3(y)\right\rceil$。

考虑优化：首先假设其中一份有 $x=2$ 个球 $a,b$，其一次询问状态数仅变为原来的 $\frac{1}{2}$。这个过程可以优化到 $\frac{1}{3}$：

将另一份 $y$ 分为两份，一份尽可能接近 $\frac{1}{3}y$，另一份 $\frac{2}{3}y$。

将 $a$ 和 $\frac{1}{3}y$ 放在天平的左侧，$\frac{2}{3}y$ 放在右侧。如果数量不相同则添加正常球（顶多约 $\frac{1}{3}y$ 个）。

补充：由于两份球各找一个轻球的状态由方法三有 $x,y\le\left\lceil\frac{n}{3}\right\rceil$，而已知的正常球个数至少为 $\left\lfloor\frac{n}{3}\right\rfloor$，因此正常球数量足够来使两边数量相同。

+ 如果平衡，则轻球为 $a$ 并在 $\frac{2}{3}y$ 那一份再找一个轻球。

+ 如果右侧重量比较轻，则轻球为 $b$ 并在 $\frac{2}{3}y$ 那一份再找一个轻球。

+ 如果左侧重量比较轻，则 $a,b$ 中有一个轻球，并在 $\frac{1}{3}y$ 那一份再找一个轻球。此处进行递归操作。

每种情况都将 $2y$ 的状态数划分为 $\frac{2}{3}y$，是比较优秀的操作。

可以将 $x=2$ 的情况进行推广为对于更大的 $x$ 分为 $A,B$ 两份的情况。在这种情况下，误差开始增大，因此需要详细考虑是否该使用该操作。

![](https://cdn.luogu.com.cn/upload/image_hosting/1n47o08m.png)

### 建立决策树

发现对于以上方法，像 $n=7,13,20,21,22,37,38,115$ 之类的数据并没有取到 $f(n)$，因此可以使用建立决策树的策略，将决策树直接枚举出来，将答案降为最小。

决策数量为 $\Theta(3^n)$，但由于很多决策都能够将状态尽可能三等分，所以找到这样的一个决策并不是太难。

经测试，找到一个决策的时间复杂度**大约**为 $\Theta(n)$，判断一个决策的合法性需要 $\Theta(s)$ 的时间复杂度。（$s$ 为当前节点的状态总数。）

决策树较为平均，因此决策树的深度约为 $\Theta(\log_3({n^2}))$，且一层节点的状态数之和为 $\Theta(n^2)$。

因此总复杂度约为 $\Theta(n^3\log_3({n^2}))$。

优化：如果 $n$ 和 $n-1$ 都需要搜索决策树，那么强制钦定 $n$ 号球一直不选可以减少一倍的常数。

同理，可以发现对于两份分别找轻球的状态时，$x=5,7,11,19$ 之类的数据使用二分法和三分法仍然显得比较差。

发现当 $x=5,7,11,19$ 的时候，可以依次用 $3,4,5,6$ 次操作，对于另一份进行 $y=5,11,22,38$ 等分（最坏条件下为上取整）。

注意此处如果球的数量不同仍需要补充正常球使球的数量相同。

决策状态数量为 $\Theta(3^{x+y})$，如果实现较差的暴力可能只能找出 $x=5$ 的决策树，实现较好的暴力可以找到 $x=7,11,19$ 的决策树。

### 打表

对于 $n=115,343,344$ 以及 $x=172,y=343$ 仍然没有卡到下界，且无法在搜索的时间复杂度内通过。可以发现有些节点找到一个决策的次数远超过 $\Theta(n)$。

因此，可以采用的方法是将这些节点的决策打表。

需要打印的字符串为所有需要决策的情况使用的询问，对于每一个点可以使用长度为 $n$ 或 $x+y$，每一位为 $0,1,2$ 的字符串记录。

此时的代码可以在一秒内通过，但代码长度很有可能超限。

字符串压缩方法：将 $4$ 位压成 $1$ 位减少长度，总共需要 $3^4=81$ 种不同的可见字符。

又可以发现在原字符串中，连续的 $0$ 出现次数非常多，因此又可以将压缩后的字符串的连续的 $0$ 进行二次压缩，即用剩下的可见字符表示 $4k$ 个 $0$。

需要注意的是，由于寻找决策的过程需要用到随机数。因为打表的代码和原代码需要有相同的结果。因此需要可复现的随机数实现，这里使用 [P7738](https://www.luogu.com.cn/problem/P7738) 的下发代码。

### 第三种方法的不足之处

对于在 $n$ 个球中找到 $2$ 个轻球，一次操作的第二个步骤，实际上误差比较大，足以达到 $\frac{2}{3}n$。

对于在两堆球中分别找到 $2$ 个轻球，仍然有一些 $x,y$ 也存在误差，并没能卡到下界。

### 表现

对于 $2\le n\le10^7$ 的最坏情况，进行整理：
 
| 最坏情况下的称量次数 | 为 $f(n)$ 的 $n$ 的个数 | 为 $f(n)+1$ 的 $n$ 的个数 | 总计 |
| :-: | :-: | :-: | :-: |
| 方法一&方法二（另一原因无优化） | $5519275$ | $4480724$ | $9999999$ |
| 方法三（另一原因无优化） | $5519275$ | $4480724$ | $9999999$ |
| 方法三（$x=2,4$ 优化） | $7910718$ | $2089281$ | $9999999$ |
| 方法三（无优化搜索决策树） | $8442161$ | $1557838$ | $9999999$ |
| 方法三（优化搜索决策树） | $9939102$ | $60897$ | $9999999$ |
| 方法三（打表+优化搜索决策树） | $9968628$ | $31371$ | $9999999$ |

（注：用@[WYXkk](https://www.luogu.com.cn/user/130151) 的代码跑出来的结果和他题解里的结果略有不同，有可能我使用方法不对。）

对于足够大的 $n$，最后的方法能取到 $f(n)$ 的数量占比大于 $99\%$。

一个不够充分的证明：

$n\le 10^4$ 经程序计算满足条件。

对于 $n\leftarrow 3n$，由于为三分法，原本不能取到的数 $\times 3$ 左右的数，显然都不能够取到最优解。

运用数学归纳法可以得证。

对于最坏情况下的称量次数一定 $\le f(n)+1$，该点比较难以证明。欢迎读者补充证明。

关于是否对于每个 $n$ 都有卡到 $f(n)$ 次的方法，我的观点与 @[WYXkk](https://www.luogu.com.cn/user/130151) 不同，因为决策数量是指数级别的，很可能存在恰好将状态均分为三种的决策。

在本题中，试验过所有可能的数据，询问次数均没有超过 $11$ 次，且 $11$ 次为本题理论下界。

更好的是，对于所有 $n\le 500$，询问次数均没有超过 $f(n)$ 次。最小的超过询问次数的是 $595$。

~~因此，又可以加强数据了。~~

[本文中用到的代码](https://www.luogu.com.cn/paste/mdywt0s3)

### 本文中提到的链接

1.@[Little09](https://www.luogu.com.cn/user/151475) 的[题解](https://www.luogu.com.cn/blog/LJA001111/solution-p7579)

2.@[WYXkk](https://www.luogu.com.cn/user/130151) 的[题解](https://www.luogu.com.cn/blog/WYXkk/solution-p7579)

3.@[Rui_er](https://www.luogu.com.cn/user/122461) 的[题解](https://www.luogu.com.cn/blog/ak-ioi/rdoi-r2-cheng-zhong-weigh-ti-xie)

顺便附上[本文链接](https://www.luogu.com.cn/blog/134249/solution-P7579)

