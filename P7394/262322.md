学校[dd_d](https://www.luogu.com.cn/user/167999)的模拟赛，赛时直接寄了，赛后听 Ta 讲了三遍才会 Orz。
## 题面

```1 x``` 将 $x$ 位置上的灯打开或关闭（原来如果打开就关闭，否则打开）。

```2 x y``` 询问树上与 $x$ 相同深度的点中与 $x$ 结点距离为 $y$ 的点中开着的灯的个数。

```3 x``` 回到第 $x$ 次事件发生之后的状态。
## 题解
先不考虑操作 $3$ 会在下面提到。

* $10pts$ 在考场上想出来的做法，因为树同层的点之间的距离显然是偶数，如下图：
![](https://cdn.luogu.com.cn/upload/image_hosting/mn94dfkm.png)

手玩发现 $len_{2\rightarrow3}=2,len_{6\rightarrow7}=4,len_{5\rightarrow8}=4\dots$

所以当操作 $2$ 中 $y=0$ 时，答案就是 $0$。

* $20\sim30pts$ $\mathcal O(n^3)$ 对于每次询问做一遍搜索，找出距离等于 $y$ 的点，统计答案，对于操作 $1$ 直接暴力修改即可。

* $50\sim60pts$ $\mathcal O(n^2)$ 想到 $20pts$ 的做法以后就很容易想到 $60pts$ 做法了吧（~~就我没想到~~）。

先以每个点为起点预处理出所有点到它的距离，每次询问这些点。

* $100pts$ $\mathcal O(n\log n)$ 对于每个点之间的距离可以用 ST 表 $f_{i,j}$ 维护 $i$ 向上 $j$ 级的祖先，区间修改查询则可以用动态开点线段树维护。

## 维护方法
由于 dfs 序是连续的一段，那么我们可以维护这一段中深度等于 $x$ 的点中开着的点的个数，先 $\mathcal O(n)$ 枚举出所有子树的 dfs 序起点和终点。

然后由于向上的距离是 $y/2$ 所以统计 $x$ 向上 $y/2$ 级为根的子树中亮着的节点数即可。

**但是**相同深度的还有其他子树，如上图中 $4$ 和 $4$ 在相同深度，假设 $y=4$ 但是他们的距离显然不是 $4$，需要统计的是 $8$ 和 $9$，所以在统计深度时还要减去它向上 $y/2-1$ 级为根的子树中亮着的节点数：
$$ans\leftarrow query(f_{x,y/2})-query(f_{x,y/2-1})$$
$query$ 表示动态开点线段树的询问操作。

## 操作3
最后就是操作 $3$ 的解决方法，因为要回到第 $x$ 次所以讲所有询问离线，把操作 $3$ 中的 $x$ 和 $i$ 连边，对于其他操作直接由上一次向下一次连边，最后**从0开始**对于每条边做一遍 dfs 遍历并进行操作，操作 $3$ 就迎刃而解了。

[Code](https://www.luogu.com.cn/paste/wwhildah)