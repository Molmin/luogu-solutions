出于个人习惯，我们把原题的 $a_{[1,n-1]}$ 整体平移到 $a_{[2,n]}$。

为了方便，令 $g_{i,j}$ 表示一个深度为 $i$ 的点有多少个深度为 $i+j$ 的子孙，显然这些子孙到这个点的距离为 $j$。

其实我一开始设的是深度为 $j$，没啥区别，只是后面式子里上面的设法会舒服一点。

那么显然有 $g_{i,j}=\prod_{k=i+1}^ja_k$。

我们考虑枚举路径两端的 LCA 的深度 $i$，对于一端就是 LCA 的情况，我们直接将 $g_{i,j}$ 加到 $ans_j$ 即可。

对于剩下的情况，我们可以列出以下式子。

$\binom{a_{i+1}}{2}\sum_{k=0}^jg_{i+1,k}\times g_{i+1,j-k}\to ans_j$。

然后就有了一个 $O(n^3)$ 的做法，考虑优化。

这是一个卷积的形式，我们把这部分单独提出来。

设 $f_{i,j}=\sum_{k=0}^jg_{i,k}\times g_{i,j-k}$。

一个很重要的性质在于 $g_{i,j}=\frac{g_{i-1,j+1}}{a_i}$。

我们发现这个转移和 $j$ 无关。然后每个 $g_{i,j}$ 都有个 $\frac{1}{a_i}$ 意味着 $f_{i,j}$ 整体有一个 $\frac{1}{a_i^2}$。

然后注意 $g_{i-1,j+1}$，相当于集体平移一位，那么对应到 $f_{i,j}$ 就是集体平移两遍。

那么我们把特殊的 $g_{i-1,0}$ 的影响减掉后，有 $f_{i,j}=\frac{f_{i-1,j+2}}{a_i^2}$。

这样，我们就用 $O(n^2)$ 的复杂度求出了 $f_{i,j}$。

https://codeforces.com/contest/954/submission/183982007