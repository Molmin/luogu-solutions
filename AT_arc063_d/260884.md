- 很久以前的[坑](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/solution-at2149)，现在好歹是有机会补上。
- 这题个人认为骨子里流着分治的血。（虽然你可以看到最后分治几乎没掉了）

**题意**
- [题目](https://www.luogu.com.cn/problem/AT2149)。
- 给定一个 $W\times H$ 的平面，求周长最大的一个矩形，不经过所有的 $n$ 个整点。
- $n\le 3\times10^5$，$W,H\le 10^8$。

**做法一**
- 做法一:（分治+）扫描线。
- 考虑经过分治中心的矩形，用扫描线维护，它大概长这样：
![](https://cdn.luogu.com.cn/upload/image_hosting/5g4hfirm.png)
- 维护单调上升或下降的点可以使用单调栈，更新需要支持区间加和全局最大值的查询，这个用线段树即可方便维护。
- 总复杂度 $O(n\log^2n)$。
- 当然，由于这道题目的特殊性，我们发现答案有个下界 $2(\max(W,H)+1)$，这同样说明了合法矩形必须经过 $x=\frac W2$ 或 $y=\frac H2$，所以我们其实不需要分治，复杂度是 $O(n\log n)$。
- 口胡五分钟，代码两小时。（
- 这题如果你是动态开点线段树实现它的代码会相当不方便，这主要是因为动态开点对下传和特殊处理的操作是比较脆弱的。
- 一开始离散化吗？注意它不允许咱们在每个问题上都来一次线性的建树，所以我们要在每次分治的时候单独离散化。
- $O(n\log^2n)$ [代码实现](https://www.luogu.com.cn/paste/xxke5mqd)。
- $O(n\log n)$ [代码实现](https://www.luogu.com.cn/paste/zz7zdimt)。

**做法二**
- 做法二：（分治+）分治。
- 考虑经过分治中心的矩形，$x$ 维搞一个分治，$y$ 维也搞一个分治，结果如何？
![](https://cdn.luogu.com.cn/upload/image_hosting/smkbn3rl.png)
- 使用单调队列和双指针，我们就可以在关于分治块内的点数的线性时间内求解问题，所以复杂度是 $O(n\log^2 n)$（这个做法似乎更具有广泛的适用性，它显然可以类似地处理最大面积的问题）。
- 简单粗暴地利用之前的那个结论，可以消掉一维分治，时间复杂度 $O(n\log n)$。
- 实现对我来说会稍微有些复杂，我的代码能力还是有待提高，解决代码实现困难的问题仍然任重而道远。
- 在实现中一个相当重要的细节就是：最后计算的时候我们希望所有的点都关于某个位置有序，但直接排序的时间复杂度是不可以承受的，需要注意。