好题。我大概是看题解想出来一个大致的框架，要说每一步的证明的话倒真还不难，但是要想从头想到尾难度还真是很大啊！

**其实这个题的思考过程还是很有可借鉴性的。**

首先题目给了我们一个看上去很复杂的条件，直接进行模型转化有点困难，因此我们不妨先从分析一些简单情形入手。每个点双是独立的，因此只需考虑所有点双，求一遍答案然后直接进行 vector 的拼接即可。一般来说，比较典型的点双有以下几种：

- 一个环：显然在环上按顺序定向即可。
- 一个环 + 一条弦：环上的点照样按顺序定向，而对于这条弦 $(u,v)$，我们令 $v$ 在 $u$ 的邻接表中夹在与 $u$ 相邻的两个点之间，令 $u$ 在 $v$ 的邻接表中夹在与 $v$ 相邻的两个点之间即可。
- 完全图。注意到 $K_4$ 不合法，因此对于 $n\ge 4$，$K_n$ 也不合法。好像也没啥性质可以得出。
- 杏仁（即两个点之间有多条链），如果这两个点之间只有两条不退化成边的链，或者有两条不退化成边的链 + 一条边，那么情况就是一个环 / 一个环 + 一条弦的情况，这里不再赘述。我们着重考虑两个点之间有三条及以上不退化成边的链的情况。最简单的，两点 $A,B$ 之间存在三条链：$A\to C\to B,A\to D\to B,A\to E\to B$。考虑点 $C$ 的邻居顺序，根据对称性，不妨假设是 $A,B$，那么考虑环 $ACBD$，那么 $D$ 中 $B$ 必须在 $A$ 前面，再考虑环 $ACBE$，同理 $E$ 中 $B$ 必须在 $A$ 前面。可以发现这是矛盾的，因为在环 $ADBE$ 中，$D$ 的邻居顺序必须与 $E$ 的邻居顺序相反。如果这条链上不只有一个点而有更多，则也是同理不合法的，证明类似。

也就是说，一个点双连通分量存在合法的钦定方式的必要条件是对于任意两个点 $x,y$，它们之间至多存在两条不退化成点的路径。考虑这样的图有什么性质，可以发现这样的图必然存在哈密顿回路。否则，考虑一条极大的简单回路，我们把不在回路上的链提取出来，显然这条链长度 $\ge 2$ 且其连接的两点在回路中的距离也 $\ge 2$，否则就不是极大的了，这样可以得到这两点之间存在三条不退化成点的路径，与已知条件矛盾。

现在，假设我们已经通过某种奥秘重重的手段得到了这个点双的哈密顿回路。考虑使这个点双合法还需有什么条件。我们还可以观察到一个性质：考虑不在环上的边，我们称之为“弦”，那么如果存在两条弦不在端点相交，这个点双就必然不合法。考虑找到两条这样的弦，那么两条弦的四个端点中必然存在两个点距离 $\ge 2$——否则就是一个 $K_4$ 的结构，根据已知其必然不合法。这样一来这两个距离 $\ge 2$ 的点之间存在三条路径，在下图中分别用不同的颜色标注了出来：

![](https://cdn.luogu.com.cn/upload/image_hosting/b66j4r0b.png)

也就是说说一个合法的图必然一个环 $+$ 若干条不相交的弦组成，那么有没有什么更好的性质呢？这里引入**广义串并联图**的概念。广义串并联图，指可以由删一度点、缩二度点、叠合重边（简称删一缩二叠重）三种操作缩成一个点的图。可以证明，所有符合要求的点双都是广义串并联图。因为非广义串并联图都存在 $K_4$，而存在 $K_4$ 就意味着一定不合法。

因此考虑对点双进行删一缩二叠重操作，显然在这过程中可以用链表维护哈密顿回路。找到哈密顿回路后，剩余的部分肯定是若干条不相交的弦，构造方案是容易的——直接将与每个点相连的边按类似于极角排序的方向排序就行了，证明是 trivial 的。

这样我们就解决了此题，复杂度线性。