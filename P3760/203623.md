原本准备投的月赛，发现原题，故公开解法。

给出了目前题解中时间复杂度最优秀的解法。

很明显就前缀和（设为 $s$，$s_0=0$），然后按位考虑。

把这一位拆出来作为 $01$ 序列 $t$。

对于 $i,j$，如果 $s_j-s_i$ 在当前位没有发生退位，那么就要求 $t_i\ne t_j$；否则 $t_i =t_j$。

考虑退位是什么，其实就是对于在这一位之前的所有位产生的数（设为 $b$）,$b_j<b_i$。

明了了。

即求

$$\sum_{i=0}^{n-1} \sum_{j=i+1}^n [t_i =t_j \land b_i >b_j \lor t_i\ne t_j \land b_i\le b_j] $$

树状数组可以做到 $O(nw\log n)$。

我们不妨拆开上面的式子，然后分别加起来。

$$\sum_{i=0}^{n-1} \sum_{j=i+1}^n [t_i =t_j \land b_i >b_j ] $$

如果我们把 $t$ 按 $01$ 分类，就相当于逆序对问题。

这个是难以做到线性的。

但是题目有一个很好的性质，就是我们只用求逆序对的奇偶性。

存在线性算法，见下。

第二个东西是：

$$\sum_{i=0}^{n-1} \sum_{j=i+1}^n [t_i\ne t_j \land b_i\le b_j] $$

不妨不考虑 $t_i \ne t_j$ 的限制，直接算。这个用逆序对容斥一下即可。

然后再减去 $t_i=t_j$ 的部分。这个上面已经几乎算过了，也用逆序对容斥即可。

接下来我们考虑，如何求逆序对的奇偶性。

首先，我们可以在线性时间内将 $b$ 转为排列。

考虑从低到高加入每一位。每加入一位，相当于把某些数的最高位变成 $1$。

那么维护排序数组，把这些数提到最后即可。

考虑求排列逆序对奇偶性。

### 引理：对于一个排列，若任意交换 $x$ 次相邻项后，该排列有序，那么 $x$ 和该排列的逆序对奇偶性相同。

证明：

一个排列的逆序对数等于交换相邻项的次数，这是众所周知的。

但这里的相邻项要满足前项大于后项。若前项小于后项，那么使用了一次操作将逆序对数量增加了一。这显然是不改变 $x$ 的奇偶性的。

### 推论：一个排列的逆序对的奇偶性与 $n$ 减去该排列的环数的奇偶性相同。

考虑 $n$ 减去该排列的环数是什么，是任意交换两项，得到有序排列的最小次数。因为有序排列 $p_i=i$。

而这个和任意交换的奇偶性是相同的。

为什么呢？考虑使用相邻项交换模拟任意两项交换。显然任意交换两项都可以通过若干次相邻项交换得到，

又因为任意交换的奇偶性和逆序对的奇偶性相同，所以推论得证。

环数容易线性求出，所以本题的每一位的处理可以做到线性。

时间复杂度 $O(nw)$。