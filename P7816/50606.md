**洛谷当场月赛讲评人题解。**

$$\rm Analysis\sim\text{以父之名}$$

$$\rm Author:~Znloye$$

---

容易发现一个合法的方案中，所有的边的方向反向，依然是一个合法方案，据此我们只需要关心一条边的方向与其他边的相对关系，亦即 **差的绝对值** $\le1$。

---

#### $\rm Subtask~1$

特殊性质：$n\le10,~m\le15$。

做法：$m$ 条边的方向非正即逆，$2^m$ 枚举所有可能性，$O(m)$ 进行度数统计。

期望复杂度 $O(m\times 2^m)$，期望得分 $7$。

[$\rm code\Leftarrow$](/api/team/downloadFile/aq0aypjs)

---

#### $\rm Subtask~2$

特殊性质：$n\le10^3,~m\le3\times10^3$。

做法：正解中不会使用正确写法“删环”，对每个点暴力找环的部分分。

期望复杂度 $O(n\times m)$，考虑到对每个点找环时根本跑不满 $O(m)$，期望得分 $27\sim67$。

---

#### $\rm Subtask~3$

特殊性质：图是一片边权 $=1$ 的森林。

做法：由于图是一片森林，对每棵树，考虑从一个点 $root$ 开始遍历，假设目前遍历到 $u$，并记录自己父亲 $fa$ 带来的权值信息 $val$：

- 若上面一条边指向 $fa\rightarrow u$，则先从向下的边 $u\rightarrow v$ 开始定向并向下传递信息；
- 反之 $u\leftarrow v$ 开始定向并向下传递信息。
- 这样无论 $u$ 有多少个孩子，$u$ 定出来的绝对值之差不会超过 $1$。

另一方面，对于每个叶子结点 $y$，无论其父亲 $x$ 的定向方案是 $x\rightarrow y$ 或 $x\leftarrow y$，绝对值之差均不会超过 $1$。

综上，每一棵树的所有叶子、非叶子结点绝对值之差均不超过 $1$，即整片森林均满足绝对值之差均不超过 $1$。

[$\rm code\Leftarrow$](/api/team/downloadFile/on0cbwym)

---

#### $\rm Subtask~4$

特殊性质：结点 $u$ 最多连一条权为 $1$ 的边、一条权为 $2$ 的边。

做法：这就是一条链，进一步地，边权是 $1,2$ 交替的一条链。

直接考虑找到一个度为 $1$ 的结点 $u$，所有边都同向地指向链的另一个端点 $v$。

即：$u\rightarrow node_1\rightarrow node_2\rightarrow\cdots\rightarrow node_{n-2}\rightarrow v$。

与 Subtask3 的最后一步相同，由于每条链的结果均符合要求，最终答案也一定符合要求。

[$\rm code\Leftarrow$](/api/team/downloadFile/p5u0bi8y)

---

#### $\rm Subtask~5$

满分做法 $O(n+m)$ 分为三个部分：

1. 删环；
2. 剖链；
3. 定向：$\rm Subtask4$。

4. 删环怎么 $O(n+m)$ 删：

	-  一个朴素的类似 tarjan 想法是，dfs，每次找到一条后向边就删掉对应的环，显然这种做法的复杂度 $O(n\times m)$。
	- 考虑优化这一过程，每次多记录一个最后一次遍历到的有效边，这就保证了每条有用的边仅遍历一次，不会遍历到已经删除的边去判断出这条边不能遍历，这种做法的复杂度 $O(n+m)$。

5. 剖链的功能：将“删环”后的图进一步简化成一个满足 $\rm Subtask4$ 性质的图，该图的边数是 $O(n)$ $\color{red}特别注意不是 O(m)$。

	- 借用 $\rm Subtask3$ 的模型，考虑对于以 $u$ 为根的 **子树**（**包括 $u$ 连向 $fa$ 的边，但不包括 $fa$**）剖成若干条链，其中有一条链从 $u$ 的子树中 **某个点** 连向 $fa$。
	- 对于叶子结点 $y$ 直接返回连向 $fa$ 的边。
	- 对于其他的非叶子结点 $u$，先把其子结点 $v_1,v_2,\cdots,v_k$ 的子树内连上来的边（或称作链）两两配对。
	- 容易发现若 $k$ 为奇数，最后会剩余一棵子树，直接将它返回的链连给 $fa$ 结点。
	- 若 $k$ 为偶数，则返回 $u$ 向 $u$ 的父亲连的边。
   
至此我们用一个三元组 $(x,y,lca)$ 形容一条链，表示一条链的两个端点 $(x,y)$ 与它们的最近公共祖先 $lca$。

同时记录下每个点连向其父亲的边的编号 `Id` 与方向（对应题目输入是正向或反向），方便最后进行定向。

**特别注意：我们在将图转化为 Subtask4 之前不对任何没有在去环时处理掉的边进行定向，最后做 Subtask4 的时候才定向。**

6. 最后定向。根据 Subtask4 的逻辑，上面的“剖链”过程已经保证对每个点至多有一条边权为 $1$ 的边和一条边权为 $2$ 的边与之相连，直接按照 Subtask4 和之前记下的方向信息进行最终定向即可。

[$\rm huge~code\Leftarrow$](/api/team/downloadFile/mnovifb4)