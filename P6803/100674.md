# CF1402C Star Trek

洛谷的Markdown缩进有一些问题，请务必进入下面的链接阅读：

[超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超超爽的阅读体验](https://www.cnblogs.com/dysyn1314/p/13581665.html)

[题目链接](https://codeforces.com/contest/1402/problem/C)

约定：假设从第$i$棵树的节点$a$，连向了第$i+1$棵树的节点$b$，则我们认为第$i+1$棵树是以$b$为根的。

考虑一个DP。设$dp[i]$表示依次连接了$i$棵树，【从第一棵树的根节点出发，先手必胜】的方案数。注意，第一棵树的根节点可以是**任意一个节点**（只有在求答案时，才强制要求第一棵树的根节点是$1$，我们在定义状态时不考虑这个）。也就是说，$dp[i]$，是把第一棵树根节点为$1\dots n$的方案数加起来。

转移时考虑在**前面**添加一棵树。

朴素的转移，我们枚举添加的这棵树的根$\text{root}$。此时需要做一些分类讨论：

- 单独考虑一棵树，以$\text{root}$为根时，是否是先手必胜的。如果是**先手必胜**的，此时我们要求连出去的边**不能改变**根节点$\text{root}$的胜负状态。具体来说，枚举树里每一个节点$u$，考虑从$u$连出去：
  - 如果改变$u$的胜负性后，**不会影响**到根节点$\text{root}$的胜负性。那么后面$i-1$棵树的连边方案可以任意。方案数是$n\times n^{2(i-1)}$。其中$n$表示给后面的第一棵树定一个根节点，$n^{2(i-1)}$表示其他树之间任意连边。
  - 如果改变$u$的胜负性后，**会影响**到根节点$\text{root}$的胜负性：
    - 如果$u$的子树是先手**必胜**的。那么随便连一条边，当走到$u$时，先手无论如何不会走向这条边。所以也可以任意连边，方案数是$n\times n^{2(i-1)}$。
    - 如果$u$的子树是先手**必败**的。则我们连出去的边必须必胜。因为如果连向了一个必败状态，则走到$u$时，先手就一定就会走我们新连的这条边，于是就改变了$u$的胜负性，进而改变了根的胜负性。因此，连边只能连向必胜，方案数是$dp[i-1]$。
- 单独考虑一棵树，以$\text{root}$为根时，如果不是先手必胜（也就是**后手必胜**），此时我们要求连出去的边**必须改变**根节点的胜负状态。具体来说，枚举树里每一个节点$u$，考虑从$u$连出去：
  - 如果改变$u$的胜负性后，**不会影响**到根节点$\text{root}$的胜负性。那一定不符合我们的要求。所以从$u$节点连出去的方案数是$0$。
  - 如果改变$u$的胜负性后，**会影响**到根节点$\text{root}$的胜负性：
    - 如果$u$的子树是先手**必胜**的。那么我们无论怎么连边，走到$u$时先手都不会走我们连出去的边。所以不可能改变$u$的胜负性，进而不可能改变根的胜负性。所以方案数还是$0$。
    - 如果$u$的子树是先手**必败**的。那么我们连向一个必败点，就能改变$u$的胜负性。所以连边方案数是$n\times n^{2(i-1)}-dp[i-1]$。

通过上述的分类讨论，我们发现，确定根后，只需要知道每个节点$u$的两个信息：

- 点$u$的子树，是否是先手必胜的。
- 点$u$胜负性改变，是否会影响根的胜负性。

具体来说，只需要知道，对每个根来说，两种信息$2\times2$共$4$类点的数量分别是多少，就能计算出DP的转移系数。然后用矩阵快速幂优化DP。

首先，可以枚举根，各做一次树形DP，求出这两个信息。时间复杂度$O(n^2)$。具体来说：

- 点$u$的子树是否先手必胜。这个只需要看儿子里，有没有先手必败的点即可。只要存在先手必败的儿子，则点$u$就是先手必胜的，否则是先手必败的。
- 点$u$的胜负性改变，能否影响到根。这个要满足两个条件：
  - 首先，点$u$的父亲，必须能影响根。
  - 其次，点$u$的所有兄弟里（它父亲除了$u$以外的儿子），必须没有必败点。也就是说，要么点$u$父亲的儿子里压根没有必败点；要么恰好有一个必败点且这个点就是$u$。

这两个DP都比较简单。假设求出的两个信息，分别为$f_{\text{root}}(u),g_{\text{root}}(u)$（$f_{\text{root}}(u),g_{\text{root}}(u)\in\{0,1\}$）。那相当于对每个$\text{root}$，求出一个：
$$
\text{cnt}[\text{root}][x\in\{0,1\}][y\in\{0,1\}]=\sum_{i=1}^{n}[f_{\text{root}}(i)=x]\times[g_{\text{root}}(i)=y]
$$
假设有了这个$\text{cnt}$数组，我们就很容易求出系数，然后进行上述的DP并用矩阵快速幂优化了。

先对$1$，求出$\text{cnt}[1][x][y]$，然后换根。换根的时候非常复杂，需要进行大量的讨论。具体来说，要预处理出一个$s(u)$表示只考虑（以$1$为根时）点$u$的子树，子树里有多少$g_{1}(i)=1$的点。换句话说，就是不考虑$u$的父亲了，强制点$g(u)=1$。这个$s$在换根时，有很大的用处。

其他细节，留给读者自行讨论。实在讨论不出来可以看看参考代码。~~不过看到这么长的代码，你估计宁愿自己讨论......~~。

时间复杂度$O(n+\log d)$。


[去看代码~](https://www.cnblogs.com/dysyn1314/p/13581665.html)
