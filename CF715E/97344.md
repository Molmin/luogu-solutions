一种不需要黑科技的做法。

假设 $p,q$ 已知。

假设 $p_i=i$，那么我们连边 $i\to q_i$，答案就是 $n-$ 环的个数。

如果 $p_i$ 不等于 $i$，我们可以建立辅助点， $i\to p_i,j\to q_j$，这样得到的图的环数和原图是等价的。

进一步的，我们可以删掉每一个 $i$，也就是直接 $p_i$ 向 $q_i$ 连边，不难发现这样也是等价的。

所以现在问题变成了要让 $p_i$ 和 $q_i$ 连起来，求这个图的环的个数。

考虑以每一个 $p_i$ 往后连的一串链。

发现对于每一个位置，只可能有四种情况：$PQ,P0,0Q,00$。

对于 $P=Q$，我们可以把 $0Q$ 和 $P0$ 缩成一个 $00$，这样是等价的。

同样，对于 $P_2=Q_1$，我们可以把 $0Q_1$ 和 $P_2Q_2$ 缩成一个 $0Q_2$。

当然还有类似的可以缩一下。

当然如果已经有的 $PQ$ 类型的已经构成了一些环，我们就直接把这些扔掉最后再加回来就可以了。

然后对于每一个 $x$，如果有 $q_i=x$ 且 $p_i$ 非 $0$，那么他不能作为一个链头，否则以 $x$ 出发的都有一条链，并且一定是上面那四类中的一个。

假设这样的链最后分别有 $n_1,n_2,n_3,n_4$ 个。

考虑按顺序把这些链连成环。

首先先把 $PQ$ 和 $P0$ 放一起，他们可以任意连，并且连的时候必须要消耗一个 $00$（这里是 $p_i=q_i=0$ 的 $i$）。

这两类的情况可以直接第一类斯特林数计算。

接下来考虑第三类，他不能接在 $P0$ 的后面，因为这样的话那两个 0 可以任意的填，我们无法确定，其他情况需要一个 $p_i=q_i=0$ 来当中介。

所以转移类似于第一类斯特林数的转移，有：

$$f(i,j)=(i-1-n_2)f(i-1,j)+f(i-1,j-1)$$

接下来考虑第四类，他不能接在第二类的后面，不能接在第三类的前面，不能接在自己的两边，自己也不能成环，同时我们注意到，第二类的后面和第三类的前面一定中间隔了一个，同理第四类的两边也和第二类的后面或者第三类的前面之间隔了别的，所以可以直接减掉这些情况获得合法的情况数，所以有转移：

$$f(i,j)=(i-1-n_2-n_3-2\times (i-1-n_1-n_2-n_3))f(i-1,j-1)$$

但是对于所有的 $p_i=q_i=0$ 的边，他们可以随便交换顺序，因此需要乘上这样的 $i$ 的个数的阶乘。

$\mathcal O(n^2)$

[code](https://codeforces.com/contest/715/submission/127900032)