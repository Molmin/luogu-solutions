考场一眼口胡出来的 $O((n+q)\log n)$ 的并查集+**树剖**+虚树的做法，~~因为在考场上不想打 LCT 于是这个做法没有 LCT~~。

由于是口胡的可能有很多地方实现费拉不堪，还请及时指出。

------------

以下用边重和边权来区分限重大小和边权大小。

首先将边按边重从大到小加入，并用并查集维护连通块内的点权最大值，而这个最大值可能有很多个点，我们只记录一个点即可。

对于每个询问我们可以在对应的时刻找到其可以到达的最大点权，同时记录其中一个点以备后用。

这里显然是 $O(n\log n+(n+q)\alpha(n))$ 的。

------------

将每个询问挂在其对应的最大点权上，然后对于每种权值的所有点，我们在此称其为关键点，建虚树，用于处理询问。

首先我们要求出虚树上相邻点之间的边重和边权，对应到树上就是一段求到祖先的路径最大值，精细实现一下可以做到单次 $O(\log n)$。

由于虚树总大小是 $O(n)$ 的，而求一条边又是 $O(\log n)$，故此处复杂度并不超过 $O(n\log n)$。

------------

这里提一嘴怎么树剖精细实现单 $\log$，知道的请跳过，算是个小 trick。

一条到祖先的链会被拆成 $O(\log n)$ 条重链上连续的区间，更具体的，是 $O(\log n)$ 个重链前缀询问和 $1$ 个重链区间询问，而前缀询问可以预处理后 $O(1)$ 得到，故可以在单次 $O(\log n)$ 得到最大值。

------------

然后我们还是按边重从大到小将虚树边加入到虚树中，并再次用并查集维护连通块的最大边权。

**注意**：这里合并边权的时候要注意细节，如果只是某个 LCA 而没有接到关键点上应该让 LCA 先挂在关键点并查集的下面，后面有关键点通过这个 LCA 并进来的时候再把边权信息合并。

然后在对应时刻处理询问，不难发现，询问的最大边权就是连通块内的最大边权和**询问点接到连通块的那段路径上的最大边权**取 $\max$。

连通块的最大边权已经用并查集维护出来了，于是考虑另一个最大边权。

我们的目标转化为找到询问点到某时刻一个连通块的路径最大边权，发现**询问点到任意一个关键点的路径必定包含了所需的这条路径**（其实是个常用 trick 来着）。

（附：有一种再建一棵虚树并对其树剖然后仍然是 $O(\log)$ 能够精确地找到这段路径的办法，由于写了可能就上 7k 了，不再赘述）

于是我们随便 $O(\log)$ 询问到某个关键点的路径取个 $\max$ 即可，这里可以用我们一开始就用并查集找到的某一个点。

至此我们就可以完完全全在 $O((n+q)(\log(n+q)+\alpha(n)))$ 的复杂度内解决这道题。

这种离奇的实现方法常数应该不大（唯一的夙愿就是跑得比 LCT 快）。