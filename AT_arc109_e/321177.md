博弈论！概率期望！计数！推式子！

# 策略

通过观察和打表可以得到以下结论：

- 结论 $1$：最终结果一定是不超过一段黑色连续段和不超过一段白色连续段构成。
    
    证明：显然，否则不满足题目描述。

- 结论 $2$：如果 $col_1=col_n$，则无论如何操作结果一定全为 $col_1$。

    证明：两端颜色无法被改变，因此一定会把另一种颜色的全部改变。

- 结论 $3$：设左侧连续段右端点 $l$，右侧连续段左端点 $r$，如果 $col_1\neq col_n$，则最终一定是保留 $l$，$r$ 扩展到 $l+1$ 或保留 $r$，$l$ 扩展到 $r-1$。

    证明：当石子被放在 $l$ 或 $r$ 中后，这一端的颜色将不再改变，而剩余一端在到达连续段前，一定会经过另一种颜色，这使得其余所有位置的颜色都变成先到达的一端。

- 结论 $4$：在结论 $3$ 的基础上，设两侧黑色连续段长 $len_{\mathrm{B}}$，白色连续段长 $len_{\mathrm{W}}$，若 $s$ 距白色连续段较近，则最终黑色石子个数为 $len_{\mathrm{B}}$，否则为 $n-len_{\mathrm{W}}$。

    证明：结合结论 $3$ 的证明，双方会尽量向各自颜色的一端移动，先到达的可以占有除两侧连续段以外的位置，而黑色先手先移动，因此只要到黑色一端距离不大于到白色一端，就可以达到目的。

# 计数

先统计个数之和再除以方案数。

以下默认 $n\ge 2$。

对初始颜色和位置 $s$ 进行分类讨论。

---

情况 $1$：两端均为黑色，显然总和是 $n2^{n-2}$。

---

情况 $2$：两端颜色不同，但只有两个连续段，此时结果固定，与 $s$ 的放置无关，总和是 $2\times [1+2+\cdots+(n-1)]=n(n-1)$。

---

情况 $3$：两端颜色不同，连续段个数大于 $2$，且 $s$ 在两侧连续段中的一个。

设左侧连续段右端点 $l$，右侧连续段左端点 $r$。

考虑在左侧连续段的情况，此时如果左侧为黑色，则答案为 $n-r$，反之答案为 $r$。因此其余位置不变，左黒右白或是左白右黑两种情况的结果之和是 $n$，这个性质非常重要。

$$
\begin{aligned}
&n\sum_{l=s}^{n-3}\sum_{r=l+3}^n 2^{r-l-3}\\
=&n\sum_{l=s}^{n-3}\dfrac{1}{2^l}\sum_{r=l+3}^n 2^{r-3}\\
=&n\sum_{l=s}^{n-3}\dfrac{1}{2^l}(2^{n-2}-2^{l})
\end{aligned}
$$

预处理一下前缀和即可。

在右侧连续段的情况类似：

$$
\begin{aligned}
&n\sum_{r=4}^s\sum_{l=1}^{r-3} 2^{r-l-3}\\
=&\sum_{r=4}^s2^r\sum_{l=1}^{r-3} \dfrac{1}{2^{l+3}}\\
=&\sum_{r=4}^s2^r\left(\dfrac{2^r-1}{2^r}-\dfrac{2^3-1}{2^3}\right)
\end{aligned}
$$

注意 $l,r$ 之间至少间隔 $2$ 个位置，且 $l+1,r-1$ 两个位置的颜色已经钦定了。

---

情况 $4$：两端颜色不同，连续段个数大于 $2$，且 $s$ 不在两侧连续段中的任何一个。

先考虑到两端距离不相等的情况，同样是如果左侧距离更近，则贡献和为 $n$，同理右端距离更近，贡献和也为 $n$，则要求的是：

$$n\sum_{l=1}^{s-1}\sum_{r=s+1}^n2^{r-l-3}[s-l+1\neq r-s+1]$$


即 $l+r\neq 2s$，可以先计算全部情况再减去相等情况。

全部情况的式子：

$$
\begin{aligned}
&n\sum_{l=1}^{s-1}\sum_{r=s+1}^n2^{r-l-3}\\
=&\dfrac{1}{8}n\sum_{l=1}^{s-1} \dfrac{1}{2^l}\sum_{r=s+1}^n 2^r\\
=&\dfrac{1}{8}n\left(\dfrac{2^{s-1}-1}{2^{s-1}}\right)(2^{n+1}-2^{s+1})
\end{aligned}
$$

删去 $l+r=2s$ 的情况需要卡一个比较精准的范围，$r=2s-l\in[s+1,n]$，于是 $l\in[\max(2s-n,1),s-1]$。

设 $m=\max(2s-n,1)$。

$$n\sum_{l=m}^{s-1}2^{2s-2l-3}=n\sum_{i=1}^{s-m}2^{2i-3}$$

最后 $l+r=2s$ 的答案需要再计算一次，若左侧为黑色则答案为 $n-(n-r+1)=r-1$，若右侧为黑色则答案为 $n-l$，因此每种情况对应答案为 $n+r-l-1$，注意到由于 $r-l>2$，所以 $l=s-1,r=s+1$ 的情况不能计算，$l$ 的范围应当是 $l\in[m,s-2]$，再推一下：

$$\sum_{l=m}^{s-2} 2^{2s-2l-3}(n+2s-2l-1)=\sum_{i=2}^{s-m}2^{2i-3}(n+2i-1)$$

---

这样就做完了。