首先是一个显然的转化：看做在 $n \times m$ 的循环网格图上行走，$0$ 为向右走，$1$ 为向下走。于是问题转化为：

> 在 $n \times m$ 的循环网格图上行走，每次只能向右或向下走，求从 $(1,1)$ 出发回到 $(1,1)$ 且除起终点不经过重复格子的回路数。

由于回路不定长，看起来没有什么特殊性质。

直接观察路径形态，容易发现整个回路是由若干条由左上边界到右下边界的连续路径组成的。考虑枚举这些路径的起终点，那么合法方案对应的起终点一定满足：

- 起点和终点数量相同，每个起点的对面都是终点，每个终点的对面都是起点。

- 第 $1$ 行或第 $1$ 列上必须存在起终点（因为必须从 $(1,1)$ 出发）。

- 记行上起终点数量为 $r$，列上起终点数量为 $c$，则 $\gcd(r,c)=1$（否则会形成多个回路）。

为了方便暂时先不考虑第二个条件。

同时若将所有起点及终点分别从右上至左下排序，则它们的连接方式必然是顺序一一对应的。

![](https://pic.imgdb.cn/item/63f6a797f144a010076c75bb.png)

那么如果枚举了起终点，直接使用 LGV 引理计算不交路径组数即可。

然而无法枚举起终点，矩阵也难以维护，直接计算行不通。

考虑更改图的形态，将所有行列都考虑进来，但允许一些相对的行列同时不作为起终点。同时引入变元 $x,y$ 作为边权以统计 $r,c$，如下图：

![](https://img.atcoder.jp/agc061/45c39a9885fa7ca59ffbd50188d2a4f7.png)

（图来自[官方题解](https://atcoder.jp/contests/agc061/editorial/5698)）

再使用 LGV 引理。但现在出现了一个问题：LGV 引理得到的结果中排列 $\sigma(S)$ 的方案数会带一个 $(-1)^{inv(\sigma(S))}$（$inv(P)$ 表示逆序对数）的权值，对于同一个 $x^{n-r} y^{m-c}$ 项这个值有可能不一样。

幸运的是，对于同一对 $(r,c)$ 逆序对数总是相同的。下面进行推导。

只考虑左上边界的点。称起点为特殊点，其它点为普通点。

首先特殊点间的逆序对数容易计算：行特殊点及列特殊点内部没有逆序对，而行特殊点及列特殊点间产生 $rc$ 对逆序对。

同样普通点内部也没有逆序对。

考虑一个列特殊点 $t$ 与普通点间的逆序对数。如果只有它一个列特殊点，那么普通点 $t+1,\cdots,n+t$ 会与它产生逆序对。

进一步的，产生逆序对的普通点是一段区间。记 $c[l,r]$ 表示标号为 $[l,r]$ 的点中特殊点的数量，则区间左端点是 $t-c[1,t)$，右端点是 $n+t-c[1,t)-c[m+1,m+n]-1$。

故该特殊点产生的逆序对数为 $n-r$。逆序对总数为 $(n-r)c+(m-c)r+rc=nm-(n-r)(m-c)$。

![](https://pic.imgdb.cn/item/63f6ae21f144a010077322f1.png)

于是这个问题得到解决。

还有一点小细节：第 $1$ 行或第 $1$ 列上必须存在起终点。显然这两个条件不可能同时满足，那么不妨设第一列上必须存在起终点，即不允许第一列的两个点同时不作为起终点，将对应边删去即可。

最后只需要计算下列矩阵的行列式：

![](https://pic.imgdb.cn/item/63f6b3d8f144a010077972c5.png)

暴力做法是对每个 $(x,y)$ 进行二元多项式插值，复杂度 $O(nm (n+m)^3)$，足以通过本题。

更优秀的做法是将 $y$ 换元成 $rx$，对 $r$ 进行插值。注意到将整个矩阵的每个元素除去 $x$ 后即求关于 $x^{-1}$ 的特征多项式，可以 $O((n+m)^3)$ 解决。于是总复杂度 $O(n(n+m)^3)$。

事实上任何形如 $det(A+Bx+Cy)$ 的问题都可以在 $O(n^4)$ 内得到解决：只需要对 $x$ 进行插值，跑 [$det(A+Bz)$](https://qoj.ac/problem/59) 即可。

代码只实现了 $O(nm(n+m)^3)$ 做法。

[**Code**](https://atcoder.jp/contests/agc061/submissions/39102934)