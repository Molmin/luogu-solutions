这个问题相当于有一个 $n\times m$ 的 torus（循环网格），每次可以从 $(x,y)$ 走到 $((x+1)\bmod n,y)$ 或 $(x,(y+1)\bmod m)$，从 $(0,0)$ 走到 $(0,0)$ 且不经过重复点的方案数。

抛掉一定从 $(0,0)$ 出发的限制，改成从任意点出发，最后除掉 $nm$。现在变成了 对于图中每个简单环，对答案有环长的贡献，计算总贡献。

下面以平面直角坐标系考虑，$x$ 轴长度为 $n$，$y$ 轴高度为 $m$。

接下来手绘一下几个方案，发现方案符合非常明显的规律：

取 $i$ 对上-下接口，取 $j$ 对左-右接口，把左下和右上接口依次配对，求不相交路径数。

要求 $\gcd(i,j)=1$，并且此时路径长度固定，为 $im+jn$。

![](https://cdn.luogu.com.cn/upload/image_hosting/rxf8pqiz.png)

不相交路径数可以用 LGV 数。

但是如果爆枚 $2^{40+40}$ 种取接口方案肯定寄了，尝试加上边表示“是否跳过”，构造下面这张图，边权为 $x,y$ 或 $1$，一对接口没有跳过就会乘上 $x$ 或 $y$。

![](https://cdn.luogu.com.cn/upload/image_hosting/f1p4s1or.png)

对左下节点-右上节点做 LGV，提取答案多项式的 $[x^iy^j]$，取 $\gcd(i,j)=1$ 的项，乘上 $im+jn$ 的系数，计算答案即可。

注意这样（如上图）构造的话，起点为 $\text{12345}$ 时终点会变成 $\text{45123}$，于是会自带上 $ij$ 的逆序对数，所以最后 $[x^iy^j]$ 这一项要乘上 $(-1)^{ij}$。

算 LGV 的多项式的话就用经典套路，取 $x\in[0,n],y\in[0,m]$ 代入算点值，然后插值就好了，复杂度 $O(nm\times (n+m)^3)$。

~~所以 F 是不是比 B 简单啊~~