注意到：对树上的两条路径 $(x,y)$ 和 $(X,Y)$，如果 $(x,y)$ 被严格包含于 $(X,Y)$，那么 $f(x,y)$ 一定大于 $f(X,Y)$。这说明

**性质** 对每个点 $x$，设 $y$ 是树上除了 $x$ 以外的节点中使得 $f(x,y)$ 最大的那个节点，那么原树上一定存在边 $(x,y)$。

我们考虑这样一个流程：先对每个点 $x$ 都找出它的最大出边 $(x,y)$，这些边是已经确定存在的了。接下来我们把已经确定的边所形成的连通块缩起来，再反复使用上面的算法，直到最后只有一个连通块为止。这样由于每次连通块数都至少减半，因而一定在 $O(\log n)$ 轮内停止，因而时间复杂度 $O(n^2\log n)$。这样我们就确定了树的形态。

（当然可以注意到上面的算法就是求解最大生成树的 Boruvka 算法，因而实际上我们要找的树就是原图的最大生成树。用别的最大生成树算法，如 Prim / Kruskal 算法也可以求解。）

最后我们需要确定每条边的边权。对一条边 $(x,y)$，设将它断开后和 $x$ 相连的部分总结点数为 $s_x$，和 $y$ 相连的部分总节点数为 $s_y$。那么这条边的边权 $w_{x,y}=\dfrac{f(x,x)-f(x,y)}{s_y}=\dfrac{f(y,y)-f(x,y)}{s_x}$，可以轻松求得。