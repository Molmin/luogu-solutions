若 $(x,y)$ 不存在，连接 $(x,y)$ 后可以发现环就是 $x$ 到 $y$ 路径上的点。我们此时可以在 $x$ 到 $y$ 的路径上找一点 $z$。不难发现，连接 $(x,z)$ 时的环和连接 $(z,y)$ 时的环是连接 $(x,y)$ 时的环的子集。

这样一来不难发现 $f(x,z),f(z,y)>f(x,y)$，所以原树即为以 $(x,y,f(x,y))$ 为边的最大生成树。

现在考虑把边权求出来，我们可以借助 $f(i,i)$ 表示所有点到自己的距离和来简化。随意选取一条边 $(x,y)$，那么只有在以 $x$ 为根时 $y$ 的子树内的点对 $f(x,x)-f(x,y)$ 有 $w_{(x,y)}$ 的贡献。子树大小可以轻松求出，相除即可。

复杂度 $O(n^2\log n)$，瓶颈来自 $\text{Kruskal}$ 求最小生成树，当然用 $\text{Prim}$ 也没问题。