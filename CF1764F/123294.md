标算的确厉害：注意到若 $i, j$ 不直接相连，则存在 $k$ 使得 $f(i, k)$ 和 $f(j, k)$ 均大于 $f(i, j)$，这和最大生成树的性质如出一辙。因此，我们断言原树结构即 $(i, j, f(i, j))$ 的最大生成树。

得到 $(i, j)$ 边权 $w$ 很容易。考虑到 $f(i, i) - f(i, j)$ 相当于 $w$ 乘以 $j$ 在以 $i$ 为根时的子树大小，所以 $w = \frac {f(i, i) + f(j, j) - 2f(i, j)} {n}$。

接下来讲讲我的做法。

考虑检查 $i, j$ 是否直接相连。考虑到若 $i, j$ 直接相连，则对于所有 $k$，$f(k, i) - f(k, j)$ 要么等于 $f(i, i) - f(i, j)$，此时 $k$ 在 $i$ 子树内，要么等于 $f(j, i) - f(j, j)$，此时 $k$ 在 $j$ 子树内。反之，则对于不在 $i, j$ 子树内的 $k$，必然有 $f(k, i) - f(k, j)$ 不等于上述两者。考虑按随机顺序枚举 $k$ 检查，若 $i, j$ 子树大小和为 $c$，则期望检查 $\frac n {n - c + 1}$ 次找到反例。

考虑一条链的极限情况，期望检查次数为 $\sum_{i = 1} ^ n \frac {n ^ 2} {i}$，时间复杂度 $\mathcal{O}(n ^ 2\ln n)$。[代码](https://codeforces.com/contest/1764/submission/183150346)。