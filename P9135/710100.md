考虑将操作的贡献拆分为删除和加入两部分的贡献。计数对象是所有元素的 $\text{lcm}$，因此可以对每个质数 $p$ 单独分析。记 $v_p(x)$ 表示 $x$ 的唯一分解中 $p$ 的指数，并记 $k_i \gets v_p(a_i), k_j \gets v_p(a_j), m_p = \max v_p(a), m'_p$ 为**非严格**次大 $v_p(a)$。不妨设 $k_i \geq k_j$。

删除元素 $a_i$ 时 $\text{lcm}$ 发生改变的必要条件是 $k_i = m_p$（与 $k_j$ 是否为 $m'$ 无关），此时 $p$ 的指数会变为 $m'_p$，因此贡献（$\text{i.e. lcm}$ 的变化系数）为 $\frac{1}{p^{m_p - m'_p}}$。用 $d_{i} = [k_i = m_p] \frac{1}{p^{m_p - m'_p}}$ 表示删除 $a_i$ 的贡献。则删除 $a_i, a_j$ 的贡献可以被表示为 $d_{i}d_{j}$（即使存在 $m_p = m'_p$ 的情况，可以发现这样计算也是正确的）。

加入 $x = a_i + a_j$ 时，贡献为 $h_x = p ^ {\max(0, v_p(x) - m_p)}$（此处忽略了 $x$ 中其它非 $p$ 的质因子的贡献）。至此我们可以把操作对质因子 $p$ 的贡献表示为 $d_id_jh_{a_i + a_j}$，可以证明这样计算不会使删除和加入两部分的贡献产生冲突。

推广到多个质数的情况，有 $d'_i = \prod_p [v_p(a_i) = m_p]\frac{1}{p^{m_p - m'_p}}$，$h_x = \prod_p p^{\max(0, v_p(x) - m_p)}$，操作贡献依旧可以表示为 $d'_id'_jh_{a_i + a_j}$。记 $L \gets $ 原序列 $\text{lcm}$，答案可写作
$$
\sum_{i < j} d'_{i}d'_{j}h_{a_i + a_j}L
$$
将 $d'$ 的定义域转为值域，记 $c_x$ 表示 $x$ 在 $a$ 中的出现次数，得 $d_{x} = c_x\prod_p [v_p(x) = m_p] \frac{1}{p ^ {m_p - m'_p}}$。转为枚举值域，得
$$
L\sum_k h_k \sum_{x + y = k} d_xd_y
$$
后式是一个比较明显的卷积，因此可以 $\mathcal{O}(V \log V)$ 计算。

注意计算结果需要减去选择了同一个数的情况，即 $L\sum_{i = 1} ^ n {d'_i}^ 2h_{2a_i}$（注意是 $d'$ 而非 $d$），由于选择是无序的最后应除以 $2$。