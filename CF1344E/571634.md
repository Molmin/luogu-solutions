## [CF1344E](https://www.luogu.com.cn/problem/CF1344E)

考虑 $u$ 的所有变换。设 $dis$ 表示根到 $u$ 的距离，将所有终点在子树内（不包含 $u$）的火车按发车时间从小到大排序，对于假设排序后第 $i$ 个火车发车时间是 $t_i$，终点是在 $u$ 的儿子 $v_i$ 子树内（包含 $v_i$），如果 $v_i!=v_{i+1}$，那么在 $i$ 火车驶出 $u$ 和 $i+1$ 火车到达 $u$ 这段时间内，需要将 $u$ 的下一个节点从 $v_i$ 切换到 $v_{i+1}$，即区间 $(t_i+dis,t_{i+1}+dis]$ 时间内需要对 $u$ 进行一次变换。

合并两个儿子的火车集合 $S,T$ 时，产生的新的区间个数是 $O(\min(|S|,|T|))$ 的。可以考虑将小集合中的火车插入到大集合中，每次插入最多加入两个区间，利用启发式合并的时间复杂度证明，区间个数是 $O(n\log_2 n)$。

启发式合并加 $\verb!std::set<int>!$ 得到所有区间，时间复杂度 $O(n\log_2^2n)$。

问题转化为有一个区间集合 $t$，判断是否有大小为 $|t|$ 的集合满足 $s_i\in t_i$。经典的贪心问题，可以参考其他题解或者我的代码，不进行赘述。

[代码](https://codeforces.com/contest/1344/submission/205419591)。