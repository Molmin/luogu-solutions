
- 介绍一种时间复杂度为 $O(n\alpha(n))$，但是实际上跑的很慢的做法。
- 前置知识（？）：[P4062 [Code+#1]Yazid 的新生舞会](https://www.luogu.com.cn/problem/P4062) 或类似的题。
- 我们对原序列两两分组，第 $i$ 组包含了第 $ i \times 2 -1 $ 和第 $ i \times 2 $  这两个数。
- 当一个区间 $[l,r]$ 存在绝对众数时，我们设 $c_{l,r}=1$，否则设 $c_{l,r}=0$。

- 首先，对于一个 $dp_i$ 来说，只有当 $c_{j+1,i} =0$ 时，$dp_j$ 才对 $dp_i$ 有贡献。解决有关绝对众数的问题时，我们常常枚举一个数 $d$，将其作为绝对众数。如果第 $i$ 组两个数都等于 $d$，我们设 $val_{d,i}=1$；两个数中有一个等于 $d$，则设 $val_{d,i}=0$；否则 $val_{d,i}=-1$。那么如果存在一个 $d$，满足 $\sum_{j=l}^r val_{d,i} > 0$，则 $c_{l,r}=1$。
- 对一个 $d$ 来说，我们先找出 $val_{d,i} =0$ 的所有 $i$，并将它们标记出来；再找出 $val_{d,i}=1$ 的所有 $i$，并标记 $i$ 左右最靠近 $i$ 且没有被标记的位置。可以发现，只有被标记的连续段内会互相产生贡献，段和段之间没有贡献。设对于 $d$ 来说有 $s_d$ 个数被标记了，可以发现所有 $s_d$ 的和是 $O(n)$ 级别的。（一个 $i$ 最多只会额外标记 $2$ 个数）在这个过程中，我们需要处理出 $i$ 在哪些 $d$ 被标记了，且这个过程的时间复杂度为 $O(n\alpha(n))$（使用并查集实现）。



- 设 $pre_{d,i}=\sum_{j=1}^i val_{d,j}$，则 $dp_j$ 对 $dp_i$ 有贡献，当且仅当 $pre_{d,i}>pre_{d,j}$。则每次求 $dp_i$ 的值时，我们其实是在询问 $\sum_{j<i,pre_{d,j}<pre_{d,i}}dp_j$。我们维护一个类似于桶的东西，$bk_{d,k}$ 维护了当区间众数为 $d$ 时，所有 $pre_{d,j}=k$ 的 $j$ 的 $dp_j$ 之和。我们设 $sum_d $ 表示 $\sum_{k=-\infty}^{pre_{d,i}-1}bk_{d,k}$，则有 $dp_i=\sum_{j=0}^{i-1}dp_j -\sum_{d=1}^n sum_d$。我们找出 $i$ 被哪些 $d$ 所标记了，并询问 $sum_d$；如果 $i$ 没有被一个 $d$ 所标记，那么 $sum_d$ 一定为 $0$。每次更新完 $i$   的 $dp_i$ 后，再让 $bk_{d,pre_{d,i}} =bk_{d,pre_{d,i}}+dp_i$。

- 对于询问 $sum_d$，有一个重要的性质是对于同一个 $d$ 来说，同一段内两个相邻的 $i$ 的 $pre_{d,i}$ 之差最多只有 $1$。所以对于 $i=i+1$ 之后，$sum_d$ 最多只需要加上一个值就可以被更新：
1. 如果 $val_{d,i}=1$，则 $sum_d=sum_d+bk_{d,pre_{d,i}}$；
2. 如果 $val_{d,i}=0$，则 $sum_d$ 不变；
3. 如果 $val_{d,i}=-1$，则 $sum_d=sum_d-bk_{d,pre_{d,i-1}}$。

如果对于一个 $d$ 来说出现了 $i$ 跨越段的情况，因为段和段之间不可能有贡献，所以我们只需要将 $sum_d$ 和 $bk_d$ 清空即可。所以我们可以做到单次询问 $sum_d$ $O(1)$，而我们的总询问量是 $O(n)$ 级别的（$\sum_{d=1}^ns_d$ 是 $O(n)$ 级别的），所以可以做到 dp 过程复杂度为 $O(n)$。


一些细节：

- 对于一个 $d$ 来说，设被标记的连续段开头为 $x$，则可以认为 $pre_{d,x-1}=0$。（因为我们会在跨越段的时候清空 $bk_d$）这样可以保证所有被标记的 $i$ 的 $\max(pre_{d,i})\leq s_d,\min (pre_{d,i}) \geq -s_d$。所以可以使用 $n$ 个 vector 存储 $bk_{d,pre_{d,i}}$，并在开始 dp 之前提前 resize。

- 一个 $dp_j$ 并不会给 $dp_i$ 产生多次贡献，因为区间 $[j+1,r]$ 最多只有一个绝对众数。


- 谢谢 Alan_Zhao 本题的 $O(n\log n)$ 做法和对题解的一些建议。

[代码云剪贴板](https://www.luogu.com.cn/paste/tte074us)


 