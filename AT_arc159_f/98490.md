绝杀题，直接上 3 Dan 了。

先考虑满足条件的 $X$ 是啥样的。

容易发现，$|X|$ 必须是偶数，并且不存在绝对众数。

绝对众数的定义是，出现次数超过 $\frac{|X|}{2}$ 的数。

咋证呢，对于一个 $X$，如果存在一个绝对众数，那么它一定不合法。

否则，考虑进行一次删除操作时，只有出现次数为 $\frac{|X|}{2}$ 的数可能会不合法。

讨论一下，如果有两个这样的数，那么整个序列一定只有这两个数，直接操作一组即可。

否则，只要找到出现次数为 $\frac{|X|}{2}$ 的数，必然有一个可以和旁边的操作。

这样就可以一直保持合法状态，所以合法。

## $O(n^2)$ 做法

直接对着这个暴力即可，设 $f_i$ 表示前 $i$ 个数的方案数，然后暴力枚举前面满足条件的左端点，维护一下当前区间众数。

[code](https://atcoder.jp/contests/arc159/submissions/40421268)

场上甚至还写了一发来验证一下结论。

## $O(n\log^2 n)$ 做法

绝对众数，考虑一下摩尔投票，但是这个题好想不太能直接用。

摩尔投票满足一个可加性，换句话说就是如果把一个区间裂成两半，那么绝对众数一定至少在一半里是绝对众数。

考虑 cdq 分治，对于区间 $[l,r]$，先把 $[l,mid]$ 的 dp 值先去递归算出，然后只需要考虑左边对右边的贡献，相当于只需要找出所有跨过 $mid$ 的有绝对众数区间。

跨过 $mid$，自然是分成左右两半，一个满足条件的区间一定在左边或者右边是区间众数。

对左边求后缀绝对众数，右边求前缀，会发现前缀不同绝对众数只会有 $O(\log n)$ 个，因为每次出现一个，所需要的区间长度翻倍。

然后一个区间最多只有一个绝对众数。

所以对于 $O(\log n)$ 个绝对众数，每个做一遍前缀和，这样就可以快速算出所有需要减去的区间了。

[code](https://atcoder.jp/contests/arc159/submissions/40425986)

[官方题解](https://atcoder.jp/contests/arc159/editorial/6171)有线性做法，有兴趣的可以自己了解。