先确定开始的点，再按照题意的运动方式模拟的做法没有很大的优化空间。

果断改变思路，考虑让所有的点一起走，然后把走出了边界的点舍弃，可以证明这样行走在任何时刻剩余的点一定填满了一个棱平行于坐标轴的 $k$ 维超立方体。

可以归纳证明：一开始所有的点显然填满了这个 $k$ 维超立方体，之后每一步对它的影响都是至多从某个维度超越了边界，然后顺着这个 $k - 1$ 维边界被削掉一层，剩余部分显然也是个 $k$ 维超立方体。（可以考虑用 $3$ 维的理解一下。）

这样对于每一步有贡献的点，就是走这一步之前，剩余的点构成的超立方体的 $k$ 维体积。

直接按照这个方式模拟，判一下无解（走完 $n$ 步之后总位移为 $0$ 且仍旧存在剩余的点）即可得到 45 分。（代码可以见下面 Code 部分。）

----

正解做法非常优美。

因为剩余点是个棱平行于坐标轴的超立方体，那么在每个维度上一定排布成了一个连续区间。

手玩或者模拟可以发现一个关键的结论：除了前 $n$ 步之外，剩下的每 $n$ 步在每个维度上对剩余区间大小的减少量都相等。

这样可以先做一个预处理，先模拟一轮，求出每个维度上剩余区间的大小，每个维度之后每一轮的减少量，一轮中走第 $i$ 步（$1 \le i \le n$）之前每个维度的剩余区间大小分别减小了多少。我将其分别记为 $rev(d), del(d)$ 和 $f(i, d)$。

然后求出这个周期性计算最多能支持多少完整的轮，即最多多少轮之后任意一个维度上剩余区间的大小仍严格大于 $0$，记为 $t = \min\left\{\dfrac{rev(d) - 1}{del(d)}\right\}$。多出来的那个不完整的轮仍然可以直接模拟。

然后是统一计算中间这部分，先写一下用这三个预处理的量表示出来的模拟时的式子：

$$\sum_{x = 0} ^ {t - 1} \sum_{j = 1} ^ n \prod_{d = 1} ^ k\left(\left(rev(d) - f(j, d)\right) - x \cdot del(d)\right)$$

$\displaystyle\sum_{j = 1} ^ n\prod_{d = 1} ^ k\left(\left(rev(d) - f(j, d)\right) - x \cdot del(d)\right)$ 是一个关于 $x$ 的 $k$ 次多项式，可以将其暴力 $O(nk^2)$ 计算出每一项的系数，设其为 $\displaystyle\sum_{i = 0} ^ k c_ix^i$，那么改变一下枚举顺序，上面的式子就可以变化为：

$$\sum_{i = 0} ^ k c_i \left(\sum_{x = 0} ^ {t - 1}x^i\right)$$

算 $\displaystyle\sum_{x = 0} ^ {t - 1}x^i$ 的时候，只要用的是用 $i + 2$ 个点值求出这个 $i + 1$ 次多项式的大部分方法都是可行的。（如拉格朗日插值或者高斯消元，复杂度上 $k$ 的指数是 $2, 3, 4$ 然后带上一只或者两只 $\log$ 问题都不大，代码中为了方便直接写了单个 $O(n^2)$ 的插值。）

代码可以在[博客园](https://www.cnblogs.com/zimujun/p/liansai_buti2021.html)查看。