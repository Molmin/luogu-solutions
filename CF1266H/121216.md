设 $x_i$ 表示经过 $i$ 指出的红边的次数，$y_i$ 表示经过 $i$ 指出的蓝边的次数，那么 $x_i=y_i+[s_i=R]$。假设所在点为 $v$，那么除了 $1$ 和 $v$ 外的点进去和出来的次数都相等，$1$ 多出来一次，$v$ 多进去一次，设 $R_i$ 表示有红边指向 $i$ 的点的集合，$B_i$ 表示有蓝边指向 $i$ 的点的集合，即 $\sum_{r\in R_i}x_r+\sum_{b\in B_i}y_b=x_i+y_i-[i=1]+[i=v]$，代入 $x_i=y_i+[s_i=R]$ 并化简得：$2x_i-\sum_{r\in R_i}x_r-\sum_{b\in B_i}x_b=[s_i=R]-\sum_{b\in B_i}[s_b=R]+[i=1]-[i=v]$。

可以发现等式左边是由图的结构决定的，不会因询问发生变化，用矩阵 $A$ 表示系数，$x$ 表示未知数组成的向量，$z$ 表示等式右侧的值组成的向量，即 $Ax=z$。注意到由矩阵树定理 $A$ 的行列式即以 $n$ 为根的根向树个数，而 $n$ 从任意一个点出发都可达，所以 $A$ 的行列式大于 $0$，即 $A$ 满秩，所以 $A$ 存在逆矩阵。求出 $A$ 的逆矩阵 $A^{-1}$，每次查询时由 $x=A^{-1}z$ 可以 $O(n^2)$ 解得 $x$。知道 $x$ 后答案即为 $\sum_{i=1}^{n-1}(2x_i-[s_i=R])$。

但是满足上述方程只是状态可达的必要条件，而这并不充分。其充要条件为：1. 由上述方程解得的 $x$ 都为非负整数，特别地，$s_i=R$ 时 $x_i$ 不能为 $0$。2. 只考虑每个点的活跃边的导出子图，每个被经过至少一次的点都可以只通过活跃边（有向的）到达 $v$。

先考虑必要性。第一个条件比较显然，第二个条件考虑对 $\sum_{i=1}^{n-1}(2x_i-[s_i=R])$ 进行归纳证明：$\sum_{i=1}^{n-1}(2x_i-[s_i=R])=0$ 时显然；设 $\sum_{i=1}^{n-1}(2x_i-[s_i=R])=k-1$ 时在点 $u$，则 $k-1\rightarrow k$ 时 $u$ 交换其指出的两条边的活跃性，并沿着新的活跃边走到了 $v$，由于 $k-1$ 时所有被经过至少一次的点都可以只通过活跃边到达 $u$，且它们能否到达 $u$ 与 $u$ 连出的活跃边指向哪并没有关系，所以 $k$ 时所有被经过至少一次的点（除去 $v$）仍都能到达 $u$，再通过 $u$ 的活跃边便都能到达 $v$。

再考虑充分性。首先 $\sum_{i=1}^{n-1}(2x_i-[s_i=R])=0$ 时所有满足上述条件的 $(s,v)$ 一定合法，且恰有一组 $(s,v)$ 满足条件。设 $\sum_{i=1}^{n-1}(2x_i-[s_i=R])=k-1$ 时所有满足上述条件的 $(s,v)$ 都合法，且恰有一组 $(s,v)$ 满足条件，$k$ 时 $(s',v')$ 满足上述所有条件。考虑在原图的活跃边的导出子图中，所有被经过至少一次的点与它们能否到达 $v'$ 与 $v'$ 连出的活跃边指向哪并没有关系，可知若在导出子图中 $v'$ 的活跃边指向的点未被访问过，则所有被经过至少一次的点形成了一棵以 $v'$ 为根的根向树，同时可知 $v'$ 是第一次被到达，且在导出子图中指向 $v'$ 的活跃边有且仅有一条，因此可以唯一确定 $k-1$ 时的满足条件的状态；否则，$v'$ 的活跃边指向其子树内一点 $w$，$w$ 的祖先中活跃边指向 $v'$ 的点是 $u$，那么 $v'$ 只有是从 $u$ 来的才能使 $k-1$ 时的状态满足条件（否则不满足条件 $2$）。所以已知 $k$ 时满足条件的 $(s',v')$ 可以恰好确定一组 $k-1$ 时满足条件的 $(s,v)$，而如果 $k-1$ 时有至少两组不同的 $(s',v')$ 满足条件，那么可以确定至少两组 $k-1$ 时满足条件的 $(s,v)$，且 $(s,v)$ 互不相同，这与归纳假设矛盾。所以 $k$ 时恰有一组 $(s',v')$ 满足上述条件，自然也就合法了。

因此，只需判下是否有解，再用上述方法求解即可。根据上述分析，给定 $s$ 和 $v$ 后可以唯一确定 $x$，所以答案在 $[0,(n-1)2^{n-1}]$ 之间，那么可以用两个大于 $(n-1)2^{n-1}$ 的质数作为模数求出模意义下的结果，根据在不同模数下结果是否相等可以判断出 $x$ 是否是非负整数。时间复杂度 $O(n^3+qn^2)$，空间复杂度 $O(n^2)$。