有删减，原文见[**我的博客**](https://www.cnblogs.com/SharpnessV/p/15177914.html)。

对于初始排列，就是求原序列的逆序对数。

对于逆序对我们可以拆开来算，用 $[i,j]$ 表示满足 $a_u =i,a_v=j,i>j$ 二元组 $(u,v)$ 个数。

那么初始答案可以表示为 $\sum\limits_{i = 1}^{k}\sum\limits_{j = i + 1}^{k}[i,j]$。

推导之后可以得到，对于一次交换，令交换的两个数为 $x,y$，我们只用在上一次答案的基础上加上 $2\times[x,y] - c _x\times c_y$，其中 $c_i$ 表示 $i$ 在原序列中出现的次数。

现在我们只用求 $[x,y]$​，这个玩意本质上也是求逆序对，考虑根号分治，对于 $c_x, c_y\le \sqrt n$ 的直接爆算，其余的离线后对整个原序列扫一遍统计答案。

由于 $q$ 远大于 $n$ ，我们令 $lim$ 表示对于 $c_x, c_y\le lim$ 的 $[x,y]$ 进行爆算，解方程 $q\times lim = \frac{n^2}{lim}$，解的 $lim = 100$ 时最优。