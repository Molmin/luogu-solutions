考虑枚举转折点 $k$ 使得 $a_1 \le \cdots \le a_k \ge a_{k+1} \ge \cdots > a_n$ .

然后答案就是前面的最小答案加后面的最小答案 .

于是只需要处理前缀修改成不下降序列的最小操作次数和后缀修改成不上升序列的最小操作次数，这两个是等价的，以下就以前缀修改成不下降序列为例 .

考虑 DP，令 $dp_{i,j}$ 表示将 $a_{1\dots i}$ 改为不下降且最后 $a_i=j$ 需要的最小步数，则考虑枚举 $a_{i-1}$ 可得转移为
$$dp_{i,j}=\min_{0\le k\le j}\{dp_{i-1,k}+f(a_i,j)\}$$
其中 $f(x,y)$ 表示将 $x$ 改为 $y$ 需要的最小操作次数 .

这样维护一个前缀 $\min$ 即可 $\Theta(V)$ 转移 .

于是时间复杂度为 $\Theta(nV)$，$V$ 是值域 .

可以滚动数组优化空间复杂度到 $\Theta(V)$，不过卡空间不好所以不滚也是可以过的 .