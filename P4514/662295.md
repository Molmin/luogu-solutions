### CDQ 分治套扫描线

###### 无 O2 单点时间 $\leq$ 800ms

------------

#### 前言

这道题很有名，二维树状数组的模板——当然，这篇题解不写二维树状数组。

感谢 @[H_Kaguya](https://www.luogu.com.cn/user/663405) 和 @[yllcm](https://www.luogu.com.cn/user/682934) 指教扫描线相关问题。

前置知识：差分、线段树、树状数组、扫描线、CDQ 分治。

------------

#### 线段树 + 扫描线

使用扫描线、线段树和差分离线解决静态问题：平面加**之后**平面求和。

扫描线的收益：问题降一维，维护一个一维线段树即可。

扫描线的代价：问题转为在线，所以扫描线只能用一次。

将修改和查询按照某个坐标轴差分成两个平面修改或平面查询（将矩形拆成两个等长对边），本文中扫描线全部按 y 轴差分且按照 y 轴坐标从小到大扫描。

为保证答案正确，差分时将询问中高度较小一边高度 $-1$，修改中高度较大一边高度 $+1$，等高度的情况先执行修改操作。

使用两次扫描线，第一次扫描时直接执行修改，在查询时将贡献乘以该查询的 y 轴坐标 $+1$（查询的 y 轴坐标修改后可能是 $0$，两次统计时线段树中的信息可能不等），同一查询先减后加。第一次扫描线的修改如果全部执行，线段树会自行清空。第二次扫描时将修改的贡献乘以其 y 轴坐标，同一查询先加后减，线段树不会清空这次扫描的修改（差分后的修改带了高度权值）。

可以感性理解为第一次统计查询范围内“不完整”的矩形，第二次统计查询范围内“完整”的矩形并且去掉第一次扫描加入的多余贡献。

时间复杂度： $O(n\log n)$。

[Code](https://www.luogu.com.cn/paste/pkm4y5fh)：扫描线解决静态二维平面加 & 平面求和。

PS：写得这么多是因为网上没有多少文章讲这个，至少笔者学习的时候没有找到。

------------
#### CDQ 分治和进一步优化

这道题并非静态问题，但 CDQ 分治可以做到化动为静，需要离线处理。

按照时间顺序划出分治线，处理分治线左侧修改操作对分治线右侧查询操作的贡献即可，扫描线的使用方法上文已经讲了。关于 CDQ 分治，具体解释和使用方法可以看 [OI Wiki](https://oi-wiki.org/misc/cdq-divide/)，需要注意的是不能重复统计贡献，而且要按时间顺序进行操作。

分治执行 $\log n$ 层，时间复杂度 $O(n\log^2 n)$。

注意：第二次扫描之后清空数据结构。

[Code](https://www.luogu.com.cn/paste/7mbt341x)：朴素代码，询问和修改使用了同样的结构体。[评测记录](https://www.luogu.com.cn/record/102064908)，[吸氧可过](https://www.luogu.com.cn/record/102065532)。

但是如果要吸氧才能通过，这篇文章就没有意义了，为什么不写正解呢？~~我自己推不出来正解的式子~~。

开始优化，首先注意到分治过程中对一个操作差分了很多次，而更碍眼的是夹在分治函数里面的 ```sort```，它不影响复杂度，但带来了巨大的常数，另外线段树需要开 ```long long```，也在一定程度上影响了程序效率。

此时瓶颈应该在 ```sort```。考虑如何去掉它，可以使用 CDQ 分治的常见套路：归并排序优化。分治线左边的操作无论如何都比右边的查询更早执行，可以先递归左半边和右半边，扫描线，归并左右区间。实现后即可删除 ```sort```。

问题出现：操作差分之后才能排序。

把操作差分之后再分治不就行了？很遗憾，直接这样做会稻花香里说丰年——扫描线的过程中，同一个查询或修改操作差分后不能分开。

苦思冥想（2min）后，想到 FFT，发现用 $2$ 的整数次幂作分治总长度时分治树为完美二叉树，同一个操作差分后不会分开，同时由于分治长度为 $2$ 时必定为同一操作的差分，自然满足排序条件，递归层数可以减少一层。用空操作填充序列直到总长度为 $2$ 的整数次幂即可。

额外优化：只有区间内同时存在修改和查询时才会影响答案，用前缀和判断。

[Code](https://www.luogu.com.cn/paste/vlffs9bq)：此时的代码已经能通过[六个测试点](https://www.luogu.com.cn/record/102085539)。

最后的瓶颈是线段树，换成区间加区间求和的树状数组即可，也不用开 ```long long``` 了。最后还是写了树状数组。

[AC Code](https://www.luogu.com.cn/paste/hb9p4t6m)：[评测记录](https://www.luogu.com.cn/record/102086860)。

------------

#### 总结

效率比正解差，也许读者会认为这种解法不很值得学习，但是作为离线算法，它也有二维树状数组没有的优点。

- 统计贡献不受 y 轴值域影响：这一维被扫描线扫掉了，数据结构不需要关心它，它的值域也不影响扫描线进行。
- 统计贡献不受 x 轴值域影响：使用值域离散线段树记录区间，区间加时将加值乘以区间的实际长度，树状数组不能实现。

本题虽然是为二维树状数组设计的，但 CDQ 分治套扫描线的解法也适用，而且这种离线分治的方法在更大的数据范围下表现会更好。

2023.6.15:由于补齐了序列，可以将分治换成倍增。

------------

#### 闲话

当初写这种解法的时候，没有打算通过，一步步优化后却取得了意料之外的成果，十分令人欣喜。

题解区没有这种做法，也许是认为效率太低？笔者认为能够不开 O2 优化通过已经足够，毕竟题目的数据范围较小，操作较多，树状数组以外的做法很难胜任。

虽然思路早就有了，实现却花费了很长时间，积累了宝贵的经验。