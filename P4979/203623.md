挺板子的。

题意简述：

一只包含 A，B，C 的字符序列，俩操作：

1. 区间推平

2. 判断区间是否全等，且 $a_{l-1}\ne a_{r+1}$（当然如果 $l=1$ 或者 $r=n$ 就不用判断这个条件）。

虽然线段树可以直接维护，但是还是用一种思维难度较小的方法。

先把序列转换，对于三个字母，分别用三个有识别度的大数字代替。

如果怕被卡可以用随机数。

然后线段树维护区间和，区间推平。

对于操作 $2$，令 $ans=\dfrac {\sum_{i=l}^r a_i} {r-l+1}$，说人话即区间 $[l,r]$ 的平均数（线段树基本操作）。不难得知如果 $ans$ 是三个字母对应的数之一那么大概率满足区间全等。

然后对于第二个条件直接单点求值即可。

~~一开始憨憨地维护了异或和~~