### 前言
小蒟蒻在拿了4个CE4个WA，心态被搞崩 $114^{514}$ 次，反复趋势一小时后，终于切了这道题，准备发篇题解纪念一下。
### 解法
![](https://cdn.luogu.com.cn/upload/image_hosting/2xcbk88k.png)

因为 $n$ 的范围只有 $300$，所以考虑直接枚举蓝色部分，枚举这一部分的时间复杂度是 $\Theta(n^3)$。为保证复杂度的正确性，我们需要用 $\Theta(\log n)$ 或 $\Theta(1)$ 的时间求出绿色和红色部分的值。这是不能直接求的，考虑dp。令 $f_{i,j,k}$ 表示左下角端点和右下角端点分别为 $i$ 行 $j$ 列，$i$ 行 $k$ 列的格子的红色部分的最大高度。如果的两个格子中间的格子都没有瑕疵，则 $f_{i,j,k}$ 可以为 $0$。（即当前的左右端点可以是红色的最上面一行）。否则，如果两个格子都没有瑕疵，那么可以从上一行直接转移。否则，当前的状态就是不合法的。判断两个格子之间的格子是否有瑕疵可以用前缀和优化到 $\Theta(1)$，这样整个dp的过程就是 $\Theta(n^3)$ 的。预处理绿色部分的过程同理。$g_{i,j,k}$ 表示左上角端点和右上角端点分别为 $i$ 行 $j$ 列，$i$ 行 $k$ 列的格子的绿色部分的最大高度。

形式化的状态转移方程如下：（$x(i,j)=0$ 等价于 $i$ 行 $j$ 列的格子无瑕疵）
$$f_{i,j,k}= \begin{cases}\max\{0,f_{i-1,j,k}+1\} & (\forall p \in [j,k],x(i,p)=0)\\f_{i-1,j,k}+1 &(x(i,j)=0\ \land\ x(i,k)=0)\\-\text{inf}& \text{otherwise.}\end{cases}$$
还有一个遗留的问题：题目中要求一个矩形框的底边是是另一个矩形框的顶边的子集。在枚举蓝色的时候，绿色部分可以唯一确定（两端点已唯一确定），但是无法确定红色部分的两端点。令 $dp_{(i),j,k}$ 表示第 $i$ 行中，左下角端点和右下角端点在区间 $[j,k]$ 之间的红色部分的最大面积。可以发现，$dp_{(i),j,k}$ 的值可以通过两个长度为 $k-j$ 的子区间转移得到。这本质上是一个区间dp。

形式化的状态转移方程如下：

$$dp_{(i),j,k}=\max\{dp_{(i),j+1,k},dp_{(i),j,k-1},f_{i,j,k}\times(k-j-1)\}$$
### 卡常
都写完了，[自信地往上一交](https://www.luogu.com.cn/record/97372374)

因为 $f$ 数组和 $g$ 数组中的值都不超过 $n$，所以可以使用赛加加的 `short` 类型，该类型存储数据的范围为`-32768~32767`。这样就可以卡过去了。

[代码在这里](https://www.luogu.com.cn/paste/qw0vrl37)