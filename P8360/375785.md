一眼分块，然后想怎么分块。

设块长为 $B$。

对于 $1,2$ 操作，将其两端的块暴力重构，中间的块打标记，能够 $O(1)$ 维护出区间各种颜色的数量以及区间和。

暴力重构，具体地就是，对于每个块，把其作为中间块的操作都存下来；当其作为两端的块时，可以用并查集，从而维护出每个点的颜色与数量。

对于查询，如果其作为中间块，可以通过维护出的区间和直接求出答案，两端仍然可以重构。

不考虑重构的单次操作复杂度为 $O(B+\frac nB)$；重构共有 $\frac{qn}b$ 个标记，总共重构 $O(q)$ 次，复杂度是 $O\left(\big(qB+\frac{qn}B\big)\log\right)$。

这样做是 $O\left(q\sqrt n\log\right)$。

考虑怎么去掉 $\log$，即不使用并查集。

注意不到，将序列倒置，从后向前操作，就可以不用并查集了。

最终复杂度为 $O(q\sqrt n)$。