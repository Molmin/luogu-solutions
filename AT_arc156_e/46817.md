### 充要条件

容易发现，序列 $(X_1,...,X_N)$ 是好的，当且仅当：

- 记 $S=X_1+...+X_N$，$S$ 是偶数，且 $\forall 1\le i\le N,X_i+X_{i\mod N+1}\le \frac{S}{2}$。

对最后一个条件容斥，答案等于：无限制的方案数，减去存在一个位置不满足，再加上两个位置不满足。注意后者两个位置一定相邻。

### 无限制的方案数

记 $f(x)=\frac{1-x^{M+1}}{1-x}$，这个序列的生成函数就是 $f(x)^N$。所求为这个多项式不超过 $K$ 的偶数次系数之和。

不妨设 $K$ 为偶数，那么所求等于 $[x^K]\frac{f(x)^N}{1-x^2}$。

$f(x)^N$ 的上下次数都较高，不如先求出 $g(x)=\frac{(1-x^{M+1})^N}{1-x^2}$，然后就可以快速求出 $[x^K]g(x)(1-x)^{-N}$ 了。

### 存在一个位置不满足的方案数

不妨设不满足的位置是 $1$。

枚举 $T=X_3+...+X_N$，对 $X_1,X_2$ 的限制只和 $X_1+X_2$ 有关。

注意到 $T<2M$，可以在 $O(M^2)$ 的时间内求出 $f(x)^{N-2}$ 的前 $2M$ 项，也就是 $X_3...X_N$ 的填法。

枚举 $X_1+X_2,T$ 计算，复杂度 $O(M^2)$。

### 两个位置不满足的方案数

不妨设不满足的位置是 $1,2$。

枚举 $X_2,T$，
所求为 $\sum\limits_{0\le X_2\le M,T}[x^T]f(x)^{N-3}h(X_2+T,X_2-T)$。

其中 $h(a,b)=\sum\limits_{0\le X_1,X_3\le M,2|X_1+X_3+a}[X_1+X_3\le K-a\land |X_1-X_3|< b]$。可以前缀和预处理。

总时间复杂度 $O((N+M)M)$。