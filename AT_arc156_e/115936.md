当允许有 $(i,i+1)$ 的边时，满足题目要求有充要条件 $S=\sum x_i$ 为偶数且不存在某个 $x_i>\frac{S}{2}$。

考虑在这个基础上去调整，将 $(i,i+1)$ 的边找个没有公共点的边去重新选边。那么充要条件为 $S=\sum x_i$ 为偶数且不存在某个 $x_i+x_{i+1}>\frac{S}{2}$。考虑对这个东西计数。

直接数是很麻烦的，但是如果去容斥的话，容易发现由于 $>\frac{S}{2}$，所以需要考虑的情况只有两种，一种是存在 $x_i+x_{i-1}>\frac{S}{2}$，一种是在满足前面一个条件的同时满足 $x_{i-1}+x_i>\frac{S}{2}$。设前面的情况的方案数为 $B$，后面的方案数为 $C$，总的方案数为 $A$，那么答案就是 $A-B+C$。

考虑逐个计算。

对于总方案数，相当于求 $n$ 个 $[0,m]$ 的数凑出来的和 $\le k$ 且为偶数的情况。我选择从生成函数的角度去考虑。

每个数的 GF 是 $1+x+x^2+...+x^m=\frac{1-x^{m+1}}{1-x}$，那么 $n$ 个数乘起来就是 $(\frac{1-x^{m+1}}{1-x})^n$。把分子分母拆开，令 $F(x)=(1-x^{m+1})^n,G(x)=\frac{1}{(1-x)^n}$。那么所求为 $F(x)G(x)$ 的 $\le k $ 的偶数次项的系数。

对于 $F(x)$ 考虑二项式定理展开。

$$F(x)=\sum_{i=0}^n(-1)^i\binom{n}{i}x^{(m+1)i}$$

而 $G(x)$ 是一个很经典的式子，也可以组合意义理解为 $n$ 个没有限制的值凑出来一个和的方案数。

$$G(x)=\sum_{i}\binom{i+n-1}{n-1}x^i$$

枚举 $F(x)$ 的每一项，乘上 $G(x)$ 的一个前缀和即可。复杂度 $O(k)$。

然后还要去除 $x_i>\frac{S}{2}$ 的情况。但是因为 $x_i\le m$ 所以 $S< 2m$，所以不妨直接枚举 $x$ 和 $S$，剩下的部分插板即可，贡献是 $n\times\binom{S-x+n-2}{n-2}$。复杂度 $O(m^2)$。

为了方便，我们可以实现一个函数 $Calc(n,S)$ 表示用 $n$ 个 $[0,m]$ 的数凑出和**恰好**为 $s$ 的方案数。计算方法依然是 $F(x)G(x)$，因为 $F(x)$ 每 $m+1$ 位才有值，所以这个复杂度是 $O(\frac{S}{m})$。

对于 $B$，不妨设 $x_1+x_2>\frac{S}{2}$。因为 $x_1,x_2\le m$，所以有 $S< 4m$。我们考虑枚举 $S$ 和 $S_1=x_1+x_2$。然后考虑把 $x_2$ 用 $S_1-x_1$ 表示，列出与 $x_1$ 有关的不等式。

$$0\le x_1,S_1-x_1\le \min(m,\frac{S}{2})$$

$$S_1-\max(m,\frac{S}{2})\le x_1\le\min(m,\frac{S}{2})$$

有了范围，直接算出 $x_1$ 的情况数即可。复杂度 $O(m^2)$。

然后对于其他数乘上一个 $Calc(n-2,S-S_1)$ 即可。因为 $S<4m$，所以调用该函数的复杂度可以视作常数忽略不计。

对于 $C$，不妨设 $x_1+x_2,x_2+x_3>\frac{S}{2}$。同理有 $S<4m$。枚举 $S$ 和 $S_1=x_1+x_2+x_3$。

接着我们考虑如果我们再去枚举一个 $x_2$ 的话相关的不等式会变成什么样子，尽管直接枚举是 $O(m^3)$ 的。我们将 $x_3$ 用 $S_1-x_2-x_1$ 表示，列出关于 $x_1$ 的不等式。

$$\frac{S}{2}-x_2+1\le x_1,S_1-x_2-x_1\le\min(S_1-x_2,\frac{S}{2},m)$$

化简。

$$\max(\frac{S}{2}+1,S_1-\frac{S}{2},S_1-m)-x_2\le x_1\le \min(\frac{S}{2},m,S_1-\frac{S}{2}-1)$$

容易发现右端点是一个常数，而左端点随着 $x_2$ 增加而减少，那么 $x_1$ 的可选方案数就构成一个公差为 1 的等差数列。直接求和即可。

复杂度 $O(m^2)$。然后同理调用 $Calc(n-3,S-S_1)$ 去计算其他数的方案数。复杂度同理，忽略不计。

值得一提的是算完 $B$ 和 $C$ 都要 $\times n$，原因显然。

https://atcoder.jp/contests/arc156/submissions/39080070