这里提供一种@_Enthalpy教我的其实是AGC标解的方法

希望大家能读完这片题解，看上去性质很多很杂，其实你会发现每一步都很逻辑紧密

首先我们转化一下问题

这种 $n$ 元组其实 $A_i$ 对应的是$(-1)^j2^{i-1}$,下标不好挪位置下面经常写错了有些下界是 $0$ 的写成 $1$ 了有些又反了，希望大家理解

(希望大家能理解这种转换和其他题解里树做法的相似性(~~我不能理解~~))

定义 $n$ 个 $n$ 元组，分别为 $A_i($ 最初 $A_i[i]=1),\forall j\neq i,A_i[j]=0$

定义在 $n$ 元组域上的二元运算为 $*$ ,使得 $C=A*B\Leftrightarrow \forall i\in[1,n],C[i]=2A[i]-B[i]$，注意到这个运算没有交换律

然后问题变成求 $|\bigcup\limits _{p \text{~is~a~permutation}}((((A_{p_1}*A_{p_2})*A_{p_3}))\cdots *A_{p_n})|$

即合法的可以作为 $A_i$ 按序乘积的结果种类

设 $B$ 是一个合法的乘积，现在对 $B$ 的性质作分析

- 【性质1】$\forall i, \exists j,k\in \mathbb{Z},B[i]=(-1)^j2^k$
	- 很容易理解，这个归纳法即可
- 【性质2】下文对任意 $n$元组 $A$ 均设 $|A|=\sum_{i} A_i$，若 $B$ 是任意合法的乘积有 $|A|=1$
	- 这个归纳法也可，核心 $C=A*B\Rightarrow |C|=2|A|-|B|=1$
- 【性质3】若$A[i]>0$则$A[i-1]>0(i>1)$
	- 显然
- 【性质4】**超级重要的性质**:若 $A$ 合法则对 $\forall i\in[1,n],$ 设 $S_1=\sum\limits_{j=1}^{i-1}A[j]$ ，再设 $A$ 中形如 $(-1)^k2^i$ 的个数为 $p$ 则存在一种为 $p$ 个 $2^i$ 定符号 $(+~\mathrm{or}~-)$ 方式使得这 $p$ 个数与 $S_1$ 的和为 $1$ ,也即$\forall i\in[1,n],\exists \{x_j\}(\forall j\in[1,i],x_j\in\{-1,1\}),\left(\sum\limits_{j=1}^px_j2^i\right)+S_1=1$
	- 这个性质依然用归纳法证明，基于对满足性质的 $n$ 一定可以被构造出来，我们分可以拆出对指定的 $i$ , $2^j(j\in[1,i))$ 都存在至少 $2$ 个，和不能的分类讨论，后面一种除了唯独 $2^1$ 单独一个都是非法的，可证
   - 【性质4推论】易发现这个性质在 $A$ 上满足后，若我们 $A$ 中有值的部分 $2$ 的次幂形如(性质3) $2^{j}(j\in[0,i])$,则我们必定可以把 $|A|$ 表示成 $1+t2^{i+1},t\in \mathbb{Z}$
		- 再给一个证明，$\exists \{x_j\}(\forall j\in[1,i],x_j\in\{-1,1\}),\left(\sum\limits_{j=1}^px_j2^i\right)+\left(\sum\limits_{j=1}^{i-1}A[j]\right)=1 $,则发现任意$\{y_j\}(\forall j\in[1,i],y_j\in\{-1,1\}),\{x_j\}\neq \{y_j\}$ 有$\left(\sum\limits_{j=1}^px_j2^i\right)\equiv \left(\sum\limits_{j=1}^py_j2^i\right)\pmod {2^{i+1}}
        $即$\left(\sum\limits_{j=1}^py_j2^i\right)+\left(\sum\limits_{j=1}^{i-1}A[j]\right)\equiv 1\pmod{2^{i+1}}$

这四个性质是 $n$ 元组合法的充要条件

然后设计dp

令$f_{i,j}$表示值域为$\{x|x=2^k,k\in[1,n]\}$，放入了 $i$ 个元素，$\exists k\in[1,n],|A|=1+j2^k$，的满足【性质1,3,4】的 $n$ 元组个数(这一步dp的是一个合法的"前缀")

对指定的用 $1+j2^k$ 来表示 $|A|$的所有的被统计 $A$ ,我们知道原来元素的绝对值 $\in\{x|x=2^j,j\in[0,k)\}$,故考虑当前加入 $x$ 个 $2^k$ , $y$ 个 $-2^k$ 则转移到的$n$元组 $B$的 $|B|$ 可以写成 $1+\frac{x-y+j}{2}2^{k+1}$,通过刚刚的表示可以看出 $B$ 也是合法的当且仅当 $x-y\equiv j$(【性质4】推论)

故我们已经可以写出转移了

$f_{i,j}\to f_{i+x+y,\frac{j+x-y}{2}}(x-y\equiv j\mod 2)\frac{1}{x!y!}$，这是 $\mathcal O(n^4)$ 的

注意答案是$n!f_{n,0}$,观察我们莫名加的系数的意思是其实每个位置是有序的但$(-1)^k2^j$中$k,j$**均**相同时是不存在顺序的

