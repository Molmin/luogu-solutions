前言

感谢来自 @[_rqy](https://www.luogu.com.cn/user/7868) 清芷姐姐的全程指导及代码帮助。

这题原来是偶然间发现的，结果拖了几个月一直没能解决，后面在指导下发现了一堆显然的错误及修改代码才最终解决。

正文

这题有很多种解法。

方法一：矩阵快速幂

暴力枚举所有可能的取值并用矩阵快速幂判断，显然不可行。

方法二：生日悖论

简单来说就是每次随机两个数，判断这两个数对应的斐波那契值是否相等，时间复杂度期望下是 $ \mathcal{O}(T\sqrt{n}) $，对于本题的数据范围难以接受。

方法三：质因数分解

一个结论是设模数为 $ p $，则斐波那契的循环节不会超过 $ 6 \times p $。

有一个目前并没有被完全证明，不过和哥德巴赫猜想一样在给定范围内足够用的结论是如果模数是某个素数的幂，记为 $ p^k $，则对应的周期长度 $ f(p^k) $ 为 $ f(p) \times p^{k-1} $ 。

对于 $ f(p) $ 的计算：当 $ p \bmod 10 = 1 $ 或者 $ p \bmod 10 = 9 $ 时计算 $ f(x-1) $，否则计算 $ 2 \times (p+1) $ ，可知这样得到的结果一定是斐波那契数列的一个循环节（但不一定是最小循环节），然后暴力枚举所有可行的质因子分解，如果循环节内包含更小的循环节则更新答案，注意用矩阵快速幂计算斐波那契数列的值。

最后对模数进行质因数分解后直接取唯一分解后所有质数幂的 $\operatorname{lcm}$ 即可。

然而朴素的质因数分解时间复杂度仍然是 $ \mathcal{O}(T\sqrt{n}) $，仍然不能接受。（原来我用这种办法一直超时）

考虑用一些更快速的质因数分解方法（如 Pollard-rho ）可以做到在 $ \mathcal{O}(Tn^{1/4}) $ 的时间复杂度内解决这个问题。

注意一些实现细节： $ 10^{12} $ 级别的两个数相乘可能会超过 long long 能表示的范围，需要手写快速乘。（此份代码使用的是玄学 $ \mathcal{O}(1) $ 快速乘，比正常写法貌似快出不少）每次分解质因子时不需要求出所有因子后再分解能加速很多。

代码因为太长，所以扔剪贴板里了。

[link](https://www.luogu.com.cn/paste/zpvnx446)

后记

再次感谢来自 @[_rqy](https://www.luogu.com.cn/user/7868) 清芷姐姐的全程指导及代码帮助。

目前此份代码为本题最优解。（主要优化为玄学快速乘）