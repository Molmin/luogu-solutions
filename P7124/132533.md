**P7124**题解。

好久没做 Ynoi 了，感觉复键困难。

-----------------------------------------------

题解区里面有个利用区间关系只存在包含的很 ez 的分治做法，不好意思我是真的想不到。/ll

之前自己胡了个只对儿子建立 huffman 树的垃圾做法结果被 gxy 反手叉了，本质问题是处理不了轻儿子的遍历顺序关系。

事实上我们有一个想法：直接轻重链剖分，对于重链可以直接下沉递归加轻子树，由于选定前 $k$ 大的节点作为重儿子则轻儿子子树和为 $O(n \log_{k + 1} n)$ 级别，所以在 $k$ 取成 $1$ 的情况下我们直接下沉递归重链解决链上所有节点的询问是正确的。

猜测问题转化成了将重链扔掉后递归的轻子树问题，我们需要一个优秀的重构树结构使得对由轻儿子们组成的重构树可以执行一个类似线段树分治的操作，即：

- 将一系列带权节点 $x$ 作为叶子，建立一棵只有叶子带权的重构树；

- 对重构树进行一次 dfs，每次下沉递归时需加入非子树节点的节点权值和，求一棵能让总的加入权值和尽量小的重构树。

这里每个节点带的权即为子树大小。

我们知道如果叶子节点权相等直接建立线段树就是正常的线段树分治。对于权不相等的叶子我们发现转化一下该权值和等于其 [WPL](https://baike.baidu.com/item/wpl/10089687?fr=aladdin)，则我们建立 huffman 树即可。

huffman 树可以做到的是使得一个节点向上跳两次父节点子树和大小翻倍，这样很容易能分析出来一个 $O(n \log^2 n)$ 的不严格操作次数。

不过事实上我们发现树的结构是可以合并的，对重链缩点，将轻儿子建立的 huffman 树接在重链的缩点上，对于轻儿子的子问题也递归建树，我们发现建出来的新树具有轻重链剖分与 huffman 树的性质。

由于轻重链剖分的性质优于 huffman 树的性质，所以我们可以将原树当成一棵 huffman 树分析，则一个节点只会对其祖先贡献，而该树的深度数量级也是 $O(\log n)$ 的，故我们的一个更严格一点的上界是 $O(n \log n)$ 的。

于是我们要做的就是：

- 对于重链下沉，下沉递归的时候加入轻子树；

- 对于轻儿子的子树形成子问题，建立 huffman 树并对其执行类似线段树分治的操作，每次向左儿子走加入右儿子包含的轻子树中的所有点，递归子问题撤销加入的点再向右儿子走，加入左儿子中包含的轻子树中的所有点，递归子问题撤销加入点后回溯。

时间复杂度 $O(n \log n)$，总的操作次数也是 $O(n \log n)$ 数量级的，可以通过本题。

不知道多取重儿子能不能有更好的上界，不过破坏了链性质可能就不好做了。