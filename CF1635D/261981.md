因为对于集合中的数的要求是严格小于 $2^p$，我们可以想到二进制。

那么对集合中数的要求就转化为了位数小于等于 $p$。

接下来我们观察两种操作，分别是 乘 $2$ 加 $1$ 与 乘 $4$，

那么可以分别转化为左移一位、结尾补一与左移两位；

也就是说分别能让位数 $+1$ 与 $+2$。

可以证明：对于一个初始的数 $x$，有进行若干次操作后所得到的数不重复。

因此我们可以直接用 dp 计算位数加 $x$ 时的方案数，

转移方程为 $f_x\gets f_{x-1}+f_{x-2}$，然后我们用前缀和处理就可以了。

接下来要解决的问题是：

数组中可能存在 $x$ 与 $y$ 满足 $y$ 可以由 $x$ 进行若干次操作后得到。

解决这个问题的方法是把数组从小到大排序，

对于每个数 $x$，进行反向操作直到不满足限制为止，

并查询前面的数中有没有可以通过反向操作得到的。

如果有的话，那么这个数的所有方案就已经被计算过了。

[代码](https://codeforces.com/contest/1635/submission/147073999)。