提供一个时间 $O(n\log\log n-q\log\log n)$，空间 $O(n\log\log n)$ 的做法。

考虑用重剖做。每次如果能跳就暴力跳到链顶，否则答案在这条重链上，容易通过 dfs 序做到 $O(1)$ 查出。总时间复杂度 $O(n-q\log n)$，空间复杂度 $O(n)$。

然后我们发现这个事情和求 LCA 那个倍增非常像。于是我们可以预处理出来跳 $2^k$ 次重链能到的点，这样就可以平衡查询和预处理的复杂度了。

非常好写，且在需要重剖的时候顺便一求更方便。在 2020 年一般电脑能 10s 跑出来的数据范围内基本不劣于长剖，原因是长剖内存操作和跳跃访问比较多，常数会相对较大。

代码链接：https://www.luogu.com.cn/paste/97df80cx。


