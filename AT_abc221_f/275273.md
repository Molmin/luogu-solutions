显然，选出的每两个点都要组成一条直径。

进一步发现，设直径点数为 $x$，如果 $x \nmid 2$，所有直径都会在中点重合，否则会在连接两个中点的边重合。简单证一下，如果有两条直径不在中点或中边重合，那么：

- 它们不可能不重合，要不然就不会成为直径了；
- 它们在除了中点和中边的地方重合，此时长的两端构成了一条新的直径。

然后考虑计数。

- 如果重合部分是点 $u$，答案为 $\prod\limits_{v, (u,v) \in E} (f_v + 1) - a - 1$，其中 $f_v$ 为 $u$ 为根时 $v$ 的子树中有多少个点与 $u$ 的距离为 $\frac{x-1}{2}$，$a$ 为整棵树中有多少个点与 $u$ 的距离为 $\frac{x-1}{2}$。大概意思就是每个点可选可不选，最后减去 $|S| \le 1$ 的 $S$。

- 如果重合部分是边 $(u,v)$，答案为 $f_u \times g_v$，其中 $f_u$ 为以 $v$ 为根时 $u$ 的子树中有多少个点到 $u$ 距离为 $\frac{x}{2} - 1$，$g_v$ 为以 $u$ 为根时 $v$ 的子树中有多少个点到 $v$ 距离为 $\frac{x}{2} - 1$。

时间复杂度 $O(n)$。

[code](https://atcoder.jp/contests/abc221/submissions/41291249)