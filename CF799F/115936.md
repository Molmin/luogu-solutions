完全不会随机化。

二元组显然是一个区间，要求的是合法的子区间长度和。

考虑扫描线，枚举右端点 $r$，然后用线段树维护左端点 $l$。

考虑用线段树维护合法的区间的 $l-1$ 的和 $sum$ 以及个数 $cnt$ 即可。那么对于一个 $r$，它的贡献为 $r\times cnt-sum$。

先不考虑第一个条件，按照第二个条件去维护线段树，然后发现第一个条件限制的不过是一段前缀，可以直接放到查询区间里。

考虑有可能有影响的区间 $[l_i,r_i]$，首先肯定要满足 $r\ge l_i$，然后根据 $r$ 关于 $r_i$ 的大小进行分讨。

对于 $r_i<r$，那么对于 $l=r_i-2p+1$ 且 $l\ge l_i$，区间 $[l,r]$ 是不合法的，这个 $2p$ 启发我们将位置按奇偶分类，各自建一棵线段树。

如果有 $r_i-l_i+1$ 为偶数，那么对于 $l\le l_i$ 也是不合法的。

对于 $r_i\ge r$，那么对于 $l=r-2p+1$ 且 $l\ge l_i$，区间 $[l,r]$ 是不合法的。因此我们只需要用 set 维护当前满足 $r_i\ge r$ 的区间的 $l_i$，每次直接取最小值用即可。

然后对于 $r-l_i+1$ 为偶数的情况，对于所有的 $l\le l_i$ 也不满足，我们需要取这个最大的 $l_i$。

所以对奇偶也要开两个 set。

当然，也可以使用队列维护。取决于个人喜好。

显然上述条件影响的都是一个区间，所以区间修改即可。具体地，我们可以使其区间 $-1$，然后查询区间最大值的个数。

https://codeforces.com/contest/799/submission/180217527