首先，序列中每个位置都有一个变化后的最大值以及一个变化后的最小值。设第 $i$ 位的值的最大值位 $max_i$， 最小值为 $min_i$，原本的值为 $o_i$。那么为了保证第 $i$ 个数无论怎样变化都小于第 $j$ 个数，那么需要保证：

+ $o_i<min_j$
+ $max_i<o_j$

于是我们愉快的发现这就是求三维偏序求 LIS。于是直接套用 cdq 分治。在计算左部对右部贡献的时候，直接更新右边的 dp 数组即可。

**细节：注意要先算左边，然后更新右边，最后再递归右边。**

原因很简单，在递归右面的时候，使用了右面的部分数据来更新右面的另一半数据。而尚未计算左边对右边贡献时，右边的 dp 数组尚未更新，不能用来计算其它的数据。

[Code Here](https://www.luogu.com.cn/paste/k65l6i5j)