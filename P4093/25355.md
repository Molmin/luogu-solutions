看上去就是可以dp的样子。

设$dp_{i}$为以i结尾的最长不下降序列。

易得:$dp_{i}$ = $max(dp_{j})+1$ $(j<=i$&&$Max_{j}<=a_{i}$&&$a_{j}<=Min_{i})$

$Max_{i}$和$Min_{i}$表示第i个点所有变化中的最大值和最小值。

我们考虑用一个什么东西来维护这个dp。

我的第一反应是树状数组套动态开点线段树，而且写那玩意应该也不会太长。

突然想到最近学了CDQ。

于是讲下CDQ怎么搞。

因为有两个两边不是同一个数组的条件，所以我们在solve的时候，要对$[l,mid]$和$[mid+1,r]$的根据不同的两个数组sort下，然后用个树状数组维护前缀max，算下左边对右边的贡献。

然后因为是dp，所以我们不能直接分治$[l,mid]$和$[mid+1,r]$然后合并，我们应该先分治$[l,mid]$然后算好$[l,mid]$对$[mid+1,r]$的贡献，然后再去分治$[mid+1,r]$ （记得去做$[mid+1,r]$前先把数组$[mid+1,r]$恢复）

具体代码可以见我[博客](http://www.cnblogs.com/zykykyk/p/9073893.html)