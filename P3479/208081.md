好难的一道题。。。

首先我们从下往上考虑，直到必须要选的时候再选，可以证明这样一定最优。

我们设计两个状态。

$f[i][j]$表示以$i$为根的子树中距离$i$为$j$的灭火器还有多少点能分配。

$g[i][j]$表示以$i$为根的子树中距离$i$为$j$的点还有多少没有灭火。

我们考虑点$x$是否放置灭火器的条件，当且仅当距离$x$为$k$的点还需要放置灭火器。因为如果不考虑$x$，那么子树已经达到最优，而且我们不能使用$x$的其他子树中的灭火器，因为距离和大于$k$。

接着，我们还要考虑子树之间的情况。

考虑两个位于不同子树中的灭火器和点，如果他们的距离和为$k$或$k-1$，那么就将他们相消。

关于证明，如果他们都匹配了距离之和小于$k-1$的点，那么交换匹配不会使得答案更劣。

根结点需要特殊考虑。