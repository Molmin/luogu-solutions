调了一下午终于调出来了。

常见错误：n,m弄反；取模没取干净；~~毒瘤的出题人要求我们在L>R时仍然直接计算Solve(r)-Solve(l-1)，此时不要自己交换L，r或直接输出0~~

然后我的方法和大家不一样：

设$f_n$表示由所有$n$位$B$进制数的权值和，$cf_n$表示$n$位$B$进制数的个数（均**不能**有前导0）；$g_n$表示由所有$n$位$B$进制数的权值和，$cg_n$表示$n$位$B$进制数的个数（均**可以**有前导0）（先不考虑L和R的限制）；

$cf$和$cg$的递推就不说了，考虑$f$和$g$的计算（下面只有$f$，$g$是差不多的）：

$f_n=\sum\limits_{i=0}^{B-1}\sum\limits_{j=0}^{B-1}\sum\limits_{a\text{是}n-2\text{位的}B\text{进制数}}\Big((B+1)w(\overline{aj})+ni-Bw(a)\Big)$

解释一下：$i$表示最后一位，$j$表示倒数第二位，$w(\overline{aj})$计算子串不含最后一位；$ni$计算最后一位的贡献，$B(w(\overline{aj})-w(a))$计算包含最后一位的选法中其它位的贡献。

带进去是不行的，下面化简(显然$a$有$cf_{n-2}$种不同的取值：

$f_n=\sum\limits_{i=0}^{B-1}\sum\limits_{j=0}^{B-1}\Big(cf_{n-2}ni+(B+1)\sum\limits_{a\text{是}n-2\text{位的}B\text{进制数}}\cdot w(\overline{aj})-Bf_{n-2}\Big)$

$\quad=\sum\limits_{i=0}^{B-1}\Big(B\cdot cf_{n-2}ni+(B+1)f_{n-1}-B^2\cdot f_{n-2}\Big)$

$\quad=\frac{B(B-1)}{2}\cdot cf_{n-1}\cdot n+B(B+1)f_{n-1}-B^3\cdot f_{n-2}$

明显比原来好多了，可以推出$f$了（其实$g$和$f$的差别就是把$cf$改成了$cg$）。

接下来，我们设我们考虑的区间为$[1,n]$，$n$在$B$进制下有$a$位，$n_a(a=1,2,\cdots,n)$位$n$从左数起第$a$位。

如果这个数不满$a$位，则总数显然为$\sum_{i=1}^{a-1}f_i$

如果第一位不为$n_1$，则总贡献为：

$$\sum_1^{n_1-1}(S_ni\cdot cg_{n-1}+2g_{n-1}-Bg_{n-2})=\frac{n_1(n_1-1)}{2}\cdot S_ncg_{n-1}+(n_1-1)(2g_{n-1}+Bg_{n-2})$$

（$S_n$表示$B$进制下$\begin{matrix}\underbrace{11\cdots1}\\n\text{个}1\end{matrix}$，下同）

如果第一位为$n_1$，则这一位贡献为:

$$n_1\cdot S_ncg_{n-1}$$

然后递归（其实可以递推）计算$n$少了第一位的总贡献乘以2减去$n$少了前两位的总贡献（此时可以有前导0，因此上一种情况$(n_1-1)$应改为$n_1$）。（显然需要记忆化，或者递推出从左侧第$i$位对答案的总贡献为计算结果的$i$倍，然后递推）。

鉴于我的代码实在太丑，就不放上了。