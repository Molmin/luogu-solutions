考察每条边的贡献。

设切掉这个边后形成连通块 $s1,s2$，设 $|s1|\le |s2|$，那么这条边的贡献 $\le 2|s1|$

取等当且仅当 $s1$ 中的每个点 $x$，$p_x\in s2$。

取重心为根，那么每个子树大小均不大于其补树大小。

也就是说每个子树都是 $s1$，这个子树中的每个点都要连向其补树。
​
考虑容斥。

对于一个大小为 $x$ 的子树，钦定其中有 $i$ 个点不合法，那么显然是 $\dbinom x i ^2 i!$。

钦定 $i$ 个点乘上钦定 $i$ 个 $p$ 乘上交换顺序。

那么可以算出重心每个子树的有 $i$ 个点不合法的数量，考虑合并到重心。树形背包即可。

然后对于根，你合并出一个 $f_i$ 表示有 $i$ 个点不合法的数量，那么答案就是 $\sum_{i=0}^n f_i(n-i)!(-1)^i$。

注意到这里的时间复杂度 $O(n^2)$，瓶颈在于树形背包。

这里树形背包的形式相当于将若干个总长为 $n$ 的多项式相乘。我们每次选择两个长度最小的多项式用 NTT 相乘（哈夫曼树），即可做到 $O(n\log ^2 n)$ 的时间复杂度。