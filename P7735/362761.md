[P7735 [NOI2021] 轻重边](https://www.luogu.com.cn/problem/P7735)
### 题意
一颗有 $n$ 个节点的树，边分成轻边和重边。开始时所有边都为轻边。然后对树进行 $m$ 次操作：

操作 $1$：输入 $a$、$b$，对路径 $(a,b)$ 上的每一个点 $x$，将与 $x$ 相连的所有边变成轻边；然后再将路径 $(a,b)$ 上的所有边变成重边。

操作 $2$：输入 $a$、$b$，求路径 $(a,b)$ 上重边的数量。

本题为多组数据，组数为 $T$。

###### 数据范围：
$T \leq 3,1\leq n,m\leq 10^5$，保证输入操作时 $a\neq b$。

###### 关键词：树链剖分，最近公共祖先 LCA

------------
### 解题思路
##### 30分：$1\leq n,m\leq 5000$，无特殊性质。
对于 $30$ 分的数据，可以直接对题目中的操作进行模拟。若操作数为 $1$，先求出点 $a$ 和 $b$ 的最近公共祖先 $L$，然后分别把路径 $(a,L)$ 和 $(b,L)$ 上所有点连接的边标记为轻边，再把两条路径上的边标记为重边。

标记可以直接记录在边上，也可以把 $1$ 号点作为根，将整棵树变成有根树，然后将标记记录在深度较深的节点上。

查询时，同样先求出点 $a$ 和 $b$ 的最近公共祖先 $L$，然后统计路径 $(a,L)$ 和 $(b,L)$ 上的重边数即可。

这种模拟算法，对每一次操作，都需要 $O(n)$ 的时间进行修改/查询，因此总时间复杂度为 $O(Tmn)$。

##### 50分：$1\leq n,m \leq10^5$，树的形态是一条链。
对于这个范围的部分分，可以发现所有操作其实是在序列上进行的，具体地说就是序列上的区间修改和区间查询。既然如此，我们可以很轻松地使用线段树来维护每一个点上的标记，然后在询问时查询区间和即可。

有一点需要注意，就是在更新标记时，因为需要将路径 $(a,b)$ 两侧的边设置为轻边，所以应该先更新轻边标记，再更新重边标记。

对每一次操作，线段树上的更新或查询都需要 $O(\log n)$ 的时间，因此总时间复杂度为 $O(Tm\log n)$。

##### 100分：$1\leq n,m \leq10^5$，无特殊性质。
既然一条链上的信息可以用线段树来维护，那我们是否可以对树进行树链剖分，从而维护树上的信息呢？

答案是肯定的，但是并不能直接套用之前的线段树的更新方法。

由于每次更新需要将与路径 $(a,b)$ 相邻的边变为轻边，而进行树链剖分后线段树只能有效维护链上的信息，因此每次改变所有边的标记是不现实的。我们需要尽量做到每次操作只维护路径上的信息。

之前提到可以把边的标记转移到点上。那我们考虑是否可以只标记点，通过点上的信息来计算答案。要实现这样的操作，我们需要记录的是每个点被修改的时间戳。如果一条边是重边，那它的两个端点必须同一次被修改，也就是说两个端点的时间戳相同。于是，我们需要统计的就是路径上极长的连续时间戳的段数 $cnt$。答案就是路径长度减去 $(cnt-1)$。

由于需要统计路径中连续时间戳的段数，我们需要在线段树上维护段数 $cnt$，左端点的时间戳 $ltm$ 和右端点的时间戳 $rtm$（用于区间合并时判断是否重复计算）。同时，使用懒标记 $tag$ 来记录一个区间内全部相同的时间戳。

对于每一次操作，我们需要在计算点 $a$ 和点 $b$ 最近公共祖先的同时进行维护和查询操作。

每次操作时，使用树链剖分计算最近公共祖先需要 $O(\log n)$ 的时间，同时在线段树上进行维护/查询又需要 $O(\log n)$ 的时间，因此一次操作的时间复杂度为 $O(\log^2 n)$，总时间复杂度为 $O(Tm\log^2 n)$。

由于本题卡常，使用这个方法可能需要一些速度上的优化才可以通过。

[完整代码](https://www.luogu.com.cn/paste/b7hcnf50)



