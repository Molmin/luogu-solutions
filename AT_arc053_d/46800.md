直接求解比较麻烦，考虑将问题进行转化。

设序列$a = \{3, 1, 4, 2, 5\}, b = \{3, 2, 4, 1, 5\}$，那么我们构造一个正方形方格，将$a$放在横行，$b$放在竖行，可以画出下图。

![](https://i.loli.net/2019/07/06/5d20109f0058322756.png)

那么我们可以发现，方案数就是从左上走到右下的不同序列个数。

这样我们可以$\texttt{d}\texttt{p}$，设$f[i][j]$表示走到$(i, j)$的方案数，那么显然$f[i][j] = f[i - 1][j] + f[i][j - 1]$。

不过这样转移发现有重复。考虑到$a_i = b_j$是$f[i][j]$出现重复的必要条件，通过推导可以得出方程：$f[i][j] = f[i][j - 1] + f[i - 1][j] + [a_i = b_j]\sum_{k \geq 1}[a_{i - k} = b_{j - k}]f[i - k][j - k]\mathrm{C}(t - 1)$，其中$\mathrm{C}$表示卡特兰数，$t$表示$1$到$k$之间有多少个$l$满足$a_l = b_l$。

由于$a_i = b_j$只有$n$对，所以时间复杂度为$\mathrm{O}(n ^ 2)$。

代码见我的[$\texttt{blog}$](https://www.cnblogs.com/cj-xxz/p/11142101.html)