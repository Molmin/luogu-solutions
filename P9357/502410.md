不知道这道题难点在哪里，但确实有思考价值。

设 $F(u,v)$ 表示所有操作方式中，某一次对 $u$ 操作，此时 $u,v$ 连通的情况总和。

不难发现，答案就是 $\sum\limits_{u=1}^n\sum\limits_{v=1}^nF(u,v)$。

在 $F(u,v)$ 的过程中，$u,v$ 路径上的点本质相同，路径外的点也本质相同。

于是，$F(u,v)$ 只与 $u,v$ 之间的路径长度有关，我们可以暴力求出路径长度为 $l$ 的 $(u,v)$ 点对有多少个，记为 $ct_l$，而路径长度为 $l$ 的 $F(u,v)$ 均相等，记为 $G_l$，于是答案为 $\sum\limits_{l=1}^nct_lG_l$

考虑求出 $G_l$，先枚举连通时相等的 $w$，再枚举连通之后的对 $u$ 的操作是第 $k$ 次。

第 $k$ 次之后的操作点没有限制，而之前的路径外点只有 $n-l$ 个，路径上点每一个只能**恰好**出现 $w$ 次。

于是 $G_l=\sum\limits_{wl<m}\dfrac{(wl)!}{(w!)^l}\sum\limits_{k=wl+1}^m\dbinom{k-1}{wl}(n-l)^{k-wl-1}n^{m-k}$ 这个式子不方便计算，直接算时间复杂度为 $O(m^2\ln n)$。

如果你想用三模 NTT 也可以，但我没研究过，可能可以多得一些分。

然后我们需要还一种计数方式，具体地，改为总共有 $k$ 次操作在路径上，这样可以规避二项式中的 $wl$，事实上，这 $k$ 次操作一定是前 $wl$ 次按规律排布，第 $wl+1$ 次是对 $u$ 操作，而后面的没有限制，于是让计算更简便。

此时有 $G_l=\sum\limits_{wl<m}\dfrac{(wl)!}{(w!)^l}\sum\limits_{k=wl+1}^m\dbinom m kl^{k-wl-1}(n-l)^{m-k}$，我们希望后面的和式中不含 $wl$，于是将 $l^{m-wl-1}$ 前提。

于是 $G_l=\sum\limits_{wl<m}\dfrac{(wl)!}{(w!)^l}l^{m-wl-1}\sum\limits_{k=wl+1}^m\dbinom m k(\dfrac{n-l}l)^{m-k}$，然后后面的和式可以前缀和处理。

总时间复杂度 $O(nm+m\ln n)$，可以通过。