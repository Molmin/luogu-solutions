先考虑没有 $-1$ 的情况该怎么判断是否合法。

容易发现成立的条件就是，相邻列之间每一行的两个数的差对应相等。

我们可以直接枚举判断或者使用边带权并查集维护。

想想怎么扩展。

继续使用边带权并查集。

对于每一个不是所有列都是 $-1$ 的行，用边带权并查集维护列与列之间的关系。判掉无解的情况

设有 $x$ 个连通块。

在每一行中，对于每一个连通块，只要连通块中任意一个位置确定，那么这一行在这个连通块中的所有列都可以确定。

任取一个不是全为 $-1$ 的行，所有非 $-1$ 列在同一个连通块中，确定剩下的 $x-1$ 个联通块即可确定这一行，进而可以确定出所有不是全为 $-1$ 的行，共 $h^{x - 1}$ 种方案。

剩下 $y$ 个全是 $-1$ 的行，只要确定任意一个位置即可确定整行，方案数 $h^y$。

$$ans = h^{x+y-1}$$