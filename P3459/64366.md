提供一个新思路，不过懒得写代码了。首先把所有询问和改变以及它们的时间记录下来，之后dfs加动态开点线段树（可持久化权值线段树），记录每个点的祖先结点某个时间建成公路的个数。这样一来，每个结点的祖先中的土路的个数即为深度减T.query(0,time)，time代表当前时间。之后再加上标准的LCA就可以查询了。