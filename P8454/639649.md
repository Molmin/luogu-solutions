赛时调了半天结果是线段树左右区间合并写挂了 /kx

设 $v_i$ 为 $i$ 的收益。

假如 $w$ 不变，我们发现 $v_i$ 的值是固定的，考虑如何处理询问。

发现每次询问的喜欢的位置的数量很少，可以枚举每个喜欢的位置 $pos$，求包含 $pos$，并且不包含不喜欢的位置的区间 $[l,r]$ 的 $\sum_{i=l}^rv_i$ 的最大值。  
（此处的 $l$ 和题面中的 $l$ 含义不一样）

把区间 $[l,r]$ 按 $pos$ 分成 $[l,pos]$ 和 $[pos+1,r]$ 两段。

我们要找到一个 $l$，使得 $\sum_{i=l}^{pos} v_i$ 最大并且 $[l,pos]$ 不包含不喜欢的位置。$r$ 同理。（$l\leq pos$，$r\ge pos-1$，因为 $pos$ 必须选）

因为不喜欢的位置也很少，所以我们可以双指针求出一个喜欢的位置左边和右边的第一个不喜欢的位置 $p$ 和 $q$。（假设 $0$ 和 $n+1$ 也是不喜欢的位置）

于是我们要求的就是区间 $[p+1,pos]$ 的后缀和的最大值与区间 $[pos+1,q-1]$ 的前缀和的最大值。这是线段树的经典问题。（可以参考[此题](https://www.luogu.com.cn/problem/SP1043)）

但是 $w$ 是动态变化的，因此我们考虑如何维护 $v_i$。

我们将 $v_i$ 看作关于 $|x_i-w|$ 的函数，发现 $|x_i-w|$ 不断变大的时候，$v_i$ 的值只会在两个位置发生改变。

更进一步，$w$ 从 $-\infty$ 到 $+\infty$ 不断变大的时候，$v_i$ 的值会在四个位置发生改变，即分成五段。

- $w\in[-\infty,x_i-b2)$，$v_i=dec$。

- $w\in[x_i-b2,x_i-b1)$，$v_i=0$。

- $w\in[x_i-b1,x_i+b1]$，$v_i=inc$。

- $w\in(x_i+b1,x_i+b2]$，$v_i=0$。

- $w\in(x_i+b2,+\infty)$，$v_i=dec$。

我们发现 $w$ 不断变大的过程中，所有 $v_i$ 的值总共变化 $4n$ 次。

考虑将询问离线并按 $w$ 排序，处理出每个 $v_i$ 会被哪些 $w$ 改变，在线段树上单点修改即可。

[code](https://www.luogu.com.cn/paste/nxeugzra)