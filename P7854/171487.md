毒瘤题。

容易发现这棵树合法的必要条件是 $a_{fa_x}|a_x$。

那么我们考虑先构造出一棵树满足这个条件，然后再判断是否合法。

先把重复的数处理掉，直接往和他相同的数上连就行了。

将数组 $a$ 从小到大排序，最小的为根，然后剩下的一个一个加入树中。

记录下每个 $a_i$ 的因数，然后找到 $a$ 中出现的最大的那个因数（不能是他自己，找不到就是无解），然后连上去。

为什么连最大的呢？

考虑两种情况。

1. 存在 $j,k~(a_j<a_k)$ 且 $a_j\not|~a_k$，这种情况一定无解，因为你不管连 $j$ 还是 $k$ 都会矛盾，比如连 $j$，那么 $\operatorname{lca}(i,k)=\operatorname{lca}(j,k)$，$a_{\operatorname{lca}(j,k)}|\gcd(a_j,a_k)$，$\gcd(a_i,a_k)=a_{\operatorname{lca}(i,k)}\neq a_k$。

2. 存在 $j,k~(a_j|a_k)$，那么直接连 $k$ 不会有问题。

得到这个东西不一定是合法的，要进行判断。

判断的方法是，如果存在互不相同的 $u,v,w$ 使得 $v$ 在 $u$ 子树内，$w$ 不在 $u$ 子树内则不合法。

考虑这玩意咋维护。

其实很好维护，直接树上启发式合并就可以了。

复杂度是 $nD\log n$，$D\le \max(d(a_i))$。

[Code](https://paste.ubuntu.com/p/cPDXq3yW3x/)