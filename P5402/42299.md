~~话说就我一个人把 no where 看成 now here 的吗~~

### 题意简述

将 $n$ 个矩形 $r_i$ 放置在大矩形 $R$ 内部。小矩形不能重合，并且边要平行或垂直于 $R$ 的边。

1. 安放所有矩形，令 $R$ 的面积尽量小。
2. 固定 $R$ 的大小，安放尽量多的矩形。

相关 NPC 问题：[Strip packing problem](https://en.wikipedia.org/wiki/Strip_packing_problem)

### 测试点 $1, 2, 3$

- 测试点 $1: type = 1, n = 8, std = 168$。
- 测试点 $2: type = 2, n = 12, w = 17, h = 13, std = 12$。
- 测试点 $3: type = 1, n = 16, std = 156$。
- $n \leq 16$，矩形的数量较少。

手玩，答案的可视化结果如下：

```
1 1 1 1 1 1 1 1 1 1 2 2
1 1 1 1 1 1 1 1 1 1 2 2
3 3 3 3 3 3 3 3 8 8 2 2
3 3 3 3 3 3 3 3 8 8 2 2
3 3 3 3 3 3 3 3 8 8 2 2
3 3 3 3 3 3 3 3 8 8 2 2
4 4 4 4 5 5 5 5 5 5 2 2
4 4 4 4 5 5 5 5 5 5 2 2
4 4 4 4 6 6 6 6 6 6 2 2
4 4 4 4 6 6 6 6 6 6 2 2
4 4 4 4 7 7 7 7 7 7 7 7
4 4 4 4 7 7 7 7 7 7 7 7
4 4 4 4 7 7 7 7 7 7 7 7
4 4 4 4 7 7 7 7 7 7 7 7

4  4  4  4 11 11 11  8  8 10 10 10 10
4  4  4  4 11 11 11  8  8 10 10 10 10
4  4  4  4 11 11 11  8  8 10 10 10 10
4  4  4  4 11 11 11  8  8 10 10 10 10
1  1  1  1 12 12 12  8  8 10 10 10 10
1  1  1  1 12 12 12  8  8 10 10 10 10
1  1  1  1 12 12 12  8  8 10 10 10 10
1  1  1  1 12 12 12  8  8  6  6  6  5
1  1  1  1 12 12 12  8  8  6  6  6  5
2  2  2  2  3  3  3  8  8  6  6  6  5
2  2  2  2  3  3  3  8  8  6  6  6  5
2  2  2  2  3  3  3  8  8  6  6  6  5
2  2  2  2  3  3  3  8  8  6  6  6  7
2  2  2  2  3  3  3  9  9  9  9  9  9
2  2  2  2  3  3  3  9  9  9  9  9  9
2  2  2  2  3  3  3  9  9  9  9  9  9
2  2  2  2  3  3  3  9  9  9  9  9  9

 7  7  7  7  7  2  2  2 11 11 11 11 12 12 12  6  6  8  5  1  1  1  1  1  1  1
 7  7  7  7  7  2  2  2 11 11 11 11 12 12 12  6  6  8  5  1  1  1  1  1  1  1
 7  7  7  7  7  4  4  4 15 15 15 15 12 12 12  6  6  8  5  1  1  1  1  1  1  1
 7  7  7  7  7  4  4  4 15 15 15 15 13 13 13  6  6  8  3  3  3  3  3  3  3  3
 7  7  7  7  7  4  4  4 15 15 15 15 13 13 13  6  6  0  3  3  3  3  3  3  3  3
10 10 10 10 10 10 16 16 16 16 16  9  9  9  9 14 14 14  3  3  3  3  3  3  3  3
```

~~出题人没有出完美正方形的测试点，差评~~

### 测试点 $4$

- 测试点 $4: type = 2, w = 7518, h = 4, std = 4997$。
- 矩形大小不超过 $4 \times 4$。

这是矩形大小的统计数据：

```
1 * 1: 669
1 * 2: 559
1 * 3: 448
1 * 4: 334
2 * 2: 467
2 * 3: 444
2 * 4: 566
3 * 3: 798
3 * 4: 512
4 * 4: 203
```

首先，$1 \times 3 + 3 \times 3$ 的矩形可以填满 $3$ 列。

```
AAA
BBB
BBB
BBB
```

其次，$1 \times 1 + 1 \times 2 + 3 \times 3$ 的矩形可以填满 $3$ 列。

```
ABB
CCC
CCC
CCC
```

然后，两个 $k \times 2$ 的矩形可以填满 $k$ 列。

接着，四个 $1 \times 1$ 的矩形可以填满 $1$ 列。

这时剩下三个 $1 \times 1$ 的矩形，一个 $1 \times 2$ 和一个 $2 \times 2$ 的矩形，占用 $3$ 列位置。

最后，一个 $k \times 4$ 的矩形可以填满 $k$ 列。

记得扔掉两个 $4 \times 4$ 的矩形。

~~诶我居然比 std 高了一分?~~

### 测试点 $5$

- 测试点 $5: type = 1, n = 5000, std = 10^9$。

令所有矩形 $r_i$ 的长大于宽（即，长小于宽时交换长和宽），并按照宽排序，发现有一些长度 $L(L \leq 500)$ 使得宽 $ = L$ 的矩形有较多个。

对于“较多个”以外的矩形，交换它们的长和宽。

此时所有不同的宽之和为 $5000$，且相同 $L$ 对应的长之和都为 $200000$。

因此可以拼成一个 $5000 \times 200000$ 的大矩形。

注意不要进行去重的处理，因为相同大小的矩形会有多个。

### 测试点 $6$

- 测试点 $6: type = 2, n = 8000, w = 800, h = 800, std = 8000$。
- 矩形大小不超过 $33 \times 33$。

先把可以凑成一行的矩形尽量凑，然后把一些较大的矩形进行特判（面向数据编程）凑成一行，最后剩下的小矩形暴力枚举位置。

### 测试点 $7$

- 测试点 $7: type = 2, n = 5000, w = 16304, h = 16720, std = 4995$。

首先，有五个 $416 \times k(k > 1000)$ 的矩形，三个 $416 \times k(500 < k < 1000)$ 的矩形，其它矩形的大小都在 $500 \times 500$ 以内。

根据标准答案，果断扔掉 $416 \times k(k > 1000)$ 的矩形。将其它 $416 \times k$ 的矩形拼成一个 $416 \times W$ 的矩形。

将其它矩形的长、宽出现次数统计，发现只有 $70$ 种长度 $L_i$，长度之和 $\sum L_i = W$。矩形个数为 $70^2$，对于 $1 \leq i, j \leq 70$ 各一个 $L_i \times L_j$ 的矩形。这些矩形能够拼成一个 $(\sum L_i) \times (\sum L_i)$（即 $W \times W$）的矩形。

因此没被扔掉的所有矩形能够拼成一个 $(416 + W) \times W = H \times W$ 的矩形。

[提交记录 (70 pts)](https://loj.ac/submission/464067)

### 测试点 $8, 9, 10$

- 测试点 $8: type = 1, n = 100, std = 1257728, area = 1196640$。
- 测试点 $9: type = 1, n = 200, std = 2117820, area = 2023360$。
- 测试点 $10: type = 1, n = 500, std = 21199784, area = 19897996$。
- 其中 $area$ 是输入中矩形面积的和。
- 数据随机生成，没有特殊性质。输入中的矩形边长是 $2 \times rand()$。对于测试点 $8, 9$，矩形边长 $\in [1, 200]$；对于测试点 $10$，矩形边长 $\in [1, 400]$。

通过上网搜索，我们找到了一篇优秀的博客：[参考资料](https://blog.csdn.net/nestingChina/article/details/5491730)

Update: 以上的博客已经找不到了，这是另一个链接：[参考资料](https://blog.csdn.net/anypkv/article/details/9564539)

实现如下：

- 手动二分出大矩形的大小 $W, H$
- 随机交换若干对小矩形的长/宽
- 将所有矩形按照某种方式排序（长度，宽度，面积，周长，长宽比，长宽差……你能想到的都可以尝试）
- 对于每个矩形 $X$，枚举它可能的位置：
  - 假设 $X$ 将要紧贴着矩形 $Y$ 摆放
  - (1) $X$ 的左下角 = $Y$ 的右下角
  - (2) $X$ 的左下角 = $Y$ 的左上角
  - (3) $X$ 的左上角 = $Y$ 的右上角
  - (4) $X$ 的右下角 = $Y$ 的右上角
- 并选择估价函数最高的位置
  - 若 $X$ 超出边界，函数值为 $- \infty$
  - 否则对于每个矩形 $Z$：若 $X, Z$ 重合，函数值为 $- \infty$；否则让函数值加上 $X, Z$ 各自边长扩大 $1$ 后的重叠面积。
  - 如果 $X$ 紧贴着矩形的边界，让函数值乘以 $3$
  - 最后让函数值除以 $X$ 左下角的横坐标加 $1$
- 跳到第二步，直到得出一个足够优秀的答案为止；或者发现无解则跳回第一步调整 $W, H$ 的大小

赠送测试点 $8$ 答案的可视化结果：[nowhere8.png](https://i.loli.net/2019/11/22/1adgEF2OTYhLpvs.png)

[提交记录 (100 pts)](https://loj.ac/submission/681896)
