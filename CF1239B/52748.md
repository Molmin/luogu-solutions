这题最大的价值在于引入了一种非常直观有效的思考括号序列相关题目的工具：折线图。

对于一个长度为 $n$ 的括号序列，把左括号看做 $+1$，右括号看做 $-1$，求出该序列的前缀和数组 $h_i$。

一个括号序列合法的充要条件为：

 - $\forall i \in [0, n], h_i \geq 0$；
 - $h_n = 0$。

将 $h_i$ 画到平面直角坐标系中，可以发现合法的充要条件是：

  - 整条直线不低于 $x$ 轴。
  - $h_n=0$

现在回到题目中，先来思考一个没有修改的 $Case$，即一个序列循环移位之后合法的括号序列有多少个。

若 $h_i=n$ ，结论是**所有最小值所在的位置都一一对应一个合法的括号序列**。

设所有最小值的位置为 $p_i$。可以发现原序列中 $p_i$ 的位置一定是右括号，且任意 $h_{p_i} \leq 0$。使得位置 $p_{i}+1$为新的序列的开头即可得到一个合法的括号序列。

至于为什么是合法的括号序列，则需要考虑该循环唯一对于前缀和数组的影响以及判定合法的充要条件。

设 $t = |\min h_i|$，可以发现操作之后，原来 $(p_i, n]$ 的位置整体上移 $y$ 个单位长度，且将 $[0, p_i]$ 这个折线也向上平移 $t$ 之后接到了后面。

现在思考一下这个折线图是否合法：

 - 整条折线向上平移了 $t$，可以发现一定不越过 $x$ 轴。
 - 左右括号的数量并没有变化，所以 $h_n$依然为 $0$。

至此简单的 $Case$ 已经解决了。

现在再考虑上进行一次修改，要使得最小值的数量最多。

一定只需要考虑交换不同的括号，否则这个操作相当于没做。

现在考虑交换对于 $h_i$ 数组的影响。

 - 交换`(`和`)` 相当于区间减 $2$。
 - 交换`）`和`(`相当于区间加$2$。

可以发现操作 $2$ 不会使得答案变优。

先将序列变成其中一个最小值对应的合法括号序列，这个操作一定是可以完成的，变换之后必然不会有区间是一段前缀和后缀拼起来，具体原因下面讲。

变换之后 $t=0$。

答案一定来自最小值是否变化两种情况。

 - 最小值不变，则需要最大化修改区间内 $2$ 的数量，且不能包含 $1, 0$。
 - 最小值变化，则需要最大化 $1$ 的数量，且不包含 $0$。

如果将原有的 $0$ 变成 $-2$ 显然是不优的，因为不会比原序列 $0$ 的数量更多。

至此问题解决，根据实现不同可以做到 $O(n)$  或者 $O(n \log n)$。
