考虑费用流模型：

源点连每个员工，流量为 $1$，费用为 $v_i$（记为一类边）。

每个员工连对应的树上节点，流量为正无穷，费用为 $0$。

树上每个节点连向自己的儿子，流量为正无穷，费用为 $0$。

树上每个节点向汇点连边，流量为 $1$，费用为 $0$（记为二类边）。

删除可以一个 $\log$ 线段树分治掉，故只需考虑插入一个员工 $i$ 的影响。

不妨记 $a_i,b_i$ 表示 $x_i$ 子树中满流的一类边与二类边的数量，将一条源点 $\rightarrow$ 一类边 $\rightarrow$ 二类边 $\rightarrow$ 汇点的流量路径记作一个匹配。

$1.$ 若 $b_i < size_{x_i}$，则员工 $i$ 所对应的一类边可以直接与子树中未满流的二类边匹配。

$2.$ 若 $b_i = size_{x_i}$ 且 $a_i = size_{x_i}$，则退流子树内一条一类边权值最小的路径后，将员工 $i$ 对应的一类边与该二类边匹配。

$3.$ 若 $b_i = size_{x_i}$ 且 $a_i < size_{x_i}$，这意味着 $x_i$ 至少有一个祖先的一类边与 $x_i$ 子树中某点的二类边匹配，这也意味着存在一条 $x_i$ 到 $x_i$ 父亲的反向边，不断地沿着此类边向上走直到 $a_i = size_{x_i}$ 后以 $2.$ 中的方式处理即可。

考虑用树剖模拟上述过程。若 $x_i$ 的所有祖先 $size_u - a_u$ 都不为 $0$，则一定存在一种方案使得 $b_i < size_{x_i}$，故直接将员工 $i$ 插入即可。否则令 $u$ 为离 $x_i$ 最近的满足 $size_u - a_u = 0$ 的祖先（包括 $x_i$ ），用员工 $i$ 对应的一类边替换掉 $u$ 子树中权值最小的一类边即可。以上操作均可用 $multiset$ 与线段树维护。

总复杂度 $n \log^3 n$。

