首先考虑如何判定合法。两种思路，搞出 DFA，或者找充要条件。大概想一下会发现 DFA 状态数肯定是爆炸的，所以只能找充要条件。

**Lemma.** 记 $A$ 为任意前缀中 `B` 的数量减 `A` 的数量的最大值，同理定义 $B,C$，那么合法的充要条件是 $A+B+C\le n$。

**必要性.** 若 $S$ 可划分为 $n$ 个 `ABC`，`BCA`，`CAB`，那么 $A$ 一定不大于 `BCA` 的数量，$B,C$ 类似。于是可知 $A+B+C\le n$。

**充分性.** 考虑如下构造：第 $i$ 个 `A` 与第 $i+A$ 个 `B` 与第 $i+A+B$ 个 `C` 构成一个三元组（下标超过 $n$ 的看做循环）。根据定义可知第 $i+A$ 个 `B` 一定在第 $i$ 个 `A` 后面，第 $i+A+B$ 个 `C` 一定在第 $i+A$ 个 `B` 后面；且第 $i+A+B$ 个 `C` 一定在第 $i+A+B+C$ 个 `A` 之前，又由于 $A+B+C\le n$，所以这个 `A` 一定不超过第 $i+n$ 个 `A` 即第 $i$ 个 `A`。由此可以发现，这样的三元组从 `A` 走到 `B` 走到 `C` 不会走过一整圈，且是按顺序走的，进而可以得知一定是符合题意的。 

于是，设 $f(i,a,b,c,A,B,C)$ 表示考虑前 $i$ 个字符，`A,B,C` 分别有 $a,b,c$ 个，$A,B,C$ 的含义如上所述，的方案数。显然 $a+b+c=i$，因此实际上状态数是 $O(n^6)$ 的，转移是 $O(1)$ 的，所以总复杂度 $O(n^6)$，且常数非常小。

[代码](https://atcoder.jp/contests/agc055/submissions/38180885)

