- 多写题解从我做起。
- 勿做斜杠青年从我做起。
- 希望作者不要爆零。

**题意**
- [题目链接](https://www.luogu.com.cn/problem/P7963)。
- 一个 $n\times m$ 的网格。
- 每个格点除了向边缘没有网格线以外上下左右四个方向都有四条网格线。
- 每个棋子有且仅有三种走子方式：**只**通过**一条**标号为 $1$ 的网格线走一步，**只**通过标号为 $2$ 的网格往**同一个方向**一直走，**只**通过标号为 $3$ 的网格走。
- 每个棋子在通往其它格点时可能会遇到棋子阻碍，这时一定不能**穿过**该棋子，但是如果该棋子与本棋子颜色不同且等级不高于走子的等级，则可以到达该棋子所在的位置，否则不可以。
- 给出棋盘以及所有网格线的标号，在棋盘上按顺序放 $q$ 个棋子，你要对于每个棋子输出**当前**它能够走到的格点数量（但不需要走子）。
- 多测，数据组数不超过 $5$，$1\le q\le n\times m\le 2\times 10^5$，$q\le 10^5$，保证每个棋子的等级都是 $1$ 到 $q$ 的整数，且只有白子和黑子。

**暴力**
- 别看到这题如此要求复杂连暴力都不会打了。
- ~~下次就应该多做大模拟。~~
- 这里主要要注意的是三种走法是可能经过重复的节点的（比如走法 $1$ 和走法 $3$ 重合了），这里不能草率地用一个数组记录有没有跑过。
- [暴力代码](https://www.luogu.com.cn/paste/a9szfy92)，得分 $32$。
- 打完它后笔者表示怀疑人生。
- 接下来还有更怀疑人生的：看着 $\text{1.00GB}$ 的空间我们大胆猜测它是一个数据结构题……
- 所以我们赶快来水分吧！水完分再去学数据结构。
- [这是作者开（正在更新的）的线段树专题](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/xian-duan-shu)。
- 下面是作者的水分挑战。（作者将会给出下面代码实现的时间开始到结束）

**暴力**
- 作者觉得自己暴力打得太烂了于是决定重新打一遍暴力！
- 作者将一些实现的细节记录：我靠作者的位移惯性打成短整型，我靠作者忘记判断是否越界就读取数据！
- 虽然打了 $2$ 小时但代码只有 $1.6\text{KB}$ 还是可以的。
- [代码实现](https://www.luogu.com.cn/paste/5beweyjc)。
- 时间复杂度 $O(nmq)$，空间复杂度 $O(nm+q)$，由于某组织的数据太水这个可以拿 $44$ 分，即通过编号为 $1$ 至 $11$ 的测试点。


**不存在互通道路**
- 这里重点讨论直行道路的情况。
- 使用并查集即可维护每个点上下左右所到达的最远的棋子，然后就可以计算（不愧是并查集）。
- 由于某组织的数据太水导致暴力的代码就可以水到该部分分所以这里不给出代码。

**不存在直行道路**
- 也就是只需要维护互通道路的情况外加四个点的特判。
- 考虑离线从后往前跑。（这是一个直觉：连边比删边好维护）
- 使用一个并查集维护连通性，用两棵动态开点权值线段树分别维护棋子黑色和白色的棋子有哪些，暴力删点，暴力线段树合并即可。
- 水分代码打线段树合并……真是非人哉。
- 时间复杂度 $O(\max(n,m)\alpha(nm)q+nm\lg(nm))$，空间复杂度 $O(nm\lg(nm)+q)$。
- 注意实现有个小细节，棋子可能会被不同的连通块盯上，所以我们在合并信息的时候要对棋子进行去重操作，这个时候可以通过离散化重新标记每个棋子的级别使得棋子级别两两不同便于操作。
- 作者打了很久，但是自测有点像暴力？~~原来是作者与或不清写假了。~~
- [代码实现](https://www.luogu.com.cn/paste/xofzw4ew)，能够得到 $56$ 分的~~好~~成绩。
- 打了 $6$ 小时（其实中途空缺了），代码 $3.7\text{KB}$（死人啦），线段树合并部分的代码其实并不长。

**一般情况**
- 必须处理掉那个“直行道路”。
- ~~其实到现在我们都没有考察到底有什么性质。~~
- 在并查集维护最远点的基础上，我们主要就是希望知道能走到的路径中有多少已经在 $3$ 路径之内。
- 简单来讲就是查询某个连通块内横/纵坐标为 $x$ 的点在区间 $[l,r]$ 有多少个。
- 树套树是一个直观的想法~~树套树合并吗~~，~~虽然如果正确实现时空复杂度也是对的~~但显然过于复杂。
- 完全没有用到连通块是横纵坐标连续的性质呢，我们对坐标 $(x,y)$ 分别标号为 $mx+y$ 和 $ny+x$，然后查询相当于查询一个区间的点有多少个，用最朴素的线段树合并即可。
- $4$ 类线段树，$3$ 类并查集，时间复杂度 $O(nm\lg(nm)+q\lg q)$，空间复杂度 $O(nm\lg(nm)+q)$ ~~实在是太好打了呢~~。
- [代码实现](https://www.luogu.com.cn/paste/gtojy7s8)。
- 打了两天（中途有空缺），代码长度 $4.3\text{KB}$（我靠怎么这么长）。
- 做一些细节上的提示：判断标号为 $1$ 的网格线需要的判断语句较长，推荐使用宏定义。
- 注意四类线段树全都是用来维护 $3$ 号网格线的，而上下的最值信息才是 $2$ 号网格线维护的。
- 感觉线段树合并并不是最困难的，维护才是最困难的，考场上很容易写挂。
- 还有感觉题目的样例真的不错，过了样例基本上程序就没错了。