可以发现，选择一部分给定的 $E_i$，即选出 $\mathcal{E} = \{E_1, E_2, \ldots , E_{N - 1}\}$ 的一个子集 $\mathcal{S} \subseteq \mathcal{E}$。

考虑 $\mathcal{S}$ 能够连通的所有点，令它们为 $f(\mathcal{S})$，即 $f(\mathcal{S}) = \{u \mid u \in E_i \in \mathcal{S}\}$。

如果 $\mathcal{S}$ 非空且 $|f(\mathcal{S})| \le |\mathcal{S}|$，那就完蛋了，因为不管怎么使用这 $|\mathcal{S}|$ 条边，都会连出环来，造不成树。

也就是说，对于任意 $\mathcal{S} \ne \varnothing$，都必须要有 $|f(\mathcal{S})| \ge \mathcal{S} + 1$。

这是一个有解的**必要条件**，之后的构造显示了它也是**充分条件**。

看起来很 Hall 定理，先整个二分图匹配再说吧。

二分图左边为 $N$ 个点，右边为 $(N - 1)$ 个点集，如果 $u \in E_i$，则左边的 $u$ 对应的点与右边的 $E_i$ 对应的点之间连边。

这样必须要有右侧的 $(N - 1)$ 个点的完备匹配，如果求不出来一定无解，可以使用 Dinic 实现。

那么左边就会有恰好 $1$ 个点没被匹配到，令它为 $r$。

考虑从 $r$ 开始 DFS，随便找到一个与 $r$ 相邻的，且未被经过的右侧的点 $i$，把它标记为被经过了，令这个点在左侧的匹配为 $u$，然后就能确定 $E_i$ 中选择的两个点是 $r$ 和 $u$。然后 DFS 递归进 $u$，这样一直下去直到把所有点都经过为止。

如果还没有经过所有点，就无法拓展新点而返回了，那就是无解。

这个过程有没有可能把有解判成无解呢？

如果过程中途停止了的话，当且仅当：对于所有的左侧被经过的点，与它们相邻的右侧的点都被经过了，无法拓展新点。

显然左侧被经过的点数在任意时刻都等于右侧被经过的点数 $+ 1$，因为多了一个 $r$。

考虑令 $\mathcal{S}$ 为右侧**未被经过**的点，它们在左侧对应的点也是未被经过的，那么 $|f(\mathcal{S})| \le |\mathcal{S}|$，也就是无解，与假设矛盾。

所以一定不会把有解判成无解，如果无解一定是 $f(\mathcal{S})| \le |\mathcal{S}|$ 的情况出现了。所以 $|f(\mathcal{S})| \ge \mathcal{S} + 1$ 是充分必要条件。

时间复杂度为 $\mathcal O (N + M \sqrt{N})$，[评测链接](https://atcoder.jp/contests/agc029/submissions/10423134)。