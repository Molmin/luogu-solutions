- 话说俺最近的题解咋都没有审核啊。
- 算了这只是个人笔记，提交题解只是进一步检验而已。

**题意**
- [题目链接](https://www.luogu.com.cn/problem/P7603)。
- 从前有一群鬼，他们喜欢数论，因此是**魔鬼**。
- 鬼屋编号为 $1$ 到 $n$。
- 有 $m$ 个操作：
- $0\ x\ y$，以 $x$ 为质因数的房子都加上 $y$ 次闹鬼。
- $1\ x\ y$，一个监控器被安装，当以 $x$ 为质因数的房子的（在安装后）闹鬼次数总和达到或超过 $y$，这个监控器会立刻报警。
- 对于每个 $0$ 操作输出操作触发的警报器。
- 可恶的**数论魔鬼**不允许我们离线进行操作，因此这题强制在线。
- $1<x\le n,m\le 10^5$，$0\le y<2^{32}$。

**分析**
- 有句话说得好：要用 **魔鬼** 来打败 **魔鬼**，这提示我们使用 **数论魔鬼** 的方式来思考。
- 作者可能会提到一些有趣的结论并且没有加上它的证明，因为作者要用 **魔鬼** 打败 **魔鬼**，如果感兴趣也可以对作者的文章进行评论~~或者不让题解过审~~。
- 首先观察到这一点：质因子很少啊！我们知道平均每个数的不同质因子 $\omega(n)$ 是 $O(\ln\ln n)$ 级别的，最特别的不超过 $O(\ln n/\ln\ln n)$ 级别（更具体化地，在 $10^5$ 内这个数字不会超过 $6$ 因为 $2\times 3\times 5 \times 7\times 11\times 13\times 17=510510$），埃拉托斯特尼筛法 $O(n\ln\ln n)$ 筛出每个数的质因子之后（这题空间大可以直接存），插入操作是平凡的。
- 但问题是查询操作怎么办？
- 这是一个有趣的地方，鸽巢原理：如果 $\sum_{i=1}^nx_i\ge y$，那么一定有 $\max_{i=1}^nx_i\ge \lceil y/n\rceil$（这里增强了原定理来适应变量取整数的情况）。
- 那特别地，我们对于每个警报器阈值 $y$，对于它的因子个数 $\omega(x)$，对于它的每个质因子 $p$ 都设下阈值 $\lceil y/\omega(x)\rceil$，它的复杂度会如何呢？
- 不难发现触发有可能是真的，有可能并没有效果，但是容易发现对所有没有效果的情况，警报器阈值都会减小 $1/\omega(x)$，所以假警报的次数不会太多，可以从容更新。
- 因为我们还要使用数据结构维护警报（多一个 $\log$），最坏的时间复杂度不会超过：
$$O(n\ln\ln n+m\omega(x)\log_{\omega(x)/(\omega(x)-1
)}y\log n)$$
- 将 $\omega(x)=O(\ln n/\ln\ln n)$，$y=W=2^{32}$ 带入可得。
$$O(n\ln\ln n+m\frac{\ln W\cdot \ln n\cdot \log n}{(\ln\ln n)^2-\ln\ln n\cdot \ln(\ln n-\ln\ln n)})$$
- 值得一提的是，通过一些有趣的手段可以得到一个清晰一点的界（不完全是上式转移得到）：
$$O(n\ln\ln n+m\frac{\ln W\cdot \ln^3 n}{\ln\ln n})$$
- 本人也不对此复杂度做出分析，反正在测试数据中肯定会给你卡到这个复杂度的，方法是给 $99884$ 个 $1\ 30030\ 2^{32}-1$，再在后面的 $116$ 个数中（可以证明，存在一种安排使得前 $115$ 个闹鬼事件都是假激发，复杂度 $6\times 116\times \log (99984)\times 99984=1.15\times 10^9$），所以可以做好卡常的准备了。
- 空间复杂度 $O(n\ln\ln n+m\omega(x))=O(n\ln\ln n+m\ln n/\ln\ln n)$ 是显然的。

**实际实现**
- 实现有些细节，因为我们刚刚推出来的复杂度要求我们卡常。
- 但是阈值是当时的情况这有点麻烦，不过还好，就是每个都要开个无符号长整型，不过这不影响复杂度。
- 还有一个有趣的情况需要注意：你是不是担心 $0$ 操作和 $1$ 操作互相引发，哈哈，你不需要管这个问题，原因留做习题。
- 详细见于代码，作者的错误是将没有判断可不可行就删除查询操作。
- [代码实现](https://www.luogu.com.cn/paste/bipaa6rw)。

**后记**
- 顺带一提若这题允许离线就简单了，修改操作太少了，先把所有操作可持久化下去，然后对于每次查询二分查找首次冲突的警报即可。
- 时间复杂度 $O(n\ln\ln n+m\omega(x)\log m)$，空间复杂度同在线做法。