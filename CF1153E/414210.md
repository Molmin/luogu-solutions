先考虑这么一个性质：

当某个矩形内有蛇头蛇尾之一的时候，矩形上一定会有奇数条边，否则一定有偶数条。

下面给出证明：

当端点不在矩形内时，蛇身进入矩形后一定要出去，因此边数一定是偶数。当只有一个端点在矩形里时，与端点直接相连的蛇身进入矩形后就不再出去，因此边数是奇数。有两个端点在矩形内时，结果是两个奇数相加也是偶数。

于是我们暴力枚举每行每列，根据结果分两种讨论：

1.每行每列各有两个是奇数。蛇头蛇尾被确定在了 $4$ 个点之内，暴力枚举排除即可。操作次数为 $2n+1$。

2.只有一行或者一列有两个数是奇数。蛇头蛇尾在同一列或者一行，并且我们确定了它们的行或列。因此我们选择其中的一行或一列，二分端点的所在的列或行即可。操作次数为 $2n+\log n$。
