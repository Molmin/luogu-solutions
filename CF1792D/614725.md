提供一个乱搞做法，能通过现有数据。思路十分暴力，跑的也很慢，仅供参考。

首先考虑 $r$ 数组美观的条件，即 $q_{p_i}=i$。那么，我们就是要构造一个 $q$，使得其尽可能多的满足下列条件：$q$ 的第 $p_i$ 位是 $i$。

也就是说，我们可以把满足形如“第 $a$ 位的值是 $b$”的数组看成一个集合，然后从小到大枚举 $i$，看当前所有集合的交是否为空集。

这种集合操作显然用 bitset 维护。用一个二维 bitset 数组维护这种条件。复杂度 $O(\frac{n^2m}{w})$。看似不可思议但是跑过去了。[代码](https://codeforces.com/contest/1792/my)。