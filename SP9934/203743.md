按我自己的理解再来解释一下这题的 $\mathcal O(n)$ 做法。

约定：$x$ 堆表示个数为 $x$ 的堆。 

首先，我们手玩了样例以后可以发现，当没有 $1$ 堆的时候特别简单，就讨论一下奇偶就行了。唯一麻烦的就是 $1$ 堆可以改变先后手所对应的奇偶性，导致特别麻烦。正如spoj原站上一个评论所说：

> this question demonstrates the power of 1!

所以我们考虑把 $1$ 堆与其他堆分开考虑，看成两个子游戏。

但是我们发现，我们并不能完全把 $1$ 堆与其他堆割裂。因为它们可能之间会有合并。但这些合并的目的一定是为了去掉一个 $1$ 堆。所以可以把它们看作同类型考虑。

我们设 $sum$ 为保留 $1$ 堆后的最大操作次数，$cnt$ 为 $1$ 堆的个数。那么我们分几种情况讨论：

- $sum=cnt+cnt-1$（即没有非 $1$ 堆）

	此时 $1$ 堆无法与其他非 $1$ 堆合并。我们手玩以后可以发现，当 $cnt\equiv 0\pmod 3$ 时先手必败。

- $sum\equiv 1\pmod 2$

	那么此时我们需要保证先手在操作完 $1$ 堆后一共拿走了偶数个 $1$ 堆。
    
    我们考虑手玩一些情况，会发现：无论 $cnt$ 为多少，先手必胜。
    
- $sum\equiv 0\pmod 2$

	那么我们需要保证先手在操作先手在操作完 $1$ 堆后一共拿走了奇数个 $1$ 堆。
    
    同样手玩一些情况后会发现：当 $cnt\equiv 0\pmod 2$ 的时候先手必败。

所以这就完了？

~~那你为什么连样例都过不了~~

我们考虑出错这组数据：$1,1,2$。

先手的一个策略是把 $2$ 拿成 $1$，让后手面临了必败态。

于是我们考虑刚才考虑错在了哪里：

先手可能会把一个非 $1$ 堆拿成 $1$ 堆，从而影响决策。所以不能如此简单地考虑。但是假如先手想把 $x$ 拿成 $1$，那么后手一定会阻止先手，具体来说就是又合并一个 $1$ 堆进去，或者自己去使用一个 $1$ 堆且毫无顾忌，或者合并掉两个 $1$ 堆。总之，这对先手是不利的。

但是有一种情况是例外，当 $x=2$ 的时候，先手就可以直接创造一个 $1$ 堆。这个会有什么影响呢？

- 假如后手合并一个 $1$ 堆进去，可能改变的 $1$ 堆个数就影响了胜负。

- 假如后手使用 $1$ 堆，就相当于把那个 $2$ 堆给去掉了，就可能会影响胜负。

- 假如后手合并两个 $1$ 堆，情况同第一种。

- 还有同前三种不一样的情况就是把先手创造的 $1$ 堆合并到一个非 $1$ 堆上去。

但其实 $1/3$ 种方式并没作用，因为你并没有删除那个 $2$ 堆，也没有改变先后手，所以后手是不会采用的，真正有意义的就是 $2/4$ 种。

所以，当非 $1$ 堆只有一个 $2$ 堆的时候，先手是可能可以通过创造 $1$ 堆来强制后手使用第二种方式来改变胜负的。

因此我们需要单独讨论非 $1$ 堆只有 $2$ 的情况：

同样根据上文的分析，可以知道当 $cnt\equiv 0\pmod 3$ 时先手必败。

所以总结一下：

- 当非 $1$ 堆只有一个 $2$ 堆或者没有非 $1$ 堆的时候

	当 $cnt\equiv 0\pmod 3$ 时先手必败。

- 否则

	若 $cnt\equiv 0\pmod 2$ 并且 $sum\equiv 0\pmod 2$ 时先手必败。
    
代码就不放了。