## [CF1810G](https://www.luogu.com.cn/problem/CF1810G)

设 $dp_{i,j,k}$ 表示考虑了前 $i$ 个位置，当前前缀和为 $j$，最大前缀和为 $k$ 的概率，时间复杂度 $O(n^3)$。

考虑计算位置 $i$ 作为最大前缀和的贡献。设长度为 $n$，满足 $a[1,i]$ 的任意后缀和 $> 0$、$a(i,n]$ 的任意前缀和 $\le 0$ 时 $i$ 才会对 $n$ 产生贡献，贡献为 $h_{s_i}\times P$，$P$ 指总概率。

$P$ 由两部分组成，设 $dp_{i,j}$ 表示从 $i$ 位置向前，初值为 $j$，填完 $i$ 到 $1$ 所有位置后的期望，$f_{i,n}$ 表示从 $i$ 位置向后，填完 $i$ 到 $n$ 满足任意前缀和 $\le 0$ 的概率，得到 $i$ 对 $n$ 的贡献为 $dp_{i,j}\times f_{i,n}$。

先考虑前缀。对于 $j=1\sim n$，有 $dp_{0,j}=h_j$。对于 $i\ge 1$，$dp_{i,j}=dp_{i-1,j+1}\times p_i+dp_{i-1,j-1}\times q_i$，从 $dp_{i-1,j-1}$ 转移需要满足 $j>1$，因为需要保证后缀和 $>0$。

$f_{i,n}$ 只能做到 $O(n^3)$，因为要从每个位置开始 dp，一次 dp 时间复杂度为 $O(n^2)$。考虑设 $g_{i,j}$ 表示从 $\le i$ 的一个位置 $k$ 开始填到 $i$、当前前缀和为 $-j$、任意前前缀和 $\le 0$ 的概率 $\times $ $dp_{k,0}$。$g_{i,j}=g_{i-1,j+1}\times p_i+g_{i-1,j-1}\times q_i$，从 $g_{i-1,j-1}$ 转移需要满足 $j>0$。最后还要加上从 $i$ 出发的贡献，$g_{i,0}\leftarrow g_{i,0}+dp_{i,0}$。

$ans_i=\sum_{j=0}^ng_{i,j}$。

[代码](https://codeforces.com/contest/1810/submission/208718107)。

