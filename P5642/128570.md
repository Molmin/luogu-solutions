模拟赛考了，对就是讨论区里峰巨那个。为了订这题被创了三天，订出来了写篇题解回馈社会。膜拜讲题人 [275307894a](/user/181766) /bx。

省流：本题 $n,m$ 同阶，此法时间复杂度 $\mathcal O(n\log n)$。**请注意本题解中部分字母的含义与题面中不同。**

------------

首先考虑如何求 $W(U)$。不知道这算不算经典问题~~但上次见到是在模拟赛 T2~~。

对于路径 $(x,y,w)$，我们把它挂在 $u=lca(x,y)$ 上。设 $f_u$ 表示仅考虑 $u$ 子树以内所得的最大值，$s_u=\sum\limits_{v\in son_u}f_v$ 表示仅考虑 $u$ 子树以内且钦定 $u$ 不被占用所得的最大值。

在 $f_v$ 的基础上 $s_u$ 显然易求，考虑如何求 $f_u$。若 $u$ 不被占用则 $f_u=s_u$，若 $u$ 被占用，由于仅考虑 $u$ 子树内，所以占用 $u$ 的路径一定有 $lca(x,y)=u$，而我们已经把这样的路径挂在了 $u$ 上。若要选择这一条路径，则对于每个在 $(x,y)$ 路径上的点 $z$，都事先不能被占用，否则将会在这里产生一个交。所以此时有 $f_u=w+s_u-\sum\limits_{z\in path(x,y)}(f_z-s_z)$。$f_u$ 在所有情况中取 $\max$ 即可。

考虑如何维护上式中的和号。~~使用树剖套数据结构可以做到 $\mathcal O(n\log^2n)$（~~ 事实上对于树上的{单点/子树/链}{加/求和}，除去平凡的单点加单点求值、非平凡的链加链求和，其余情况都可以直接或间接地用树状数组以 $\mathcal O(n\log n)$ 解决。具体到本题，将和号内的 $f_u-s_u$ 视作单点加的值来维护即可。由于在计算 $f_u$ 时 $u$ 及 $u$ 的祖先均未被计算，所以链求和时无需考虑这些部分，可以有所简化。

------------

现在 $f_1$ 即为 $W(U)$，另外在计算 $f$ 数组时，我们把路径权值 $w$ 更新为 $w+s_u-\sum\limits_{z\in path(x,y)}(f_z-s_z)$，此时它表示在选择这条路径的情况下，仅考虑 $u$ 子树以内所得的最大值。

我们再设 $g_u$ 表示仅考虑 $u$ 子树的补（即整棵树去掉 $u$ 子树的部分）所得的最大值。显然 $g_1=0$。在计算 $u$ 的儿子的 $g$ 值之前，先令挂在 $u$ 上的路径的权值 $w\gets w+g_u$，此时这一权值表示在选择这条路径的情况下的全局最大值。

考虑如何由父亲 $u$ 向儿子 $v$ 递推。根据所求的定义，$v$ 的子树内外被人为分割，故求 $g_v$ 时边 $(u,v)$ 不能被占用，也即不能有路径同时占用 $v$ 和它的父亲。 故有如下几种情况：

- $u$ 未被占用，则 $g_v=g_u+s_u-f_v$；

- $u$ 与它的父亲一同被占用，则这条占用它们的路径满足 $lca(x,y)$ 是 $u$ 的祖先，$x$ 或 $y$ 是 $u$ 的后代但不是 $v$ 的后代。由于上面已经更新了路径权值，所以在满足如上要求的路径中找出最大的权值，减去 $f_v$ 即可；

- $u$ 与它的儿子一同被占用，则根据所求定义，$v$ 不能作为这样的儿子。事先将挂在 $u$ 上的路径按权值从大到小排序，遍历找到第一条满足 $x,y$ 均不是 $v$ 后代的路径，这样的路径不会占用 $v$，用它的权值减去 $f_v$ 更新答案。

我们分析一下上面第三种情况的时间复杂度。称一次节点对路径的访问有效等价于这次访问更新了答案，因为一条路径最多会占用 $u$ 的两个儿子，所以每条路径被“无效访问”的次数最多为 $2$，而根据上述流程，每个 $v$ 最多会进行一次“有效访问”，所以这里对路径的总访问次数是线性的，所以对于所有的 $u$，这步的总时间复杂度为排序所需的 $\mathcal O(m\log m)$。

在计算出 $g_v$ 之后向下递归之前，将挂在 $u$ 上的路径权值按照端点插入到以 dfs 序为下标的线段树上，这样就能以单点插入区间求最大值的线段树实现上面第二种情况的需求。

------------

现在我们求出了一车 dp 值，回头看看题中定义的 $f(u,v)$。题目要求在路径集合 $U$ 中加入 $(u,v,f(u,v))$ 后，$W(U)$ 刚好不能被更新。考虑在原树上删除路径 $(u,v)$ 上的所有点和与这些点相邻的所有边，对形成的若干子树的 dp 值求和，则 $f(u,v)$ 即为 $W(U)$ 减去这个和。我们的目标即为求出这个和。

考虑上面所说“形成的若干子树”，在原树以 $1$ 为根时，这些子树要么仍是一个子树，要么是某个子树的补，它们的 dp 值即为上面求出的 $f_u$ 和 $g_u$。于是我们可以转而考虑每个 $f_u$ 或 $g_u$ 对答案产生的贡献。$f_u$ 会产生贡献当且仅当新增的路径不经过 $u$ 而经过它的父亲，$g_u$ 会产生贡献当且仅当新增的路径经过 $u$ 而不经过它的父亲，简单容斥即可求出贡献次数。

整个流程中，求 lca、树状数组、排序、线段树均为单 $\log$，在本题 $n,m$ 同阶的情况下，总的时间复杂度为 $\mathcal O(n\log n)$。

代码见[评测记录](/record/103495053)，目前是无氧最优解。

upd:同一份代码[吸了下氧](/record/104028662)，目前是最优解。

------------

闲话：当事模拟赛，开赛不久 T4 被指出是重题，于是从 P3772 换成了这道（

另外感谢峰发帖建议这题紫升黑，这下黑题喜加一了。