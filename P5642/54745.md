设 $f_u$ 为只考虑 $u$ 子树内的路径，$g_u$ 表示只考虑子树外的路径。通过这两个数组可以 $O(n)$ 计算出答案。

计算 $f_u$ 可以考虑转移时枚举 LCA 是当前点的路径，设 $f'_u$ 表示 $fa_u$ 除去 $u$ 这颗子树后其他儿子的 $f$ 值之和。我们用树状数组维护 $f'$ 的单点加链求和就可以从下往上计算出 $f_u$。

计算 $g_u$ 时，考虑从 $g_u$ 转移到 $g_v$。$u$ 点不选路径就是用其他子树的 $f$ 和 $g_u$ 的和转移；选了一条 LCA 为 $u$ 的路径，相当于 ban 了某些儿子不能用这条路径转移；
选了一条 LCA 在 $u$ 上面的路径，相当于 ban 了一个儿子不能转移。我们在从上往下枚举到某个 LCA 时可以把这条路径的答案存在端点处，转移的时候查询子树 max 即可。用线段树维护。

总时间复杂度 $O(n \log n)$。

代码 https://www.luogu.com.cn/paste/w7qd0zpi