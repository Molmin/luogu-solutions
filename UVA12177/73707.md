# 题目大意

给定一个 $ M \times N $ 的矩阵和在每个点向四个方向走的概率，求从 $(1, 1)$ 走到 $(M, N)$ 的期望步数。

$M, N \leq 40$

# 题目分析

此题表面上看起来是套路题,定义 $f(x, y)$ 为从 $(x, y)$ 走到 $(M, N)$ 的期望步数。则有转移方程式

$ f(x, y) = p_{x, y}^{(1)}f(x + 1, y) + p_{x, y}^{(2)}f(x, y + 1) + p_{x, y}^{(3)}f(x - 1, y) + p_{x, y}^{(4)}f(x, y - 1) $

$ f(M, N) = 0 $

显然会出现循环依赖，可用高斯消元，但高斯消元是 $\Theta(N^3M^3)$ 的，显然不行。考虑优化。

1. 从 $f(M, N)$ 开始消元，最后消到 $f(1, 1)$ 则不需要回代。
2. 观察此题，我们发现高斯消元时，仅有极少数的系数不为 $0$。具体来说，从 $f(M, N)$ 开始消元，对 $f(x, y)$ 消元时 ，至多会影响到$f(x, y + 1)$ 和从 $f(x - 1, 1)$ 到 $f(x - 1,y)$ 的方程（消成下三角矩阵）。时间复杂度 $\Theta(N^3M^2)$，加上常数优化或许能过。
3. 观察消元的过程，我们可以发现 $f(x, y)$ 对其他方程进行消元时，至多会影响到$f(x, y + 1)$ 和从 $f(x - 1, 1)$ 到 $f(x - 1,y)$ 项的系数（消成下三角矩阵）。时间复杂度 $\Theta(N^3M)$，即本题正解。

# 实现

我们对坐标进行编码 $e(x, y) \gets (MN - (x-1)N + y))$ 那么消 $e(x, y)$ 时至多只需消矩阵从 $e(x,y) + 1$ 到 $e(x,y) + N$ 的行的从 $e(x,y)$ 到 $e(x,y) + N$ 的项。（感性理解一下）

# 核心代码

```cpp
#define dN (N * M)
#define getP(x, y) (N * M -((y) + ((x) - 1) * M) + 1)
#define isZero(x) (abs(x) <= 1e-12)
inline void gauss()
{
    for (int i = 1; i <= dN; ++i) {
        for (int j = i + 1; j <= i + M + 1 && j <= dN; ++j) {
            const double r = d[j][i] / d[i][i];
            v[j] -= v[i] * r;
            for (int k = i; k <= i + M + 1 && k <= dN; ++k)
                d[j][k] -= d[i][k] * r;
        }
    }
}
```

## 附注

参见[浅析竞赛中一类数学期望问题的解决方法](https://wenku.baidu.com/view/90adb02acfc789eb172dc8a8.html)


