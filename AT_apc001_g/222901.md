唐爷爷要讲这题，所以我提前做了一做（

然而由于一些原因，这题解发出来时唐爷爷早讲完了（

首先有个题叫[teleporters](https://www.luogu.com.cn/problem/P4686)，和这个题非常像。但这两题做法完全不同，因为那题不在乎传送门位置，而这题在此要求严格。

我们先从最简单的原则开始考虑：

![](https://cdn.luogu.com.cn/upload/image_hosting/kupipesd.png)

当有一组配对关系确定之后，它外侧和内侧的两段会被永远合并，所以它们状态一定一样！

![](https://cdn.luogu.com.cn/upload/image_hosting/pdnugzxs.png)

我们可以用 $\text{ABCD}$ 来表示一个点的两边的不同状态，可以看出，$\text{A}$ 只能和 $\text{A}$ 配对，$\text{B}$ 只能和 $\text{C}$ 配对，$\text{D}$ 只能和 $\text{D}$ 配对。$\text{B}$ 和 $\text{C}$ 数量一定相等，要是 $\text{A}$ 和 $\text{D}$ 数量中有奇数那就不可以总司令就好了。

然后考虑具体连边方案，显然 $\text{D}$ 和 $\text{D}$ 间可以随便连接，反正你根本不会经过这些传送门。我们可以把形如 $\text{CAAAAAAB}$ 的段连成一个环，起点终点连起来视为一段，然后要求所有连续段里的地方都被经过。要是 $\text{A}$ 有 $4$ 的倍数个，我们直接用一堆 $\text{xyxy}$ 的配对方案四个四个消除所有的A即可。

![](https://cdn.luogu.com.cn/upload/image_hosting/250ytnau.png)

$\text{A}$ 不是 $4$ 的倍数个呢？直接用这样类似样例 $3$ 的方案“绞死”两个 $\text{A}$就行了！那为啥样例 $4$ 完蛋了呢？因为没有 $\text{A}$ 的 $\text{CB}$ 段是没有用的，它只能连接其他段，并且连接完之后不再有其它的操作空间。因此样例 $4$ 等价于一个环上有两个传送门，这个显然是无解的。

一开始那个题终于有用了，那题有个结论：添加一对传送门时，要么增加一个环，要么减少一个环，一开始只有一个环，那加减奇数次肯定没法让环数还是1！

然后这题就做完了，实现很简单，就不放代码了（

~~说句闲话，这题样例真强，在你不会时掐碎你所有错误想法，在你有思路时把正解呈现在你眼前（~~