妹看懂其他 5 种类型的题解，感觉麻烦了。。。

我们将题意进行转化可以得到应该算的是每种操作做或不做的答案和。

容易考虑 dp，设 $f_u$ 表示 $u$ 这个节点 tag 为 1 的期望，因为这样可以使需要修改的节点是 $\mathcal{O}(\log)$ 的。

然后思考转移，我们会发现有很多种点。

- 要 $\textsf{pushdown}$ 的点，一轮修改后一定是 $0$。

- 要 $\textsf{tag}\gets 1$ 的点有，一轮修改后一定是 $1$。

- 被 $\textsf{pushdown}$ 的点，一轮修改后为 $1$ 的概率是这个点到根上至少有一个 $1$ 的概率。

至少有一个 $1$ 的概率是 $1-$ 其他点全是 $0$ 的概率。

也就是 $P(tag_1\times tag_2\times tag_3\dots )$，但注意它不等于 $\prod P(tag_i)$，因为 $tag_1,tag_2$ 等可能是相关的。

于是我们再设计一个函数 $g_u$ 表示 $u$ 到 $rt$ 至少有一个 $1$ 的概率。

然后就是 $g$ 的转移，分为三部分。

第一类点，第二类点和它的子树，第三类点和它的子树。

第一类点 $g\gets g/2$。

第二类点和它的子树 $g\gets (g+1)/2$ 。

第三类点 $g$ 不变，$f$ 容易转移。

对于子树加打标记即可，时间复杂度 $\mathcal{O}(n\log n)$