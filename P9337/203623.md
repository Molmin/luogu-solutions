boring.

简单口胡一下。很明显，这个问题存在矩乘归约。考虑根号做法。

数颜色直接根号分治。对于 $\le B$ 的颜色，枚举颜色对，取出这个颜色对的区间中的 $\min,\max$，查询直接用分块二维数点，$O(nB+m\sqrt n)$。对于 $>B$ 的颜色，对每种颜色做一下。将相邻两个该颜色之间的区间用其 $\min,\max$ 代替，把询问区间离散化一下，然后跑回滚莫队用链表维护一下。单个颜色复杂度是 $O(m+n'\sqrt m)$，总的时间复杂度就是 $O(\dfrac {nm} B+n\sqrt m)$。取 $B=\sqrt m$ 有最优时间复杂度 $O(n\sqrt m+m\sqrt n)$。

我有一点 interesting 的想法，可惜地方太小，写不下。