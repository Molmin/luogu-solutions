题意：给定序列 $a_i$，$b_i$，设 $f(l,r)=\max\limits_{i=l}^ra_i\max\limits_{i=l}^rb_i$。求 $g(l,r)=\sum\limits_{l\le l'\le r'\le r}f(l',r')$。

设 $h(l,r)$ 表示 $\sum\limits_{i=1}^lf(i,r)$，考虑对于每一个 $r$ 维护后缀最大值，发现后缀最大值是单调不升的，于是每次右端点右移相当于进行了一次后缀赋值，显然只会有 $O(1)$ 次边块赋值，这种情况，我们需要对块重构。只有前后都是整块，才不需要重构。

对块内维护 $\sum\limits_{i=L}^xf(i,r)$，整块维护 $\sum\limits_{i=1}^Rf(i,r)$，将 $r$ 从 $1$ 枚举到 $n$，这样重构块的次数为 $O(n)$，平摊为 $O(n\sqrt n)$，可以做到 $O(1)$ 查询 $h(l,r)$。

当然，你还需要维护左端点，然后套上莫队就可以了，注意修改复杂度远远超过了查询复杂度，于是二次离线可以做到 $O(n(\sqrt n+\sqrt q))$，空间 $O(n+q)$。

因为没有对拍 $\text{NOIP}$ 连 $150$ 都没上，我已经是半退役状态，写不出代码了，但目测不到 $1s$，如果有错误请指出。