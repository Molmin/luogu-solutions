首先离线之后容易转换成有两个序列 $a$ 和 $b$，然后对 $a,b$ 区间加，然后求 $\sum a_ib_i$ 的历史和。

首先考虑只有一维的历史和是怎么做的，这是个经典的问题，如果你去网上搜题解，几乎所有的做法都是打三个标记。

但是这有个更好的理解方式：使用矩阵维护长度，当前的和和历史和，然后这样每个节点都是两个叶子的和，然后矩阵乘法有结合律和分配率，那么打 tag 即可。

那么原题也非常简单了，矩阵维护长度，序列 $a$ 的和，序列 $b$ 的和， $a_ib_i$ 的和和历史和。

直接写矩阵乘法会 TLE，注意到你需要维护的矩阵本质不同的数只有 $7$ 个，直接维护那 $7$ 个数然后手动矩乘即可。

[朴素实现](https://www.luogu.com.cn/paste/zp5fg5z2) [能过洛谷民间数据的实现](https://www.luogu.com.cn/paste/sdmubcwv)。


----

所以说四个简单题的 noip 我是怎么打出来这么烂的成绩的？？太小丑了吧。