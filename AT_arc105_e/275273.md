显然终止态是只剩两个连通块，一个包含 $1$ 另一个包含 $n$，并且两个连通块内的边数均为 $\frac{sz(sz-1)}{2}$。

如果只在连通块内连边，那么能连的边的总数是 $\frac{n(n-1)}{2} - \sum\limits_{i=1}^{cnt} \frac{sz_i (sz_i - 1)}{2}$，其中 $cnt$ 为连通块总数，$sz_i$ 为第 $i$ 个连通块的点数。下文钦定 $1$ 所在连通块为第 $1$ 个连通块，$n$ 所在连通块为第 $2$ 个连通块。

然而还可以在连通块之间连边，这样还需要 $cnt - 2$ 次连边使得原图仅剩第 $1$ 个和第 $2$ 个连通块。

在连通块之间连边时，设两个连通块的 $sz$ 分别为 $x,y$，那么会新增 $xy-1$ 条块内部的连边。如果 $x,y$ 均为奇数，那么不会影响能连的边数的奇偶性；如果 $x,y$ 有一个为偶数，那么能连的边数的奇偶性会改变。

据此考虑按 $n$ 的奇偶性分类讨论。

- $n \bmod 2 = 1$：最终 $sz_1$ 和 $sz_2$ 必然一奇一偶。此时合并偶数块的次数可以算出来。
- $n \bmod 2 = 0$：最终 $sz_1$ 和 $sz_2$ 两奇或两偶。如果初始 $sz_1$ 和 $sz_2$ 奇偶性不相同，那么先手可以控制最终 $sz_1$ 和 $sz_2$ 的奇偶性，此时先手必胜；否则 $sz_1$ 和 $sz_2$ 的奇偶性不会改变，因为如果落败的那一方想改变，那么胜利的那一方可以操作回去。那么此时合并偶数块的次数也可以算出来了。

[code](https://atcoder.jp/contests/arc105/submissions/40723027)