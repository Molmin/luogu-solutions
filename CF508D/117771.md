如果有一个合法的串 $s_1s_2\cdots s_{n+2}$ ，那么 $s_1s_2s_3,s_2s_3s_4,\cdots,s_ns_{n+1}s_{n+2}$ 应该能和输入的串一一对应。

考虑两个纸条上的字符串，如果整个串拼起来之后这两个纸条上的字符串是相邻的，那么这两个纸条有长度为 $2$ 公共部分。

借住这个发现，我们可以把所有可能的长度为 $2$ 的字符串都找出来，建出它们对应的点。

把输入的字符串 $s_1s_2s_3$ 看成是 $s_1s_2$ 和 $s_2s_3$ 之间的有向边，那么一个合法的串相当于图上的一条欧拉路径。

回顾一下存在欧拉路径的充要条件：

> 结论：若一张联通有向图中至多存在一个 入度比出度多 $1$ 和 出度比入度多 $1$ 的点，那么这张有向图存在欧拉路径。

详细证明参见 [【模板】欧拉路径](https://www.luogu.com.cn/problem/P7771) 。

找出一条欧拉路径也很简单：

* 如果图中所有顶点的入度与出度相同，那么随意挑一个点出发。

* 如果图中有出度比入度大 $1$ 的顶点，那么从这个点出发。

* 遍历到一个点的时候，先走一遍所有的自环，然后随便找一个邻接的节点，接着走就行。走完把边删掉。

只需要用并查集判联通然后随便找一条欧拉路径就可以了。

综上，复杂度 $O(n)$。