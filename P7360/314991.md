对每一个 $p^s$ 计算其贡献。

容易发现出现 $p$ 次数至多为 $s$ 的选法有 $(n-n/p^s)^k$ 种。将恰好 $s$ 差分为至多 $s$ 减去至多 $s-1$。则其贡献为 $(p^s)^{(n-n/p^s)^k-(n-n/p^{s+1})^k}$。

考虑根号分治。当 $p\le \sqrt n$ 时，暴力计算上式；否则必然有 $s=1$。$O(n)$ 预处理区间内素数乘积，整除分块即可做到 $O(T\sqrt n\log \text{mod})$。