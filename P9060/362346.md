考虑对质数的正整数次幂分开计算贡献。

具体地，设 $p$ 是质数，$k$ 是正整数。如果区间 $[l,r]$ 内有 $c$ 个数能被 $p^k$ 整除，那么 $p^k$ 产生的贡献就是 $p^{2^c-1}$。

$p^k$ 的贡献可以用普通莫队处理。具体地，我对每个 $p^k$ 开了两个栈，分别存 $p^{2^0},p^{2^1},\dots,p^{2^{c-1}}$ 及其逆元的值。

下面的操作默认当前栈里有 $c$ 个值。

加入一个值的时候。把 $p^{2^c}$ 和 $p^{-2^c}$ 加到对应的栈内，将答案乘上 $p^{2^c}$。

删除一个值的时候，把答案乘上 $p^{-2^{c-1}}$，接着进行弹栈操作。

如果莫队时对每个 $a_i$ 暴力枚举它的质因子，时间复杂度是 $O(n\sqrt{m}\log A)$（$A=\max{a_i}$）的，无法获得满分。

考虑根号分治。对于小于等于 $\sqrt{A}$ 的质数 $p$，它们的正整数次幂总个数不多，不超过 $O(\frac{\sqrt{A}}{\log \sqrt{A}}\times \log \sqrt{A})=O(\sqrt{A})$ 个。可以暴力枚举 $p^k$，预处理 $c$ 的前缀和，对每个问询算它的贡献。

对于大于 $\sqrt{A}$ 的质数，每个 $a_i$ 最多只有 $1$ 个这样的质因子，可以用上面的莫队算法处理。

时间复杂度大约是 $O(n\sqrt m)$ 的，反正 $n,m,A$ 的范围都相同。