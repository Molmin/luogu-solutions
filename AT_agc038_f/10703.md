把 $P$ 分解成不相交循环的乘积后，考虑其中一个循环 $(a_1, a_2, \ldots , a_k)$。

不失一般性，可以把这个循环看作 $(1, 2, \ldots , k)$。

那么对于 $A_1$，有两种情况：$A_1 = 1$ 或 $A_1 = P_1 = 2$。

如果 $A_1 = 1$，则考虑 $A_k$ 有两种情况：$A_k = k$ 或 $A_k = P_k = 1$，但是因为 $A_1 = 1$，所以只能有 $A_k = k$。  
以此类推，可以得到：对于这个循环中的所有元素 $i$，均有 $A_i = i$。

如果 $A_1 = 2$，则考虑 $A_2$ 有两种情况：$A_2 = 2$ 或 $A_2 = P_2 = 3$，但是因为 $A_1 = 2$，所以只能有 $A_2 = 3$。  
以此类推，可以得到：对于这个循环中的所有元素 $i$，均有 $A_i = P_i$。

换句话说，对于每个循环，要么这个循环被完全保留，要么这个循环被完全拆解成一个个自环。

上述结论对 $Q$ 和 $B$ 当然也适用。

我们称**选择**一个循环，指这个循环被完全保留，称**不选**一个循环，指这个循环被拆解成了一个个自环。

接着，考虑一个 $P$ 中的循环 $a$ 和一个 $Q$ 中的循环 $b$，假设它们共有一个元素 $i$。分若干类讨论：

1. $P_i = Q_i = i$：无论如何，这个位置上均有 $A_i = B_i$。
2. $P_i = i, Q_i \ne i$：如果**选择**了 $b$，则这个位置上有 $A_i \ne B_i$，否则**不选** $b$，则这个位置上有 $A_i = B_i$。
3. $P_i \ne i, Q_i = i$：如果**选择**了 $a$，则这个位置上有 $A_i \ne B_i$，否则**不选** $a$，则这个位置上有 $A_i = B_i$。
4. $P_i \ne i, Q_i \ne i, P_i \ne Q_i$：如果**不选** $a$ 且**不选** $b$，则这个位置上有 $A_i = B_i$，否则这个位置上有 $A_i \ne B_i$。
5. $P_i \ne i, Q_i \ne i, P_i = Q_i$：如果 $a, b$ 同时**选择**或同时**不选**，则这个位置上有 $A_i = B_i$，否则这个位置上有 $A_i \ne B_i$。

最终需要最大化 $A_i \ne B_i$ 的下标 $i$ 的数量，也就是最小化 $A_i = B_i$ 的下标 $i$ 的数量。

如果在上述 $5$ 种情况中，一旦发生了 $A_i = B_i$，就赋有 $1$ 的**代价**，那么就是要最小化总代价。

可以发现类似于一个**文理分科模型**，可以建立一个网络流模型，求最小割得到答案。

但是因为有些条件不符合，没法直接套用。

不过，如果把 $Q$ 中的循环割掉与源点和汇点之间的边的意义交换，就可以套用了。

而且可以发现，这样建出来的图是一个二分图，因为 $P$ 中的循环只和源点连边，$Q$ 中的循环只和汇点连边，$P, Q$ 之间也只会互相连边。（如果 $P$ 中的循环对应的节点，割掉与源点相连的边的意义是**不选**它，而 $Q$ 中的循环对应的节点的意义恰好相反的话）

所以最终是在单位容量的二分图上求最小割，使用 Dinic 算法可以做到 $\mathcal O (|E| \sqrt{|V|})$ 的复杂度。

时间复杂度为 $\mathcal O (N \sqrt{N})$，[评测链接](https://atcoder.jp/contests/agc038/submissions/10342736)。