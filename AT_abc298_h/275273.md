挺无脑的。是不是因为 unr 所以评分虚高啊/qd

考虑把 $L_i \to R_i$ 的路径拎出来，那么路径中点（或中边）左边的点挂的子树到 $L_i$ 更优，右边的点挂的子树到 $R_i$ 更优。

差分一下，可以转化成 $O(q)$ 次询问，每次询问形如 $(u, v)$ 表示求 $v$ 子树中所有点到 $u$ 的距离之和。

考虑离线，把 $(u, v)$ 的询问挂到 $u$ 子树，然后一遍 dfs。dfs 的同时维护所有点到当前点的距离，那么从父亲转移到儿子就相当于，儿子的这棵子树的距离全部 $- 1$，子树外的距离全部 $+ 1$。处理挂在这个点的查询，就做一次区间查询和即可。区间加、区间查询和，使用线段树维护。

总时间复杂度 $O((n + q) \log n)$。

[code](https://atcoder.jp/contests/abc298/submissions/42288917)