考虑 $dp_{l,r,d,u}$ 表示对横坐标在 $[l,r]$，纵坐标在 $[d,u]$ 中的点进行操作后可以得到多少种不同的点的序列。

直接枚举分界点显然会算重，这里考虑有以下两种一般性的思路：

- **探究一下什么序列能够被得到**，由此而不是由操作序列的角度设计 DP 状态。
- 硬是从操作序列的角度入手，**不过给操作序列定个顺序**（比方说，字典序最小的操作序列），以保证任意一个合法的序列只会被算一次。

大多数题我们采用第一种处理方法，不过这题如果采用第一种就 GG 了，因此考虑第二种。

我们首先先将这个矩形中的点的横纵坐标离散化。我们定义一次操作的大小为，$x(1)<y(1)<x(2)<y(2)<\cdots<x(k)<y(k)$，其中 $k$ 为矩形中点的个数。

这样我们第一步枚举第一次进行的操作是什么，然后分成两部分求 DP 值并做乘积，但是这样不能体现操作序列的最小性，也就是说我们设 $fx_i$ 表示有多少个点序列可以通过第一次进行 $x(i)$ 操作得到，并且该操作序列是得到此点序列的字典序最小的操作序列，$fy_i$ 也同理，那么我们考虑容斥，以 $fx_i$ 为例，我们枚举有多少个操作序列满足其第一次进行的操作比 $x(i)$ 小，并且可以通过第一步进行 $x(i)$ 得到，分情况讨论：

- 第一次进行的操作是 $x(j)$，那么左边的矩形的方案数是 $fx_j$，中间的矩形的方案数是 $dp_{j+1,i,1,k}$，右边的矩形的方案数是 $dp_{i+1,k,1,k}$，三者乘起来即可。
- 第一次进行的操作是 $y(j)$，情况类似，不过此种转移可以进行的条件是 $y$ 坐标 $\le j$ 的点被完全包含于横坐标 $\le i$ 的点中。

使用记忆化搜索常数会小 $114514$ 倍。时间复杂度 $O(n^6)$。