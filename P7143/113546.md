似乎是不太一样的想法呢。

有一个熟知结论：区间 $[l,r]$ 在线段树上的区间定位数等于 $2\times (r-l+1)-|S|$，其中 $|S|$ 表示线段树上包含于 $[l,r]$ 的区间个数，这个结论使用森林中点边连通块的关系以及完满二叉树的叶结点与非叶结点关系容易得到。

接下来：

$$\sum\limits_{l=1}^n\sum\limits_{r=l}^n2\times (r-l+1)=2\times\sum\limits_{len=1}^nlen\times(n-len+1)$$

令 $s_i(n)$ 表示 $\sum\limits_{j=1}^n j^i$，那么上式等于：

$$2\times \Big((n+1)\times s_1(n)-s_2(n)\Big)$$

后面这个 $|S|$，设线段树结点集合为 $V$，点 $x$ 的左右端点为 $l_x,r_x$，那么：

$$\sum |S|=\sum\limits_{x\in V}l_x\times (n-r_x+1)$$

设 $c(n),sl(n),sr(n),slr(n)$ 分别表示 $[1,n]$ 线段树中的点数，左端点和，右端点和，左端点乘右端点之和，那么：

$$\sum |S|=(n+1)\times sl(n)-slr(n)$$

考虑分治，用左边加上右边加上根即可，注意右边需要有个将所有 $l,r$ 平移的过程，但是这个操作可以通过我们已有的信息和平移量直接得出。

然后使用记忆化搜索即可。

