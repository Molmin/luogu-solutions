这篇题解侧重介绍不考虑摆放数量的限制时，答案为何为斐波那契序列。当然，解题的其他步骤也不会忽略。

------------

首先显然每一行相互独立，设一行的方案为 $x$，则答案显然为 $x^n$。

先不考虑摆放数量的限制。不妨将总摆放的方案按最后一个摆放位置进行分类。设最后一个棋子在位置 $i$ 的方案数为 $g_i$，有：

$$
g_i=1+\sum_{k=0}^{i-2}g_k
$$

表示枚举除去 $i$ 的最后一个棋子的位置 $k$，并最后加上只有单独 $i$ 一个棋子的方案。

设 $g$ 的前缀和为 $S$，即 $S_i=\sum_{k\leqslant i}a_i$。因 $S_{i-2}=S_{i-3}+g_{i-2}$，故有：

$$
g_{i}=1+S_{i-2}=(S_{i-3}+1)+g_{i-2}=g_{i-1}+g_{i-2}
$$

边界显然为 $g_0=0,g_1=1$。于是这就是一个标准的 $\rm Fibonacci$ 序列。

在不考虑摆放棋子数量的限制时，最终答案显然为 $S_{n}+1$，即对以不同位置结尾的摆放方案进行求和，并加上一个棋子也不放的情况。设 $f_n=S_{n}+1$，不妨先把 $g$ 和 $S$ 的表打出来。

$$
\begin{matrix}
\,\,n=&1&2&3&4&5&6&7\\
g_n=&1&1&2&3&5&8&13\\
f_n=&2&3&5&8&13&21&34
\end{matrix}
$$

真是太神奇了，$f$ 居然也是一个砍掉了前两位的 $\rm Fibonacci$ 序列。怎么回事呢？下面就来解释这个结果。

考虑设 $G(z)=\sum\limits_{k=0}^{\infty}g_kz^k$ 为序列 $f$ 的生成函数，其中令 $g<0$ 的 $f_{k}$ 均为 $0$。根据 $g$ 的递归关系 $g_n=g_{n-1}+g_{n-2}+[n=1]$，显然有：

$$
G(z)=\sum\limits_{k=0}^{\infty}g_kz^k=\sum_{k=0}^{\infty}g_{k-1}z^{k}+\sum_{k=0}^{\infty}g_{k-2}z^{k}+\sum_{k=0}^{\infty}[n=1]z^k
$$

$$
=\sum_{k=0}^{\infty}g_{k}z^{k+1}+\sum_{k=0}^{\infty}g_{k}z^{k+2}+z
$$

$$
=zG(z)+z^2G(z)+z
$$

解得：

$$
G(z)=\frac{z}{1-z-z^2}
$$

我们设 $F_1(z)$ 为 $S_{n}+1$ 的生成函数，$F_2(z)$ 为 $g_{n+2}$ 的生成函数。根据前面打出的那张表，这两个东西应该是相等的。

$F_2(z)$ 是很容易求出的。因 $g_{n+2}=g_n+g_{n+1}$，故：

$$
F_2(z)=G(z)+\sum_{k=0}^{\infty}g_{k+1}z^{k}=G(z)+\frac{1}{z}\sum_{k=0}^{\infty}g_kz^{k}
$$

$$
=G(z)+\frac{1}{z}G(z)
$$

现在考虑求 $F_1(z)$。先求 $S_n$ 的生成函数，有个经典结论是 $k$ 维前缀和的生成函数应当乘上 $\frac{1}{(1-z)^k}$，具体来说：

$$
S(z)=G(z)\left(1+z+z^2+z^3+\cdots\right)=\frac{G(z)}{1-z}
$$

$F_1(z)$ 即为 $G(z)+\sum\limits_{k=0}^{\infty}z^k=G(z)+\frac{1}{1-z}$。将 $G(z)$ 代入可得：

$$
F_1(z)=\frac{1}{1-z}\left(1+\frac{z}{1-z-z^2}\right)
$$

$$
=\frac{1}{1-z}\frac{1-z^2}{1-z-z^2}=\frac{1+z}{1-z-z^2}
$$

$$
=G(z)+\frac{1}{z}G(z)
$$

即得 $F_1(z)=F_2(z)$。从而我们就证明了 $f_n=g_{n+2}$。

这样就解释了 $f$ 作为一个砍掉前两位的 $\rm Fibonacci$ 序列的原因。现在我们加上了限制，那么不放棋子的那种情况肯定不合法了，并且只放一个的情况也不合法了，这些的数量为 $n+1$。对于每一行我们只需先求出 $f_n$，然后再减去 $n+1$ 即可。

求 $\mathit{fib}_n$ 是一个非常典的矩阵加速：

$$
(\mathit{fib}_n,\mathit{fib}_{n-1})\begin{pmatrix}1&1\\1&0\end{pmatrix}=(\mathit{fib}_{n+1},\mathit{fib}_{n})
$$

直接上矩阵快速幂即可。注意模数最大可以到 $10^{18}$，要用快速乘。