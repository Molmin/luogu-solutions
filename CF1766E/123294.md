这题还蛮不错的。

先考虑 $f(1, n)$。

首先，$0$ 是相对特殊的。每个 $a_i = 0$ 恰好产生一个空序列，且不产生其他任何影响，对 $f(1, n)$ 的贡献为 $1$。

**不妨设序列里面没有 $0$**。

我们注意到，因为 $3$ 可以和所有数（$1\sim 3$ 相邻），所以 $3$ 一定放在第一个序列里，不会影响到其它序列。

因此，除了第一个序列以外，其它序列要么全是 $1$，要么全是 $2$，$f(1, n)\leq 3$。

因为只有三个序列，且我们只关心序列的最后一个数，可能的状态很少，这启发我们设 $f_{i, j, k, l}$ 表示在所有 $f(a[p, i]) (p \leq i)$ 当中，三个序列末尾分别为 $j, k, l$ 的 $p$ 的数量，其中若 $j / k / l = 0$ 则表示对应序列不存在。

直接枚举 $j, k, l$，结合对应的 $a_i$ 通过模拟题目要求转移即可。答案即 $\sum f_{i, j, k, l} ([j > 0] + [k > 0] + [l > 0])$。

当序列里面有 $0$ 时，它对所有包含它的区间产生 $1$ 的贡献，这是容易计算的。

可以记录是否存在全 $1$ 序列和全 $2$ 序列取代 $k, l$，将总状态数除以 $4$，但不必要。

时间复杂度 $\mathcal{O}(n)$。[代码](https://codeforces.com/contest/1766/submission/185020456)。