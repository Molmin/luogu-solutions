这种最大值最小化的题一般可以先考虑二分。设二分了一个 $mid$。

记 $A = (a_1,a_2,...,a_k)$ 为表示每个棋子的位置的状态，如果 $A,B$ 可以互相到达，就在它们之间连一条无向边。则要判断的是 $S = (s_1,s_2,...,s_k)$ 和 $T = (t_1,t_2,...,t_k)$ 是否在同一连通块内。

记 $f(A)$ 为 $\sum\limits_{i=1}^k a_{A_i}$，那我们不妨让 $S$ 和 $T$ 都到达一个 $f(A)$ 最小的状态 $A$（如果 $f(A)$ 相同则比较字典序）。如果两个 $A$ 都相同，则 $S,T$ 在同一连通块内，否则不在。

设 $g(A)$ 为 $A$ 能到达的最小状态，则问题转化成了求 $g(A)$。

考虑一个暴力做法：每次找到能移的棋子中造成的贡献最大的，移动这个棋子（需要预处理点 $u$ 经过权值不超过 $D$ 的点能到达的所有点的点权最小值）。因为每个棋子的移动不会重复经过某个点，所以最多移动 $O(nk)$ 次。时间复杂度是 $O(nk^2 \log n \log ans)$，[显然会 T](https://atcoder.jp/contests/arc115/submissions/40914722)。

考虑加点优化。用堆维护下一个贡献最大的操作。每次 $\sum\limits_{i=1}^k a_i$ 变小时，一些点的移动会变得合法，将它们加入堆中即可。需要[精细实现](https://atcoder.jp/contests/arc115/submissions/40923965)，复杂度 $O(\text{可过})$。