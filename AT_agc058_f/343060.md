看了好久，所以我来写一下。

求 $f(T)$ 的过程若是没有 $\dfrac{1}{n}$ 的话，可以看成枚举一条边，然后对剩下的边也做相同操作的过程。其实就是求边的排列个数。

但是这边有一个 $\dfrac{1}{n}$ 在里面。考虑转换成概率。边的个数是 $n - 1$，必须加点东西。加边补全的方式不可行，它会计算自己，想一想很复杂。

此时有一个人类智慧想法：我们把所有边新建一个点，称为**边点** $e$，每个边再带一个大小为 $-1$ 的辅助点，在模意义下就是加一个大小为 $P - 1$ 的点。那么总点数就是 $n$ 了。

此时我们定义这个新树为 $T^{\prime}$，那么答案就是：$T^{\prime}$ 的点排列满足**对于所有边点，其出现位置都比其相邻点小**的概率。证明可以想象一下取边过程，单点的情况一定要取完相邻边点才能计算到。

我们把这个点的大小关系从大到小连边，可以连出这样的图：

![P1](https://cdn.luogu.com.cn/upload/image_hosting/u6k97ue1.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

（黑色点是边点，蓝色点是大小为 $-1$ 的点）

这个东西的边方向不统一，考虑容斥。将所有向上的边改成向下或没有边，容斥系数就是改成向下的边的数量。

树形背包，设 $f_{u,i}$ 为考虑 $u$ 子树以 $u$ 为根，其外向树大小为 $i$ 满足条件的概率。

两种情况，第一种是将边改下。

![P2](https://cdn.luogu.com.cn/upload/image_hosting/0uwkrij5.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

你要乘上指向的边点作为根的概率 $\dfrac{1}{j}$ 和容斥系数 $-1$。$j$ 是你枚举的 $v$ 外向树大小，用树形背包转移。

然后是删掉的情况。

![P3](https://cdn.luogu.com.cn/upload/image_hosting/v3rxep38.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

同样乘上 $\dfrac{1}{j}$。

最后还要乘上 $u$ 概率 $\dfrac{1}{i}$。

最后答案相当于 $\sum_{i = 1}^{n}{f_{1,i}}$。

