定义 $i$ 和 $i+1$ 是相邻的，当且仅当 $a_i+1=a_{i+1}$。

考虑求出有 $k$ 个相邻的方案数，容斥，求出钦定 $k$ 个相邻的方案数，最后二项式反演即可。

枚举 lcp，设现在做到 $i$，前一半有 $a$ 个相邻，假设后一半有 $b$ 个可能相邻的。

这里 可能相邻 指 $(j,j+1)$ 都没被使用过。

接下来我们枚举前一半钦定有 $t_1$ 个相邻，后一半钦定有 $t_2$ 个相邻，则前一半需要在已知的 $a$ 个选出 $t_1$ 个，后一半在 $n-i-1$ 中选出 $t_2$ 个相邻，剩下的乱排，写出式子：

$$f_{t_1+t_2}\gets \binom{a}{t_1}\binom{n-i-1}{t_2} (n-i-1-t_2)!$$

直接枚举 lcp 和 lcp 后一位取什么，时间复杂度 $\mathcal{O}(n^4)$。

我们发现 lcp 后一位取什么对后面 $a,b$ 的影响是 $\leq 2$ 的，我们对于每一种影响算出数量，然后乘一下计入答案即可，时间复杂度 $\mathcal{O}(n^3)$。

我们盯着这个式子看，发现一眼卷积。于是考虑 GF。

我们有两个 GF，一个 $F_a(z)=(1+z)^a$ 一个 $G_i(z)=$ 后面一大坨 $\times z^x$。

最后答案可以表示为 $\mathcal{O}(n)$ 个 $F\times G$ 之和。

显而易见的，$F$ 看上去非常简单，我们将相同 $a$ 的 $F$ 要乘的 $G$ 并在一起，最后答案式子：

$$\sum\limits_{a=0}^n(1+z)^a\times G_a$$

不过并没有什么用，时间复杂度依然是 $\mathcal{O}(n^3)$。

使用秦九韶算法，每次先乘一个 $1+z$ 再加一个 $G$，时间复杂度 $\mathcal{O}(n^2)$。

至此，本题得到了解决。



