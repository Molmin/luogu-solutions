不会做组合题的 emu（

先考虑一个没有限制的问题，也即对于所有 $n$ 阶排列求答案，记答案的数列为 $f$。直接算 $f$ 不好算，考虑算另一个数列 $g$，其中 $g_i$ 表示钦定划分成 $i$ 个段的方案数（一个排列可以贡献多次），可以写出关于 $f$ 和 $g$ 的表达式：

$$
g_i = \sum_{j=1}^i \dbinom{n-j}{i-j} f_j
$$

这个式子比较好理解，恰好被分成 $j$ 个段的排列还有 $n-j$ 个位置可以切开，需要选择 $i-j$ 个位置。只要得到 $g$ 就可以得到 $f$，具体的通过 $g_{1\dots i-1}$ 得到 $f_{1\dots i-1}$，在 $g_i$ 中 $f_i$ 的系数为 $1$，就可以算出来。

要求字典序小于某一个排列，只能枚举 LCP 之后计算。假设我们现在确定了一个长为 $i-1$ 的 LCP，第 $i$ 位需要填进一个小于 $p_i$ 的数。首先预处理两组东西，第一组表示还没有填入的数中，值小于 $p_i$ 的在数轴上构成的连续段个数，以及这样的数的个数 $(f_1,g_1+f_1)$；第二组就是把这样的数换成不大于 $p_i$ 的数，求出另外一个 $(f_2,g_2+f_2)$（$\cdots, p_i-1,p_i,p_i+1,\cdots$ 视作构成一个值小于 $p_i$ 的数在数轴上构成的连续段，另外请注意每组数的第二个值是 $g_i+f_i$ 而非 $g_i$）。

有了这几个东西我们就可以求贡献了。钦定 $p'[i\dots n]$ 被分成了 $k$ 段（$f_1+f_2 \leq j \leq f_1+f_2+g_1+g_2$），方案数为：

$$
\sum_{j=0}^k \dfrac{g_1+j}{k} k! \dbinom{g_1}{j} \dbinom{g_2}{k-f_1-f_2-j}
$$

简单解释一下含义：因为一定至少有 $f_1+f_2$ 个连续段，我们枚举前小于 $p_i$ 的数多构成了多少个连续段，那么后面不小于 $p_i$ 的数多构成的连续段确定，也即 $\dbinom{g_1}{j}\dbinom{g_2}{k-f_1-f_2-j}$。$k$ 个段乱排方案为 $k!$，但是要求 $p_i'<p_i$，发现所有 $k!$ 个排列中有 $\dfrac{g_1+j}{k}$ 都是合法的。

接下来是一些比较简单的东西，具体运用 $m\dbinom{n}{m} = n\dbinom{n-1}{m-1}$ 以及两次范德蒙德卷积将整体拆成和 $j$ 无关的形式，下面直接给出结果：

$$
(k-1)!f_1\dbinom{g_1+g_2}{k-f_1-f_2} + (k-1)!g_1\dbinom{g_1+g_2-1}{k-f_1-f_2-1}
$$

当然还有特殊情况，也即 $p_i'$ 可以填入 $p_{i-1}+1$，这样可以选择不钦定 $i$ 作为一段的起点，这样的方案为 $\dfrac{k!}{k}\dbinom{g_1+g_2}{k-f_1-f_2}$（因为在这种情况下 $p_{i-1}+1$ 一定是一个连续段的起点，可以不枚举，补满缺少的 $k-f_1-f_2$ 个钦定的连续段之后的所有连续段排列有 $\dfrac{1}{k}$ 的概率满足条件）。

当然如果做 $n$ 次容斥不太科学，我们考虑只做一次。注意到一开始的式子 $g$ 可加，我们从大到小枚举 LCP，让后面的 $g$ 加到当前的 $g$ 上来。简单分类讨论，如果 $p_i-1=p_{i-1}$ 就可以选择是否钦定分段，那么有转移 $g_{i,j}=g_{i,j-1}+g_{i,j}$；否则一定要分段，转移 $g_{i,j}=g_{i,j-1}$。

[评测记录](https://codeforces.com/contest/1750/submission/180070446)。

