~~来自 COCI 的官方题解。~~

## 思路

让 $x_{d[i]}$ 为到第一个有 $d$ 个祖先的 $i$ 型精灵诞生的年份。由于事故中每种类型的小精灵都有一个，我们可以为每个 $i$ 设置 $x_0[i] = 0$。

检查一种有 $d$ 祖先的 $i$ 型小精灵。一年后他产下一枚 $j$ 型卵，那需要 $z_{i,j}$ 年才能孵化。那个蛋有 $d+1$ 个祖先。所以我们现在知道 $x_{d+1}[j]$ 小于或等于 $x_{d[i]} + y_i + z$。显然，找到所有孵化 $j$ 型蛋的小精灵的最小值，我们得到 $x_{d+1}[j]$。我们可以用矩阵代数一次观察所有类型。

我们有:

$$a \otimes x_d = x_{d +1}$$

其中 $a$ 是一个矩形矩阵，第 $i$ 行第 $j$ 列等于 $y_j + z_j$，如果是 $j$ 型格莱姆林孵化出第 $i$ 型蛋，则为 $i$，如果不是 $\infty$。矩阵 $x_d$ 和 $x_{d+1}$ 是不需要加以说明的，$\otimes$ 表示最小加矩阵乘法。

用二进制求幂法可以快速地将矩阵 $a$ 提升到任意次幂。

将 $a^d \times x_0$，然后对 $x_d$ 进行最小加代数运算，扫描得到的 $x_d$ 矩阵。如果每个数字都大于 $t$，那么就没有 $d$ 祖先的小妖精。否则，至少有一个。对 $D$ 进行二分搜索，找到最大的可能 $d$。