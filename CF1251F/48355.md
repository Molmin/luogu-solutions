首先发现所求周长等于(中间红栅栏的高度+栅栏个数) $\times 2$，因此不妨先把所有询问都除以 $2$。然后注意到红栅栏个数很小，可以枚举中间的红色栅栏是什么。  

考虑所有 $a_i$ 互不相同的情况，询问 $k$ 的答案是 $2^k C_n^k$，因为可以任选 $k$ 个，每个可以放左边或者右边。  

接下来考虑相同的 $a_i$ ，不难发现两个以上相同的等价于两个相同的，假设有 $x$ 对相同的栅栏，答案为 $C_{2x}^k$，可以理解为任意一对如果第一个被选则表示左边放一个，第二个被选表示右边放一个，两个都被选表示两边都放。  

然后把两种情况卷一下得到答案。注意要加上当前红栅栏的长度 $+ 1$。

小号在cf上的提交暂时是最短解？  
[代码](https://codeforces.com/contest/1251/submission/63386062)