**无需转期望或笛卡尔树的一步到位简单组合思路。**

观察到最终的答案是每个 $a_i$ 乘上位置 $i$ 的一个系数 $x_i$ 的和，而系数 $x_i$ 只和 $n$ 有关。考虑求出所有 $x_i$。

考虑解决一个更弱的问题：所有 $a_i$ 中只有 $a_1=1$，其他为 $0$，即求出 $x_1$。令 $f_n$ 表示答案。根据题意，一个长度为 $n$ 的排列 $p$ 答案为：
$$w(p)=\sum_{i=1}^n[\nexists j<i,p_j<p_i]$$
则：
$$f_n=\sum_pw(p)$$
考虑由 $f_{n-1}$ 递推至 $f_n$。考虑往一个长度为 $n-1$ 的排列中插入一个数 $n$，得到长度为 $n$ 的排列。注意到对于任何 $p$，只有这个 $n$ 插入在 $p$ 开头时 $w(p)$ 才会增加 $1$。所以：
$$f_n=nf_{n-1}+(n-1)!$$
有了系数 $x_1$，我们考虑原问题。对于一个排列 $p$ 和一个下标 $i$，将 $p$ 中 $\le i$ 和 $\ge i$ 的元素分别拿出来，顺序不变，得到两个新序列 $p_1,p_2$，再将 $p_1$ 中的值域翻转（即所有元素 $p_{1,j}$ 变为 $i-p_{1,j}+1$）、$p_2$ 中每个元素减去 $i-1$，则 $p$ 对 $x_i$ 的贡献就是 $w(p_1)+w(p_2)-1$，则：
$$\begin{aligned}x_i&=\sum_pw(p_1)+w(p_2)-1\\&=\sum_pw(p_1)+\sum_pw(p_2)-n!\\&=\sum_{p_1}w(p_1)\cdot A_n^{n-i}+\sum_{p_2}w(p_2)\cdot A_n^{i-1}-n!\\&=n!\left(\frac{f_i}{i!}+\frac{f_{n-i+1}}{(n-i+1)!}-1\right)\end{aligned}$$
其中 $A_n^m$ 为排列数。

令 $g_n=\dfrac{f_n}{n!}$，则根据上面 $f_n$ 的递推式易得 $g_n=g_{n-1}+\dfrac1n$，最终的答案即为：
$$n!\sum_{i=1}^na_i(g_i+g_{n-i+1}-1)$$
式子和其他题解一样。时空复杂度均为 $\mathcal O(n)$。代码过于简单，没必要放了。