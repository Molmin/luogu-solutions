假如这个像过山车一样的序列总长只有 $10^5$ 该怎么做？考虑增量构造，设 $f_i$ 表示当前序列中，结尾是 $i$ 的最长上升子序列个数；那么增加一个数 $x$ 也就等价于执行 $f_{x}+=\max(f_{x-1},1)$；依次加入数就行了，最后的答案只要统计那些 $\sum\limits_{j=1}^i d_j-\min\limits_{k=1}^{i-1}\{\sum_{j=1}^kd_j\}=max$ 的 $i$ 位置的值的和就行了（注意这个 $f$ 是在 $i$ 位置时的 $f$）；注意每次到达新的最低点时要将 $f$ 数组清空。

现在考虑序列可能很长的情况。我们发现：下降操作，大致相当于把 $[pos_i,pos_{i-1}]$ 这一段平移一下加到自己身上；上升操作，相当于把区间的第一个数加上一个数，然后把这个区间前缀和一下。

有没有合适的结构可以用来维护这个 DP 数组呢？有，那就是多项式！先给出一个结论：任一时刻的 $f$ 数组皆可以被分成 $O(n)$ 段，每一段内的 $f_x$ 均可以用次数小于 $O(n)$ 的多项式 $f(x)$ 表示。下面大致口胡一下：

1. 序列 `1,1,1,...` 可以用 $f(x)=1$ 表示。
2. 它的前缀和可以用 $f(x)=\frac{(1+x)x}2$ 表示，它的前缀和的前缀和可以用 $f(x)=\frac{(2x+1)(x+1)x}6$ 表示。...... 它的任意一阶前缀和都可以用多项式表示。
3. 下降操作中，除了区间第一个数之外的 $f$ 可以用 $f(x)+f(x-1)$ 表示；第一个数可以单独拆成一个常数多项式。
4. 上升操作中，前缀和操作可以用多项式表示；而第一个数加上一个数，相当于在这个多项式上加上一个常数；而这些使得这段的 $f$ 可以看作是序列 `1,1,1,...` 的多阶前缀和的多项式的和。

于是我们可以大力用多项式维护这个 $f$ 数组，每次操作直接算出这一段 $f$ 的前 $n$ 项，前缀和/偏移一下，然后把新的 $f$ 直接拉格朗日插值插出来。

有一些细节，比如在下降操作中，第一个位置需要单独新建一个多项式；上升操作中，如果有一段的 $f$ 已经超出了原来的范围，那么就需要新建一个常数多项式来表示这一段。

评测链接：[AC submission：https://codeforces.ml/problemset/submission/1474/113669336](https://codeforces.ml/problemset/submission/1474/113669336). 