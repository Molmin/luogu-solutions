果然我搞学术写题解啥的就只是个二流水平，当 nm 的题管啊，爬了

简要题意：

一个序列在尾端加入删除，实时做完全背包。

在线做法显然是把序列每个前缀的动规结果全部存下来，删除操作直接扬了末端，加入操作在前一个的基础上 dp。

具体地，设当前的物品编号列表为 $s=\{s_1,s_2,\cdots,s_n\}$。

现在在末尾加一个 $s_{n+1}=t$ 号物品。

$$dp_{n+1,m}=max\{dp_{n,m},dp_{n,m-w_i}+v_i\}(m=0,1,\cdots,V)$$

时间复杂度 $O(qV)$，可以接受。  
空间复杂度 $O(qV)$，炸了。

反正这道题也不强制在线，考虑离线一棵操作树下来。每个点的结果可以从它的父亲推过来。

显然整体的动态规划过程是自上而下的。

我们发现，对于树上一条自上而下的链 $L=\{a_1,a_2,\cdots,a_n\}$，我们在把这条链推下去的过程中，先对 $a_i$ 做出结果，那么其实只有 $a_i$ 这个点的儿子需要用到它。如果我们先做完了所有以 $a_i$ 儿子为根的子树，那么它就用不到了。

所以对于一条链，如果我们采取这样自上而下处理的方式，只需要开一个数组！

只要重链剖分就只有 $O(\log n)$ 条链。

对于整个过程，我们处理点 $u$ 的时候可以先处理轻儿子 $\{l_1,l_2,\cdots,l_n\}$ 的结果，然后继续遍历轻儿子（并开一条新的链），然后把当前这条链的空间递给重儿子 $w_u$，继续搜就可以遍历整棵子树。

代码就不放了，相信大家都会。