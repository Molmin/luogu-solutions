给定序列 $a_{1\cdots n}$，找一个最长的子区间使得该子区间加入至多 $k$ 个数之后，排序后是一个公差为 $d$ 的等差数列。多个解输出 $l$ 最小的。

$n,k\leq 2\times 10^5$，$|a_i|,d\leq 10^9$。

特判掉 $d=0$，则区间 $[l,r]$ 合法当且仅当：

- 相邻两个数的 $\Delta$ 是 $d$ 的倍数。
- 没有重复元素。
- $r-l+k\ge\frac{\max-\min}{d}$。

注意到答案（长度）是没有单调性的，所以不要二分。

前两个限制是容易处理的，对于第三个限制，变形为 $\max-\min-Rd\leq (k-L)d$，当我们固定 $L$ 时右边是常数，左边的 $\max-\min$ 关于 $R$ 单调。 对于单个 $L$，考虑这样一个结算 $\max-\min$ 的方式：记 $s_R$ 表示 $[L,R]$ 的 $\max-\min$，找到 $L$ 后第一个比 $a_L$ 大的位置 $a_x$，则 $s_{x\cdots n}$ 都应该加上 $a_x-a_L$，再往后找到第一个比 $a_x$ 大的，以此类推；$\min$ 部分同理。

一个想法是向后面第一个比自己大/小的点连父边，但这题中会建立两棵树，信息不方便合并，于是只能整体维护（$\max-\min$）。另外发现，本质是从后往前维护了两个单调栈，栈中相邻两个元素之间会有 $s$ 的后缀加。

对于前两个限制，合法的 $R$ 是一个 $L$ 开始的前缀 $[L,r]$，二分出这个 $r$，然后需要查询 $L\leq R\leq r$，满足 $s_R-Rd\leq (k-L)d$ 的最大的 $R$，不妨整体维护 $s_R-Rd$，于是本质是需要维护一个序列 $val$，支持区间加，查询区间最靠后一个满足 $val_i\leq x$ 的 $i$，线段树二分可以 $O(n\log n)$ 解决这样的问题。

