巨大厉害题。

首先可以从难点出发，也可以从简单一点的地方出发。

可以从前置状态出发，也可以从结果出发。

拓扑排序有个结论，给一个无向图定向，一定存在一种构造，对于所有拓扑序中，**存在一些点的拓扑序始终不动，当且仅当这些点的度数为 $n-1$，且这些点的个数就是所有拓扑序对的差异值的最小值。**

所以我们从简构造，为了尽量消除复杂的边限制，先挑选出那些固定点，把他们全部打包扔到拓扑序列的最前面，相当于直接把它们删掉了。

**然后一定要消除一个模糊点，我们如果可以给图任意定向，我们的拓扑序无论怎么取，都可以对应一个合法构造。**因为如果原图是完全图，它也能满足，那么自然这个结论成立。

**构造序列的排列至少还是比给边定向简单很多的，所以在这种高度自由的情况下，我们把给边定向转换为构造拓扑序列，进而对应一个合法的定向方案。**拓扑序列上的一个点只能向它后面那一段后缀的点连有向边。

两个拓扑序列的剩下部分，我们要完全错开。很自然可以想到通过把拓扑序列的一些部分进行交换做到。

考虑这样一种简单（？）构造，我们把一个拓扑序列划分成一些区间，这个区间内的前后两部分进行一个交换，就可以使这两个拓扑序列的差异值取到最优。

但我们真的做得到吗 \ch ？我们考虑发掘一些需要满足的性质，**当前这一段区间，它的前面一部分，和后面一部分进行交换，不会影响区间外的点和区间内的连边，那么我们只需要保证这两部分之间没有边**。

那么相当于要寻找匹配，将原图划分成若干子图，给这些子图匹配，满足匹配的两个子图之间没有边。

把没有边的进行匹配有个经典技巧，**补图菊花剖分**。我们建出补图，进行菊花剖分。 菊花剖分的意义就是中心与所有叶片在原图中匹配。

为什么这个满足原图限制，因为我们在补图中菊花剖分不重不漏地选中了每个点，但是可能少选了一些边，**也就相当于在原图中多考虑了一些不存在的边的性质，这样叶片在原图中成为了一个团，我们将这个团与中心匹配，反而加强了条件**，正确性成立。

注意这里的每一个菊花大小都得 $\geq 2$ ，但由于删去了固定点，补图中每个点的度数都大于等于 $1$，一定做剖得出来。

补图肯定建不出来，我们考虑建出补图的一棵生成树，因为任意一棵树都可以菊花剖分。

怎么建出生成树呢？我们维护一个当前还没有选入生成树的集合，假设当前要对于一个点 $x$ 建边，在该集合中寻找合法点，与 $x$ 连。那么我们的复杂度怎么保证？考虑一个点必然产生一次时间贡献，一条边顶多产生一次贡献，均摊合理。

关于菊花剖分还有一些细节，看代码不难理解。

[mycode](https://codeforces.ml/contest/1477/submission/134805277)