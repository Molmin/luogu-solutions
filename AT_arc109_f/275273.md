考虑判断一个终止态是否可达。如果只有一个棋子连续段那一定可达；否则就存在 $\ge 2$ 个连续段。此时把放棋子看成删除，那么限制就是如果删除一个孤立的棋子（两边没有棋子）且还有别的格子有棋子，这个棋子的颜色 **异于其他连续段的两边棋子的颜色**。

设第一个被删的段（最后一个放棋子的段）的最后一个棋子颜色为 $c$，记其补色为 $c'$。想删掉这个棋子就必须把其他连续段删成两边都是 $c'$。借这个机会可以把所有包含 $c$ 的段都删除，剩下的段只会包含 $c'$。这样的段最多只有一个（多了就寄了），所以这个段就是最后被删除的段（第一个放棋子的段）。

可以发现删棋子和放棋子的方案是一一对应的，所以“存在一个合法的删棋子方案”就是“存在一个合法的放棋子方案”的充要条件。

考虑枚举 $c$，那么根据以上讨论有如下限制：

- 第一个被删的段必须包含子序列 $c$。
- 最后被删的段 **和它两边** 必须包含子序列 $c'c'$。
- 其他段 **和它两边** 必须包含子序列 $c'cc'$。

考虑左边和右边扩充 $3$ 位后大力 dp。设 $f_{i,0/1,0/1}$ 表示钦定 $i$ 不放棋子，当前是否存在 **第一个被删的段**，当前是否存在 **最后被删的段**，放棋子数量的最小值。转移大概是如果 $i-1$ 不放棋子就是 $f_{i,x,y} \gets f_{i-1,x,y}$，否则枚举 $i-1$ 所在段的左端点，考虑这一段是第一个被删的段、最后被删的段还是其他段。

直接做是 $O(n^2)$ 的，考虑优化。容易通过子序列自动机找到以 $i-1$ 为右端点的第一个合法的左端点，并且发现能转移的点是一段前缀，这个前缀随着 $i$ 增大而增大。分三类记一下前缀最小值即可。这样是 $O(n)$ 的。

[code](https://atcoder.jp/contests/arc109/submissions/40780253)