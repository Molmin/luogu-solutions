此题解是对 Legitimity 大佬的题解做的补充，由于最后求得公式的一部分只是简单的用“插板法”一语带过，我只好对着公式想了好几个小时，才想出公式的意义，希望这篇注解能帮到大家

本文假设你已经看懂了 Legitimity 大佬的题解中“分析出必要条件是...”之前的部分。

考虑既有必经点又有其他点的情况，需要强调的是，我们是对最后的方案计数，所以**如果必经点的放置方案是相同的，$k$也是相同的，那么这就是同样的方案**

考虑一种必经点的放置方案，我们需要将剩下的点划分成无用点和非必经点，再求出他们可能的 $k$ 值域的并，由于必经点的放置方案确定，值域下界是不变的 $\max(x,3)$，因此要求值域的并只要求出 $k$ 在这种必经点的放置方案下的最大值就可以了，而这意味着必经点划分出的 $x+1$ 段区间中每段区间最多只有一个点是无用点/三个一组的非必经点，剩下都是两两成组的非必经点。

于是我们只需要对这样的方案计数，再乘上此时 $k$ 的值域。

考虑枚举必经点的个数 $x$ 以及成对非必经点的对数 $y$，那么分配这些点的方案数（一对点必须在一起被安排）就是 $\binom{x+y}{y}$，此时还剩下 $n-x-2y$ 个点，他们只可能是无用点/三个一组的非必经点，而且 $x+1$ 段区间的每一段最多只能插入一个，但是这一个插在区间的哪个位置是不影响的（因为成对非必经点和这种点都是 $k-1$），因此再乘上一个 $\binom{x+1}{n-x-2y}$ 即可计算出方案数。